<!DOCTYPE html>
<html lang="zh-Hant" data-app>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é›¢ç·šåŒ¯å·®è¨ˆç®—å™¨ v3ï½œæ°´å–® & é€²å‡ºå£å ±å–®</title>
  <style>
    /* ===== Theme System (Light / Dark) ===== */
    :root{
      /* light theme defaults */
      --bg:#f8fafc;          /* slate-50 */
      --panel:#ffffff;       /* white */
      --panel-2:#f1f5f9;     /* slate-100 */
      --muted:#475569;       /* slate-600 */
      --text:#0f172a;        /* slate-900 */
      --accent:#0284c7;      /* sky-600 */
      --accent-2:#06b6d4;    /* cyan-500 */
      --ok:#10b981;          /* emerald-500 */
      --bad:#ef4444;         /* red-500 */
      --warn:#d97706;        /* amber-600 */
      --card:#ffffff;
      --border:#e2e8f0;      /* slate-200 */
      --input-bg:#ffffff;
      --input-text:#0f172a;
      --table-stripe:#f8fafc;
      --shadow:0 10px 30px rgba(2,6,23,.06);
      --code:#0f172a;
    }

    [data-theme="dark"]{
      --bg:#0b1220;          /* deep blue */
      --panel:#0f172a;       /* slate-900 */
      --panel-2:#0a1220;
      --muted:#94a3b8;       /* slate-400 */
      --text:#e2e8f0;        /* slate-200 */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#38bdf8;    /* sky-400 */
      --ok:#34d399;          /* green-400 */
      --bad:#fb7185;         /* rose-400 */
      --warn:#f59e0b;        /* amber-500 */
      --card:#0f172a;
      --border:#1f2a44;
      --input-bg:#0a1220;
      --input-text:#e2e8f0;
      --table-stripe:#0b1628;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --code:#e2e8f0;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,var(--panel-2) 0%,transparent 60%),linear-gradient(0deg,var(--bg),var(--bg));color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
    h1,h2{margin:.2rem 0 1rem}
    h1{font-size:1.3rem}
    h2{font-size:1.1rem;color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}

    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .theme-toggle{display:flex;gap:8px;align-items:center}
    .theme-btn{border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:999px;padding:6px 10px;cursor:pointer;box-shadow:var(--shadow)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    .tab{border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:999px;padding:8px 12px;cursor:pointer;transition:.18s;box-shadow:var(--shadow)}
    .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#0b1220;font-weight:700;border-color:transparent}

    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .split{display:grid;grid-template-columns: 1.3fr .7fr;gap:12px}
    @media (max-width: 900px){.grid.cols-2,.grid.cols-3,.split{grid-template-columns:1fr}}

    .row{display:flex;gap:8px;align-items:flex-end}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    label{font-size:.85rem;color:var(--muted)}

    input,select,textarea{width:100%;background:var(--input-bg);color:var(--input-text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent)}
    textarea{min-height:100px}

    table{width:100%;border-collapse:collapse;background:var(--panel)}
    thead{position:sticky;top:0;background:var(--panel)}
    th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;color:var(--text)}
    tbody tr:nth-child(odd){background:var(--table-stripe)}

    .btn{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#082f49;font-weight:700}
    .btn.ghost{background:transparent}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#f97316);border:none;color:#111;font-weight:700}
    .btn.danger{background:linear-gradient(90deg,#fb7185,#ef4444);border:none;color:#111;font-weight:700}

    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:.75rem;opacity:.9}
    .gain{background:color-mix(in oklab, var(--ok) 18%, transparent);color:var(--ok)}
    .loss{background:color-mix(in oklab, var(--bad) 18%, transparent);color:var(--bad)}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;color:var(--code)}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .hint{font-size:.8rem;color:var(--muted)}
    .sticky{position:sticky;top:8px}
    .footer{margin-top:16px;color:var(--muted);font-size:.8rem}
    .small{font-size:.85rem}
    .allocation-detail-row td {
      padding-top: 0;
      padding-bottom: 0;
    }
    .allocation-detail-content {
      padding: 8px 0;
      background: var(--panel-2);
      border-radius: 8px;
      margin: 8px 0;
    }
    .allocation-detail-content table {
      width: calc(100% - 16px);
      margin: 0 8px;
    }
    .allocation-detail-content th,
    .allocation-detail-content td {
      padding: 4px 8px;
      font-size: 0.8rem;
    }
    .allocation-detail-content tbody tr:nth-child(odd) {
      background: transparent; /* No stripe for nested table */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>é›¢ç·šåŒ¯å·®è¨ˆç®—å™¨ v3ï½œæ°´å–® & é€²å‡ºå£å ±å–®</h1>
      <div class="theme-toggle">
        <span class="muted">ä¸»é¡Œ</span>
        <button id="theme-btn" class="theme-btn" title="åˆ‡æ›äº®/æš—">ğŸŒ— åˆ‡æ›</button>
      </div>
    </div>

    <!-- Quick bar: Global Customer/Vendor + Allocation actions -->
    <div class="row" id="quickbar" style="margin-bottom:8px">
      <div style="flex:1" class="card">
        <label>å®¢æˆ¶ï¼ˆç¯©é¸å» å•†ï¼‰</label>
        <input id="globalVendor" list="global-vendor-list" placeholder="è¼¸å…¥æˆ–é¸æ“‡å®¢æˆ¶/å» å•†" />
        <datalist id="global-vendor-list"></datalist>
        <div class="hint">æ­¤æ¬„ä½œç‚ºåˆ—è¡¨/åˆ†æé è¨­ç¯©é¸ï¼›å¯éš¨æ™‚æ¸…ç©ºã€‚</div>
      </div>
      <div class="card" style="min-width:260px">
        <label>åˆ†æ”¤å¿«é€Ÿå‹•ä½œï¼ˆé‡å°ä¸Šæ–¹å®¢æˆ¶ï¼‰</label>
        <div class="row">
          <button class="btn" id="fifoAlloc">FIFO è‡ªå‹•åˆ†æ”¤</button>
          <button class="btn" id="clearAlloc">æ¸…ç©ºåˆ†æ”¤</button>
        </div>
      </div>
    </div>

    <div class="tabs" id="tabs"></div>
    <div id="panel-container" class="grid"></div>

    <div class="footer">è³‡æ–™çš†å„²å­˜åœ¨æ­¤ç€è¦½å™¨çš„ <span class="mono">localStorage</span>ï¼Œå¯é›¢ç·šä½¿ç”¨ã€‚å»ºè­°å®šæœŸã€ŒåŒ¯å‡ºå‚™ä»½ã€ã€‚</div>
  </div>

  <!-- Datalists for vendors -->
  <datalist id="all-vendor-list"></datalist>
  <datalist id="slip-vendor-list"></datalist>

<script>
(function(){
  // ===== Theme: auto-detect & toggle =====
  const THEME_KEY = 'fx-theme';
  const GLOBAL_VENDOR_KEY='fx-current-vendor';
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const savedTheme = localStorage.getItem(THEME_KEY);
  const theme = savedTheme || (prefersDark ? 'dark' : 'light');
  setTheme(theme);
  document.getElementById('theme-btn').onclick = ()=>{
    setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');
  };
  function setTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem(THEME_KEY, t);
  }

  // ------------------ Data Layer ------------------
  const storeKey = 'fx-offline-v3';
  const state = load() || {
    settings:{ rateMode:'mul', vendorHint:'', defaultCurrency:'USD', baseCurrency:'TWD' },
    slips:[], // æ°´å–®
    decls:[], // å ±å–®
    allocs:[], // åˆ†æ”¤: {id, declId, slipId, amount}
    audit:[] // ç¨½æ ¸: {id,time,action,entity,entityId,detail}
  };
  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(storeKey)); }catch(e){ return null; } }
  function uid(){ return Math.random().toString(36).slice(2,10); }
  function nowISO(){ return new Date().toISOString(); }
  function log(action, entity, entityId, detail){ state.audit.unshift({id:uid(), time:nowISO(), action, entity, entityId, detail}); if(state.audit.length>2000) state.audit.length=2000; }
  function parseNum(x){ const n=Number(String(x).replace(/,/g,'')); return isFinite(n)?n:0; }
  function format(n, d=2){ return (isFinite(n)?n:0).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}); }
  
  function allVendors(){ const set=new Set([...(state.slips||[]).map(x=>x.vendor), ...(state.decls||[]).map(x=>x.vendor)]); return Array.from(set).filter(Boolean).sort(); }
  function slipVendors(){ const set=new Set((state.slips||[]).map(x=>x.vendor)); return Array.from(set).filter(Boolean).sort(); }

  // Allocation helpers
  function totalAllocatedForDecl(declId){ return state.allocs.filter(a=>a.declId===declId).reduce((s,a)=>s+parseNum(a.amount),0); }
  function totalAllocatedForSlip(slipId){ return state.allocs.filter(a=>a.slipId===slipId).reduce((s,a)=>s+parseNum(a.amount),0); }
  function slipAvailable(slip){ return Math.max(0, parseNum(slip.amount) - totalAllocatedForSlip(slip.id)); }
  function declAvailable(decl){ return Math.max(0, parseNum(decl.amount) - totalAllocatedForDecl(decl.id)); }

  // Compute FX (supports allocations)
  function computeFx(decl){
    const relevantAllocs = state.allocs.filter(a=>a.declId===decl.id);
    const rDecl = parseNum(decl.rate);

    if(relevantAllocs.length>0){
      let sumLocalSlip=0, sumLocalDecl=0;
      let arapList=[]; let stepLines=[];
      relevantAllocs.forEach(a=>{
        const slip = state.slips.find(s=>s.id===a.slipId); if(!slip) return;
        const rSlip = parseNum(slip.rate);
        const part = parseNum(a.amount);
        const localBySlip = state.settings.rateMode==='mul' ? part * rSlip : (rSlip? part / rSlip : 0);
        const localByDecl = state.settings.rateMode==='mul' ? part * rDecl : (rDecl? part / rDecl : 0);
        sumLocalSlip += localBySlip; sumLocalDecl += localByDecl;
        const slipDate = new Date(slip.date); const declDate=new Date(decl.date);
        arapList.push(slipDate < declDate ? 'é æ”¶ä»˜' : (slipDate > declDate ? 'æ‡‰æ”¶ä»˜' : 'åŒæ—¥'));
        // Updated formula display for each allocation step
        const currencySymbol = decl.currency || 'å¤–å¹£';
        stepLines.push(`${format(part)}${currencySymbol} @ ${format(rDecl,4)}-${format(rSlip,4)} (å·®é¡: ${format(localByDecl-localBySlip)})`);
      });
      const diff = sumLocalDecl - sumLocalSlip;
      let label='', kind='';
      if(decl.type==='é€²å£'){
        label = diff>0 ? 'å…Œæ›ç›ˆé¤˜' : (diff<0 ? 'å…Œæ›æå¤±':'ç„¡å·®é¡');
        kind = diff>0 ? 'gain' : (diff<0 ? 'loss':'even');
      }else{ // å‡ºå£
        label = diff>0 ? 'å…Œæ›æå¤±' : (diff<0 ? 'å…Œæ›ç›ˆé¤˜':'ç„¡å·®é¡');
        kind = diff>0 ? 'loss' : (diff<0 ? 'gain':'even');
      }
      return { slip:null, localBySlip:sumLocalSlip, localByDecl:sumLocalDecl, diff, label, kind, arap:arapList.join(' / '), steps:stepLines.join('\n') };
    }

    // Original single-slip matching logic removed. If no allocations, diff is 0 and status is 'æœªåˆ†æ”¤'.
    return { slip:null, note:'å°šæœªåˆ†æ”¤', localBySlip:0, localByDecl:0, diff:0, label:'æœªåˆ†æ”¤', kind:'none', arap:null, steps:'å°šæœªé€²è¡Œåˆ†æ”¤ã€‚è«‹åœ¨å³å´ã€Œåˆ†æ”¤é…ç½®ã€å€å¡Šæ–°å¢æ°´å–®é€²è¡Œåˆ†é…ã€‚' };
  }

  // ------------------ UI Helpers ------------------
  const elTabs = document.getElementById('tabs');
  const elPanels = document.getElementById('panel-container');
  const tabs = [
    { id:'slip', name:'æ°´å–®ç®¡ç†' },
    { id:'decl', name:'é€²å‡ºå£å ±å–®' },
    { id:'fx',   name:'åŒ¯å·®åˆ†æ' },
    { id:'audit',name:'ç¨½æ ¸è»Œè·¡' },
    { id:'data', name:'è³‡æ–™ç®¡ç†' }
  ];
  let activeTab = 'slip';
  let selectedDeclForDetailId = null; // Store the ID of the decl to show detail for
  let expandedSlipId = null; // Store the ID of the slip whose allocations are expanded

  function renderTabs(){
    elTabs.innerHTML = '';
    tabs.forEach(t=>{
      const b=document.createElement('button');
      b.className = 'tab'+(activeTab===t.id?' active':'');
      b.textContent = t.name;
      b.onclick = ()=>{ activeTab=t.id; render(); };
      elTabs.appendChild(b);
    })
  }

  function wrapField(labelText, input){ const w=document.createElement('div'); const l=document.createElement('label'); l.textContent=labelText; w.appendChild(l); w.appendChild(input); return w; }
  function button(text, kind, onclick){ const b=document.createElement('button'); b.className='btn '+(kind||''); b.textContent=text; b.onclick=onclick; return b; }
  function esc(s){ return String(s||'').replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

  // ------------------ Panels ------------------
  function panelSlip(){
    const box = document.createElement('div'); box.className='grid';

    const p = document.createElement('div'); p.className='card';
    p.innerHTML = `<h2>æ–°å¢æ°´å–®</h2>`;
    const row1 = document.createElement('div'); row1.className='grid cols-3';
    const date = document.createElement('input'); date.type='date';
    const currency = document.createElement('input'); currency.placeholder='å¹£åˆ¥ (å¦‚: USD)'; currency.value = state.settings.defaultCurrency;
    const rate = document.createElement('input'); rate.type='number'; rate.step='0.0001';
    const amount = document.createElement('input'); amount.type='number'; amount.step='0.01';
    const vendor = document.createElement('input'); vendor.placeholder='å» å•†/å®¢æˆ¶'; vendor.setAttribute('list','all-vendor-list'); vendor.id='newSlipVendor';
    const note = document.createElement('input'); note.placeholder='å‚™è¨» (é¸å¡«)';

    // Removed globalVendor auto-population here as per requirement

    row1.appendChild(wrapField('æ—¥æœŸ',date));
    row1.appendChild(wrapField('å¹£åˆ¥',currency));
    row1.appendChild(wrapField('åŒ¯ç‡',rate));
    row1.appendChild(wrapField('å¤–å¹£é‡‘é¡',amount));
    row1.appendChild(wrapField('å» å•†',vendor));
    row1.appendChild(wrapField('å‚™è¨»',note));
    const actions=document.createElement('div'); actions.className='right';
    const btn = button('æ–°å¢æ°´å–®','primary',()=>{
      if(!date.value||!vendor.value||!currency.value){ alert('è«‹å¡«å¯« æ—¥æœŸã€å¹£åˆ¥ èˆ‡ å» å•†'); return; }
      const obj={id:uid(), date:date.value, currency:currency.value.toUpperCase().trim(), rate:parseNum(rate.value), amount:parseNum(amount.value), vendor:vendor.value.trim(), note:note.value.trim()};
      state.slips.push(obj); log('æ–°å¢','æ°´å–®',obj.id, JSON.stringify(obj));
      save(); render();
    });
    actions.appendChild(btn);

    const batch = document.createElement('textarea');
    batch.placeholder = `æ‰¹é‡æ–°å¢ï¼šæ¯è¡Œè¼¸å…¥ã€Œæ—¥æœŸ,å¹£åˆ¥,åŒ¯ç‡,é‡‘é¡,å» å•†,å‚™è¨»ã€
ä¾‹å¦‚ï¼š
2025-01-05,USD,31.25,10000,Acme Ltd,TTåŒ¯å…¥
2025-01-08,JPY,0.215,500000,Acme Ltd,éƒ¨åˆ†é æ”¶`;
    const rowBatch = document.createElement('div'); rowBatch.className='row';
    rowBatch.appendChild(batch);
    const btnBatch = button('æ‰¹é‡åŒ¯å…¥æ°´å–®', 'warn', ()=>{
      const lines = batch.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      let ok=0, bad=0; const added=[];
      lines.forEach(line=>{
        const [d,c,r,a,v, n] = line.split(',').map(x=>x!=null?x.trim():x);
        if(d && c && v){ const obj={id:uid(), date:d, currency:c.toUpperCase(), rate:parseNum(r), amount:parseNum(a), vendor:v, note:n||''}; state.slips.push(obj); added.push(obj); ok++; } else bad++;
      });
      if(added.length) log('æ‰¹é‡åŒ¯å…¥','æ°´å–®','-', `${added.length} ç­†`);
      save(); alert(`æˆåŠŸ ${ok} ç­†ï¼Œç•¥é ${bad} ç­†ã€‚`); render();
    });
    rowBatch.appendChild(btnBatch);

    p.appendChild(row1); p.appendChild(actions); p.appendChild(document.createElement('hr')); p.appendChild(rowBatch);
    box.appendChild(p);

    const list = document.createElement('div'); list.className='card';
    list.innerHTML = `<h2>æ°´å–®æ­·å²</h2>`;
    const filter = document.createElement('div'); filter.className='row';
    const fVendor = document.createElement('input'); fVendor.placeholder='æœå°‹å» å•†'; fVendor.setAttribute('list','all-vendor-list'); fVendor.id='slipFilterVendor';
    const fFrom = document.createElement('input'); fFrom.type='date';
    const fTo = document.createElement('input'); fTo.type='date';
    filter.appendChild(wrapField('å» å•†', fVendor));
    filter.appendChild(wrapField('èµ·', fFrom));
    filter.appendChild(wrapField('è¿„', fTo));
    list.appendChild(filter);

    const tbl = document.createElement('table');
    const thead = document.createElement('thead'); thead.innerHTML = `<tr><th>æ—¥æœŸ</th><th>å» å•†</th><th class="small">å¹£åˆ¥</th><th class="small">åŒ¯ç‡</th><th class="small">å¤–å¹£é‡‘é¡</th><th>å¯ç”¨é‡‘é¡</th><th>å‚™è¨»</th><th>å‹•ä½œ</th></tr>`; tbl.appendChild(thead);
    const tbody = document.createElement('tbody');
    function drawBody(){
      tbody.innerHTML='';
      state.slips
        .filter(s=>!fVendor.value || (s.vendor||'').toLowerCase().includes(fVendor.value.toLowerCase()))
        .filter(s=>!fFrom.value || new Date(s.date)>=new Date(fFrom.value))
        .filter(s=>!fTo.value || new Date(s.date)<=new Date(fTo.value))
        .sort((a,b)=>new Date(b.date)-new Date(a.date))
        .forEach(s=>{
          const tr=document.createElement('tr');
          tr.setAttribute('data-slip-id', s.id);
          tr.innerHTML = `<td>${s.date}</td><td>${esc(s.vendor)}</td><td>${esc(s.currency||'N/A')}</td><td>${format(s.rate,4)}</td><td>${format(s.amount)}</td><td>${format(slipAvailable(s))}</td><td>${esc(s.note||'')}</td>`;
          const td=document.createElement('td');
          const viewAllocBtn = button('æŸ¥çœ‹åˆ†æ”¤','ghost',()=>{
            if (expandedSlipId === s.id) {
              expandedSlipId = null;
            } else {
              expandedSlipId = s.id;
            }
            render(); // Re-render to show/hide the allocation detail
          });
          const del=button('åˆªé™¤','danger',()=>{ if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ log('åˆªé™¤', 'æ°´å–®', s.id, JSON.stringify(s)); state.slips=state.slips.filter(x=>x.id!==s.id); state.allocs=state.allocs.filter(a=>a.slipId!==s.id); save(); render(); }});
          td.appendChild(viewAllocBtn);
          td.appendChild(del); tr.appendChild(td); tbody.appendChild(tr);

          // Add allocation detail row if this slip is expanded
          if (expandedSlipId === s.id) {
            const allocDetailRow = document.createElement('tr');
            allocDetailRow.className = 'allocation-detail-row';
            allocDetailRow.innerHTML = `<td colspan="8">
              <div class="allocation-detail-content card">
                <h4>å·²åˆ†é…è‡³å ±å–®ï¼š</h4>
                <table style="width:100%">
                  <thead><tr><th>å ±å–®æ—¥æœŸ</th><th>å» å•†</th><th>é¡å‹</th><th>åˆ†æ”¤é‡‘é¡(å¤–å¹£)</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </td>`;
            const allocTbody = allocDetailRow.querySelector('tbody');
            const relevantAllocs = state.allocs.filter(a => a.slipId === s.id);
            if (relevantAllocs.length === 0) {
              allocTbody.innerHTML = `<tr><td colspan="5" class="muted">ç„¡åˆ†æ”¤ç´€éŒ„</td></tr>`;
            } else {
              relevantAllocs.forEach(alloc => {
                const decl = state.decls.find(d => d.id === alloc.declId);
                if (decl) {
                  const allocTr = document.createElement('tr');
                  allocTr.innerHTML = `
                    <td>${decl.date}</td>
                    <td>${esc(decl.vendor)}</td>
                    <td>${decl.type}</td>
                    <td>${format(alloc.amount)} ${decl.currency||'N/A'}</td>
                  `;
                  const viewDeclTd = document.createElement('td');
                  const viewDeclBtn = button('æŸ¥çœ‹å ±å–®','ghost',()=>{
                    activeTab='fx'; selectedDeclForDetailId = decl.id; render();
                  });
                  viewDeclTd.appendChild(viewDeclBtn);
                  allocTr.appendChild(viewDeclTd);
                  allocTbody.appendChild(allocTr);
                }
              });
            }
            tbody.appendChild(allocDetailRow);
          }
        });
    }
    [fVendor,fFrom,fTo].forEach(el=>el.oninput=drawBody);
    const gv1 = (localStorage.getItem(GLOBAL_VENDOR_KEY)||'').trim(); if(gv1) fVendor.value=gv1;
    drawBody();

    tbl.appendChild(tbody); list.appendChild(tbl); box.appendChild(list);
    return box;
  }

  function panelDecl(){
    const box = document.createElement('div'); box.className='grid';

    const p = document.createElement('div'); p.className='card'; p.innerHTML='<h2>æ–°å¢é€²å‡ºå£å ±å–®</h2>';
    const row = document.createElement('div'); row.className='grid cols-3';
    const date = document.createElement('input'); date.type='date';
    const currency = document.createElement('input'); currency.placeholder='å¹£åˆ¥ (å¦‚: USD)'; currency.value = state.settings.defaultCurrency;
    const rate = document.createElement('input'); rate.type='number'; rate.step='0.0001';
    const amount = document.createElement('input'); amount.type='number'; amount.step='0.01';
    const vendor = document.createElement('input'); vendor.placeholder='å» å•†/å®¢æˆ¶'; vendor.setAttribute('list','slip-vendor-list'); vendor.id='newDeclVendor'; // Use slip-vendor-list
    const type = document.createElement('select'); type.innerHTML = '<option value="é€²å£">é€²å£</option><option value="å‡ºå£">å‡ºå£</option>';
    const note = document.createElement('input'); note.placeholder='å‚™è¨» (é¸å¡«)';

    // Removed globalVendor auto-population here as per requirement

    row.appendChild(wrapField('æ—¥æœŸ',date));
    row.appendChild(wrapField('å¹£åˆ¥',currency));
    row.appendChild(wrapField('åŒ¯ç‡',rate));
    row.appendChild(wrapField('å¤–å¹£é‡‘é¡',amount));
    row.appendChild(wrapField('å» å•†',vendor));
    row.appendChild(wrapField('é¡å‹',type));
    row.appendChild(wrapField('å‚™è¨»',note));

    const actions=document.createElement('div'); actions.className='right';
    const btn = button('æ–°å¢å ±å–®','primary',()=>{
      if(!date.value||!vendor.value||!currency.value){ alert('è«‹å¡«å¯« æ—¥æœŸã€å¹£åˆ¥ èˆ‡ å» å•†'); return; }
      // Check if vendor exists in slipVendors
      if (!slipVendors().includes(vendor.value.trim())) {
        alert('è«‹å¾ç¾æœ‰çš„æ°´å–®å» å•†ä¸­é¸æ“‡ï¼Œæˆ–å…ˆåˆ°æ°´å–®ç®¡ç†æ–°å¢è©²å» å•†ã€‚');
        return;
      }
      const obj={id:uid(), date:date.value, currency:currency.value.toUpperCase().trim(), rate:parseNum(rate.value), amount:parseNum(amount.value), vendor:vendor.value.trim(), type:type.value, note:note.value.trim()};
      state.decls.push(obj); log('æ–°å¢','å ±å–®',obj.id, JSON.stringify(obj));
      save(); render();
    });
    actions.appendChild(btn);

    const batch = document.createElement('textarea');
    batch.placeholder = `æ‰¹é‡æ–°å¢ï¼šæ¯è¡Œã€Œæ—¥æœŸ,å¹£åˆ¥,åŒ¯ç‡,é‡‘é¡,å» å•†,é¡å‹(é€²å£/å‡ºå£),å‚™è¨»ã€
ä¾‹å¦‚ï¼š
2025-01-09,USD,31.50,8000,Acme Ltd,é€²å£,1æœˆé€²å£
2025-01-12,JPY,0.218,1200000,Acme Ltd,å‡ºå£,1æœˆå‡ºå£`;
    const rowBatch = document.createElement('div'); rowBatch.className='row';
    rowBatch.appendChild(batch);
    const btnBatch = button('æ‰¹é‡åŒ¯å…¥å ±å–®', 'warn', ()=>{
      const lines = batch.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      let ok=0, bad=0;
      const validSlipVendors = new Set(slipVendors()); // Get valid vendors once
      lines.forEach(line=>{
        const [d,c,r,a,v,t,n] = line.split(',').map(x=>x!=null?x.trim():x);
        if(d && c && v && (t==='é€²å£'||t==='å‡ºå£') && validSlipVendors.has(v)){
          const obj={id:uid(), date:d, currency:c.toUpperCase(), rate:parseNum(r), amount:parseNum(a), vendor:v, type:t, note:n||''};
          state.decls.push(obj); ok++; log('æ‰¹é‡æ–°å¢','å ±å–®',obj.id, JSON.stringify(obj));
        } else bad++;
      });
      save(); alert(`æˆåŠŸ ${ok} ç­†ï¼Œç•¥é ${bad} ç­† (å¯èƒ½å› å» å•†åç¨±ä¸åœ¨æ°´å–®ç´€éŒ„ä¸­)ã€‚`); render();
    });
    rowBatch.appendChild(btnBatch);

    p.appendChild(row);
    p.appendChild(actions); p.appendChild(document.createElement('hr')); p.appendChild(rowBatch);
    box.appendChild(p);

    const list = document.createElement('div'); list.className='card';
    list.innerHTML = `<h2>å ±å–®æ­·å²</h2>`;
    const filter = document.createElement('div'); filter.className='row';
    const fVendor = document.createElement('input'); fVendor.placeholder='æœå°‹å» å•†'; fVendor.setAttribute('list','all-vendor-list'); fVendor.id='declFilterVendor';
    const fType = document.createElement('select'); fType.innerHTML='<option value="">å…¨éƒ¨</option><option>é€²å£</option><option>å‡ºå£</option>';
    const fFrom = document.createElement('input'); fFrom.type='date';
    const fTo = document.createElement('input'); fTo.type='date';
    filter.appendChild(wrapField('å» å•†', fVendor));
    filter.appendChild(wrapField('é¡å‹', fType));
    filter.appendChild(wrapField('èµ·', fFrom));
    filter.appendChild(wrapField('è¿„', fTo));
    list.appendChild(filter);

    const tbl = document.createElement('table');
    const thead = document.createElement('thead'); thead.innerHTML = `<tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>å» å•†</th><th class="small">å¹£åˆ¥</th><th>åŒ¯ç‡</th><th>å¤–å¹£é‡‘é¡</th><th>å·²åˆ†æ”¤</th><th>åˆ†æ”¤æ°´å–®</th><th></th></tr>`; tbl.appendChild(thead);
    const tbody = document.createElement('tbody');
    function drawBody(){
      tbody.innerHTML='';
      state.decls
        .filter(s=>!fVendor.value || (s.vendor||'').toLowerCase().includes(fVendor.value.toLowerCase()))
        .filter(s=>!fType.value || s.type===fType.value)
        .filter(s=>!fFrom.value || new Date(s.date)>=new Date(fFrom.value))
        .filter(s=>!fTo.value || new Date(s.date)<=new Date(fTo.value))
        .sort((a,b)=>new Date(b.date)-new Date(a.date))
        .forEach(s=>{
          const tr=document.createElement('tr');
          const totalAllocated = totalAllocatedForDecl(s.id);
          const slipTxt = totalAllocated > 0 ? `å·²åˆ†æ”¤ (${format(totalAllocated)} ${s.currency||'å¤–å¹£'})` : 'æœªåˆ†æ”¤';
          tr.innerHTML = `<td>${s.date}</td><td>${s.type}</td><td>${esc(s.vendor)}</td><td>${esc(s.currency||'N/A')}</td><td>${format(s.rate,4)}</td><td>${format(s.amount)}</td><td>${format(totalAllocated)}</td><td class="small">${slipTxt}</td>`;
          const td=document.createElement('td');
          const del=button('åˆªé™¤','danger',()=>{ if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ log('åˆªé™¤','å ±å–®',s.id, JSON.stringify(s)); state.decls=state.decls.filter(x=>x.id!==s.id); state.allocs=state.allocs.filter(a=>a.declId!==s.id); save(); render(); }});
          td.appendChild(del); tr.appendChild(td); tbody.appendChild(tr);
          tr.onclick=()=>{ activeTab='fx'; selectedDeclForDetailId = s.id; render(); };
          tr.setAttribute('data-decl-id', s.id);
        });
    }
    [fVendor,fType,fFrom,fTo].forEach(el=>el.oninput=drawBody);
    const gv2 = (localStorage.getItem(GLOBAL_VENDOR_KEY)||'').trim(); if(gv2) fVendor.value=gv2;
    drawBody();

    tbl.appendChild(tbody); list.appendChild(tbl); box.appendChild(list);
    return box;
  }

  function panelFx(){
    const box = document.createElement('div'); box.className='split';

    const left = document.createElement('div'); left.className='grid';
    const p = document.createElement('div'); p.className='card'; p.innerHTML = '<h2>åŒ¯å·®åˆ†æ</h2>';

    const filter = document.createElement('div'); filter.className='row';
    const fVendor = document.createElement('input'); fVendor.placeholder='æœå°‹å» å•†'; fVendor.setAttribute('list','all-vendor-list'); fVendor.id='fxFilterVendor';
    const fType = document.createElement('select'); fType.innerHTML='<option value="">å…¨éƒ¨</option><option>é€²å£</option><option>å‡ºå£</option>';
    const fFrom = document.createElement('input'); fFrom.type='date';
    const fTo = document.createElement('input'); fTo.type='date';
    filter.appendChild(wrapField('å» å•†', fVendor));
    filter.appendChild(wrapField('é¡å‹', fType));
    filter.appendChild(wrapField('èµ·', fFrom));
    filter.appendChild(wrapField('è¿„', fTo));
    p.appendChild(filter);

    const tbl = document.createElement('table');
    const thead = document.createElement('thead'); thead.innerHTML='<tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>å» å•†</th><th class="small">å¹£åˆ¥</th><th>é‡‘é¡(å¤–å¹£)</th><th>å ±å–®åŒ¯ç‡</th><th>åˆ†æ”¤æ°´å–®æ•¸</th><th>å·®é¡</th><th>åˆ¤æ–·</th></tr>';
    tbl.appendChild(thead);
    const tbody = document.createElement('tbody');

    function draw(){
      tbody.innerHTML='';
      const filtered = state.decls
        .filter(s=>!fVendor.value || (s.vendor||'').toLowerCase().includes(fVendor.value.toLowerCase()))
        .filter(s=>!fType.value || s.type===fType.value)
        .filter(s=>!fFrom.value || new Date(s.date)>=new Date(fFrom.value))
        .filter(s=>!fTo.value || new Date(s.date)<=new Date(fTo.value))
        .sort((a,b)=>new Date(b.date)-new Date(a.date));

      let sumGain=0, sumLoss=0;
      filtered.forEach(d=>{
        const r = computeFx(d);
        const tr=document.createElement('tr');
        const numSlipsAllocated = state.allocs.filter(a=>a.declId===d.id).length;
        tr.innerHTML = `<td>${d.date}</td><td>${d.type}</td><td>${esc(d.vendor)}</td><td>${esc(d.currency||'N/A')}</td><td>${format(d.amount)}</td><td>${format(d.rate,4)}</td><td>${numSlipsAllocated || '-'}</td>`;
        const tdDiff = document.createElement('td');
        tdDiff.innerHTML = `<span class="mono">${format(Math.abs(r.diff))}</span>`;
        const tdLabel = document.createElement('td');
        const pill = document.createElement('span'); pill.className='pill '+(r.kind==='gain'?'gain':(r.kind==='loss'?'loss':'')); pill.textContent=r.label;
        tdLabel.appendChild(pill);
        tr.appendChild(tdDiff); tr.appendChild(tdLabel);
        tr.onclick = ()=> showDetail(d);
        tr.setAttribute('data-decl-id', d.id);
        tbody.appendChild(tr);
        if(r.kind==='gain') sumGain += Math.abs(r.diff);
        if(r.kind==='loss') sumLoss += Math.abs(r.diff);
      });

      sumBar.textContent = `ç¸½ç›ˆé¤˜ï¼š${format(sumGain)} ï½œ ç¸½æå¤±ï¼š${format(sumLoss)}`;
    }

    [fVendor,fType,fFrom,fTo].forEach(el=>el.oninput=draw);
    const gv3 = (localStorage.getItem(GLOBAL_VENDOR_KEY)||'').trim(); if(gv3) fVendor.value=gv3;
    tbl.appendChild(tbody); p.appendChild(tbl);

    const sumBar = document.createElement('div'); sumBar.className='hint'; p.appendChild(sumBar);

    left.appendChild(p);

    const right = document.createElement('div'); right.className='card sticky'; right.innerHTML='<h2>æ˜ç´° / è¨ˆç®—éç¨‹</h2><div id="detail" class="small muted">é»æ“Šå·¦å´ä»»ä¸€ç­†è³‡æ–™ä»¥æŸ¥çœ‹</div><div id="alloc" style="margin-top:10px"></div>';

    function showDetail(d){
      const r = computeFx(d);
      const box = document.getElementById('detail');
      const allocBox = document.getElementById('alloc');
      if(!r){ box.textContent='ç™¼ç”ŸéŒ¯èª¤'; return; }
      box.className='small';
      const currencySymbol = d.currency || 'å¤–å¹£';
      const slipInfo = state.allocs.filter(a=>a.declId===d.id).length > 0 ? `å·²åˆ†æ”¤å¤šç­†æ°´å–®` : 'å°šæœªåˆ†æ”¤';
      box.innerHTML = `
      <div class="grid">
        <div><label>å ±å–®</label><div class="mono">${d.date}ï½œ${d.type}ï½œ${esc(d.vendor)}ï½œå¤–å¹£ ${currencySymbol} ${format(d.amount)}ï½œåŒ¯ç‡ ${format(d.rate,4)}</div></div>
        <div><label>é…å°æ°´å–®</label><div class="mono">${slipInfo}</div></div>
        <div><label>æ‡‰æ”¶æ‡‰ä»˜åˆ¤å®š</label><div>${r.arap||'â€”'}</div></div>
        <div><label>åˆ¤æ–·</label><div><span class="pill ${r.kind==='gain'?'gain':(r.kind==='loss'?'loss':'')}">${r.label}</span></div></div>
        <div><label>å·®é¡çµ•å°å€¼ï¼ˆæœ¬å¹£ï¼‰</label><div class="mono">${format(Math.abs(r.diff))}</div></div>
        <div><label>è¨ˆç®—éç¨‹</label><pre class="mono" style="white-space:pre-wrap;background:var(--panel-2);border:1px solid var(--border);padding:8px;border-radius:10px">${esc(r.steps||'â€”')}</pre></div>
      </div>`;

      // åˆ†æ”¤é…ç½® UI
      const sameVendorSlips = state.slips.filter(s=>s.vendor===d.vendor && s.currency===d.currency).sort((a,b)=>new Date(a.date)-new Date(b.date));
      const currentAllocs = state.allocs.filter(a=>a.declId===d.id);
      const totalAvailDecl = declAvailable(d);
      allocBox.innerHTML = '';
      const wrap = document.createElement('div'); wrap.className='card';
      const title = document.createElement('h2'); title.textContent='éƒ¨åˆ†æ²–éŠ· / åˆ†æ”¤é…ç½®'; wrap.appendChild(title);
      const hint = document.createElement('div'); hint.className='hint'; hint.textContent='å¯ç‚ºæ­¤å ±å–®åˆ†é…å¤šç­†æ°´å–®èˆ‡åˆ†æ”¤å¤–å¹£é‡‘é¡ã€‚è‹¥æœªè¨­å®šåˆ†æ”¤ï¼Œå‰‡åŒ¯å·®çµæœç‚ºé›¶ã€‚'; wrap.appendChild(hint);

      const tbl = document.createElement('table');
      tbl.innerHTML = '<thead><tr><th>æ°´å–®æ—¥æœŸ</th><th>å¹£åˆ¥</th><th>åŒ¯ç‡</th><th>æ°´å–®å¯ç”¨(å¤–å¹£)</th><th>åˆ†æ”¤é‡‘é¡(å¤–å¹£)</th><th></th></tr></thead>';
      const tbody = document.createElement('tbody');
      currentAllocs.forEach(a=>{
        const slip = state.slips.find(s=>s.id===a.slipId); if(!slip) return;
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${slip.date}</td><td>${esc(slip.currency||'N/A')}</td><td>${format(slip.rate,4)}</td><td>${format(slipAvailable(slip))}</td>`;
        const tdAmt = document.createElement('td');
        const inp = document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.value=a.amount; inp.onchange=()=>{ a.amount=parseNum(inp.value); log('ä¿®æ”¹åˆ†æ”¤','åˆ†æ”¤',a.id, `æ–°é‡‘é¡ ${a.amount}`); save(); render(); showDetail(d); };
        tdAmt.appendChild(inp); tr.appendChild(tdAmt);
        const tdAct=document.createElement('td');
        const del=button('ç§»é™¤','danger',()=>{ state.allocs=state.allocs.filter(x=>x.id!==a.id); log('ç§»é™¤åˆ†æ”¤','åˆ†æ”¤',a.id, JSON.stringify(a)); save(); render(); showDetail(d); });
        tdAct.appendChild(del); tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody); wrap.appendChild(tbl);

      // Add new allocation controls
      const addRow = document.createElement('div'); addRow.className='row';
      const sel = document.createElement('select');
      sel.innerHTML = sameVendorSlips.map(s=>`<option value="${s.id}">${s.date}ï½œ${esc(s.currency||'N/A')}ï½œå¯ç”¨${format(slipAvailable(s))}ï½œåŒ¯ç‡${format(s.rate,4)}</option>`).join('');
      const addAmt = document.createElement('input'); addAmt.type='number'; addAmt.step='0.01'; addAmt.placeholder='åˆ†æ”¤å¤–å¹£é‡‘é¡';
      addRow.appendChild(wrapField('é¸æ“‡æ°´å–®', sel));
      addRow.appendChild(wrapField('é‡‘é¡(å¤–å¹£)', addAmt));
      const addBtn = button('æ–°å¢åˆ†æ”¤','primary',()=>{
        const slip = state.slips.find(s=>s.id===sel.value);
        if(!slip){ alert('è«‹é¸æ“‡æ°´å–®'); return; }
        if(slip.currency !== d.currency){ alert('æ°´å–®èˆ‡å ±å–®å¹£åˆ¥ä¸ç¬¦ï¼Œç„¡æ³•åˆ†æ”¤ã€‚'); return; }
        const want = parseNum(addAmt.value);
        if(want<=0){ alert('é‡‘é¡éœ€å¤§æ–¼ 0'); return; }
        const max = Math.min(slipAvailable(slip), declAvailable(d));
        if(want>max){ alert(`è¶…éå¯åˆ†é…é‡‘é¡ï¼Œæœ€å¤§å¯åˆ†é…ï¼š${format(max)} ${currencySymbol}`); return; }
        const obj={id:uid(), declId:d.id, slipId:slip.id, amount:want};
        state.allocs.push(obj); log('æ–°å¢åˆ†æ”¤','åˆ†æ”¤',obj.id, JSON.stringify(obj)); save(); render(); showDetail(d);
      });
      addRow.appendChild(addBtn);
      wrap.appendChild(addRow);

      const info = document.createElement('div'); info.className='hint'; info.textContent = `æ­¤å ±å–®å‰©é¤˜å¯åˆ†é…ï¼š${format(totalAvailDecl)} ${currencySymbol}`;
      wrap.appendChild(info);

      // Wire quickbar buttons to current vendor
      const fifoBtn = document.getElementById('fifoAlloc'); if(fifoBtn) fifoBtn.onclick = ()=>{ const v=(localStorage.getItem(GLOBAL_VENDOR_KEY)||'').trim(); autoFIFO(v||null); };
      const clearBtn = document.getElementById('clearAlloc'); if(clearBtn) clearBtn.onclick = ()=>{ if(confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰åˆ†æ”¤ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')){ state.allocs=[]; log('æ¸…ç©º','åˆ†æ”¤','-','å…¨éƒ¨æ¸…é™¤'); save(); render(); } };

      allocBox.appendChild(wrap);
    }

    // helper: auto FIFO distribute within vendor context
    function autoFIFO(vendor){
      const decls = state.decls.filter(d=>!vendor || d.vendor===vendor).sort((a,b)=>new Date(a.date)-new Date(b.date));
      const slips = state.slips.filter(s=>!vendor || s.vendor===vendor).sort((a,b)=>new Date(a.date)-new Date(b.date));
      // reset vendor-related allocs
      if(vendor){
        const allocsToRemove = new Set();
        state.decls.filter(d => d.vendor === vendor).forEach(d => {
          state.allocs.filter(a => a.declId === d.id).forEach(a => allocsToRemove.add(a.id));
        });
        state.allocs = state.allocs.filter(a => !allocsToRemove.has(a.id));
      }
      let si=0;
      decls.forEach(d=>{
        let need = declAvailable(d);
        while(need>0 && si<slips.length){
          const s = slips[si];
          if (s.currency !== d.currency) {
              si++;
              continue;
          }
          let avail = slipAvailable(s);
          if(avail<=0){ si++; continue; }
          const take = Math.min(need, avail);
          const obj={id:uid(), declId:d.id, slipId:s.id, amount:take};
          state.allocs.push(obj); need -= take; log('FIFOåˆ†æ”¤','åˆ†æ”¤',obj.id, `${d.id} â‡„ ${s.id} / ${take}`);
          if(slipAvailable(s)<=0) si++;
        }
      });
      save(); render();
    }

    box.appendChild(left); box.appendChild(right);
    return box;
  }

  function panelAudit(){
    const box=document.createElement('div'); box.className='card';
    box.innerHTML='<h2>ç¨½æ ¸è»Œè·¡</h2>';
    const hint=document.createElement('div'); hint.className='hint'; hint.textContent='è¨˜éŒ„æ–°å¢/åˆªé™¤/æ‰¹é‡åŒ¯å…¥/åˆ†æ”¤ç­‰æ“ä½œï¼ˆåƒ…å­˜æœ¬æ©Ÿï¼‰ã€‚'; box.appendChild(hint);
    const tbl=document.createElement('table');
    tbl.innerHTML='<thead><tr><th>æ™‚é–“</th><th>å‹•ä½œ</th><th>é¡å‹</th><th>ID</th><th>èªªæ˜</th></tr></thead>';
    const tbody=document.createElement('tbody');
    state.audit.forEach(a=>{
      const tr=document.createElement('tr');
      const t = new Date(a.time).toLocaleString();
      tr.innerHTML=`<td>${t}</td><td>${esc(a.action)}</td><td>${esc(a.entity)}</td><td class="mono">${esc(a.entityId)}</td><td class="small">${esc(a.detail||'')}</td>`;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody); box.appendChild(tbl);
    return box;
  }

  function panelData(){
    const box = document.createElement('div'); box.className='grid';

    const s = document.createElement('div'); s.className='card'; s.innerHTML='<h2>ç³»çµ±è¨­å®š</h2>';
    const mode = document.createElement('select'); mode.innerHTML='<option value="mul">æœ¬å¹£=å¤–å¹£Ã—åŒ¯ç‡</option><option value="div">æœ¬å¹£=å¤–å¹£Ã·åŒ¯ç‡</option>';
    mode.value = state.settings.rateMode;
    mode.onchange = ()=>{ state.settings.rateMode=mode.value; log('ä¿®æ”¹è¨­å®š','ç³»çµ±','rateMode', mode.value); save(); };

    const defaultCurrencyInput = document.createElement('input');
    defaultCurrencyInput.placeholder = 'é è¨­å¤–å¹£å¹£åˆ¥ (å¦‚: USD)';
    defaultCurrencyInput.value = state.settings.defaultCurrency;
    defaultCurrencyInput.onchange = () => {
      state.settings.defaultCurrency = defaultCurrencyInput.value.toUpperCase().trim();
      log('ä¿®æ”¹è¨­å®š', 'ç³»çµ±', 'defaultCurrency', defaultCurrencyInput.value);
      save(); render();
    };

    const note = document.createElement('div'); note.className='hint';
    note.textContent = 'ä¸»é¡Œè‡ªå‹•èª¿æ•´æ–‡å­—é¡è‰²ï¼›åŒ¯ç‡æ¨¡å¼ä¾æ‚¨å…¬å¸ç¿’æ…£èª¿æ•´ã€‚';

    s.appendChild(wrapField('åŒ¯ç‡è§£è®€', mode));
    s.appendChild(wrapField('é è¨­å¤–å¹£å¹£åˆ¥', defaultCurrencyInput));
    s.appendChild(note);

    const d = document.createElement('div'); d.className='card'; d.innerHTML='<h2>è³‡æ–™å‚™ä»½</h2>';
    const ta = document.createElement('textarea'); ta.value = JSON.stringify(state, null, 2);
    const row = document.createElement('div'); row.className='right';
    row.appendChild(button('é‡æ–°è¼‰å…¥é è¦½','ghost',()=>{ ta.value = JSON.stringify(state,null,2); }));
    row.appendChild(button('å¾æ–‡å­—åŒ¯å…¥','warn',()=>{ try{ const obj=JSON.parse(ta.value); Object.assign(state,obj); log('åŒ¯å…¥','è³‡æ–™','JSON',''); save(); render(); }catch(e){ alert('JSON æ ¼å¼éŒ¯èª¤'); } }));
    row.appendChild(button('æ¸…ç©ºæ‰€æœ‰è³‡æ–™','danger',()=>{ if(confirm('æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šï¼Ÿ')){ localStorage.removeItem(storeKey); location.reload(); } }));

    d.appendChild(ta); d.appendChild(row);

    box.appendChild(s); box.appendChild(d);
    return box;
  }

  // ------------------ Render Root ------------------
  function render(){
    // Update global vendor datalists
    const globalVendorsList = document.getElementById('global-vendor-list');
    if(globalVendorsList){ globalVendorsList.innerHTML = allVendors().map(v=>`<option value="${v}"></option>`).join(''); }

    const allVendorsDatalist = document.getElementById('all-vendor-list');
    if(allVendorsDatalist){ allVendorsDatalist.innerHTML = allVendors().map(v=>`<option value="${v}"></option>`).join(''); }
    
    const slipVendorsDatalist = document.getElementById('slip-vendor-list');
    if(slipVendorsDatalist){ slipVendorsDatalist.innerHTML = slipVendors().map(v=>`<option value="${v}"></option>`).join(''); }

    // quickbar vendor list + default
    const gv = document.getElementById('globalVendor'); if(gv){
      const savedGV = localStorage.getItem(GLOBAL_VENDOR_KEY)||''; if(gv.value!==savedGV) gv.value=savedGV;
      gv.oninput = ()=>{ localStorage.setItem(GLOBAL_VENDOR_KEY, gv.value.trim()); render(); };
    }

    // Set filters to global vendor
    const slipFilterVendor = document.getElementById('slipFilterVendor');
    if (slipFilterVendor) { slipFilterVendor.value = localStorage.getItem(GLOBAL_VENDOR_KEY) || ''; }
    const declFilterVendor = document.getElementById('declFilterVendor');
    if (declFilterVendor) { declFilterVendor.value = localStorage.getItem(GLOBAL_VENDOR_KEY) || ''; }
    const fxFilterVendor = document.getElementById('fxFilterVendor');
    if (fxFilterVendor) { fxFilterVendor.value = localStorage.getItem(GLOBAL_VENDOR_KEY) || ''; }


    renderTabs();
    elPanels.innerHTML='';
    const panel =
      activeTab==='slip' ? panelSlip() :
      activeTab==='decl' ? panelDecl() :
      activeTab==='fx' ? panelFx() :
      activeTab==='audit' ? panelAudit() :
      panelData();
    elPanels.appendChild(panel);

    // If there's a pending detail to show, and we're on the FX tab, show it
    if (activeTab === 'fx' && selectedDeclForDetailId) {
      const decl = state.decls.find(d => d.id === selectedDeclForDetailId);
      if (decl) {
        setTimeout(() => {
          const detailDeclRow = elPanels.querySelector(`table tbody tr[data-decl-id="${decl.id}"]`);
          if (detailDeclRow) {
            detailDeclRow.click();
          }
        }, 0);
      }
      selectedDeclForDetailId = null; // Clear after attempting to show
    }
  }

  // boot
  render();
})();
</script>
</body>
</html>