<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多冊批量計算與核算工具 (v2)</title>

    <style>
        :root {
            --color-bg: #f9f9f9;
            --color-surface: #ffffff;
            --color-border: #e0e0e0;
            --color-text-primary: #222222;
            --color-text-secondary: #555555;
            --color-text-accent: #007aff;
            --color-text-monospace: #d9480f;
            --color-error: #d9534f;
            --color-success: #4caf50;
            --color-info: #007aff;
            --color-button-bg: #f0f0f0;
            --color-button-hover-bg: #e0e0e0;
            --color-button-primary-bg: #333333;
            --color-button-primary-text: #ffffff;
            --color-button-danger-bg: #d9534f;
            --color-button-danger-text: #ffffff;

            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-family-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;

            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;

            --border-radius: 6px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* --- 1. Base & Layout --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: var(--font-family-sans);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            line-height: 1.6;
            padding: var(--spacing-l);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            gap: var(--spacing-l);
        }

        header {
            padding-bottom: var(--spacing-m);
            border-bottom: 2px solid var(--color-border);
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--spacing-m);
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
        }

        h2.summary-out-title {
            color: var(--color-error);
        }

        h2.summary-in-title {
            color: var(--color-success);
        }

        h2.summary-calc-title {
            color: var(--color-info);
        }


        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            padding: var(--spacing-m);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-s);
        }

        h3 .book-title {
            flex: 1;
            min-width: 100px;
        }

        h3 .tax-rate-badge {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--color-text-secondary);
            background-color: var(--color-bg);
            padding: var(--spacing-xs) var(--spacing-s);
            border-radius: var(--border-radius);
        }

        /* --- 2. Panels & Cards --- */
        .panel {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .config-panel,
        .actions-panel {
            padding: var(--spacing-m);
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-m);
            align-items: center;
        }

        /* 【NEW】Global config panel */
        .global-config-panel {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: var(--spacing-l);
            background-color: var(--color-surface);
            padding: var(--spacing-m);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            align-items: center;
        }

        .rounding-config {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-s);
        }

        .rounding-config legend {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-secondary);
        }

        .rounding-options {
            display: flex;
            gap: var(--spacing-s);
            align-items: center;
        }

        .toggle-switch {
            display: flex;
            gap: var(--spacing-s);
        }

        .toggle-switch label {
            padding: var(--spacing-xs) var(--spacing-s);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .toggle-switch input[type="radio"] {
            display: none;
        }

        .toggle-switch input[type="radio"]:checked+label {
            background-color: var(--color-button-primary-bg);
            color: var(--color-button-primary-text);
            border-color: var(--color-button-primary-bg);
        }

        /* 【NEW】Book header controls */
        .book-header-controls {
            display: flex;
            gap: var(--spacing-s);
            align-items: center;
            flex-wrap: wrap;
        }

        .book-input-mode {
            display: flex;
            gap: var(--spacing-xs);
        }

        .book-input-mode label {
            padding: var(--spacing-xs) var(--spacing-s);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            background-color: var(--color-bg);
        }

        .book-input-mode input[type="radio"],
        .book-input-mode input[type="checkbox"] {
            display: none;
        }

        .book-input-mode input:checked+label {
            background-color: var(--color-button-primary-bg);
            color: var(--color-button-primary-text);
            border-color: var(--color-button-primary-bg);
        }

        /* 【NEW】Editable entry values */
        .entry-value {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
        }

        .entry-value:hover {
            background-color: var(--color-bg);
        }

        .entry-value.editing {
            background-color: var(--color-surface);
            border: 1px solid var(--color-text-accent);
        }

        .entry-edit-input {
            width: 100%;
            font-family: var(--font-family-mono);
            font-size: 0.95rem;
            border: none;
            background: transparent;
            text-align: right;
            outline: none;
        }

        .actions-panel {
            background: none;
            border: none;
            box-shadow: none;
            padding: 0;
            justify-content: flex-end;
        }

        /* 【NEW】Floating add button */
        .floating-add-btn {
            position: fixed;
            bottom: var(--spacing-l);
            right: var(--spacing-l);
            z-index: 1000;
            border-radius: 50px;
            padding: var(--spacing-m) var(--spacing-l);
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .floating-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .floating-add-btn {
                bottom: var(--spacing-m);
                right: var(--spacing-m);
                padding: var(--spacing-s) var(--spacing-m);
                font-size: 0.9rem;
            }
        }

        .summary-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-l);
        }

        @media (max-width: 900px) {
            .summary-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .summary-container {
                grid-template-columns: 1fr;
            }
        }

        .books-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: var(--spacing-l);
        }

        .book {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* For border-radius */
        }

        /* --- 3. Forms & Inputs --- */
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-secondary);
        }

        input[type="number"],
        input[type="text"],
        select {
            font-family: var(--font-family-mono);
            font-size: 1rem;
            padding: var(--spacing-s);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-surface);
        }

        input[type="number"]:focus-visible,
        input[type="text"]:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--color-text-accent);
            outline-offset: 2px;
            border-color: var(--color-text-accent);
        }

        button {
            font-family: var(--font-family-sans);
            font-size: 0.9rem;
            padding: var(--spacing-s) var(--spacing-m);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-button-bg);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover,
        button:focus-visible {
            background-color: var(--color-button-hover-bg);
        }

        button:focus-visible {
            outline: 2px solid var(--color-text-accent);
            outline-offset: 2px;
        }

        button.btn-primary {
            background-color: var(--color-button-primary-bg);
            color: var(--color-button-primary-text);
            border-color: var(--color-button-primary-bg);
            font-weight: 500;
        }

        button.btn-primary:hover,
        button.btn-primary:focus-visible {
            background-color: #000;
        }

        button.btn-danger {
            background-color: var(--color-button-danger-bg);
            color: var(--color-button-danger-text);
            border-color: var(--color-button-danger-bg);
        }

        button.btn-danger:hover,
        button.btn-danger:focus-visible {
            background-color: #c9302c;
        }

        .entry-form {
            padding: var(--spacing-m);
            border-top: 1px solid var(--color-border);
        }

        .entry-form input {
            width: 100%;
        }

        .error-message {
            font-size: 0.85rem;
            color: var(--color-error);
            margin-top: var(--spacing-s);
            display: none;
            /* Hidden by default */
        }

        .book.has-error .entry-form input {
            border-color: var(--color-error);
        }

        .book.has-error .error-message {
            display: block;
        }

        .hidden {
            display: none;
        }

        /* --- 4. Data Display --- */
        .entries-list {
            padding: var(--spacing-s) var(--spacing-m);
            max-height: 250px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            /* New entries appear at the bottom */
        }

        /* 【MODIFIED】Grid layout 4 columns */
        .entry {
            display: grid;
            grid-template-columns: 0.6fr 1.2fr 1fr 1.2fr;
            gap: var(--spacing-s);
            padding: var(--spacing-xs) 0;
            font-family: var(--font-family-mono);
            font-size: 0.95rem;
            border-bottom: 1px dashed var(--color-border);
        }

        .entry span:nth-child(1) {
            /* Type */
            font-size: 0.8rem;
            font-weight: 500;
            text-align: left;
            padding: 2px 4px;
            border-radius: var(--border-radius);
            align-self: center;
        }

        .entry span.type-out {
            color: var(--color-error);
            background-color: #fdeaea;
        }

        .entry span.type-in {
            color: var(--color-success);
            background-color: #eaf7eb;
        }

        .entry span:nth-child(2) {
            text-align: right;
        }

        /* Untaxed */
        .entry span:nth-child(3) {
            text-align: right;
            color: var(--color-text-secondary);
        }

        /* Tax */
        .entry span:nth-child(4) {
            text-align: right;
            font-weight: 500;
        }

        /* Total */

        /* 【MODIFIED】Grid layout 4 columns */
        .entry-header {
            display: grid;
            grid-template-columns: 0.6fr 1.2fr 1fr 1.2fr;
            gap: var(--spacing-s);
            padding: var(--spacing-xs) 0;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            padding: var(--spacing-xs) var(--spacing-m);
        }

        .entry-header span:nth-child(1) {
            text-align: left;
        }

        .entry-header span:nth-child(2) {
            text-align: right;
        }

        .entry-header span:nth-child(3) {
            text-align: right;
        }

        .entry-header span:nth-child(4) {
            text-align: right;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: var(--spacing-m);
            padding: var(--spacing-m);
        }

        .summary-grid>div {
            display: contents;
            /* Allows grid layout to apply to children */
        }

        .summary-key {
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .summary-value {
            font-family: var(--font-family-mono);
            font-weight: 600;
            text-align: right;
            font-size: 1.1rem;
            color: var(--color-text-primary);
        }

        .summary-value.is-error {
            color: var(--color-error);
        }

        .summary-value.is-success {
            color: var(--color-success);
        }

        /* 【NEW】Final tax calculation display */
        .final-tax-panel {
            padding: var(--spacing-l);
            text-align: center;
        }

        .final-tax-panel .summary-key {
            font-size: 1.1rem;
            text-align: center;
            display: block;
        }

        .final-tax-panel .summary-value {
            font-size: 2rem;
            text-align: center;
            display: block;
            margin-top: var(--spacing-s);
        }

        .final-tax-panel .summary-value.is-payable {
            color: var(--color-error);
        }

        .final-tax-panel .summary-value.is-creditable {
            color: var(--color-success);
        }

        .book-summary {
            border-top: 1px solid var(--color-border);
            background-color: var(--color-bg);
        }

        /* 【NEW】Per-book verification */
        .book-verification {
            background-color: var(--color-bg);
            border-top: 1px solid var(--color-border);
        }

        .book-verification summary {
            font-size: 0.9rem;
            font-weight: 500;
            padding: var(--spacing-s) var(--spacing-m);
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .book-verification summary:hover {
            background-color: var(--color-button-hover-bg);
        }

        .book-verification .summary-grid {
            background-color: var(--color-surface);
        }

        /* --- 5. Toast Notifications (for Zero-Console-Issue) --- */
        #toast-container {
            position: fixed;
            top: var(--spacing-l);
            right: var(--spacing-l);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-m);
        }

        .toast {
            padding: var(--spacing-m);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background-color: var(--color-success);
            color: white;
        }

        .toast.error {
            background-color: var(--color-error);
            color: white;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>多冊批量計算與核算工具 (v2)</h1>
        </header>

        <main>
            <div class="summary-container">
                <div class="panel">
                    <h2 class="summary-out-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="19" x2="12" y2="5"></line>
                            <polyline points="5 12 12 5 19 12"></polyline>
                        </svg>
                        銷項總覽 (OUT)
                    </h2>
                    <div class="summary-grid" id="summaryOutPanel">
                        <div>
                            <span class="summary-key">總筆數</span>
                            <span class="summary-value" id="grandTotalOutCount">0</span>
                        </div>
                        <div>
                            <span class="summary-key">總未稅銷售額</span>
                            <span class="summary-value" id="grandTotalOutUntaxed">0.00</span>
                        </div>
                        <div>
                            <span class="summary-key">總稅額</span>
                            <span class="summary-value" id="grandTotalOutTax">0</span>
                        </div>
                        <div>
                            <span class="summary-key">總總計</span>
                            <span class="summary-value" id="grandTotalOutTotal">0.00</span>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2 class="summary-in-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <polyline points="19 12 12 19 5 12"></polyline>
                        </svg>
                        進項總覽 (IN)
                    </h2>
                    <div class="summary-grid" id="summaryInPanel">
                        <div>
                            <span class="summary-key">總筆數</span>
                            <span class="summary-value" id="grandTotalInCount">0</span>
                        </div>
                        <div>
                            <span class="summary-key">總未稅銷售額</span>
                            <span class="summary-value" id="grandTotalInUntaxed">0.00</span>
                        </div>
                        <div>
                            <span class="summary-key">總稅額</span>
                            <span class="summary-value" id="grandTotalInTax">0</span>
                        </div>
                        <div>
                            <span class="summary-key">總總計</span>
                            <span class="summary-value" id="grandTotalInTotal">0.00</span>
                        </div>
                    </div>
                </div>

                <div class="panel final-tax-panel">
                    <h2 class="summary-calc-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.21 15.89A10 10 0 1 1 8.11 3h7.9A7 7 0 0 0 21.21 15.89z"></path>
                        </svg>
                        預估稅額
                    </h2>
                    <span class="summary-key" id="finalTaxLabel">應繳稅額</span>
                    <span class="summary-value" id="finalTaxValue">0</span>
                </div>
            </div>

            <div class="global-config-panel">
                <div class="form-group">
                    <label for="taxRateInput">當前稅率設定 (%)</label>
                    <input type="number" id="taxRateInput" value="5" min="0" step="0.01" style="width: 150px;">
                </div>

                <div class="rounding-config">
                    <legend>稅額計算方式</legend>
                    <div class="rounding-options">
                        <fieldset class="toggle-switch">
                            <input type="radio" id="roundOriginal" name="roundingMode" value="original" checked>
                            <label for="roundOriginal">照原本</label>
                            
                            <input type="radio" id="roundNormal" name="roundingMode" value="round">
                            <label for="roundNormal">四捨五入</label>

                            <input type="radio" id="roundUp" name="roundingMode" value="ceil">
                            <label for="roundUp">無條件進位</label>

                            <input type="radio" id="roundDown" name="roundingMode" value="floor">
                            <label for="roundDown">無條件捨去</label>
                        </fieldset>

                        <div class="form-group" style="margin-left: var(--spacing-m);">
                            <label for="decimalPlaces" style="font-size: 0.75rem;">取到第幾位</label>
                            <select id="decimalPlaces" style="font-size: 0.8rem; padding: var(--spacing-xs);">
                                <option value="0" selected>整數位</option>
                                <option value="1">小數第1位</option>
                                <option value="2">小數第2位</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="text-align: right; font-size: 0.8rem; color: var(--color-text-secondary);">
                    輸入模式請在各冊標題列設定
                </div>
            </div>

            <div class="actions-panel">
                <div>
                    <button id="exportBtn">匯出 JSON</button>
                    <button id="importBtn">匯入 JSON</button>
                    <input type="file" id="importFileInput" accept="application/json" class="hidden">
                    <button id="clearAllBtn" class="btn-danger">全部清除</button>
                </div>
            </div>

            <div id="booksContainer" class="books-container">
            </div>
        </main>
    </div>

    <div id="toast-container"></div>
    
    <!-- 【NEW】Floating add button -->
    <button id="addNewBookBtn" class="btn-primary floating-add-btn">＋ 新增一冊</button>

    <template id="bookTemplate">
        <article class="book">
            <h3>
                <span class="book-title">第 X 冊</span>

                <div class="book-header-controls">
                    <div class="book-input-mode">
                        <input type="radio" name="bookEntryType" value="IN" class="book-type-in">
                        <label for="">進項</label>

                        <input type="radio" name="bookEntryType" value="OUT" class="book-type-out" checked>
                        <label for="">銷項</label>
                    </div>

                    <div class="book-input-mode">
                        <input type="checkbox" class="book-inclusive">
                        <label for="">含稅</label>
                    </div>
                </div>

                <span class="tax-rate-badge">稅率: Y%</span>
            </h3>

            <div class="entry-header">
                <span>類型</span>
                <span>未稅額</span>
                <span>稅額</span>
                <span>總計</span>
            </div>
            <div class="entries-list">
            </div>

            <form class="entry-form" novalidate>
                <input type="number" step="0.01" placeholder="輸入金額 (Enter 提交)">
                <div class="error-message"></div>
            </form>

            <div class="book-summary">
                <div class="summary-grid">
                    <div>
                        <span class="summary-key">本冊筆數</span>
                        <span class="summary-value book-summary-count">0</span>
                    </div>
                    <div>
                        <span class="summary-key">本冊未稅加總</span>
                        <span class="summary-value book-summary-untaxed">0.00</span>
                    </div>
                    <div>
                        <span class="summary-key">本冊稅額加總</span>
                        <span class="summary-value book-summary-tax">0</span>
                    </div>
                    <div>
                        <span class="summary-key">本冊總計加總</span>
                        <span class="summary-value book-summary-total">0.00</span>
                    </div>
                </div>
            </div>

            <details class="book-verification">
                <summary>本冊核算驗證</summary>
                <div class="summary-grid">
                    <div>
                        <span class="summary-key">核算未稅總額</span>
                        <span class="summary-value book-verify-untaxed">0.00</span>
                    </div>
                    <div>
                        <span class="summary-key">核算稅額總額</span>
                        <span class="summary-value book-verify-tax">0.00</span>
                    </div>
                    <div>
                        <span class="summary-key">核算誤差 (絕對值)</span>
                        <span class="summary-value book-verify-error">0.00</span>
                    </div>
                </div>
            </details>

        </article>
    </template>

    <script type="module">
        // 嚴格模式
        "use strict";

        // --- 0. Constants and State ---
        const STORAGE_KEY = 'multiBookCalculatorData_v1';

        // DOM Elements
        const taxRateInput = document.getElementById('taxRateInput');
        const addNewBookBtn = document.getElementById('addNewBookBtn');
        const booksContainer = document.getElementById('booksContainer');
        const bookTemplate = document.getElementById('bookTemplate');

        // 【NEW】Rounding Mode Elements
        const roundOriginal = document.getElementById('roundOriginal');
        const roundNormal = document.getElementById('roundNormal');
        const roundUp = document.getElementById('roundUp');
        const roundDown = document.getElementById('roundDown');
        const decimalPlaces = document.getElementById('decimalPlaces');

        const entryFormPlaceholders = {
            exclusive: "輸入未稅金額 (Enter 提交)",
            inclusive: "輸入含稅總額 (Enter 提交)"
        };

        // 【REBUILT】Summary Panel Elements
        const grandTotalOutCountEl = document.getElementById('grandTotalOutCount');
        const grandTotalOutUntaxedEl = document.getElementById('grandTotalOutUntaxed');
        const grandTotalOutTaxEl = document.getElementById('grandTotalOutTax');
        const grandTotalOutTotalEl = document.getElementById('grandTotalOutTotal');

        const grandTotalInCountEl = document.getElementById('grandTotalInCount');
        const grandTotalInUntaxedEl = document.getElementById('grandTotalInUntaxed');
        const grandTotalInTaxEl = document.getElementById('grandTotalInTax');
        const grandTotalInTotalEl = document.getElementById('grandTotalInTotal');

        const finalTaxLabelEl = document.getElementById('finalTaxLabel');
        const finalTaxValueEl = document.getElementById('finalTaxValue');

        // Actions
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFileInput = document.getElementById('importFileInput');
        const clearAllBtn = document.getElementById('clearAllBtn');

        const toastContainer = document.getElementById('toast-container');

        // Application State
        let state = {
            books: [], // Array of book objects
            globalTaxRate: 5.0,
            // 【NEW】Global rounding settings
            roundingMode: 'original', // 'original' | 'round' | 'ceil' | 'floor'
            decimalPlaces: 0, // 0, 1, 2
        };

        let saveTimeout;

        // --- 1. Utility Functions ---

        /**
         * 根據設定進行數值捨入
         */
        function applyRounding(value, mode = state.roundingMode, places = state.decimalPlaces) {
            if (mode === 'original') {
                // 照原本：使用傳統的四捨五入到整數
                return Math.round(value);
            }
            
            const multiplier = Math.pow(10, places);
            let result;

            switch (mode) {
                case 'ceil':
                    result = Math.ceil(value * multiplier) / multiplier;
                    break;
                case 'floor':
                    result = Math.floor(value * multiplier) / multiplier;
                    break;
                case 'round':
                default:
                    result = Math.round(value * multiplier) / multiplier;
                    break;
            }

            return result;
        }

        /**
         * 財務捨入：四捨五入到小數點後 2 位 (保持向後相容)
         */
        function round(value) {
            return Math.round(value * 100) / 100;
        }

        /**
         * 【NEW】根據設定格式化數字顯示（支援動態精度和千位分隔符）
         */
        function formatNumber(value, decimalPlaces = state.decimalPlaces) {
            if (isNaN(value)) return '0';
            
            // 根據設定的小數位數格式化
            const formatted = Number(value).toFixed(decimalPlaces);
            
            // 添加千位分隔符
            const parts = formatted.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            return parts.join('.');
        }

        /**
         * 格式化數字為貨幣顯示 (保持向後相容)
         */
        function formatDisplay(value) {
            return formatNumber(value, state.decimalPlaces);
        }

        /**
         * 格式化數字為整數顯示 (用於稅額，但會根據設定調整)
         */
        function formatInteger(value) {
            return formatNumber(value, state.decimalPlaces);
        }

        /**
         * 顯示 UI Toast 通知
         */
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => { toast.classList.add('show'); }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 500);
            }, 3000);
        }

        /**
         * 在特定輸入框顯示錯誤
         */
        function showInputError(inputElement, message) {
            const bookElement = inputElement.closest('.book');
            if (!bookElement) return;

            const errorEl = bookElement.querySelector('.error-message');
            bookElement.classList.add('has-error');
            if (errorEl) {
                errorEl.textContent = message;
            }
        }

        /**
         * 清除特定輸入框的錯誤
         */
        function clearInputError(inputElement) {
            const bookElement = inputElement.closest('.book');
            if (!bookElement) return;

            const errorEl = bookElement.querySelector('.error-message');
            bookElement.classList.remove('has-error');
            if (errorEl) {
                errorEl.textContent = '';
            }
        }

        // --- 2. State Management & Persistence (Data Ownership) ---

        /**
         * 延遲保存狀態到 localStorage
         */
        function debouncedSaveState() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveState, 300);
        }

        /**
         * 立即保存狀態到 localStorage
         */
        function saveState() {
            try {
                const data = JSON.stringify(state);
                localStorage.setItem(STORAGE_KEY, data);
            } catch (e) {
                showToast('儲存資料時發生錯誤，空間可能已滿。', 'error');
            }
        }

        /**
         * 從 localStorage 載入狀態
         */
        function loadState() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const parsedData = JSON.parse(data);
                    // 基礎 Schema 驗證
                    if (parsedData && Array.isArray(parsedData.books) && typeof parsedData.globalTaxRate === 'number') {
                        state = parsedData;

                        // 【NEW】確保舊資料有新的 state 屬性
                        state.roundingMode = state.roundingMode || 'original';
                        state.decimalPlaces = state.decimalPlaces !== undefined ? state.decimalPlaces : 0;

                    } else {
                        resetState(false); // 載入失敗，重置但不新增
                    }
                }
            } catch (e) {
                showToast('載入本地資料失敗，將重置為預設值。', 'error');
                resetState(false); // 載入失敗，重置但不新增
            }

            // 確保每本書都有輸入模式屬性
            state.books.forEach(book => {
                if (book.entryType === undefined) book.entryType = 'OUT';
                if (book.isInclusive === undefined) book.isInclusive = false;
            });

            // 如果載入後一本都沒有，才新增第一冊
            if (state.books.length === 0) {
                addNewBook();
            }
        }

        /**
         * 重置狀態
         * @param {boolean} [createFirstBook=true] - 是否自動創建第一冊
         */
        function resetState(createFirstBook = true) {
            state = {
                books: [],
                globalTaxRate: 5.0,
                roundingMode: 'original',
                decimalPlaces: 0,
            };
            if (createFirstBook) {
                addNewBook();
            }
            updateRoundingModeUI();
        }

        // --- 3. Core Calculation Logic (as per spec) ---

        /**
         * 重新計算並更新所有總結
         */
        function updateAllCalculations() {
            let grandTotal = {
                IN: { count: 0, untaxed: 0, tax: 0, total: 0 },
                OUT: { count: 0, untaxed: 0, tax: 0, total: 0 }
            };

            // 1. 更新每冊的總結
            state.books.forEach(book => {
                let bookTotals = {
                    count: 0,
                    untaxed: 0,
                    tax: 0,
                    total: 0
                };

                book.entries.forEach(entry => {
                    // 累加到冊
                    bookTotals.count++;
                    bookTotals.untaxed += entry.untaxed;
                    bookTotals.tax += entry.tax;
                    bookTotals.total += entry.total;

                    // 累加到總
                    const type = entry.type; // 'IN' or 'OUT'
                    grandTotal[type].count++;
                    grandTotal[type].untaxed += entry.untaxed;
                    grandTotal[type].tax += entry.tax;
                    grandTotal[type].total += entry.total;
                });

                // 儲存計算結果到 state
                book.totals = {
                    count: bookTotals.count,
                    untaxed: round(bookTotals.untaxed),
                    tax: Math.round(bookTotals.tax),
                    total: round(bookTotals.total)
                };

                // 更新 DOM (分冊顯示)
                updateBookSummaryDOM(book);

                // 【NEW】執行分冊核算
                runBookVerification(book);
            });

            // 2. 處理總結的浮點數精度
            grandTotal.IN.untaxed = round(grandTotal.IN.untaxed);
            grandTotal.IN.tax = Math.round(grandTotal.IN.tax);
            grandTotal.IN.total = round(grandTotal.IN.total);

            grandTotal.OUT.untaxed = round(grandTotal.OUT.untaxed);
            grandTotal.OUT.tax = Math.round(grandTotal.OUT.tax);
            grandTotal.OUT.total = round(grandTotal.OUT.total);

            // 3. 更新總結 DOM
            grandTotalOutCountEl.textContent = grandTotal.OUT.count;
            grandTotalOutUntaxedEl.textContent = formatDisplay(grandTotal.OUT.untaxed);
            grandTotalOutTaxEl.textContent = formatInteger(grandTotal.OUT.tax);
            grandTotalOutTotalEl.textContent = formatDisplay(grandTotal.OUT.total);

            grandTotalInCountEl.textContent = grandTotal.IN.count;
            grandTotalInUntaxedEl.textContent = formatDisplay(grandTotal.IN.untaxed);
            grandTotalInTaxEl.textContent = formatInteger(grandTotal.IN.tax);
            grandTotalInTotalEl.textContent = formatDisplay(grandTotal.IN.total);

            // 4. 執行最終稅額計算
            const finalTax = grandTotal.OUT.tax - grandTotal.IN.tax;
            if (finalTax >= 0) {
                finalTaxLabelEl.textContent = "應繳稅額";
                finalTaxValueEl.textContent = formatInteger(finalTax);
                finalTaxValueEl.className = 'summary-value is-payable';
            } else {
                finalTaxLabelEl.textContent = "可留抵稅額";
                finalTaxValueEl.textContent = formatInteger(Math.abs(finalTax));
                finalTaxValueEl.className = 'summary-value is-creditable';
            }
        }

        /**
         * 【MODIFIED】執行反向核算驗證 (針對特定冊)
         * @param {object} book - The book object from state
         */
        function runBookVerification(book) {
            const bookElement = booksContainer.querySelector(`.book[data-book-id="${book.id}"]`);
            if (!bookElement) return;

            const verifyUntaxedEl = bookElement.querySelector('.book-verify-untaxed');
            const verifyTaxEl = bookElement.querySelector('.book-verify-tax');
            const verifyErrorEl = bookElement.querySelector('.book-verify-error');

            const rate = book.taxRate / 100;
            const bookTotal = book.totals.total;
            const bookTax = book.totals.tax;

            if (rate <= -1) { // 避免除以 0
                verifyUntaxedEl.textContent = 'N/A';
                verifyTaxEl.textContent = 'N/A';
                verifyErrorEl.textContent = 'N/A';
                return;
            }

            const verifiedUntaxed = bookTotal / (1 + rate);
            const verifiedTax = bookTotal - verifiedUntaxed; // float
            const verificationError = Math.abs(bookTax - verifiedTax); // (integer) vs (float)

            verifyUntaxedEl.textContent = formatDisplay(verifiedUntaxed);
            verifyTaxEl.textContent = formatDisplay(verifiedTax);
            verifyErrorEl.textContent = formatDisplay(verificationError);

            verifyErrorEl.className = verificationError < 0.01
                ? 'summary-value book-verify-error is-success'
                : 'summary-value book-verify-error is-error';
        }


        // --- 4. DOM Rendering ---

        /**
         * 渲染所有 state 中的 books
         */
        function renderAllBooks() {
            booksContainer.innerHTML = ''; // 清空
            state.books.forEach(book => renderBook(book));
            updateAllCalculations();
            updateInputModePlaceholders(); // 更新所有輸入框的 placeholder
        }

        /**
         * 渲染單一冊
         */
        function renderBook(book) {
            const bookElement = bookTemplate.content.cloneNode(true);
            const article = bookElement.querySelector('.book');
            const titleEl = bookElement.querySelector('.book-title');
            const taxRateEl = bookElement.querySelector('.tax-rate-badge');
            const entriesListEl = bookElement.querySelector('.entries-list');
            const formEl = bookElement.querySelector('.entry-form');
            const inputEl = bookElement.querySelector('input[type="number"]');

            // 【NEW】Book input mode controls
            const typeInEl = bookElement.querySelector('.book-type-in');
            const typeOutEl = bookElement.querySelector('.book-type-out');
            const inclusiveEl = bookElement.querySelector('.book-inclusive');

            article.dataset.bookId = book.id;
            titleEl.textContent = `第 ${book.index} 冊`;
            taxRateEl.textContent = `稅率: ${book.taxRate}%`;

            // 【NEW】設定每冊的輸入模式控制
            const bookId = book.id;
            typeInEl.name = `bookEntryType_${bookId}`;
            typeOutEl.name = `bookEntryType_${bookId}`;
            typeInEl.id = `bookTypeIn_${bookId}`;
            typeOutEl.id = `bookTypeOut_${bookId}`;
            inclusiveEl.id = `bookInclusive_${bookId}`;

            // 設定對應的label
            typeInEl.nextElementSibling.setAttribute('for', typeInEl.id);
            typeOutEl.nextElementSibling.setAttribute('for', typeOutEl.id);
            inclusiveEl.nextElementSibling.setAttribute('for', inclusiveEl.id);

            // 設定初始值
            if (book.entryType === 'IN') {
                typeInEl.checked = true;
            } else {
                typeOutEl.checked = true;
            }
            inclusiveEl.checked = book.isInclusive;

            // 更新 placeholder
            inputEl.placeholder = book.isInclusive ? entryFormPlaceholders.inclusive : entryFormPlaceholders.exclusive;

            // 【NEW】綁定輸入模式變更事件
            typeInEl.addEventListener('change', () => updateBookInputMode(bookId));
            typeOutEl.addEventListener('change', () => updateBookInputMode(bookId));
            inclusiveEl.addEventListener('change', () => updateBookInputMode(bookId));

            // 渲染該冊所有條目
            entriesListEl.innerHTML = '';
            book.entries.forEach(entry => {
                renderEntry(entriesListEl, entry);
            });

            // 綁定表單提交事件
            formEl.addEventListener('submit', (e) => handleEntrySubmit(e, book.id));
            inputEl.addEventListener('input', () => clearInputError(inputEl));

            booksContainer.appendChild(bookElement);
        }

        /**
         * 【REBUILT】渲染單一條目 (改回 span 顯示)
         * @param {HTMLElement} listElement - The .entries-list element
         * @param {object} entry - The entry object
         */
        function renderEntry(listElement, entry) {
            const entryEl = document.createElement('div');
            entryEl.className = 'entry';
            entryEl.dataset.entryId = entry.id;

            const typeText = entry.type === 'IN' ? '進項' : '銷項';
            const typeClass = entry.type === 'IN' ? 'type-in' : 'type-out';

            entryEl.innerHTML = `
                <span class="entry-type ${typeClass}">${typeText}</span>
                <span class="entry-value" data-field="untaxed">${formatDisplay(entry.untaxed)}</span>
                <span class="entry-value" data-field="tax">${formatInteger(entry.tax)}</span>
                <span class="entry-value" data-field="total">${formatDisplay(entry.total)}</span>
            `;

            // 【NEW】為可編輯數值添加點擊事件
            entryEl.querySelectorAll('.entry-value').forEach(valueEl => {
                valueEl.addEventListener('click', () => makeEntryValueEditable(valueEl, entry));
            });

            listElement.appendChild(entryEl);
        }

        /**
         * 更新指定 book 的 DOM 總結
         */
        function updateBookSummaryDOM(book) {
            const bookElement = booksContainer.querySelector(`.book[data-book-id="${book.id}"]`);
            if (!bookElement) return;

            bookElement.querySelector('.book-summary-count').textContent = book.totals.count;
            bookElement.querySelector('.book-summary-untaxed').textContent = formatDisplay(book.totals.untaxed);
            bookElement.querySelector('.book-summary-tax').textContent = formatInteger(book.totals.tax);
            bookElement.querySelector('.book-summary-total').textContent = formatDisplay(book.totals.total);
        }


        /**
         * 【NEW】更新書本的輸入模式
         */
        function updateBookInputMode(bookId) {
            const book = state.books.find(b => b.id === bookId);
            if (!book) return;

            const bookElement = booksContainer.querySelector(`.book[data-book-id="${bookId}"]`);
            if (!bookElement) return;

            const typeInEl = bookElement.querySelector('.book-type-in');
            const inclusiveEl = bookElement.querySelector('.book-inclusive');
            const inputEl = bookElement.querySelector('input[type="number"]');

            book.entryType = typeInEl.checked ? 'IN' : 'OUT';
            book.isInclusive = inclusiveEl.checked;

            // 更新輸入框placeholder
            inputEl.placeholder = book.isInclusive ? entryFormPlaceholders.inclusive : entryFormPlaceholders.exclusive;

            debouncedSaveState();
        }

        /**
         * 【NEW】讓條目數值可編輯
         */
        function makeEntryValueEditable(valueEl, entry) {
            if (valueEl.classList.contains('editing')) return;

            const field = valueEl.dataset.field;
            const currentValue = entry[field];

            valueEl.classList.add('editing');
            const originalText = valueEl.textContent;

            const input = document.createElement('input');
            input.className = 'entry-edit-input';
            input.type = 'number';
            input.step = field === 'tax' ? '1' : '0.01';
            input.value = currentValue;

            valueEl.innerHTML = '';
            valueEl.appendChild(input);
            input.focus();
            input.select();

            const finishEdit = (save = false) => {
                if (save && input.value !== '' && !isNaN(input.value)) {
                    const newValue = parseFloat(input.value);
                    entry[field] = newValue;

                    // 重新計算相關數值
                    if (field === 'untaxed') {
                        const book = state.books.find(b => b.entries.some(e => e.id === entry.id));
                        if (book) {
                            entry.tax = applyRounding(newValue * book.taxRate / 100);
                            entry.total = round(newValue + entry.tax);
                        }
                    } else if (field === 'total') {
                        const book = state.books.find(b => b.entries.some(e => e.id === entry.id));
                        if (book) {
                            entry.untaxed = round(newValue / (1 + book.taxRate / 100));
                            entry.tax = applyRounding(entry.untaxed * book.taxRate / 100);
                        }
                    } else if (field === 'tax') {
                        entry.tax = applyRounding(newValue);
                        entry.total = round(entry.untaxed + entry.tax);
                    }

                    updateAllCalculations();
                    debouncedSaveState();
                }

                valueEl.classList.remove('editing');
                const displayValue = field === 'tax' ? formatInteger(entry[field]) : formatDisplay(entry[field]);
                valueEl.textContent = displayValue;
            };

            input.addEventListener('blur', () => finishEdit(true));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    finishEdit(true);
                } else if (e.key === 'Escape') {
                    finishEdit(false);
                }
            });
        }

        /**
         * 【NEW】更新四捨五入模式UI
         */
        function updateRoundingModeUI() {
            if (roundOriginal) roundOriginal.checked = state.roundingMode === 'original';
            if (roundNormal) roundNormal.checked = state.roundingMode === 'round';
            if (roundUp) roundUp.checked = state.roundingMode === 'ceil';
            if (roundDown) roundDown.checked = state.roundingMode === 'floor';
            if (decimalPlaces) decimalPlaces.value = state.decimalPlaces.toString();
        }

        // --- 5. Event Handlers ---

        /**
         * 處理新增一冊
         */
        function addNewBook() {
            const newBook = {
                id: `book-${Date.now()}`,
                index: state.books.length + 1,
                taxRate: state.globalTaxRate, // 鎖定當前稅率
                entries: [],
                totals: { count: 0, untaxed: 0, tax: 0, total: 0 },
                // 【NEW】每冊的輸入模式設定
                entryType: 'OUT', // 'IN' | 'OUT'
                isInclusive: false // bool
            };
            state.books.push(newBook);
            renderBook(newBook); // 只渲染新增的
            debouncedSaveState();
        }

        /**
         * 【REBUILT】處理單筆輸入提交
         * @param {Event} event - The form submit event
         * @param {string} bookId - The ID of the book being added to
         */
        function handleEntrySubmit(event, bookId) {
            event.preventDefault();
            const form = event.target;
            const input = form.querySelector('input[type="number"]');

            const inputValue = parseFloat(input.value);

            // 判斷1: 無效輸入或負值
            if (isNaN(inputValue) || inputValue < 0) {
                showInputError(input, "輸入無效，請輸入大於或等於 0 的數字。");
                input.value = ''; // 清空無效輸入
                input.focus();
                return;
            }

            clearInputError(input);

            const book = state.books.find(b => b.id === bookId);
            if (!book) return;

            // 步驟4: 單筆計算 (使用該冊鎖定的稅率和輸入模式)
            const rate = book.taxRate / 100;
            let untaxed, tax, total;

            if (book.isInclusive) {
                // 含稅模式
                total = round(inputValue);
                untaxed = round(total / (1 + rate));
                tax = applyRounding(total - untaxed); // 使用設定的捨入方式
            } else {
                // 未稅模式
                untaxed = round(inputValue);
                tax = applyRounding(untaxed * rate); // 使用設定的捨入方式
                total = round(untaxed + tax);
            }

            const entry = {
                id: `entry-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                type: book.entryType, // 使用該冊的類型設定
                untaxed: untaxed,
                tax: tax,
                total: total
            };

            // 步驟5: 更新 state
            book.entries.push(entry);

            // 更新 DOM
            const listElement = form.previousElementSibling; // .entries-list
            renderEntry(listElement, entry);

            // 步驟6: 更新總結並儲存
            updateAllCalculations();
            debouncedSaveState();

            // 步驟7: 清空輸入框以便連續輸入
            input.value = '';
            input.focus();
        }

        /**
         * 處理稅率變更
         */
        function handleTaxRateChange(event) {
            const newRate = parseFloat(event.target.value);
            if (isNaN(newRate) || newRate < 0) {
                event.target.value = state.globalTaxRate; // 恢復原值
                showToast("稅率必須是有效的正數。", "error");
                return;
            }
            state.globalTaxRate = newRate;

            // 稅率變更會影響核算驗證，所以要重新計算
            updateAllCalculations();
            debouncedSaveState();
        }

        /**
         * 【NEW】處理四捨五入模式變更
         */
        function handleRoundingModeChange() {
            if (roundOriginal && roundOriginal.checked) state.roundingMode = 'original';
            else if (roundNormal && roundNormal.checked) state.roundingMode = 'round';
            else if (roundUp && roundUp.checked) state.roundingMode = 'ceil';
            else if (roundDown && roundDown.checked) state.roundingMode = 'floor';

            if (decimalPlaces) state.decimalPlaces = parseInt(decimalPlaces.value);

            // 【NEW】重新計算所有數值並更新顯示
            if (state.roundingMode !== 'original') {
                recalculateAllEntries();
            }
            updateAllCalculations();
            renderAllBooks();
            
            debouncedSaveState();
        }

        /**
         * 【NEW】重新計算所有條目的稅額（當四捨五入模式變更時）
         */
        function recalculateAllEntries() {
            state.books.forEach(book => {
                book.entries.forEach(entry => {
                    const rate = book.taxRate / 100;
                    // 重新計算稅額，使用新的四捨五入設定
                    entry.tax = applyRounding(entry.untaxed * rate);
                    entry.total = round(entry.untaxed + entry.tax);
                });
            });
        }

        /**
         * 【NEW】更新全域設定 UI (通常在載入時)
         */
        function updateGlobalUI() {
            taxRateInput.value = state.globalTaxRate;
            updateRoundingModeUI();
        }

        /**
         * 處理全部清除
         */
        function handleClearAll() {
            if (confirm("您確定要清除所有冊和全部數據嗎？此操作無法復原。")) {
                resetState(true); // 重置並建立新冊
                renderAllBooks(); // 渲染
                saveState(); // 立即儲存
                showToast("所有數據已清除。", "success");
            }
        }

        /**
         * 處理 JSON 匯出
         */
        function handleExport() {
            try {
                const data = JSON.stringify(state, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.href = url;
                a.download = `multi-book-calculator-backup-${timestamp}.json`;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast("資料匯出成功。", "success");
            } catch (e) {
                showToast("匯出失敗。", "error");
            }
        }

        /**
         * 處理匯入按鈕點擊
         */
        function handleImportClick() {
            importFileInput.click();
        }

        /**
         * 處理檔案匯入 (覆蓋模式)
         */
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (importedData && Array.isArray(importedData.books) && typeof importedData.globalTaxRate === 'number') {
                        if (confirm("匯入將會覆蓋當前所有資料，確定要繼續嗎？")) {
                            state = importedData;

                            // 【NEW】確保匯入的資料有新 state
                            state.entryType = state.entryType || 'OUT';
                            state.isInclusive = state.isInclusive || false;

                            updateGlobalUI(); // 更新 UI 上的設定
                            renderAllBooks();
                            saveState();
                            showToast("資料匯入並覆蓋成功。", "success");
                        }
                    } else {
                        throw new Error("無效的檔案格式。");
                    }
                } catch (err) {
                    showToast(`匯入失敗：${err.message}`, "error");
                } finally {
                    importFileInput.value = '';
                }
            };

            reader.onerror = () => {
                showToast("讀取檔案失敗。", "error");
                importFileInput.value = '';
            };

            reader.readAsText(file);
        }

        // --- 6. Initialization ---

        /**
         * 應用程式初始化
         */
        function init() {
            // 綁定全域事件
            taxRateInput.addEventListener('change', handleTaxRateChange);
            addNewBookBtn.addEventListener('click', addNewBook);

            // 【NEW】綁定四捨五入模式
            if (roundOriginal) roundOriginal.addEventListener('change', handleRoundingModeChange);
            if (roundNormal) roundNormal.addEventListener('change', handleRoundingModeChange);
            if (roundUp) roundUp.addEventListener('change', handleRoundingModeChange);
            if (roundDown) roundDown.addEventListener('change', handleRoundingModeChange);
            if (decimalPlaces) decimalPlaces.addEventListener('change', handleRoundingModeChange);

            // 綁定匯出/匯入/清除
            exportBtn.addEventListener('click', handleExport);
            importBtn.addEventListener('click', handleImportClick);
            importFileInput.addEventListener('change', handleImportFile);
            clearAllBtn.addEventListener('click', handleClearAll);

            // 載入資料並渲染
            loadState();
            updateGlobalUI();
            renderAllBooks();

            if (state.books.length === 0 || (state.books.length === 1 && state.books[0].entries.length === 0)) {
                updateAllCalculations();
            }
        }

        // --- 7. Run Application ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    </script>
</body>

</html>