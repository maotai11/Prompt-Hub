
<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå†Šæ‰¹é‡è¨ˆç®—èˆ‡æ ¸ç®—å·¥å…· (v2)</title>

    <style>
        :root {
            --color-bg: #f9f9f9;
            --color-surface: #ffffff;
            --color-border: #e0e0e0;
            --color-text-primary: #222222;
            --color-text-secondary: #555555;
            --color-text-accent: #007aff;
            --color-text-monospace: #d9480f;
            --color-error: #d9534f;
            --color-success: #4caf50;
            --color-info: #007aff;
            --color-button-bg: #f0f0f0;
            --color-button-hover-bg: #e0e0e0;
            --color-button-primary-bg: #333333;
            --color-button-primary-text: #ffffff;
            --color-button-danger-bg: #d9534f;
            --color-button-danger-text: #ffffff;

            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-family-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;

            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;

            --border-radius: 6px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* --- 1. Base & Layout --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: var(--font-family-sans);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            line-height: 1.6;
            padding: var(--spacing-l);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            gap: var(--spacing-l);
        }

        header {
            padding-bottom: var(--spacing-m);
            border-bottom: 2px solid var(--color-border);
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--spacing-m);
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
        }

        h2.summary-out-title {
            color: var(--color-error);
        }

        h2.summary-in-title {
            color: var(--color-success);
        }

        h2.summary-calc-title {
            color: var(--color-info);
        }


        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            padding: var(--spacing-m);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-s);
        }

        h3 .book-title {
            flex: 1;
            min-width: 100px;
        }

        h3 .tax-rate-badge {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--color-text-secondary);
            background-color: var(--color-bg);
            padding: var(--spacing-xs) var(--spacing-s);
            border-radius: var(--border-radius);
        }

        /* --- 2. Panels & Cards --- */
        .panel {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .config-panel,
        .actions-panel {
            padding: var(--spacing-m);
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-m);
            align-items: center;
        }

        /* ã€NEWã€‘Global config panel */
        .global-config-panel {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: var(--spacing-l);
            background-color: var(--color-surface);
            padding: var(--spacing-m);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            align-items: center;
        }

        .rounding-config {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-s);
        }

        .rounding-config legend {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-secondary);
        }

        .rounding-options {
            display: flex;
            gap: var(--spacing-s);
            align-items: center;
        }

        .toggle-switch {
            display: flex;
            gap: var(--spacing-s);
        }

        .toggle-switch label {
            padding: var(--spacing-xs) var(--spacing-s);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .toggle-switch input[type="radio"] {
            display: none;
        }

        .toggle-switch input[type="radio"]:checked+label {
            background-color: var(--color-button-primary-bg);
            color: var(--color-button-primary-text);
            border-color: var(--color-button-primary-bg);
        }

        /* ã€NEWã€‘Book header controls */
        .book-header-controls {
            display: flex;
            gap: var(--spacing-s);
            align-items: center;
            flex-wrap: wrap;
        }

        .book-input-mode {
            display: flex;
            gap: var(--spacing-xs);
        }

        .book-input-mode label {
            padding: var(--spacing-xs) var(--spacing-s);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            background-color: var(--color-bg);
        }

        .book-input-mode input[type="radio"],
        .book-input-mode input[type="checkbox"] {
            display: none;
        }

        .book-input-mode input:checked+label {
            background-color: var(--color-button-primary-bg);
            color: var(--color-button-primary-text);
            border-color: var(--color-button-primary-bg);
        }

        /* ã€NEWã€‘Editable entry values */
        .entry-value {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
        }

        .entry-value:hover {
            background-color: var(--color-bg);
        }

        .entry-value.editing {
            background-color: var(--color-surface);
            border: 1px solid var(--color-text-accent);
        }

        .entry-edit-input {
            width: 100%;
            font-family: var(--font-family-mono);
            font-size: 0.95rem;
            border: none;
            background: transparent;
            text-align: right;
            outline: none;
        }

        .actions-panel {
            background: none;
            border: none;
            box-shadow: none;
            padding: 0;
            justify-content: flex-end;
        }

        /* ã€NEWã€‘Floating add button */
        .floating-add-btn {
            position: fixed;
            bottom: var(--spacing-l);
            right: var(--spacing-l);
            z-index: 1000;
            border-radius: 50px;
            padding: var(--spacing-m) var(--spacing-l);
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .floating-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .floating-add-btn {
                bottom: var(--spacing-m);
                right: var(--spacing-m);
                padding: var(--spacing-s) var(--spacing-m);
                font-size: 0.9rem;
            }
        }

        .summary-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-l);
        }

        @media (max-width: 900px) {
            .summary-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .summary-container {
                grid-template-columns: 1fr;
            }
        }

        .books-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: var(--spacing-l);
        }

        .book {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* For border-radius */
        }

        /* --- 3. Forms & Inputs --- */
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-secondary);
        }

        input[type="number"],
        input[type="text"],
        select {
            font-family: var(--font-family-mono);
            font-size: 1rem;
            padding: var(--spacing-s);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-surface);
        }

        input[type="number"]:focus-visible,
        input[type="text"]:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--color-text-accent);
            outline-offset: 2px;
            border-color: var(--color-text-accent);
        }

        button {
            font-family: var(--font-family-sans);
            font-size: 0.9rem;
            padding: var(--spacing-s) var(--spacing-m);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-button-bg);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover,
        button:focus-visible {
            background-color: var(--color-button-hover-bg);
        }

        button:focus-visible {
            outline: 2px solid var(--color-text-accent);
            outline-offset: 2px;
        }

        button.btn-primary {
            background-color: var(--color-button-primary-bg);
            color: var(--color-button-primary-text);
            border-color: var(--color-button-primary-bg);
            font-weight: 500;
        }

        button.btn-primary:hover,
        button.btn-primary:focus-visible {
            background-color: #000;
        }

        button.btn-danger {
            background-color: var(--color-button-danger-bg);
            color: var(--color-button-danger-text);
            border-color: var(--color-button-danger-bg);
        }

        button.btn-danger:hover,
        button.btn-danger:focus-visible {
            background-color: #c9302c;
        }

        .entry-form {
            padding: var(--spacing-m);
            border-top: 1px solid var(--color-border);
        }

        .entry-form input {
            width: 100%;
        }

        .error-message {
            font-size: 0.85rem;
            color: var(--color-error);
            margin-top: var(--spacing-s);
            display: none;
            /* Hidden by default */
        }

        .book.has-error .entry-form input {
            border-color: var(--color-error);
        }

        .book.has-error .error-message {
            display: block;
        }

        .hidden {
            display: none;
        }

        /* --- 4. Data Display --- */
        .entries-list {
            padding: var(--spacing-s) var(--spacing-m);
            max-height: 250px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            /* New entries appear at the bottom */
        }

        /* ã€MODIFIEDã€‘Grid layout 5 columns - patch: 2025-11-08 æ–°å¢æ“ä½œæ¬„ */
        .entry {
            display: grid;
            grid-template-columns: 0.6fr 1.2fr 1fr 1.2fr auto;
            gap: var(--spacing-s);
            padding: var(--spacing-xs) 0;
            font-family: var(--font-family-mono);
            font-size: 0.95rem;
            border-bottom: 1px dashed var(--color-border);
            align-items: center;
        }

        /* patch: 2025-11-08 æ¢ç›®æ“ä½œæŒ‰éˆ•æ¨£å¼ */
        .entry-actions {
            display: flex;
            gap: var(--spacing-xs);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .entry:hover .entry-actions {
            opacity: 1;
        }

        .entry-action-btn {
            padding: 2px 6px;
            font-size: 0.7rem;
            border: 1px solid var(--color-border);
            border-radius: 3px;
            background-color: var(--color-surface);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .entry-action-btn:hover {
            background-color: var(--color-button-hover-bg);
        }

        .entry-action-btn.btn-delete {
            color: var(--color-error);
            border-color: var(--color-error);
        }

        .entry-action-btn.btn-delete:hover {
            background-color: var(--color-error);
            color: white;
        }

        .entry span:nth-child(1) {
            /* Type */
            font-size: 0.8rem;
            font-weight: 500;
            text-align: left;
            padding: 2px 4px;
            border-radius: var(--border-radius);
            align-self: center;
        }

        .entry span.type-out {
            color: var(--color-error);
            background-color: #fdeaea;
        }

        .entry span.type-in {
            color: var(--color-success);
            background-color: #eaf7eb;
        }

        .entry span:nth-child(2) {
            text-align: right;
        }

        /* Untaxed */
        .entry span:nth-child(3) {
            text-align: right;
            color: var(--color-text-secondary);
        }

        /* Tax */
        .entry span:nth-child(4) {
            text-align: right;
            font-weight: 500;
        }

        /* Total */

        /* ã€MODIFIEDã€‘Grid layout 5 columns - patch: 2025-11-08 æ–°å¢æ“ä½œæ¬„ */
        .entry-header {
            display: grid;
            grid-template-columns: 0.6fr 1.2fr 1fr 1.2fr auto;
            gap: var(--spacing-s);
            padding: var(--spacing-xs) 0;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            padding: var(--spacing-xs) var(--spacing-m);
        }

        .entry-header span:nth-child(1) {
            text-align: left;
        }

        .entry-header span:nth-child(2) {
            text-align: right;
        }

        .entry-header span:nth-child(3) {
            text-align: right;
        }

        .entry-header span:nth-child(4) {
            text-align: right;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: var(--spacing-m);
            padding: var(--spacing-m);
        }

        .summary-grid>div {
            display: contents;
            /* Allows grid layout to apply to children */
        }

        .summary-key {
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .summary-value {
            font-family: var(--font-family-mono);
            font-weight: 600;
            text-align: right;
            font-size: 1.1rem;
            color: var(--color-text-primary);
        }

        .summary-value.is-error {
            color: var(--color-error);
        }

        .summary-value.is-success {
            color: var(--color-success);
        }

        /* ã€NEWã€‘Final tax calculation display */
        .final-tax-panel {
            padding: var(--spacing-l);
            text-align: center;
        }

        .final-tax-panel .summary-key {
            font-size: 1.1rem;
            text-align: center;
            display: block;
        }

        .final-tax-panel .summary-value {
            font-size: 2rem;
            text-align: center;
            display: block;
            margin-top: var(--spacing-s);
        }

        .final-tax-panel .summary-value.is-payable {
            color: var(--color-error);
        }

        .final-tax-panel .summary-value.is-creditable {
            color: var(--color-success);
        }

        .book-summary {
            border-top: 1px solid var(--color-border);
            background-color: var(--color-bg);
        }

        /* ã€NEWã€‘Per-book verification */
        .book-verification {
            background-color: var(--color-bg);
            border-top: 1px solid var(--color-border);
        }

        .book-verification summary {
            font-size: 0.9rem;
            font-weight: 500;
            padding: var(--spacing-s) var(--spacing-m);
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .book-verification summary:hover {
            background-color: var(--color-button-hover-bg);
        }

        .book-verification .summary-grid {
            background-color: var(--color-surface);
        }

        /* --- 5. Toast Notifications (for Zero-Console-Issue) --- */
        #toast-container {
            position: fixed;
            top: var(--spacing-l);
            right: var(--spacing-l);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-m);
        }

        .toast {
            padding: var(--spacing-m);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background-color: var(--color-success);
            color: white;
        }

        .toast.error {
            background-color: var(--color-error);
            color: white;
        }

        /* patch: 2025-11-08 æ™ºæ…§æ ¸å°æ¨¡å¼æ¨£å¼ */
        .book.has-warning {
            border: 2px solid #ff9800;
            box-shadow: 0 0 8px rgba(255, 152, 0, 0.3);
        }

        .book.has-warning h3 {
            background-color: #fff3e0;
        }

        .warning-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: var(--border-radius);
            background-color: #ff9800;
            color: white;
            font-weight: 500;
        }

        /* patch: 2025-11-08 å„²å­˜ç´€éŒ„æ¨£å¼ */
        .saved-records-panel {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: var(--spacing-m);
        }

        .saved-records-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-s);
            max-height: 200px;
            overflow-y: auto;
            margin-top: var(--spacing-m);
        }

        .saved-record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-s) var(--spacing-m);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-bg);
            transition: all 0.2s;
        }

        .saved-record-item:hover {
            background-color: var(--color-button-hover-bg);
        }

        .saved-record-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .saved-record-name {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .saved-record-date {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-family: var(--font-family-mono);
        }

        .saved-record-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .saved-record-actions button {
            padding: var(--spacing-xs) var(--spacing-s);
            font-size: 0.8rem;
        }

        /* patch: 2025-11-08 å„²å­˜å°è©±æ¡†æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background-color: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            padding: var(--spacing-l);
            min-width: 400px;
            max-width: 90vw;
        }

        .modal-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: var(--spacing-m);
        }

        .modal-body {
            margin-bottom: var(--spacing-l);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-s);
        }

        .modal-input {
            width: 100%;
            padding: var(--spacing-s);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            margin-top: var(--spacing-s);
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>å¤šå†Šæ‰¹é‡è¨ˆç®—èˆ‡æ ¸ç®—å·¥å…· (v2)</h1>
        </header>

        <main>
            <div class="summary-container">
                <div class="panel">
                    <h2 class="summary-out-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="19" x2="12" y2="5"></line>
                            <polyline points="5 12 12 5 19 12"></polyline>
                        </svg>
                        éŠ·é …ç¸½è¦½ (OUT)
                    </h2>
                    <div class="summary-grid" id="summaryOutPanel">
                        <div>
                            <span class="summary-key">ç¸½ç­†æ•¸</span>
                            <span class="summary-value" id="grandTotalOutCount">0</span>
                        </div>
                        <div>
                            <span class="summary-key">ç¸½æœªç¨…éŠ·å”®é¡</span>
                            <span class="summary-value" id="grandTotalOutUntaxed">0.00</span>
                        </div>
                        <div>
                            <span class="summary-key">ç¸½ç¨…é¡</span>
                            <span class="summary-value" id="grandTotalOutTax">0</span>
                        </div>
                        <div>
                            <span class="summary-key">ç¸½ç¸½è¨ˆ</span>
                            <span class="summary-value" id="grandTotalOutTotal">0.00</span>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2 class="summary-in-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <polyline points="19 12 12 19 5 12"></polyline>
                        </svg>
                        é€²é …ç¸½è¦½ (IN)
                    </h2>
                    <div class="summary-grid" id="summaryInPanel">
                        <div>
                            <span class="summary-key">ç¸½ç­†æ•¸</span>
                            <span class="summary-value" id="grandTotalInCount">0</span>
                        </div>
                        <div>
                            <span class="summary-key">ç¸½æœªç¨…éŠ·å”®é¡</span>
                            <span class="summary-value" id="grandTotalInUntaxed">0.00</span>
                        </div>
                        <div>
                            <span class="summary-key">ç¸½ç¨…é¡</span>
                            <span class="summary-value" id="grandTotalInTax">0</span>
                        </div>
                        <div>
                            <span class="summary-key">ç¸½ç¸½è¨ˆ</span>
                            <span class="summary-value" id="grandTotalInTotal">0.00</span>
                        </div>
                    </div>
                </div>

                <div class="panel final-tax-panel">
                    <h2 class="summary-calc-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.21 15.89A10 10 0 1 1 8.11 3h7.9A7 7 0 0 0 21.21 15.89z"></path>
                        </svg>
                        é ä¼°ç¨…é¡
                    </h2>
                    <span class="summary-key" id="finalTaxLabel">æ‡‰ç¹³ç¨…é¡</span>
                    <span class="summary-value" id="finalTaxValue">0</span>
                </div>
            </div>

            <div class="global-config-panel">
                <div class="form-group">
                    <label for="taxRateInput">ç•¶å‰ç¨…ç‡è¨­å®š (%)</label>
                    <input type="number" id="taxRateInput" value="5" min="0" step="0.01" style="width: 150px;">
                </div>

                <div class="rounding-config">
                    <legend>ç¨…é¡è¨ˆç®—æ–¹å¼</legend>
                    <div class="rounding-options">
                        <fieldset class="toggle-switch">
                            <input type="radio" id="roundOriginal" name="roundingMode" value="original" checked>
                            <label for="roundOriginal">ç…§åŸæœ¬</label>
                            
                            <input type="radio" id="roundNormal" name="roundingMode" value="round">
                            <label for="roundNormal">å››æ¨äº”å…¥</label>

                            <input type="radio" id="roundUp" name="roundingMode" value="ceil">
                            <label for="roundUp">ç„¡æ¢ä»¶é€²ä½</label>

                            <input type="radio" id="roundDown" name="roundingMode" value="floor">
                            <label for="roundDown">ç„¡æ¢ä»¶æ¨å»</label>
                        </fieldset>

                        <div class="form-group" style="margin-left: var(--spacing-m);">
                            <label for="decimalPlaces" style="font-size: 0.75rem;">å–åˆ°ç¬¬å¹¾ä½</label>
                            <select id="decimalPlaces" style="font-size: 0.8rem; padding: var(--spacing-xs);">
                                <option value="0" selected>æ•´æ•¸ä½</option>
                                <option value="1">å°æ•¸ç¬¬1ä½</option>
                                <option value="2">å°æ•¸ç¬¬2ä½</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="text-align: right; font-size: 0.8rem; color: var(--color-text-secondary);">
                    è¼¸å…¥æ¨¡å¼è«‹åœ¨å„å†Šæ¨™é¡Œåˆ—è¨­å®š
                </div>
            </div>

            <div class="actions-panel">
                <div>
                    <button id="saveRecordBtn" class="btn-primary">ğŸ’¾ å„²å­˜ç´€éŒ„</button>
                    <button id="exportBtn">åŒ¯å‡º JSON</button>
                    <button id="importBtn">åŒ¯å…¥ JSON</button>
                    <input type="file" id="importFileInput" accept="application/json" class="hidden">
                    <button id="clearAllBtn" class="btn-danger">å…¨éƒ¨æ¸…é™¤</button>
                </div>
            </div>

            <!-- patch: 2025-11-08 å„²å­˜ç´€éŒ„é¢æ¿ -->
            <div class="saved-records-panel">
                <h2>ğŸ“‹ å„²å­˜ç´€éŒ„</h2>
                <div class="saved-records-list" id="savedRecordsList">
                    <div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-l);">
                        å°šç„¡å„²å­˜ç´€éŒ„
                    </div>
                </div>
            </div>

            <div id="booksContainer" class="books-container">
            </div>
        </main>
    </div>

    <div id="toast-container"></div>
    
    <!-- ã€NEWã€‘Floating add button -->
    <button id="addNewBookBtn" class="btn-primary floating-add-btn">ï¼‹ æ–°å¢ä¸€å†Š</button>

    <template id="bookTemplate">
        <article class="book">
            <h3>
                <span class="book-title">ç¬¬ X å†Š</span>

                <div class="book-header-controls">
                    <div class="book-input-mode">
                        <input type="radio" name="bookEntryType" value="IN" class="book-type-in">
                        <label for="">é€²é …</label>

                        <input type="radio" name="bookEntryType" value="OUT" class="book-type-out" checked>
                        <label for="">éŠ·é …</label>
                    </div>

                    <div class="book-input-mode">
                        <input type="checkbox" class="book-inclusive">
                        <label for="">å«ç¨…</label>
                    </div>
                </div>

                <span class="tax-rate-badge">ç¨…ç‡: Y%</span>
            </h3>

            <div class="entry-header">
                <span>é¡å‹</span>
                <span>æœªç¨…é¡</span>
                <span>ç¨…é¡</span>
                <span>ç¸½è¨ˆ</span>
                <span>æ“ä½œ</span>
            </div>
            <div class="entries-list">
            </div>

            <form class="entry-form" novalidate>
                <input type="number" step="0.01" placeholder="è¼¸å…¥é‡‘é¡ (Enter æäº¤)">
                <div class="error-message"></div>
            </form>

            <div class="book-summary">
                <div class="summary-grid">
                    <div>
                        <span class="summary-key">æœ¬å†Šç­†æ•¸</span>
                        <span class="summary-value book-summary-count">0</span>
                    </div>
                    <div>
                        <span class="summary-key">æœ¬å†Šæœªç¨…åŠ ç¸½</span>
                        <span class="summary-value book-summary-untaxed">0.00</span>
                    </div>
                    <div>
                        <span class="summary-key">æœ¬å†Šç¨…é¡åŠ ç¸½</span>
                        <span class="summary-value book-summary-tax">0</span>
                    </div>
                    <div>
                        <span class="summary-key">æœ¬å†Šç¸½è¨ˆåŠ ç¸½</span>
                        <span class="summary-value book-summary-total">0.00</span>
                    </div>
                </div>
            </div>

            <details class="book-verification">
                <summary>æœ¬å†Šæ ¸ç®—é©—è­‰</summary>
                <div class="summary-grid">
                    <div>
                        <span class="summary-key">æ ¸ç®—æœªç¨…ç¸½é¡</span>
                        <span class="summary-value book-verify-untaxed">0.00</span>
                    </div>
                    <div>
                        <span class="summary-key">æ ¸ç®—ç¨…é¡ç¸½é¡</span>
                        <span class="summary-value book-verify-tax">0.00</span>
                    </div>
                    <div>
                        <span class="summary-key">æ ¸ç®—èª¤å·® (çµ•å°å€¼)</span>
                        <span class="summary-value book-verify-error">0.00</span>
                    </div>
                </div>
            </details>

        </article>
    </template>

    <script type="module">
        // åš´æ ¼æ¨¡å¼
        "use strict";

        // --- 0. Constants and State ---
        const STORAGE_KEY = 'multiBookCalculatorData_v1';

        // DOM Elements
        const taxRateInput = document.getElementById('taxRateInput');
        const addNewBookBtn = document.getElementById('addNewBookBtn');
        const booksContainer = document.getElementById('booksContainer');
        const bookTemplate = document.getElementById('bookTemplate');

        // ã€NEWã€‘Rounding Mode Elements
        const roundOriginal = document.getElementById('roundOriginal');
        const roundNormal = document.getElementById('roundNormal');
        const roundUp = document.getElementById('roundUp');
        const roundDown = document.getElementById('roundDown');
        const decimalPlaces = document.getElementById('decimalPlaces');

        const entryFormPlaceholders = {
            exclusive: "è¼¸å…¥æœªç¨…é‡‘é¡ (Enter æäº¤)",
            inclusive: "è¼¸å…¥å«ç¨…ç¸½é¡ (Enter æäº¤)"
        };

        // ã€REBUILTã€‘Summary Panel Elements
        const grandTotalOutCountEl = document.getElementById('grandTotalOutCount');
        const grandTotalOutUntaxedEl = document.getElementById('grandTotalOutUntaxed');
        const grandTotalOutTaxEl = document.getElementById('grandTotalOutTax');
        const grandTotalOutTotalEl = document.getElementById('grandTotalOutTotal');

        const grandTotalInCountEl = document.getElementById('grandTotalInCount');
        const grandTotalInUntaxedEl = document.getElementById('grandTotalInUntaxed');
        const grandTotalInTaxEl = document.getElementById('grandTotalInTax');
        const grandTotalInTotalEl = document.getElementById('grandTotalInTotal');

        const finalTaxLabelEl = document.getElementById('finalTaxLabel');
        const finalTaxValueEl = document.getElementById('finalTaxValue');

        // Actions
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFileInput = document.getElementById('importFileInput');
        const clearAllBtn = document.getElementById('clearAllBtn');
        // patch: 2025-11-08 æ–°å¢å„²å­˜ç´€éŒ„æŒ‰éˆ•
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const savedRecordsList = document.getElementById('savedRecordsList');

        const toastContainer = document.getElementById('toast-container');

        // Application State
        let state = {
            books: [], // Array of book objects
            globalTaxRate: 5.0,
            // ã€NEWã€‘Global rounding settings
            roundingMode: 'original', // 'original' | 'round' | 'ceil' | 'floor'
            decimalPlaces: 0, // 0, 1, 2
        };

        // patch: 2025-11-08 å„²å­˜ç´€éŒ„ state
        let savedRecords = [];
        const SAVED_RECORDS_KEY = 'multiBookCalculatorRecords_v1';

        let saveTimeout;

        // --- 1. Utility Functions ---

        /**
         * æ ¹æ“šè¨­å®šé€²è¡Œæ•¸å€¼æ¨å…¥
         */
        function applyRounding(value, mode = state.roundingMode, places = state.decimalPlaces) {
            if (mode === 'original') {
                // ç…§åŸæœ¬ï¼šä½¿ç”¨å‚³çµ±çš„å››æ¨äº”å…¥åˆ°æ•´æ•¸
                return Math.round(value);
            }
            
            const multiplier = Math.pow(10, places);
            let result;

            switch (mode) {
                case 'ceil':
                    result = Math.ceil(value * multiplier) / multiplier;
                    break;
                case 'floor':
                    result = Math.floor(value * multiplier) / multiplier;
                    break;
                case 'round':
                default:
                    result = Math.round(value * multiplier) / multiplier;
                    break;
            }

            return result;
        }

        /**
         * è²¡å‹™æ¨å…¥ï¼šå››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œ 2 ä½ (ä¿æŒå‘å¾Œç›¸å®¹)
         */
        function round(value) {
            return Math.round(value * 100) / 100;
        }

        /**
         * ã€NEWã€‘æ ¹æ“šè¨­å®šæ ¼å¼åŒ–æ•¸å­—é¡¯ç¤ºï¼ˆæ”¯æ´å‹•æ…‹ç²¾åº¦å’Œåƒä½åˆ†éš”ç¬¦ï¼‰
         */
        function formatNumber(value, decimalPlaces = state.decimalPlaces) {
            if (isNaN(value)) return '0';
            
            // æ ¹æ“šè¨­å®šçš„å°æ•¸ä½æ•¸æ ¼å¼åŒ–
            const formatted = Number(value).toFixed(decimalPlaces);
            
            // æ·»åŠ åƒä½åˆ†éš”ç¬¦
            const parts = formatted.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            return parts.join('.');
        }

        /**
         * æ ¼å¼åŒ–æ•¸å­—ç‚ºè²¨å¹£é¡¯ç¤º (ä¿æŒå‘å¾Œç›¸å®¹)
         */
        function formatDisplay(value) {
            return formatNumber(value, state.decimalPlaces);
        }

        /**
         * æ ¼å¼åŒ–æ•¸å­—ç‚ºæ•´æ•¸é¡¯ç¤º (ç”¨æ–¼ç¨…é¡ï¼Œä½†æœƒæ ¹æ“šè¨­å®šèª¿æ•´)
         */
        function formatInteger(value) {
            return formatNumber(value, state.decimalPlaces);
        }

        /**
         * é¡¯ç¤º UI Toast é€šçŸ¥
         */
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => { toast.classList.add('show'); }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 500);
            }, 3000);
        }

        /**
         * åœ¨ç‰¹å®šè¼¸å…¥æ¡†é¡¯ç¤ºéŒ¯èª¤
         */
        function showInputError(inputElement, message) {
            const bookElement = inputElement.closest('.book');
            if (!bookElement) return;

            const errorEl = bookElement.querySelector('.error-message');
            bookElement.classList.add('has-error');
            if (errorEl) {
                errorEl.textContent = message;
            }
        }

        /**
         * æ¸…é™¤ç‰¹å®šè¼¸å…¥æ¡†çš„éŒ¯èª¤
         */
        function clearInputError(inputElement) {
            const bookElement = inputElement.closest('.book');
            if (!bookElement) return;

            const errorEl = bookElement.querySelector('.error-message');
            bookElement.classList.remove('has-error');
            if (errorEl) {
                errorEl.textContent = '';
            }
        }

        // --- 2. State Management & Persistence (Data Ownership) ---

        /**
         * å»¶é²ä¿å­˜ç‹€æ…‹åˆ° localStorage
         */
        function debouncedSaveState() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveState, 300);
        }

        /**
         * ç«‹å³ä¿å­˜ç‹€æ…‹åˆ° localStorage
         */
        function saveState() {
            try {
                const data = JSON.stringify(state);
                localStorage.setItem(STORAGE_KEY, data);
            } catch (e) {
                showToast('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œç©ºé–“å¯èƒ½å·²æ»¿ã€‚', 'error');
            }
        }

        /**
         * å¾ localStorage è¼‰å…¥ç‹€æ…‹
         */
        function loadState() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const parsedData = JSON.parse(data);
                    // åŸºç¤ Schema é©—è­‰
                    if (parsedData && Array.isArray(parsedData.books) && typeof parsedData.globalTaxRate === 'number') {
                        state = parsedData;

                        // ã€NEWã€‘ç¢ºä¿èˆŠè³‡æ–™æœ‰æ–°çš„ state å±¬æ€§
                        state.roundingMode = state.roundingMode || 'original';
                        state.decimalPlaces = state.decimalPlaces !== undefined ? state.decimalPlaces : 0;

                    } else {
                        resetState(false); // è¼‰å…¥å¤±æ•—ï¼Œé‡ç½®ä½†ä¸æ–°å¢
                    }
                }
            } catch (e) {
                showToast('è¼‰å…¥æœ¬åœ°è³‡æ–™å¤±æ•—ï¼Œå°‡é‡ç½®ç‚ºé è¨­å€¼ã€‚', 'error');
                resetState(false); // è¼‰å…¥å¤±æ•—ï¼Œé‡ç½®ä½†ä¸æ–°å¢
            }

            // ç¢ºä¿æ¯æœ¬æ›¸éƒ½æœ‰è¼¸å…¥æ¨¡å¼å±¬æ€§
            state.books.forEach(book => {
                if (book.entryType === undefined) book.entryType = 'OUT';
                if (book.isInclusive === undefined) book.isInclusive = false;
            });

            // å¦‚æœè¼‰å…¥å¾Œä¸€æœ¬éƒ½æ²’æœ‰ï¼Œæ‰æ–°å¢ç¬¬ä¸€å†Š
            if (state.books.length === 0) {
                addNewBook();
            }
        }

        /**
         * é‡ç½®ç‹€æ…‹
         * @param {boolean} [createFirstBook=true] - æ˜¯å¦è‡ªå‹•å‰µå»ºç¬¬ä¸€å†Š
         */
        function resetState(createFirstBook = true) {
            state = {
                books: [],
                globalTaxRate: 5.0,
                roundingMode: 'original',
                decimalPlaces: 0,
            };
            if (createFirstBook) {
                addNewBook();
            }
            updateRoundingModeUI();
        }

        // --- 3. Core Calculation Logic (as per spec) ---

        /**
         * é‡æ–°è¨ˆç®—ä¸¦æ›´æ–°æ‰€æœ‰ç¸½çµ
         * // patch: 2025-11-08 ä¿®æ­£è¨ˆç®—é‚è¼¯ï¼šæ¯ç­†å…ˆå–æ•´æ•¸å†ç´¯åŠ ï¼Œè€Œéç´¯åŠ å¾Œæ‰å–æ•´æ•¸
         */
        function updateAllCalculations() {
            let grandTotal = {
                IN: { count: 0, untaxed: 0, tax: 0, total: 0 },
                OUT: { count: 0, untaxed: 0, tax: 0, total: 0 }
            };

            // 1. æ›´æ–°æ¯å†Šçš„ç¸½çµ
            state.books.forEach(book => {
                let bookTotals = {
                    count: 0,
                    untaxed: 0,
                    tax: 0,
                    total: 0
                };

                book.entries.forEach(entry => {
                    // patch: 2025-11-08 æ¯ç­†å…ˆå–æ•´æ•¸å†ç´¯åŠ 
                    const roundedUntaxed = round(entry.untaxed);
                    const roundedTax = Math.round(entry.tax);
                    const roundedTotal = round(entry.total);

                    // ç´¯åŠ åˆ°å†Š
                    bookTotals.count++;
                    bookTotals.untaxed += roundedUntaxed;
                    bookTotals.tax += roundedTax;
                    bookTotals.total += roundedTotal;

                    // ç´¯åŠ åˆ°ç¸½
                    const type = entry.type; // 'IN' or 'OUT'
                    grandTotal[type].count++;
                    grandTotal[type].untaxed += roundedUntaxed;
                    grandTotal[type].tax += roundedTax;
                    grandTotal[type].total += roundedTotal;
                });

                // å„²å­˜è¨ˆç®—çµæœåˆ° stateï¼ˆå·²ç¶“æ˜¯æ•´æ•¸ç´¯åŠ çš„çµæœï¼Œä¸éœ€å†æ¬¡å–æ•´ï¼‰
                book.totals = {
                    count: bookTotals.count,
                    untaxed: bookTotals.untaxed,
                    tax: bookTotals.tax,
                    total: bookTotals.total
                };

                // æ›´æ–° DOM (åˆ†å†Šé¡¯ç¤º)
                updateBookSummaryDOM(book);

                // ã€NEWã€‘åŸ·è¡Œåˆ†å†Šæ ¸ç®—
                runBookVerification(book);
            });

            // 2. ç¸½çµå·²ç¶“æ˜¯æ•´æ•¸ç´¯åŠ çš„çµæœï¼Œä¸éœ€å†æ¬¡å–æ•´
            // patch: 2025-11-08 ç§»é™¤é‡è¤‡çš„å–æ•´æ“ä½œ

            // 3. æ›´æ–°ç¸½çµ DOM
            grandTotalOutCountEl.textContent = grandTotal.OUT.count;
            grandTotalOutUntaxedEl.textContent = formatDisplay(grandTotal.OUT.untaxed);
            grandTotalOutTaxEl.textContent = formatInteger(grandTotal.OUT.tax);
            grandTotalOutTotalEl.textContent = formatDisplay(grandTotal.OUT.total);

            grandTotalInCountEl.textContent = grandTotal.IN.count;
            grandTotalInUntaxedEl.textContent = formatDisplay(grandTotal.IN.untaxed);
            grandTotalInTaxEl.textContent = formatInteger(grandTotal.IN.tax);
            grandTotalInTotalEl.textContent = formatDisplay(grandTotal.IN.total);

            // 4. åŸ·è¡Œæœ€çµ‚ç¨…é¡è¨ˆç®—
            const finalTax = grandTotal.OUT.tax - grandTotal.IN.tax;
            if (finalTax >= 0) {
                finalTaxLabelEl.textContent = "æ‡‰ç¹³ç¨…é¡";
                finalTaxValueEl.textContent = formatInteger(finalTax);
                finalTaxValueEl.className = 'summary-value is-payable';
            } else {
                finalTaxLabelEl.textContent = "å¯ç•™æŠµç¨…é¡";
                finalTaxValueEl.textContent = formatInteger(Math.abs(finalTax));
                finalTaxValueEl.className = 'summary-value is-creditable';
            }

            // patch: 2025-11-08 åŸ·è¡Œæ™ºæ…§æ ¸å°
            runSmartVerification();
        }

        /**
         * ã€MODIFIEDã€‘åŸ·è¡Œåå‘æ ¸ç®—é©—è­‰ (é‡å°ç‰¹å®šå†Š)
         * @param {object} book - The book object from state
         */
        function runBookVerification(book) {
            const bookElement = booksContainer.querySelector(`.book[data-book-id="${book.id}"]`);
            if (!bookElement) return;

            const verifyUntaxedEl = bookElement.querySelector('.book-verify-untaxed');
            const verifyTaxEl = bookElement.querySelector('.book-verify-tax');
            const verifyErrorEl = bookElement.querySelector('.book-verify-error');

            const rate = book.taxRate / 100;
            const bookTotal = book.totals.total;
            const bookTax = book.totals.tax;

            if (rate <= -1) { // é¿å…é™¤ä»¥ 0
                verifyUntaxedEl.textContent = 'N/A';
                verifyTaxEl.textContent = 'N/A';
                verifyErrorEl.textContent = 'N/A';
                return;
            }

            const verifiedUntaxed = bookTotal / (1 + rate);
            const verifiedTax = bookTotal - verifiedUntaxed; // float
            const verificationError = Math.abs(bookTax - verifiedTax); // (integer) vs (float)

            verifyUntaxedEl.textContent = formatDisplay(verifiedUntaxed);
            verifyTaxEl.textContent = formatDisplay(verifiedTax);
            verifyErrorEl.textContent = formatDisplay(verificationError);

            verifyErrorEl.className = verificationError < 0.01
                ? 'summary-value book-verify-error is-success'
                : 'summary-value book-verify-error is-error';
        }

        /**
         * patch: 2025-11-08 æ™ºæ…§æ ¸å°æ¨¡å¼ï¼šè‡ªå‹•æ¨™ç¤ºç•°å¸¸ç¨…ç‡æˆ–èª¤å·®è¶…æ¨™å†Š
         */
        function runSmartVerification() {
            const ERROR_THRESHOLD = 10; // èª¤å·®è¶…é 10 å…ƒè¦–ç‚ºç•°å¸¸
            const TAX_RATE_TOLERANCE = 0.5; // ç¨…ç‡åå·®å®¹å¿åº¦ 0.5%

            state.books.forEach(book => {
                const bookElement = booksContainer.querySelector(`.book[data-book-id="${book.id}"]`);
                if (!bookElement) return;

                let hasWarning = false;
                let warningMessages = [];

                // æª¢æŸ¥ 1: ç¨…ç‡ç•°å¸¸ï¼ˆèˆ‡å…¨åŸŸç¨…ç‡å·®ç•°éå¤§ï¼‰
                const rateDiff = Math.abs(book.taxRate - state.globalTaxRate);
                if (rateDiff > TAX_RATE_TOLERANCE) {
                    hasWarning = true;
                    warningMessages.push(`ç¨…ç‡ç•°å¸¸ (${book.taxRate}% vs ${state.globalTaxRate}%)`);
                }

                // æª¢æŸ¥ 2: æ ¸ç®—èª¤å·®è¶…æ¨™
                const rate = book.taxRate / 100;
                const bookTotal = book.totals.total;
                const bookTax = book.totals.tax;
                
                if (rate > -1) {
                    const verifiedUntaxed = bookTotal / (1 + rate);
                    const verifiedTax = bookTotal - verifiedUntaxed;
                    const verificationError = Math.abs(bookTax - verifiedTax);
                    
                    if (verificationError > ERROR_THRESHOLD) {
                        hasWarning = true;
                        warningMessages.push(`èª¤å·®è¶…æ¨™ (${formatDisplay(verificationError)} å…ƒ)`);
                    }
                }

                // æ›´æ–° DOM
                const h3 = bookElement.querySelector('h3');
                if (!h3) return;

                // ç§»é™¤èˆŠçš„è­¦å‘Šæ¨™è¨˜
                const oldBadge = h3.querySelector('.warning-badge');
                if (oldBadge) oldBadge.remove();

                if (hasWarning) {
                    bookElement.classList.add('has-warning');
                    const badge = document.createElement('span');
                    badge.className = 'warning-badge';
                    badge.textContent = 'âš ï¸ ' + warningMessages.join(' / ');
                    badge.title = warningMessages.join('\n');
                    h3.appendChild(badge);
                } else {
                    bookElement.classList.remove('has-warning');
                }
            });
        }


        // --- 4. DOM Rendering ---

        /**
         * æ¸²æŸ“æ‰€æœ‰ state ä¸­çš„ books
         */
        function renderAllBooks() {
            booksContainer.innerHTML = ''; // æ¸…ç©º
            state.books.forEach(book => renderBook(book));
            updateAllCalculations();
            updateInputModePlaceholders(); // æ›´æ–°æ‰€æœ‰è¼¸å…¥æ¡†çš„ placeholder
        }

        /**
         * æ¸²æŸ“å–®ä¸€å†Š
         */
        function renderBook(book) {
            const bookElement = bookTemplate.content.cloneNode(true);
            const article = bookElement.querySelector('.book');
            const titleEl = bookElement.querySelector('.book-title');
            const taxRateEl = bookElement.querySelector('.tax-rate-badge');
            const entriesListEl = bookElement.querySelector('.entries-list');
            const formEl = bookElement.querySelector('.entry-form');
            const inputEl = bookElement.querySelector('input[type="number"]');

            // ã€NEWã€‘Book input mode controls
            const typeInEl = bookElement.querySelector('.book-type-in');
            const typeOutEl = bookElement.querySelector('.book-type-out');
            const inclusiveEl = bookElement.querySelector('.book-inclusive');

            article.dataset.bookId = book.id;
            titleEl.textContent = `ç¬¬ ${book.index} å†Š`;
            taxRateEl.textContent = `ç¨…ç‡: ${book.taxRate}%`;

            // ã€NEWã€‘è¨­å®šæ¯å†Šçš„è¼¸å…¥æ¨¡å¼æ§åˆ¶
            const bookId = book.id;
            typeInEl.name = `bookEntryType_${bookId}`;
            typeOutEl.name = `bookEntryType_${bookId}`;
            typeInEl.id = `bookTypeIn_${bookId}`;
            typeOutEl.id = `bookTypeOut_${bookId}`;
            inclusiveEl.id = `bookInclusive_${bookId}`;

            // è¨­å®šå°æ‡‰çš„label
            typeInEl.nextElementSibling.setAttribute('for', typeInEl.id);
            typeOutEl.nextElementSibling.setAttribute('for', typeOutEl.id);
            inclusiveEl.nextElementSibling.setAttribute('for', inclusiveEl.id);

            // è¨­å®šåˆå§‹å€¼
            if (book.entryType === 'IN') {
                typeInEl.checked = true;
            } else {
                typeOutEl.checked = true;
            }
            inclusiveEl.checked = book.isInclusive;

            // æ›´æ–° placeholder
            inputEl.placeholder = book.isInclusive ? entryFormPlaceholders.inclusive : entryFormPlaceholders.exclusive;

            // ã€NEWã€‘ç¶å®šè¼¸å…¥æ¨¡å¼è®Šæ›´äº‹ä»¶
            typeInEl.addEventListener('change', () => updateBookInputMode(bookId));
            typeOutEl.addEventListener('change', () => updateBookInputMode(bookId));
            inclusiveEl.addEventListener('change', () => updateBookInputMode(bookId));

            // æ¸²æŸ“è©²å†Šæ‰€æœ‰æ¢ç›®
            entriesListEl.innerHTML = '';
            book.entries.forEach(entry => {
                renderEntry(entriesListEl, entry);
            });

            // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
            formEl.addEventListener('submit', (e) => handleEntrySubmit(e, book.id));
            inputEl.addEventListener('input', () => clearInputError(inputEl));

            booksContainer.appendChild(bookElement);
        }

        /**
         * ã€REBUILTã€‘æ¸²æŸ“å–®ä¸€æ¢ç›® (æ”¹å› span é¡¯ç¤º)
         * @param {HTMLElement} listElement - The .entries-list element
         * @param {object} entry - The entry object
         * // patch: 2025-11-08 æ–°å¢æ“ä½œæŒ‰éˆ•ï¼ˆåˆ‡æ›é¡å‹ã€åˆªé™¤ï¼‰
         */
        function renderEntry(listElement, entry) {
            const entryEl = document.createElement('div');
            entryEl.className = 'entry';
            entryEl.dataset.entryId = entry.id;

            const typeText = entry.type === 'IN' ? 'é€²é …' : 'éŠ·é …';
            const typeClass = entry.type === 'IN' ? 'type-in' : 'type-out';

            entryEl.innerHTML = `
                <span class="entry-type ${typeClass}">${typeText}</span>
                <span class="entry-value" data-field="untaxed">${formatDisplay(entry.untaxed)}</span>
                <span class="entry-value" data-field="tax">${formatInteger(entry.tax)}</span>
                <span class="entry-value" data-field="total">${formatDisplay(entry.total)}</span>
                <div class="entry-actions">
                    <button class="entry-action-btn btn-toggle-type" title="åˆ‡æ›é€²éŠ·é …">â‡„</button>
                    <button class="entry-action-btn btn-delete" title="åˆªé™¤">âœ•</button>
                </div>
            `;

            // ã€NEWã€‘ç‚ºå¯ç·¨è¼¯æ•¸å€¼æ·»åŠ é»æ“Šäº‹ä»¶
            entryEl.querySelectorAll('.entry-value').forEach(valueEl => {
                valueEl.addEventListener('click', () => makeEntryValueEditable(valueEl, entry));
            });

            // patch: 2025-11-08 ç¶å®šæ“ä½œæŒ‰éˆ•äº‹ä»¶
            const toggleTypeBtn = entryEl.querySelector('.btn-toggle-type');
            const deleteBtn = entryEl.querySelector('.btn-delete');
            
            if (toggleTypeBtn) {
                toggleTypeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleEntryType(entry);
                });
            }
            
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteEntry(entry);
                });
            }

            listElement.appendChild(entryEl);
        }

        /**
         * æ›´æ–°æŒ‡å®š book çš„ DOM ç¸½çµ
         */
        function updateBookSummaryDOM(book) {
            const bookElement = booksContainer.querySelector(`.book[data-book-id="${book.id}"]`);
            if (!bookElement) return;

            bookElement.querySelector('.book-summary-count').textContent = book.totals.count;
            bookElement.querySelector('.book-summary-untaxed').textContent = formatDisplay(book.totals.untaxed);
            bookElement.querySelector('.book-summary-tax').textContent = formatInteger(book.totals.tax);
            bookElement.querySelector('.book-summary-total').textContent = formatDisplay(book.totals.total);
        }


        /**
         * ã€NEWã€‘æ›´æ–°æ›¸æœ¬çš„è¼¸å…¥æ¨¡å¼
         */
        function updateBookInputMode(bookId) {
            const book = state.books.find(b => b.id === bookId);
            if (!book) return;

            const bookElement = booksContainer.querySelector(`.book[data-book-id="${bookId}"]`);
            if (!bookElement) return;

            const typeInEl = bookElement.querySelector('.book-type-in');
            const inclusiveEl = bookElement.querySelector('.book-inclusive');
            const inputEl = bookElement.querySelector('input[type="number"]');

            book.entryType = typeInEl.checked ? 'IN' : 'OUT';
            book.isInclusive = inclusiveEl.checked;

            // æ›´æ–°è¼¸å…¥æ¡†placeholder
            inputEl.placeholder = book.isInclusive ? entryFormPlaceholders.inclusive : entryFormPlaceholders.exclusive;

            debouncedSaveState();
        }

        /**
         * ã€NEWã€‘è®“æ¢ç›®æ•¸å€¼å¯ç·¨è¼¯
         */
        function makeEntryValueEditable(valueEl, entry) {
            if (valueEl.classList.contains('editing')) return;

            const field = valueEl.dataset.field;
            const currentValue = entry[field];

            valueEl.classList.add('editing');
            const originalText = valueEl.textContent;

            const input = document.createElement('input');
            input.className = 'entry-edit-input';
            input.type = 'number';
            input.step = field === 'tax' ? '1' : '0.01';
            input.value = currentValue;

            valueEl.innerHTML = '';
            valueEl.appendChild(input);
            input.focus();
            input.select();

            const finishEdit = (save = false) => {
                if (save && input.value !== '' && !isNaN(input.value)) {
                    const newValue = parseFloat(input.value);
                    entry[field] = newValue;

                    // é‡æ–°è¨ˆç®—ç›¸é—œæ•¸å€¼
                    if (field === 'untaxed') {
                        const book = state.books.find(b => b.entries.some(e => e.id === entry.id));
                        if (book) {
                            entry.tax = applyRounding(newValue * book.taxRate / 100);
                            entry.total = round(newValue + entry.tax);
                        }
                    } else if (field === 'total') {
                        const book = state.books.find(b => b.entries.some(e => e.id === entry.id));
                        if (book) {
                            entry.untaxed = round(newValue / (1 + book.taxRate / 100));
                            entry.tax = applyRounding(entry.untaxed * book.taxRate / 100);
                        }
                    } else if (field === 'tax') {
                        entry.tax = applyRounding(newValue);
                        entry.total = round(entry.untaxed + entry.tax);
                    }

                    updateAllCalculations();
                    debouncedSaveState();
                }

                valueEl.classList.remove('editing');
                const displayValue = field === 'tax' ? formatInteger(entry[field]) : formatDisplay(entry[field]);
                valueEl.textContent = displayValue;
            };

            input.addEventListener('blur', () => finishEdit(true));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    finishEdit(true);
                } else if (e.key === 'Escape') {
                    finishEdit(false);
                }
            });
        }

        /**
         * patch: 2025-11-08 åˆ‡æ›æ¢ç›®çš„é€²éŠ·é …é¡å‹
         * @param {object} entry - The entry object
         */
        function toggleEntryType(entry) {
            if (!entry) return;
            
            // åˆ‡æ›é¡å‹
            entry.type = entry.type === 'IN' ? 'OUT' : 'IN';
            
            // æ‰¾åˆ°å°æ‡‰çš„ DOM å…ƒç´ ä¸¦æ›´æ–°
            const entryEl = booksContainer.querySelector(`.entry[data-entry-id="${entry.id}"]`);
            if (!entryEl) return;
            
            const typeSpan = entryEl.querySelector('.entry-type');
            if (typeSpan) {
                const newTypeText = entry.type === 'IN' ? 'é€²é …' : 'éŠ·é …';
                const newTypeClass = entry.type === 'IN' ? 'type-in' : 'type-out';
                typeSpan.textContent = newTypeText;
                typeSpan.className = `entry-type ${newTypeClass}`;
            }
            
            // æ›´æ–°è¨ˆç®—å’Œå„²å­˜
            updateAllCalculations();
            debouncedSaveState();
        }

        /**
         * patch: 2025-11-08 åˆªé™¤å–®ç­†æ¢ç›®
         * @param {object} entry - The entry object
         */
        function deleteEntry(entry) {
            if (!entry) return;
            
            // æ‰¾åˆ°è©²æ¢ç›®æ‰€å±¬çš„å†Š
            const book = state.books.find(b => b.entries.some(e => e.id === entry.id));
            if (!book) return;
            
            // å¾ state ä¸­ç§»é™¤
            const entryIndex = book.entries.findIndex(e => e.id === entry.id);
            if (entryIndex === -1) return;
            
            book.entries.splice(entryIndex, 1);
            
            // å¾ DOM ä¸­ç§»é™¤
            const entryEl = booksContainer.querySelector(`.entry[data-entry-id="${entry.id}"]`);
            if (entryEl) {
                entryEl.remove();
            }
            
            // æ›´æ–°è¨ˆç®—å’Œå„²å­˜
            updateAllCalculations();
            debouncedSaveState();
        }

        /**
         * ã€NEWã€‘æ›´æ–°å››æ¨äº”å…¥æ¨¡å¼UI
         */
        function updateRoundingModeUI() {
            if (roundOriginal) roundOriginal.checked = state.roundingMode === 'original';
            if (roundNormal) roundNormal.checked = state.roundingMode === 'round';
            if (roundUp) roundUp.checked = state.roundingMode === 'ceil';
            if (roundDown) roundDown.checked = state.roundingMode === 'floor';
            if (decimalPlaces) decimalPlaces.value = state.decimalPlaces.toString();
        }

        // --- 5. Event Handlers ---

        /**
         * è™•ç†æ–°å¢ä¸€å†Š
         */
        function addNewBook() {
            const newBook = {
                id: `book-${Date.now()}`,
                index: state.books.length + 1,
                taxRate: state.globalTaxRate, // é–å®šç•¶å‰ç¨…ç‡
                entries: [],
                totals: { count: 0, untaxed: 0, tax: 0, total: 0 },
                // ã€NEWã€‘æ¯å†Šçš„è¼¸å…¥æ¨¡å¼è¨­å®š
                entryType: 'OUT', // 'IN' | 'OUT'
                isInclusive: false // bool
            };
            state.books.push(newBook);
            renderBook(newBook); // åªæ¸²æŸ“æ–°å¢çš„
            debouncedSaveState();
        }

        /**
         * ã€REBUILTã€‘è™•ç†å–®ç­†è¼¸å…¥æäº¤
         * @param {Event} event - The form submit event
         * @param {string} bookId - The ID of the book being added to
         */
        function handleEntrySubmit(event, bookId) {
            event.preventDefault();
            const form = event.target;
            const input = form.querySelector('input[type="number"]');

            const inputValue = parseFloat(input.value);

            // åˆ¤æ–·1: ç„¡æ•ˆè¼¸å…¥æˆ–è² å€¼
            if (isNaN(inputValue) || inputValue < 0) {
                showInputError(input, "è¼¸å…¥ç„¡æ•ˆï¼Œè«‹è¼¸å…¥å¤§æ–¼æˆ–ç­‰æ–¼ 0 çš„æ•¸å­—ã€‚");
                input.value = ''; // æ¸…ç©ºç„¡æ•ˆè¼¸å…¥
                input.focus();
                return;
            }

            clearInputError(input);

            const book = state.books.find(b => b.id === bookId);
            if (!book) return;

            // æ­¥é©Ÿ4: å–®ç­†è¨ˆç®— (ä½¿ç”¨è©²å†Šé–å®šçš„ç¨…ç‡å’Œè¼¸å…¥æ¨¡å¼)
            const rate = book.taxRate / 100;
            let untaxed, tax, total;

            if (book.isInclusive) {
                // å«ç¨…æ¨¡å¼
                total = round(inputValue);
                untaxed = round(total / (1 + rate));
                tax = applyRounding(total - untaxed); // ä½¿ç”¨è¨­å®šçš„æ¨å…¥æ–¹å¼
            } else {
                // æœªç¨…æ¨¡å¼
                untaxed = round(inputValue);
                tax = applyRounding(untaxed * rate); // ä½¿ç”¨è¨­å®šçš„æ¨å…¥æ–¹å¼
                total = round(untaxed + tax);
            }

            const entry = {
                id: `entry-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                type: book.entryType, // ä½¿ç”¨è©²å†Šçš„é¡å‹è¨­å®š
                untaxed: untaxed,
                tax: tax,
                total: total
            };

            // æ­¥é©Ÿ5: æ›´æ–° state
            book.entries.push(entry);

            // æ›´æ–° DOM
            const listElement = form.previousElementSibling; // .entries-list
            renderEntry(listElement, entry);

            // æ­¥é©Ÿ6: æ›´æ–°ç¸½çµä¸¦å„²å­˜
            updateAllCalculations();
            debouncedSaveState();

            // æ­¥é©Ÿ7: æ¸…ç©ºè¼¸å…¥æ¡†ä»¥ä¾¿é€£çºŒè¼¸å…¥
            input.value = '';
            input.focus();
        }

        /**
         * è™•ç†ç¨…ç‡è®Šæ›´
         */
        function handleTaxRateChange(event) {
            const newRate = parseFloat(event.target.value);
            if (isNaN(newRate) || newRate < 0) {
                event.target.value = state.globalTaxRate; // æ¢å¾©åŸå€¼
                showToast("ç¨…ç‡å¿…é ˆæ˜¯æœ‰æ•ˆçš„æ­£æ•¸ã€‚", "error");
                return;
            }
            state.globalTaxRate = newRate;

            // ç¨…ç‡è®Šæ›´æœƒå½±éŸ¿æ ¸ç®—é©—è­‰ï¼Œæ‰€ä»¥è¦é‡æ–°è¨ˆç®—
            updateAllCalculations();
            debouncedSaveState();
        }

        /**
         * ã€NEWã€‘è™•ç†å››æ¨äº”å…¥æ¨¡å¼è®Šæ›´
         */
        function handleRoundingModeChange() {
            if (roundOriginal && roundOriginal.checked) state.roundingMode = 'original';
            else if (roundNormal && roundNormal.checked) state.roundingMode = 'round';
            else if (roundUp && roundUp.checked) state.roundingMode = 'ceil';
            else if (roundDown && roundDown.checked) state.roundingMode = 'floor';

            if (decimalPlaces) state.decimalPlaces = parseInt(decimalPlaces.value);

            // ã€NEWã€‘é‡æ–°è¨ˆç®—æ‰€æœ‰æ•¸å€¼ä¸¦æ›´æ–°é¡¯ç¤º
            if (state.roundingMode !== 'original') {
                recalculateAllEntries();
            }
            updateAllCalculations();
            renderAllBooks();
            
            debouncedSaveState();
        }

        /**
         * ã€NEWã€‘é‡æ–°è¨ˆç®—æ‰€æœ‰æ¢ç›®çš„ç¨…é¡ï¼ˆç•¶å››æ¨äº”å…¥æ¨¡å¼è®Šæ›´æ™‚ï¼‰
         */
        function recalculateAllEntries() {
            state.books.forEach(book => {
                book.entries.forEach(entry => {
                    const rate = book.taxRate / 100;
                    // é‡æ–°è¨ˆç®—ç¨…é¡ï¼Œä½¿ç”¨æ–°çš„å››æ¨äº”å…¥è¨­å®š
                    entry.tax = applyRounding(entry.untaxed * rate);
                    entry.total = round(entry.untaxed + entry.tax);
                });
            });
        }

        /**
         * ã€NEWã€‘æ›´æ–°å…¨åŸŸè¨­å®š UI (é€šå¸¸åœ¨è¼‰å…¥æ™‚)
         */
        function updateGlobalUI() {
            taxRateInput.value = state.globalTaxRate;
            updateRoundingModeUI();
        }

        /**
         * patch: 2025-11-08 è¼‰å…¥å„²å­˜ç´€éŒ„
         */
        function loadSavedRecords() {
            try {
                const data = localStorage.getItem(SAVED_RECORDS_KEY);
                if (data) {
                    savedRecords = JSON.parse(data);
                    if (!Array.isArray(savedRecords)) {
                        savedRecords = [];
                    }
                }
            } catch (e) {
                savedRecords = [];
            }
            renderSavedRecords();
        }

        /**
         * patch: 2025-11-08 å„²å­˜ç´€éŒ„åˆ° localStorage
         */
        function saveSavedRecords() {
            try {
                localStorage.setItem(SAVED_RECORDS_KEY, JSON.stringify(savedRecords));
            } catch (e) {
                showToast('å„²å­˜ç´€éŒ„å¤±æ•—', 'error');
            }
        }

        /**
         * patch: 2025-11-08 æ¸²æŸ“å„²å­˜ç´€éŒ„åˆ—è¡¨
         */
        function renderSavedRecords() {
            if (!savedRecordsList) return;

            if (savedRecords.length === 0) {
                savedRecordsList.innerHTML = `
                    <div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-l);">
                        å°šç„¡å„²å­˜ç´€éŒ„
                    </div>
                `;
                return;
            }

            savedRecordsList.innerHTML = '';
            savedRecords.forEach((record, index) => {
                const item = document.createElement('div');
                item.className = 'saved-record-item';
                
                const date = new Date(record.timestamp);
                const dateStr = date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                item.innerHTML = `
                    <div class="saved-record-info">
                        <div class="saved-record-name">${record.name}</div>
                        <div class="saved-record-date">${dateStr}</div>
                    </div>
                    <div class="saved-record-actions">
                        <button class="btn-load" data-index="${index}">è¼‰å…¥</button>
                        <button class="btn-danger btn-delete-record" data-index="${index}">åˆªé™¤</button>
                    </div>
                `;

                // ç¶å®šè¼‰å…¥æŒ‰éˆ•
                const loadBtn = item.querySelector('.btn-load');
                if (loadBtn) {
                    loadBtn.addEventListener('click', () => loadRecord(index));
                }

                // ç¶å®šåˆªé™¤æŒ‰éˆ•
                const deleteBtn = item.querySelector('.btn-delete-record');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => deleteRecord(index));
                }

                savedRecordsList.appendChild(item);
            });
        }

        /**
         * patch: 2025-11-08 é¡¯ç¤ºå„²å­˜å°è©±æ¡†
         */
        function showSaveDialog() {
            // å»ºç«‹ modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">ğŸ’¾ å„²å­˜ç´€éŒ„</div>
                    <div class="modal-body">
                        <label for="recordName">è«‹è¼¸å…¥ç´€éŒ„åç¨±ï¼š</label>
                        <input type="text" id="recordName" class="modal-input" placeholder="ä¾‹å¦‚ï¼š2025å¹´1æœˆå ±ç¨…è³‡æ–™" autofocus>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel">å–æ¶ˆ</button>
                        <button class="btn-primary btn-confirm">ç¢ºå®šå„²å­˜</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            const input = modal.querySelector('#recordName');
            const cancelBtn = modal.querySelector('.btn-cancel');
            const confirmBtn = modal.querySelector('.btn-confirm');

            // é—œé–‰ modal
            const closeModal = () => {
                modal.remove();
            };

            // å–æ¶ˆæŒ‰éˆ•
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModal);
            }

            // é»æ“ŠèƒŒæ™¯é—œé–‰
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // ç¢ºå®šæŒ‰éˆ•
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    const name = input ? input.value.trim() : '';
                    if (!name) {
                        showToast('è«‹è¼¸å…¥ç´€éŒ„åç¨±', 'error');
                        return;
                    }
                    saveRecord(name);
                    closeModal();
                });
            }

            // Enter éµç¢ºèª
            if (input) {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    } else if (e.key === 'Escape') {
                        closeModal();
                    }
                });
                input.focus();
            }
        }

        /**
         * patch: 2025-11-08 å„²å­˜ç•¶å‰ç‹€æ…‹ç‚ºç´€éŒ„
         */
        function saveRecord(name) {
            const record = {
                name: name,
                timestamp: Date.now(),
                data: JSON.parse(JSON.stringify(state)) // æ·±æ‹·è²
            };

            savedRecords.unshift(record); // æ–°çš„æ”¾æœ€å‰é¢

            // é™åˆ¶æœ€å¤š 20 ç­†ç´€éŒ„
            if (savedRecords.length > 20) {
                savedRecords = savedRecords.slice(0, 20);
            }

            saveSavedRecords();
            renderSavedRecords();
            showToast(`ç´€éŒ„ã€Œ${name}ã€å·²å„²å­˜`, 'success');
        }

        /**
         * patch: 2025-11-08 è¼‰å…¥ç´€éŒ„
         */
        function loadRecord(index) {
            if (index < 0 || index >= savedRecords.length) return;

            const record = savedRecords[index];
            if (!record || !record.data) return;

            if (confirm(`ç¢ºå®šè¦è¼‰å…¥ç´€éŒ„ã€Œ${record.name}ã€å—ï¼Ÿ\nç•¶å‰è³‡æ–™å°‡è¢«è¦†è“‹ã€‚`)) {
                state = JSON.parse(JSON.stringify(record.data)); // æ·±æ‹·è²
                updateGlobalUI();
                renderAllBooks();
                saveState();
                showToast(`å·²è¼‰å…¥ç´€éŒ„ã€Œ${record.name}ã€`, 'success');
            }
        }

        /**
         * patch: 2025-11-08 åˆªé™¤ç´€éŒ„
         */
        function deleteRecord(index) {
            if (index < 0 || index >= savedRecords.length) return;

            const record = savedRecords[index];
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç´€éŒ„ã€Œ${record.name}ã€å—ï¼Ÿ`)) {
                savedRecords.splice(index, 1);
                saveSavedRecords();
                renderSavedRecords();
                showToast('ç´€éŒ„å·²åˆªé™¤', 'success');
            }
        }

        /**
         * è™•ç†å…¨éƒ¨æ¸…é™¤
         */
        function handleClearAll() {
            if (confirm("æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å†Šå’Œå…¨éƒ¨æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
                resetState(true); // é‡ç½®ä¸¦å»ºç«‹æ–°å†Š
                renderAllBooks(); // æ¸²æŸ“
                saveState(); // ç«‹å³å„²å­˜
                showToast("æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤ã€‚", "success");
            }
        }

        /**
         * è™•ç† JSON åŒ¯å‡º
         */
        function handleExport() {
            try {
                const data = JSON.stringify(state, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.href = url;
                a.download = `multi-book-calculator-backup-${timestamp}.json`;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast("è³‡æ–™åŒ¯å‡ºæˆåŠŸã€‚", "success");
            } catch (e) {
                showToast("åŒ¯å‡ºå¤±æ•—ã€‚", "error");
            }
        }

        /**
         * è™•ç†åŒ¯å…¥æŒ‰éˆ•é»æ“Š
         */
        function handleImportClick() {
            importFileInput.click();
        }

        /**
         * è™•ç†æª”æ¡ˆåŒ¯å…¥ (è¦†è“‹æ¨¡å¼)
         */
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (importedData && Array.isArray(importedData.books) && typeof importedData.globalTaxRate === 'number') {
                        if (confirm("åŒ¯å…¥å°‡æœƒè¦†è“‹ç•¶å‰æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) {
                            state = importedData;

                            // ã€NEWã€‘ç¢ºä¿åŒ¯å…¥çš„è³‡æ–™æœ‰æ–° state
                            state.entryType = state.entryType || 'OUT';
                            state.isInclusive = state.isInclusive || false;

                            updateGlobalUI(); // æ›´æ–° UI ä¸Šçš„è¨­å®š
                            renderAllBooks();
                            saveState();
                            showToast("è³‡æ–™åŒ¯å…¥ä¸¦è¦†è“‹æˆåŠŸã€‚", "success");
                        }
                    } else {
                        throw new Error("ç„¡æ•ˆçš„æª”æ¡ˆæ ¼å¼ã€‚");
                    }
                } catch (err) {
                    showToast(`åŒ¯å…¥å¤±æ•—ï¼š${err.message}`, "error");
                } finally {
                    importFileInput.value = '';
                }
            };

            reader.onerror = () => {
                showToast("è®€å–æª”æ¡ˆå¤±æ•—ã€‚", "error");
                importFileInput.value = '';
            };

            reader.readAsText(file);
        }

        // --- 6. Initialization ---

        /**
         * æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
         */
        function init() {
            // ç¶å®šå…¨åŸŸäº‹ä»¶
            taxRateInput.addEventListener('change', handleTaxRateChange);
            addNewBookBtn.addEventListener('click', addNewBook);

            // ã€NEWã€‘ç¶å®šå››æ¨äº”å…¥æ¨¡å¼
            if (roundOriginal) roundOriginal.addEventListener('change', handleRoundingModeChange);
            if (roundNormal) roundNormal.addEventListener('change', handleRoundingModeChange);
            if (roundUp) roundUp.addEventListener('change', handleRoundingModeChange);
            if (roundDown) roundDown.addEventListener('change', handleRoundingModeChange);
            if (decimalPlaces) decimalPlaces.addEventListener('change', handleRoundingModeChange);

            // ç¶å®šåŒ¯å‡º/åŒ¯å…¥/æ¸…é™¤
            exportBtn.addEventListener('click', handleExport);
            importBtn.addEventListener('click', handleImportClick);
            importFileInput.addEventListener('change', handleImportFile);
            clearAllBtn.addEventListener('click', handleClearAll);
            // patch: 2025-11-08 ç¶å®šå„²å­˜ç´€éŒ„æŒ‰éˆ•
            if (saveRecordBtn) {
                saveRecordBtn.addEventListener('click', showSaveDialog);
            }

            // è¼‰å…¥è³‡æ–™ä¸¦æ¸²æŸ“
            loadState();
            updateGlobalUI();
            renderAllBooks();
            // patch: 2025-11-08 è¼‰å…¥å„²å­˜ç´€éŒ„
            loadSavedRecords();

            if (state.books.length === 0 || (state.books.length === 1 && state.books[0].entries.length === 0)) {
                updateAllCalculations();
            }
        }

        // --- 7. Run Application ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    </script>
</body>

</html>
