<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFFLINE CRM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;700&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <!-- SheetJS åº«ç”¨æ–¼è™•ç† Excel æª”æ¡ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --color-background: #101010;
            --color-surface: #1A1A1A;
            --color-surface-light: #252525;
            --color-text-primary: #F0F0F0;
            --color-text-secondary: #A0A0A0;
            --color-accent-gold: #D4AF37;
            --color-border: #383838;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-text-primary);
            font-family: 'Inter', sans-serif;
            font-weight: 300;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Layout & Components --- */
        .app-header {
            padding: 1.5rem 2.5rem;
            text-align: center;
            border-bottom: 1px solid var(--color-border);
        }

        .main-title {
            font-family: 'EB Garamond', serif;
            font-size: 2.2rem;
            font-weight: 700;
        }

        .main-container {
            padding: 2rem 2.5rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .tab-nav {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            position: relative;
            transition: color 0.3s ease;
        }

        .tab-btn:hover {
            color: var(--color-text-primary);
        }

        .tab-btn.active {
            color: var(--color-text-primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--color-accent-gold);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .module-title {
            font-family: 'EB Garamond', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .card {
            background-color: var(--color-surface);
            padding: 2.5rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border-radius: 4px;
        }

        .btn-primary {
            background-color: var(--color-accent-gold);
            color: #000;
            border-color: var(--color-accent-gold);
        }

        .btn-primary:hover {
            background-color: #FFD700;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(212, 175, 55, 0.3);
        }

        /* --- å‚™è¨»åŒ¯å‡ºé¢æ¿æ¨£å¼ --- */
        .notes-export-panel {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
            border-left: 4px solid var(--color-accent-gold);
        }

        .notes-export-panel h3 {
            color: var(--color-accent-gold);
        }

        #export-notes-excel-btn {
            font-weight: 600;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
        }

        #export-notes-excel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(212, 175, 55, 0.4);
        }

        #notes-count-display {
            font-weight: 500;
            padding: 0.3rem 0.8rem;
            background-color: rgba(212, 175, 55, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        /* --- ç‡Ÿæ¥­ç¨…å°è©±æ¡†å’Œè¨Šæ¯é è¦½æ¨£å¼ --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--color-surface);
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 1.5rem;
            color: var(--color-accent-gold);
        }

        .modal-content .form-group {
            margin-bottom: 1rem;
        }

        .modal-content label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-text-secondary);
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 0.5rem;
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-primary);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .message-preview {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .message-group {
            margin-bottom: 2rem;
        }

        .message-group h4 {
            color: var(--color-accent-gold);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .message-item {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .message-header {
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .message-content {
            background: var(--color-background);
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .copy-message-btn {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
        }

        .btn-small {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
        }

        .vat-row-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* --- æé†’å¡ç‰‡æ¨£å¼ --- */
        .reminder-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .reminder-card {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .reminder-card:hover {
            background: var(--color-border);
            transform: translateY(-1px);
        }

        .reminder-company {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.3rem;
        }

        .reminder-contact,
        .reminder-method,
        .reminder-date,
        .reminder-note {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.2rem;
        }

        .reminder-note {
            color: var(--color-accent-gold);
            font-style: italic;
        }

        .reminder-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }

        .empty-reminder {
            text-align: center;
            color: var(--color-text-secondary);
            padding: 2rem;
            font-style: italic;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* --- æœå°‹å€å¡Šæ¨£å¼ --- */
        .search-section {
            background-color: var(--color-surface);
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--color-border);
        }

        /* --- å®¢æˆ¶åˆ—è¡¨å·¥å…·åˆ—æ¨£å¼ --- */
        .customer-list-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid var(--color-border);
            margin-top: 1rem;
        }

        .toolbar-left {
            flex: 1;
            max-width: 400px;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 0.6rem 2rem 0.6rem 0.8rem;
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-accent-gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }

        .search-input::placeholder {
            color: var(--color-text-secondary);
        }

        .clear-search-btn {
            position: absolute;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.2rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .clear-search-btn:hover {
            background: var(--color-border);
            color: var(--color-text-primary);
        }

        .export-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
        }

        .export-info {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            font-style: italic;
        }

        #export-customers-excel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #export-customers-excel-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .customer-list-toolbar {
                justify-content: center;
            }

            .export-container {
                align-items: center;
            }

            .search-section {
                margin-bottom: 1.5rem;
            }
        }

        /* --- ç‡Ÿæ¥­ç¨…é é¢æ¨£å¼ --- */
        .vat-controls {
            margin-bottom: 1.5rem;
        }

        .vat-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 2rem;
        }

        .vat-period-controls {
            display: flex;
            gap: 1.5rem;
            align-items: flex-end;
        }

        .vat-period-controls .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .vat-period-controls label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .vat-period-controls input,
        .vat-period-controls select {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .vat-quick-actions {
            display: flex;
            gap: 1rem;
        }

        /* æé†’å€å¡Š */
        .vat-reminders-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .vat-reminder-column .card {
            height: 100%;
            min-height: 300px;
        }

        .reminder-title {
            font-family: 'EB Garamond', serif;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--color-accent-gold);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.5rem;
        }

        .reminder-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .reminder-card {
            background: var(--color-surface-light);
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid var(--color-accent-gold);
        }

        .reminder-card-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .reminder-card-info {
            flex-grow: 1;
        }

        .reminder-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .reminder-card-company {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .reminder-card-details {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-top: 0.3rem;
        }

        /* æ‰¹æ¬¡å€å¡Š */
        .vat-batch-section {
            margin-bottom: 1.5rem;
        }

        .batch-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 2rem;
        }

        .collect-method-filter {
            flex-grow: 1;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 0.5rem 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .batch-actions {
            display: flex;
            gap: 1rem;
        }

        .message-preview {
            background: var(--color-surface-light);
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid var(--color-accent-gold);
            white-space: pre-wrap;
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }

        /* è³‡æ–™è¡¨æ ¼ */
        .vat-data-section {
            margin-bottom: 2rem;
        }

        .vat-table-container {
            overflow-x: auto;
        }

        .vat-data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .vat-data-table th,
        .vat-data-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
            vertical-align: top;
        }

        .vat-data-table th {
            background: var(--color-surface);
            font-weight: 600;
            color: var(--color-text-secondary);
            position: sticky;
            top: 0;
        }

        .vat-data-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .vat-row-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .vat-header-row {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .vat-period-controls {
                flex-wrap: wrap;
            }

            .vat-reminders-section {
                grid-template-columns: 1fr;
            }

            .batch-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--color-text-secondary);
            border-color: var(--color-border);
        }

        /* --- Customer Form --- */
        .data-form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        .form-group input {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.6rem 0.2rem;
            font-size: 1rem;
            width: 100%;
        }

        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            border-top: 1px solid var(--color-border);
            padding-top: 1.5rem;
        }

        /* --- Customer Table --- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
            table-layout: fixed;
        }

        .data-table th:nth-child(1) {
            width: 18%;
        }

        /* ä»£è™Ÿ/å…¬å¸åç¨± */
        .data-table th:nth-child(2) {
            width: 15%;
        }

        /* è¯çµ¡äºº/é›»è©± */
        .data-table th:nth-child(3) {
            width: 15%;
        }

        /* çµ±ä¸€ç·¨è™Ÿ/ç¨…ç±ç·¨è™Ÿ */
        .data-table th:nth-child(4) {
            width: 20%;
        }

        /* åœ°å€ */
        .data-table th:nth-child(5) {
            width: 10%;
        }

        /* ç§Ÿç´„èµ·æ—¥ */
        .data-table th:nth-child(6) {
            width: 10%;
        }

        /* ç§Ÿç´„è¿„æ—¥ */
        .data-table th:nth-child(7) {
            width: 12%;
        }

        /* æ“ä½œ */

        .data-table th,
        .data-table td {
            padding: 1rem 0.8rem;
            text-align: left;
            vertical-align: top;
            border-bottom: 1px solid var(--color-border);
            line-height: 1.5;
            position: relative;
        }

        .data-table th {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            line-height: 1.2;
            background-color: var(--color-surface);
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: center;
            vertical-align: middle;
        }

        .data-table tr {
            transition: all 0.2s ease;
        }

        .data-table tr:hover {
            background-color: rgba(212, 175, 55, 0.05);
        }

        /* å³å°‡åˆ°æœŸçš„è¡Œæ¨£å¼ */
        .data-table tr.expiring-soon {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), transparent);
            border-left: 4px solid var(--color-accent-gold);
        }

        .data-table tr.expired {
            background: linear-gradient(90deg, rgba(229, 115, 115, 0.1), transparent);
            border-left: 4px solid #E57373;
        }

        .data-table tr.expiring-soon:hover,
        .data-table tr.expired:hover {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
        }

        .data-table tr.expired:hover {
            background: linear-gradient(90deg, rgba(229, 115, 115, 0.15), rgba(229, 115, 115, 0.05));
        }

        /* ç§Ÿç´„åˆ°æœŸæ—¥æ¬„ä½çš„ç‰¹æ®Šæ¨£å¼ */
        .lease-end-cell {
            position: relative;
        }

        .lease-end-cell.expiring {
            color: var(--color-accent-gold);
            font-weight: 600;
        }

        .lease-end-cell.expired {
            color: #E57373;
            font-weight: 600;
        }

        .lease-end-cell::after {
            content: '';
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0;
        }

        .lease-end-cell.expiring::after {
            background-color: var(--color-accent-gold);
            opacity: 1;
            animation: pulse 2s infinite;
        }

        .lease-end-cell.expired::after {
            background-color: #E57373;
            opacity: 1;
            animation: urgentBlink 1s infinite;
        }

        .table-row-actions {
            padding: 0.5rem;
        }

        .action-buttons-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.3rem;
            max-width: 120px;
        }

        .table-row-actions .btn-action {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            text-decoration: underline;
            font-size: 0.85rem;
            transition: color 0.2s ease;
            padding: 0.2rem 0;
            text-align: left;
            white-space: nowrap;
        }

        .table-row-actions .btn-action:hover {
            color: var(--color-text-primary);
            background-color: rgba(212, 175, 55, 0.1);
        }

        /* --- Global Notes Page & Tag Filtering --- */
        .filter-container {
            background-color: var(--color-surface);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .tag-filter-bar {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            overflow-x: auto;
            padding-bottom: 1.5rem;
        }

        .tag-filter-bar .tag-item {
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .tag-filter-bar .tag-item.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .filter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }

        .filter-logic-switcher .btn {
            font-size: 0.7rem;
            padding: 0.3rem 0.6rem;
        }

        .filter-status-bar {
            background-color: var(--color-surface-light);
            padding: 0.8rem 1.5rem;
            margin-bottom: 2rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-list {
            list-style: none;
        }

        .note-card {
            position: relative;
            background: var(--color-surface);
            padding: 1.5rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border-left: 3px solid var(--color-border);
        }

        .note-card .customer-name {
            font-family: 'EB Garamond', serif;
            font-weight: 700;
            color: var(--color-accent-gold);
        }

        .note-content {
            margin: 0.5rem 0 1rem 0;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .note-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-delete-note {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.5;
        }

        .btn-delete-note:hover {
            opacity: 1;
            color: var(--color-accent-gold);
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag-item {
            color: var(--color-text-primary);
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.9rem;
        }

        .notes-textarea {
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-primary);
            padding: 0.8rem;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .tag-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.6rem 0.2rem;
            font-size: 1rem;
            flex-grow: 1;
            min-width: 200px;
        }

        .tag-input-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .tag-delete-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0 0 0 0.5rem;
        }

        /* --- Lease Reminder Specific Styles --- */
        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .no-margin-bottom {
            margin-bottom: 0 !important;
        }

        #expiring-customers-section {
            margin-bottom: 2rem;
            position: relative;
        }

        /* å„ªå…ˆç´šæŒ‡ç¤ºå™¨ - å¢å¼·è¦–è¦ºè­¦ç¤º */
        .priority-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #E53E3E, #C53030);
            color: white;
            padding: 0.5rem 1.2rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.4), 0 0 20px rgba(229, 62, 62, 0.2);
            animation: criticalPulse 1.5s infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes criticalPulse {
            0% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(229, 62, 62, 0.4), 0 0 20px rgba(229, 62, 62, 0.2);
            }

            50% {
                opacity: 0.9;
                transform: scale(1.08);
                box-shadow: 0 6px 25px rgba(229, 62, 62, 0.6), 0 0 30px rgba(229, 62, 62, 0.4);
            }

            100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(229, 62, 62, 0.4), 0 0 20px rgba(229, 62, 62, 0.2);
            }
        }

        /* å¢å¼·ç‹€æ…‹æ¨™ç±¤çš„è¦–è¦ºè¡æ“ŠåŠ› */
        .status-badge.critical {
            background: linear-gradient(135deg, #E53E3E, #C53030);
            color: white;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.4);
            animation: criticalBadge 2s infinite;
        }

        @keyframes criticalBadge {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .status-badge.warning {
            background: linear-gradient(135deg, #D69E2E, #B7791F);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 8px rgba(214, 158, 46, 0.3);
        }

        #expiring-customers-list {
            list-style: none;
            padding: 0;
        }

        #expiring-customers-list li {
            background-color: var(--color-surface-light);
            padding: 1.2rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        #expiring-customers-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            transition: width 0.3s ease;
        }

        #expiring-customers-list li:hover {
            background-color: var(--color-border);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        #expiring-customers-list li:hover::before {
            width: 12px;
        }

        #expiring-customers-list li.expired {
            background: linear-gradient(135deg, rgba(229, 115, 115, 0.1), rgba(229, 115, 115, 0.05));
            border: 1px solid rgba(229, 115, 115, 0.3);
        }

        #expiring-customers-list li.expired::before {
            background: linear-gradient(180deg, #E57373, #EF5350);
        }

        #expiring-customers-list li.expiring-soon {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        #expiring-customers-list li.expiring-soon::before {
            background: linear-gradient(180deg, var(--color-accent-gold), #FFD700);
        }

        #expiring-customers-list .customer-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        #expiring-customers-list .customer-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--color-text-primary);
        }

        #expiring-customers-list .customer-contact {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        #expiring-customers-list .customer-address {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            opacity: 0.8;
        }

        #expiring-customers-list .days-left {
            font-weight: 700;
            font-size: 1rem;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            text-align: center;
            min-width: 120px;
            position: relative;
        }

        #expiring-customers-list .days-left:not(.expired-text) {
            background: linear-gradient(135deg, var(--color-accent-gold), #FFD700);
            color: #000;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }

        #expiring-customers-list .days-left.expired-text {
            background: linear-gradient(135deg, #E57373, #EF5350);
            color: white;
            box-shadow: 0 2px 8px rgba(229, 115, 115, 0.4);
            animation: urgentBlink 1.5s infinite alternate;
        }

        @keyframes urgentBlink {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0.7;
            }
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.critical {
            background: #E57373;
            color: white;
        }

        .status-badge.warning {
            background: var(--color-accent-gold);
            color: #000;
        }

        #reminder-card {
            background-color: var(--color-surface-light);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--color-accent-gold);
            display: none;
        }

        #reminder-card.active {
            display: block;
        }

        #reminder-card pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--color-text-primary);
            margin-bottom: 1rem;
        }

        #reminder-card .copy-btn-wrapper {
            text-align: right;
        }

        .expiring-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-copy-reminder {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
        }
    </style>
    <style>
        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .toast {
            background-color: rgba(50, 50, 50, 0.9);
            color: var(--color-text-primary);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            min-width: 250px;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <header class="app-header">
        <h1 class="main-title">å®¢æˆ¶è³‡æ–™åº«</h1>
    </header>
    <main class="main-container">
        <nav class="tab-nav">
            <button id="tab-list" type="button" class="tab-btn active">å®¢æˆ¶åˆ—è¡¨</button>
            <button id="tab-form" type="button" class="tab-btn">å®¢æˆ¶è³‡æ–™</button>
            <button id="tab-notes" type="button" class="tab-btn">æ‰€æœ‰å‚™è¨»</button>
            <button id="tab-vat" type="button" class="tab-btn">ç‡Ÿæ¥­ç¨…</button>
        </nav>

        <div id="page-list" class="page active">
            <!-- Excel åŠŸèƒ½èªªæ˜ -->
            <div class="excel-info card"
                style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 1.5rem;">ğŸ“Š</div>
                    <div>
                        <strong>Excel æ‰¹é‡ç·¨è¼¯åŠŸèƒ½</strong>
                        <div style="font-size: 0.9rem; color: var(--color-text-secondary); margin-top: 0.3rem;">
                            é»æ“Šã€ŒåŒ¯å‡ºç¯„æœ¬ (.xlsx)ã€ä¸‹è¼‰Excelæª”æ¡ˆ â†’ åœ¨Excelä¸­ç·¨è¼¯å®¢æˆ¶è³‡æ–™ â†’ é»æ“Šã€ŒåŒ¯å…¥ Excelã€ä¸Šå‚³ä¿®æ”¹å¾Œçš„æª”æ¡ˆ
                        </div>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆè³‡è¨Šé¢æ¿ -->
            <div class="stats-panel card" style="margin-bottom: 1rem; padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div class="stat-item" style="text-align: center;">
                        <div class="stat-number" id="total-customers"
                            style="font-size: 2rem; font-weight: 700; color: var(--color-accent-gold);">0</div>
                        <div class="stat-label" style="color: var(--color-text-secondary); font-size: 0.9rem;">ç¸½å®¢æˆ¶æ•¸
                        </div>
                    </div>
                    <div class="stat-item" style="text-align: center;">
                        <div class="stat-number" id="expired-count"
                            style="font-size: 2rem; font-weight: 700; color: #E57373;">0</div>
                        <div class="stat-label" style="color: var(--color-text-secondary); font-size: 0.9rem;">å·²åˆ°æœŸ</div>
                    </div>
                    <div class="stat-item" style="text-align: center;">
                        <div class="stat-number" id="expiring-count"
                            style="font-size: 2rem; font-weight: 700; color: var(--color-accent-gold);">0</div>
                        <div class="stat-label" style="color: var(--color-text-secondary); font-size: 0.9rem;">å³å°‡åˆ°æœŸ
                        </div>
                    </div>
                    <div class="stat-item" style="text-align: center;">
                        <div class="stat-number" id="active-count"
                            style="font-size: 2rem; font-weight: 700; color: #38A169;">0</div>
                        <div class="stat-label" style="color: var(--color-text-secondary); font-size: 0.9rem;">æ­£å¸¸ç§Ÿç´„
                        </div>
                    </div>
                </div>
            </div>

            <div id="expiring-customers-section" class="card">
                <div class="priority-indicator" id="priority-indicator" style="display: none;">
                    é«˜å„ªå…ˆç´šæé†’
                </div>
                <div class="section-header-row">
                    <h2 class="module-title no-margin-bottom">å³å°‡åˆ°æœŸå®¢æˆ¶</h2>
                    <div class="header-controls" style="display: flex; gap: 1rem; align-items: center;">
                        <select id="expiring-sort-select" class="form-control"
                            style="background: var(--color-surface-light); color: var(--color-text-primary); border: 1px solid var(--color-border); padding: 0.5rem; border-radius: 4px;">
                            <option value="days-asc">ä¾åˆ°æœŸæ—¥æ’åº (è¿‘åˆ°é )</option>
                            <option value="days-desc">ä¾åˆ°æœŸæ—¥æ’åº (é åˆ°è¿‘)</option>
                            <option value="company-asc">ä¾å…¬å¸åç¨±æ’åº (A-Z)</option>
                            <option value="company-desc">ä¾å…¬å¸åç¨±æ’åº (Z-A)</option>
                        </select>
                        <select id="expiring-filter-select" class="form-control"
                            style="background: var(--color-surface-light); color: var(--color-text-primary); border: 1px solid var(--color-border); padding: 0.5rem; border-radius: 4px;">
                            <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
                            <option value="expired">åƒ…é¡¯ç¤ºå·²åˆ°æœŸ</option>
                            <option value="critical">åƒ…é¡¯ç¤º30å¤©å…§åˆ°æœŸ</option>
                            <option value="warning">åƒ…é¡¯ç¤º90å¤©å…§åˆ°æœŸ</option>
                        </select>
                        <button id="export-expiring-csv-btn" class="btn btn-secondary">åŒ¯å‡º CSV</button>
                        <button id="export-excel-template-btn" class="btn btn-primary">åŒ¯å‡ºç¯„æœ¬ (.xlsx)</button>
                        <button id="import-excel-btn" class="btn btn-primary">åŒ¯å…¥ Excel</button>
                        <button id="export-all-data-btn" class="btn btn-secondary">åŒ¯å‡ºæ‰€æœ‰è³‡æ–™</button>
                        <button id="import-data-btn" class="btn btn-secondary">åŒ¯å…¥è³‡æ–™</button>
                        <button id="restore-backup-btn" class="btn btn-secondary">é‚„åŸå‚™ä»½</button>
                        <button id="auto-backup-btn" class="btn btn-secondary">ç«‹å³å‚™ä»½</button>
                        <button id="clear-data-btn" class="btn btn-secondary"
                            style="background-color: #E53E3E; color: white;">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                    </div>
                </div>
                <ul id="expiring-customers-list"></ul>
            </div>

            <div id="reminder-card" class="card">
                <pre id="reminder-text-display"></pre>
                <div class="copy-btn-wrapper">
                    <button id="copy-reminder-btn" class="btn btn-primary">è¤‡è£½æé†’èª</button>
                </div>
            </div>

            <!-- é—œéµå­—æœå°‹å€å¡Š - ç§»å‹•åˆ°å®¢æˆ¶æ¨™é¡Œåˆ—ä¸Šæ–¹ -->
            <div class="search-section" style="margin-bottom: 1rem;">
                <div class="search-container">
                    <input type="text" id="customer-search-input" class="search-input"
                        placeholder="é—œéµå­—æœå°‹ï¼ˆå…¬å¸/è¯çµ¡äºº/åœ°å€/Email/é›»è©±/æ¨™ç±¤ï¼‰">
                    <button id="clear-search-btn" class="clear-search-btn" style="display: none;">Ã—</button>
                </div>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ä»£è™Ÿ<br>å…¬å¸åç¨±</th>
                        <th>è¯çµ¡äºº<br>é›»è©±</th>
                        <th>çµ±ä¸€ç·¨è™Ÿ<br>ç¨…ç±ç·¨è™Ÿ</th>
                        <th>åœ°å€</th>
                        <th>ç§Ÿç´„èµ·æ—¥</th>
                        <th>ç§Ÿç´„è¿„æ—¥</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="customer-list-body"></tbody>
            </table>

            <!-- å®¢æˆ¶åˆ—è¡¨å·¥å…·åˆ— -->
            <div class="customer-list-toolbar">
                <div class="toolbar-left">
                    <!-- å„²å­˜çµ±è¨ˆè³‡è¨Š -->
                    <div id="storage-stats" style="font-size: 0.8rem; color: var(--color-text-secondary); display: flex; gap: 1rem;">
                        <span>è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                <div class="toolbar-right">
                    <div class="export-container">
                        <button id="export-customers-excel-btn" class="btn btn-primary">åŒ¯å‡º Excel (.xlsx)</button>
                        <div class="export-info">åŒ¯å‡ºï¼šç›®å‰çµæœ</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-form" class="page">
            <div id="form-container"></div>
        </div>

        <div id="page-notes" class="page">
            <div class="filter-container">
                <div class="tag-filter-bar" id="tag-filter-bar"></div>
                <div class="filter-controls">
                    <div>
                        <label>ç¯©é¸é‚è¼¯: </label>
                        <div class="btn-group" id="filter-logic-switcher">
                            <button class="btn btn-secondary active" data-logic="OR">OR (è¯é›†)</button>
                            <button class="btn btn-secondary" data-logic="AND">AND (äº¤é›†)</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- å‚™è¨»åŒ¯å‡ºåŠŸèƒ½å€å¡Š -->
            <div class="notes-export-panel card" id="notesExportPanel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; font-family: 'EB Garamond', serif; font-size: 1.5rem;">å‚™è¨»åŒ¯å‡º</h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <span id="notes-count-display"
                            style="color: var(--color-text-secondary); font-size: 0.9rem;">è¼‰å…¥ä¸­...</span>
                        <button id="export-notes-excel-btn" class="btn btn-primary"
                            style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>ğŸ“Š</span>
                            <span>åŒ¯å‡º Excel (.xlsx)</span>
                        </button>
                    </div>
                </div>
                <div style="color: var(--color-text-secondary); font-size: 0.9rem; line-height: 1.5;">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>åŒ¯å‡ºæ¨¡å¼ï¼š</strong>
                    </div>
                    <div style="margin-left: 1rem;">
                        â€¢ <strong>æœ‰æ¨™ç±¤ç¯©é¸æ™‚</strong>ï¼šåƒ…åŒ¯å‡ºç¬¦åˆç¯©é¸æ¢ä»¶çš„å‚™è¨»<br>
                        â€¢ <strong>ç„¡æ¨™ç±¤ç¯©é¸æ™‚</strong>ï¼šåŒ¯å‡ºæ‰€æœ‰å®¢æˆ¶çš„å‚™è¨»è³‡æ–™
                    </div>
                </div>
            </div>
            <div class="filter-status-bar" id="filter-status-bar" style="display: none;">
                <span></span><button class="btn btn-secondary" id="clear-filter-btn">æ¸…ç©ºç¯©é¸</button>
            </div>
            <ul class="notes-list" id="notes-list"></ul>
        </div>

        <!-- ç‡Ÿæ¥­ç¨…é é¢ -->
        <div id="page-vat" class="page">
            <!-- é ‚éƒ¨æ§åˆ¶åˆ— -->
            <div class="vat-controls card">
                <div class="vat-header-row">
                    <div class="vat-period-controls">
                        <div class="form-group">
                            <label for="vat-year">å¹´åº¦</label>
                            <input type="number" id="vat-year" min="100" max="200" value="113" style="width: 80px;">
                        </div>
                        <div class="form-group">
                            <label for="vat-period">æœŸæ•¸</label>
                            <select id="vat-period">
                                <option value="1">ç¬¬1æœŸ (01-02æœˆ)</option>
                                <option value="2">ç¬¬2æœŸ (03-04æœˆ)</option>
                                <option value="3">ç¬¬3æœŸ (05-06æœˆ)</option>
                                <option value="4">ç¬¬4æœŸ (07-08æœˆ)</option>
                                <option value="5">ç¬¬5æœŸ (09-10æœˆ)</option>
                                <option value="6">ç¬¬6æœŸ (11-12æœˆ)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vat-deadline">æœ€æ™šæ”¶å–ç™¼ç¥¨æ—¥</label>
                            <input type="date" id="vat-deadline">
                        </div>
                    </div>
                    <div class="vat-quick-actions">
                        <button id="load-other-period-btn" class="btn btn-secondary">è¼‰å…¥ä»–æœŸä½œç‚ºè‰ç¨¿</button>
                        <button id="vat-history-btn" class="btn btn-secondary">ç·¨è¼¯ç´€éŒ„</button>
                        <button id="vat-backup-btn" class="btn btn-secondary">å‚™ä»½ç‡Ÿæ¥­ç¨…è³‡æ–™</button>
                        <button id="vat-restore-btn" class="btn btn-secondary">é‚„åŸå‚™ä»½</button>
                        <button id="m2-json-export" class="btn btn-secondary">åŒ¯å‡º JSON</button>
                        <input type="file" id="m2-json-in" accept=".json" style="display: none;">
                        <button id="m2-json-import-btn" class="btn btn-secondary">åŒ¯å…¥ JSON</button>
                    </div>
                </div>
                
                <!-- ç‡Ÿæ¥­ç¨…å„²å­˜çµ±è¨ˆ -->
                <div style="margin-top: 1rem; padding: 0.8rem; background: var(--color-surface-light); border-radius: 4px; border-left: 3px solid var(--color-accent-gold);">
                    <div id="vat-storage-stats" style="font-size: 0.8rem; color: var(--color-text-secondary); display: flex; gap: 1rem;">
                        <span>è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            </div>

            <!-- æé†’å€å¡Šï¼ˆå…©æ¬„ï¼‰ -->
            <div class="vat-reminders-section">
                <div class="vat-reminder-column">
                    <div class="card">
                        <h3 class="reminder-title">ä»Šæ—¥é è¨ˆæ”¶å– <span id="today-date"></span></h3>
                        <div id="today-reminders" class="reminder-list"></div>
                    </div>
                </div>
                <div class="vat-reminder-column">
                    <div class="card">
                        <h3 class="reminder-title">æ˜æ—¥é è¨ˆæ”¶å– <span id="tomorrow-date-range"></span></h3>
                        <div id="tomorrow-reminders" class="reminder-list"></div>
                    </div>
                </div>
            </div>

            <!-- æé†’å®¢äººå€å¡Š -->
            <div class="vat-batch-section card">
                <h3>æé†’å®¢äººï¼ˆæ‰¹æ¬¡è©±è¡“ & åŒ¯å‡ºï¼‰</h3>
                <div class="batch-controls">
                    <div class="collect-method-filter">
                        <label>æ”¶å–ç™¼ç¥¨æ–¹å¼ï¼š</label>
                        <div id="collect-method-checkboxes" class="checkbox-group"></div>
                        <button id="add-collect-method-btn" class="btn btn-secondary btn-small">+ æ–°å¢æ–¹å¼</button>
                    </div>
                    <div class="batch-actions">
                        <button id="generate-batch-message-btn" class="btn btn-primary">ä¸€éµç”¢ç”Ÿè©±è¡“</button>
                        <button id="export-batch-excel-btn" class="btn btn-primary">åŒ¯å‡º Excel</button>
                    </div>
                </div>
                <div id="batch-message-preview" class="message-preview" style="display: none;"></div>
            </div>

            <!-- æœ¬æœŸè³‡æ–™è¡¨æ ¼ -->
            <div class="vat-data-section card">
                <div class="section-header-row">
                    <h3>æœ¬æœŸè³‡æ–™</h3>
                    <div class="data-actions">
                        <button id="add-vat-row-btn" class="btn btn-primary">+ æ–°å¢å®¢æˆ¶</button>
                        <button id="export-period-data-btn" class="btn btn-secondary">åŒ¯å‡ºæœ¬æœŸè³‡æ–™</button>
                    </div>
                </div>
                <div class="vat-table-container">
                    <table class="vat-data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-vat"></th>
                                <th>å®¢æˆ¶</th>
                                <th>æ”¶å–æ–¹å¼</th>
                                <th>é è¨ˆæ”¶å–æ—¥</th>
                                <th>å‚™è¨»-ç™¼ç¥¨</th>
                                <th>å‚™è¨»-æé†’</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="vat-data-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="toast-container"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- CONFIG --- //
            const EXPIRE_SOON_DAYS = 90; // å¯èª¿æ•´çš„åˆ°æœŸæé†’é–¾å€¼

            // --- DATA STORAGE FUNCTIONS --- //
            const STORAGE_KEY = 'offline-crm-customers';
            const BACKUP_KEY = 'offline-crm-backup';
            const SETTINGS_KEY = 'offline-crm-settings';

            // å„²å­˜è³‡æ–™åˆ° localStorageï¼ˆå¢å¼·ç‰ˆï¼‰
            const saveCustomersToStorage = () => {
                try {
                    // å»ºç«‹å‚™ä»½ï¼ˆä¿ç•™ä¸Šä¸€ç‰ˆæœ¬ï¼‰
                    const currentData = localStorage.getItem(STORAGE_KEY);
                    if (currentData) {
                        const backupData = {
                            data: currentData,
                            timestamp: new Date().toISOString(),
                            version: Date.now()
                        };
                        localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
                    }

                    // å„²å­˜æ–°è³‡æ–™ï¼ˆåŒ…å«å…ƒè³‡æ–™ï¼‰
                    const dataToSave = {
                        customers: customers,
                        lastModified: new Date().toISOString(),
                        version: Date.now(),
                        checksum: generateChecksum(customers)
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                    
                    // æ›´æ–°å„²å­˜çµ±è¨ˆ
                    updateStorageStats();
                    console.log('å®¢æˆ¶è³‡æ–™å·²å„²å­˜åˆ°æœ¬åœ°å„²å­˜');
                } catch (error) {
                    console.error('å„²å­˜å®¢æˆ¶è³‡æ–™å¤±æ•—:', error);
                    if (error.name === 'QuotaExceededError') {
                        showToast('å„²å­˜ç©ºé–“ä¸è¶³ï¼è«‹æ¸…ç†ç€è¦½å™¨è³‡æ–™æˆ–åŒ¯å‡ºå‚™ä»½', 'error');
                        // å˜—è©¦æ¸…ç†èˆŠå‚™ä»½
                        cleanupOldBackups();
                    } else {
                        showToast('å„²å­˜è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š', 'error');
                    }
                }
            };

            // å¾ localStorage è¼‰å…¥è³‡æ–™ï¼ˆå¢å¼·ç‰ˆï¼‰
            const loadCustomersFromStorage = () => {
                try {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        
                        // æª¢æŸ¥è³‡æ–™æ ¼å¼ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
                        if (Array.isArray(parsedData)) {
                            // èˆŠæ ¼å¼ï¼šç›´æ¥æ˜¯é™£åˆ—
                            console.log('å¾æœ¬åœ°å„²å­˜è¼‰å…¥å®¢æˆ¶è³‡æ–™:', parsedData.length, 'ç­†ï¼ˆèˆŠæ ¼å¼ï¼‰');
                            return parsedData;
                        } else if (parsedData.customers) {
                            // æ–°æ ¼å¼ï¼šåŒ…å«å…ƒè³‡æ–™
                            const customers = parsedData.customers;
                            
                            // é©—è­‰è³‡æ–™å®Œæ•´æ€§
                            if (parsedData.checksum && !verifyChecksum(customers, parsedData.checksum)) {
                                console.warn('è³‡æ–™æ ¡é©—å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥å‚™ä»½...');
                                showToast('è³‡æ–™å¯èƒ½æå£ï¼Œæ­£åœ¨è¼‰å…¥å‚™ä»½...', 'warning');
                                return loadBackupData();
                            }
                            
                            console.log('å¾æœ¬åœ°å„²å­˜è¼‰å…¥å®¢æˆ¶è³‡æ–™:', customers.length, 'ç­†ï¼ˆ', parsedData.lastModified, 'ï¼‰');
                            return customers;
                        }
                    }
                } catch (error) {
                    console.error('è¼‰å…¥å®¢æˆ¶è³‡æ–™å¤±æ•—:', error);
                    showToast('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥å‚™ä»½...', 'warning');
                    return loadBackupData();
                }
                return null;
            };

            // è¼‰å…¥å‚™ä»½è³‡æ–™
            const loadBackupData = () => {
                try {
                    const backupData = localStorage.getItem(BACKUP_KEY);
                    if (backupData) {
                        const backup = JSON.parse(backupData);
                        const restoredData = JSON.parse(backup.data);
                        
                        let customers;
                        if (Array.isArray(restoredData)) {
                            customers = restoredData;
                        } else if (restoredData.customers) {
                            customers = restoredData.customers;
                        }
                        
                        if (customers) {
                            showToast(`å·²å¾å‚™ä»½è¼‰å…¥è³‡æ–™ï¼ˆ${new Date(backup.timestamp).toLocaleString()}ï¼‰`, 'success');
                            return customers;
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('è¼‰å…¥å‚™ä»½è³‡æ–™å¤±æ•—:', error);
                    showToast('è¼‰å…¥å‚™ä»½è³‡æ–™ä¹Ÿå¤±æ•—äº†', 'error');
                    return null;
                }
            };

            // ç”Ÿæˆè³‡æ–™æ ¡é©—ç¢¼
            const generateChecksum = (data) => {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // è½‰æ›ç‚º32ä½æ•´æ•¸
                }
                return hash.toString();
            };

            // é©—è­‰è³‡æ–™æ ¡é©—ç¢¼
            const verifyChecksum = (data, expectedChecksum) => {
                return generateChecksum(data) === expectedChecksum;
            };

            // å„²å­˜ä½¿ç”¨è€…è¨­å®š
            const saveSettings = (settings) => {
                try {
                    const currentSettings = loadSettings();
                    const newSettings = { ...currentSettings, ...settings };
                    localStorage.setItem(SETTINGS_KEY, JSON.stringify(newSettings));
                } catch (error) {
                    console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                }
            };

            // è¼‰å…¥ä½¿ç”¨è€…è¨­å®š
            const loadSettings = () => {
                try {
                    const settings = localStorage.getItem(SETTINGS_KEY);
                    return settings ? JSON.parse(settings) : {
                        autoBackup: true,
                        backupInterval: 24, // å°æ™‚
                        theme: 'dark'
                    };
                } catch (error) {
                    console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
                    return { autoBackup: true, backupInterval: 24, theme: 'dark' };
                }
            };

            // æ›´æ–°å„²å­˜çµ±è¨ˆè³‡è¨Š
            const updateStorageStats = () => {
                try {
                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            totalSize += localStorage[key].length;
                        }
                    }
                    
                    // æ›´æ–° UI ä¸­çš„çµ±è¨ˆè³‡è¨Š
                    const statsElement = document.getElementById('storage-stats');
                    if (statsElement) {
                        const sizeKB = Math.round(totalSize / 1024);
                        const maxSize = 5120; // å‡è¨­æœ€å¤§ 5MB
                        const percentage = Math.round((sizeKB / maxSize) * 100);
                        statsElement.innerHTML = `
                            <span>å„²å­˜ï¼š${sizeKB}KB/${maxSize}KB (${percentage}%)</span>
                            <span>å®¢æˆ¶ï¼š${customers.length}ç­†</span>
                        `;
                    }
                } catch (error) {
                    console.error('æ›´æ–°å„²å­˜çµ±è¨ˆå¤±æ•—:', error);
                }
            };

            // æ¸…ç†èˆŠå‚™ä»½
            const cleanupOldBackups = () => {
                try {
                    // æ¸…ç†ä¸€äº›ä¸å¿…è¦çš„èˆŠè³‡æ–™
                    const keysToCheck = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('temp-') || key.includes('cache-')) {
                            keysToCheck.push(key);
                        }
                    }
                    
                    keysToCheck.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    console.log('å·²æ¸…ç†', keysToCheck.length, 'å€‹æš«å­˜é …ç›®');
                } catch (error) {
                    console.error('æ¸…ç†å‚™ä»½å¤±æ•—:', error);
                }
            };

            // è‡ªå‹•å‚™ä»½åŠŸèƒ½
            const createAutoBackup = () => {
                try {
                    const settings = loadSettings();
                    if (!settings.autoBackup) return;
                    
                    const backupData = {
                        customers: customers,
                        timestamp: new Date().toISOString(),
                        type: 'auto',
                        version: '2.0'
                    };
                    
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `è‡ªå‹•å‚™ä»½_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showToast('è‡ªå‹•å‚™ä»½å·²ä¸‹è¼‰', 'success');
                } catch (error) {
                    console.error('è‡ªå‹•å‚™ä»½å¤±æ•—:', error);
                }
            };

            // é è¨­è³‡æ–™
            const defaultCustomers = [
                { id: "C0001", companyName: "ç¯„ä¾‹è‚¡ä»½æœ‰é™å…¬å¸", taxId: "12345678", taxAddr: "å°åŒ—å¸‚ä¿¡ç¾©å€", contact: "æ—å°å§", phone: "02-1234-5678", regAddr: "å°åŒ—å¸‚ä¿¡ç¾©å€ç¤ºä¾‹è·¯ 100 è™Ÿ", contactAddr: "å°åŒ—å¸‚ä¿¡ç¾©å€ç¤ºä¾‹è·¯ 200 è™Ÿ", leaseStart: "2024-01-01", leaseEnd: "2025-01-15", notes: [{ id: `N001`, content: "9/30 å·²å ±åƒ¹ï¼Œå®¢æˆ¶è€ƒæ…®ä¸­ã€‚", tags: ["å ±åƒ¹", "å¾…å›è¦†"], createdAt: "2023-09-30" }] },
                { id: "C0002", companyName: "æ˜Ÿå¡µè¨­è¨ˆ", taxId: "98765432", taxAddr: "å°åŒ—å¸‚å¤§å®‰å€", contact: "å¤§è¡›Â·é®‘ä¼Š", phone: "0987-654-321", regAddr: "å°åŒ—å¸‚å¤§å®‰å€å¿ å­æ±è·¯å››æ®µ 100 è™Ÿ", contactAddr: "å°åŒ—å¸‚å¤§å®‰å€å¿ å­æ±è·¯å››æ®µ 100 è™Ÿ", leaseStart: "2024-03-01", leaseEnd: "2024-06-01", notes: [{ id: `N002`, content: "å°ˆæ¡ˆåˆæ­¥è¨è«–ï¼Œå°æˆ‘å€‘çš„é¢¨æ ¼å¾ˆæ„Ÿèˆˆè¶£ã€‚", tags: ["æ½›åœ¨å®¢æˆ¶", "å¾…å›è¦†"], createdAt: "2023-10-02" }] },
                { id: "C0003", companyName: "æœªä¾†ç§‘æŠ€", taxId: "87654321", taxAddr: "æ–°åŒ—å¸‚æ¿æ©‹å€", contact: "æç¶“ç†", phone: "02-5555-1234", regAddr: "æ–°åŒ—å¸‚æ¿æ©‹å€æ–‡åŒ–è·¯ä¸€æ®µ 1 è™Ÿ", contactAddr: "æ–°åŒ—å¸‚æ¿æ©‹å€æ–‡åŒ–è·¯ä¸€æ®µ 1 è™Ÿ", leaseStart: "2023-01-01", leaseEnd: "2024-03-01", notes: [] }
            ];

            // --- DATA --- //
            // åˆå§‹åŒ–å®¢æˆ¶è³‡æ–™ï¼šå„ªå…ˆå¾æœ¬åœ°å„²å­˜è¼‰å…¥ï¼Œå¦å‰‡ä½¿ç”¨é è¨­è³‡æ–™
            let customers = loadCustomersFromStorage() || defaultCustomers;
            let currentlyEditingId = null;
            let currentlyEditingNoteId = null;
            let newNoteTags = [];
            let filterState = { selectedTags: [], logic: 'OR' };

            // UIç‹€æ…‹ç‰©ä»¶
            let uiState = {
                activeTab: 'page-list',
                expiringSort: 'days-asc',
                expiringFilter: 'all',
                reminderCardOpenForId: null,
                scrollPosition: 0
            };

            // --- UI ELEMENTS --- //
            const doc = (id) => document.getElementById(id);
            const ui = {
                list: doc('page-list'), form: doc('page-form'), notes: doc('page-notes'),
                tabList: doc('tab-list'), tabForm: doc('tab-form'), tabNotes: doc('tab-notes'),
                customerBody: doc('customer-list-body'), formContainer: doc('form-container'),
                notesList: doc('notes-list'), tagFilterBar: doc('tag-filter-bar'),
                filterLogicSwitcher: doc('filter-logic-switcher'), filterStatusBar: doc('filter-status-bar'), clearFilterBtn: doc('clear-filter-btn'),
                expiringCustomersList: doc('expiring-customers-list'), exportExpiringCsvBtn: doc('export-expiring-csv-btn'),
                reminderCard: doc('reminder-card'), reminderTextDisplay: doc('reminder-text-display'), copyReminderBtn: doc('copy-reminder-btn')
            };

            // --- UTILITIES --- //
            const showToast = (message, type = 'success') => {
                const toastContainer = doc('toast-container');
                const toast = document.createElement('div');
                toast.classList.add('toast');
                if (type === 'error') {
                    toast.style.backgroundColor = 'rgba(180, 50, 50, 0.9)';
                }
                toast.textContent = message;
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 10); // Small delay to trigger transition

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            };
            const TAG_COLORS = ['#4A69BD', '#58B19F', '#F8C291', '#EAB543', '#9A6324', '#82589F', '#E06C9F'];
            const getTagColor = (tag) => { let hash = 0; for (let i = 0; i < tag.length; i++) { hash = tag.charCodeAt(i) + ((hash << 5) - hash); } return TAG_COLORS[Math.abs(hash) % TAG_COLORS.length]; };
            const normalizeTag = (tag) => tag.trim().toLowerCase();
            const toROCDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return 'ç„¡æ•ˆæ—¥æœŸ'; // æ–°å¢éŒ¯èª¤è™•ç†
                return `${date.getFullYear() - 1911}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            };
            const getDaysRemaining = (endDateStr) => {
                if (!endDateStr) return Infinity;
                const endDate = new Date(endDateStr);
                if (isNaN(endDate.getTime())) return -99999; // æˆ–å®šç¾©ä¸€å€‹éŒ¯èª¤ç‹€æ…‹å€¼
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffTime = endDate.getTime() - today.getTime();
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };

            // --- RENDER FUNCTIONS --- //
            const renderAll = () => {
                console.log('=== renderAll é–‹å§‹ï¼Œä¿å­˜UIç‹€æ…‹ ===');

                // ä¿å­˜ç•¶å‰UIç‹€æ…‹
                const sortSelect = doc('expiring-sort-select');
                const filterSelect = doc('expiring-filter-select');
                if (sortSelect) uiState.expiringSort = sortSelect.value;
                if (filterSelect) uiState.expiringFilter = filterSelect.value;

                // åŸ·è¡Œæ¸²æŸ“
                renderCustomerTable();
                renderExpiringCustomersList();
                renderNotesPage();
                renderTagFilterBar();
                renderFilterStatusBar();
                updateStatsPanel();

                // æ¢å¾©UIç‹€æ…‹
                setTimeout(() => {
                    const newSortSelect = doc('expiring-sort-select');
                    const newFilterSelect = doc('expiring-filter-select');
                    if (newSortSelect && uiState.expiringSort) {
                        newSortSelect.value = uiState.expiringSort;
                    }
                    if (newFilterSelect && uiState.expiringFilter) {
                        newFilterSelect.value = uiState.expiringFilter;
                    }
                    console.log('=== UIç‹€æ…‹å·²æ¢å¾© ===');
                }, 10);
            };

            const updateStatsPanel = () => {
                const totalCustomers = customers.length;
                const expiredCount = customers.filter(c => c.leaseEnd && getDaysRemaining(c.leaseEnd) <= 0).length;
                const expiringCount = customers.filter(c => c.leaseEnd && getDaysRemaining(c.leaseEnd) > 0 && getDaysRemaining(c.leaseEnd) <= EXPIRE_SOON_DAYS).length;
                const activeCount = customers.filter(c => !c.leaseEnd || getDaysRemaining(c.leaseEnd) > EXPIRE_SOON_DAYS).length;

                const totalEl = doc('total-customers');
                const expiredEl = doc('expired-count');
                const expiringEl = doc('expiring-count');
                const activeEl = doc('active-count');

                if (totalEl) totalEl.textContent = totalCustomers;
                if (expiredEl) expiredEl.textContent = expiredCount;
                if (expiringEl) expiringEl.textContent = expiringCount;
                if (activeEl) activeEl.textContent = activeCount;
            };

            const renderCustomerTable = () => {
                console.log('=== renderCustomerTable é–‹å§‹ ===');
                console.log('å®¢æˆ¶é™£åˆ—é•·åº¦:', customers.length);
                if (customers.length > 0) {
                    console.log('ç¬¬ä¸€ç­†å®¢æˆ¶è³‡æ–™:', customers[0]);
                    const futureCustomer = customers.find(c => c.companyName === 'æœªä¾†ç§‘æŠ€');
                    if (futureCustomer) {
                        console.log('æœªä¾†ç§‘æŠ€å®¢æˆ¶è³‡æ–™:', futureCustomer);
                    }
                }

                if (customers.length === 0) {
                    ui.customerBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">ç›®å‰æ²’æœ‰å®¢æˆ¶è³‡æ–™ã€‚</td></tr>';
                    return;
                }
                ui.customerBody.innerHTML = customers.map(c => {
                    const days = getDaysRemaining(c.leaseEnd);
                    const isExpiring = days <= EXPIRE_SOON_DAYS && days > 0;
                    const isExpired = days <= 0;
                    const rowClass = isExpired ? 'expired' : isExpiring ? 'expiring-soon' : '';
                    const leaseEndClass = isExpired ? 'lease-end-cell expired' : isExpiring ? 'lease-end-cell expiring' : 'lease-end-cell';

                    return `<tr data-id="${c.id}" class="${rowClass}">
                        <td>${escapeHTML(c.id)}<br>${escapeHTML(c.companyName)}</td>
                        <td>${escapeHTML(c.contact) || '-'}<br>${escapeHTML(c.phone) || '-'}</td>
                        <td>${escapeHTML(c.taxId) || '-'}<br>${c.taxAddr ? `ç¨…ç±:${escapeHTML(c.taxAddr)}` : '-'}</td>
                        <td>${c.regAddr ? `è¨­ç±:${escapeHTML(c.regAddr)}` : ''}${c.regAddr && c.contactAddr ? '<br>' : ''}${c.contactAddr ? `è¯çµ¡:${escapeHTML(c.contactAddr)}` : ''}</td>
                        <td>${toROCDate(c.leaseStart) || '-'}</td>
                        <td class="${leaseEndClass}">${toROCDate(c.leaseEnd) || '-'}</td>
                        <td class="table-row-actions">
                            <div class="action-buttons-grid">
                                <button type="button" class="btn-action btn-view-notes">æŸ¥çœ‹å‚™è¨»</button>
                                <button type="button" class="btn-action btn-edit">ç·¨è¼¯</button>
                                <button type="button" class="btn-action btn-delete">åˆªé™¤</button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
            };

            const renderExpiringCustomersList = () => {
                console.log('=== renderExpiringCustomersList é–‹å§‹ ===');
                const futureCustomer = customers.find(c => c.companyName === 'æœªä¾†ç§‘æŠ€');
                if (futureCustomer) {
                    console.log('æ¸²æŸ“åˆ°æœŸæ¸…å–®æ™‚çš„æœªä¾†ç§‘æŠ€è³‡æ–™:', futureCustomer);
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // ç²å–ç¯©é¸å’Œæ’åºè¨­å®š
                const sortSelect = doc('expiring-sort-select');
                const filterSelect = doc('expiring-filter-select');
                const sortValue = sortSelect ? sortSelect.value : 'days-asc';
                const filterValue = filterSelect ? filterSelect.value : 'all';

                // ç¯©é¸é‚è¼¯
                let expiringCustomers = customers.filter(c => {
                    if (!c.leaseEnd) return false;
                    const days = getDaysRemaining(c.leaseEnd);

                    switch (filterValue) {
                        case 'expired': return days <= 0;
                        case 'critical': return days <= 30 && days > 0;
                        case 'warning': return days <= 90 && days > 30;
                        case 'all':
                        default: return days <= EXPIRE_SOON_DAYS;
                    }
                });

                // æ’åºé‚è¼¯
                expiringCustomers.sort((a, b) => {
                    switch (sortValue) {
                        case 'days-desc':
                            return getDaysRemaining(b.leaseEnd) - getDaysRemaining(a.leaseEnd);
                        case 'company-asc':
                            return (a.companyName || '').localeCompare(b.companyName || '');
                        case 'company-desc':
                            return (b.companyName || '').localeCompare(a.companyName || '');
                        case 'days-asc':
                        default:
                            return getDaysRemaining(a.leaseEnd) - getDaysRemaining(b.leaseEnd);
                    }
                });

                ui.expiringCustomersList.innerHTML = '';
                const priorityIndicator = doc('priority-indicator');

                if (expiringCustomers.length === 0) {
                    ui.expiringCustomersList.innerHTML = '<li>ç›®å‰æ²’æœ‰å³å°‡åˆ°æœŸæˆ–å·²åˆ°æœŸçš„å®¢æˆ¶ã€‚</li>';
                    ui.reminderCard.classList.remove('active');
                    priorityIndicator.style.display = 'none';
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦æœ‰ç·Šæ€¥æƒ…æ³ï¼ˆå·²åˆ°æœŸæˆ–30å¤©å…§åˆ°æœŸï¼‰
                const criticalCount = expiringCustomers.filter(c => getDaysRemaining(c.leaseEnd) <= 30).length;
                const expiredCount = expiringCustomers.filter(c => getDaysRemaining(c.leaseEnd) <= 0).length;

                if (criticalCount > 0) {
                    priorityIndicator.style.display = 'block';
                    priorityIndicator.textContent = expiredCount > 0
                        ? `ç·Šæ€¥ï¼š${expiredCount} å€‹å·²åˆ°æœŸï¼Œ${criticalCount - expiredCount} å€‹å³å°‡åˆ°æœŸ`
                        : `æ³¨æ„ï¼š${criticalCount} å€‹å®¢æˆ¶å³å°‡åˆ°æœŸ`;
                } else {
                    priorityIndicator.style.display = 'none';
                }

                // ä¸€æ¬¡æ€§innerHTMLæŒ‡æ´¾ï¼šå…ˆç”¨mapç”¢ç”Ÿå­—ä¸²é™£åˆ—ï¼Œå†joinä¸€æ¬¡æ€§æŒ‡å®š
                const listItemsHtml = expiringCustomers.map(c => {
                    const days = getDaysRemaining(c.leaseEnd);
                    const statusClass = days <= 0 ? 'expired' : 'expiring-soon';
                    const statusText = days <= 0 ? `å·²åˆ°æœŸ ${Math.abs(days)} å¤©` : `å‰©é¤˜ ${days} å¤©`;
                    const urgencyLevel = days <= 0 ? 'critical' : days <= 30 ? 'critical' : 'warning';
                    const statusBadge = days <= 0 ? 'ç·Šæ€¥' : days <= 30 ? 'æ€¥è¿«' : 'æ³¨æ„';

                    return `
                    <li data-id="${c.id}" class="${statusClass}">
                        <div class="status-badge ${urgencyLevel}">${statusBadge}</div>
                        <div class="customer-info">
                            <div class="customer-name">${c.companyName || 'è³‡æ–™å¾…è£œ'}</div>
                            <div class="customer-contact">${c.contact || 'è³‡æ–™å¾…è£œ'} ${c.phone ? 'â€¢ ' + c.phone : ''}</div>
                            <div class="customer-address">${c.regAddr || 'è³‡æ–™å¾…è£œ'}</div>
                        </div>
                        <div class="expiring-actions">
                            <div class="days-left ${statusClass === 'expired' ? 'expired-text' : ''}">
                                <div style="font-size: 0.8rem; opacity: 0.8;">${toROCDate(c.leaseEnd)}</div>
                                <div>${statusText}</div>
                            </div>
                            <div class="action-buttons" style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                <button type="button" class="btn btn-primary btn-quick-edit" data-id="${c.id}" title="å¿«é€Ÿç·¨è¼¯å®¢æˆ¶è³‡æ–™">
                                    âœï¸ ç·¨è¼¯
                                </button>
                                <button type="button" class="btn btn-secondary btn-copy-reminder" data-id="${c.id}" title="è¤‡è£½æé†’è¨Šæ¯">
                                    ğŸ“‹ è¤‡è£½æé†’
                                </button>
                                <button type="button" class="btn btn-secondary btn-mark-renewed" data-id="${c.id}" title="æ¨™è¨˜ç‚ºå·²çºŒç´„" style="background-color: #38A169; color: white;">
                                    âœ“ å·²çºŒç´„
                                </button>
                            </div>
                        </div>
                    </li>`;
                });

                // ä¸€æ¬¡æ€§æŒ‡æ´¾å®Œæ•´HTML
                ui.expiringCustomersList.innerHTML = listItemsHtml.join('');
            };

            const renderFormPage = (customer = null) => {
                currentlyEditingId = customer ? customer.id : null;
                currentlyEditingNoteId = null;
                newNoteTags = [];

                console.log('=== renderFormPage èª¿ç”¨ ===');
                console.log('å‚³å…¥çš„å®¢æˆ¶è³‡æ–™:', customer);
                console.log('è¨­ç½®çš„ currentlyEditingId:', currentlyEditingId);

                const formHtml = `
                <div class="card">
                    <h2 class="module-title">${customer ? 'ç·¨è¼¯å®¢æˆ¶è³‡æ–™' : 'æ–°å¢å®¢æˆ¶è³‡æ–™'}</h2>
                    <form id="data-form">
                        <div class="data-form-grid">
                            <div class="form-group">
                                <label for="id">å®¢æˆ¶ä»£è™Ÿ</label>
                                <input type="text" id="id" value="${customer?.id || ''}" ${customer ? 'readonly' : ''}>
                            </div>
                            <div class="form-group">
                                <label for="companyName">å…¬å¸åç¨±</label>
                                <input type="text" id="companyName" value="${customer?.companyName || ''}">
                            </div>
                            <div class="form-group">
                                <label for="taxId">çµ±ä¸€ç·¨è™Ÿ</label>
                                <input type="text" id="taxId" value="${customer?.taxId || ''}">
                            </div>
                            <div class="form-group">
                                <label for="contact">è¯çµ¡äºº</label>
                                <input type="text" id="contact" value="${customer?.contact || ''}">
                            </div>
                            <div class="form-group">
                                <label for="phone">é›»è©±</label>
                                <input type="text" id="phone" value="${customer?.phone || ''}">
                            </div>
                            <div class="form-group">
                                <label for="leaseStart">ç§Ÿç´„èµ·æ—¥</label>
                                <input type="date" id="leaseStart" value="${customer?.leaseStart || ''}">
                            </div>
                            <div class="form-group">
                                <label for="taxAddr">ç¨…ç±ç·¨è™Ÿ</label>
                                <input type="text" id="taxAddr" value="${customer?.taxAddr || ''}">
                            </div>
                            <div class="form-group full-width">
                                <label for="regAddr">è¨­ç±åœ°å€</label>
                                <input type="text" id="regAddr" value="${customer?.regAddr || ''}">
                            </div>
                            <div class="form-group full-width">
                                <label for="contactAddr">è¯çµ¡åœ°å€</label>
                                <input type="text" id="contactAddr" value="${customer?.contactAddr || ''}">
                            </div>
                            <div class="form-group">
                                <label for="leaseEnd">ç§Ÿç´„è¿„æ—¥</label>
                                <input type="date" id="leaseEnd" value="${customer?.leaseEnd || ''}">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">${customer ? 'æ›´æ–°å®¢æˆ¶' : 'æ–°å¢å®¢æˆ¶'}</button>
                                <button type="button" class="btn btn-secondary" id="cancel-form-btn">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </form>
                </div>`;

                if (customer && customer.notes) {
                    const notesHtml = `
                    <div class="card">
                        <h3 class="module-title">å®¢æˆ¶å‚™è¨»</h3>
                        <div class="tag-input-wrapper">
                            <div id="new-note-tags"></div>
                            <input type="text" id="new-note-tag-input" class="tag-input" placeholder="è¼¸å…¥æ¨™ç±¤å¾ŒæŒ‰ Enter">
                        </div>
                        <textarea id="new-note-content" class="notes-textarea" placeholder="è¼¸å…¥å‚™è¨»å…§å®¹..."></textarea>
                        <button type="button" id="add-note-btn" class="btn btn-primary">å„²å­˜æ–°å‚™è¨»</button>
                        
                        <ul class="notes-list" style="margin-top: 2rem;">
                            ${customer.notes.length > 0 ? customer.notes.map(note => `
                                <li class="note-card">
                                    <p class="note-content">${note.content}</p>
                                    <div class="tag-list">
                                        ${note.tags.map(tag => `<span class="tag-item" style="background-color: ${getTagColor(tag)};">${tag}</span>`).join('')}
                                    </div>
                                    <div class="note-meta">
                                        <span>${note.createdAt}</span>
                                        <div class="note-actions">
                                            <button class="btn-action btn-edit-note" data-note-id="${note.id}">ç·¨è¼¯</button>
                                            <button class="btn-action btn-delete-note" data-note-id="${note.id}">åˆªé™¤</button>
                                        </div>
                                    </div>
                                </li>
                            `).join('') : '<li style="text-align: center; padding: 2rem;">æ­¤å®¢æˆ¶ç›®å‰æ²’æœ‰å‚™è¨»ã€‚</li>'}
                        </ul>
                    </div>`;
                    ui.formContainer.innerHTML = formHtml + notesHtml;
                } else {
                    ui.formContainer.innerHTML = formHtml;
                }

                showPage('page-form');

                // æ¸²æŸ“å®Œæˆå¾Œç«‹å³ç¶å®šsubmitäº‹ä»¶åˆ°ç•¶å‰è¡¨å–®
                setTimeout(() => {
                    const currentForm = doc('data-form');
                    if (currentForm) {
                        console.log('=== ç¶å®šè¡¨å–®submitäº‹ä»¶ ===');
                        currentForm.addEventListener('submit', handleFormSubmit);

                        // é›™é‡é˜²å‘†ï¼šåœ¨è¡¨å–®å±¬æ€§å±¤ç´šç¦æ­¢é è¨­æäº¤
                        currentForm.setAttribute('onsubmit', 'return false;');

                        console.log('è¡¨å–®äº‹ä»¶ç¶å®šå®Œæˆ');
                    } else {
                        console.error('æ‰¾ä¸åˆ°è¡¨å–®å…ƒç´ ï¼Œç„¡æ³•ç¶å®šäº‹ä»¶');
                    }
                }, 10);
            };

            const renderNotesPage = () => {
                const allNotes = customers.flatMap(c =>
                    c.notes.map(note => ({ ...note, customer: c }))
                );

                let filteredNotes = allNotes;
                if (filterState.selectedTags.length > 0) {
                    filteredNotes = allNotes.filter(note => {
                        const noteTags = note.tags.map(normalizeTag);
                        if (filterState.logic === 'AND') {
                            return filterState.selectedTags.every(tag => noteTags.includes(tag));
                        } else {
                            return filterState.selectedTags.some(tag => noteTags.includes(tag));
                        }
                    });
                }

                // æ›´æ–°å‚™è¨»è¨ˆæ•¸é¡¯ç¤º
                const notesCountDisplay = doc('notes-count-display');
                if (notesCountDisplay) {
                    if (filterState.selectedTags.length > 0) {
                        notesCountDisplay.textContent = `ç¯©é¸çµæœï¼š${filteredNotes.length} ç­†å‚™è¨» (å…± ${allNotes.length} ç­†)`;
                    } else {
                        notesCountDisplay.textContent = `å…± ${allNotes.length} ç­†å‚™è¨»`;
                    }
                }

                ui.notesList.innerHTML = filteredNotes.length > 0
                    ? filteredNotes.map(note => `
                    <li class="note-card">
                        <p class="customer-name">${note.customer.companyName || note.customer.id}</p>
                        <p class="note-content">${note.content}</p>
                        <div class="tag-list">
                            ${note.tags.map(tag => `<span class="tag-item" style="background-color: ${getTagColor(tag)};">${tag}</span>`).join('')}
                        </div>
                        <div class="note-meta">
                            <span>${note.createdAt}</span>
                            <div class="note-actions">
                                <button class="btn-action btn-edit-from-note" data-id="${note.customer.id}">ç·¨è¼¯å®¢æˆ¶</button>
                            </div>
                        </div>
                    </li>
                `).join('')
                    : '<li style="text-align: center; padding: 2rem;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å‚™è¨»ã€‚</li>';
            };

            const renderTagFilterBar = () => {
                const allTags = [...new Set(customers.flatMap(c =>
                    c.notes.flatMap(n => n.tags.map(normalizeTag))
                ))];

                ui.tagFilterBar.innerHTML = allTags.map(tag =>
                    `<span class="tag-item ${filterState.selectedTags.includes(tag) ? 'active' : ''}" 
                       style="background-color: ${getTagColor(tag)};" 
                       data-tag="${tag}">${tag}</span>`
                ).join('');
            };

            const renderFilterStatusBar = () => {
                if (filterState.selectedTags.length > 0) {
                    ui.filterStatusBar.style.display = 'flex';
                    ui.filterStatusBar.querySelector('span').textContent =
                        `å·²é¸æ“‡ ${filterState.selectedTags.length} å€‹æ¨™ç±¤ (${filterState.logic} é‚è¼¯)`;
                } else {
                    ui.filterStatusBar.style.display = 'none';
                }
            };

            // å‡è¨­æœ‰ä¸€å€‹å‡½å¼è² è²¬æ¸²æŸ“ç‰¹å®šå®¢æˆ¶çš„å‚™è¨»å€å¡Š
            const renderCustomerNotesSection = (customer) => {
                const notesSection = doc('customer-notes-section'); // å‡è¨­é€™æ˜¯å‚™è¨»å€å¡Šçš„çˆ¶å…ƒç´  ID
                if (!notesSection) return;

                // æ¸…ç©ºä¸¦é‡æ–°æ¸²æŸ“å‚™è¨»åˆ—è¡¨ (æˆ–ä½¿ç”¨æ›´ç²¾ç´°çš„ diffing æ¼”ç®—æ³•)
                notesSection.querySelector('.notes-list').innerHTML = customer.notes.length > 0
                    ? customer.notes.map(note => `
                    <li class="note-card">
                        <p class="customer-name">${customer.companyName}</p>
                        <p class="note-content">${note.content}</p>
                        <div class="tag-list">
                            ${note.tags.map(tag => `<span class="tag-item" style="background-color: ${getTagColor(tag)};">${tag}</span>`).join('')}
                        </div>
                        <div class="note-meta">
                            <span>${note.createdAt}</span>
                            <div class="note-actions">
                                <button class="btn-action btn-edit-note" data-note-id="${note.id}">ç·¨è¼¯</button>
                                <button class="btn-action btn-delete-note" data-note-id="${note.id}">åˆªé™¤</button>
                            </div>
                        </div>
                    </li>
                `).join('')
                    : '<li style="text-align: center; padding: 2rem;">æ­¤å®¢æˆ¶ç›®å‰æ²’æœ‰å‚™è¨»ã€‚</li>';

                // æ›´æ–°æ–°å¢/ç·¨è¼¯å‚™è¨»è¡¨å–®çš„ç‹€æ…‹
                doc('new-note-content').value = currentlyEditingNoteId ? customer.notes.find(n => n.id === currentlyEditingNoteId).content : '';
                doc('new-note-tags').innerHTML = newNoteTags.map(t => `<span class="tag-item" style="background-color: ${getTagColor(t)};" data-tag="${t}">${t} <button class="tag-delete-btn" data-tag="${t}">&times;</button></span>`).join('');
                doc('add-note-btn').textContent = currentlyEditingNoteId ? 'æ›´æ–°å‚™è¨»' : 'å„²å­˜æ–°å‚™è¨»';
            };

            const populateReminderCard = (customer) => {
                const contact = customer.contact || 'è³‡æ–™å¾…è£œ';
                const companyName = customer.companyName || 'è³‡æ–™å¾…è£œ';
                const regAddr = customer.regAddr || 'è³‡æ–™å¾…è£œ';
                const leaseEnd = toROCDate(customer.leaseEnd) || 'è³‡æ–™å¾…è£œ';

                const reminderText =
                    `é™³å°å§ æ‚¨å¥½ï¼š

ç‰¹æ­¤æé†’ï¼Œ${companyName}ç›®å‰æ‰¿ç§Ÿä½æ–¼ ${regAddr}ï¼Œç§Ÿè³ƒåˆç´„å°‡æ–¼${leaseEnd}åˆ°æœŸã€‚

å†éº»ç…©æä¾›æ–°çš„ç§Ÿè³ƒåˆç´„

è¬è¬
`;
                ui.reminderTextDisplay.textContent = reminderText;
                ui.reminderCard.classList.add('active');
            };

            const handleExportExpiringCsv = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const expiringCustomers = customers.filter(c => c.leaseEnd && getDaysRemaining(c.leaseEnd) <= EXPIRE_SOON_DAYS)
                    .sort((a, b) => getDaysRemaining(a.leaseEnd) - getDaysRemaining(b.leaseEnd));

                let csvContent = "å…¬å¸åç¨±,è¯çµ¡äºº,è¨­ç±åœ°å€,ç§Ÿç´„è¿„æ—¥(YYY/MM/DD),å€’æ•¸å¤©æ•¸,é›»è©±\n";
                expiringCustomers.forEach(c => {
                    const days = getDaysRemaining(c.leaseEnd);
                    const company = c.companyName || 'è³‡æ–™å¾…è£œ';
                    const contact = c.contact || 'è³‡æ–™å¾…è£œ';
                    const address = c.regAddr || 'è³‡æ–™å¾…è£œ';
                    const leaseEndRoc = toROCDate(c.leaseEnd) || 'è³‡æ–™å¾…è£œ';
                    const phone = c.phone || 'è³‡æ–™å¾…è£œ';
                    csvContent += `"${company}","${contact}","${address}","${leaseEndRoc}","${days}","${phone}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'å³å°‡åˆ°æœŸå®¢æˆ¶æ¸…å–®.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- ä¿®æ­£ç¼ºå¤±çš„å‡½å¼ --- //
            function editTaxItem(id) {
                const x = tax.items.find(t => t.id === id);
                if (!x) { alert("æ‰¾ä¸åˆ°é …ç›®"); return; }
                // å›å¡«æ¬„ä½ï¼ˆå”¯è®€å¼•ç”¨å®¢æˆ¶ï¼‰
                m2.customerSel.value = x.customerId;
                // å¦‚æœæ–¹æ³•è¢«åˆªäº†ï¼Œè£œå›å»å†é¸å–
                if ([...m2.methodSel.options].some(o => o.value === x.method)) {
                    m2.methodSel.value = x.method;
                } else {
                    methods.list.push(x.method);
                    storeSave(DB_KEYS.METHODS, methods).then(populateMethods);
                    m2.methodSel.value = x.method;
                }
                m2.date.value = x.date;
                m2.remind.value = x.note || "";
                // ä»¥ã€Œåˆªæ—¢æœ‰ â†’ é‡æ–°åŠ å…¥ã€çš„è¦†è“‹æµç¨‹è™•ç†
                if (confirm("å°‡è©²ç­†ç§»é™¤ä¸¦ä»¥ä¸Šæ–¹æ¬„ä½é‡æ–°å»ºç«‹ï¼ˆè¦–ç‚ºè¦†è“‹ï¼‰ï¼Ÿ")) {
                    tax.items = tax.items.filter(t => t.id !== id);
                    storeSave(DB_KEYS.M2, tax).then(renderM2Lists);
                }
            }

            function deleteTaxItem(id) {
                if (!confirm("ç¢ºå®šåˆªé™¤æ­¤é …ï¼Ÿ")) return;
                const i = tax.items.findIndex(t => t.id === id);
                if (i >= 0) {
                    tax.items.splice(i, 1);
                    storeSave(DB_KEYS.M2, tax).then(renderM2Lists);
                }
            }

            // HTML è·³è„«å‡½å¼
            function escapeHTML(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            // åˆªé™¤å®¢æˆ¶å‡½å¼ï¼ˆè™•ç†é—œè¯ç¨…é …ï¼‰
            async function deleteCustomer(id) {
                if (!confirm(`ç¢ºå®šåˆªé™¤å®¢æˆ¶ ${id}ï¼Ÿ`)) return;
                const i = customers.findIndex(c => c.id === id);
                if (i >= 0) {
                    // æª¢æŸ¥æ˜¯å¦æœ‰é—œè¯çš„ç¨…é …è³‡æ–™
                    const vatData = JSON.parse(localStorage.getItem('vatData') || '{}');
                    let orphanCount = 0;

                    // è¨ˆç®—æ‰€æœ‰æœŸæ•¸ä¸­å¼•ç”¨æ­¤å®¢æˆ¶çš„é …ç›®æ•¸é‡
                    Object.values(vatData).forEach(periodData => {
                        if (periodData.rows) {
                            orphanCount += periodData.rows.filter(r => r.customer_id === id).length;
                        }
                    });

                    if (orphanCount > 0) {
                        if (confirm(`åŒæ™‚ç§»é™¤ ${orphanCount} ç­†å¼•ç”¨æ­¤å®¢æˆ¶çš„é å®šæ¸…å–®ï¼Ÿ`)) {
                            // ç§»é™¤æ‰€æœ‰é—œè¯çš„ç¨…é …è³‡æ–™
                            Object.keys(vatData).forEach(key => {
                                if (vatData[key].rows) {
                                    vatData[key].rows = vatData[key].rows.filter(r => r.customer_id !== id);
                                }
                            });
                            localStorage.setItem('vatData', JSON.stringify(vatData));
                        }
                    }

                    customers.splice(i, 1);
                    saveCustomersToStorage();
                    renderAll();
                    showToast('å®¢æˆ¶è³‡æ–™å·²åˆªé™¤');
                }
            }

            // JSON ä¸‹è¼‰å‡½å¼
            function downloadJSON(filename, data) {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- EVENT HANDLERS --- //
            const showPage = (pageId) => {
                // ä¿å­˜ç•¶å‰ç‹€æ…‹
                uiState.activeTab = pageId;

                ['page-list', 'page-form', 'page-notes', 'page-vat'].forEach(p => doc(p).classList.remove('active'));
                ['tab-list', 'tab-form', 'tab-notes', 'tab-vat'].forEach(t => doc(t).classList.remove('active'));
                doc(pageId).classList.add('active');
                doc(pageId.replace('page', 'tab')).classList.add('active');

                if (pageId === 'page-form') {
                    ui.formContainer.style.display = 'block';
                }

                console.log('=== é é¢åˆ‡æ›å®Œæˆ ===', pageId);
            };
            ui.tabList.addEventListener('click', () => showPage('page-list'));
            ui.tabForm.addEventListener('click', () => renderFormPage());
            ui.tabNotes.addEventListener('click', () => showPage('page-notes'));
            doc('tab-vat')?.addEventListener('click', () => { showPage('page-vat'); initVatPage(); });
            ui.clearFilterBtn.addEventListener('click', () => { filterState.selectedTags = []; renderAll(); });

            // --- å‚™è¨» Excel åŒ¯å‡ºåŠŸèƒ½ ---
            doc('export-notes-excel-btn')?.addEventListener('click', () => {
                try {
                    // ç²å–æ‰€æœ‰å‚™è¨»è³‡æ–™
                    const allNotes = customers.flatMap(c =>
                        c.notes.map(note => ({ ...note, customer: c }))
                    );

                    let filteredNotes = allNotes;
                    let exportMode = 'å…¨éƒ¨å‚™è¨»';

                    // å¦‚æœæœ‰æ¨™ç±¤ç¯©é¸ï¼Œå‰‡åªåŒ¯å‡ºç¬¦åˆæ¢ä»¶çš„å‚™è¨»
                    if (filterState.selectedTags.length > 0) {
                        filteredNotes = allNotes.filter(note => {
                            const noteTags = note.tags.map(tag => tag.toLowerCase());
                            if (filterState.logic === 'AND') {
                                return filterState.selectedTags.every(tag => noteTags.includes(tag));
                            } else {
                                return filterState.selectedTags.some(tag => noteTags.includes(tag));
                            }
                        });
                        exportMode = `ç¯©é¸æ¢ä»¶ (${filterState.selectedTags.join(', ')})`;
                    }

                    if (filteredNotes.length === 0) {
                        showToast('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å‚™è¨»è³‡æ–™å¯åŒ¯å‡º', 'error');
                        return;
                    }

                    // æº–å‚™Excelè³‡æ–™
                    const excelData = [];

                    // æ¨™é¡Œè¡Œ
                    excelData.push([
                        'å®¢æˆ¶ä»£è™Ÿ', 'å…¬å¸åç¨±', 'è¯çµ¡äºº', 'é›»è©±', 'å‚™è¨»æ—¥æœŸ', 'å‚™è¨»å…§å®¹', 'æ¨™ç±¤', 'çµ±ä¸€ç·¨è™Ÿ', 'è¨­ç±åœ°å€'
                    ]);

                    // è³‡æ–™è¡Œ
                    filteredNotes.forEach(note => {
                        const customer = note.customer;
                        excelData.push([
                            customer.id || '',
                            customer.companyName || '',
                            customer.contact || '',
                            customer.phone || '',
                            note.createdAt || '',
                            note.content || '',
                            note.tags ? note.tags.join(', ') : '',
                            customer.taxId || '',
                            customer.regAddr || ''
                        ]);
                    });

                    // å‰µå»ºå·¥ä½œç°¿
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);

                    // è¨­å®šæ¬„ä½å¯¬åº¦
                    ws['!cols'] = [
                        { width: 12 }, // å®¢æˆ¶ä»£è™Ÿ
                        { width: 20 }, // å…¬å¸åç¨±
                        { width: 12 }, // è¯çµ¡äºº
                        { width: 15 }, // é›»è©±
                        { width: 12 }, // å‚™è¨»æ—¥æœŸ
                        { width: 50 }, // å‚™è¨»å…§å®¹
                        { width: 20 }, // æ¨™ç±¤
                        { width: 12 }, // çµ±ä¸€ç·¨è™Ÿ
                        { width: 30 }  // è¨­ç±åœ°å€
                    ];

                    // è¨­å®šæ¨™é¡Œè¡Œæ¨£å¼
                    const headerStyle = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "D4AF37" } },
                        alignment: { horizontal: "center" }
                    };

                    // æ‡‰ç”¨æ¨™é¡Œæ¨£å¼
                    for (let col = 0; col < 9; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }

                    // æ·»åŠ å·¥ä½œè¡¨
                    XLSX.utils.book_append_sheet(wb, ws, "å®¢æˆ¶å‚™è¨»");

                    // åŒ¯å‡ºæª”æ¡ˆ
                    const today = new Date().toISOString().split('T')[0];
                    const fileName = `å®¢æˆ¶å‚™è¨»_${exportMode.replace(/[^\w\s]/gi, '')}_${today}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    showToast(`âœ… å·²åŒ¯å‡º ${filteredNotes.length} ç­†å‚™è¨»è³‡æ–™`);

                } catch (error) {
                    console.error('å‚™è¨»ExcelåŒ¯å‡ºå¤±æ•—:', error);
                    showToast('å‚™è¨»ExcelåŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ”¯æ´', 'error');
                }
            });

            ui.customerBody.addEventListener('click', async e => {
                const row = e.target.closest('tr');
                if (!row) return;
                const id = row.dataset.id;
                if (e.target.classList.contains('btn-edit')) {
                    const customer = customers.find(c => c.id === id);
                    if (customer) renderFormPage(customer);
                } else if (e.target.classList.contains('btn-delete')) {
                    await deleteCustomer(id);
                } else if (e.target.classList.contains('btn-view-notes')) {
                    const customer = customers.find(c => c.id === id);
                    if (!customer) return;
                    filterState.selectedTags = [...new Set(customer.notes.flatMap(n => n.tags.map(normalizeTag)))];
                    filterState.logic = 'OR';
                    showPage('page-notes');
                    renderAll();
                }
            });

            ui.notesList.addEventListener('click', e => {
                if (e.target.classList.contains('btn-edit-from-note')) {
                    e.preventDefault();
                    const customer = customers.find(c => c.id === e.target.dataset.id);
                    if (customer) renderFormPage(customer);
                }
            });

            ui.tagFilterBar.addEventListener('click', e => { if (e.target.classList.contains('tag-item')) { const tag = e.target.dataset.tag; const index = filterState.selectedTags.indexOf(tag); if (index > -1) filterState.selectedTags.splice(index, 1); else filterState.selectedTags.push(tag); renderAll(); } });
            ui.filterLogicSwitcher.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { filterState.logic = e.target.dataset.logic; ui.filterLogicSwitcher.querySelectorAll('button').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); renderAll(); } });

            // è¡¨å–®æäº¤è™•ç†å‡½æ•¸
            const handleFormSubmit = (e) => {
                // ç¬¬ä¸€è¡ŒåŸ·è¡Œé˜²å‘†
                e.preventDefault();
                e.stopPropagation();

                console.log('=== è¡¨å–®æäº¤äº‹ä»¶è§¸ç™¼ ===');
                console.log('äº‹ä»¶ç›®æ¨™:', e.target);
                console.log('ç•¶å‰ç·¨è¼¯ID:', currentlyEditingId);

                // ç›´æ¥å¾è¡¨å–®å…ƒç´ æ”¶é›†è³‡æ–™
                const form = e.target;
                const formData = {
                    id: form.querySelector('#id')?.value?.trim() || '',
                    companyName: form.querySelector('#companyName')?.value?.trim() || '',
                    taxId: form.querySelector('#taxId')?.value?.trim() || '',
                    taxAddr: form.querySelector('#taxAddr')?.value?.trim() || '',
                    contact: form.querySelector('#contact')?.value?.trim() || '',
                    phone: form.querySelector('#phone')?.value?.trim() || '',
                    regAddr: form.querySelector('#regAddr')?.value?.trim() || '',
                    contactAddr: form.querySelector('#contactAddr')?.value?.trim() || '',
                    leaseStart: form.querySelector('#leaseStart')?.value?.trim() || '',
                    leaseEnd: form.querySelector('#leaseEnd')?.value?.trim() || ''
                };

                console.log('æ”¶é›†åˆ°çš„è¡¨å–®è³‡æ–™:', formData);

                // åŸºæœ¬é©—è­‰
                if (!formData.companyName && !formData.id) {
                    showToast('ã€Œç”¨æˆ¶ä»£è™Ÿã€å’Œã€Œå…¬å¸åç¨±ã€è‡³å°‘éœ€å¡«å¯«ä¸€é …ã€‚', 'error');
                    return false;
                }

                if (currentlyEditingId) {
                    console.log('=== åŸ·è¡Œæ›´æ–°æ“ä½œ ===');
                    const customerIndex = customers.findIndex(c => c.id === currentlyEditingId);
                    console.log('æ‰¾åˆ°å®¢æˆ¶ç´¢å¼•:', customerIndex);

                    if (customerIndex !== -1) {
                        const originalCustomer = { ...customers[customerIndex] };
                        console.log('åŸå§‹å®¢æˆ¶è³‡æ–™:', originalCustomer);

                        // æ•´ç­†è¦†å¯«ï¼šå‰µå»ºå…¨æ–°ç‰©ä»¶ï¼Œåˆ‡æ–·èˆŠåƒç…§
                        const newCustomerData = {
                            id: formData.id,
                            companyName: formData.companyName,
                            taxId: formData.taxId,
                            taxAddr: formData.taxAddr,
                            contact: formData.contact,
                            phone: formData.phone,
                            regAddr: formData.regAddr,
                            contactAddr: formData.contactAddr,
                            leaseStart: formData.leaseStart,
                            leaseEnd: formData.leaseEnd,
                            notes: originalCustomer.notes || [] // ä¿ç•™å‚™è¨»
                        };

                        // æ•´ç­†æ›¿æ›ï¼Œä¸æ˜¯é€æ¬„ä½ä¿®æ”¹
                        customers[customerIndex] = newCustomerData;

                        // ç«‹å³é©—è­‰æ›´æ–°çµæœ
                        const verifyResult = customers.find(c => c.id === currentlyEditingId);
                        console.log('=== ç«‹å³é©—è­‰æ›´æ–°çµæœ ===');
                        console.log('ç›®æ¨™å®¢æˆ¶ID:', currentlyEditingId);
                        console.log('é©—è­‰çµæœ:', verifyResult);
                        console.log('è¯çµ¡äººæ˜¯å¦å·²æ›´æ–°:', verifyResult?.contact);

                        showToast(`âœ… å®¢æˆ¶è³‡æ–™å·²æ›´æ–°ï¼è¯çµ¡äºº: ${customers[customerIndex].contact}`);

                        // å„²å­˜è³‡æ–™åˆ°æœ¬åœ°å„²å­˜
                        saveCustomersToStorage();

                        // å–®ä¸€è·¯å¾‘ï¼šæ›´æ–°è³‡æ–™ â†’ renderAll() â†’ åˆ‡æ›é é¢
                        console.log('=== é–‹å§‹æ¸²æŸ“æµç¨‹ ===');
                        renderAll();
                        console.log('=== renderAllå®Œæˆï¼Œæº–å‚™åˆ‡æ›é é¢ ===');
                        showPage('page-list');
                        console.log('=== é é¢åˆ‡æ›å®Œæˆï¼Œæ¸…é™¤ç·¨è¼¯ç‹€æ…‹ ===');
                        currentlyEditingId = null;

                    } else {
                        console.error('æ‰¾ä¸åˆ°è¦æ›´æ–°çš„å®¢æˆ¶');
                        showToast('æ‰¾ä¸åˆ°è¦æ›´æ–°çš„å®¢æˆ¶è³‡æ–™ã€‚', 'error');
                    }
                } else {
                    console.log('=== åŸ·è¡Œæ–°å¢æ“ä½œ ===');
                    formData.id = formData.id || `C${Date.now()}`;
                    if (customers.some(c => c.id === formData.id)) {
                        showToast(`å®¢æˆ¶ä»£è™Ÿ "${formData.id}" å·²å­˜åœ¨ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚`, 'error');
                        return false;
                    }
                    formData.notes = [];
                    customers.push(formData);
                    showToast('å®¢æˆ¶è³‡æ–™å·²æˆåŠŸæ–°å¢ï¼');

                    // å„²å­˜è³‡æ–™åˆ°æœ¬åœ°å„²å­˜
                    saveCustomersToStorage();

                    renderAll();
                    showPage('page-list');
                }

                // é›™é‡é˜²å‘†ï¼šè¿”å›falseé˜»æ­¢é è¨­è¡Œç‚º
                return false;
            };

            ui.formContainer.addEventListener('click', e => {
                // Handle cancel button
                if (e.target.id === 'cancel-form-btn') {
                    if (currentlyEditingId) {
                        const confirmCancel = confirm('ç¢ºå®šè¦å–æ¶ˆç·¨è¼¯å—ï¼Ÿæœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚');
                        if (!confirmCancel) return;
                    }
                    currentlyEditingId = null;
                    showPage('page-list');
                    showToast('å·²å–æ¶ˆç·¨è¼¯æ“ä½œ');
                    return;
                }

                const customer = customers.find(c => c.id === currentlyEditingId);
                if (!customer) return;

                // --- Save/Update Note --- 
                if (e.target.id === 'add-note-btn') {
                    const content = doc('new-note-content').value.trim();
                    if (!content) return alert('å‚™è¨»å…§å®¹ä¸å¯ç‚ºç©ºã€‚');
                    const tags = newNoteTags;

                    if (currentlyEditingNoteId) {
                        const note = customer.notes.find(n => n.id === currentlyEditingNoteId);
                        if (note) { note.content = content; note.tags = tags; }
                    } else {
                        customer.notes.push({ id: `N${Date.now()}`, content, tags, createdAt: new Date().toISOString().split('T')[0] });
                    }
                    currentlyEditingNoteId = null;
                    newNoteTags = [];
                    doc('new-note-content').value = '';
                    doc('new-note-tags').innerHTML = '';
                    doc('add-note-btn').textContent = 'å„²å­˜æ–°å‚™è¨»';

                    // å„²å­˜è³‡æ–™åˆ°æœ¬åœ°å„²å­˜
                    saveCustomersToStorage();
                    showToast('å‚™è¨»å·²å„²å­˜');

                    renderFormPage(customer); // Re-render only the form page
                } else if (e.target.classList.contains('btn-delete-note')) {
                    const noteId = e.target.dataset.noteId;
                    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å‚™è¨»å—ï¼Ÿ')) {
                        customer.notes = customer.notes.filter(n => n.id !== noteId);

                        // å„²å­˜è³‡æ–™åˆ°æœ¬åœ°å„²å­˜
                        saveCustomersToStorage();
                        showToast('å‚™è¨»å·²åˆªé™¤');

                        renderFormPage(customer);
                    }
                } else if (e.target.classList.contains('btn-edit-note')) {
                    const noteId = e.target.dataset.noteId;
                    const note = customer.notes.find(n => n.id === noteId);
                    if (note) {
                        currentlyEditingNoteId = noteId;
                        newNoteTags = [...note.tags];
                        doc('new-note-content').value = note.content;
                        doc('new-note-tags').innerHTML = newNoteTags.map(t => `<span class="tag-item" style="background-color: ${getTagColor(t)};" data-tag="${t}">${t} <button class="tag-delete-btn" data-tag="${t}">&times;</button></span>`).join('');
                        doc('add-note-btn').textContent = 'æ›´æ–°å‚™è¨»';
                        doc('new-note-content').focus();
                    }
                } else if (e.target.classList.contains('tag-delete-btn')) {
                    const tagToRemove = e.target.dataset.tag;
                    newNoteTags = newNoteTags.filter(t => t !== tagToRemove);
                    e.target.parentElement.remove();
                }
            });

            ui.formContainer.addEventListener('keydown', e => {
                if (e.key === 'Enter' && e.target.id === 'new-note-tag-input') {
                    e.preventDefault();
                    const newTag = normalizeTag(e.target.value);
                    if (!newTag) return;
                    if (!newNoteTags.includes(newTag)) {
                        newNoteTags.push(newTag);
                        doc('new-note-tags').innerHTML += `<span class="tag-item" style="background-color: ${getTagColor(newTag)};" data-tag="${newTag}">${newTag} <button class="tag-delete-btn" data-tag="${newTag}">&times;</button></span>`;
                    }
                    e.target.value = '';
                }
            });

            // --- Lease Reminder Event Handlers --- 
            ui.expiringCustomersList.addEventListener('click', async e => {
                if (e.target.classList.contains('btn-quick-edit')) {
                    const customerId = e.target.dataset.id;
                    const customer = customers.find(c => c.id === customerId);
                    if (customer) {
                        renderFormPage(customer);
                    }
                } else if (e.target.classList.contains('btn-mark-renewed')) {
                    const customerId = e.target.dataset.id;
                    const customer = customers.find(c => c.id === customerId);
                    if (customer) {
                        const newEndDate = prompt('è«‹è¼¸å…¥æ–°çš„ç§Ÿç´„åˆ°æœŸæ—¥ (YYYY-MM-DD):', customer.leaseEnd);
                        if (newEndDate && /^\d{4}-\d{2}-\d{2}$/.test(newEndDate)) {
                            customer.leaseEnd = newEndDate;

                            // å„²å­˜è³‡æ–™åˆ°æœ¬åœ°å„²å­˜
                            saveCustomersToStorage();

                            showToast(`${customer.companyName} çš„ç§Ÿç´„å·²æ›´æ–°è‡³ ${toROCDate(newEndDate)}`);
                            renderAll();
                        } else if (newEndDate) {
                            showToast('æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ YYYY-MM-DD æ ¼å¼', 'error');
                        }
                    }
                } else if (e.target.classList.contains('btn-copy-reminder')) {
                    const customerId = e.target.dataset.id;
                    const customer = customers.find(c => c.id === customerId);

                    if (!customer) {
                        showToast('å®¢æˆ¶è³‡æ–™ä¸å­˜åœ¨ã€‚', 'error');
                        return;
                    }

                    // Handle empty or invalid leaseEnd
                    if (!customer.leaseEnd || isNaN(new Date(customer.leaseEnd))) {
                        showToast('ç¼ºå°‘ç§Ÿç´„è¿„æ—¥æ—¥æœŸï¼Œç„¡æ³•è¤‡è£½æé†’ã€‚', 'error');
                        return;
                    }

                    const contactName = customer.contact || 'è²´å…¬å¸';
                    const companyName = customer.companyName || 'è³‡æ–™å¾…è£œ';
                    const regAddr = customer.regAddr ? `ä½æ–¼${customer.regAddr}` : '';
                    const leaseEndDate = toROCDate(customer.leaseEnd);

                    const reminderText = `${contactName} æ‚¨å¥½ï¼š\n\nç‰¹æ­¤æé†’ï¼Œ${companyName}ç›®å‰æ‰¿ç§Ÿ${regAddr}ï¼Œç§Ÿè³ƒåˆç´„å°‡æ–¼${leaseEndDate}åˆ°æœŸã€‚\n\nå†éº»ç…©æä¾›æ–°çš„ç§Ÿè³ƒåˆç´„\n\nè¬è¬æ‚¨`;

                    try {
                        await navigator.clipboard.writeText(reminderText);
                        showToast(`å·²è¤‡è£½æé†’çµ¦ï¼š${contactName} / ${companyName}`);
                    } catch (err) {
                        console.error('è¤‡è£½å¤±æ•—: ', err);
                        showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½', 'error');
                    }
                } else {
                    const listItem = e.target.closest('li');
                    if (listItem) {
                        const customerId = listItem.dataset.id;
                        const customer = customers.find(c => c.id === customerId);
                        if (customer) {
                            populateReminderCard(customer);
                        }
                    }
                }
            });

            ui.copyReminderBtn.addEventListener('click', () => {
                const textToCopy = ui.reminderTextDisplay.textContent;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    ui.copyReminderBtn.textContent = 'å·²è¤‡è£½!';
                    setTimeout(() => { ui.copyReminderBtn.textContent = 'è¤‡è£½æé†’èª'; }, 2000);
                    showToast('æé†’èªå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼'); // æ–°å¢ Toast æç¤º
                }).catch(err => {
                    console.error('è¤‡è£½å¤±æ•—: ', err);
                    showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½', 'error'); // æä¾›ä½¿ç”¨è€…å›é¥‹
                });
            });

            ui.exportExpiringCsvBtn.addEventListener('click', handleExportExpiringCsv);

            // --- è³‡æ–™ç®¡ç†åŠŸèƒ½ ---
            doc('export-all-data-btn')?.addEventListener('click', () => {
                try {
                    const dataStr = JSON.stringify(customers, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `å®¢æˆ¶è³‡æ–™å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('è³‡æ–™å·²åŒ¯å‡º');
                } catch (error) {
                    console.error('åŒ¯å‡ºå¤±æ•—:', error);
                    showToast('åŒ¯å‡ºå¤±æ•—', 'error');
                }
            });

            doc('import-data-btn')?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (Array.isArray(importedData)) {
                                    if (confirm('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚')) {
                                        customers = importedData;
                                        saveCustomersToStorage();
                                        renderAll();
                                        showToast(`å·²åŒ¯å…¥ ${customers.length} ç­†å®¢æˆ¶è³‡æ–™`);
                                    }
                                } else {
                                    showToast('æª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error');
                                }
                            } catch (error) {
                                console.error('åŒ¯å…¥å¤±æ•—:', error);
                                showToast('åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            });

            doc('clear-data-btn')?.addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                    if (confirm('æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦æ¸…é™¤æ‰€æœ‰å®¢æˆ¶è³‡æ–™å—ï¼Ÿ')) {
                        customers = [];
                        localStorage.removeItem(STORAGE_KEY);
                        renderAll();
                        showToast('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤');
                    }
                }
            });

            // é‚„åŸå‚™ä»½æŒ‰éˆ•
            doc('restore-backup-btn')?.addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦é‚„åŸå‚™ä»½è³‡æ–™å—ï¼Ÿé€™å°‡è¦†è“‹ç›®å‰çš„è³‡æ–™ã€‚')) {
                    const backupData = loadBackupData();
                    if (backupData) {
                        customers = backupData;
                        saveCustomersToStorage();
                        renderAll();
                        showToast('å‚™ä»½è³‡æ–™å·²é‚„åŸ');
                    } else {
                        showToast('æ²’æœ‰æ‰¾åˆ°å‚™ä»½è³‡æ–™', 'error');
                    }
                }
            });

            // ç«‹å³å‚™ä»½æŒ‰éˆ•
            doc('auto-backup-btn')?.addEventListener('click', () => {
                createAutoBackup();
            });

            // --- Excel åŒ¯å‡ºç¯„æœ¬åŠŸèƒ½ ---
            doc('export-excel-template-btn')?.addEventListener('click', () => {
                try {
                    // æº–å‚™Excelè³‡æ–™ï¼ŒåŒ…å«ç¾æœ‰å®¢æˆ¶è³‡æ–™å’Œç©ºç™½ç¯„æœ¬è¡Œ
                    const excelData = [];

                    // æ¨™é¡Œè¡Œ
                    excelData.push([
                        'å®¢æˆ¶ä»£è™Ÿ', 'å…¬å¸åç¨±', 'çµ±ä¸€ç·¨è™Ÿ', 'ç¨…ç±ç·¨è™Ÿ', 'è¯çµ¡äºº', 'é›»è©±',
                        'è¨­ç±åœ°å€', 'è¯çµ¡åœ°å€', 'ç§Ÿç´„èµ·æ—¥', 'ç§Ÿç´„è¿„æ—¥', 'å‚™è¨»'
                    ]);

                    // ç¾æœ‰å®¢æˆ¶è³‡æ–™
                    customers.forEach(c => {
                        const notesText = c.notes ? c.notes.map(n => `${n.createdAt}: ${n.content}`).join('; ') : '';
                        excelData.push([
                            c.id || '',
                            c.companyName || '',
                            c.taxId || '',
                            c.taxAddr || '',
                            c.contact || '',
                            c.phone || '',
                            c.regAddr || '',
                            c.contactAddr || '',
                            c.leaseStart || '',
                            c.leaseEnd || '',
                            notesText
                        ]);
                    });

                    // æ·»åŠ 5è¡Œç©ºç™½ç¯„æœ¬ä¾›æ–°å¢ä½¿ç”¨
                    for (let i = 0; i < 5; i++) {
                        excelData.push(['', '', '', '', '', '', '', '', '', '', '']);
                    }

                    // å‰µå»ºå·¥ä½œç°¿
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);

                    // è¨­å®šæ¬„ä½å¯¬åº¦
                    ws['!cols'] = [
                        { width: 12 }, // å®¢æˆ¶ä»£è™Ÿ
                        { width: 20 }, // å…¬å¸åç¨±
                        { width: 12 }, // çµ±ä¸€ç·¨è™Ÿ
                        { width: 15 }, // ç¨…ç±ç·¨è™Ÿ
                        { width: 12 }, // è¯çµ¡äºº
                        { width: 15 }, // é›»è©±
                        { width: 30 }, // è¨­ç±åœ°å€
                        { width: 30 }, // è¯çµ¡åœ°å€
                        { width: 12 }, // ç§Ÿç´„èµ·æ—¥
                        { width: 12 }, // ç§Ÿç´„è¿„æ—¥
                        { width: 40 }  // å‚™è¨»
                    ];

                    // è¨­å®šæ¨™é¡Œè¡Œæ¨£å¼
                    const headerStyle = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "D4AF37" } },
                        alignment: { horizontal: "center" }
                    };

                    // æ‡‰ç”¨æ¨™é¡Œæ¨£å¼
                    for (let col = 0; col < 11; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }

                    XLSX.utils.book_append_sheet(wb, ws, "å®¢æˆ¶è³‡æ–™");

                    // åŒ¯å‡ºæª”æ¡ˆ
                    const fileName = `å®¢æˆ¶è³‡æ–™ç¯„æœ¬_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    showToast(`Excelç¯„æœ¬å·²åŒ¯å‡ºï¼š${fileName}`);
                } catch (error) {
                    console.error('ExcelåŒ¯å‡ºå¤±æ•—:', error);
                    showToast('ExcelåŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ”¯æ´', 'error');
                }
            });

            // --- Excel åŒ¯å…¥åŠŸèƒ½ ---
            doc('import-excel-btn')?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const sheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[sheetName];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                                if (jsonData.length < 2) {
                                    showToast('Excelæª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ç„¡è³‡æ–™', 'error');
                                    return;
                                }

                                // æª¢æŸ¥æ¨™é¡Œè¡Œ
                                const headers = jsonData[0];
                                const expectedHeaders = ['å®¢æˆ¶ä»£è™Ÿ', 'å…¬å¸åç¨±', 'çµ±ä¸€ç·¨è™Ÿ', 'ç¨…ç±ç·¨è™Ÿ', 'è¯çµ¡äºº', 'é›»è©±', 'è¨­ç±åœ°å€', 'è¯çµ¡åœ°å€', 'ç§Ÿç´„èµ·æ—¥', 'ç§Ÿç´„è¿„æ—¥', 'å‚™è¨»'];

                                const isValidFormat = expectedHeaders.every((header, index) =>
                                    headers[index] && headers[index].toString().trim() === header
                                );

                                if (!isValidFormat) {
                                    showToast('Excelæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ä½¿ç”¨åŒ¯å‡ºçš„ç¯„æœ¬æ ¼å¼', 'error');
                                    return;
                                }

                                // æª¢æŸ¥å¿…è¦æ¬„ä½
                                const required = ["å®¢æˆ¶ä»£è™Ÿ", "å…¬å¸åç¨±"];
                                for (const k of required) {
                                    if (!headers.includes(k)) {
                                        alert(`Excel ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š${k}`);
                                        return;
                                    }
                                }

                                // è§£æè³‡æ–™è¡Œ
                                const importedCustomers = [];
                                let created = 0, updated = 0;

                                for (let i = 1; i < jsonData.length; i++) {
                                    const row = jsonData[i];

                                    // è·³éç©ºè¡Œ
                                    if (!row || row.every(cell => !cell || cell.toString().trim() === '')) {
                                        continue;
                                    }

                                    const customerId = row[0] ? row[0].toString().trim() : `C${Date.now()}_${i}`;
                                    const existingCustomer = customers.find(c => c.id === customerId);

                                    const customer = {
                                        id: customerId,
                                        companyName: row[1] ? row[1].toString().trim() : '',
                                        taxId: row[2] ? row[2].toString().trim() : '',
                                        taxAddr: row[3] ? row[3].toString().trim() : '',
                                        contact: row[4] ? row[4].toString().trim() : '',
                                        phone: row[5] ? row[5].toString().trim() : '',
                                        regAddr: row[6] ? row[6].toString().trim() : '',
                                        contactAddr: row[7] ? row[7].toString().trim() : '',
                                        leaseStart: row[8] ? row[8].toString().trim() : '',
                                        leaseEnd: row[9] ? row[9].toString().trim() : '',
                                        notes: existingCustomer ? existingCustomer.notes : []
                                    };

                                    if (existingCustomer) {
                                        updated++;
                                    } else {
                                        created++;
                                    }

                                    // è™•ç†å‚™è¨»
                                    if (row[10] && row[10].toString().trim()) {
                                        const notesText = row[10].toString().trim();
                                        // ç°¡å–®è§£æå‚™è¨»æ ¼å¼ï¼šæ—¥æœŸ: å…§å®¹; æ—¥æœŸ: å…§å®¹
                                        const noteEntries = notesText.split(';');
                                        noteEntries.forEach(entry => {
                                            const trimmedEntry = entry.trim();
                                            if (trimmedEntry) {
                                                const colonIndex = trimmedEntry.indexOf(':');
                                                if (colonIndex > 0) {
                                                    const date = trimmedEntry.substring(0, colonIndex).trim();
                                                    const content = trimmedEntry.substring(colonIndex + 1).trim();
                                                    customer.notes.push({
                                                        id: `N${Date.now()}_${Math.random()}`,
                                                        content: content,
                                                        tags: [],
                                                        createdAt: date
                                                    });
                                                } else {
                                                    // æ²’æœ‰æ—¥æœŸæ ¼å¼ï¼Œä½¿ç”¨ä»Šå¤©æ—¥æœŸ
                                                    customer.notes.push({
                                                        id: `N${Date.now()}_${Math.random()}`,
                                                        content: trimmedEntry,
                                                        tags: [],
                                                        createdAt: new Date().toISOString().split('T')[0]
                                                    });
                                                }
                                            }
                                        });
                                    }

                                    // åŸºæœ¬é©—è­‰
                                    if (customer.companyName || customer.id) {
                                        importedCustomers.push(customer);
                                    }
                                }

                                if (importedCustomers.length === 0) {
                                    showToast('Excelæª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„å®¢æˆ¶è³‡æ–™', 'error');
                                    return;
                                }

                                // ç¢ºèªåŒ¯å…¥
                                const confirmMessage = `æ‰¾åˆ° ${importedCustomers.length} ç­†å®¢æˆ¶è³‡æ–™ï¼Œç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ\n\nåŒ¯å…¥æ–¹å¼ï¼š\nâ€¢ ç¢ºå®šï¼šè¦†è“‹ç¾æœ‰è³‡æ–™\nâ€¢ å–æ¶ˆï¼šå–æ¶ˆåŒ¯å…¥`;

                                if (confirm(confirmMessage)) {
                                    customers = importedCustomers;
                                    saveCustomersToStorage();
                                    renderAll();
                                    showToast(`âœ… Excel åŒ¯å…¥å®Œæˆï¼šæ–°å¢ ${created} ç­†ã€è¦†è“‹ ${updated} ç­†`);
                                }

                            } catch (error) {
                                console.error('ExcelåŒ¯å…¥å¤±æ•—:', error);
                                showToast('ExcelåŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼', 'error');
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    }
                };
                input.click();
            });

            // --- æ’åºå’Œç¯©é¸äº‹ä»¶ç›£è½å™¨ - ç›´æ¥ç¶å®šåˆ°selectå…ƒç´  ---
            // å»¶é²ç¶å®šï¼Œç¢ºä¿å…ƒç´ å­˜åœ¨
            setTimeout(() => {
                const sortSelect = doc('expiring-sort-select');
                const filterSelect = doc('expiring-filter-select');

                if (sortSelect) {
                    sortSelect.addEventListener('change', () => {
                        console.log('æ’åºé¸é …è®Šæ›´ï¼Œé‡æ–°æ¸²æŸ“åˆ°æœŸæ¸…å–®');
                        renderExpiringCustomersList();
                    });
                }

                if (filterSelect) {
                    filterSelect.addEventListener('change', () => {
                        console.log('ç¯©é¸é¸é …è®Šæ›´ï¼Œé‡æ–°æ¸²æŸ“åˆ°æœŸæ¸…å–®');
                        renderExpiringCustomersList();
                    });
                }
            }, 100);

            // --- ç‡Ÿæ¥­ç¨…åŠŸèƒ½ ---
            const VAT_STORAGE_KEY = 'offline-crm-vat-data';
            const VAT_BACKUP_KEY = 'offline-crm-vat-backup';
            const VAT_SETTINGS_KEY = 'offline-crm-vat-settings';
            
            let currentVatData = null;
            let vatHistory = [];
            // è¼‰å…¥æ”¶å–æ–¹å¼ï¼ˆå„ªå…ˆå¾æœ¬åœ°å„²å­˜è¼‰å…¥ï¼‰
            const loadCollectMethods = () => {
                try {
                    const stored = localStorage.getItem('offline-crm-collect-methods');
                    if (stored) {
                        const methods = JSON.parse(stored);
                        if (Array.isArray(methods) && methods.length > 0) {
                            return methods;
                        }
                    }
                } catch (error) {
                    console.error('è¼‰å…¥æ”¶å–æ–¹å¼å¤±æ•—:', error);
                }
                return ['å¿«é', 'è‡ªå·±å¯„é€', 'è¦ªæ”¶']; // é è¨­å€¼
            };

            // å„²å­˜æ”¶å–æ–¹å¼åˆ°æœ¬åœ°å„²å­˜
            const saveCollectMethods = () => {
                try {
                    localStorage.setItem('offline-crm-collect-methods', JSON.stringify(collectMethods));
                    console.log('æ”¶å–æ–¹å¼å·²å„²å­˜:', collectMethods);
                } catch (error) {
                    console.error('å„²å­˜æ”¶å–æ–¹å¼å¤±æ•—:', error);
                }
            };

            let collectMethods = loadCollectMethods();

            // ç‡Ÿæ¥­ç¨…è³‡æ–™çµæ§‹
            const createVatPeriodSheet = (year, period) => ({
                year: year,
                period: period,
                last_collect_deadline: '',
                rows: [],
                history: [],
                collectMethods: [...collectMethods], // åŒ…å«æ”¶å–æ–¹å¼
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            });

            // å„²å­˜ç‡Ÿæ¥­ç¨…è³‡æ–™ï¼ˆå¢å¼·ç‰ˆï¼‰
            const saveVatData = () => {
                try {
                    // å»ºç«‹å‚™ä»½
                    const currentVatStorage = localStorage.getItem(VAT_STORAGE_KEY);
                    if (currentVatStorage) {
                        const backupData = {
                            data: currentVatStorage,
                            timestamp: new Date().toISOString(),
                            version: Date.now()
                        };
                        localStorage.setItem(VAT_BACKUP_KEY, JSON.stringify(backupData));
                    }

                    // å„²å­˜æ–°è³‡æ–™
                    const allVatData = JSON.parse(localStorage.getItem(VAT_STORAGE_KEY) || '{}');
                    const key = `${currentVatData.year}_${currentVatData.period}`;
                    
                    // æ·»åŠ å…ƒè³‡æ–™
                    currentVatData.updated_at = new Date().toISOString();
                    currentVatData.version = Date.now();
                    currentVatData.collectMethods = [...collectMethods]; // ç¢ºä¿æ”¶å–æ–¹å¼è¢«å„²å­˜
                    currentVatData.checksum = generateVatChecksum(currentVatData);
                    
                    allVatData[key] = currentVatData;
                    
                    const dataToSave = {
                        vatData: allVatData,
                        lastModified: new Date().toISOString(),
                        totalPeriods: Object.keys(allVatData).length
                    };
                    
                    localStorage.setItem(VAT_STORAGE_KEY, JSON.stringify(dataToSave));
                    
                    // æ›´æ–°ç‡Ÿæ¥­ç¨…çµ±è¨ˆ
                    updateVatStorageStats();
                    console.log('ç‡Ÿæ¥­ç¨…è³‡æ–™å·²å„²å­˜:', key);
                } catch (error) {
                    console.error('å„²å­˜ç‡Ÿæ¥­ç¨…è³‡æ–™å¤±æ•—:', error);
                    if (error.name === 'QuotaExceededError') {
                        showToast('ç‡Ÿæ¥­ç¨…è³‡æ–™å„²å­˜ç©ºé–“ä¸è¶³ï¼', 'error');
                    } else {
                        showToast('å„²å­˜å¤±æ•—', 'error');
                    }
                }
            };

            // è¼‰å…¥ç‡Ÿæ¥­ç¨…è³‡æ–™ï¼ˆå¢å¼·ç‰ˆï¼‰
            const loadVatData = (year, period) => {
                try {
                    const storedData = localStorage.getItem(VAT_STORAGE_KEY);
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        
                        let allVatData;
                        // æª¢æŸ¥è³‡æ–™æ ¼å¼ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
                        if (parsedData.vatData) {
                            // æ–°æ ¼å¼
                            allVatData = parsedData.vatData;
                        } else {
                            // èˆŠæ ¼å¼ï¼šç›´æ¥æ˜¯ç‡Ÿæ¥­ç¨…è³‡æ–™ç‰©ä»¶
                            allVatData = parsedData;
                        }
                        
                        const key = `${year}_${period}`;
                        const vatData = allVatData[key];
                        
                        if (vatData) {
                            // é©—è­‰è³‡æ–™å®Œæ•´æ€§
                            if (vatData.checksum && !verifyVatChecksum(vatData)) {
                                console.warn('ç‡Ÿæ¥­ç¨…è³‡æ–™æ ¡é©—å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥å‚™ä»½...');
                                return loadVatBackupData(year, period);
                            }
                            
                            // æ¢å¾©æ”¶å–æ–¹å¼ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                            if (vatData.collectMethods && Array.isArray(vatData.collectMethods)) {
                                collectMethods = [...vatData.collectMethods];
                            }
                            
                            return vatData;
                        }
                    }
                    
                    // æ²’æœ‰è³‡æ–™æ™‚å»ºç«‹æ–°çš„
                    return createVatPeriodSheet(year, period);
                } catch (error) {
                    console.error('è¼‰å…¥ç‡Ÿæ¥­ç¨…è³‡æ–™å¤±æ•—:', error);
                    showToast('è¼‰å…¥ç‡Ÿæ¥­ç¨…è³‡æ–™å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥å‚™ä»½...', 'warning');
                    return loadVatBackupData(year, period) || createVatPeriodSheet(year, period);
                }
            };

            // è¼‰å…¥ç‡Ÿæ¥­ç¨…å‚™ä»½è³‡æ–™
            const loadVatBackupData = (year, period) => {
                try {
                    const backupData = localStorage.getItem(VAT_BACKUP_KEY);
                    if (backupData) {
                        const backup = JSON.parse(backupData);
                        const restoredData = JSON.parse(backup.data);
                        
                        let allVatData;
                        if (restoredData.vatData) {
                            allVatData = restoredData.vatData;
                        } else {
                            allVatData = restoredData;
                        }
                        
                        const key = `${year}_${period}`;
                        const vatData = allVatData[key];
                        
                        if (vatData) {
                            // æ¢å¾©æ”¶å–æ–¹å¼ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                            if (vatData.collectMethods && Array.isArray(vatData.collectMethods)) {
                                collectMethods = [...vatData.collectMethods];
                            }
                            
                            showToast(`å·²å¾å‚™ä»½è¼‰å…¥ç‡Ÿæ¥­ç¨…è³‡æ–™ï¼ˆ${new Date(backup.timestamp).toLocaleString()}ï¼‰`, 'success');
                            return vatData;
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('è¼‰å…¥ç‡Ÿæ¥­ç¨…å‚™ä»½è³‡æ–™å¤±æ•—:', error);
                    return null;
                }
            };

            // ç”Ÿæˆç‡Ÿæ¥­ç¨…è³‡æ–™æ ¡é©—ç¢¼
            const generateVatChecksum = (vatData) => {
                const dataForChecksum = {
                    year: vatData.year,
                    period: vatData.period,
                    rows: vatData.rows,
                    last_collect_deadline: vatData.last_collect_deadline
                };
                const str = JSON.stringify(dataForChecksum);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            };

            // é©—è­‰ç‡Ÿæ¥­ç¨…è³‡æ–™æ ¡é©—ç¢¼
            const verifyVatChecksum = (vatData) => {
                if (!vatData.checksum) return true; // èˆŠè³‡æ–™æ²’æœ‰æ ¡é©—ç¢¼ï¼Œè¦–ç‚ºæœ‰æ•ˆ
                const expectedChecksum = generateVatChecksum(vatData);
                return vatData.checksum === expectedChecksum;
            };

            // æ›´æ–°ç‡Ÿæ¥­ç¨…å„²å­˜çµ±è¨ˆ
            const updateVatStorageStats = () => {
                try {
                    const storedData = localStorage.getItem(VAT_STORAGE_KEY);
                    if (storedData) {
                        const size = storedData.length;
                        const parsedData = JSON.parse(storedData);
                        
                        let periodCount = 0;
                        if (parsedData.vatData) {
                            periodCount = Object.keys(parsedData.vatData).length;
                        } else {
                            periodCount = Object.keys(parsedData).length;
                        }
                        
                        // æ›´æ–° UI ä¸­çš„çµ±è¨ˆè³‡è¨Š
                        const statsElement = document.getElementById('vat-storage-stats');
                        if (statsElement) {
                            const sizeKB = Math.round(size / 1024);
                            statsElement.innerHTML = `
                                <span>ç‡Ÿæ¥­ç¨…è³‡æ–™ï¼š${sizeKB}KB</span>
                                <span>æœŸæ•¸ï¼š${periodCount}æœŸ</span>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('æ›´æ–°ç‡Ÿæ¥­ç¨…å„²å­˜çµ±è¨ˆå¤±æ•—:', error);
                }
            };

            // åŒ¯å‡ºç‡Ÿæ¥­ç¨…å‚™ä»½
            const exportVatBackup = () => {
                try {
                    const allVatData = JSON.parse(localStorage.getItem(VAT_STORAGE_KEY) || '{}');
                    const backupData = {
                        vatData: allVatData.vatData || allVatData,
                        exportDate: new Date().toISOString(),
                        version: '2.0',
                        type: 'vat_backup'
                    };
                    
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ç‡Ÿæ¥­ç¨…å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showToast('ç‡Ÿæ¥­ç¨…å‚™ä»½å·²ä¸‹è¼‰', 'success');
                } catch (error) {
                    console.error('åŒ¯å‡ºç‡Ÿæ¥­ç¨…å‚™ä»½å¤±æ•—:', error);
                    showToast('åŒ¯å‡ºå‚™ä»½å¤±æ•—', 'error');
                }
            };

            // å–å¾—å°ç£æ™‚é–“
            const getTaiwanDate = (offset = 0) => {
                const now = new Date();
                const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000)); // UTC+8
                taiwanTime.setDate(taiwanTime.getDate() + offset);
                return taiwanTime;
            };

            // æ ¼å¼åŒ–æ—¥æœŸç‚ºæ°‘åœ‹å¹´
            const formatROCDate = (date, includeWeekday = true) => {
                const year = date.getFullYear() - 1911;
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                const weekday = weekdays[date.getDay()];
                return includeWeekday ? `${year}-${month}-${day}ï¼ˆ${weekday}ï¼‰` : `${year}-${month}-${day}`;
            };

            // å–å¾—ç•¶å‰æœŸæ•¸ï¼ˆæ ¹æ“šæœˆä»½ï¼‰
            const getCurrentPeriod = () => {
                const month = new Date().getMonth() + 1; // 1-12
                return Math.ceil(month / 2);
            };

            // åˆå§‹åŒ–ç‡Ÿæ¥­ç¨…é é¢
            const initVatPage = () => {
                const currentYear = new Date().getFullYear() - 1911; // æ°‘åœ‹å¹´
                const currentPeriod = getCurrentPeriod();

                // è¨­å®šé è¨­å€¼
                doc('vat-year').value = currentYear;
                doc('vat-period').value = currentPeriod;

                // è¼‰å…¥è³‡æ–™
                loadCurrentVatPeriod();

                // æ›´æ–°æ—¥æœŸé¡¯ç¤º
                updateDateDisplays();

                // æ¸²æŸ“æ”¶å–æ–¹å¼é¸é …
                renderCollectMethodCheckboxes();

                // æ¸²æŸ“æé†’åˆ—è¡¨
                renderReminderLists();

                // æ¸²æŸ“æœ¬æœŸè³‡æ–™è¡¨æ ¼
                renderVatDataTable();
            };





            // è¤‡è£½æé†’è©±è¡“
            const copyReminderMessage = (rowId) => {
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) return;

                const customer = customers.find(c => c.id === row.customer_id);
                if (!customer) return;

                const plannedDate = new Date(row.planned_collect_date);
                const year = plannedDate.getFullYear() - 1911;
                const month = (plannedDate.getMonth() + 1).toString().padStart(2, '0');
                const day = plannedDate.getDate().toString().padStart(2, '0');
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekday = weekdays[plannedDate.getDay()];
                const dateStr = `${year}-${month}-${day}ï¼ˆé€±${weekday}ï¼‰`;

                const message = `æé†’æ‚¨ï¼Œæˆ‘å€‘å·²å®‰æ’æ–¼${dateStr}å‰å¾€è²´å…¬å¸æ”¶å–ç™¼ç¥¨è³‡æ–™ã€‚

éº»ç…©æ‚¨å”åŠ©ç¢ºèªä»¥ä¸‹è³‡æ–™æ˜¯å¦å·²å‚™å¦¥ï¼š
âœ… æœ¬æœŸæ‰€æœ‰é€²é …èˆ‡éŠ·é …ç™¼ç¥¨ã€æ†‘è­‰
âœ… ä½œå»¢ç™¼ç¥¨ã€æµ·é—œé€²å£å ±å–®ç­‰å…¶ä»–è­‰æ˜æ–‡ä»¶

è‹¥æœ‰ä»»ä½•è®Šå‹•ï¼Œè«‹ç›¡å¿«å›è¦†å‘ŠçŸ¥ï¼Œè¬è¬ï¼`;

                navigator.clipboard.writeText(message).then(() => {
                    showToast('æé†’è©±è¡“å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                }).catch(() => {
                    showToast('è¤‡è£½å¤±æ•—', 'error');
                });
            };

            // åŠ å…¥åŒ¯å‡ºæ¸…å–®
            const addToExportList = (rowId) => {
                // é€™è£¡å¯ä»¥å¯¦ç¾åŠ å…¥åŒ¯å‡ºæ¸…å–®çš„é‚è¼¯
                showToast('å·²åŠ å…¥åŒ¯å‡ºæ¸…å–®');
            };

            // è¼‰å…¥ç•¶å‰æœŸæ•¸è³‡æ–™
            const loadCurrentVatPeriod = () => {
                const year = parseInt(doc('vat-year').value);
                const period = parseInt(doc('vat-period').value);
                currentVatData = loadVatData(year, period);
                doc('vat-deadline').value = currentVatData.last_collect_deadline;

                // é‡æ–°æ¸²æŸ“æ‰€æœ‰ç›¸é—œçµ„ä»¶
                renderVatDataTable();
                renderReminderLists();
                renderCollectMethodCheckboxes();
                
                // æ›´æ–°ç‡Ÿæ¥­ç¨…å„²å­˜çµ±è¨ˆ
                updateVatStorageStats();

                console.log('=== è¼‰å…¥æœŸæ•¸è³‡æ–™å®Œæˆ ===');
                console.log('å¹´åº¦:', year, 'æœŸæ•¸:', period);
                console.log('æœ¬æœŸè³‡æ–™ç­†æ•¸:', currentVatData.rows.length);
            };

            // æ›´æ–°æ—¥æœŸé¡¯ç¤º
            const updateDateDisplays = () => {
                const today = getTaiwanDate();
                const tomorrow = getTaiwanDate(1);

                doc('today-date').textContent = `ï¼ˆ${formatROCDate(today)}ï¼‰`;

                // è™•ç†é€±äº”çš„ç‰¹æ®Šæƒ…æ³
                if (today.getDay() === 5) { // é€±äº”
                    const saturday = getTaiwanDate(1);
                    const sunday = getTaiwanDate(2);
                    const monday = getTaiwanDate(3);
                    doc('tomorrow-date-range').textContent =
                        `ï¼ˆ${formatROCDate(saturday, false)}ï½${formatROCDate(monday)}ï¼‰`;
                } else {
                    doc('tomorrow-date-range').textContent = `ï¼ˆ${formatROCDate(tomorrow)}ï¼‰`;
                }
            };

            // æ¸²æŸ“æ”¶å–æ–¹å¼é¸é …
            const renderCollectMethodCheckboxes = () => {
                const container = doc('collect-method-checkboxes');
                container.innerHTML = collectMethods.map(method => `
                    <div class="checkbox-item">
                        <input type="checkbox" id="method-${method}" value="${method}" checked>
                        <label for="method-${method}">${method}</label>
                        <button class="btn-small btn-secondary" onclick="removeCollectMethod('${method}')">Ã—</button>
                    </div>
                `).join('');
            };

            // æ–°å¢æ”¶å–æ–¹å¼
            window.addCollectMethod = () => {
                const method = prompt('è«‹è¼¸å…¥æ–°çš„æ”¶å–æ–¹å¼ï¼š');
                if (method && method.trim() && !collectMethods.includes(method.trim())) {
                    collectMethods.push(method.trim());
                    saveCollectMethods(); // å„²å­˜æ”¶å–æ–¹å¼
                    renderCollectMethodCheckboxes();
                    saveVatData(); // ä¹Ÿå„²å­˜åˆ°ç‡Ÿæ¥­ç¨…è³‡æ–™ä¸­
                    showToast(`å·²æ–°å¢æ”¶å–æ–¹å¼ï¼š${method.trim()}`, 'success');
                }
            };

            // ç§»é™¤æ”¶å–æ–¹å¼
            window.removeCollectMethod = (method) => {
                if (confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${method}ã€é€™å€‹æ”¶å–æ–¹å¼å—ï¼Ÿ`)) {
                    collectMethods = collectMethods.filter(m => m !== method);
                    saveCollectMethods(); // å„²å­˜æ”¶å–æ–¹å¼
                    renderCollectMethodCheckboxes();
                    saveVatData(); // ä¹Ÿå„²å­˜åˆ°ç‡Ÿæ¥­ç¨…è³‡æ–™ä¸­
                    showToast(`å·²ç§»é™¤æ”¶å–æ–¹å¼ï¼š${method}`, 'success');
                }
            };

            // æ¸²æŸ“æé†’åˆ—è¡¨
            const renderReminderLists = () => {
                if (!currentVatData || !currentVatData.rows) {
                    doc('today-reminders').innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: 2rem;">è«‹å…ˆè¼‰å…¥æœŸæ•¸è³‡æ–™</div>';
                    doc('tomorrow-reminders').innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: 2rem;">è«‹å…ˆè¼‰å…¥æœŸæ•¸è³‡æ–™</div>';
                    return;
                }

                const today = new Date();
                const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼

                console.log('=== æ¸²æŸ“æé†’åˆ—è¡¨ ===');
                console.log('ä»Šæ—¥æ—¥æœŸ:', todayStr);
                console.log('æœ¬æœŸè³‡æ–™ç­†æ•¸:', currentVatData.rows.length);
                console.log('æœ¬æœŸè³‡æ–™:', currentVatData.rows.map(r => ({ id: r.customer_id, date: r.planned_collect_date })));

                // ä»Šæ—¥æé†’
                const todayReminders = currentVatData.rows.filter(row => {
                    const match = row.planned_collect_date === todayStr;
                    if (match) console.log('ä»Šæ—¥æé†’åŒ¹é…:', row.customer_id, row.planned_collect_date);
                    return match;
                });

                console.log('ä»Šæ—¥æé†’ç­†æ•¸:', todayReminders.length);
                renderReminderList('today-reminders', todayReminders);

                // æ˜æ—¥æé†’ï¼ˆè™•ç†é€±äº”ç‰¹æ®Šæƒ…æ³ï¼‰
                let tomorrowDates = [];
                if (today.getDay() === 5) { // é€±äº”
                    for (let i = 1; i <= 3; i++) {
                        const date = new Date(today);
                        date.setDate(date.getDate() + i);
                        tomorrowDates.push(date.toISOString().split('T')[0]);
                    }
                } else {
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrowDates.push(tomorrow.toISOString().split('T')[0]);
                }

                console.log('æ˜æ—¥æé†’æ—¥æœŸç¯„åœ:', tomorrowDates);

                const tomorrowReminders = currentVatData.rows.filter(row => {
                    const match = tomorrowDates.includes(row.planned_collect_date);
                    if (match) console.log('æ˜æ—¥æé†’åŒ¹é…:', row.customer_id, row.planned_collect_date);
                    return match;
                });

                console.log('æ˜æ—¥æé†’ç­†æ•¸:', tomorrowReminders.length);
                renderReminderList('tomorrow-reminders', tomorrowReminders);
            };

            // æ¸²æŸ“å–®å€‹æé†’åˆ—è¡¨
            const renderReminderList = (containerId, reminders) => {
                const container = doc(containerId);
                if (reminders.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: 2rem;">æœ¬æ¬„ä½ç„¡ç¬¦åˆæ—¥æœŸçš„å®¢æˆ¶</div>';
                    return;
                }

                container.innerHTML = reminders.map(row => {
                    const customer = customers.find(c => c.id === row.customer_id);
                    if (!customer) return '';

                    return `
                        <div class="reminder-card">
                            <div class="reminder-card-header">
                                <div class="reminder-card-info">
                                    <div class="reminder-card-company">${customer.companyName || customer.id}</div>
                                    <div class="reminder-card-details">
                                        è¯çµ¡äººï¼š${customer.contact || 'æœªè¨­å®š'} | 
                                        æ”¶å–æ–¹å¼ï¼š${row.collect_method} | 
                                        é è¨ˆæ”¶å–ï¼š${row.planned_collect_date}
                                        ${row.note_reminder ? `<br>æé†’å‚™è¨»ï¼š${row.note_reminder}` : ''}
                                    </div>
                                </div>
                                <div class="reminder-card-actions">
                                    <button class="btn btn-small btn-secondary" onclick="copyReminderMessage('${row.row_id}')">è¤‡è£½æé†’</button>
                                    <button class="btn btn-small btn-primary" onclick="addToExportList('${row.row_id}')">åŠ å…¥åŒ¯å‡º</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            // è¤‡è£½æé†’è©±è¡“
            window.copyReminderMessage = (rowId) => {
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) return;

                const message = generateReminderMessage(row);
                navigator.clipboard.writeText(message).then(() => {
                    showToast('æé†’è©±è¡“å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                }).catch(() => {
                    showToast('è¤‡è£½å¤±æ•—', 'error');
                });
            };

            // ç”Ÿæˆæé†’è©±è¡“
            const generateReminderMessage = (row) => {
                const customer = customers.find(c => c.id === row.customer_id);
                const plannedDate = row.planned_collect_date;

                return `æé†’æ‚¨ï¼Œæˆ‘å€‘å·²å®‰æ’æ–¼ã€${plannedDate}ã€‘å‰å¾€è²´å…¬å¸æ”¶å–ç™¼ç¥¨è³‡æ–™ã€‚

éº»ç…©æ‚¨å”åŠ©ç¢ºèªä»¥ä¸‹è³‡æ–™æ˜¯å¦å·²å‚™å¦¥ï¼š
âœ… æœ¬æœŸæ‰€æœ‰é€²é …èˆ‡éŠ·é …ç™¼ç¥¨ã€æ†‘è­‰
âœ… ä½œå»¢ç™¼ç¥¨ã€æµ·é—œé€²å£å ±å–®ç­‰å…¶ä»–è­‰æ˜æ–‡ä»¶

è‹¥æœ‰ä»»ä½•è®Šå‹•ï¼Œè«‹ç›¡å¿«å›è¦†å‘ŠçŸ¥ï¼Œè¬è¬ï¼`;
            };

            // æ¸²æŸ“æœ¬æœŸè³‡æ–™è¡¨æ ¼
            const renderVatDataTable = () => {
                const tbody = doc('vat-data-tbody');
                if (!currentVatData.rows.length) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">å°šæœªæ–°å¢ä»»ä½•å®¢æˆ¶è³‡æ–™</td></tr>';
                    return;
                }

                tbody.innerHTML = currentVatData.rows.map(row => {
                    const customer = customers.find(c => c.id === row.customer_id);
                    if (!customer) return '';

                    return `
                        <tr data-row-id="${row.row_id}">
                            <td><input type="checkbox" class="row-checkbox" value="${row.row_id}"></td>
                            <td>
                                <div><strong>${customer.companyName || customer.id}</strong></div>
                                <div style="font-size: 0.9rem; color: var(--color-text-secondary);">
                                    ${customer.contact || 'æœªè¨­å®š'} | ${customer.phone || ''}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--color-text-secondary);">
                                    ${customer.regAddr || ''}
                                </div>
                            </td>
                            <td>${row.collect_method}</td>
                            <td>${row.planned_collect_date}</td>
                            <td>${row.note_invoice || ''}</td>
                            <td>${row.note_reminder || ''}</td>
                            <td class="vat-row-actions">
                                <button class="btn btn-small btn-secondary" onclick="editVatRow('${row.row_id}')">ç·¨è¼¯</button>
                                <button class="btn btn-small btn-secondary" onclick="deleteVatRow('${row.row_id}')">åˆªé™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            };

            // ç”¢ç”Ÿæ‰¹æ¬¡è©±è¡“
            const generateBatchMessages = (rows, selectedMethods) => {
                const messages = {};

                selectedMethods.forEach(method => {
                    const methodRows = rows.filter(row => row.collect_method === method);
                    messages[method] = methodRows.map(row => {
                        const customer = customers.find(c => c.id === row.customer_id);
                        if (!customer) return '';

                        const contactName = customer.contact || 'è²´å…¬å¸';
                        const period = currentVatData.period;
                        const periodText = `ç¬¬${period}æœŸ`;
                        const deadline = currentVatData.last_collect_deadline;
                        const deadlineMinus2 = getDateMinus2(deadline);
                        const noteReminder = row.note_reminder ? `\n${row.note_reminder}` : '';

                        if (method === 'è‡ªå·±å¯„é€') {
                            return `${contactName}æ‚¨å¥½ï¼š

æé†’æ‚¨ï¼Œæœ¬æœŸï¼ˆ${periodText}ï¼‰ç‡Ÿæ¥­ç¨…å³å°‡é–‹å§‹ç”³å ±å›‰ï¼

è«‹æ‚¨å‹™å¿…æ–¼${deadlineMinus2}å‰å‚™å¦¥æ‰€æœ‰é€²é …ã€éŠ·é …ç™¼ç¥¨åŠç›¸é—œæ†‘è­‰ï¼ˆå«ä½œå»¢ç™¼ç¥¨ã€é€²å£å ±å–®ç­‰ï¼‰ï¼Œä¸¦æº–å‚™å¥½äº¤ä»˜æœ¬æ‰€ã€‚${noteReminder}

è¬è¬`;
                        } else {
                            return `${contactName}æ‚¨å¥½ï¼š

æé†’æ‚¨ï¼Œæœ¬æœŸï¼ˆ${periodText}ï¼‰ç‡Ÿæ¥­ç¨…å³å°‡é–‹å§‹ç”³å ±å›‰ï¼

è«‹å•${deadlineMinus2}å‰çš„å“ªå€‹æ™‚æ®µéå»è²´å…¬å¸æ”¶å–è³‡æ–™æ¯”è¼ƒæ–¹ä¾¿å‘¢ï¼Ÿ

è«‹æä¾›æ‚¨æ–¹ä¾¿çš„ç¢ºåˆ‡æ—¥æœŸèˆ‡æ™‚é–“ï¼Œæœƒç›¡å¿«ç‚ºæ‚¨å®‰æ’éå»æ”¶å–ã€‚`;
                        }
                    });
                });

                return messages;
            };

            // é¡¯ç¤ºæ‰¹æ¬¡è©±è¡“
            const displayBatchMessages = (messages) => {
                const previewDiv = doc('batch-message-preview');
                let html = '';

                Object.keys(messages).forEach(method => {
                    html += `<div class="message-group">
                        <h4>${method} (${messages[method].length} ç­†)</h4>
                        <div class="message-list">`;

                    messages[method].forEach((message, index) => {
                        if (message.trim()) {
                            html += `<div class="message-item">
                                <div class="message-header">å®¢æˆ¶ ${index + 1}</div>
                                <pre class="message-content">${message}</pre>
                                <button class="btn btn-small btn-secondary copy-message-btn" data-message="${encodeURIComponent(message)}">è¤‡è£½</button>
                            </div>`;
                        }
                    });

                    html += `</div></div>`;
                });

                previewDiv.innerHTML = html;
                previewDiv.style.display = 'block';

                // ç¶å®šè¤‡è£½æŒ‰éˆ•äº‹ä»¶
                previewDiv.querySelectorAll('.copy-message-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const message = decodeURIComponent(e.target.dataset.message);
                        navigator.clipboard.writeText(message).then(() => {
                            showToast('è©±è¡“å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                        }).catch(() => {
                            showToast('è¤‡è£½å¤±æ•—', 'error');
                        });
                    });
                });
            };

            // åŒ¯å‡ºç‡Ÿæ¥­ç¨…è³‡æ–™åˆ°Excel
            const exportVatToExcel = (rows, exportType) => {
                try {
                    const excelData = [];

                    // æ¨™é¡Œè¡Œ
                    excelData.push([
                        'customer_id', 'company_name', 'contact_name', 'registered_address',
                        'collect_method', 'planned_collect_date', 'period', 'year',
                        'last_collect_deadline', 'deadline_minus2', 'note_invoice',
                        'note_reminder', 'message_type', 'message_preview'
                    ]);

                    // è³‡æ–™è¡Œ
                    rows.forEach(row => {
                        const customer = customers.find(c => c.id === row.customer_id);
                        if (!customer) return;

                        const deadline = currentVatData.last_collect_deadline;
                        const deadlineMinus2 = getDateMinus2(deadline);
                        const messageType = row.collect_method === 'è‡ªå·±å¯„é€' ? 'B-è‡ªå·±å¯„é€' : 'B-åˆ°åºœæ”¶å–';

                        // ç”¢ç”Ÿå®Œæ•´è©±è¡“
                        const contactName = customer.contact || 'è²´å…¬å¸';
                        const period = currentVatData.period;
                        const periodText = `ç¬¬${period}æœŸ`;
                        const noteReminder = row.note_reminder ? `\n${row.note_reminder}` : '';

                        let messagePreview = '';
                        if (row.collect_method === 'è‡ªå·±å¯„é€') {
                            messagePreview = `${contactName}æ‚¨å¥½ï¼š\n\næé†’æ‚¨ï¼Œæœ¬æœŸï¼ˆ${periodText}ï¼‰ç‡Ÿæ¥­ç¨…å³å°‡é–‹å§‹ç”³å ±å›‰ï¼\n\nè«‹æ‚¨å‹™å¿…æ–¼${deadlineMinus2}å‰å‚™å¦¥æ‰€æœ‰é€²é …ã€éŠ·é …ç™¼ç¥¨åŠç›¸é—œæ†‘è­‰ï¼ˆå«ä½œå»¢ç™¼ç¥¨ã€é€²å£å ±å–®ç­‰ï¼‰ï¼Œä¸¦æº–å‚™å¥½äº¤ä»˜æœ¬æ‰€ã€‚${noteReminder}\n\nè¬è¬`;
                        } else {
                            messagePreview = `${contactName}æ‚¨å¥½ï¼š\n\næé†’æ‚¨ï¼Œæœ¬æœŸï¼ˆ${periodText}ï¼‰ç‡Ÿæ¥­ç¨…å³å°‡é–‹å§‹ç”³å ±å›‰ï¼\n\nè«‹å•${deadlineMinus2}å‰çš„å“ªå€‹æ™‚æ®µéå»è²´å…¬å¸æ”¶å–è³‡æ–™æ¯”è¼ƒæ–¹ä¾¿å‘¢ï¼Ÿ\n\nè«‹æä¾›æ‚¨æ–¹ä¾¿çš„ç¢ºåˆ‡æ—¥æœŸèˆ‡æ™‚é–“ï¼Œæœƒç›¡å¿«ç‚ºæ‚¨å®‰æ’éå»æ”¶å–ã€‚`;
                        }

                        excelData.push([
                            customer.id,
                            customer.companyName || '',
                            customer.contact || '',
                            customer.regAddr || '',
                            row.collect_method,
                            row.planned_collect_date,
                            `ç¬¬${currentVatData.period}æœŸ`,
                            currentVatData.year + 1911, // è½‰ç‚ºè¥¿å…ƒå¹´
                            deadline,
                            deadlineMinus2,
                            row.note_invoice || '',
                            row.note_reminder || '',
                            messageType,
                            messagePreview
                        ]);
                    });

                    // å‰µå»ºå·¥ä½œç°¿
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);

                    // è¨­å®šæ¬„ä½å¯¬åº¦
                    ws['!cols'] = [
                        { width: 12 }, { width: 20 }, { width: 12 }, { width: 30 },
                        { width: 12 }, { width: 15 }, { width: 10 }, { width: 8 },
                        { width: 15 }, { width: 15 }, { width: 20 }, { width: 20 },
                        { width: 15 }, { width: 50 }
                    ];

                    // å‡çµæ¨™é¡Œè¡Œ
                    ws['!freeze'] = { xSplit: 0, ySplit: 1 };

                    XLSX.utils.book_append_sheet(wb, ws, "Notices");

                    // åŒ¯å‡ºæª”æ¡ˆ
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/[-:]/g, '').slice(0, 13);
                    const fileName = `vat_notice_${timestamp}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                } catch (error) {
                    console.error('ExcelåŒ¯å‡ºå¤±æ•—:', error);
                    showToast('ExcelåŒ¯å‡ºå¤±æ•—', 'error');
                }
            };

            // é¡¯ç¤ºæ–°å¢å®¢æˆ¶å°è©±æ¡†
            const showAddVatRowDialog = () => {
                const customerOptions = customers.map(c =>
                    `<option value="${c.id}">${c.companyName || c.id} (${c.contact || 'æœªè¨­å®š'})</option>`
                ).join('');

                const methodOptions = collectMethods.map(method =>
                    `<option value="${method}">${method}</option>`
                ).join('');

                const dialogHtml = `
                    <div class="modal-overlay" id="add-vat-row-modal">
                        <div class="modal-content">
                            <h3>æ–°å¢å®¢æˆ¶åˆ°æœ¬æœŸè³‡æ–™</h3>
                            <div class="form-group">
                                <label>é¸æ“‡å®¢æˆ¶</label>
                                <select id="new-vat-customer">${customerOptions}</select>
                            </div>
                            <div class="form-group">
                                <label>æ”¶å–ç™¼ç¥¨æ–¹å¼</label>
                                <select id="new-vat-method">${methodOptions}</select>
                            </div>
                            <div class="form-group">
                                <label>é è¨ˆæ”¶å–æ—¥</label>
                                <input type="date" id="new-vat-date">
                            </div>
                            <div class="form-group">
                                <label>å‚™è¨»-ç™¼ç¥¨</label>
                                <input type="text" id="new-vat-note-invoice" placeholder="é¸å¡«">
                            </div>
                            <div class="form-group">
                                <label>å‚™è¨»-æé†’</label>
                                <input type="text" id="new-vat-note-reminder" placeholder="é¸å¡«">
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-primary" onclick="confirmAddVatRow()">ç¢ºå®šæ–°å¢</button>
                                <button class="btn btn-secondary" onclick="closeAddVatRowDialog()">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', dialogHtml);
            };

            // é—œé–‰æ–°å¢å®¢æˆ¶å°è©±æ¡†
            window.closeAddVatRowDialog = () => {
                const modal = doc('add-vat-row-modal');
                if (modal) modal.remove();
            };

            // ç¢ºèªæ–°å¢å®¢æˆ¶
            window.confirmAddVatRow = () => {
                const customerId = doc('new-vat-customer').value;
                const method = doc('new-vat-method').value;
                const date = doc('new-vat-date').value;
                const noteInvoice = doc('new-vat-note-invoice').value;
                const noteReminder = doc('new-vat-note-reminder').value;

                if (!customerId || !method) {
                    showToast('è«‹é¸æ“‡å®¢æˆ¶å’Œæ”¶å–æ–¹å¼', 'error');
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = currentVatData.rows.some(row => row.customer_id === customerId);
                if (exists) {
                    showToast('æ­¤å®¢æˆ¶å·²å­˜åœ¨æ–¼æœ¬æœŸè³‡æ–™ä¸­', 'error');
                    return;
                }

                const newRow = {
                    row_id: `vat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    customer_id: customerId,
                    collect_method: method,
                    planned_collect_date: date,
                    note_invoice: noteInvoice,
                    note_reminder: noteReminder,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                currentVatData.rows.push(newRow);

                // è¨˜éŒ„æ­·å²
                currentVatData.history.push({
                    timestamp: new Date().toISOString(),
                    action: 'æ–°å¢',
                    summary: `æ–°å¢å®¢æˆ¶ ${customers.find(c => c.id === customerId)?.companyName || customerId}`
                });

                saveVatData();
                renderVatDataTable();
                closeAddVatRowDialog();
                showToast('å®¢æˆ¶å·²æ–°å¢åˆ°æœ¬æœŸè³‡æ–™');
            };

            // ç²å–æ—¥æœŸæ¸›2å¤©
            const getDateMinus2 = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                date.setDate(date.getDate() - 2);
                const year = date.getFullYear() - 1911; // æ°‘åœ‹å¹´
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekday = weekdays[date.getDay()];
                return `${year}-${month}-${day}ï¼ˆé€±${weekday}ï¼‰`;
            };

            // ç·¨è¼¯ç‡Ÿæ¥­ç¨…è³‡æ–™è¡Œ
            window.editVatRow = (rowId) => {
                console.log('ç·¨è¼¯ç‡Ÿæ¥­ç¨…è³‡æ–™è¡Œ:', rowId);
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) {
                    showToast('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è³‡æ–™', 'error');
                    return;
                }

                const customer = customers.find(c => c.id === row.customer_id);
                if (!customer) {
                    showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„å®¢æˆ¶è³‡æ–™', 'error');
                    return;
                }

                showEditVatRowDialog(row, customer);
            };

            // é¡¯ç¤ºç·¨è¼¯å®¢æˆ¶å°è©±æ¡†
            const showEditVatRowDialog = (row, customer) => {
                const methodOptions = collectMethods.map(method =>
                    `<option value="${method}" ${method === row.collect_method ? 'selected' : ''}>${method}</option>`
                ).join('');

                const dialogHtml = `
                    <div class="modal-overlay" id="edit-vat-row-modal">
                        <div class="modal-content">
                            <h3>ç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
                            <div class="form-group">
                                <label>å®¢æˆ¶è³‡è¨Š</label>
                                <div style="background: var(--color-surface-light); padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                                    <div><strong>${customer.companyName || customer.id}</strong></div>
                                    <div style="color: var(--color-text-secondary); font-size: 0.9rem;">
                                        ${customer.contact || 'æœªè¨­å®š'} | ${customer.phone || ''}
                                    </div>
                                    <div style="color: var(--color-text-secondary); font-size: 0.8rem;">
                                        ${customer.regAddr || ''}
                                    </div>
                                    <div style="margin-top: 0.5rem;">
                                        <a href="#" onclick="showPage('page-list'); closeEditVatRowDialog();" style="color: var(--color-accent-gold); font-size: 0.8rem;">
                                            â†’ åˆ°å®¢æˆ¶åˆ—è¡¨ç·¨è¼¯åŸºæœ¬è³‡æ–™
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>æ”¶å–ç™¼ç¥¨æ–¹å¼</label>
                                <select id="edit-vat-method">${methodOptions}</select>
                            </div>
                            <div class="form-group">
                                <label>é è¨ˆæ”¶å–æ—¥</label>
                                <input type="date" id="edit-vat-date" value="${row.planned_collect_date || ''}">
                            </div>
                            <div class="form-group">
                                <label>å‚™è¨»-ç™¼ç¥¨</label>
                                <input type="text" id="edit-vat-note-invoice" value="${row.note_invoice || ''}" placeholder="é¸å¡«">
                            </div>
                            <div class="form-group">
                                <label>å‚™è¨»-æé†’</label>
                                <input type="text" id="edit-vat-note-reminder" value="${row.note_reminder || ''}" placeholder="é¸å¡«">
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-primary" onclick="confirmEditVatRow('${row.row_id}')">ç¢ºå®šæ›´æ–°</button>
                                <button class="btn btn-secondary" onclick="closeEditVatRowDialog()">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', dialogHtml);
            };

            // é—œé–‰ç·¨è¼¯å®¢æˆ¶å°è©±æ¡†
            window.closeEditVatRowDialog = () => {
                const modal = doc('edit-vat-row-modal');
                if (modal) modal.remove();
            };

            // ç¢ºèªç·¨è¼¯å®¢æˆ¶
            window.confirmEditVatRow = (rowId) => {
                const method = doc('edit-vat-method').value;
                const date = doc('edit-vat-date').value;
                const noteInvoice = doc('edit-vat-note-invoice').value;
                const noteReminder = doc('edit-vat-note-reminder').value;

                if (!method) {
                    showToast('è«‹é¸æ“‡æ”¶å–æ–¹å¼', 'error');
                    return;
                }

                const rowIndex = currentVatData.rows.findIndex(r => r.row_id === rowId);
                if (rowIndex === -1) {
                    showToast('æ‰¾ä¸åˆ°è¦æ›´æ–°çš„è³‡æ–™', 'error');
                    return;
                }

                // ä¿å­˜åŸå§‹è³‡æ–™ç”¨æ–¼æ­·å²è¨˜éŒ„
                const originalRow = { ...currentVatData.rows[rowIndex] };

                // æ›´æ–°è³‡æ–™
                currentVatData.rows[rowIndex] = {
                    ...currentVatData.rows[rowIndex],
                    collect_method: method,
                    planned_collect_date: date,
                    note_invoice: noteInvoice,
                    note_reminder: noteReminder,
                    updated_at: new Date().toISOString()
                };

                // è¨˜éŒ„æ­·å²
                const customer = customers.find(c => c.id === currentVatData.rows[rowIndex].customer_id);
                const changes = [];
                if (originalRow.collect_method !== method) changes.push(`æ”¶å–æ–¹å¼: ${originalRow.collect_method} â†’ ${method}`);
                if (originalRow.planned_collect_date !== date) changes.push(`é è¨ˆæ”¶å–æ—¥: ${originalRow.planned_collect_date || 'æœªè¨­å®š'} â†’ ${date || 'æœªè¨­å®š'}`);
                if (originalRow.note_invoice !== noteInvoice) changes.push(`å‚™è¨»-ç™¼ç¥¨: ${originalRow.note_invoice || 'ç©º'} â†’ ${noteInvoice || 'ç©º'}`);
                if (originalRow.note_reminder !== noteReminder) changes.push(`å‚™è¨»-æé†’: ${originalRow.note_reminder || 'ç©º'} â†’ ${noteReminder || 'ç©º'}`);

                currentVatData.history.push({
                    timestamp: new Date().toISOString(),
                    action: 'ç·¨è¼¯',
                    summary: `ç·¨è¼¯å®¢æˆ¶ ${customer?.companyName || rowId}${changes.length > 0 ? ': ' + changes.join(', ') : ''}`
                });

                saveVatData();
                renderVatDataTable();
                renderReminderLists(); // é‡æ–°æ¸²æŸ“æé†’åˆ—è¡¨
                closeEditVatRowDialog();
                showToast('å®¢æˆ¶è³‡æ–™å·²æ›´æ–°');
            };

            // åˆªé™¤ç‡Ÿæ¥­ç¨…è³‡æ–™è¡Œ
            window.deleteVatRow = (rowId) => {
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) return;

                const customer = customers.find(c => c.id === row.customer_id);
                const customerName = customer?.companyName || row.customer_id;

                if (confirm(`ç¢ºå®šè¦åˆªé™¤å®¢æˆ¶ã€Œ${customerName}ã€çš„è³‡æ–™å—ï¼Ÿ\n\næ­¤ç­†å°‡è¢«ç§»é™¤ï¼Œå¯åœ¨ç·¨è¼¯ç´€éŒ„å›æœ”å¾©åŸã€‚`)) {
                    currentVatData.rows = currentVatData.rows.filter(r => r.row_id !== rowId);

                    // è¨˜éŒ„æ­·å²
                    currentVatData.history.push({
                        timestamp: new Date().toISOString(),
                        action: 'åˆªé™¤',
                        summary: `åˆªé™¤å®¢æˆ¶ ${customerName}`
                    });

                    saveVatData();
                    renderVatDataTable();
                    showToast('è³‡æ–™å·²åˆªé™¤');
                }
            };

            // --- ç‡Ÿæ¥­ç¨…äº‹ä»¶è™•ç†å™¨ ---
            doc('vat-year')?.addEventListener('change', loadCurrentVatPeriod);
            doc('vat-period')?.addEventListener('change', loadCurrentVatPeriod);
            doc('vat-deadline')?.addEventListener('change', () => {
                if (currentVatData) {
                    currentVatData.last_collect_deadline = doc('vat-deadline').value;
                    saveVatData();
                }
            });

            doc('add-collect-method-btn')?.addEventListener('click', addCollectMethod);

            // è¼‰å…¥ä»–æœŸä½œç‚ºè‰ç¨¿
            doc('load-other-period-btn')?.addEventListener('click', () => {
                console.log('=== è¼‰å…¥ä»–æœŸä½œç‚ºè‰ç¨¿ ===');
                const currentYear = parseInt(doc('vat-year').value);
                const currentPeriod = parseInt(doc('vat-period').value);

                const periodOptions = [
                    { value: 1, text: 'ç¬¬1æœŸ (01-02æœˆ)' },
                    { value: 2, text: 'ç¬¬2æœŸ (03-04æœˆ)' },
                    { value: 3, text: 'ç¬¬3æœŸ (05-06æœˆ)' },
                    { value: 4, text: 'ç¬¬4æœŸ (07-08æœˆ)' },
                    { value: 5, text: 'ç¬¬5æœŸ (09-10æœˆ)' },
                    { value: 6, text: 'ç¬¬6æœŸ (11-12æœˆ)' }
                ];

                const availablePeriods = periodOptions.filter(p => p.value !== currentPeriod);
                const periodList = availablePeriods.map(p => `${p.value}. ${p.text}`).join('\n');

                const selectedPeriod = prompt(`è«‹é¸æ“‡è¦è¼‰å…¥çš„æœŸæ•¸ï¼š\n${periodList}\n\nè«‹è¼¸å…¥æœŸæ•¸ (1-6):`);

                if (selectedPeriod && /^[1-6]$/.test(selectedPeriod)) {
                    const sourcePeriod = parseInt(selectedPeriod);
                    const sourceData = loadVatData(currentYear, sourcePeriod);

                    if (sourceData.rows.length === 0) {
                        showToast(`ç¬¬${sourcePeriod}æœŸæ²’æœ‰è³‡æ–™å¯è¼‰å…¥`, 'error');
                        return;
                    }

                    if (confirm(`ç¢ºå®šè¦è¼‰å…¥ç¬¬${sourcePeriod}æœŸçš„ ${sourceData.rows.length} ç­†è³‡æ–™ä½œç‚ºè‰ç¨¿å—ï¼Ÿ\n\næ³¨æ„ï¼šé€™ä¸æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œè€Œæ˜¯ä½œç‚ºæ–°å¢çš„è‰ç¨¿ã€‚`)) {
                        // è¤‡è£½è³‡æ–™ä½†é‡æ–°ç”ŸæˆIDå’Œæ™‚é–“
                        const draftRows = sourceData.rows.map(row => ({
                            ...row,
                            row_id: `vat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            planned_collect_date: '', // æ¸…ç©ºé è¨ˆæ”¶å–æ—¥ï¼Œéœ€è¦é‡æ–°è¨­å®š
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }));

                        currentVatData.rows.push(...draftRows);
                        saveVatData();
                        renderVatDataTable();
                        showToast(`å·²è¼‰å…¥ ${draftRows.length} ç­†è‰ç¨¿è³‡æ–™`);
                    }
                } else if (selectedPeriod) {
                    showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„æœŸæ•¸ (1-6)', 'error');
                }
            });

            // ç·¨è¼¯ç´€éŒ„
            doc('vat-history-btn')?.addEventListener('click', () => {
                console.log('=== æŸ¥çœ‹ç·¨è¼¯ç´€éŒ„ ===');
                if (!currentVatData || currentVatData.history.length === 0) {
                    showToast('ç›®å‰æ²’æœ‰ç·¨è¼¯ç´€éŒ„');
                    return;
                }

                const historyList = currentVatData.history
                    .slice(-10) // åªé¡¯ç¤ºæœ€è¿‘10ç­†
                    .reverse()
                    .map((entry, index) => {
                        const date = new Date(entry.timestamp).toLocaleString('zh-TW');
                        return `${index + 1}. ${date}\n   ${entry.action}: ${entry.summary}`;
                    })
                    .join('\n\n');

                alert(`ç·¨è¼¯ç´€éŒ„ (æœ€è¿‘10ç­†):\n\n${historyList}`);
            });

            // ä¸€éµç”¢ç”Ÿè©±è¡“
            doc('generate-batch-message-btn')?.addEventListener('click', () => {
                console.log('=== ä¸€éµç”¢ç”Ÿè©±è¡“ ===');
                const selectedMethods = Array.from(document.querySelectorAll('#collect-method-checkboxes input:checked'))
                    .map(cb => cb.value);

                if (selectedMethods.length === 0) {
                    showToast('è«‹å…ˆé¸æ“‡æ”¶å–ç™¼ç¥¨æ–¹å¼', 'error');
                    return;
                }

                const filteredRows = currentVatData.rows.filter(row =>
                    selectedMethods.includes(row.collect_method)
                );

                if (filteredRows.length === 0) {
                    showToast('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å®¢æˆ¶è³‡æ–™', 'error');
                    return;
                }

                const messages = generateBatchMessages(filteredRows, selectedMethods);
                displayBatchMessages(messages);
                showToast(`å·²ç”¢ç”Ÿ ${filteredRows.length} ç­†å®¢æˆ¶çš„è©±è¡“`);
            });

            // åŒ¯å‡ºæ‰¹æ¬¡Excel
            doc('export-batch-excel-btn')?.addEventListener('click', () => {
                console.log('=== åŒ¯å‡ºæ‰¹æ¬¡Excel ===');
                const selectedMethods = Array.from(document.querySelectorAll('#collect-method-checkboxes input:checked'))
                    .map(cb => cb.value);

                if (selectedMethods.length === 0) {
                    showToast('è«‹å…ˆé¸æ“‡æ”¶å–ç™¼ç¥¨æ–¹å¼', 'error');
                    return;
                }

                const filteredRows = currentVatData.rows.filter(row =>
                    selectedMethods.includes(row.collect_method)
                );

                if (filteredRows.length === 0) {
                    showToast('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å®¢æˆ¶è³‡æ–™å¯åŒ¯å‡º', 'error');
                    return;
                }

                exportVatToExcel(filteredRows, `æ‰¹æ¬¡è©±è¡“_${selectedMethods.join('_')}`);
            });

            // æ–°å¢å®¢æˆ¶åˆ°æœ¬æœŸè³‡æ–™
            doc('add-vat-row-btn')?.addEventListener('click', () => {
                console.log('=== æ–°å¢å®¢æˆ¶åˆ°æœ¬æœŸè³‡æ–™ ===');
                showAddVatRowDialog();
            });

            // åŒ¯å‡ºæœ¬æœŸè³‡æ–™
            doc('export-period-data-btn')?.addEventListener('click', () => {
                console.log('=== åŒ¯å‡ºæœ¬æœŸè³‡æ–™ ===');
                if (currentVatData.rows.length === 0) {
                    showToast('æœ¬æœŸæ²’æœ‰è³‡æ–™å¯åŒ¯å‡º', 'error');
                    return;
                }

                const selectedRows = Array.from(document.querySelectorAll('#vat-data-tbody input[type="checkbox"]:checked'))
                    .map(cb => currentVatData.rows.find(row => row.row_id === cb.value))
                    .filter(row => row);

                const exportRows = selectedRows.length > 0 ? selectedRows : currentVatData.rows;
                const exportType = selectedRows.length > 0 ? 'é¸å–è³‡æ–™' : 'å…¨éƒ¨è³‡æ–™';

                exportVatToExcel(exportRows, `æœ¬æœŸè³‡æ–™_${exportType}`);
                showToast(`å·²åŒ¯å‡º ${exportRows.length} ç­†${exportType}`);
            });

            // JSON åŒ¯å‡ºåŠŸèƒ½
            doc('m2-json-export')?.addEventListener('click', () => {
                try {
                    const storedData = localStorage.getItem(VAT_STORAGE_KEY);
                    let vatData = {};
                    
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        // æª¢æŸ¥æ–°èˆŠæ ¼å¼
                        if (parsedData.vatData) {
                            vatData = parsedData.vatData;
                        } else {
                            vatData = parsedData;
                        }
                    }
                    
                    downloadJSON(`vat_data_${Date.now()}.json`, vatData);
                } catch (error) {
                    console.error('JSON åŒ¯å‡ºå¤±æ•—:', error);
                    showToast('JSON åŒ¯å‡ºå¤±æ•—', 'error');
                }
            });

            // ç‡Ÿæ¥­ç¨…å‚™ä»½åŠŸèƒ½
            doc('vat-backup-btn')?.addEventListener('click', () => {
                exportVatBackup();
            });

            // ç‡Ÿæ¥­ç¨…é‚„åŸå‚™ä»½åŠŸèƒ½
            doc('vat-restore-btn')?.addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦é‚„åŸç‡Ÿæ¥­ç¨…å‚™ä»½è³‡æ–™å—ï¼Ÿé€™å°‡è¦†è“‹ç›®å‰çš„è³‡æ–™ã€‚')) {
                    const year = parseInt(doc('vat-year').value);
                    const period = parseInt(doc('vat-period').value);
                    const backupData = loadVatBackupData(year, period);
                    
                    if (backupData) {
                        currentVatData = backupData;
                        saveVatData();
                        renderVatDataTable();
                        renderReminderLists();
                        showToast('ç‡Ÿæ¥­ç¨…å‚™ä»½è³‡æ–™å·²é‚„åŸ');
                    } else {
                        showToast('æ²’æœ‰æ‰¾åˆ°å°æ‡‰æœŸæ•¸çš„å‚™ä»½è³‡æ–™', 'error');
                    }
                }
            });

            // JSON åŒ¯å…¥æŒ‰éˆ•è§¸ç™¼æª”æ¡ˆé¸æ“‡
            doc('m2-json-import-btn')?.addEventListener('click', () => {
                doc('m2-json-in').click();
            });

            // JSON åŒ¯å…¥åŠŸèƒ½
            doc('m2-json-in')?.addEventListener('change', (e) => {
                const f = e.target.files && e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = async () => {
                    try {
                        const obj = JSON.parse(r.result);
                        if (!obj || typeof obj !== 'object') {
                            throw new Error('æ ¼å¼éœ€ç‚ºæœ‰æ•ˆçš„ JSON ç‰©ä»¶');
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°çš„å‚™ä»½æ ¼å¼
                        let vatDataToImport;
                        if (obj.type === 'vat_backup' && obj.vatData) {
                            vatDataToImport = obj.vatData;
                        } else {
                            vatDataToImport = obj;
                        }
                        
                        // ä½¿ç”¨æ–°çš„å„²å­˜æ ¼å¼
                        const dataToSave = {
                            vatData: vatDataToImport,
                            lastModified: new Date().toISOString(),
                            totalPeriods: Object.keys(vatDataToImport).length
                        };
                        
                        localStorage.setItem(VAT_STORAGE_KEY, JSON.stringify(dataToSave));
                        
                        // é‡æ–°è¼‰å…¥ç•¶å‰æœŸæ•¸è³‡æ–™
                        loadCurrentVatPeriod();
                        showToast('ç‡Ÿæ¥­ç¨… JSON åŒ¯å…¥å®Œæˆ', 'success');
                    } catch (err) {
                        console.error('JSON åŒ¯å…¥å¤±æ•—:', err);
                        showToast('JSON è§£æå¤±æ•—ï¼š' + err.message, 'error');
                    }
                };
                r.readAsText(f);
            });

            // --- å®¢æˆ¶åˆ—è¡¨æœå°‹å’ŒåŒ¯å‡ºåŠŸèƒ½ ---
            let filteredCustomers = [...customers]; // æœå°‹å¾Œçš„çµæœ
            let searchTimeout = null;

            // é—œéµå­—æœå°‹åŠŸèƒ½
            const searchCustomers = (keyword) => {
                if (!keyword.trim()) {
                    filteredCustomers = [...customers];
                    updateExportInfo();
                    enhancedRenderCustomerTable();
                    return;
                }

                const searchTerm = keyword.toLowerCase();
                filteredCustomers = customers.filter(customer => {
                    // æœå°‹æ¬„ä½ï¼šå…¬å¸åç¨±ã€è¯çµ¡äººã€åœ°å€ã€Emailã€é›»è©±ã€æ¨™ç±¤
                    const searchFields = [
                        customer.companyName || '',
                        customer.contact || '',
                        customer.regAddr || '',
                        customer.contactAddr || '',
                        customer.email || '',
                        customer.phone || '',
                        customer.taxId || '',
                        customer.taxAddr || '',
                        // æ¨™ç±¤æœå°‹ï¼ˆå¦‚æœæœ‰å‚™è¨»æ¨™ç±¤ï¼‰
                        ...(customer.notes ? customer.notes.flatMap(note => note.tags || []) : [])
                    ];

                    return searchFields.some(field =>
                        field.toLowerCase().includes(searchTerm)
                    );
                });

                console.log(`æœå°‹é—œéµå­—: "${keyword}", æ‰¾åˆ° ${filteredCustomers.length} ç­†çµæœ`);
                updateExportInfo();
                renderFilteredCustomerTable();
            };

            // æ¸²æŸ“ç¯©é¸å¾Œçš„å®¢æˆ¶è¡¨æ ¼
            const renderFilteredCustomerTable = () => {
                const ui = {
                    customerBody: doc('customer-list-body')
                };

                if (filteredCustomers.length === 0) {
                    ui.customerBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--color-text-secondary);">æ²’æœ‰ç¬¦åˆæœå°‹æ¢ä»¶çš„å®¢æˆ¶è³‡æ–™</td></tr>';
                    return;
                }

                ui.customerBody.innerHTML = filteredCustomers.map(c => {
                    const days = getDaysRemaining(c.leaseEnd);
                    const isExpiring = days <= EXPIRE_SOON_DAYS && days > 0;
                    const isExpired = days <= 0;
                    const rowClass = isExpired ? 'expired' : isExpiring ? 'expiring-soon' : '';
                    const leaseEndClass = isExpired ? 'lease-end-cell expired' : isExpiring ? 'lease-end-cell expiring' : 'lease-end-cell';

                    return `<tr data-id="${c.id}" class="${rowClass}">
                        <td>${escapeHTML(c.id)}<br>${escapeHTML(c.companyName)}</td>
                        <td>${escapeHTML(c.contact) || '-'}<br>${escapeHTML(c.phone) || '-'}</td>
                        <td>${escapeHTML(c.taxId) || '-'}<br>${c.taxAddr ? `ç¨…ç±:${escapeHTML(c.taxAddr)}` : '-'}</td>
                        <td>${c.regAddr ? `è¨­ç±:${escapeHTML(c.regAddr)}` : ''}${c.regAddr && c.contactAddr ? '<br>' : ''}${c.contactAddr ? `è¯çµ¡:${escapeHTML(c.contactAddr)}` : ''}</td>
                        <td>${toROCDate(c.leaseStart) || '-'}</td>
                        <td class="${leaseEndClass}">${toROCDate(c.leaseEnd) || '-'}</td>
                        <td class="table-row-actions">
                            <div class="action-buttons-grid">
                                <button type="button" class="btn-action btn-view-notes">æŸ¥çœ‹å‚™è¨»</button>
                                <button type="button" class="btn-action btn-edit">ç·¨è¼¯</button>
                                <button type="button" class="btn-action btn-delete">åˆªé™¤</button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
            };

            // æ›´æ–°åŒ¯å‡ºè³‡è¨Š
            const updateExportInfo = () => {
                const exportInfo = document.querySelector('.export-info');
                const exportBtn = doc('export-customers-excel-btn');

                if (filteredCustomers.length === 0) {
                    if (exportInfo) exportInfo.textContent = 'ç›®å‰ç„¡å¯åŒ¯å‡ºçš„è³‡æ–™';
                    if (exportBtn) {
                        exportBtn.disabled = true;
                        exportBtn.title = 'ç›®å‰ç„¡å¯åŒ¯å‡ºçš„è³‡æ–™';
                    }
                } else {
                    const searchInput = doc('customer-search-input');
                    const hasSearch = searchInput && searchInput.value.trim();
                    const infoText = hasSearch ?
                        `åŒ¯å‡ºï¼šæœå°‹çµæœ (${filteredCustomers.length} ç­†)` :
                        `åŒ¯å‡ºï¼šå…¨éƒ¨å®¢æˆ¶ (${filteredCustomers.length} ç­†)`;

                    if (exportInfo) exportInfo.textContent = infoText;
                    if (exportBtn) {
                        exportBtn.disabled = false;
                        exportBtn.title = '';
                    }
                }
            };

            // åŒ¯å‡ºå®¢æˆ¶Excel
            const exportCustomersToExcel = () => {
                if (filteredCustomers.length === 0) {
                    showToast('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™', 'error');
                    return;
                }

                try {
                    const excelData = [];

                    // æ¨™é¡Œè¡Œ
                    excelData.push([
                        'customer_id', 'company_name', 'contact_name', 'email', 'phone',
                        'registered_address', 'lease_end_date', 'tags'
                    ]);

                    // è³‡æ–™è¡Œ
                    filteredCustomers.forEach(customer => {
                        const tags = customer.notes ?
                            [...new Set(customer.notes.flatMap(note => note.tags || []))]
                                .map(tag => tag.toLowerCase())
                                .join('; ') : '';

                        const leaseEndDate = customer.leaseEnd ?
                            new Date(customer.leaseEnd).toISOString().split('T')[0].replace(/-/g, '/') : '';

                        excelData.push([
                            customer.id || '',
                            customer.companyName || '',
                            customer.contact || '',
                            customer.email || '',
                            customer.phone || '',
                            customer.regAddr || '',
                            leaseEndDate,
                            tags
                        ]);
                    });

                    // å‰µå»ºå·¥ä½œç°¿
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);

                    // è¨­å®šæ¬„ä½å¯¬åº¦
                    ws['!cols'] = [
                        { width: 12 }, // customer_id
                        { width: 25 }, // company_name
                        { width: 15 }, // contact_name
                        { width: 25 }, // email
                        { width: 15 }, // phone
                        { width: 35 }, // registered_address
                        { width: 12 }, // lease_end_date
                        { width: 30 }  // tags
                    ];

                    // å‡çµæ¨™é¡Œè¡Œ
                    ws['!freeze'] = { xSplit: 0, ySplit: 1 };

                    // è¨­å®šæ¨™é¡Œè¡Œæ¨£å¼
                    const headerStyle = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "D4AF37" } },
                        alignment: { horizontal: "center" }
                    };

                    for (let col = 0; col < 8; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }

                    XLSX.utils.book_append_sheet(wb, ws, "Customers");

                    // åŒ¯å‡ºæª”æ¡ˆ
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/[-:]/g, '').slice(0, 13);
                    const fileName = `customers_${timestamp}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    showToast(`âœ… å·²åŒ¯å‡º ${filteredCustomers.length} ç­†å®¢æˆ¶è³‡æ–™`);

                } catch (error) {
                    console.error('ExcelåŒ¯å‡ºå¤±æ•—:', error);
                    showToast('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                }
            };

            // æœå°‹è¼¸å…¥äº‹ä»¶
            doc('customer-search-input')?.addEventListener('input', (e) => {
                const keyword = e.target.value;
                const clearBtn = doc('clear-search-btn');

                // é¡¯ç¤º/éš±è—æ¸…é™¤æŒ‰éˆ•
                if (clearBtn) {
                    clearBtn.style.display = keyword ? 'block' : 'none';
                }

                // Debounceæœå°‹
                if (searchTimeout) clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchCustomers(keyword);
                }, 300);
            });

            // æ¸…é™¤æœå°‹
            doc('clear-search-btn')?.addEventListener('click', () => {
                const searchInput = doc('customer-search-input');
                const clearBtn = doc('clear-search-btn');

                if (searchInput) searchInput.value = '';
                if (clearBtn) clearBtn.style.display = 'none';

                filteredCustomers = [...customers];
                updateExportInfo();
                enhancedRenderCustomerTable();
            });

            // åŒ¯å‡ºExcelæŒ‰éˆ•äº‹ä»¶
            doc('export-customers-excel-btn')?.addEventListener('click', exportCustomersToExcel);

            // å»ºç«‹å¢å¼·ç‰ˆçš„å®¢æˆ¶è¡¨æ ¼æ¸²æŸ“å‡½æ•¸
            const enhancedRenderCustomerTable = () => {
                // å¦‚æœæ²’æœ‰æœå°‹ï¼Œä½¿ç”¨åŸæœ‰é‚è¼¯
                const searchInput = doc('customer-search-input');
                if (!searchInput || !searchInput.value.trim()) {
                    filteredCustomers = [...customers];
                    updateExportInfo();
                }
                
                // ä½¿ç”¨ç¯©é¸å¾Œçš„æ¸²æŸ“é‚è¼¯
                renderFilteredCustomerTable();
            };

            // --- INITIAL RENDER --- 
            console.log('=== ç³»çµ±åˆå§‹åŒ– ===');
            console.log('è¼‰å…¥çš„å®¢æˆ¶è³‡æ–™ç­†æ•¸:', customers.length);

            // åˆå§‹åŒ–å„²å­˜çµ±è¨ˆ
            updateStorageStats();
            updateVatStorageStats();

            // é¡¯ç¤ºè¼‰å…¥å®Œæˆæç¤º
            if (localStorage.getItem(STORAGE_KEY)) {
                showToast(`å·²è¼‰å…¥ ${customers.length} ç­†å®¢æˆ¶è³‡æ–™`);
            } else {
                showToast('ä½¿ç”¨é è¨­è³‡æ–™ï¼Œé¦–æ¬¡ä½¿ç”¨è«‹æ–°å¢å®¢æˆ¶è³‡æ–™');
            }

            renderAll();

            // åˆå§‹åŒ–æ”¶å–æ–¹å¼ï¼ˆç¢ºä¿åœ¨ç‡Ÿæ¥­ç¨…é é¢æ­£ç¢ºé¡¯ç¤ºï¼‰
            console.log('è¼‰å…¥çš„æ”¶å–æ–¹å¼:', collectMethods);

            // åˆå§‹åŒ–æœå°‹å’ŒåŒ¯å‡ºåŠŸèƒ½
            filteredCustomers = [...customers];
            updateExportInfo();
        });
    </script>
</body>

</html>