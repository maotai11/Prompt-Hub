
<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFFLINE CRM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;700&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <!-- SheetJS 庫用於處理 Excel 檔案 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --color-background: #101010;
            --color-surface: #1A1A1A;
            --color-surface-light: #252525;
            --color-text-primary: #F0F0F0;
            --color-text-secondary: #A0A0A0;
            --color-accent-gold: #D4AF37;
            --color-border: #383838;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-text-primary);
            font-family: 'Inter', sans-serif;
            font-weight: 300;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Layout & Components --- */
        /* patch: 2025-11-09 Advanced Features - Header with Search */
        .app-header {
            padding: 1.5rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
        }

        .main-title {
            font-family: 'EB Garamond', serif;
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
        }

        .btn-icon {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-container {
            padding: 2rem 2.5rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .tab-nav {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            position: relative;
            transition: color 0.3s ease;
        }

        .tab-btn:hover {
            color: var(--color-text-primary);
        }

        .tab-btn.active {
            color: var(--color-text-primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--color-accent-gold);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .module-title {
            font-family: 'EB Garamond', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .card {
            background-color: var(--color-surface);
            padding: 2.5rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        /* patch: 2025-11-09 全域 select 和 option 樣式 */
        select {
            background: var(--color-surface-light);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        select option {
            background: var(--color-surface);
            color: var(--color-text-primary);
            padding: 0.5rem;
        }

        /* 確保下拉選單的選項有足夠的對比度 */
        select option:hover,
        select option:focus,
        select option:checked {
            background: var(--color-accent-gold);
            color: var(--color-background);
        }

        /* patch: 2025-11-09 統一按鈕樣式系統 */
        .btn {
            padding: 0.6rem 1.2rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border-radius: 4px;
        }

        .btn-primary {
            background-color: var(--color-accent-gold);
            color: #000;
            border-color: var(--color-accent-gold);
        }

        .btn-primary:hover {
            background-color: #FFD700;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(212, 175, 55, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(212, 175, 55, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            color: var(--color-text-primary);
            border-color: var(--color-accent-gold);
            background-color: rgba(212, 175, 55, 0.1);
            transform: translateY(-1px);
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background-color: transparent;
            color: #E57373;
            border: 1px solid #E57373;
        }

        .btn-danger:hover {
            background-color: rgba(229, 115, 115, 0.1);
            border-color: #EF5350;
            color: #EF5350;
            transform: translateY(-1px);
        }

        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* patch: 2025-11-09 select 下拉選單按鈕樣式 */
        select.btn {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23A0A0A0' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            padding-right: 2.5rem;
        }

        /* --- 備註匯出面板樣式 --- */
        .notes-export-panel {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
            border-left: 4px solid var(--color-accent-gold);
        }

        .notes-export-panel h3 {
            color: var(--color-accent-gold);
        }

        #export-notes-excel-btn {
            font-weight: 600;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
        }

        #export-notes-excel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(212, 175, 55, 0.4);
        }

        #notes-count-display {
            font-weight: 500;
            padding: 0.3rem 0.8rem;
            background-color: rgba(212, 175, 55, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        /* patch: 2025-11-09 優化 Modal 系統 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.closing {
            animation: fadeOut 0.2s ease forwards;
        }

        .modal-content {
            background: var(--color-surface);
            padding: 2.5rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* patch: 2025-11-08 客戶表單 modal 樣式 */
        .modal-content.customer-form-modal {
            max-width: 1200px;
            width: 95%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .modal-title {
            font-family: 'EB Garamond', serif;
            font-size: 1.8rem;
            color: var(--color-accent-gold);
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .modal-close-btn:hover {
            color: var(--color-text-primary);
        }

        /* patch: 2025-11-08 多選功能樣式 */
        .customer-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--color-accent-gold);
        }

        .batch-actions-bar {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
            border: 1px solid var(--color-accent-gold);
            border-radius: 6px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .batch-actions-bar.active {
            display: flex;
        }

        .batch-info {
            flex: 1;
            color: var(--color-accent-gold);
            font-weight: 600;
        }

        .batch-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* patch: 2025-11-08 客戶備註折疊區樣式 */
        .customer-notes-row {
            display: none;
            background: var(--color-surface-light);
        }

        .customer-notes-row.expanded {
            display: table-row;
        }

        .customer-notes-content {
            padding: 1.5rem;
            border-left: 3px solid var(--color-accent-gold);
        }

        .notes-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .notes-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-accent-gold);
        }

        .add-note-section {
            background: var(--color-surface);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .note-item {
            background: var(--color-surface);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.8rem;
            border-left: 3px solid var(--color-border);
        }

        .note-item-content {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .note-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .note-item-tags {
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
        }

        .note-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .modal-content h3 {
            margin-bottom: 1.5rem;
            color: var(--color-accent-gold);
        }

        .modal-content .form-group {
            margin-bottom: 1rem;
        }

        .modal-content label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-text-secondary);
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 0.5rem;
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-primary);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* patch: 2025-11-08 標籤分類標題樣式 */
        .tag-category-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 0.5rem;
        }

        .message-preview {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .message-group {
            margin-bottom: 2rem;
        }

        .message-group h4 {
            color: var(--color-accent-gold);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .message-item {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .message-header {
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .message-content {
            background: var(--color-background);
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .copy-message-btn {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
        }

        .btn-small {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
        }

        .vat-row-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* --- 提醒卡片樣式 --- */
        .reminder-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .reminder-card {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .reminder-card:hover {
            background: var(--color-border);
            transform: translateY(-1px);
        }

        .reminder-company {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.3rem;
        }

        .reminder-contact,
        .reminder-method,
        .reminder-date,
        .reminder-note {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.2rem;
        }

        .reminder-note {
            color: var(--color-accent-gold);
            font-style: italic;
        }

        .reminder-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }

        .empty-reminder {
            text-align: center;
            color: var(--color-text-secondary);
            padding: 2rem;
            font-style: italic;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* --- 搜尋區塊樣式 --- */
        .search-section {
            background-color: var(--color-surface);
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--color-border);
        }

        /* --- 客戶列表工具列樣式 --- */
        .customer-list-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid var(--color-border);
            margin-top: 1rem;
        }

        .toolbar-left {
            flex: 1;
            max-width: 400px;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 0.6rem 2rem 0.6rem 0.8rem;
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-accent-gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }

        .search-input::placeholder {
            color: var(--color-text-secondary);
        }

        .clear-search-btn {
            position: absolute;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.2rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .clear-search-btn:hover {
            background: var(--color-border);
            color: var(--color-text-primary);
        }

        .export-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
        }

        .export-info {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            font-style: italic;
        }

        #export-customers-excel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #export-customers-excel-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .customer-list-toolbar {
                justify-content: center;
            }

            .export-container {
                align-items: center;
            }

            .search-section {
                margin-bottom: 1.5rem;
            }
        }

        /* --- 營業稅頁面樣式 --- */
        .vat-controls {
            margin-bottom: 1.5rem;
        }

        .vat-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 2rem;
        }

        .vat-period-controls {
            display: flex;
            gap: 1.5rem;
            align-items: flex-end;
        }

        .vat-period-controls .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .vat-period-controls label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .vat-period-controls input,
        .vat-period-controls select {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .vat-quick-actions {
            display: flex;
            gap: 1rem;
        }

        /* 提醒區塊 */
        .vat-reminders-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .vat-reminder-column .card {
            height: 100%;
            min-height: 300px;
        }

        .reminder-title {
            font-family: 'EB Garamond', serif;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--color-accent-gold);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.5rem;
        }

        .reminder-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .reminder-card {
            background: var(--color-surface-light);
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid var(--color-accent-gold);
        }

        .reminder-card-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .reminder-card-info {
            flex-grow: 1;
        }

        .reminder-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .reminder-card-company {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .reminder-card-details {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-top: 0.3rem;
        }

        /* 批次區塊 */
        .vat-batch-section {
            margin-bottom: 1.5rem;
        }

        .batch-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 2rem;
        }

        .collect-method-filter {
            flex-grow: 1;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 0.5rem 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .batch-actions {
            display: flex;
            gap: 1rem;
        }

        .message-preview {
            background: var(--color-surface-light);
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid var(--color-accent-gold);
            white-space: pre-wrap;
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }

        /* 資料表格 */
        .vat-data-section {
            margin-bottom: 2rem;
        }

        .vat-table-container {
            overflow-x: auto;
        }

        .vat-data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .vat-data-table th,
        .vat-data-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
            vertical-align: top;
        }

        .vat-data-table th {
            background: var(--color-surface);
            font-weight: 600;
            color: var(--color-text-secondary);
            position: sticky;
            top: 0;
        }

        /* patch: 2025-11-08 排序功能樣式 */
        .vat-data-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .vat-data-table th.sortable:hover {
            background-color: var(--color-surface-light);
            color: var(--color-accent-gold);
        }

        /* patch: 2025-11-09 動態排序圖示 - 使用 ::after 偽元素 */
        .vat-data-table th.sortable::after {
            content: '';
            margin-left: 0.3rem;
            font-size: 0.7rem;
            opacity: 0;
        }

        .vat-data-table th.sortable.sorted-asc::after {
            content: ' ▲';
            opacity: 1;
            color: var(--color-accent-gold);
        }

        .vat-data-table th.sortable.sorted-desc::after {
            content: ' ▼';
            opacity: 1;
            color: var(--color-accent-gold);
        }

        .vat-data-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .vat-row-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .vat-header-row {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .vat-period-controls {
                flex-wrap: wrap;
            }

            .vat-reminders-section {
                grid-template-columns: 1fr;
            }

            .batch-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* patch: 2025-11-09 移除重複的 btn-secondary 定義，已在上方統一定義 */

        /* --- Customer Form --- */
        .data-form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        .form-group input {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.6rem 0.2rem;
            font-size: 1rem;
            width: 100%;
        }

        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            border-top: 1px solid var(--color-border);
            padding-top: 1.5rem;
        }

        /* patch: 2025-11-08 固定新增按鈕樣式 */
        .floating-add-btn {
            position: sticky;
            top: 1rem;
            left: 0;
            z-index: 100;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .floating-add-btn .btn {
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
            font-size: 1rem;
            padding: 0.8rem 1.5rem;
        }

        .floating-add-btn .btn:hover {
            box-shadow: 0 6px 16px rgba(212, 175, 55, 0.5);
        }

        /* --- Customer Table --- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
            table-layout: fixed;
        }

        /* patch: 2025-11-09 調整欄寬，增加地址欄位寬度 */
        .data-table th:nth-child(1) {
            width: 3%;
            min-width: 40px;
        }

        /* 代號/公司名稱 */
        .data-table th:nth-child(2) {
            width: 15%;
            min-width: 150px;
        }

        /* 聯絡人/電話 */
        .data-table th:nth-child(3) {
            width: 12%;
            min-width: 120px;
        }

        /* 統一編號/稅籍編號 */
        .data-table th:nth-child(4) {
            width: 12%;
            min-width: 120px;
        }

        /* 地址 - 增加寬度 */
        .data-table th:nth-child(5) {
            width: 25%;
            min-width: 200px;
        }

        /* 租約起日 */
        .data-table th:nth-child(6) {
            width: 10%;
            min-width: 100px;
        }

        /* 租約迄日 */
        .data-table th:nth-child(7) {
            width: 10%;
            min-width: 100px;
        }

        /* 操作 */
        .data-table th:nth-child(8) {
            width: 13%;
            min-width: 120px;
        }

        /* 可調整欄寬功能 */
        .data-table th {
            position: relative;
            user-select: none;
        }

        .data-table th .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            background: transparent;
            transition: background 0.2s ease;
            z-index: 1;
        }

        .data-table th .resize-handle:hover {
            background: var(--color-accent-gold);
        }

        .data-table th .resize-handle.resizing {
            background: var(--color-accent-gold);
        }

        .data-table th.resizable:hover {
            background-color: rgba(212, 175, 55, 0.05);
        }

        /* 操作 */

        /* patch: 2025-11-09 調整表格間距 */
        .data-table th,
        .data-table td {
            padding: 1.2rem 0.8rem;
            text-align: left;
            vertical-align: top;
            border-bottom: 1px solid var(--color-border);
            line-height: 1.6;
            position: relative;
            min-height: 3rem;
        }

        .data-table th {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            line-height: 1.2;
            background-color: var(--color-surface);
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: center;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* patch: 2025-11-09 改善表格互動效果 */
        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background-color: rgba(212, 175, 55, 0.08);
            transform: translateX(2px);
        }

        /* patch: 2025-11-09 增強租約到期視覺狀態 */
        .data-table tr.expiring-soon {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.12), transparent);
            border-left: 4px solid var(--color-accent-gold);
        }

        .data-table tr.expired {
            background: linear-gradient(90deg, rgba(229, 115, 115, 0.12), transparent);
            border-left: 4px solid #E57373;
        }

        .data-table tr.expiring-soon:hover {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.18), rgba(212, 175, 55, 0.05));
        }

        .data-table tr.expired:hover {
            background: linear-gradient(90deg, rgba(229, 115, 115, 0.18), rgba(229, 115, 115, 0.05));
        }

        /* 租約到期日欄位的特殊樣式 */
        .lease-end-cell {
            position: relative;
        }

        .lease-end-cell.expiring {
            color: var(--color-accent-gold);
            font-weight: 600;
        }

        .lease-end-cell.expired {
            color: #E57373;
            font-weight: 600;
        }

        .lease-end-cell::after {
            content: '';
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0;
        }

        .lease-end-cell.expiring::after {
            background-color: var(--color-accent-gold);
            opacity: 1;
            animation: pulse 2s infinite;
        }

        .lease-end-cell.expired::after {
            background-color: #E57373;
            opacity: 1;
            animation: urgentBlink 1s infinite;
        }

        /* patch: 2025-11-09 租約到期動畫 */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
            50% {
                opacity: 0.5;
                transform: translateY(-50%) scale(1.2);
            }
        }

        @keyframes urgentBlink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .table-row-actions {
            padding: 0.5rem;
        }

        .action-buttons-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.3rem;
            max-width: 120px;
        }

        .table-row-actions .btn-action {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            text-decoration: underline;
            font-size: 0.85rem;
            transition: color 0.2s ease;
            padding: 0.2rem 0;
            text-align: left;
            white-space: nowrap;
        }

        .table-row-actions .btn-action:hover {
            color: var(--color-text-primary);
            background-color: rgba(212, 175, 55, 0.1);
        }

        /* patch: 2025-11-08 可調整欄寬功能樣式 */
        .data-table th {
            position: relative;
            user-select: none;
        }

        .data-table th .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            background: transparent;
            transition: background 0.2s ease;
        }

        .data-table th .resize-handle:hover {
            background: var(--color-accent-gold);
        }

        .data-table th .resize-handle.resizing {
            background: var(--color-accent-gold);
        }

        .data-table th.resizable {
            cursor: default;
        }

        .data-table th.resizable:hover {
            background-color: rgba(212, 175, 55, 0.05);
        }

        /* --- Global Notes Page & Tag Filtering --- */
        .filter-container {
            background-color: var(--color-surface);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .tag-filter-bar {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            overflow-x: auto;
            padding-bottom: 1.5rem;
        }

        .tag-filter-bar .tag-item {
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .tag-filter-bar .tag-item.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .filter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }

        .filter-logic-switcher .btn {
            font-size: 0.7rem;
            padding: 0.3rem 0.6rem;
        }

        .filter-status-bar {
            background-color: var(--color-surface-light);
            padding: 0.8rem 1.5rem;
            margin-bottom: 2rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-list {
            list-style: none;
        }

        .note-card {
            position: relative;
            background: var(--color-surface);
            padding: 1.5rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border-left: 3px solid var(--color-border);
        }

        .note-card .customer-name {
            font-family: 'EB Garamond', serif;
            font-weight: 700;
            color: var(--color-accent-gold);
        }

        .note-content {
            margin: 0.5rem 0 1rem 0;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .note-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-delete-note {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.5;
        }

        .btn-delete-note:hover {
            opacity: 1;
            color: var(--color-accent-gold);
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag-item {
            color: var(--color-text-primary);
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.9rem;
        }

        .notes-textarea {
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-primary);
            padding: 0.8rem;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .tag-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.6rem 0.2rem;
            font-size: 1rem;
            flex-grow: 1;
            min-width: 200px;
        }

        .tag-input-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .tag-delete-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0 0 0 0.5rem;
        }

        /* --- Lease Reminder Specific Styles --- */
        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .no-margin-bottom {
            margin-bottom: 0 !important;
        }

        #expiring-customers-section {
            margin-bottom: 2rem;
            position: relative;
        }

        /* patch: 2025-11-08 折疊功能樣式 */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        /* patch: 2025-11-09 改進展開收合圖示 */
        .collapse-icon {
            transition: all 0.3s ease;
            font-size: 1.3rem;
            color: var(--color-accent-gold);
            cursor: pointer;
        }

        .collapse-icon:hover {
            color: #FFD700;
            transform: scale(1.1);
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapse-icon.collapsed:hover {
            transform: rotate(-90deg) scale(1.1);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        /* patch: 2025-11-09 移除舊的 priority-indicator 樣式，使用新的統一樣式 */

        /* 增強狀態標籤的視覺衝擊力 */
        .status-badge.critical {
            background: linear-gradient(135deg, #E53E3E, #C53030);
            color: white;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.4);
            animation: criticalBadge 2s infinite;
        }

        @keyframes criticalBadge {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .status-badge.warning {
            background: linear-gradient(135deg, #D69E2E, #B7791F);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 8px rgba(214, 158, 46, 0.3);
        }

        #expiring-customers-list {
            list-style: none;
            padding: 0;
        }

        #expiring-customers-list li {
            background-color: var(--color-surface-light);
            padding: 1.2rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        #expiring-customers-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            transition: width 0.3s ease;
        }

        #expiring-customers-list li:hover {
            background-color: var(--color-border);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        #expiring-customers-list li:hover::before {
            width: 12px;
        }

        #expiring-customers-list li.expired {
            background: linear-gradient(135deg, rgba(229, 115, 115, 0.1), rgba(229, 115, 115, 0.05));
            border: 1px solid rgba(229, 115, 115, 0.3);
        }

        #expiring-customers-list li.expired::before {
            background: linear-gradient(180deg, #E57373, #EF5350);
        }

        #expiring-customers-list li.expiring-soon {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        #expiring-customers-list li.expiring-soon::before {
            background: linear-gradient(180deg, var(--color-accent-gold), #FFD700);
        }

        #expiring-customers-list .customer-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        #expiring-customers-list .customer-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--color-text-primary);
        }

        #expiring-customers-list .customer-contact {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        #expiring-customers-list .customer-address {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            opacity: 0.8;
        }

        #expiring-customers-list .days-left {
            font-weight: 700;
            font-size: 1rem;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            text-align: center;
            min-width: 120px;
            position: relative;
        }

        #expiring-customers-list .days-left:not(.expired-text) {
            background: linear-gradient(135deg, var(--color-accent-gold), #FFD700);
            color: #000;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }

        #expiring-customers-list .days-left.expired-text {
            background: linear-gradient(135deg, #E57373, #EF5350);
            color: white;
            box-shadow: 0 2px 8px rgba(229, 115, 115, 0.4);
            animation: urgentBlink 1.5s infinite alternate;
        }

        @keyframes urgentBlink {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0.7;
            }
        }

        /* 狀態標籤 */
        .status-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.critical {
            background: #E57373;
            color: white;
        }

        .status-badge.warning {
            background: var(--color-accent-gold);
            color: #000;
        }

        #reminder-card {
            background-color: var(--color-surface-light);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--color-accent-gold);
            display: none;
        }

        #reminder-card.active {
            display: block;
        }

        #reminder-card pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--color-text-primary);
            margin-bottom: 1rem;
        }

        #reminder-card .copy-btn-wrapper {
            text-align: right;
        }

        .expiring-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-copy-reminder {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
        }
    </style>
    <style>
        /* patch: 2025-11-09 Toast 通知系統改進 */
        #toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
        }

        .toast {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1rem 1.5rem;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 1rem;
            pointer-events: auto;
            animation: slideInRight 0.3s ease;
        }

        .toast.toast-success {
            border-left: 4px solid var(--color-accent-gold);
        }

        .toast.toast-error {
            border-left: 4px solid #E57373;
        }

        .toast.toast-info {
            border-left: 4px solid #64B5F6;
        }

        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .toast-success .toast-icon {
            color: var(--color-accent-gold);
        }

        .toast-error .toast-icon {
            color: #E57373;
        }

        .toast-info .toast-icon {
            color: #64B5F6;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* patch: 2025-11-09 Loading 指示器系統 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            animation: fadeIn 0.2s ease;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--color-text-primary);
            font-size: 0.9rem;
        }

        /* patch: 2025-11-09 功能按鈕分組樣式 */
        .function-groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
        }

        .function-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .function-group-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .function-group-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .function-group-buttons .btn {
            width: 100%;
            text-align: left;
            justify-content: flex-start;
        }

        /* patch: 2025-11-09 響應式設計優化 */
        @media (max-width: 768px) {
            .function-groups-container {
                grid-template-columns: 1fr;
                padding: 1.5rem;
            }

            .function-group-buttons .btn {
                width: 100%;
                padding: 0.8rem 1rem;
            }

            .data-form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95vw;
                padding: 1.5rem;
            }

            .modal-content.customer-form-modal {
                width: 95vw;
            }

            .btn {
                width: 100%;
                padding: 0.8rem 1rem;
            }

            .batch-actions-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .batch-buttons {
                flex-direction: column;
            }

            .batch-buttons .btn {
                width: 100%;
            }

            .toast {
                min-width: 280px;
                max-width: 90vw;
            }

            #toast-container {
                right: 1rem;
                left: 1rem;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 1.5rem;
            }

            .module-title {
                font-size: 2rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.8rem 0.5rem;
                font-size: 0.85rem;
            }
        }

        /* patch: 2025-11-09 額外的 UI 改進 */
        
        /* 1. 統計卡片化 */
        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
            border-color: var(--color-accent-gold);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* 2. 緊急提示樣式增強 */
        .priority-indicator {
            background: linear-gradient(135deg, rgba(229, 115, 115, 0.2), rgba(229, 115, 115, 0.1));
            border: 2px solid #E57373;
            border-radius: 6px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            color: #E57373;
            font-weight: 600;
            font-size: 1.1rem;
            text-align: center;
            animation: urgentPulse 2s infinite;
        }

        @keyframes urgentPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(229, 115, 115, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(229, 115, 115, 0);
            }
        }

        /* 3. 資訊提示框 */
        .info-box {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
            border-left: 4px solid var(--color-accent-gold);
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .info-box-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .info-box-content {
            flex: 1;
        }

        .info-box-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--color-accent-gold);
        }

        .info-box-text {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
        }

        /* 4. 客戶工具列 */
        .customer-toolbar {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .customer-toolbar > * {
            flex: 1;
            min-width: 200px;
        }

        /* 5. 操作欄位下拉選單 */
        .action-dropdown {
            position: relative;
            display: inline-block;
        }

        .action-dropdown-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.3rem 0.5rem;
            transition: all 0.2s ease;
        }

        .action-dropdown-btn:hover {
            color: var(--color-accent-gold);
            background: rgba(212, 175, 55, 0.1);
            border-radius: 4px;
        }

        .action-dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            min-width: 150px;
            z-index: 1000;
            margin-top: 0.3rem;
            /* patch: 2025-11-09 確保背景不透明 */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .action-dropdown-menu.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .action-dropdown-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--color-border);
        }

        .action-dropdown-item:last-child {
            border-bottom: none;
        }

        .action-dropdown-item:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--color-accent-gold);
        }

        .action-dropdown-item.danger:hover {
            background: rgba(229, 115, 115, 0.1);
            color: #E57373;
        }

        /* 6. 數字欄位右對齊 */
        .cell-numeric {
            text-align: right;
        }

        /* 7. 儲存空間視覺化 */
        .storage-info-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .storage-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .storage-info-label {
            font-weight: 600;
        }

        .storage-info-value {
            font-family: 'Courier New', monospace;
        }

        .storage-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-surface-light);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .storage-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-accent-gold), #FFD700);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .storage-progress-fill.warning {
            background: linear-gradient(90deg, #F59E0B, #FBBF24);
        }

        .storage-progress-fill.danger {
            background: linear-gradient(90deg, #E57373, #EF5350);
        }
    </style>

    <style>
        /* patch: 2025-11-08 訊息模板系統樣式 */
        
        /* 模板列表頁面 */
        .template-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .template-actions {
            display: flex;
            gap: 0.5rem;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .template-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .template-card:hover {
            border-color: var(--color-accent-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
        }

        .template-card-header {
            margin-bottom: 1rem;
        }

        .template-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--color-accent-gold);
            margin-bottom: 0.5rem;
        }

        /* patch: 2025-11-09 改善模板元數據樣式 */
        .template-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            background: var(--color-surface-light);
            padding: 0.5rem 0.8rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .template-card-body {
            margin-bottom: 1rem;
        }

        .template-description {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        /* patch: 2025-11-09 美化訊息內容預覽 */
        .message-preview-box {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.05), rgba(212, 175, 55, 0.02));
            border-left: 3px solid var(--color-accent-gold);
            padding: 1rem;
            border-radius: 4px;
            margin-top: 0.8rem;
        }

        .template-preview {
            font-size: 0.9rem;
            color: var(--color-text-primary);
            line-height: 1.6;
            max-height: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: pre-wrap;
        }

        .template-card-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        /* patch: 2025-11-08 平台徽章和客戶預覽樣式 */
        .template-platform-badge {
            background: var(--color-accent-gold);
            color: #000;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .template-subject {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        .template-customer-preview {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }

        .customer-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            font-weight: 600;
            color: var(--color-accent-gold);
        }

        .customer-preview-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .customer-preview-item {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .customer-preview-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .customer-preview-item-name {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .customer-preview-item-subject {
            background: var(--color-surface);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .customer-preview-item-subject-label {
            color: var(--color-text-secondary);
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
        }

        .customer-preview-item-content {
            background: var(--color-surface);
            padding: 0.8rem;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 0.85rem;
            line-height: 1.5;
            max-height: 150px;
            overflow-y: auto;
        }

        /* 模板編輯器 Modal */
        .template-editor-modal {
            max-width: 800px;
            width: 95%;
        }

        .template-content-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .template-help-text {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-top: 0.5rem;
        }

        /* patch: 2025-11-09 Advanced Features - Global Search Styles */
        .global-search-modal {
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
        }

        .search-input-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .global-search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            background: var(--color-surface-light);
            border: 2px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text-primary);
            transition: all 0.2s ease;
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--color-accent-gold);
        }

        .search-shortcut-hint {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            background: var(--color-surface);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            pointer-events: none;
        }

        .search-results {
            max-height: 500px;
            overflow-y: auto;
        }

        .search-category {
            margin-bottom: 1.5rem;
        }

        .search-category-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-count {
            font-size: 0.75rem;
            color: var(--color-accent-gold);
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .search-result-item:hover {
            background: var(--color-surface-light);
            border-color: var(--color-accent-gold);
            transform: translateX(4px);
        }

        .search-result-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .search-result-content {
            flex: 1;
            min-width: 0;
        }

        .search-result-title {
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: 0.3rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .search-result-meta {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .search-initial-state,
        .search-empty-state {
            text-align: center;
            padding: 3rem 2rem;
        }

        .search-initial-state .empty-state-icon,
        .search-empty-state .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .search-initial-state .empty-state-text,
        .search-empty-state .empty-state-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
        }

        .search-initial-state .empty-state-hint,
        .search-empty-state .empty-state-hint {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        /* patch: 2025-11-09 標籤選擇器 Modal 優化 */
        .tag-selector-modal {
            max-width: 600px;
            width: 90%;
        }

        .tag-selector-search {
            margin-bottom: 1.5rem;
        }

        .tag-selector-search .search-input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-primary);
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .tag-selector-search .search-input:focus {
            outline: none;
            border-color: var(--color-accent-gold);
            background: var(--color-surface);
        }

        .tag-selector-search .search-input::placeholder {
            color: var(--color-text-secondary);
        }

        .tag-list {
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background: var(--color-surface);
        }

        .tag-category-header {
            padding: 0.8rem 1rem;
            background: var(--color-surface-light);
            border-bottom: 2px solid var(--color-border);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--color-accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .tag-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.2rem;
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .tag-option:last-child {
            border-bottom: none;
        }

        .tag-option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--color-accent-gold);
            transform: scaleY(0);
            transition: transform 0.2s ease;
        }

        .tag-option:hover {
            background: rgba(212, 175, 55, 0.08);
            padding-left: 1.5rem;
        }

        .tag-option:hover::before {
            transform: scaleY(1);
        }

        .tag-label {
            font-weight: 500;
            color: var(--color-text-primary);
            font-size: 0.95rem;
        }

        .tag-format {
            font-family: 'Courier New', monospace;
            color: var(--color-accent-gold);
            font-size: 0.85rem;
            background: rgba(212, 175, 55, 0.1);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        /* 訊息預覽 Modal */
        .message-preview-modal {
            max-width: 900px;
            width: 95%;
            max-height: 85vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .message-list {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .message-item {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid var(--color-accent-gold);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .message-number {
            font-weight: 700;
            color: var(--color-accent-gold);
        }

        .customer-info {
            flex: 1;
            margin: 0 1rem;
            color: var(--color-text-primary);
        }

        .message-content {
            background: var(--color-surface);
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .btn-copy-message {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
        }

        /* 模板選擇器 */
        .template-selector-modal {
            max-width: 600px;
            width: 90%;
        }

        .template-selector-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .template-selector-item {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-selector-item:hover {
            border-color: var(--color-accent-gold);
            background: var(--color-surface);
            transform: translateX(4px);
        }

        .template-selector-item-name {
            font-weight: 600;
            color: var(--color-accent-gold);
            margin-bottom: 0.3rem;
        }

        .template-selector-item-desc {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        /* 空狀態 */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .empty-state-hint {
            font-size: 0.9rem;
        }

        /* patch: 2025-11-08 客戶選擇器樣式 */
        .customer-selector-search {
            margin-bottom: 1rem;
        }

        .customer-selector-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }

        /* patch: 2025-11-09 優化客戶選擇器佈局 */
        .customer-selector-item {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            border-bottom: 1px solid var(--color-border);
            transition: background 0.2s ease;
            gap: 0.8rem;
        }

        .customer-selector-item:last-child {
            border-bottom: none;
        }

        .customer-selector-item:hover {
            background: var(--color-surface-light);
        }

        .customer-selector-item input[type="checkbox"] {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
        }

        .customer-selector-item label {
            flex: 1;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .template-grid {
                grid-template-columns: 1fr;
            }

            .template-list-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .template-actions {
                flex-direction: column;
            }

            .template-card-actions {
                justify-content: flex-start;
            }
        }
    </style>

    <style>
        /* patch: 2025-11-09 Dashboard Home Page Styles */
        
        /* Dashboard Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* Dashboard Stats */
        .dashboard-stats {
            margin-bottom: 2rem;
        }

        .stat-card.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(212, 175, 55, 0.3);
            border-color: var(--color-accent-gold);
        }

        /* Dashboard Content Layout */
        .dashboard-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .dashboard-left,
        .dashboard-right {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Dashboard Card */
        .dashboard-card {
            height: 100%;
        }

        .dashboard-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .dashboard-card-title {
            font-family: 'EB Garamond', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent-gold);
            margin: 0;
        }

        /* Dashboard List */
        .dashboard-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .dashboard-list-item {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .dashboard-list-item:hover {
            background: var(--color-border);
            transform: translateX(4px);
            border-left: 3px solid var(--color-accent-gold);
        }

        .dashboard-list-item.urgent {
            border-left: 3px solid #E57373;
        }

        .dashboard-list-item.warning {
            border-left: 3px solid var(--color-accent-gold);
        }

        .dashboard-list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .dashboard-list-item-company {
            font-weight: 600;
            color: var(--color-text-primary);
            font-size: 1rem;
        }

        .dashboard-list-item-days {
            font-size: 0.85rem;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .dashboard-list-item-days.urgent {
            background: rgba(229, 115, 115, 0.2);
            color: #E57373;
        }

        .dashboard-list-item-days.warning {
            background: rgba(212, 175, 55, 0.2);
            color: var(--color-accent-gold);
        }

        .dashboard-list-item-info {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        .dashboard-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--color-text-secondary);
        }

        .dashboard-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .dashboard-empty-text {
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        /* Dashboard VAT Section */
        .dashboard-vat-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .dashboard-vat-item {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
            border: 1px solid var(--color-border);
            border-left: 3px solid var(--color-accent-gold);
            border-radius: 6px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dashboard-vat-item:hover {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.08));
            transform: translateX(4px);
        }

        .dashboard-vat-item.urgent {
            border-left-color: #E57373;
            background: linear-gradient(135deg, rgba(229, 115, 115, 0.1), rgba(229, 115, 115, 0.05));
        }

        .dashboard-vat-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .dashboard-vat-item-period {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .dashboard-vat-item-badge {
            font-size: 0.85rem;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .dashboard-vat-item-badge.urgent {
            background: rgba(229, 115, 115, 0.2);
            color: #E57373;
        }

        .dashboard-vat-item-badge.normal {
            background: rgba(212, 175, 55, 0.2);
            color: var(--color-accent-gold);
        }

        .dashboard-vat-item-info {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        /* Dashboard Timeline */
        .dashboard-timeline {
            max-height: 500px;
            overflow-y: auto;
        }

        .timeline-month {
            margin-bottom: 2rem;
        }

        .timeline-month-header {
            font-family: 'EB Garamond', serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-accent-gold);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--color-border);
        }

        .timeline-day {
            margin-bottom: 1.5rem;
        }

        .timeline-day-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.8rem;
        }

        .timeline-day-date {
            font-weight: 600;
            color: var(--color-text-primary);
            min-width: 80px;
        }

        .timeline-day-weekday {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .timeline-day-count {
            font-size: 0.85rem;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            background: rgba(212, 175, 55, 0.2);
            color: var(--color-accent-gold);
            font-weight: 600;
        }

        .timeline-events {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-left: 1rem;
            border-left: 2px solid var(--color-border);
        }

        .timeline-event {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .timeline-event:hover {
            background: var(--color-border);
            transform: translateX(4px);
        }

        .timeline-event-icon {
            font-size: 1.2rem;
            min-width: 24px;
            text-align: center;
        }

        .timeline-event-content {
            flex: 1;
        }

        .timeline-event-title {
            font-weight: 600;
            color: var(--color-text-primary);
            font-size: 0.95rem;
            margin-bottom: 0.2rem;
        }

        .timeline-event-detail {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .timeline-event-type {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .timeline-event-type.lease {
            background: rgba(212, 175, 55, 0.2);
            color: var(--color-accent-gold);
        }

        .timeline-event-type.vat {
            background: rgba(56, 161, 105, 0.2);
            color: #38A169;
        }

        .timeline-event-type.reminder {
            background: rgba(66, 153, 225, 0.2);
            color: #4299E1;
        }

        /* Dashboard Quick Actions */
        .dashboard-quick-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 2rem 0;
            border-top: 1px solid var(--color-border);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .dashboard-quick-actions {
                flex-direction: column;
            }

            .dashboard-quick-actions .btn {
                width: 100%;
            }
        }
    </style>

    <style>
        /* patch: 2025-11-09 Settings Page Styles */
        
        /* Settings Section */
        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section-title {
            font-family: 'EB Garamond', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent-gold);
            margin: 0 0 1.5rem 0;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid var(--color-border);
        }

        /* Settings Item */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--color-border);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-info {
            flex: 1;
            padding-right: 2rem;
        }

        .settings-item-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.3rem;
        }

        .settings-item-description {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        .settings-item-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 200px;
        }

        .settings-item-control .form-control {
            flex: 1;
        }

        .settings-unit {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            white-space: nowrap;
        }

        .settings-info-text {
            font-size: 0.9rem;
            color: var(--color-accent-gold);
            font-weight: 600;
        }

        /* Toggle Switch */
        .settings-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .settings-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-border);
            transition: 0.3s;
            border-radius: 26px;
        }

        .settings-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: var(--color-surface);
            transition: 0.3s;
            border-radius: 50%;
        }

        .settings-toggle input:checked + .settings-toggle-slider {
            background-color: var(--color-accent-gold);
        }

        .settings-toggle input:checked + .settings-toggle-slider:before {
            transform: translateX(24px);
        }

        .settings-toggle-slider:hover {
            opacity: 0.8;
        }

        /* Settings Actions */
        .settings-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
        }

        /* Settings Footer */
        .settings-footer {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 2rem 0;
            border-top: 2px solid var(--color-border);
            margin-top: 2rem;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }

        .btn-danger {
            background: linear-gradient(135deg, #E57373, #EF5350);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #EF5350, #E53935);
        }

        /* Light Theme Styles */
        body.light-theme {
            --color-background: #FAFAFA;
            --color-surface: #FFFFFF;
            --color-surface-light: #F5F5F5;
            --color-text-primary: #212121;
            --color-text-secondary: #757575;
            --color-border: #E0E0E0;
        }

        body.light-theme .btn-secondary {
            background: var(--color-surface-light);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        body.light-theme .btn-secondary:hover {
            background: var(--color-border);
        }

        body.light-theme .stat-card {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Font Size Variations */
        body.font-small {
            font-size: 14px;
        }

        body.font-large {
            font-size: 18px;
        }

        /* Performance Mode */
        body.performance-mode * {
            transition: none !important;
            animation: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .settings-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .settings-item-info {
                padding-right: 0;
            }

            .settings-item-control {
                width: 100%;
                min-width: auto;
            }

            .settings-actions {
                flex-direction: column;
            }

            .settings-actions .btn {
                width: 100%;
            }

            .settings-footer {
                flex-direction: column;
            }

            .settings-footer .btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- patch: 2025-11-09 Advanced Features - Header with Search -->
    <header class="app-header">
        <h1 class="main-title">客戶資料庫</h1>
        <button id="global-search-btn" class="btn btn-secondary btn-icon" title="全域搜尋 (Ctrl+K)">
            🔍 搜尋
        </button>
    </header>
    <main class="main-container">
        <nav class="tab-nav">
            <button id="tab-dashboard" type="button" class="tab-btn active">儀表板</button>
            <button id="tab-list" type="button" class="tab-btn">客戶列表</button>
            <button id="tab-templates" type="button" class="tab-btn">訊息模板</button>
            <button id="tab-vat" type="button" class="tab-btn">營業稅</button>
        </nav>

        <!-- patch: 2025-11-09 Dashboard Home Page -->
        <div id="page-dashboard" class="page active">
            <div class="dashboard-header">
                <h1 class="module-title">儀表板</h1>
                <button id="dashboard-refresh-btn" class="btn btn-secondary btn-icon">
                    <span>🔄</span>
                    <span>重新整理</span>
                </button>
            </div>

            <!-- 統計卡片區域 -->
            <div class="stats-container dashboard-stats">
                <div class="stat-card clickable" data-filter="all">
                    <div class="stat-number" id="dashboard-total-customers">0</div>
                    <div class="stat-label">總客戶數</div>
                </div>
                <div class="stat-card clickable" data-filter="expired">
                    <div class="stat-number" id="dashboard-expired-count" style="color: #E57373;">0</div>
                    <div class="stat-label">已到期</div>
                </div>
                <div class="stat-card clickable" data-filter="expiring">
                    <div class="stat-number" id="dashboard-expiring-count" style="color: var(--color-accent-gold);">0</div>
                    <div class="stat-label">即將到期 (30天)</div>
                </div>
                <div class="stat-card clickable" data-filter="active">
                    <div class="stat-number" id="dashboard-active-count" style="color: #38A169;">0</div>
                    <div class="stat-label">正常租約</div>
                </div>
            </div>

            <!-- 主要內容區域 -->
            <div class="dashboard-content">
                <!-- 左側：即將到期客戶 + 營業稅提醒 -->
                <div class="dashboard-left">
                    <!-- 即將到期客戶 -->
                    <div class="card dashboard-card">
                        <div class="dashboard-card-header">
                            <h3 class="dashboard-card-title">即將到期客戶</h3>
                            <button id="view-all-expiring-btn" class="btn btn-secondary btn-small">查看全部</button>
                        </div>
                        <div id="dashboard-expiring-list" class="dashboard-list">
                            <!-- 動態生成 -->
                        </div>
                    </div>

                    <!-- 營業稅提醒 -->
                    <div class="card dashboard-card">
                        <div class="dashboard-card-header">
                            <h3 class="dashboard-card-title">營業稅提醒</h3>
                        </div>
                        <div id="dashboard-vat-reminders" class="dashboard-vat-section">
                            <!-- 動態生成 -->
                        </div>
                    </div>
                </div>

                <!-- 右側：時間軸事件檢視 -->
                <div class="dashboard-right">
                    <div class="card dashboard-card">
                        <div class="dashboard-card-header">
                            <h3 class="dashboard-card-title">未來事件時間軸</h3>
                            <select id="timeline-range-select" class="btn btn-secondary btn-small">
                                <option value="30">未來 30 天</option>
                                <option value="60">未來 60 天</option>
                                <option value="90" selected>未來 90 天</option>
                            </select>
                        </div>
                        <div id="dashboard-timeline" class="dashboard-timeline">
                            <!-- 動態生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 快速操作區域 -->
            <div class="dashboard-quick-actions">
                <button id="dashboard-add-customer-btn" class="btn btn-primary btn-icon">
                    <span>➕</span>
                    <span>新增客戶</span>
                </button>
                <button id="dashboard-export-btn" class="btn btn-secondary btn-icon">
                    <span>📊</span>
                    <span>匯出資料</span>
                </button>
                <button id="dashboard-search-btn" class="btn btn-secondary btn-icon">
                    <span>🔍</span>
                    <span>全域搜尋</span>
                </button>
            </div>
        </div>

        <div id="page-list" class="page">
            <!-- patch: 2025-11-09 Excel 功能說明美化 -->
            <div class="info-box">
                <div class="info-box-icon">📊</div>
                <div class="info-box-content">
                    <div class="info-box-title">Excel 批量編輯功能</div>
                    <div class="info-box-text">
                        點擊「匯出範本 (.xlsx)」下載Excel檔案 → 在Excel中編輯客戶資料 → 點擊「匯入 Excel」上傳修改後的檔案
                    </div>
                </div>
            </div>

            <!-- patch: 2025-11-09 統計資訊面板卡片化 -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="total-customers" style="color: var(--color-accent-gold);">0</div>
                    <div class="stat-label">總客戶數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="expired-count" style="color: #E57373;">0</div>
                    <div class="stat-label">已到期</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="expiring-count" style="color: var(--color-accent-gold);">0</div>
                    <div class="stat-label">即將到期</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-count" style="color: #38A169;">0</div>
                    <div class="stat-label">正常租約</div>
                </div>
            </div>

            <div id="expiring-customers-section" class="card">
                <!-- patch: 2025-11-09 緊急提示樣式 -->
                <div class="priority-indicator" id="priority-indicator" style="display: none;">
                    高優先級提醒
                </div>
                <div class="section-header-row collapsible-header" id="expiring-section-header">
                    <h2 class="module-title no-margin-bottom">即將到期客戶</h2>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="collapsible-content" id="expiring-section-content">
                    <!-- patch: 2025-11-09 功能按鈕分組佈局 -->
                    <div class="header-controls" style="margin-top: 1rem;">
                        <!-- 排序和篩選控制項 -->
                        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                            <select id="expiring-sort-select" class="form-control"
                                style="background: var(--color-surface-light); color: var(--color-text-primary); border: 1px solid var(--color-border); padding: 0.5rem; border-radius: 4px;">
                                <option value="days-asc">依到期日排序 (近到遠)</option>
                                <option value="days-desc">依到期日排序 (遠到近)</option>
                                <option value="company-asc">依公司名稱排序 (A-Z)</option>
                                <option value="company-desc">依公司名稱排序 (Z-A)</option>
                            </select>
                            <select id="expiring-filter-select" class="form-control"
                                style="background: var(--color-surface-light); color: var(--color-text-primary); border: 1px solid var(--color-border); padding: 0.5rem; border-radius: 4px;">
                                <option value="all">顯示全部</option>
                                <option value="expired">僅顯示已到期</option>
                                <option value="critical">僅顯示30天內到期</option>
                                <option value="warning">僅顯示90天內到期</option>
                            </select>
                        </div>

                        <!-- 功能按鈕分組 -->
                        <div class="function-groups-container">
                            <div class="function-group">
                                <h4 class="function-group-title">資料管理</h4>
                                <div class="function-group-buttons">
                                    <button id="export-excel-template-btn" class="btn btn-primary">📥 匯出範本 (.xlsx)</button>
                                    <button id="import-excel-btn" class="btn btn-primary">📤 匯入 Excel</button>
                                    <button id="import-data-btn" class="btn btn-secondary">📂 匯入資料</button>
                                </div>
                            </div>
                            
                            <div class="function-group">
                                <h4 class="function-group-title">備份還原</h4>
                                <div class="function-group-buttons">
                                    <button id="auto-backup-btn" class="btn btn-secondary">💾 立即備份</button>
                                    <button id="restore-backup-btn" class="btn btn-secondary">♻️ 還原備份</button>
                                    <button id="clear-data-btn" class="btn btn-danger">🗑️ 清除所有資料</button>
                                </div>
                            </div>
                            
                            <div class="function-group">
                                <h4 class="function-group-title">匯出功能</h4>
                                <div class="function-group-buttons">
                                    <button id="export-all-data-btn" class="btn btn-secondary">📊 匯出所有資料</button>
                                    <button id="export-expiring-csv-btn" class="btn btn-secondary">📄 匯出 CSV</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <ul id="expiring-customers-list"></ul>
                </div>
            </div>

            <div id="reminder-card" class="card">
                <pre id="reminder-text-display"></pre>
                <div class="copy-btn-wrapper">
                    <button id="copy-reminder-btn" class="btn btn-primary">複製提醒語</button>
                </div>
            </div>

            <!-- 關鍵字搜尋區塊 - 移動到客戶標題列上方 -->
            <div class="search-section" style="margin-bottom: 1rem;">
                <div class="search-container">
                    <input type="text" id="customer-search-input" class="search-input"
                        placeholder="關鍵字搜尋（公司/聯絡人/地址/Email/電話/標籤）">
                    <button id="clear-search-btn" class="clear-search-btn" style="display: none;">×</button>
                </div>
            </div>

            <!-- patch: 2025-11-08 固定新增按鈕 -->
            <div class="floating-add-btn">
                <button id="floating-add-customer-btn" class="btn btn-primary">+ 新增客戶資料</button>
            </div>

            <!-- patch: 2025-11-08 批次操作工具列 -->
            <div class="batch-actions-bar" id="batch-actions-bar">
                <div class="batch-info">
                    已選擇 <span id="selected-count">0</span> 筆客戶
                </div>
                <div class="batch-buttons">
                    <button id="apply-template-btn" class="btn btn-primary">套用訊息模板</button>
                    <button id="export-selected-notes-btn" class="btn btn-primary">匯出選中客戶備註</button>
                    <button id="clear-selection-btn" class="btn btn-secondary">取消選擇</button>
                </div>
            </div>

            <!-- patch: 2025-11-09 表格欄寬已調整，resize-handle 由 JavaScript 自動生成 -->
            <table class="data-table" id="customer-table">
                <thead>
                    <tr>
                        <th style="width: 3%;">
                            <input type="checkbox" id="select-all-checkbox" class="customer-checkbox" title="全選/取消全選">
                        </th>
                        <th>代號<br>公司名稱</th>
                        <th>聯絡人<br>電話</th>
                        <th>統一編號<br>稅籍編號</th>
                        <th>地址</th>
                        <th>租約起日</th>
                        <th>租約迄日</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="customer-list-body"></tbody>
            </table>

            <!-- patch: 2025-11-09 視覺化儲存空間資訊 -->
            <div class="storage-info-card" style="margin-bottom: 1.5rem;">
                <div class="storage-info-header">
                    <span class="storage-info-label">💾 儲存空間使用情況</span>
                    <span class="storage-info-value" id="storage-stats-text">載入中...</span>
                </div>
                <div class="storage-progress-bar">
                    <div class="storage-progress-fill" id="storage-progress-fill" style="width: 0%;"></div>
                </div>
            </div>

            <!-- 客戶列表工具列 -->
            <div class="customer-list-toolbar">
                <div class="toolbar-right" style="display: flex; gap: 1rem; width: 100%; justify-content: flex-end;">
                    <div class="export-container">
                        <button id="export-all-notes-btn" class="btn btn-secondary">匯出所有備註</button>
                        <div class="export-info">匯出：所有客戶備註</div>
                    </div>
                    <div class="export-container">
                        <button id="export-customers-excel-btn" class="btn btn-primary">匯出客戶資料</button>
                        <div class="export-info">匯出：目前結果</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-form" class="page">
            <div id="form-container"></div>
        </div>

        <div id="page-notes" class="page">
            <div class="filter-container">
                <div class="tag-filter-bar" id="tag-filter-bar"></div>
                <div class="filter-controls">
                    <div>
                        <label>篩選邏輯: </label>
                        <div class="btn-group" id="filter-logic-switcher">
                            <button class="btn btn-secondary active" data-logic="OR">OR (聯集)</button>
                            <button class="btn btn-secondary" data-logic="AND">AND (交集)</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 備註匯出功能區塊 -->
            <div class="notes-export-panel card" id="notesExportPanel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; font-family: 'EB Garamond', serif; font-size: 1.5rem;">備註匯出</h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <span id="notes-count-display"
                            style="color: var(--color-text-secondary); font-size: 0.9rem;">載入中...</span>
                        <button id="export-notes-excel-btn" class="btn btn-primary"
                            style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>📊</span>
                            <span>匯出 Excel (.xlsx)</span>
                        </button>
                    </div>
                </div>
                <div style="color: var(--color-text-secondary); font-size: 0.9rem; line-height: 1.5;">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>匯出模式：</strong>
                    </div>
                    <div style="margin-left: 1rem;">
                        • <strong>有標籤篩選時</strong>：僅匯出符合篩選條件的備註<br>
                        • <strong>無標籤篩選時</strong>：匯出所有客戶的備註資料
                    </div>
                </div>
            </div>
            <div class="filter-status-bar" id="filter-status-bar" style="display: none;">
                <span></span><button class="btn btn-secondary" id="clear-filter-btn">清空篩選</button>
            </div>
            <ul class="notes-list" id="notes-list"></ul>
        </div>

        <!-- patch: 2025-11-08 訊息模板頁面 -->
        <div id="page-templates" class="page">
            <div id="templates-container"></div>
        </div>

        <!-- 營業稅頁面 -->
        <div id="page-vat" class="page">
            <!-- 頂部控制列 -->
            <div class="vat-controls card">
                <div class="vat-header-row">
                    <div class="vat-period-controls">
                        <div class="form-group">
                            <label for="vat-year">年度</label>
                            <input type="number" id="vat-year" min="100" max="200" value="113" style="width: 80px;">
                        </div>
                        <div class="form-group">
                            <label for="vat-period">期數</label>
                            <select id="vat-period" class="btn btn-secondary">
                                <option value="1">第1期 (01-02月)</option>
                                <option value="2">第2期 (03-04月)</option>
                                <option value="3">第3期 (05-06月)</option>
                                <option value="4">第4期 (07-08月)</option>
                                <option value="5">第5期 (09-10月)</option>
                                <option value="6">第6期 (11-12月)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vat-deadline">最晚收取發票日</label>
                            <input type="date" id="vat-deadline">
                        </div>
                    </div>
                    <div class="vat-quick-actions">
                        <button id="load-other-period-btn" class="btn btn-secondary">載入他期作為草稿</button>
                        <button id="vat-history-btn" class="btn btn-secondary">編輯紀錄</button>
                        <button id="vat-backup-btn" class="btn btn-secondary">備份營業稅資料</button>
                        <button id="vat-restore-btn" class="btn btn-secondary">還原備份</button>
                        <button id="m2-json-export" class="btn btn-secondary">匯出 JSON</button>
                        <input type="file" id="m2-json-in" accept=".json" style="display: none;">
                        <button id="m2-json-import-btn" class="btn btn-secondary">匯入 JSON</button>
                    </div>
                </div>
                
                <!-- 營業稅儲存統計 -->
                <div style="margin-top: 1rem; padding: 0.8rem; background: var(--color-surface-light); border-radius: 4px; border-left: 3px solid var(--color-accent-gold);">
                    <div id="vat-storage-stats" style="font-size: 0.8rem; color: var(--color-text-secondary); display: flex; gap: 1rem;">
                        <span>載入中...</span>
                    </div>
                </div>
            </div>

            <!-- 提醒區塊（兩欄） -->
            <div class="vat-reminders-section">
                <div class="vat-reminder-column">
                    <div class="card">
                        <h3 class="reminder-title">今日預計收取 <span id="today-date"></span></h3>
                        <div id="today-reminders" class="reminder-list"></div>
                    </div>
                </div>
                <div class="vat-reminder-column">
                    <div class="card">
                        <h3 class="reminder-title">明日預計收取 <span id="tomorrow-date-range"></span></h3>
                        <div id="tomorrow-reminders" class="reminder-list"></div>
                    </div>
                </div>
            </div>

            <!-- 提醒客人區塊 -->
            <div class="vat-batch-section card">
                <h3>提醒客人（訊息模板 & 批次話術）</h3>
                <div class="batch-controls">
                    <div class="collect-method-filter">
                        <label>收取發票方式：</label>
                        <div id="collect-method-checkboxes" class="checkbox-group"></div>
                        <button id="add-collect-method-btn" class="btn btn-primary btn-small">+ 新增方式</button>
                    </div>
                    <div class="batch-actions">
                        <button id="apply-vat-template-btn" class="btn btn-secondary btn-small">📋 套用訊息模板</button>
                        <button id="generate-batch-message-btn" class="btn btn-secondary btn-small">一鍵產生話術</button>
                        <button id="export-batch-excel-btn" class="btn btn-secondary btn-small">匯出 EXCEL</button>
                    </div>
                </div>
                <div id="batch-message-preview" class="message-preview" style="display: none;"></div>
            </div>

            <!-- 本期資料表格 -->
            <div class="vat-data-section card">
                <div class="section-header-row">
                    <h3>本期資料</h3>
                    <div class="data-actions">
                        <button id="add-vat-row-btn" class="btn btn-primary">+ 新增客戶</button>
                        <button id="export-period-data-btn" class="btn btn-secondary">匯出本期資料</button>
                    </div>
                </div>
                <div class="vat-table-container">
                    <table class="vat-data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-vat"></th>
                                <th class="sortable" data-sort="customer">客戶</th>
                                <th class="sortable" data-sort="method">收取方式</th>
                                <th class="sortable" data-sort="date">預計收取日</th>
                                <th>稅金</th>
                                <th class="sortable" data-sort="note-invoice">備註-發票</th>
                                <th class="sortable" data-sort="note-reminder">備註-提醒</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="vat-data-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="toast-container"></div>

        <!-- patch: 2025-11-09 Advanced Features - Global Search Modal -->
        <div class="modal-overlay" id="global-search-modal" style="display: none;">
            <div class="modal-content global-search-modal">
                <div class="search-input-container">
                    <input type="text" id="global-search-input" 
                           placeholder="搜尋客戶、備註、模板... (Ctrl+K)" 
                           class="global-search-input"
                           autocomplete="off">
                    <span class="search-shortcut-hint">ESC 關閉</span>
                </div>
                
                <div class="search-results" id="global-search-results" style="display: none;">
                    <!-- 動態生成搜尋結果 -->
                </div>
                
                <div class="search-empty-state" id="search-empty-state" style="display: none;">
                    <div class="empty-state-icon">🔍</div>
                    <div class="empty-state-text">找不到符合的結果</div>
                    <div class="empty-state-hint">試試搜尋客戶名稱、聯絡人、電話或標籤</div>
                </div>
                
                <div class="search-initial-state" id="search-initial-state">
                    <div class="empty-state-icon">🔍</div>
                    <div class="empty-state-text">開始搜尋</div>
                    <div class="empty-state-hint">輸入至少 2 個字元開始搜尋</div>
                </div>
            </div>
        </div>

        <!-- patch: 2025-11-09 Settings Page -->
        <div id="page-settings" class="page">
            <h1 class="module-title">系統設定</h1>

            <!-- 一般設定 -->
            <div class="card settings-section">
                <h2 class="settings-section-title">一般設定</h2>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">即將到期提醒天數</div>
                        <div class="settings-item-description">設定多少天內到期的客戶會被標記為「即將到期」</div>
                    </div>
                    <div class="settings-item-control">
                        <input type="number" id="setting-expire-days" class="form-control" min="1" max="365" value="30">
                        <span class="settings-unit">天</span>
                    </div>
                </div>

                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">緊急提醒天數</div>
                        <div class="settings-item-description">設定多少天內到期的客戶會被標記為「緊急」（紅色警示）</div>
                    </div>
                    <div class="settings-item-control">
                        <input type="number" id="setting-urgent-days" class="form-control" min="1" max="30" value="7">
                        <span class="settings-unit">天</span>
                    </div>
                </div>

                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">儀表板時間軸預設範圍</div>
                        <div class="settings-item-description">設定儀表板時間軸預設顯示的天數</div>
                    </div>
                    <div class="settings-item-control">
                        <select id="setting-timeline-days" class="form-control">
                            <option value="30">30 天</option>
                            <option value="60">60 天</option>
                            <option value="90" selected>90 天</option>
                            <option value="120">120 天</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 外觀設定 -->
            <div class="card settings-section">
                <h2 class="settings-section-title">外觀設定</h2>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">主題模式</div>
                        <div class="settings-item-description">選擇應用程式的顯示主題</div>
                    </div>
                    <div class="settings-item-control">
                        <select id="setting-theme" class="form-control">
                            <option value="dark" selected>深色主題</option>
                            <option value="light">淺色主題</option>
                        </select>
                    </div>
                </div>

                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">字體大小</div>
                        <div class="settings-item-description">調整介面文字的大小</div>
                    </div>
                    <div class="settings-item-control">
                        <select id="setting-font-size" class="form-control">
                            <option value="small">小</option>
                            <option value="medium" selected>中</option>
                            <option value="large">大</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 資料管理 -->
            <div class="card settings-section">
                <h2 class="settings-section-title">資料管理</h2>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">自動備份</div>
                        <div class="settings-item-description">啟用後，系統會定期自動備份資料到瀏覽器儲存空間</div>
                    </div>
                    <div class="settings-item-control">
                        <label class="settings-toggle">
                            <input type="checkbox" id="setting-auto-backup" checked>
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">備份頻率</div>
                        <div class="settings-item-description">設定自動備份的時間間隔</div>
                    </div>
                    <div class="settings-item-control">
                        <select id="setting-backup-frequency" class="form-control">
                            <option value="1">每天</option>
                            <option value="3">每 3 天</option>
                            <option value="7" selected>每週</option>
                            <option value="30">每月</option>
                        </select>
                    </div>
                </div>

                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">儲存空間使用情況</div>
                        <div class="settings-item-description">查看目前資料佔用的儲存空間</div>
                    </div>
                    <div class="settings-item-control">
                        <div id="storage-usage-info" class="settings-info-text">計算中...</div>
                    </div>
                </div>

                <div class="settings-actions">
                    <button id="settings-export-all-btn" class="btn btn-secondary btn-icon">
                        <span>📦</span>
                        <span>匯出完整備份</span>
                    </button>
                    <button id="settings-import-backup-btn" class="btn btn-secondary btn-icon">
                        <span>📥</span>
                        <span>匯入備份</span>
                    </button>
                    <button id="settings-clear-all-btn" class="btn btn-danger btn-icon">
                        <span>🗑️</span>
                        <span>清除所有資料</span>
                    </button>
                </div>
            </div>

            <!-- 進階設定 -->
            <div class="card settings-section">
                <h2 class="settings-section-title">進階設定</h2>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">開發者模式</div>
                        <div class="settings-item-description">啟用後會在 Console 顯示詳細的除錯資訊</div>
                    </div>
                    <div class="settings-item-control">
                        <label class="settings-toggle">
                            <input type="checkbox" id="setting-debug-mode">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-label">效能模式</div>
                        <div class="settings-item-description">啟用後會減少動畫效果以提升效能</div>
                    </div>
                    <div class="settings-item-control">
                        <label class="settings-toggle">
                            <input type="checkbox" id="setting-performance-mode">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- 儲存按鈕 -->
            <div class="settings-footer">
                <button id="settings-save-btn" class="btn btn-primary btn-large">
                    💾 儲存設定
                </button>
                <button id="settings-reset-btn" class="btn btn-secondary btn-large">
                    🔄 重設為預設值
                </button>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- CONFIG --- //
            const EXPIRE_SOON_DAYS = 90; // 可調整的到期提醒閾值

            // --- DATA STORAGE FUNCTIONS --- //
            const STORAGE_KEY = 'offline-crm-customers';
            const BACKUP_KEY = 'offline-crm-backup';
            const SETTINGS_KEY = 'offline-crm-settings';
            const TEMPLATES_STORAGE_KEY = 'crm-message-templates'; // patch: 2025-11-08 訊息模板系統

            // 儲存資料到 localStorage（增強版）
            const saveCustomersToStorage = () => {
                try {
                    // 建立備份（保留上一版本）
                    const currentData = localStorage.getItem(STORAGE_KEY);
                    if (currentData) {
                        const backupData = {
                            data: currentData,
                            timestamp: new Date().toISOString(),
                            version: Date.now()
                        };
                        localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
                    }

                    // 儲存新資料（包含元資料）
                    const dataToSave = {
                        customers: customers,
                        lastModified: new Date().toISOString(),
                        version: Date.now(),
                        checksum: generateChecksum(customers)
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                    
                    // 更新儲存統計
                    updateStorageStats();
                    console.log('客戶資料已儲存到本地儲存');
                } catch (error) {
                    console.error('儲存客戶資料失敗:', error);
                    if (error.name === 'QuotaExceededError') {
                        showToast('儲存空間不足！請清理瀏覽器資料或匯出備份', 'error');
                        // 嘗試清理舊備份
                        cleanupOldBackups();
                    } else {
                        showToast('儲存資料失敗，請檢查瀏覽器設定', 'error');
                    }
                }
            };

            // 從 localStorage 載入資料（增強版）
            const loadCustomersFromStorage = () => {
                try {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        
                        // 檢查資料格式（向後相容）
                        if (Array.isArray(parsedData)) {
                            // 舊格式：直接是陣列
                            console.log('從本地儲存載入客戶資料:', parsedData.length, '筆（舊格式）');
                            return parsedData;
                        } else if (parsedData.customers) {
                            // 新格式：包含元資料
                            const customers = parsedData.customers;
                            
                            // 驗證資料完整性
                            if (parsedData.checksum && !verifyChecksum(customers, parsedData.checksum)) {
                                console.warn('資料校驗失敗，嘗試載入備份...');
                                showToast('資料可能損壞，正在載入備份...', 'warning');
                                return loadBackupData();
                            }
                            
                            console.log('從本地儲存載入客戶資料:', customers.length, '筆（', parsedData.lastModified, '）');
                            return customers;
                        }
                    }
                } catch (error) {
                    console.error('載入客戶資料失敗:', error);
                    showToast('載入資料失敗，嘗試載入備份...', 'warning');
                    return loadBackupData();
                }
                return null;
            };

            // 載入備份資料
            const loadBackupData = () => {
                try {
                    const backupData = localStorage.getItem(BACKUP_KEY);
                    if (backupData) {
                        const backup = JSON.parse(backupData);
                        const restoredData = JSON.parse(backup.data);
                        
                        let customers;
                        if (Array.isArray(restoredData)) {
                            customers = restoredData;
                        } else if (restoredData.customers) {
                            customers = restoredData.customers;
                        }
                        
                        if (customers) {
                            showToast(`已從備份載入資料（${new Date(backup.timestamp).toLocaleString()}）`, 'success');
                            return customers;
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('載入備份資料失敗:', error);
                    showToast('載入備份資料也失敗了', 'error');
                    return null;
                }
            };

            // 生成資料校驗碼
            const generateChecksum = (data) => {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 轉換為32位整數
                }
                return hash.toString();
            };

            // 驗證資料校驗碼
            const verifyChecksum = (data, expectedChecksum) => {
                return generateChecksum(data) === expectedChecksum;
            };

            // 儲存使用者設定
            const saveSettings = (settings) => {
                try {
                    const currentSettings = loadSettings();
                    const newSettings = { ...currentSettings, ...settings };
                    localStorage.setItem(SETTINGS_KEY, JSON.stringify(newSettings));
                } catch (error) {
                    console.error('儲存設定失敗:', error);
                }
            };

            // 載入使用者設定
            const loadSettings = () => {
                try {
                    const settings = localStorage.getItem(SETTINGS_KEY);
                    return settings ? JSON.parse(settings) : {
                        autoBackup: true,
                        backupInterval: 24, // 小時
                        theme: 'dark'
                    };
                } catch (error) {
                    console.error('載入設定失敗:', error);
                    return { autoBackup: true, backupInterval: 24, theme: 'dark' };
                }
            };

            // 更新儲存統計資訊
            // patch: 2025-11-09 視覺化儲存統計
            const updateStorageStats = () => {
                try {
                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            totalSize += localStorage[key].length;
                        }
                    }
                    
                    const sizeKB = Math.round(totalSize / 1024);
                    const maxSize = 5120; // 假設最大 5MB
                    const percentage = Math.round((sizeKB / maxSize) * 100);
                    
                    // 更新文字資訊
                    const statsText = document.getElementById('storage-stats-text');
                    if (statsText) {
                        statsText.textContent = `${sizeKB}KB / ${maxSize}KB (${percentage}%) • ${customers.length} 筆客戶`;
                    }
                    
                    // 更新進度條
                    const progressFill = document.getElementById('storage-progress-fill');
                    if (progressFill) {
                        progressFill.style.width = `${percentage}%`;
                        
                        // 根據使用量改變顏色
                        progressFill.classList.remove('warning', 'danger');
                        if (percentage >= 80) {
                            progressFill.classList.add('danger');
                        } else if (percentage >= 60) {
                            progressFill.classList.add('warning');
                        }
                    }
                } catch (error) {
                    console.error('更新儲存統計失敗:', error);
                }
            };

            // 清理舊備份
            const cleanupOldBackups = () => {
                try {
                    // 清理一些不必要的舊資料
                    const keysToCheck = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('temp-') || key.includes('cache-')) {
                            keysToCheck.push(key);
                        }
                    }
                    
                    keysToCheck.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    console.log('已清理', keysToCheck.length, '個暫存項目');
                } catch (error) {
                    console.error('清理備份失敗:', error);
                }
            };

            // 自動備份功能
            const createAutoBackup = () => {
                try {
                    const settings = loadSettings();
                    if (!settings.autoBackup) return;
                    
                    const backupData = {
                        customers: customers,
                        timestamp: new Date().toISOString(),
                        type: 'auto',
                        version: '2.0'
                    };
                    
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `自動備份_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showToast('自動備份已下載', 'success');
                } catch (error) {
                    console.error('自動備份失敗:', error);
                }
            };

            // 預設資料
            const defaultCustomers = [
                { id: "C0001", companyName: "範例股份有限公司", taxId: "12345678", taxAddr: "台北市信義區", contact: "林小姐", phone: "02-1234-5678", regAddr: "台北市信義區示例路 100 號", contactAddr: "台北市信義區示例路 200 號", leaseStart: "2024-01-01", leaseEnd: "2025-01-15", notes: [{ id: `N001`, content: "9/30 已報價，客戶考慮中。", tags: ["報價", "待回覆"], createdAt: "2023-09-30" }] },
                { id: "C0002", companyName: "星塵設計", taxId: "98765432", taxAddr: "台北市大安區", contact: "大衛·鮑伊", phone: "0987-654-321", regAddr: "台北市大安區忠孝東路四段 100 號", contactAddr: "台北市大安區忠孝東路四段 100 號", leaseStart: "2024-03-01", leaseEnd: "2024-06-01", notes: [{ id: `N002`, content: "專案初步討論，對我們的風格很感興趣。", tags: ["潛在客戶", "待回覆"], createdAt: "2023-10-02" }] },
                { id: "C0003", companyName: "未來科技", taxId: "87654321", taxAddr: "新北市板橋區", contact: "李經理", phone: "02-5555-1234", regAddr: "新北市板橋區文化路一段 1 號", contactAddr: "新北市板橋區文化路一段 1 號", leaseStart: "2023-01-01", leaseEnd: "2024-03-01", notes: [] }
            ];

            // --- DATA --- //
            // 初始化客戶資料：優先從本地儲存載入，否則使用預設資料
            let customers = loadCustomersFromStorage() || defaultCustomers;
            let currentlyEditingId = null;
            let currentlyEditingNoteId = null;
            let newNoteTags = [];
            let filterState = { selectedTags: [], logic: 'OR' };

            // patch: 2025-11-08 訊息模板系統 - 核心類別
            // ========================================
            // Template Manager Class
            // ========================================
            class TemplateManager {
                constructor() {
                    this.storageKey = TEMPLATES_STORAGE_KEY;
                    this.templates = [];
                    this.loadTemplates();
                }

                loadTemplates() {
                    try {
                        const data = localStorage.getItem(this.storageKey);
                        this.templates = data ? JSON.parse(data) : [];
                        return this.templates;
                    } catch (error) {
                        console.error('載入模板失敗:', error);
                        this.templates = [];
                        return [];
                    }
                }

                saveTemplates() {
                    try {
                        localStorage.setItem(this.storageKey, JSON.stringify(this.templates));
                        return true;
                    } catch (error) {
                        console.error('儲存模板失敗:', error);
                        if (error.name === 'QuotaExceededError') {
                            showToast('儲存空間不足！', 'error');
                        }
                        return false;
                    }
                }

                addTemplate(template) {
                    const newTemplate = {
                        id: template.id || `template-${Date.now()}`, // patch: 2025-11-08 允許自訂 ID
                        name: template.name,
                        content: template.content,
                        description: template.description || '',
                        platform: template.platform || 'LINE', // patch: 2025-11-08 訊息平台
                        subject: template.subject || '', // patch: 2025-11-08 Mail 主旨
                        category: template.category || 'general', // patch: 2025-11-08 模板類別
                        createdAt: template.createdAt || new Date().toISOString(),
                        updatedAt: template.updatedAt || new Date().toISOString(),
                        usageCount: template.usageCount || 0
                    };
                    this.templates.push(newTemplate);
                    this.saveTemplates();
                    return newTemplate;
                }

                updateTemplate(id, updates) {
                    const index = this.templates.findIndex(t => t.id === id);
                    if (index !== -1) {
                        this.templates[index] = {
                            ...this.templates[index],
                            ...updates,
                            updatedAt: new Date().toISOString()
                        };
                        this.saveTemplates();
                        return this.templates[index];
                    }
                    return null;
                }

                deleteTemplate(id) {
                    const index = this.templates.findIndex(t => t.id === id);
                    if (index !== -1) {
                        this.templates.splice(index, 1);
                        this.saveTemplates();
                        return true;
                    }
                    return false;
                }

                getTemplate(id) {
                    return this.templates.find(t => t.id === id);
                }

                incrementUsage(id) {
                    const template = this.getTemplate(id);
                    if (template) {
                        template.usageCount = (template.usageCount || 0) + 1;
                        template.updatedAt = new Date().toISOString();
                        this.saveTemplates();
                    }
                }

                exportTemplates() {
                    const data = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        templates: this.templates
                    };
                    return JSON.stringify(data, null, 2);
                }

                importTemplates(jsonData) {
                    try {
                        const data = JSON.parse(jsonData);
                        const imported = data.templates || [];
                        const conflicts = [];
                        const newTemplates = [];

                        imported.forEach(template => {
                            const existing = this.templates.find(t => t.id === template.id);
                            if (existing) {
                                conflicts.push({ existing, imported: template });
                            } else {
                                newTemplates.push(template);
                            }
                        });

                        return { conflicts, newTemplates, success: true };
                    } catch (error) {
                        return { success: false, error: 'JSON 格式錯誤' };
                    }
                }

                mergeTemplates(newTemplates, overwriteConflicts = false) {
                    if (overwriteConflicts) {
                        newTemplates.forEach(template => {
                            const index = this.templates.findIndex(t => t.id === template.id);
                            if (index !== -1) {
                                this.templates[index] = template;
                            } else {
                                this.templates.push(template);
                            }
                        });
                    } else {
                        this.templates.push(...newTemplates);
                    }
                    this.saveTemplates();
                }
            }

            // ========================================
            // Tag System Class
            // ========================================
            class TagSystem {
                constructor(customers, vatData = null) {
                    this.customers = customers;
                    this.vatData = vatData; // patch: 2025-11-08 營業稅資料
                    this.fieldMapping = {
                        'id': '客戶代號',
                        'companyName': '公司名稱',
                        'contact': '聯絡人',
                        'phone': '電話',
                        'taxId': '統一編號',
                        'taxAddr': '稅籍編號',
                        'regAddr': '設籍地址',
                        'contactAddr': '聯絡地址',
                        'leaseStart': '租約起日',
                        'leaseEnd': '租約迄日',
                        'bookkeepingFee': '記帳費', // patch: 2025-11-08
                        // patch: 2025-11-08 營業稅專用標籤
                        'vat_period': '營業稅期數',
                        'vat_year': '營業稅年度',
                        'vat_deadline': '最晚收取發票日',
                        'vat_deadline_minus2': '最晚收取日-2天',
                        'vat_collect_method': '收取方式',
                        'vat_planned_date': '預計收取日',
                        'vat_tax_amount': '稅金',
                        'vat_note_invoice': '備註-發票',
                        'vat_note_reminder': '備註-提醒'
                    };
                    this.excludeFields = ['notes'];
                }

                getAvailableFields(includeVatFields = false) {
                    let fields = [];
                    
                    // 客戶欄位
                    if (this.customers.length === 0) {
                        fields = Object.keys(this.fieldMapping)
                            .filter(key => !key.startsWith('vat_'))
                            .map(key => ({
                                field: key,
                                label: this.fieldMapping[key],
                                tag: `{{${key}}}`,
                                category: 'customer'
                            }));
                    } else {
                        const firstCustomer = this.customers[0];
                        fields = Object.keys(firstCustomer)
                            .filter(key => !this.excludeFields.includes(key))
                            .map(key => ({
                                field: key,
                                label: this.fieldMapping[key] || key,
                                tag: `{{${key}}}`,
                                category: 'customer'
                            }));
                    }
                    
                    // patch: 2025-11-08 營業稅欄位
                    if (includeVatFields) {
                        const vatFields = Object.keys(this.fieldMapping)
                            .filter(key => key.startsWith('vat_'))
                            .map(key => ({
                                field: key,
                                label: this.fieldMapping[key],
                                tag: `{{${key}}}`,
                                category: 'vat'
                            }));
                        fields = fields.concat(vatFields);
                    }

                    return fields;
                }

                replaceTagsInTemplate(template, customer, vatRow = null) {
                    let result = template;
                    const tagRegex = /\{\{(\w+)\}\}/g;
                    
                    // patch: 2025-11-09 除錯日誌
                    console.log('=== replaceTagsInTemplate 開始 ===');
                    console.log('this.vatData:', this.vatData);
                    console.log('customer:', customer);
                    console.log('vatRow:', vatRow);
                    console.log('template:', template);
                    
                    result = result.replace(tagRegex, (match, fieldName) => {
                        console.log(`處理標籤: ${match}, fieldName: ${fieldName}`);
                        
                        // 優先處理客戶欄位
                        if (customer.hasOwnProperty(fieldName)) {
                            const value = customer[fieldName];
                            console.log(`  -> 客戶欄位: ${fieldName} = ${value}`);
                            return value !== null && value !== undefined ? String(value) : '';
                        }
                        
                        // patch: 2025-11-08 處理營業稅欄位
                        if (fieldName.startsWith('vat_')) {
                            console.log(`  -> 營業稅欄位: ${fieldName}`);
                            console.log(`  -> this.vatData 存在: ${!!this.vatData}`);
                            
                            if (!this.vatData) {
                                console.warn(`  -> this.vatData 為 null，無法替換 ${fieldName}`);
                                return match;
                            }
                            
                            const vatField = fieldName.replace('vat_', '');
                            console.log(`  -> vatField: ${vatField}`);
                            
                            switch (vatField) {
                                case 'period':
                                    const periodValue = this.vatData.period ? `${this.vatData.period}` : '';
                                    console.log(`  -> period 值: ${periodValue}`);
                                    return periodValue;
                                case 'year':
                                    const yearValue = this.vatData.year ? `${this.vatData.year}` : '';
                                    console.log(`  -> year 值: ${yearValue}`);
                                    return yearValue;
                                case 'deadline':
                                    const deadlineValue = this.vatData.last_collect_deadline || '';
                                    console.log(`  -> deadline 值: ${deadlineValue}`);
                                    return deadlineValue;
                                case 'deadline_minus2':
                                    const deadline2Value = this.vatData.last_collect_deadline ? getDateMinus2(this.vatData.last_collect_deadline) : '';
                                    console.log(`  -> deadline_minus2 值: ${deadline2Value}`);
                                    return deadline2Value;
                                case 'collect_method':
                                    const methodValue = vatRow ? (vatRow.collect_method || '') : '';
                                    console.log(`  -> collect_method 值: ${methodValue}`);
                                    return methodValue;
                                case 'planned_date':
                                    const dateValue = vatRow ? (vatRow.planned_collect_date || '') : '';
                                    console.log(`  -> planned_date 值: ${dateValue}`);
                                    return dateValue;
                                case 'tax_amount':
                                    const taxValue = vatRow ? (vatRow.tax_amount || '') : '';
                                    console.log(`  -> tax_amount 值: ${taxValue}`);
                                    return taxValue;
                                case 'note_invoice':
                                    const invoiceValue = vatRow ? (vatRow.note_invoice || '') : '';
                                    console.log(`  -> note_invoice 值: ${invoiceValue}`);
                                    return invoiceValue;
                                case 'note_reminder':
                                    const reminderValue = vatRow ? (vatRow.note_reminder ? `\n${vatRow.note_reminder}` : '') : '';
                                    console.log(`  -> note_reminder 值: ${reminderValue}`);
                                    return reminderValue;
                                default:
                                    console.log(`  -> 未知的營業稅欄位: ${vatField}`);
                                    return match;
                            }
                        }
                        
                        console.log(`  -> 未處理的標籤: ${match}`);
                        return match;
                    });
                    
                    console.log('=== replaceTagsInTemplate 結束 ===');
                    console.log('result:', result);
                    console.log('');
                    

                    return result;
                }

                generateMessages(template, customers, vatRows = null) {
                    // patch: 2025-11-09 確保 this 綁定正確
                    console.log('generateMessages - this.vatData:', this.vatData);
                    
                    return customers.map((customer) => {
                        // patch: 2025-11-08 尋找對應的營業稅資料
                        const vatRow = vatRows ? vatRows.find(row => row.customer_id === customer.id) : null;
                        
                        console.log('generateMessages - 處理客戶:', customer.companyName || customer.id);
                        console.log('generateMessages - this.vatData (map 內):', this.vatData);
                        
                        return {
                            customer: customer,
                            message: this.replaceTagsInTemplate(template, customer, vatRow)
                        };
                    });
                }

                validateTags(template) {
                    const tagRegex = /\{\{(\w+)\}\}/g;
                    const tags = [];
                    let match;

                    while ((match = tagRegex.exec(template)) !== null) {
                        tags.push(match[1]);
                    }

                    const availableFields = this.getAvailableFields().map(f => f.field);
                    const invalidTags = tags.filter(tag => !availableFields.includes(tag));

                    return {
                        allTags: tags,
                        validTags: tags.filter(tag => availableFields.includes(tag)),
                        invalidTags: invalidTags
                    };
                }
            }

            // ========================================
            // patch: 2025-11-09 Advanced Features
            // Tag Manager Class
            // ========================================
            class TagManager {
                constructor() {
                    this.storageKey = 'crm-tag-definitions';
                    this.tags = this.loadTags();
                }
                
                loadTags() {
                    try {
                        const stored = localStorage.getItem(this.storageKey);
                        if (stored) {
                            return JSON.parse(stored);
                        }
                    } catch (error) {
                        console.error('載入標籤定義失敗:', error);
                    }
                    return this.getDefaultTags();
                }
                
                getDefaultTags() {
                    return [
                        { id: 'vip', name: 'VIP', color: '#D4AF37', createdAt: new Date().toISOString(), usageCount: 0 },
                        { id: 'important', name: '重要', color: '#E57373', createdAt: new Date().toISOString(), usageCount: 0 },
                        { id: 'follow-up', name: '需追蹤', color: '#64B5F6', createdAt: new Date().toISOString(), usageCount: 0 }
                    ];
                }
                
                saveTags() {
                    try {
                        localStorage.setItem(this.storageKey, JSON.stringify(this.tags));
                        return true;
                    } catch (error) {
                        console.error('儲存標籤定義失敗:', error);
                        return false;
                    }
                }
                
                createTag(name, color) {
                    if (this.getTagByName(name)) {
                        return { success: false, error: '標籤名稱已存在' };
                    }
                    
                    const id = `tag-${Date.now()}`;
                    const tag = {
                        id,
                        name,
                        color: color || this.getRandomColor(),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        usageCount: 0
                    };
                    this.tags.push(tag);
                    this.saveTags();
                    return { success: true, tag };
                }
                
                updateTag(id, updates) {
                    const tag = this.tags.find(t => t.id === id);
                    if (!tag) return false;
                    
                    Object.assign(tag, updates, {
                        updatedAt: new Date().toISOString()
                    });
                    
                    this.saveTags();
                    return true;
                }
                
                deleteTag(id) {
                    const index = this.tags.findIndex(t => t.id === id);
                    if (index === -1) return false;
                    
                    this.tags.splice(index, 1);
                    this.saveTags();
                    return true;
                }
                
                getTagByName(name) {
                    return this.tags.find(t => t.name === name);
                }
                
                getTagById(id) {
                    return this.tags.find(t => t.id === id);
                }
                
                updateUsageCount(tagName, delta = 1) {
                    const tag = this.getTagByName(tagName);
                    if (tag) {
                        tag.usageCount = (tag.usageCount || 0) + delta;
                        this.saveTags();
                    }
                }
                
                getRandomColor() {
                    const colors = [
                        '#D4AF37', '#E57373', '#64B5F6', '#81C784',
                        '#FFB74D', '#BA68C8', '#4DB6AC', '#FF8A65'
                    ];
                    return colors[Math.floor(Math.random() * colors.length)];
                }
                
                getAllTags() {
                    return [...this.tags];
                }
            }

            // ========================================
            // patch: 2025-11-09 Advanced Features
            // Settings Manager Class
            // ========================================
            class SettingsManager {
                constructor() {
                    this.storageKey = 'crm-system-settings';
                    this.settings = this.loadSettings();
                }
                
                loadSettings() {
                    try {
                        const stored = localStorage.getItem(this.storageKey);
                        if (stored) {
                            return { ...this.getDefaultSettings(), ...JSON.parse(stored) };
                        }
                    } catch (error) {
                        console.error('載入設定失敗:', error);
                    }
                    return this.getDefaultSettings();
                }
                
                getDefaultSettings() {
                    return {
                        general: {
                            expiringSoonDays: 90,
                            language: 'zh-TW',
                            dateFormat: 'YYYY-MM-DD'
                        },
                        appearance: {
                            theme: 'dark',
                            fontSize: 'medium',
                            compactMode: false
                        },
                        notifications: {
                            showExpiring: true,
                            showVATReminders: true,
                            soundEnabled: false
                        },
                        data: {
                            autoBackup: false,
                            backupFrequency: 'weekly',
                            maxBackups: 5
                        }
                    };
                }
                
                saveSettings() {
                    try {
                        localStorage.setItem(this.storageKey, JSON.stringify(this.settings));
                        return true;
                    } catch (error) {
                        console.error('儲存設定失敗:', error);
                        return false;
                    }
                }
                
                updateSetting(category, key, value) {
                    if (this.settings[category]) {
                        this.settings[category][key] = value;
                        this.saveSettings();
                        return true;
                    }
                    return false;
                }
                
                getSetting(category, key) {
                    return this.settings[category]?.[key];
                }
                
                resetToDefaults() {
                    this.settings = this.getDefaultSettings();
                    this.saveSettings();
                    return true;
                }
                
                exportSettings() {
                    const dataStr = JSON.stringify(this.settings, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `crm-settings-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                }
                
                importSettings(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const imported = JSON.parse(e.target.result);
                                this.settings = { ...this.getDefaultSettings(), ...imported };
                                this.saveSettings();
                                resolve(true);
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                }
            }

            // ========================================
            // patch: 2025-11-09 Advanced Features
            // Global Search Class
            // ========================================
            class GlobalSearch {
                constructor(customers, templates) {
                    this.customers = customers;
                    this.templates = templates;
                    this.searchIndex = null;
                }
                
                buildSearchIndex() {
                    const index = {
                        customers: [],
                        notes: [],
                        templates: []
                    };
                    
                    // 索引客戶
                    this.customers.forEach(customer => {
                        const searchText = [
                            customer.companyName,
                            customer.contact,
                            customer.phone,
                            customer.email,
                            customer.regAddr,
                            customer.contactAddr,
                            customer.taxId,
                            ...(customer.tags || [])
                        ].filter(Boolean).join(' ').toLowerCase();
                        
                        index.customers.push({
                            id: customer.id,
                            searchText,
                            type: 'customer',
                            data: customer
                        });
                        
                        // 索引備註
                        if (customer.notes && customer.notes.length > 0) {
                            customer.notes.forEach(note => {
                                const noteSearchText = [
                                    note.content,
                                    ...(note.tags || [])
                                ].filter(Boolean).join(' ').toLowerCase();
                                
                                index.notes.push({
                                    id: note.id,
                                    customerId: customer.id,
                                    searchText: noteSearchText,
                                    type: 'note',
                                    data: { ...note, customerName: customer.companyName, customerId: customer.id }
                                });
                            });
                        }
                    });
                    
                    // 索引模板
                    this.templates.forEach(template => {
                        const searchText = [
                            template.name,
                            template.description,
                            template.content,
                            template.platform
                        ].filter(Boolean).join(' ').toLowerCase();
                        
                        index.templates.push({
                            id: template.id,
                            searchText,
                            type: 'template',
                            data: template
                        });
                    });
                    
                    this.searchIndex = index;
                    return index;
                }
                
                search(query) {
                    if (!query || query.length < 2) {
                        return { customers: [], notes: [], templates: [], total: 0 };
                    }
                    
                    if (!this.searchIndex) {
                        this.buildSearchIndex();
                    }
                    
                    const lowerQuery = query.toLowerCase();
                    const results = {
                        customers: [],
                        notes: [],
                        templates: [],
                        total: 0
                    };
                    
                    // 搜尋客戶
                    results.customers = this.searchIndex.customers
                        .filter(item => item.searchText.includes(lowerQuery))
                        .slice(0, 10)
                        .map(item => item.data);
                    
                    // 搜尋備註
                    results.notes = this.searchIndex.notes
                        .filter(item => item.searchText.includes(lowerQuery))
                        .slice(0, 10)
                        .map(item => item.data);
                    
                    // 搜尋模板
                    results.templates = this.searchIndex.templates
                        .filter(item => item.searchText.includes(lowerQuery))
                        .slice(0, 10)
                        .map(item => item.data);
                    
                    results.total = results.customers.length + results.notes.length + results.templates.length;
                    
                    return results;
                }
                
                refreshIndex() {
                    this.buildSearchIndex();
                }
            }

            // 初始化模板管理器和標籤系統
            const templateManager = new TemplateManager();
            const tagSystem = new TagSystem(customers);
            const tagManager = new TagManager(); // patch: 2025-11-09
            const settingsManager = new SettingsManager(); // patch: 2025-11-09
            let globalSearch = null; // patch: 2025-11-09 延遲初始化
            
            // patch: 2025-11-08 初始化預設營業稅模板
            function initializeDefaultVatTemplates() {
                const templates = templateManager.loadTemplates();
                const hasVatTemplates = templates.some(t => t.category === 'vat');
                
                if (!hasVatTemplates) {
                    const defaultVatTemplates = [
                        {
                            id: 'vat-template-self-send',
                            name: '營業稅提醒 - 自己寄送',
                            description: '用於提醒客戶自己寄送發票',
                            category: 'vat',
                            platform: 'LINE',
                            content: `{{contact}}您好：

提醒您，本期（第{{vat_period}}期）營業稅即將開始申報囉！

請您務必於{{vat_deadline_minus2}}前備妥所有進項、銷項發票及相關憑證（含作廢發票、進口報單等），並準備好交付本所。{{vat_note_reminder}}

謝謝`,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            usageCount: 0
                        },
                        {
                            id: 'vat-template-pickup',
                            name: '營業稅提醒 - 到府收取',
                            description: '用於約定到府收取發票的時間',
                            category: 'vat',
                            platform: 'LINE',
                            content: `{{contact}}您好：

提醒您，本期（第{{vat_period}}期）營業稅即將開始申報囉！

請問{{vat_deadline_minus2}}前的哪個時段過去貴公司收取資料比較方便呢？

請提供您方便的確切日期與時間，會盡快為您安排過去收取。`,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            usageCount: 0
                        },
                        {
                            id: 'vat-template-tomorrow',
                            name: '明日預計收取提醒',
                            description: '用於提醒明日預計收取發票的客戶',
                            category: 'vat',
                            platform: 'LINE',
                            content: `{{contact}}您好：

提醒您，明日（{{vat_planned_date}}）預計前往貴公司收取第{{vat_period}}期營業稅發票。

收取方式：{{vat_collect_method}}{{vat_note_reminder}}

如有任何變更，請提前告知，謝謝！`,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            usageCount: 0
                        }
                    ];
                    
                    defaultVatTemplates.forEach(template => {
                        templateManager.addTemplate(template);
                    });
                    
                    console.log('已載入預設營業稅模板');
                }
            }

            // UI狀態物件
            let uiState = {
                activeTab: 'page-list',
                expiringSort: 'days-asc',
                expiringFilter: 'all',
                reminderCardOpenForId: null,
                scrollPosition: 0
            };

            // patch: 2025-11-09 DOM 操作防呆機制
            const doc = (id, silent = false) => {
                const el = document.getElementById(id);
                if (!el && !silent) {
                    console.warn(`Element not found: #${id}`);
                }
                return el;
            };

            const safeQuerySelector = (selector) => {
                const el = document.querySelector(selector);
                if (!el) {
                    console.warn(`Element not found: ${selector}`);
                }
                return el;
            };

            const safeAddEventListener = (elementOrId, event, handler) => {
                const el = typeof elementOrId === 'string' ? doc(elementOrId) : elementOrId;
                if (el) {
                    el.removeEventListener(event, handler);
                    el.addEventListener(event, handler);
                }
            };

            // patch: 2025-11-09 操作下拉選單功能
            window.toggleActionMenu = (event, customerId) => {
                event.stopPropagation();
                const menu = doc(`action-menu-${customerId}`);
                if (!menu) return;
                
                // 關閉其他所有選單
                document.querySelectorAll('.action-dropdown-menu.show').forEach(m => {
                    if (m.id !== `action-menu-${customerId}`) {
                        m.classList.remove('show');
                    }
                });
                
                // 切換當前選單
                menu.classList.toggle('show');
            };

            // 點擊外部關閉選單
            document.addEventListener('click', () => {
                document.querySelectorAll('.action-dropdown-menu.show').forEach(m => {
                    m.classList.remove('show');
                });
            });
            const ui = {
                list: doc('page-list'), form: doc('page-form'), notes: doc('page-notes'),
                tabList: doc('tab-list'),
                customerBody: doc('customer-list-body'), formContainer: doc('form-container'),
                notesList: doc('notes-list'), tagFilterBar: doc('tag-filter-bar'),
                filterLogicSwitcher: doc('filter-logic-switcher'), filterStatusBar: doc('filter-status-bar'), clearFilterBtn: doc('clear-filter-btn'),
                expiringCustomersList: doc('expiring-customers-list'), exportExpiringCsvBtn: doc('export-expiring-csv-btn'),
                reminderCard: doc('reminder-card'), reminderTextDisplay: doc('reminder-text-display'), copyReminderBtn: doc('copy-reminder-btn')
            };

            // --- UTILITIES --- //
            // patch: 2025-11-09 改進的 Toast 通知系統（向後相容）
            const showToast = (titleOrMessage, messageOrType = '', typeOrDuration = 'success', duration = 3000) => {
                const toastContainer = doc('toast-container');
                if (!toastContainer) {
                    console.warn('Toast container not found');
                    return;
                }
                
                // 向後相容：檢測舊的呼叫方式 showToast(message, type)
                let title, message, type;
                if (typeof messageOrType === 'string' && ['success', 'error', 'info', 'warning'].includes(messageOrType)) {
                    // 舊格式：showToast(message, type)
                    title = titleOrMessage;
                    message = '';
                    type = messageOrType;
                } else {
                    // 新格式：showToast(title, message, type, duration)
                    title = titleOrMessage;
                    message = messageOrType;
                    type = typeOrDuration;
                }
                
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                const icons = {
                    success: '✓',
                    error: '✕',
                    info: 'ℹ',
                    warning: '⚠'
                };
                
                toast.innerHTML = `
                    <div class="toast-icon">${icons[type] || icons.info}</div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        ${message ? `<div class="toast-message">${message}</div>` : ''}
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('hiding');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            };

            // patch: 2025-11-09 Loading 指示器系統
            const showLoading = (text = '處理中...') => {
                // 移除現有的 loading overlay（如果有）
                hideLoading();
                
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.id = 'loading-overlay';
                overlay.innerHTML = `
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">${text}</div>
                    </div>
                `;
                document.body.appendChild(overlay);
            };

            const hideLoading = () => {
                const overlay = document.getElementById('loading-overlay');
                if (overlay && overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            };
            const TAG_COLORS = ['#4A69BD', '#58B19F', '#F8C291', '#EAB543', '#9A6324', '#82589F', '#E06C9F'];
            const getTagColor = (tag) => { let hash = 0; for (let i = 0; i < tag.length; i++) { hash = tag.charCodeAt(i) + ((hash << 5) - hash); } return TAG_COLORS[Math.abs(hash) % TAG_COLORS.length]; };
            const normalizeTag = (tag) => tag.trim().toLowerCase();
            const toROCDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return '無效日期'; // 新增錯誤處理
                return `${date.getFullYear() - 1911}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            };
            const getDaysRemaining = (endDateStr) => {
                if (!endDateStr) return Infinity;
                const endDate = new Date(endDateStr);
                if (isNaN(endDate.getTime())) return -99999; // 或定義一個錯誤狀態值
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffTime = endDate.getTime() - today.getTime();
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };

            // patch: 2025-11-08 訊息模板系統 - 渲染函數
            // ========================================
            // Template Rendering Functions
            // ========================================
            
            function renderTemplateList() {
                const container = doc('templates-container');
                if (!container) return;

                const templates = templateManager.templates;

                // 始終顯示工具列
                const headerHtml = `
                    <div class="template-list-header">
                        <h2 class="module-title">訊息模板</h2>
                        <div class="template-actions">
                            <button id="add-template-btn" class="btn btn-primary">+ 新增模板</button>
                            <button id="export-templates-btn" class="btn btn-secondary">匯出模板</button>
                            <button id="import-templates-btn" class="btn btn-secondary">匯入模板</button>
                        </div>
                    </div>
                `;

                if (templates.length === 0) {
                    container.innerHTML = headerHtml + `
                        <div class="empty-state">
                            <div class="empty-state-icon">📝</div>
                            <div class="empty-state-text">尚未建立任何訊息模板</div>
                            <div class="empty-state-hint">點擊上方「+ 新增模板」開始建立您的第一個模板</div>
                        </div>
                    `;
                } else {
                    const html = headerHtml + `
                        <div class="template-grid">
                            ${templates.map(template => `
                                <div class="card template-card" data-template-id="${template.id}">
                                    <div class="template-card-header">
                                        <h3 class="template-name">${escapeHTML(template.name)}</h3>
                                        <div class="template-meta">
                                            <span class="template-platform-badge">${escapeHTML(template.platform || 'LINE')}</span>
                                            <span>使用 ${template.usageCount || 0} 次</span>
                                            <span>${new Date(template.updatedAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                    <div class="template-card-body">
                                        <p class="template-description">${escapeHTML(template.description || '無描述')}</p>
                                        ${template.platform === 'Mail' && template.subject ? `<p class="template-subject">主旨: ${escapeHTML(template.subject)}</p>` : ''}
                                        <div class="message-preview-box">
                                            <div class="template-preview">${escapeHTML(template.content.substring(0, 100))}${template.content.length > 100 ? '...' : ''}</div>
                                        </div>
                                    </div>
                                    <div class="template-card-actions">
                                        <button class="btn btn-primary btn-small btn-select-customers" data-id="${template.id}">選取客戶</button>
                                        <button class="btn btn-secondary btn-small btn-edit-template" data-id="${template.id}">編輯</button>
                                        <button class="btn btn-secondary btn-small btn-preview-template" data-id="${template.id}">預覽</button>
                                        <button class="btn btn-danger btn-small btn-delete-template" data-id="${template.id}">刪除</button>
                                    </div>
                                    <div class="template-customer-preview" id="customer-preview-${template.id}" style="display: none;">
                                        <div class="customer-preview-header">
                                            <span>客戶訊息預覽</span>
                                            <button class="btn btn-secondary btn-small btn-close-preview" data-id="${template.id}">收起</button>
                                        </div>
                                        <div class="customer-preview-list" id="customer-preview-list-${template.id}"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.innerHTML = html;
                }

                // 綁定按鈕事件
                setupTemplateListEvents();
            }

            function showTemplateEditorModal(template = null) {
                const isEdit = template !== null;
                const platform = template?.platform || 'LINE';
                const category = template?.category || 'general'; // patch: 2025-11-08
                
                const html = `
                    <div class="modal-overlay" id="template-editor-modal">
                        <div class="modal-content template-editor-modal">
                            <h3>${isEdit ? '編輯模板' : '新增模板'}</h3>
                            
                            <form id="template-form">
                                <div class="form-group">
                                    <label for="template-name">模板名稱 *</label>
                                    <input type="text" id="template-name" value="${template?.name || ''}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="template-description">模板描述</label>
                                    <input type="text" id="template-description" value="${template?.description || ''}" placeholder="選填">
                                </div>
                                
                                <div class="form-group">
                                    <label for="template-category">模板類別 *</label>
                                    <select id="template-category" required>
                                        <option value="general" ${category === 'general' ? 'selected' : ''}>一般模板</option>
                                        <option value="vat" ${category === 'vat' ? 'selected' : ''}>營業稅模板</option>
                                    </select>
                                    <div class="template-help-text" style="margin-top: 0.3rem; font-size: 0.85rem; color: var(--color-text-secondary);">
                                        💡 選擇「營業稅模板」可使用營業稅專用標籤（如期數、最晚收取日等）
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="template-platform">訊息平台 *</label>
                                    <select id="template-platform" required>
                                        <option value="LINE" ${platform === 'LINE' ? 'selected' : ''}>LINE</option>
                                        <option value="Mail" ${platform === 'Mail' ? 'selected' : ''}>Mail</option>
                                        <option value="SMS" ${platform === 'SMS' ? 'selected' : ''}>SMS</option>
                                        <option value="WhatsApp" ${platform === 'WhatsApp' ? 'selected' : ''}>WhatsApp</option>
                                        <option value="其他" ${platform === '其他' ? 'selected' : ''}>其他</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="subject-group" style="display: ${platform === 'Mail' ? 'flex' : 'none'};">
                                    <label for="template-subject">Mail 主旨</label>
                                    <div class="template-content-toolbar">
                                        <button type="button" id="insert-tag-subject-btn" class="btn btn-secondary btn-small">
                                            插入標籤
                                        </button>
                                    </div>
                                    <input type="text" id="template-subject" value="${template?.subject || ''}" placeholder="可使用 {{標籤}}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="template-content">模板內容 *</label>
                                    <div class="template-content-toolbar">
                                        <button type="button" id="insert-tag-btn" class="btn btn-secondary btn-small">
                                            插入標籤
                                        </button>
                                        <button type="button" id="preview-template-btn" class="btn btn-secondary btn-small">
                                            預覽
                                        </button>
                                    </div>
                                    <textarea id="template-content" rows="10" required>${template?.content || ''}</textarea>
                                    <div class="template-help-text">
                                        使用 {{標籤}} 格式插入客戶資料，點擊「插入標籤」查看可用欄位
                                    </div>
                                </div>
                                
                                <div class="modal-actions">
                                    <button type="submit" class="btn btn-primary">儲存</button>
                                    <button type="button" class="btn btn-secondary" id="cancel-template-btn">取消</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
                
                // 綁定事件
                setupTemplateEditorEvents(template);
            }

            function showTagSelector(insertCallback, includeVatFields = false) {
                const fields = tagSystem.getAvailableFields(includeVatFields);
                
                // patch: 2025-11-08 分組顯示標籤
                const customerFields = fields.filter(f => f.category === 'customer');
                const vatFields = fields.filter(f => f.category === 'vat');
                
                const html = `
                    <div class="modal-overlay" id="tag-selector-modal">
                        <div class="modal-content tag-selector-modal">
                            <div class="modal-header">
                                <h3 class="modal-title">插入標籤</h3>
                                <button type="button" class="modal-close-btn" id="close-tag-selector">✕</button>
                            </div>
                            <div style="margin-bottom: 1rem; padding: 0.8rem; background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--color-accent-gold); border-radius: 4px; font-size: 0.85rem; color: var(--color-text-secondary);">
                                💡 點擊標籤即可插入到游標位置
                            </div>
                            <div class="tag-selector-search">
                                <input type="text" id="tag-search" placeholder="🔍 搜尋欄位名稱..." class="search-input">
                            </div>
                            <div class="tag-list">
                                ${customerFields.length > 0 ? `
                                    <div class="tag-category-header">客戶資料</div>
                                    ${customerFields.map(field => `
                                        <div class="tag-option" data-field="${field.field}">
                                            <span class="tag-label">${field.label}</span>
                                            <span class="tag-format">${field.tag}</span>
                                        </div>
                                    `).join('')}
                                ` : ''}
                                ${vatFields.length > 0 ? `
                                    <div class="tag-category-header" style="margin-top: 1rem;">營業稅資料</div>
                                    ${vatFields.map(field => `
                                        <div class="tag-option" data-field="${field.field}">
                                            <span class="tag-label">${field.label}</span>
                                            <span class="tag-format">${field.tag}</span>
                                        </div>
                                    `).join('')}
                                ` : ''}
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" id="cancel-tag-selector">取消</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
                
                // 綁定點擊事件
                document.querySelectorAll('.tag-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const field = option.dataset.field;
                        const tag = `{{${field}}}`;
                        insertCallback(tag);
                        const modal = doc('tag-selector-modal');
                        if (modal) modal.remove();
                    });
                });
                
                // 搜尋功能
                const searchInput = doc('tag-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        document.querySelectorAll('.tag-option').forEach(option => {
                            const label = option.querySelector('.tag-label').textContent.toLowerCase();
                            option.style.display = label.includes(searchTerm) ? 'flex' : 'none';
                        });
                    });
                }

                // patch: 2025-11-09 關閉按鈕
                const closeBtn = doc('close-tag-selector');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        const modal = doc('tag-selector-modal');
                        if (modal) modal.remove();
                    });
                }

                // 取消按鈕
                const cancelBtn = doc('cancel-tag-selector');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        const modal = doc('tag-selector-modal');
                        if (modal) modal.remove();
                    });
                }

                // 點擊背景關閉
                const modal = doc('tag-selector-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                }
                
                // patch: 2025-11-09 ESC 鍵關閉
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        const modal = doc('tag-selector-modal');
                        if (modal) {
                            modal.remove();
                            document.removeEventListener('keydown', handleEsc);
                        }
                    }
                };
                document.addEventListener('keydown', handleEsc);
            }

            function showMessagePreviewModal(messages) {
                const html = `
                    <div class="modal-overlay" id="message-preview-modal">
                        <div class="modal-content message-preview-modal">
                            <div class="modal-header">
                                <h3>訊息預覽 (${messages.length} 筆)</h3>
                                <button type="button" class="btn btn-primary" id="copy-all-messages">全部複製</button>
                            </div>
                            
                            <div class="message-list">
                                ${messages.map((msg, index) => `
                                    <div class="message-item">
                                        <div class="message-header">
                                            <span class="message-number">#${index + 1}</span>
                                            <span class="customer-info">
                                                ${escapeHTML(msg.customer.companyName || msg.customer.id)}
                                                ${msg.customer.contact ? `- ${escapeHTML(msg.customer.contact)}` : ''}
                                            </span>
                                            <button class="btn btn-small btn-copy-message" data-index="${index}">複製</button>
                                        </div>
                                        <div class="message-content">
${escapeHTML(msg.message)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" id="close-preview">關閉</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
                
                // 綁定複製事件
                setupMessageCopyEvents(messages);
            }

            // patch: 2025-11-08 客戶選擇器（用於模板預覽）
            function showCustomerSelectorForTemplate(templateId) {
                const template = templateManager.getTemplate(templateId);
                if (!template) return;

                const html = `
                    <div class="modal-overlay" id="customer-selector-modal">
                        <div class="modal-content template-selector-modal">
                            <h3>選擇要預覽的客戶</h3>
                            <div class="customer-selector-search">
                                <input type="text" id="customer-selector-search" placeholder="搜尋客戶..." class="search-input">
                            </div>
                            <div class="customer-selector-list">
                                ${customers.map(customer => `
                                    <div class="customer-selector-item">
                                        <input type="checkbox" class="customer-checkbox customer-selector-checkbox" 
                                               data-customer-id="${customer.id}" id="cust-${customer.id}">
                                        <label for="cust-${customer.id}">
                                            <div style="font-weight: 600; margin-bottom: 0.2rem;">${escapeHTML(customer.companyName || customer.id)}</div>
                                            <div style="font-size: 0.85rem; color: var(--color-text-secondary);">
                                                ${escapeHTML(customer.contact || '')} ${customer.phone ? `- ${escapeHTML(customer.phone)}` : ''}
                                            </div>
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-primary" id="confirm-customer-selection">確定 (已選 <span id="selected-customer-count">0</span> 位)</button>
                                <button type="button" class="btn btn-secondary" id="cancel-customer-selector">取消</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', html);

                // 更新選中數量
                const updateCount = () => {
                    const count = document.querySelectorAll('.customer-selector-checkbox:checked').length;
                    const countSpan = doc('selected-customer-count');
                    if (countSpan) countSpan.textContent = count;
                };

                // 綁定 checkbox 事件
                document.querySelectorAll('.customer-selector-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateCount);
                });

                // 搜尋功能
                const searchInput = doc('customer-selector-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        document.querySelectorAll('.customer-selector-item').forEach(item => {
                            const text = item.textContent.toLowerCase();
                            item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
                        });
                    });
                }

                // 確定按鈕
                const confirmBtn = doc('confirm-customer-selection');
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', () => {
                        const selectedIds = Array.from(document.querySelectorAll('.customer-selector-checkbox:checked'))
                            .map(cb => cb.dataset.customerId);
                        
                        if (selectedIds.length === 0) {
                            showToast('請至少選擇一位客戶', 'error');
                            return;
                        }

                        const selectedCustomers = customers.filter(c => selectedIds.includes(c.id));
                        renderCustomerPreview(templateId, template, selectedCustomers);
                        
                        const modal = doc('customer-selector-modal');
                        if (modal) modal.remove();
                    });
                }

                // 取消按鈕
                const cancelBtn = doc('cancel-customer-selector');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        const modal = doc('customer-selector-modal');
                        if (modal) modal.remove();
                    });
                }

                // 點擊背景關閉
                const modal = doc('customer-selector-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                }
            }

            // patch: 2025-11-08 渲染客戶預覽
            function renderCustomerPreview(templateId, template, selectedCustomers) {
                const previewDiv = doc(`customer-preview-${templateId}`);
                const listDiv = doc(`customer-preview-list-${templateId}`);
                
                if (!previewDiv || !listDiv) return;

                // patch: 2025-11-09 如果是營業稅模板，設定模擬資料用於預覽
                if (template.category === 'vat') {
                    console.log('偵測到營業稅模板，設定模擬資料用於預覽');
                    tagSystem.vatData = {
                        period: 5,
                        year: 114,  // patch: 2025-11-09 修正：2025年是民國114年
                        last_collect_deadline: '2025-11-10',  // patch: 2025-11-09 修正：使用11/10作為範例
                        rows: []
                    };
                    console.log('tagSystem.vatData 已設定為模擬資料:', tagSystem.vatData);
                }

                const messages = tagSystem.generateMessages(template.content, selectedCustomers);
                
                // 如果是 Mail，也要處理主旨
                let subjectMessages = [];
                if (template.platform === 'Mail' && template.subject) {
                    subjectMessages = tagSystem.generateMessages(template.subject, selectedCustomers);
                }
                
                // patch: 2025-11-09 預覽完成後，如果是營業稅模板，清除模擬資料
                if (template.category === 'vat') {
                    console.log('預覽完成，清除營業稅模擬資料');
                    tagSystem.vatData = null;
                }

                const html = messages.map((msg, index) => {
                    const subjectHtml = template.platform === 'Mail' && subjectMessages[index] ? `
                        <div class="customer-preview-item-subject">
                            <div class="customer-preview-item-subject-label">主旨:</div>
                            <div>${escapeHTML(subjectMessages[index].message)}</div>
                        </div>
                    ` : '';

                    return `
                        <div class="customer-preview-item">
                            <div class="customer-preview-item-header">
                                <span class="customer-preview-item-name">
                                    ${escapeHTML(msg.customer.companyName || msg.customer.id)}
                                    ${msg.customer.contact ? `- ${escapeHTML(msg.customer.contact)}` : ''}
                                </span>
                                <button class="btn btn-small btn-copy-customer-message" data-index="${index}">複製</button>
                            </div>
                            ${subjectHtml}
                            <div class="customer-preview-item-content">${escapeHTML(msg.message)}</div>
                        </div>
                    `;
                }).join('');

                listDiv.innerHTML = html;
                previewDiv.style.display = 'block';

                // 綁定複製按鈕
                document.querySelectorAll('.btn-copy-customer-message').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.dataset.index);
                        const msg = messages[index];
                        let textToCopy = msg.message;
                        
                        // 如果是 Mail，包含主旨
                        if (template.platform === 'Mail' && subjectMessages[index]) {
                            textToCopy = `主旨: ${subjectMessages[index].message}\n\n${msg.message}`;
                        }
                        
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            showToast('訊息已複製');
                        }).catch(() => {
                            showToast('複製失敗', 'error');
                        });
                    });
                });

                showToast(`已為 ${selectedCustomers.length} 位客戶產生預覽`);
            }

            function showTemplateSelectorModal(onSelect) {
                const templates = templateManager.templates;

                if (templates.length === 0) {
                    showToast('尚未建立任何模板', 'error');
                    return;
                }

                const html = `
                    <div class="modal-overlay" id="template-selector-modal">
                        <div class="modal-content template-selector-modal">
                            <h3>選擇訊息模板</h3>
                            <div class="template-selector-list">
                                ${templates.map(template => `
                                    <div class="template-selector-item" data-template-id="${template.id}">
                                        <div class="template-selector-item-name">${escapeHTML(template.name)}</div>
                                        <div class="template-selector-item-desc">${escapeHTML(template.description || '無描述')}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" id="cancel-template-selector">取消</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', html);

                // 綁定選擇事件
                document.querySelectorAll('.template-selector-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const templateId = item.dataset.templateId;
                        const template = templateManager.getTemplate(templateId);
                        if (template) {
                            onSelect(template);
                            const modal = doc('template-selector-modal');
                            if (modal) modal.remove();
                        }
                    });
                });

                // 取消按鈕
                const cancelBtn = doc('cancel-template-selector');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        const modal = doc('template-selector-modal');
                        if (modal) modal.remove();
                    });
                }

                // 點擊背景關閉
                const modal = doc('template-selector-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                }
            }

            // patch: 2025-11-08 營業稅專用模板選擇器
            function showVatTemplateSelectorModal(onSelect) {
                const templates = templateManager.templates.filter(t => t.category === 'vat');

                if (templates.length === 0) {
                    showToast('尚未建立營業稅模板，請先到訊息模板頁面建立', 'error');
                    return;
                }

                const html = `
                    <div class="modal-overlay" id="template-selector-modal">
                        <div class="modal-content template-selector-modal">
                            <h3>選擇營業稅訊息模板</h3>
                            <div class="template-help-text" style="margin-bottom: 1rem; padding: 0.8rem; background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--color-accent-gold); border-radius: 4px;">
                                💡 提示：這些模板支援營業稅專用標籤（如期數、最晚收取日等）
                            </div>
                            <div class="template-selector-list">
                                ${templates.map(template => `
                                    <div class="template-selector-item" data-template-id="${template.id}">
                                        <div class="template-selector-item-name">${escapeHTML(template.name)}</div>
                                        <div class="template-selector-item-desc">${escapeHTML(template.description || '無描述')}</div>
                                        <div class="template-selector-item-meta" style="font-size: 0.8rem; color: var(--color-text-secondary); margin-top: 0.3rem;">
                                            使用 ${template.usageCount || 0} 次
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" id="cancel-template-selector">取消</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', html);

                // 綁定選擇事件
                document.querySelectorAll('.template-selector-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const templateId = item.dataset.templateId;
                        const template = templateManager.getTemplate(templateId);
                        if (template) {
                            onSelect(template);
                            const modal = doc('template-selector-modal');
                            if (modal) modal.remove();
                        }
                    });
                });

                // 取消按鈕
                const cancelBtn = doc('cancel-template-selector');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        const modal = doc('template-selector-modal');
                        if (modal) modal.remove();
                    });
                }

                // 點擊背景關閉
                const modal = doc('template-selector-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                }
            }

            // --- RENDER FUNCTIONS --- //
            const renderAll = () => {
                console.log('=== renderAll 開始，保存UI狀態 ===');

                // 保存當前UI狀態
                const sortSelect = doc('expiring-sort-select');
                const filterSelect = doc('expiring-filter-select');
                if (sortSelect) uiState.expiringSort = sortSelect.value;
                if (filterSelect) uiState.expiringFilter = filterSelect.value;

                // 執行渲染
                renderCustomerTable();
                renderExpiringCustomersList();
                renderNotesPage();
                renderTagFilterBar();
                renderFilterStatusBar();
                updateStatsPanel();

                // 恢復UI狀態
                setTimeout(() => {
                    const newSortSelect = doc('expiring-sort-select');
                    const newFilterSelect = doc('expiring-filter-select');
                    if (newSortSelect && uiState.expiringSort) {
                        newSortSelect.value = uiState.expiringSort;
                    }
                    if (newFilterSelect && uiState.expiringFilter) {
                        newFilterSelect.value = uiState.expiringFilter;
                    }
                    console.log('=== UI狀態已恢復 ===');
                }, 10);
            };

            const updateStatsPanel = () => {
                const totalCustomers = customers.length;
                const expiredCount = customers.filter(c => c.leaseEnd && getDaysRemaining(c.leaseEnd) <= 0).length;
                const expiringCount = customers.filter(c => c.leaseEnd && getDaysRemaining(c.leaseEnd) > 0 && getDaysRemaining(c.leaseEnd) <= EXPIRE_SOON_DAYS).length;
                const activeCount = customers.filter(c => !c.leaseEnd || getDaysRemaining(c.leaseEnd) > EXPIRE_SOON_DAYS).length;

                const totalEl = doc('total-customers');
                const expiredEl = doc('expired-count');
                const expiringEl = doc('expiring-count');
                const activeEl = doc('active-count');

                if (totalEl) totalEl.textContent = totalCustomers;
                if (expiredEl) expiredEl.textContent = expiredCount;
                if (expiringEl) expiringEl.textContent = expiringCount;
                if (activeEl) activeEl.textContent = activeCount;
            };

            const renderCustomerTable = () => {
                console.log('=== renderCustomerTable 開始 ===');
                console.log('客戶陣列長度:', customers.length);
                if (customers.length > 0) {
                    console.log('第一筆客戶資料:', customers[0]);
                    const futureCustomer = customers.find(c => c.companyName === '未來科技');
                    if (futureCustomer) {
                        console.log('未來科技客戶資料:', futureCustomer);
                    }
                }

                if (customers.length === 0) {
                    ui.customerBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">目前沒有客戶資料。</td></tr>';
                    return;
                }
                ui.customerBody.innerHTML = customers.map(c => {
                    const days = getDaysRemaining(c.leaseEnd);
                    const isExpiring = days <= EXPIRE_SOON_DAYS && days > 0;
                    const isExpired = days <= 0;
                    const rowClass = isExpired ? 'expired' : isExpiring ? 'expiring-soon' : '';
                    const leaseEndClass = isExpired ? 'lease-end-cell expired' : isExpiring ? 'lease-end-cell expiring' : 'lease-end-cell';

                    // patch: 2025-11-08 渲染備註區
                    const notesHtml = (c.notes && c.notes.length > 0) ? c.notes.map(note => `
                        <div class="note-item">
                            <div class="note-item-content">${escapeHTML(note.content)}</div>
                            <div class="note-item-meta">
                                <div>
                                    <div class="note-item-tags">
                                        ${note.tags.map(tag => `<span class="tag-item" style="background-color: ${getTagColor(tag)};">${escapeHTML(tag)}</span>`).join('')}
                                    </div>
                                    <span>${note.createdAt}</span>
                                </div>
                                <div class="note-item-actions">
                                    <button class="btn-action btn-edit-note" data-customer-id="${c.id}" data-note-id="${note.id}">編輯</button>
                                    <button class="btn-action btn-delete-note" data-customer-id="${c.id}" data-note-id="${note.id}">刪除</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<div style="text-align: center; padding: 1rem; color: var(--color-text-secondary);">此客戶目前沒有備註</div>';

                    return `<tr data-id="${c.id}" class="${rowClass}">
                        <td style="text-align: center;">
                            <input type="checkbox" class="customer-checkbox customer-select-checkbox" data-customer-id="${c.id}">
                        </td>
                        <td><span class="cell-numeric">${escapeHTML(c.id)}</span><br>${escapeHTML(c.companyName)}</td>
                        <td>${escapeHTML(c.contact) || '-'}<br><span class="cell-numeric">${escapeHTML(c.phone) || '-'}</span></td>
                        <td class="cell-numeric">${escapeHTML(c.taxId) || '-'}<br>${c.taxAddr ? `稅籍:${escapeHTML(c.taxAddr)}` : '-'}</td>
                        <td>${c.regAddr ? `設籍:${escapeHTML(c.regAddr)}` : ''}${c.regAddr && c.contactAddr ? '<br>' : ''}${c.contactAddr ? `聯絡:${escapeHTML(c.contactAddr)}` : ''}</td>
                        <td>${toROCDate(c.leaseStart) || '-'}</td>
                        <td class="${leaseEndClass}">${toROCDate(c.leaseEnd) || '-'}</td>
                        <td class="table-row-actions">
                            <!-- patch: 2025-11-09 簡化操作欄位 -->
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button type="button" class="btn-action btn-edit">✏️ 編輯</button>
                                <div class="action-dropdown">
                                    <button type="button" class="action-dropdown-btn" onclick="toggleActionMenu(event, '${c.id}')">⋮</button>
                                    <div class="action-dropdown-menu" id="action-menu-${c.id}">
                                        <div class="action-dropdown-item btn-view-notes" data-customer-id="${c.id}">📝 查看備註 (${c.notes?.length || 0})</div>
                                        <div class="action-dropdown-item btn-apply-template-single" data-customer-id="${c.id}">📧 套用模板</div>
                                        <div class="action-dropdown-item btn-export-single-notes" data-customer-id="${c.id}">📊 匯出備註</div>
                                        <div class="action-dropdown-item danger btn-delete">🗑️ 刪除</div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr class="customer-notes-row" id="notes-row-${c.id}" data-customer-id="${c.id}">
                        <td colspan="8">
                            <div class="customer-notes-content">
                                <div class="notes-section-header">
                                    <span class="notes-section-title">${escapeHTML(c.companyName)} - 備註</span>
                                    <button class="btn btn-secondary btn-small btn-close-notes" data-customer-id="${c.id}">收起</button>
                                </div>
                                <div class="add-note-section">
                                    <textarea class="notes-textarea" id="new-note-content-${c.id}" placeholder="輸入新備註..."></textarea>
                                    <div style="margin: 0.5rem 0;">
                                        <input type="text" class="tag-input" id="new-note-tags-${c.id}" placeholder="輸入標籤，用逗號分隔">
                                    </div>
                                    <button class="btn btn-primary btn-small btn-add-note" data-customer-id="${c.id}">新增備註</button>
                                </div>
                                <div id="notes-list-${c.id}">
                                    ${notesHtml}
                                </div>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
            };

            const renderExpiringCustomersList = () => {
                console.log('=== renderExpiringCustomersList 開始 ===');
                const futureCustomer = customers.find(c => c.companyName === '未來科技');
                if (futureCustomer) {
                    console.log('渲染到期清單時的未來科技資料:', futureCustomer);
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // 獲取篩選和排序設定
                const sortSelect = doc('expiring-sort-select');
                const filterSelect = doc('expiring-filter-select');
                const sortValue = sortSelect ? sortSelect.value : 'days-asc';
                const filterValue = filterSelect ? filterSelect.value : 'all';

                // 篩選邏輯
                let expiringCustomers = customers.filter(c => {
                    if (!c.leaseEnd) return false;
                    const days = getDaysRemaining(c.leaseEnd);

                    switch (filterValue) {
                        case 'expired': return days <= 0;
                        case 'critical': return days <= 30 && days > 0;
                        case 'warning': return days <= 90 && days > 30;
                        case 'all':
                        default: return days <= EXPIRE_SOON_DAYS;
                    }
                });

                // 排序邏輯
                expiringCustomers.sort((a, b) => {
                    switch (sortValue) {
                        case 'days-desc':
                            return getDaysRemaining(b.leaseEnd) - getDaysRemaining(a.leaseEnd);
                        case 'company-asc':
                            return (a.companyName || '').localeCompare(b.companyName || '');
                        case 'company-desc':
                            return (b.companyName || '').localeCompare(a.companyName || '');
                        case 'days-asc':
                        default:
                            return getDaysRemaining(a.leaseEnd) - getDaysRemaining(b.leaseEnd);
                    }
                });

                ui.expiringCustomersList.innerHTML = '';
                const priorityIndicator = doc('priority-indicator');

                if (expiringCustomers.length === 0) {
                    ui.expiringCustomersList.innerHTML = '<li>目前沒有即將到期或已到期的客戶。</li>';
                    ui.reminderCard.classList.remove('active');
                    priorityIndicator.style.display = 'none';
                    return;
                }

                // 檢查是否有緊急情況（已到期或30天內到期）
                const criticalCount = expiringCustomers.filter(c => getDaysRemaining(c.leaseEnd) <= 30).length;
                const expiredCount = expiringCustomers.filter(c => getDaysRemaining(c.leaseEnd) <= 0).length;

                if (criticalCount > 0) {
                    priorityIndicator.style.display = 'block';
                    priorityIndicator.textContent = expiredCount > 0
                        ? `緊急：${expiredCount} 個已到期，${criticalCount - expiredCount} 個即將到期`
                        : `注意：${criticalCount} 個客戶即將到期`;
                } else {
                    priorityIndicator.style.display = 'none';
                }

                // 一次性innerHTML指派：先用map產生字串陣列，再join一次性指定
                const listItemsHtml = expiringCustomers.map(c => {
                    const days = getDaysRemaining(c.leaseEnd);
                    const statusClass = days <= 0 ? 'expired' : 'expiring-soon';
                    const statusText = days <= 0 ? `已到期 ${Math.abs(days)} 天` : `剩餘 ${days} 天`;
                    const urgencyLevel = days <= 0 ? 'critical' : days <= 30 ? 'critical' : 'warning';
                    const statusBadge = days <= 0 ? '緊急' : days <= 30 ? '急迫' : '注意';

                    return `
                    <li data-id="${c.id}" class="${statusClass}">
                        <div class="status-badge ${urgencyLevel}">${statusBadge}</div>
                        <div class="customer-info">
                            <div class="customer-name">${c.companyName || '資料待補'}</div>
                            <div class="customer-contact">${c.contact || '資料待補'} ${c.phone ? '• ' + c.phone : ''}</div>
                            <div class="customer-address">${c.regAddr || '資料待補'}</div>
                        </div>
                        <div class="expiring-actions">
                            <div class="days-left ${statusClass === 'expired' ? 'expired-text' : ''}">
                                <div style="font-size: 0.8rem; opacity: 0.8;">${toROCDate(c.leaseEnd)}</div>
                                <div>${statusText}</div>
                            </div>
                            <div class="action-buttons" style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                <button type="button" class="btn btn-primary btn-quick-edit" data-id="${c.id}" title="快速編輯客戶資料">
                                    ✏️ 編輯
                                </button>
                                <button type="button" class="btn btn-secondary btn-copy-reminder" data-id="${c.id}" title="複製提醒訊息">
                                    📋 複製提醒
                                </button>
                                <button type="button" class="btn btn-secondary btn-mark-renewed" data-id="${c.id}" title="標記為已續約" style="background-color: #38A169; color: white;">
                                    ✓ 已續約
                                </button>
                            </div>
                        </div>
                    </li>`;
                });

                // 一次性指派完整HTML
                ui.expiringCustomersList.innerHTML = listItemsHtml.join('');
            };

            // patch: 2025-11-08 Modal 版本的客戶表單
            const showCustomerFormModal = (customer = null) => {
                currentlyEditingId = customer ? customer.id : null;
                
                const formHtml = `
                <div class="modal-overlay" id="customer-form-modal">
                    <div class="modal-content customer-form-modal">
                        <h2 class="module-title">${customer ? '編輯客戶資料' : '新增客戶資料'}</h2>
                        <form id="data-form">
                            <div class="data-form-grid">
                                <div class="form-group">
                                    <label for="id">客戶代號</label>
                                    <input type="text" id="id" value="${customer?.id || ''}" ${customer ? 'readonly' : ''}>
                                </div>
                                <div class="form-group">
                                    <label for="companyName">公司名稱</label>
                                    <input type="text" id="companyName" value="${customer?.companyName || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="taxId">統一編號</label>
                                    <input type="text" id="taxId" value="${customer?.taxId || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="contact">聯絡人</label>
                                    <input type="text" id="contact" value="${customer?.contact || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="phone">電話</label>
                                    <input type="text" id="phone" value="${customer?.phone || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="leaseStart">租約起日</label>
                                    <input type="date" id="leaseStart" value="${customer?.leaseStart || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="taxAddr">稅籍編號</label>
                                    <input type="text" id="taxAddr" value="${customer?.taxAddr || ''}">
                                </div>
                                <div class="form-group full-width">
                                    <label for="regAddr">設籍地址</label>
                                    <input type="text" id="regAddr" value="${customer?.regAddr || ''}">
                                </div>
                                <div class="form-group full-width">
                                    <label for="contactAddr">聯絡地址</label>
                                    <input type="text" id="contactAddr" value="${customer?.contactAddr || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="leaseEnd">租約迄日</label>
                                    <input type="date" id="leaseEnd" value="${customer?.leaseEnd || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="bookkeepingFee">記帳費（選填）</label>
                                    <input type="number" id="bookkeepingFee" value="${customer?.bookkeepingFee || ''}" placeholder="請輸入金額" min="0">
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">${customer ? '更新客戶' : '新增客戶'}</button>
                                    <button type="button" class="btn btn-secondary" id="cancel-form-btn">取消</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>`;
                
                document.body.insertAdjacentHTML('beforeend', formHtml);
                
                const modal = doc('customer-form-modal');
                const form = doc('data-form');
                const cancelBtn = doc('cancel-form-btn');
                
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                }
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        if (modal) modal.remove();
                    });
                }
                
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                }
            };

            const renderFormPage = (customer = null) => {
                currentlyEditingId = customer ? customer.id : null;
                currentlyEditingNoteId = null;
                newNoteTags = [];

                console.log('=== renderFormPage 調用 ===');
                console.log('傳入的客戶資料:', customer);
                console.log('設置的 currentlyEditingId:', currentlyEditingId);

                const formHtml = `
                <div class="card">
                    <h2 class="module-title">${customer ? '編輯客戶資料' : '新增客戶資料'}</h2>
                    <form id="data-form">
                        <div class="data-form-grid">
                            <div class="form-group">
                                <label for="id">客戶代號</label>
                                <input type="text" id="id" value="${customer?.id || ''}" ${customer ? 'readonly' : ''}>
                            </div>
                            <div class="form-group">
                                <label for="companyName">公司名稱</label>
                                <input type="text" id="companyName" value="${customer?.companyName || ''}">
                            </div>
                            <div class="form-group">
                                <label for="taxId">統一編號</label>
                                <input type="text" id="taxId" value="${customer?.taxId || ''}">
                            </div>
                            <div class="form-group">
                                <label for="contact">聯絡人</label>
                                <input type="text" id="contact" value="${customer?.contact || ''}">
                            </div>
                            <div class="form-group">
                                <label for="phone">電話</label>
                                <input type="text" id="phone" value="${customer?.phone || ''}">
                            </div>
                            <div class="form-group">
                                <label for="leaseStart">租約起日</label>
                                <input type="date" id="leaseStart" value="${customer?.leaseStart || ''}">
                            </div>
                            <div class="form-group">
                                <label for="taxAddr">稅籍編號</label>
                                <input type="text" id="taxAddr" value="${customer?.taxAddr || ''}">
                            </div>
                            <div class="form-group full-width">
                                <label for="regAddr">設籍地址</label>
                                <input type="text" id="regAddr" value="${customer?.regAddr || ''}">
                            </div>
                            <div class="form-group full-width">
                                <label for="contactAddr">聯絡地址</label>
                                <input type="text" id="contactAddr" value="${customer?.contactAddr || ''}">
                            </div>
                            <div class="form-group">
                                <label for="leaseEnd">租約迄日</label>
                                <input type="date" id="leaseEnd" value="${customer?.leaseEnd || ''}">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">${customer ? '更新客戶' : '新增客戶'}</button>
                                <button type="button" class="btn btn-secondary" id="cancel-form-btn">取消</button>
                            </div>
                        </div>
                    </form>
                </div>`;

                if (customer && customer.notes) {
                    const notesHtml = `
                    <div class="card">
                        <h3 class="module-title">客戶備註</h3>
                        <div class="tag-input-wrapper">
                            <div id="new-note-tags"></div>
                            <input type="text" id="new-note-tag-input" class="tag-input" placeholder="輸入標籤後按 Enter">
                        </div>
                        <textarea id="new-note-content" class="notes-textarea" placeholder="輸入備註內容..."></textarea>
                        <button type="button" id="add-note-btn" class="btn btn-primary">儲存新備註</button>
                        
                        <ul class="notes-list" style="margin-top: 2rem;">
                            ${customer.notes.length > 0 ? customer.notes.map(note => `
                                <li class="note-card">
                                    <p class="note-content">${note.content}</p>
                                    <div class="tag-list">
                                        ${note.tags.map(tag => `<span class="tag-item" style="background-color: ${getTagColor(tag)};">${tag}</span>`).join('')}
                                    </div>
                                    <div class="note-meta">
                                        <span>${note.createdAt}</span>
                                        <div class="note-actions">
                                            <button class="btn-action btn-edit-note" data-note-id="${note.id}">編輯</button>
                                            <button class="btn-action btn-delete-note" data-note-id="${note.id}">刪除</button>
                                        </div>
                                    </div>
                                </li>
                            `).join('') : '<li style="text-align: center; padding: 2rem;">此客戶目前沒有備註。</li>'}
                        </ul>
                    </div>`;
                    ui.formContainer.innerHTML = formHtml + notesHtml;
                } else {
                    ui.formContainer.innerHTML = formHtml;
                }

                showPage('page-form');

                // 渲染完成後立即綁定submit事件到當前表單
                setTimeout(() => {
                    const currentForm = doc('data-form');
                    if (currentForm) {
                        console.log('=== 綁定表單submit事件 ===');
                        currentForm.addEventListener('submit', handleFormSubmit);

                        // 雙重防呆：在表單屬性層級禁止預設提交
                        currentForm.setAttribute('onsubmit', 'return false;');

                        console.log('表單事件綁定完成');
                    } else {
                        console.error('找不到表單元素，無法綁定事件');
                    }
                }, 10);
            };

            const renderNotesPage = () => {
                const allNotes = customers.flatMap(c =>
                    c.notes.map(note => ({ ...note, customer: c }))
                );

                let filteredNotes = allNotes;
                if (filterState.selectedTags.length > 0) {
                    filteredNotes = allNotes.filter(note => {
                        const noteTags = note.tags.map(normalizeTag);
                        if (filterState.logic === 'AND') {
                            return filterState.selectedTags.every(tag => noteTags.includes(tag));
                        } else {
                            return filterState.selectedTags.some(tag => noteTags.includes(tag));
                        }
                    });
                }

                // 更新備註計數顯示
                const notesCountDisplay = doc('notes-count-display');
                if (notesCountDisplay) {
                    if (filterState.selectedTags.length > 0) {
                        notesCountDisplay.textContent = `篩選結果：${filteredNotes.length} 筆備註 (共 ${allNotes.length} 筆)`;
                    } else {
                        notesCountDisplay.textContent = `共 ${allNotes.length} 筆備註`;
                    }
                }

                ui.notesList.innerHTML = filteredNotes.length > 0
                    ? filteredNotes.map(note => `
                    <li class="note-card">
                        <p class="customer-name">${note.customer.companyName || note.customer.id}</p>
                        <p class="note-content">${note.content}</p>
                        <div class="tag-list">
                            ${note.tags.map(tag => `<span class="tag-item" style="background-color: ${getTagColor(tag)};">${tag}</span>`).join('')}
                        </div>
                        <div class="note-meta">
                            <span>${note.createdAt}</span>
                            <div class="note-actions">
                                <button class="btn-action btn-edit-from-note" data-id="${note.customer.id}">編輯客戶</button>
                            </div>
                        </div>
                    </li>
                `).join('')
                    : '<li style="text-align: center; padding: 2rem;">沒有符合條件的備註。</li>';
            };

            const renderTagFilterBar = () => {
                const allTags = [...new Set(customers.flatMap(c =>
                    c.notes.flatMap(n => n.tags.map(normalizeTag))
                ))];

                ui.tagFilterBar.innerHTML = allTags.map(tag =>
                    `<span class="tag-item ${filterState.selectedTags.includes(tag) ? 'active' : ''}" 
                       style="background-color: ${getTagColor(tag)};" 
                       data-tag="${tag}">${tag}</span>`
                ).join('');
            };

            const renderFilterStatusBar = () => {
                if (filterState.selectedTags.length > 0) {
                    ui.filterStatusBar.style.display = 'flex';
                    ui.filterStatusBar.querySelector('span').textContent =
                        `已選擇 ${filterState.selectedTags.length} 個標籤 (${filterState.logic} 邏輯)`;
                } else {
                    ui.filterStatusBar.style.display = 'none';
                }
            };

            // 假設有一個函式負責渲染特定客戶的備註區塊
            const renderCustomerNotesSection = (customer) => {
                const notesSection = doc('customer-notes-section'); // 假設這是備註區塊的父元素 ID
                if (!notesSection) return;

                // 清空並重新渲染備註列表 (或使用更精細的 diffing 演算法)
                notesSection.querySelector('.notes-list').innerHTML = customer.notes.length > 0
                    ? customer.notes.map(note => `
                    <li class="note-card">
                        <p class="customer-name">${customer.companyName}</p>
                        <p class="note-content">${note.content}</p>
                        <div class="tag-list">
                            ${note.tags.map(tag => `<span class="tag-item" style="background-color: ${getTagColor(tag)};">${tag}</span>`).join('')}
                        </div>
                        <div class="note-meta">
                            <span>${note.createdAt}</span>
                            <div class="note-actions">
                                <button class="btn-action btn-edit-note" data-note-id="${note.id}">編輯</button>
                                <button class="btn-action btn-delete-note" data-note-id="${note.id}">刪除</button>
                            </div>
                        </div>
                    </li>
                `).join('')
                    : '<li style="text-align: center; padding: 2rem;">此客戶目前沒有備註。</li>';

                // 更新新增/編輯備註表單的狀態
                doc('new-note-content').value = currentlyEditingNoteId ? customer.notes.find(n => n.id === currentlyEditingNoteId).content : '';
                doc('new-note-tags').innerHTML = newNoteTags.map(t => `<span class="tag-item" style="background-color: ${getTagColor(t)};" data-tag="${t}">${t} <button class="tag-delete-btn" data-tag="${t}">&times;</button></span>`).join('');
                doc('add-note-btn').textContent = currentlyEditingNoteId ? '更新備註' : '儲存新備註';
            };

            const populateReminderCard = (customer) => {
                const contact = customer.contact || '資料待補';
                const companyName = customer.companyName || '資料待補';
                const regAddr = customer.regAddr || '資料待補';
                const leaseEnd = toROCDate(customer.leaseEnd) || '資料待補';

                const reminderText =
                    `陳小姐 您好：

特此提醒，${companyName}目前承租位於 ${regAddr}，租賃合約將於${leaseEnd}到期。

再麻煩提供新的租賃合約

謝謝
`;
                ui.reminderTextDisplay.textContent = reminderText;
                ui.reminderCard.classList.add('active');
            };

            const handleExportExpiringCsv = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const expiringCustomers = customers.filter(c => c.leaseEnd && getDaysRemaining(c.leaseEnd) <= EXPIRE_SOON_DAYS)
                    .sort((a, b) => getDaysRemaining(a.leaseEnd) - getDaysRemaining(b.leaseEnd));

                let csvContent = "公司名稱,聯絡人,設籍地址,租約迄日(YYY/MM/DD),倒數天數,電話\n";
                expiringCustomers.forEach(c => {
                    const days = getDaysRemaining(c.leaseEnd);
                    const company = c.companyName || '資料待補';
                    const contact = c.contact || '資料待補';
                    const address = c.regAddr || '資料待補';
                    const leaseEndRoc = toROCDate(c.leaseEnd) || '資料待補';
                    const phone = c.phone || '資料待補';
                    csvContent += `"${company}","${contact}","${address}","${leaseEndRoc}","${days}","${phone}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', '即將到期客戶清單.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- 修正缺失的函式 --- //
            function editTaxItem(id) {
                const x = tax.items.find(t => t.id === id);
                if (!x) { alert("找不到項目"); return; }
                // 回填欄位（唯讀引用客戶）
                m2.customerSel.value = x.customerId;
                // 如果方法被刪了，補回去再選取
                if ([...m2.methodSel.options].some(o => o.value === x.method)) {
                    m2.methodSel.value = x.method;
                } else {
                    methods.list.push(x.method);
                    storeSave(DB_KEYS.METHODS, methods).then(populateMethods);
                    m2.methodSel.value = x.method;
                }
                m2.date.value = x.date;
                m2.remind.value = x.note || "";
                // 以「刪既有 → 重新加入」的覆蓋流程處理
                if (confirm("將該筆移除並以上方欄位重新建立（視為覆蓋）？")) {
                    tax.items = tax.items.filter(t => t.id !== id);
                    storeSave(DB_KEYS.M2, tax).then(renderM2Lists);
                }
            }

            function deleteTaxItem(id) {
                if (!confirm("確定刪除此項？")) return;
                const i = tax.items.findIndex(t => t.id === id);
                if (i >= 0) {
                    tax.items.splice(i, 1);
                    storeSave(DB_KEYS.M2, tax).then(renderM2Lists);
                }
            }

            // HTML 跳脫函式
            function escapeHTML(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            // 刪除客戶函式（處理關聯稅項）
            async function deleteCustomer(id) {
                if (!confirm(`確定刪除客戶 ${id}？`)) return;
                const i = customers.findIndex(c => c.id === id);
                if (i >= 0) {
                    // 檢查是否有關聯的稅項資料
                    const vatData = JSON.parse(localStorage.getItem('vatData') || '{}');
                    let orphanCount = 0;

                    // 計算所有期數中引用此客戶的項目數量
                    Object.values(vatData).forEach(periodData => {
                        if (periodData.rows) {
                            orphanCount += periodData.rows.filter(r => r.customer_id === id).length;
                        }
                    });

                    if (orphanCount > 0) {
                        if (confirm(`同時移除 ${orphanCount} 筆引用此客戶的預定清單？`)) {
                            // 移除所有關聯的稅項資料
                            Object.keys(vatData).forEach(key => {
                                if (vatData[key].rows) {
                                    vatData[key].rows = vatData[key].rows.filter(r => r.customer_id !== id);
                                }
                            });
                            localStorage.setItem('vatData', JSON.stringify(vatData));
                        }
                    }

                    customers.splice(i, 1);
                    saveCustomersToStorage();
                    renderAll();
                    showToast('客戶資料已刪除');
                }
            }

            // JSON 下載函式
            function downloadJSON(filename, data) {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // patch: 2025-11-08 訊息模板系統 - 事件處理函數
            // ========================================
            // Template Event Handlers
            // ========================================
            
            function setupTemplateListEvents() {
                // 新增模板按鈕
                const addBtn = doc('add-template-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', () => showTemplateEditorModal());
                }

                // 編輯按鈕
                document.querySelectorAll('.btn-edit-template').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = btn.dataset.id;
                        const template = templateManager.getTemplate(templateId);
                        if (template) {
                            showTemplateEditorModal(template);
                        }
                    });
                });

                // 預覽按鈕
                document.querySelectorAll('.btn-preview-template').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = btn.dataset.id;
                        const template = templateManager.getTemplate(templateId);
                        if (template && customers.length > 0) {
                            const previewMessage = tagSystem.replaceTagsInTemplate(template.content, customers[0]);
                            alert(`預覽（使用第一筆客戶資料）：\n\n${previewMessage}`);
                        } else if (customers.length === 0) {
                            showToast('沒有客戶資料可供預覽', 'error');
                        }
                    });
                });

                // 刪除按鈕
                document.querySelectorAll('.btn-delete-template').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = btn.dataset.id;
                        const template = templateManager.getTemplate(templateId);
                        if (template && confirm(`確定要刪除模板「${template.name}」嗎？`)) {
                            templateManager.deleteTemplate(templateId);
                            renderTemplateList();
                            showToast('模板已刪除');
                        }
                    });
                });

                // patch: 2025-11-08 選取客戶按鈕
                document.querySelectorAll('.btn-select-customers').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = btn.dataset.id;
                        showCustomerSelectorForTemplate(templateId);
                    });
                });

                // patch: 2025-11-08 收起預覽按鈕
                document.querySelectorAll('.btn-close-preview').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = btn.dataset.id;
                        const previewDiv = doc(`customer-preview-${templateId}`);
                        if (previewDiv) {
                            previewDiv.style.display = 'none';
                        }
                    });
                });

                // 匯出按鈕
                const exportBtn = doc('export-templates-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        try {
                            const jsonData = templateManager.exportTemplates();
                            const blob = new Blob([jsonData], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `訊息模板_${new Date().toISOString().split('T')[0]}.json`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                            showToast('模板已匯出');
                        } catch (error) {
                            console.error('匯出失敗:', error);
                            showToast('匯出失敗', 'error');
                        }
                    });
                }

                // 匯入按鈕
                const importBtn = doc('import-templates-btn');
                if (importBtn) {
                    importBtn.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.json';
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    try {
                                        const result = templateManager.importTemplates(event.target.result);
                                        if (result.success) {
                                            if (result.conflicts.length > 0) {
                                                const overwrite = confirm(`發現 ${result.conflicts.length} 個重複的模板ID，是否覆蓋？\n\n點擊「確定」覆蓋，點擊「取消」保留兩者`);
                                                if (overwrite) {
                                                    templateManager.mergeTemplates([...result.newTemplates, ...result.conflicts.map(c => c.imported)], true);
                                                } else {
                                                    // 為衝突的模板生成新ID
                                                    const conflictsWithNewIds = result.conflicts.map(c => ({
                                                        ...c.imported,
                                                        id: `template-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
                                                    }));
                                                    templateManager.mergeTemplates([...result.newTemplates, ...conflictsWithNewIds], false);
                                                }
                                            } else {
                                                templateManager.mergeTemplates(result.newTemplates, false);
                                            }
                                            renderTemplateList();
                                            showToast(`成功匯入 ${result.newTemplates.length + result.conflicts.length} 個模板`);
                                        } else {
                                            showToast(result.error, 'error');
                                        }
                                    } catch (error) {
                                        console.error('匯入失敗:', error);
                                        showToast('匯入失敗：檔案格式錯誤', 'error');
                                    }
                                };
                                reader.readAsText(file);
                            }
                        };
                        input.click();
                    });
                }
            }

            function setupTemplateEditorEvents(template) {
                const form = doc('template-form');
                const contentTextarea = doc('template-content');
                const subjectInput = doc('template-subject');
                const platformSelect = doc('template-platform');
                const insertTagBtn = doc('insert-tag-btn');
                const insertTagSubjectBtn = doc('insert-tag-subject-btn');
                const previewBtn = doc('preview-template-btn');
                const cancelBtn = doc('cancel-template-btn');

                // patch: 2025-11-08 平台切換顯示/隱藏主旨欄位
                if (platformSelect) {
                    platformSelect.addEventListener('change', () => {
                        const subjectGroup = doc('subject-group');
                        if (subjectGroup) {
                            subjectGroup.style.display = platformSelect.value === 'Mail' ? 'flex' : 'none';
                        }
                    });
                }

                // 表單提交
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        
                        const name = doc('template-name')?.value?.trim();
                        const description = doc('template-description')?.value?.trim();
                        const content = doc('template-content')?.value?.trim();
                        const platform = doc('template-platform')?.value || 'LINE';
                        const subject = doc('template-subject')?.value?.trim() || '';
                        const category = doc('template-category')?.value || 'general'; // patch: 2025-11-08

                        if (!name) {
                            showToast('請輸入模板名稱', 'error');
                            return;
                        }

                        if (!content) {
                            showToast('請輸入模板內容', 'error');
                            return;
                        }

                        if (template) {
                            // 更新模板
                            templateManager.updateTemplate(template.id, { name, description, content, platform, subject, category });
                            showToast('模板已更新');
                        } else {
                            // 新增模板
                            templateManager.addTemplate({ name, description, content, platform, subject, category });
                            showToast('模板已新增');
                        }

                        const modal = doc('template-editor-modal');
                        if (modal) modal.remove();
                        renderTemplateList();
                    });
                }

                // 插入標籤按鈕（內容）
                if (insertTagBtn && contentTextarea) {
                    insertTagBtn.addEventListener('click', () => {
                        // 記錄游標位置
                        const cursorPos = contentTextarea.selectionStart;
                        
                        // patch: 2025-11-08 根據當前選擇的模板類別決定是否顯示營業稅標籤
                        const categorySelect = doc('template-category');
                        const currentCategory = categorySelect ? categorySelect.value : (template ? template.category : 'general');
                        const includeVatFields = currentCategory === 'vat';
                        
                        showTagSelector((tag) => {
                            // 在游標位置插入標籤
                            const before = contentTextarea.value.substring(0, cursorPos);
                            const after = contentTextarea.value.substring(cursorPos);
                            contentTextarea.value = before + tag + after;
                            
                            // 將游標移到插入標籤之後
                            const newPos = cursorPos + tag.length;
                            contentTextarea.setSelectionRange(newPos, newPos);
                            contentTextarea.focus();
                        }, includeVatFields);
                    });
                }

                // patch: 2025-11-08 插入標籤按鈕（主旨）
                if (insertTagSubjectBtn && subjectInput) {
                    insertTagSubjectBtn.addEventListener('click', () => {
                        const cursorPos = subjectInput.selectionStart;
                        
                        // patch: 2025-11-08 根據當前選擇的模板類別決定是否顯示營業稅標籤
                        const categorySelect = doc('template-category');
                        const currentCategory = categorySelect ? categorySelect.value : (template ? template.category : 'general');
                        const includeVatFields = currentCategory === 'vat';
                        
                        showTagSelector((tag) => {
                            const before = subjectInput.value.substring(0, cursorPos);
                            const after = subjectInput.value.substring(cursorPos);
                            subjectInput.value = before + tag + after;
                            
                            const newPos = cursorPos + tag.length;
                            subjectInput.setSelectionRange(newPos, newPos);
                            subjectInput.focus();
                        }, includeVatFields);
                    });
                }

                // 預覽按鈕
                if (previewBtn && contentTextarea) {
                    previewBtn.addEventListener('click', () => {
                        const content = contentTextarea.value;
                        if (!content) {
                            showToast('請先輸入模板內容', 'error');
                            return;
                        }

                        if (customers.length === 0) {
                            showToast('沒有客戶資料可供預覽', 'error');
                            return;
                        }

                        const previewMessage = tagSystem.replaceTagsInTemplate(content, customers[0]);
                        const validation = tagSystem.validateTags(content);
                        
                        let message = `預覽（使用第一筆客戶資料）：\n\n${previewMessage}`;
                        
                        if (validation.invalidTags.length > 0) {
                            message += `\n\n⚠️ 發現無效標籤：${validation.invalidTags.map(t => `{{${t}}}`).join(', ')}`;
                        }
                        
                        alert(message);
                    });
                }

                // 取消按鈕
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        const modal = doc('template-editor-modal');
                        if (modal) modal.remove();
                    });
                }

                // 點擊背景關閉
                const modal = doc('template-editor-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                }
            }

            function setupMessageCopyEvents(messages) {
                // 複製單一訊息
                document.querySelectorAll('.btn-copy-message').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.dataset.index);
                        const message = messages[index];
                        if (message) {
                            navigator.clipboard.writeText(message.message).then(() => {
                                showToast('訊息已複製');
                            }).catch(() => {
                                showToast('複製失敗', 'error');
                            });
                        }
                    });
                });

                // 全部複製
                const copyAllBtn = doc('copy-all-messages');
                if (copyAllBtn) {
                    copyAllBtn.addEventListener('click', () => {
                        const allMessages = messages.map((msg, index) => {
                            return `========== #${index + 1} ${msg.customer.companyName || msg.customer.id} ==========\n${msg.message}`;
                        }).join('\n\n');
                        
                        navigator.clipboard.writeText(allMessages).then(() => {
                            showToast('所有訊息已複製');
                        }).catch(() => {
                            showToast('複製失敗', 'error');
                        });
                    });
                }

                // 關閉按鈕
                const closeBtn = doc('close-preview');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        const modal = doc('message-preview-modal');
                        if (modal) modal.remove();
                    });
                }

                // 點擊背景關閉
                const modal = doc('message-preview-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                }
            }

            // --- EVENT HANDLERS --- //
            const showPage = (pageId) => {
                // 保存當前狀態
                uiState.activeTab = pageId;

                ['page-dashboard', 'page-list', 'page-form', 'page-notes', 'page-vat', 'page-templates', 'page-settings'].forEach(p => {
                    const el = doc(p, true);
                    if (el) el.classList.remove('active');
                });
                ['tab-dashboard', 'tab-list', 'tab-vat', 'tab-templates', 'tab-settings'].forEach(t => {
                    const el = doc(t, true);
                    if (el) el.classList.remove('active');
                });
                
                const pageEl = doc(pageId, true);
                if (pageEl) pageEl.classList.add('active');
                
                const tabEl = doc(pageId.replace('page', 'tab'), true);
                if (tabEl) tabEl.classList.add('active');

                console.log('=== 頁面切換完成 ===', pageId);
            };
            
            // patch: 2025-11-09 Dashboard Home Page - Tab Event Listeners
            doc('tab-dashboard')?.addEventListener('click', () => { 
                showPage('page-dashboard'); 
                refreshDashboard(); 
            });
            ui.tabList.addEventListener('click', () => showPage('page-list'));
            doc('tab-templates')?.addEventListener('click', () => { 
                showPage('page-templates'); 
                renderTemplateList(); 
            }); // patch: 2025-11-08 訊息模板頁籤
            doc('tab-vat')?.addEventListener('click', () => { showPage('page-vat'); initVatPage(); });


            // ========================================
            // patch: 2025-11-09 Advanced Features - Global Search
            // ========================================
            
            // 初始化全域搜尋
            globalSearch = new GlobalSearch(customers, templateManager.templates);
            
            // 全域搜尋按鈕事件
            const globalSearchBtn = doc('global-search-btn');
            const globalSearchModal = doc('global-search-modal');
            const globalSearchInput = doc('global-search-input');
            const globalSearchResults = doc('global-search-results');
            const searchEmptyState = doc('search-empty-state');
            const searchInitialState = doc('search-initial-state');
            
            // 開啟全域搜尋
            function openGlobalSearch() {
                if (globalSearchModal) {
                    globalSearchModal.style.display = 'flex';
                    if (globalSearchInput) {
                        globalSearchInput.value = '';
                        globalSearchInput.focus();
                    }
                    if (globalSearchResults) globalSearchResults.style.display = 'none';
                    if (searchEmptyState) searchEmptyState.style.display = 'none';
                    if (searchInitialState) searchInitialState.style.display = 'block';
                }
            }
            
            // 關閉全域搜尋
            function closeGlobalSearch() {
                if (globalSearchModal) {
                    globalSearchModal.style.display = 'none';
                }
            }
            
            // 搜尋按鈕點擊
            if (globalSearchBtn) {
                globalSearchBtn.addEventListener('click', openGlobalSearch);
            }
            
            // 點擊背景關閉
            if (globalSearchModal) {
                globalSearchModal.addEventListener('click', (e) => {
                    if (e.target === globalSearchModal) {
                        closeGlobalSearch();
                    }
                });
            }
            
            // 搜尋輸入事件（節流）
            let searchTimeout;
            if (globalSearchInput) {
                globalSearchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    
                    if (query.length < 2) {
                        if (globalSearchResults) globalSearchResults.style.display = 'none';
                        if (searchEmptyState) searchEmptyState.style.display = 'none';
                        if (searchInitialState) searchInitialState.style.display = 'block';
                        return;
                    }
                    
                    searchTimeout = setTimeout(() => {
                        performGlobalSearch(query);
                    }, 300);
                });
                
                // ESC 關閉
                globalSearchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeGlobalSearch();
                    }
                });
            }
            
            // 執行搜尋
            function performGlobalSearch(query) {
                const results = globalSearch.search(query);
                
                if (results.total === 0) {
                    if (globalSearchResults) globalSearchResults.style.display = 'none';
                    if (searchEmptyState) searchEmptyState.style.display = 'block';
                    if (searchInitialState) searchInitialState.style.display = 'none';
                    return;
                }
                
                // 顯示結果
                if (searchEmptyState) searchEmptyState.style.display = 'none';
                if (searchInitialState) searchInitialState.style.display = 'none';
                if (globalSearchResults) {
                    globalSearchResults.style.display = 'block';
                    renderSearchResults(results);
                }
            }
            
            // 渲染搜尋結果
            function renderSearchResults(results) {
                let html = '';
                
                // 客戶結果
                if (results.customers.length > 0) {
                    html += `
                        <div class="search-category">
                            <h4 class="search-category-title">客戶 (${results.customers.length})</h4>
                            ${results.customers.map(customer => `
                                <div class="search-result-item" data-type="customer" data-id="${customer.id}">
                                    <div class="search-result-icon">👤</div>
                                    <div class="search-result-content">
                                        <div class="search-result-title">${escapeHTML(customer.companyName || customer.id)}</div>
                                        <div class="search-result-meta">
                                            ${customer.contact ? escapeHTML(customer.contact) + ' • ' : ''}
                                            ${customer.phone ? escapeHTML(customer.phone) : ''}
                                            ${customer.tags && customer.tags.length > 0 ? ' • ' + customer.tags.map(t => `<span class="tag-badge">${escapeHTML(t)}</span>`).join(' ') : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // 備註結果
                if (results.notes.length > 0) {
                    html += `
                        <div class="search-category">
                            <h4 class="search-category-title">備註 (${results.notes.length})</h4>
                            ${results.notes.map(note => `
                                <div class="search-result-item" data-type="note" data-customer-id="${note.customerId}">
                                    <div class="search-result-icon">📝</div>
                                    <div class="search-result-content">
                                        <div class="search-result-title">${escapeHTML(note.content.substring(0, 50))}${note.content.length > 50 ? '...' : ''}</div>
                                        <div class="search-result-meta">
                                            ${note.customerName ? escapeHTML(note.customerName) + ' • ' : ''}
                                            ${new Date(note.timestamp).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // 模板結果
                if (results.templates.length > 0) {
                    html += `
                        <div class="search-category">
                            <h4 class="search-category-title">訊息模板 (${results.templates.length})</h4>
                            ${results.templates.map(template => `
                                <div class="search-result-item" data-type="template" data-id="${template.id}">
                                    <div class="search-result-icon">📋</div>
                                    <div class="search-result-content">
                                        <div class="search-result-title">${escapeHTML(template.name)}</div>
                                        <div class="search-result-meta">
                                            ${template.platform || 'LINE'} • 
                                            ${template.description ? escapeHTML(template.description.substring(0, 30)) : '無描述'}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (globalSearchResults) {
                    globalSearchResults.innerHTML = html;
                    
                    // 綁定點擊事件
                    globalSearchResults.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const type = item.dataset.type;
                            const id = item.dataset.id;
                            const customerId = item.dataset.customerId;
                            
                            closeGlobalSearch();
                            
                            if (type === 'customer') {
                                showPage('page-list');
                                // 高亮客戶
                                setTimeout(() => {
                                    const row = document.querySelector(`tr[data-customer-id="${id}"]`);
                                    if (row) {
                                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        row.style.backgroundColor = 'rgba(212, 175, 55, 0.2)';
                                        setTimeout(() => {
                                            row.style.backgroundColor = '';
                                        }, 2000);
                                    }
                                }, 100);
                            } else if (type === 'note') {
                                showPage('page-list');
                                // 找到客戶並高亮
                                setTimeout(() => {
                                    const row = document.querySelector(`tr[data-customer-id="${customerId}"]`);
                                    if (row) {
                                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        row.style.backgroundColor = 'rgba(212, 175, 55, 0.2)';
                                        setTimeout(() => {
                                            row.style.backgroundColor = '';
                                        }, 2000);
                                    }
                                }, 100);
                            } else if (type === 'template') {
                                showPage('page-templates');
                                renderTemplateList();
                                // 高亮模板
                                setTimeout(() => {
                                    const card = document.querySelector(`.template-card[data-template-id="${id}"]`);
                                    if (card) {
                                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        card.style.border = '2px solid var(--color-accent-gold)';
                                        setTimeout(() => {
                                            card.style.border = '';
                                        }, 2000);
                                    }
                                }, 100);
                            }
                        });
                    });
                }
            }
            
            // Ctrl+K 快捷鍵
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    openGlobalSearch();
                }
            });

            // patch: 2025-11-08 折疊功能
            const expiringHeader = doc('expiring-section-header');
            const expiringContent = doc('expiring-section-content');
            const collapseIcon = expiringHeader?.querySelector('.collapse-icon');
            if (expiringHeader && expiringContent && collapseIcon) {
                expiringHeader.addEventListener('click', () => {
                    expiringContent.classList.toggle('collapsed');
                    collapseIcon.classList.toggle('collapsed');
                });
            }

            // patch: 2025-11-08 固定新增按鈕 - 改為開啟 modal
            const floatingAddBtn = doc('floating-add-customer-btn');
            if (floatingAddBtn) {
                floatingAddBtn.addEventListener('click', () => showCustomerFormModal());
            }

            // --- 備註 Excel 匯出功能 ---
            doc('export-notes-excel-btn')?.addEventListener('click', () => {
                try {
                    // 獲取所有備註資料
                    const allNotes = customers.flatMap(c =>
                        c.notes.map(note => ({ ...note, customer: c }))
                    );

                    let filteredNotes = allNotes;
                    let exportMode = '全部備註';

                    // 如果有標籤篩選，則只匯出符合條件的備註
                    if (filterState.selectedTags.length > 0) {
                        filteredNotes = allNotes.filter(note => {
                            const noteTags = note.tags.map(tag => tag.toLowerCase());
                            if (filterState.logic === 'AND') {
                                return filterState.selectedTags.every(tag => noteTags.includes(tag));
                            } else {
                                return filterState.selectedTags.some(tag => noteTags.includes(tag));
                            }
                        });
                        exportMode = `篩選條件 (${filterState.selectedTags.join(', ')})`;
                    }

                    if (filteredNotes.length === 0) {
                        showToast('沒有符合條件的備註資料可匯出', 'error');
                        return;
                    }

                    // 準備Excel資料
                    const excelData = [];

                    // 標題行
                    excelData.push([
                        '客戶代號', '公司名稱', '聯絡人', '電話', '備註日期', '備註內容', '標籤', '統一編號', '設籍地址'
                    ]);

                    // 資料行
                    filteredNotes.forEach(note => {
                        const customer = note.customer;
                        excelData.push([
                            customer.id || '',
                            customer.companyName || '',
                            customer.contact || '',
                            customer.phone || '',
                            note.createdAt || '',
                            note.content || '',
                            note.tags ? note.tags.join(', ') : '',
                            customer.taxId || '',
                            customer.regAddr || ''
                        ]);
                    });

                    // 創建工作簿
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);

                    // 設定欄位寬度
                    ws['!cols'] = [
                        { width: 12 }, // 客戶代號
                        { width: 20 }, // 公司名稱
                        { width: 12 }, // 聯絡人
                        { width: 15 }, // 電話
                        { width: 12 }, // 備註日期
                        { width: 50 }, // 備註內容
                        { width: 20 }, // 標籤
                        { width: 12 }, // 統一編號
                        { width: 30 }  // 設籍地址
                    ];

                    // 設定標題行樣式
                    const headerStyle = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "D4AF37" } },
                        alignment: { horizontal: "center" }
                    };

                    // 應用標題樣式
                    for (let col = 0; col < 9; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }

                    // 添加工作表
                    XLSX.utils.book_append_sheet(wb, ws, "客戶備註");

                    // 匯出檔案
                    const today = new Date().toISOString().split('T')[0];
                    const fileName = `客戶備註_${exportMode.replace(/[^\w\s]/gi, '')}_${today}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    showToast(`✅ 已匯出 ${filteredNotes.length} 筆備註資料`);

                } catch (error) {
                    console.error('備註Excel匯出失敗:', error);
                    showToast('備註Excel匯出失敗，請確認瀏覽器支援', 'error');
                }
            });

            // patch: 2025-11-08 套用訊息模板到選中客戶
            doc('apply-template-btn')?.addEventListener('click', () => {
                const selectedIds = getSelectedCustomerIds();
                if (selectedIds.length === 0) {
                    showToast('請先選擇客戶', 'error');
                    return;
                }

                const selectedCustomers = customers.filter(c => selectedIds.includes(c.id));
                
                showTemplateSelectorModal((template) => {
                    // patch: 2025-11-09 檢查是否為營業稅模板
                    if (template.category === 'vat') {
                        showToast('營業稅模板請在「營業稅」頁籤使用', 'error');
                        return;
                    }
                    
                    // 產生訊息
                    const messages = tagSystem.generateMessages(template.content, selectedCustomers);
                    
                    // 增加使用次數
                    templateManager.incrementUsage(template.id);
                    
                    // 顯示預覽
                    showMessagePreviewModal(messages);
                    
                    showToast(`已為 ${messages.length} 位客戶產生訊息`);
                });
            });

            // patch: 2025-11-08 匯出所有客戶備註
            doc('export-all-notes-btn')?.addEventListener('click', () => {
                try {
                    const allNotes = customers.flatMap(c =>
                        (c.notes || []).map(note => ({ ...note, customer: c }))
                    );

                    if (allNotes.length === 0) {
                        showToast('目前沒有任何備註資料', 'error');
                        return;
                    }

                    exportNotesToExcel(allNotes, '所有客戶備註');
                } catch (error) {
                    console.error('匯出失敗:', error);
                    showToast('匯出失敗', 'error');
                }
            });

            // patch: 2025-11-08 匯出選中客戶備註
            doc('export-selected-notes-btn')?.addEventListener('click', () => {
                try {
                    const selectedIds = getSelectedCustomerIds();
                    if (selectedIds.length === 0) {
                        showToast('請先選擇客戶', 'error');
                        return;
                    }

                    const selectedNotes = customers
                        .filter(c => selectedIds.includes(c.id))
                        .flatMap(c => (c.notes || []).map(note => ({ ...note, customer: c })));

                    if (selectedNotes.length === 0) {
                        showToast('選中的客戶沒有備註資料', 'error');
                        return;
                    }

                    exportNotesToExcel(selectedNotes, `選中客戶備註_${selectedIds.length}筆`);
                } catch (error) {
                    console.error('匯出失敗:', error);
                    showToast('匯出失敗', 'error');
                }
            });

            // patch: 2025-11-08 匯出備註通用函數
            const exportNotesToExcel = (notes, title) => {
                const excelData = [];
                
                excelData.push([
                    '客戶代號', '公司名稱', '聯絡人', '電話', '備註日期', '備註內容', '標籤', '統一編號', '設籍地址'
                ]);

                notes.forEach(note => {
                    const customer = note.customer;
                    excelData.push([
                        customer.id || '',
                        customer.companyName || '',
                        customer.contact || '',
                        customer.phone || '',
                        note.createdAt || '',
                        note.content || '',
                        note.tags ? note.tags.join(', ') : '',
                        customer.taxId || '',
                        customer.regAddr || ''
                    ]);
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);

                ws['!cols'] = [
                    { width: 12 }, { width: 20 }, { width: 12 }, { width: 15 },
                    { width: 12 }, { width: 50 }, { width: 20 }, { width: 12 }, { width: 30 }
                ];

                XLSX.utils.book_append_sheet(wb, ws, "客戶備註");

                const today = new Date().toISOString().split('T')[0];
                const fileName = `${title}_${today}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showToast(`✅ 已匯出 ${notes.length} 筆備註資料`);
            };

            // patch: 2025-11-08 多選功能
            const getSelectedCustomerIds = () => {
                const checkboxes = document.querySelectorAll('.customer-select-checkbox:checked');
                return Array.from(checkboxes).map(cb => cb.dataset.customerId);
            };

            const updateBatchActionsBar = () => {
                const selectedIds = getSelectedCustomerIds();
                const batchBar = doc('batch-actions-bar');
                const selectedCount = doc('selected-count');
                
                if (batchBar && selectedCount) {
                    selectedCount.textContent = selectedIds.length;
                    if (selectedIds.length > 0) {
                        batchBar.classList.add('active');
                    } else {
                        batchBar.classList.remove('active');
                    }
                }
            };

            // patch: 2025-11-08 全選功能
            doc('select-all-checkbox')?.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.customer-select-checkbox');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
                updateBatchActionsBar();
            });

            // patch: 2025-11-08 取消選擇
            doc('clear-selection-btn')?.addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.customer-select-checkbox');
                checkboxes.forEach(cb => cb.checked = false);
                const selectAll = doc('select-all-checkbox');
                if (selectAll) selectAll.checked = false;
                updateBatchActionsBar();
            });

            ui.customerBody.addEventListener('click', async e => {
                const row = e.target.closest('tr');
                if (!row) return;
                const id = row.dataset.id;
                
                // patch: 2025-11-08 處理多選框變更
                if (e.target.classList.contains('customer-select-checkbox')) {
                    updateBatchActionsBar();
                    return;
                }
                
                if (e.target.classList.contains('btn-edit')) {
                    const customer = customers.find(c => c.id === id);
                    // patch: 2025-11-08 改用 modal
                    if (customer) showCustomerFormModal(customer);
                } else if (e.target.classList.contains('btn-delete')) {
                    await deleteCustomer(id);
                } else if (e.target.classList.contains('btn-view-notes')) {
                    // patch: 2025-11-08 展開備註區
                    const customerId = e.target.dataset.customerId;
                    const notesRow = doc(`notes-row-${customerId}`);
                    if (notesRow) {
                        // 先收起所有其他備註區
                        document.querySelectorAll('.customer-notes-row.expanded').forEach(r => {
                            if (r.id !== `notes-row-${customerId}`) {
                                r.classList.remove('expanded');
                            }
                        });
                        // 切換當前備註區
                        notesRow.classList.toggle('expanded');
                    }
                } else if (e.target.classList.contains('btn-close-notes')) {
                    // patch: 2025-11-08 收起備註區
                    const customerId = e.target.dataset.customerId;
                    const notesRow = doc(`notes-row-${customerId}`);
                    if (notesRow) {
                        notesRow.classList.remove('expanded');
                    }
                } else if (e.target.classList.contains('btn-add-note')) {
                    // patch: 2025-11-08 新增備註
                    const customerId = e.target.dataset.customerId;
                    const content = doc(`new-note-content-${customerId}`)?.value?.trim();
                    const tagsInput = doc(`new-note-tags-${customerId}`)?.value?.trim();
                    
                    if (!content) {
                        showToast('請輸入備註內容', 'error');
                        return;
                    }
                    
                    const customer = customers.find(c => c.id === customerId);
                    if (!customer) return;
                    
                    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
                    const newNote = {
                        id: `note-${Date.now()}`,
                        content: content,
                        tags: tags,
                        createdAt: new Date().toLocaleString('zh-TW')
                    };
                    
                    if (!customer.notes) customer.notes = [];
                    customer.notes.push(newNote);
                    
                    saveCustomersToStorage();
                    renderAll();
                    
                    // 重新展開備註區
                    setTimeout(() => {
                        const notesRow = doc(`notes-row-${customerId}`);
                        if (notesRow) notesRow.classList.add('expanded');
                    }, 100);
                    
                    showToast('備註已新增');
                } else if (e.target.classList.contains('btn-edit-note')) {
                    // patch: 2025-11-08 編輯備註
                    const customerId = e.target.dataset.customerId;
                    const noteId = e.target.dataset.noteId;
                    const customer = customers.find(c => c.id === customerId);
                    if (!customer) return;
                    
                    const note = customer.notes.find(n => n.id === noteId);
                    if (!note) return;
                    
                    const newContent = prompt('編輯備註內容:', note.content);
                    if (newContent !== null && newContent.trim()) {
                        note.content = newContent.trim();
                        saveCustomersToStorage();
                        renderAll();
                        
                        // 重新展開備註區
                        setTimeout(() => {
                            const notesRow = doc(`notes-row-${customerId}`);
                            if (notesRow) notesRow.classList.add('expanded');
                        }, 100);
                        
                        showToast('備註已更新');
                    }
                } else if (e.target.classList.contains('btn-delete-note')) {
                    // patch: 2025-11-08 刪除備註
                    const customerId = e.target.dataset.customerId;
                    const noteId = e.target.dataset.noteId;
                    
                    if (!confirm('確定要刪除此備註嗎？')) return;
                    
                    const customer = customers.find(c => c.id === customerId);
                    if (!customer) return;
                    
                    customer.notes = customer.notes.filter(n => n.id !== noteId);
                    saveCustomersToStorage();
                    renderAll();
                    
                    // 重新展開備註區
                    setTimeout(() => {
                        const notesRow = doc(`notes-row-${customerId}`);
                        if (notesRow) notesRow.classList.add('expanded');
                    }, 100);
                    
                    showToast('備註已刪除');
                } else if (e.target.classList.contains('btn-export-single-notes')) {
                    // patch: 2025-11-08 匯出單一客戶備註
                    const customerId = e.target.dataset.customerId;
                    const customer = customers.find(c => c.id === customerId);
                    
                    if (!customer) {
                        showToast('找不到客戶資料', 'error');
                        return;
                    }
                    
                    if (!customer.notes || customer.notes.length === 0) {
                        showToast('此客戶沒有備註資料', 'error');
                        return;
                    }
                    
                    const notes = customer.notes.map(note => ({ ...note, customer: customer }));
                    exportNotesToExcel(notes, `${customer.companyName}_備註`);
                } else if (e.target.classList.contains('btn-apply-template-single')) {
                    // patch: 2025-11-08 單一客戶套用模板
                    const customerId = e.target.dataset.customerId;
                    const customer = customers.find(c => c.id === customerId);
                    
                    if (!customer) {
                        showToast('找不到客戶資料', 'error');
                        return;
                    }
                    
                    showTemplateSelectorModal((template) => {
                        // patch: 2025-11-09 檢查是否為營業稅模板
                        if (template.category === 'vat') {
                            showToast('營業稅模板請在「營業稅」頁籤使用', 'error');
                            return;
                        }
                        
                        const messages = tagSystem.generateMessages(template.content, [customer]);
                        templateManager.incrementUsage(template.id);
                        showMessagePreviewModal(messages);
                    });
                }
            });

            ui.notesList.addEventListener('click', e => {
                if (e.target.classList.contains('btn-edit-from-note')) {
                    e.preventDefault();
                    const customer = customers.find(c => c.id === e.target.dataset.id);
                    // patch: 2025-11-08 改用 modal
                    if (customer) showCustomerFormModal(customer);
                }
            });

            ui.tagFilterBar.addEventListener('click', e => { if (e.target.classList.contains('tag-item')) { const tag = e.target.dataset.tag; const index = filterState.selectedTags.indexOf(tag); if (index > -1) filterState.selectedTags.splice(index, 1); else filterState.selectedTags.push(tag); renderAll(); } });
            ui.filterLogicSwitcher.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { filterState.logic = e.target.dataset.logic; ui.filterLogicSwitcher.querySelectorAll('button').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); renderAll(); } });

            // 表單提交處理函數
            const handleFormSubmit = (e) => {
                // 第一行執行防呆
                e.preventDefault();
                e.stopPropagation();

                console.log('=== 表單提交事件觸發 ===');
                console.log('事件目標:', e.target);
                console.log('當前編輯ID:', currentlyEditingId);

                // 直接從表單元素收集資料
                const form = e.target;
                const formData = {
                    id: form.querySelector('#id')?.value?.trim() || '',
                    companyName: form.querySelector('#companyName')?.value?.trim() || '',
                    taxId: form.querySelector('#taxId')?.value?.trim() || '',
                    taxAddr: form.querySelector('#taxAddr')?.value?.trim() || '',
                    contact: form.querySelector('#contact')?.value?.trim() || '',
                    phone: form.querySelector('#phone')?.value?.trim() || '',
                    regAddr: form.querySelector('#regAddr')?.value?.trim() || '',
                    contactAddr: form.querySelector('#contactAddr')?.value?.trim() || '',
                    leaseStart: form.querySelector('#leaseStart')?.value?.trim() || '',
                    leaseEnd: form.querySelector('#leaseEnd')?.value?.trim() || '',
                    bookkeepingFee: form.querySelector('#bookkeepingFee')?.value?.trim() || '' // patch: 2025-11-08 記帳費
                };

                console.log('收集到的表單資料:', formData);

                // 基本驗證
                if (!formData.companyName && !formData.id) {
                    showToast('「用戶代號」和「公司名稱」至少需填寫一項。', 'error');
                    return false;
                }

                if (currentlyEditingId) {
                    console.log('=== 執行更新操作 ===');
                    const customerIndex = customers.findIndex(c => c.id === currentlyEditingId);
                    console.log('找到客戶索引:', customerIndex);

                    if (customerIndex !== -1) {
                        const originalCustomer = { ...customers[customerIndex] };
                        console.log('原始客戶資料:', originalCustomer);

                        // 整筆覆寫：創建全新物件，切斷舊參照
                        const newCustomerData = {
                            id: formData.id,
                            companyName: formData.companyName,
                            taxId: formData.taxId,
                            taxAddr: formData.taxAddr,
                            contact: formData.contact,
                            phone: formData.phone,
                            regAddr: formData.regAddr,
                            contactAddr: formData.contactAddr,
                            leaseStart: formData.leaseStart,
                            leaseEnd: formData.leaseEnd,
                            bookkeepingFee: formData.bookkeepingFee, // patch: 2025-11-08 記帳費
                            notes: originalCustomer.notes || [] // 保留備註
                        };

                        // 整筆替換，不是逐欄位修改
                        customers[customerIndex] = newCustomerData;

                        // 立即驗證更新結果
                        const verifyResult = customers.find(c => c.id === currentlyEditingId);
                        console.log('=== 立即驗證更新結果 ===');
                        console.log('目標客戶ID:', currentlyEditingId);
                        console.log('驗證結果:', verifyResult);
                        console.log('聯絡人是否已更新:', verifyResult?.contact);

                        showToast(`✅ 客戶資料已更新！聯絡人: ${customers[customerIndex].contact}`);

                        // 儲存資料到本地儲存
                        saveCustomersToStorage();

                        // patch: 2025-11-08 關閉 modal 並刷新列表
                        const modal = doc('customer-form-modal');
                        if (modal) {
                            modal.remove();
                        }
                        
                        renderAll();
                        currentlyEditingId = null;

                    } else {
                        console.error('找不到要更新的客戶');
                        showToast('找不到要更新的客戶資料。', 'error');
                    }
                } else {
                    console.log('=== 執行新增操作 ===');
                    formData.id = formData.id || `C${Date.now()}`;
                    if (customers.some(c => c.id === formData.id)) {
                        showToast(`客戶代號 "${formData.id}" 已存在，請重新輸入。`, 'error');
                        return false;
                    }
                    formData.notes = [];
                    customers.push(formData);
                    showToast('客戶資料已成功新增！');

                    // 儲存資料到本地儲存
                    saveCustomersToStorage();

                    // patch: 2025-11-08 關閉 modal 並刷新列表
                    const modal = doc('customer-form-modal');
                    if (modal) {
                        modal.remove();
                    }
                    
                    renderAll();
                }

                // 雙重防呆：返回false阻止預設行為
                return false;
            };

            ui.formContainer.addEventListener('click', e => {
                // Handle cancel button
                if (e.target.id === 'cancel-form-btn') {
                    if (currentlyEditingId) {
                        const confirmCancel = confirm('確定要取消編輯嗎？未儲存的變更將會遺失。');
                        if (!confirmCancel) return;
                    }
                    currentlyEditingId = null;
                    showPage('page-list');
                    showToast('已取消編輯操作');
                    return;
                }

                const customer = customers.find(c => c.id === currentlyEditingId);
                if (!customer) return;

                // --- Save/Update Note --- 
                if (e.target.id === 'add-note-btn') {
                    const content = doc('new-note-content').value.trim();
                    if (!content) return alert('備註內容不可為空。');
                    const tags = newNoteTags;

                    if (currentlyEditingNoteId) {
                        const note = customer.notes.find(n => n.id === currentlyEditingNoteId);
                        if (note) { note.content = content; note.tags = tags; }
                    } else {
                        customer.notes.push({ id: `N${Date.now()}`, content, tags, createdAt: new Date().toISOString().split('T')[0] });
                    }
                    currentlyEditingNoteId = null;
                    newNoteTags = [];
                    doc('new-note-content').value = '';
                    doc('new-note-tags').innerHTML = '';
                    doc('add-note-btn').textContent = '儲存新備註';

                    // 儲存資料到本地儲存
                    saveCustomersToStorage();
                    showToast('備註已儲存');

                    renderFormPage(customer); // Re-render only the form page
                } else if (e.target.classList.contains('btn-delete-note')) {
                    const noteId = e.target.dataset.noteId;
                    if (confirm('確定要刪除此備註嗎？')) {
                        customer.notes = customer.notes.filter(n => n.id !== noteId);

                        // 儲存資料到本地儲存
                        saveCustomersToStorage();
                        showToast('備註已刪除');

                        renderFormPage(customer);
                    }
                } else if (e.target.classList.contains('btn-edit-note')) {
                    const noteId = e.target.dataset.noteId;
                    const note = customer.notes.find(n => n.id === noteId);
                    if (note) {
                        currentlyEditingNoteId = noteId;
                        newNoteTags = [...note.tags];
                        doc('new-note-content').value = note.content;
                        doc('new-note-tags').innerHTML = newNoteTags.map(t => `<span class="tag-item" style="background-color: ${getTagColor(t)};" data-tag="${t}">${t} <button class="tag-delete-btn" data-tag="${t}">&times;</button></span>`).join('');
                        doc('add-note-btn').textContent = '更新備註';
                        doc('new-note-content').focus();
                    }
                } else if (e.target.classList.contains('tag-delete-btn')) {
                    const tagToRemove = e.target.dataset.tag;
                    newNoteTags = newNoteTags.filter(t => t !== tagToRemove);
                    e.target.parentElement.remove();
                }
            });

            ui.formContainer.addEventListener('keydown', e => {
                if (e.key === 'Enter' && e.target.id === 'new-note-tag-input') {
                    e.preventDefault();
                    const newTag = normalizeTag(e.target.value);
                    if (!newTag) return;
                    if (!newNoteTags.includes(newTag)) {
                        newNoteTags.push(newTag);
                        doc('new-note-tags').innerHTML += `<span class="tag-item" style="background-color: ${getTagColor(newTag)};" data-tag="${newTag}">${newTag} <button class="tag-delete-btn" data-tag="${newTag}">&times;</button></span>`;
                    }
                    e.target.value = '';
                }
            });

            // --- Lease Reminder Event Handlers --- 
            ui.expiringCustomersList.addEventListener('click', async e => {
                if (e.target.classList.contains('btn-quick-edit')) {
                    const customerId = e.target.dataset.id;
                    const customer = customers.find(c => c.id === customerId);
                    if (customer) {
                        // patch: 2025-11-08 改用 modal
                        showCustomerFormModal(customer);
                    }
                } else if (e.target.classList.contains('btn-mark-renewed')) {
                    const customerId = e.target.dataset.id;
                    const customer = customers.find(c => c.id === customerId);
                    if (customer) {
                        const newEndDate = prompt('請輸入新的租約到期日 (YYYY-MM-DD):', customer.leaseEnd);
                        if (newEndDate && /^\d{4}-\d{2}-\d{2}$/.test(newEndDate)) {
                            customer.leaseEnd = newEndDate;

                            // 儲存資料到本地儲存
                            saveCustomersToStorage();

                            showToast(`${customer.companyName} 的租約已更新至 ${toROCDate(newEndDate)}`);
                            renderAll();
                        } else if (newEndDate) {
                            showToast('日期格式錯誤，請使用 YYYY-MM-DD 格式', 'error');
                        }
                    }
                } else if (e.target.classList.contains('btn-copy-reminder')) {
                    const customerId = e.target.dataset.id;
                    const customer = customers.find(c => c.id === customerId);

                    if (!customer) {
                        showToast('客戶資料不存在。', 'error');
                        return;
                    }

                    // Handle empty or invalid leaseEnd
                    if (!customer.leaseEnd || isNaN(new Date(customer.leaseEnd))) {
                        showToast('缺少租約迄日日期，無法複製提醒。', 'error');
                        return;
                    }

                    const contactName = customer.contact || '貴公司';
                    const companyName = customer.companyName || '資料待補';
                    const regAddr = customer.regAddr ? `位於${customer.regAddr}` : '';
                    const leaseEndDate = toROCDate(customer.leaseEnd);

                    const reminderText = `${contactName} 您好：\n\n特此提醒，${companyName}目前承租${regAddr}，租賃合約將於${leaseEndDate}到期。\n\n再麻煩提供新的租賃合約\n\n謝謝您`;

                    try {
                        await navigator.clipboard.writeText(reminderText);
                        showToast(`已複製提醒給：${contactName} / ${companyName}`);
                    } catch (err) {
                        console.error('複製失敗: ', err);
                        showToast('複製失敗，請手動選取複製', 'error');
                    }
                } else {
                    const listItem = e.target.closest('li');
                    if (listItem) {
                        const customerId = listItem.dataset.id;
                        const customer = customers.find(c => c.id === customerId);
                        if (customer) {
                            populateReminderCard(customer);
                        }
                    }
                }
            });

            ui.copyReminderBtn.addEventListener('click', () => {
                const textToCopy = ui.reminderTextDisplay.textContent;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    ui.copyReminderBtn.textContent = '已複製!';
                    setTimeout(() => { ui.copyReminderBtn.textContent = '複製提醒語'; }, 2000);
                    showToast('提醒語已複製到剪貼簿！'); // 新增 Toast 提示
                }).catch(err => {
                    console.error('複製失敗: ', err);
                    showToast('複製失敗，請手動選取複製', 'error'); // 提供使用者回饋
                });
            });

            ui.exportExpiringCsvBtn.addEventListener('click', handleExportExpiringCsv);

            // --- 資料管理功能 ---
            doc('export-all-data-btn')?.addEventListener('click', () => {
                try {
                    const dataStr = JSON.stringify(customers, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `客戶資料備份_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('資料已匯出');
                } catch (error) {
                    console.error('匯出失敗:', error);
                    showToast('匯出失敗', 'error');
                }
            });

            doc('import-data-btn')?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (Array.isArray(importedData)) {
                                    if (confirm('確定要匯入資料嗎？這將覆蓋現有資料。')) {
                                        customers = importedData;
                                        saveCustomersToStorage();
                                        renderAll();
                                        showToast(`已匯入 ${customers.length} 筆客戶資料`);
                                    }
                                } else {
                                    showToast('檔案格式錯誤', 'error');
                                }
                            } catch (error) {
                                console.error('匯入失敗:', error);
                                showToast('匯入失敗，請檢查檔案格式', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            });

            doc('clear-data-btn')?.addEventListener('click', () => {
                if (confirm('確定要清除所有資料嗎？此操作無法復原！')) {
                    if (confirm('最後確認：真的要清除所有客戶資料嗎？')) {
                        customers = [];
                        localStorage.removeItem(STORAGE_KEY);
                        renderAll();
                        showToast('所有資料已清除');
                    }
                }
            });

            // 還原備份按鈕
            doc('restore-backup-btn')?.addEventListener('click', () => {
                if (confirm('確定要還原備份資料嗎？這將覆蓋目前的資料。')) {
                    const backupData = loadBackupData();
                    if (backupData) {
                        customers = backupData;
                        saveCustomersToStorage();
                        renderAll();
                        showToast('備份資料已還原');
                    } else {
                        showToast('沒有找到備份資料', 'error');
                    }
                }
            });

            // patch: 2025-11-09 立即備份加入 Loading 指示器
            doc('auto-backup-btn')?.addEventListener('click', () => {
                showLoading('正在建立備份...');
                setTimeout(() => {
                    createAutoBackup();
                    hideLoading();
                }, 100);
            });

            // --- Excel 匯出範本功能 ---
            doc('export-excel-template-btn')?.addEventListener('click', () => {
                try {
                    // 準備Excel資料，包含現有客戶資料和空白範本行
                    const excelData = [];

                    // 標題行
                    excelData.push([
                        '客戶代號', '公司名稱', '統一編號', '稅籍編號', '聯絡人', '電話',
                        '設籍地址', '聯絡地址', '租約起日', '租約迄日', '備註'
                    ]);

                    // 現有客戶資料
                    customers.forEach(c => {
                        const notesText = c.notes ? c.notes.map(n => `${n.createdAt}: ${n.content}`).join('; ') : '';
                        excelData.push([
                            c.id || '',
                            c.companyName || '',
                            c.taxId || '',
                            c.taxAddr || '',
                            c.contact || '',
                            c.phone || '',
                            c.regAddr || '',
                            c.contactAddr || '',
                            c.leaseStart || '',
                            c.leaseEnd || '',
                            notesText
                        ]);
                    });

                    // 添加5行空白範本供新增使用
                    for (let i = 0; i < 5; i++) {
                        excelData.push(['', '', '', '', '', '', '', '', '', '', '']);
                    }

                    // 創建工作簿
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);

                    // 設定欄位寬度
                    ws['!cols'] = [
                        { width: 12 }, // 客戶代號
                        { width: 20 }, // 公司名稱
                        { width: 12 }, // 統一編號
                        { width: 15 }, // 稅籍編號
                        { width: 12 }, // 聯絡人
                        { width: 15 }, // 電話
                        { width: 30 }, // 設籍地址
                        { width: 30 }, // 聯絡地址
                        { width: 12 }, // 租約起日
                        { width: 12 }, // 租約迄日
                        { width: 40 }  // 備註
                    ];

                    // 設定標題行樣式
                    const headerStyle = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "D4AF37" } },
                        alignment: { horizontal: "center" }
                    };

                    // 應用標題樣式
                    for (let col = 0; col < 11; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }

                    XLSX.utils.book_append_sheet(wb, ws, "客戶資料");

                    // 匯出檔案
                    const fileName = `客戶資料範本_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    showToast(`Excel範本已匯出：${fileName}`);
                } catch (error) {
                    console.error('Excel匯出失敗:', error);
                    showToast('Excel匯出失敗，請確認瀏覽器支援', 'error');
                }
            });

            // --- Excel 匯入功能 ---
            // patch: 2025-11-09 加入 Loading 指示器
            doc('import-excel-btn')?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        showLoading('正在讀取 Excel 檔案...');
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const sheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[sheetName];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                                if (jsonData.length < 2) {
                                    hideLoading();
                                    showToast('Excel檔案格式錯誤或無資料', 'error');
                                    return;
                                }

                                // 檢查標題行
                                const headers = jsonData[0];
                                const expectedHeaders = ['客戶代號', '公司名稱', '統一編號', '稅籍編號', '聯絡人', '電話', '設籍地址', '聯絡地址', '租約起日', '租約迄日', '備註'];

                                const isValidFormat = expectedHeaders.every((header, index) =>
                                    headers[index] && headers[index].toString().trim() === header
                                );

                                if (!isValidFormat) {
                                    hideLoading();
                                    showToast('Excel檔案格式不正確，請使用匯出的範本格式', 'error');
                                    return;
                                }

                                // 檢查必要欄位
                                const required = ["客戶代號", "公司名稱"];
                                for (const k of required) {
                                    if (!headers.includes(k)) {
                                        alert(`Excel 缺少必要欄位：${k}`);
                                        return;
                                    }
                                }

                                // 解析資料行
                                const importedCustomers = [];
                                let created = 0, updated = 0;

                                for (let i = 1; i < jsonData.length; i++) {
                                    const row = jsonData[i];

                                    // 跳過空行
                                    if (!row || row.every(cell => !cell || cell.toString().trim() === '')) {
                                        continue;
                                    }

                                    const customerId = row[0] ? row[0].toString().trim() : `C${Date.now()}_${i}`;
                                    const existingCustomer = customers.find(c => c.id === customerId);

                                    const customer = {
                                        id: customerId,
                                        companyName: row[1] ? row[1].toString().trim() : '',
                                        taxId: row[2] ? row[2].toString().trim() : '',
                                        taxAddr: row[3] ? row[3].toString().trim() : '',
                                        contact: row[4] ? row[4].toString().trim() : '',
                                        phone: row[5] ? row[5].toString().trim() : '',
                                        regAddr: row[6] ? row[6].toString().trim() : '',
                                        contactAddr: row[7] ? row[7].toString().trim() : '',
                                        leaseStart: row[8] ? row[8].toString().trim() : '',
                                        leaseEnd: row[9] ? row[9].toString().trim() : '',
                                        notes: existingCustomer ? existingCustomer.notes : []
                                    };

                                    if (existingCustomer) {
                                        updated++;
                                    } else {
                                        created++;
                                    }

                                    // 處理備註
                                    if (row[10] && row[10].toString().trim()) {
                                        const notesText = row[10].toString().trim();
                                        // 簡單解析備註格式：日期: 內容; 日期: 內容
                                        const noteEntries = notesText.split(';');
                                        noteEntries.forEach(entry => {
                                            const trimmedEntry = entry.trim();
                                            if (trimmedEntry) {
                                                const colonIndex = trimmedEntry.indexOf(':');
                                                if (colonIndex > 0) {
                                                    const date = trimmedEntry.substring(0, colonIndex).trim();
                                                    const content = trimmedEntry.substring(colonIndex + 1).trim();
                                                    customer.notes.push({
                                                        id: `N${Date.now()}_${Math.random()}`,
                                                        content: content,
                                                        tags: [],
                                                        createdAt: date
                                                    });
                                                } else {
                                                    // 沒有日期格式，使用今天日期
                                                    customer.notes.push({
                                                        id: `N${Date.now()}_${Math.random()}`,
                                                        content: trimmedEntry,
                                                        tags: [],
                                                        createdAt: new Date().toISOString().split('T')[0]
                                                    });
                                                }
                                            }
                                        });
                                    }

                                    // 基本驗證
                                    if (customer.companyName || customer.id) {
                                        importedCustomers.push(customer);
                                    }
                                }

                                if (importedCustomers.length === 0) {
                                    hideLoading();
                                    showToast('Excel檔案中沒有有效的客戶資料', 'error');
                                    return;
                                }

                                hideLoading();
                                
                                // 確認匯入
                                const confirmMessage = `找到 ${importedCustomers.length} 筆客戶資料，確定要匯入嗎？\n\n匯入方式：\n• 確定：覆蓋現有資料\n• 取消：取消匯入`;

                                if (confirm(confirmMessage)) {
                                    showLoading('正在匯入資料...');
                                    customers = importedCustomers;
                                    saveCustomersToStorage();
                                    renderAll();
                                    hideLoading();
                                    showToast('匯入成功', `新增 ${created} 筆、覆蓋 ${updated} 筆`, 'success');
                                }

                            } catch (error) {
                                console.error('Excel匯入失敗:', error);
                                hideLoading();
                                showToast('Excel匯入失敗', '請檢查檔案格式', 'error');
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    }
                };
                input.click();
            });

            // --- 排序和篩選事件監聽器 - 直接綁定到select元素 ---
            // 延遲綁定，確保元素存在
            setTimeout(() => {
                const sortSelect = doc('expiring-sort-select');
                const filterSelect = doc('expiring-filter-select');

                if (sortSelect) {
                    sortSelect.addEventListener('change', () => {
                        console.log('排序選項變更，重新渲染到期清單');
                        renderExpiringCustomersList();
                    });
                }

                if (filterSelect) {
                    filterSelect.addEventListener('change', () => {
                        console.log('篩選選項變更，重新渲染到期清單');
                        renderExpiringCustomersList();
                    });
                }
            }, 100);

            // --- 營業稅功能 ---
            const VAT_STORAGE_KEY = 'offline-crm-vat-data';
            const VAT_BACKUP_KEY = 'offline-crm-vat-backup';
            const VAT_SETTINGS_KEY = 'offline-crm-vat-settings';
            const VAT_PERIOD_SELECTION_KEY = 'offline-crm-vat-period-selection'; // patch: 2025-11-09 期數選擇本地儲存
            
            let currentVatData = null;
            let vatHistory = [];
            // 載入收取方式（優先從本地儲存載入）
            const loadCollectMethods = () => {
                try {
                    const stored = localStorage.getItem('offline-crm-collect-methods');
                    if (stored) {
                        const methods = JSON.parse(stored);
                        if (Array.isArray(methods) && methods.length > 0) {
                            return methods;
                        }
                    }
                } catch (error) {
                    console.error('載入收取方式失敗:', error);
                }
                return ['快遞', '自己寄送', '親收']; // 預設值
            };

            // 儲存收取方式到本地儲存
            const saveCollectMethods = () => {
                try {
                    localStorage.setItem('offline-crm-collect-methods', JSON.stringify(collectMethods));
                    console.log('收取方式已儲存:', collectMethods);
                } catch (error) {
                    console.error('儲存收取方式失敗:', error);
                }
            };

            let collectMethods = loadCollectMethods();

            // 營業稅資料結構
            const createVatPeriodSheet = (year, period) => ({
                year: year,
                period: period,
                last_collect_deadline: '',
                rows: [],
                history: [],
                collectMethods: [...collectMethods], // 包含收取方式
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            });

            // 儲存營業稅資料（增強版）
            const saveVatData = () => {
                try {
                    // 建立備份
                    const currentVatStorage = localStorage.getItem(VAT_STORAGE_KEY);
                    if (currentVatStorage) {
                        const backupData = {
                            data: currentVatStorage,
                            timestamp: new Date().toISOString(),
                            version: Date.now()
                        };
                        localStorage.setItem(VAT_BACKUP_KEY, JSON.stringify(backupData));
                    }

                    // 儲存新資料
                    const allVatData = JSON.parse(localStorage.getItem(VAT_STORAGE_KEY) || '{}');
                    const key = `${currentVatData.year}_${currentVatData.period}`;
                    
                    // 添加元資料
                    currentVatData.updated_at = new Date().toISOString();
                    currentVatData.version = Date.now();
                    currentVatData.collectMethods = [...collectMethods]; // 確保收取方式被儲存
                    currentVatData.checksum = generateVatChecksum(currentVatData);
                    
                    allVatData[key] = currentVatData;
                    
                    const dataToSave = {
                        vatData: allVatData,
                        lastModified: new Date().toISOString(),
                        totalPeriods: Object.keys(allVatData).length
                    };
                    
                    localStorage.setItem(VAT_STORAGE_KEY, JSON.stringify(dataToSave));
                    
                    // 更新營業稅統計
                    updateVatStorageStats();
                    console.log('營業稅資料已儲存:', key);
                } catch (error) {
                    console.error('儲存營業稅資料失敗:', error);
                    if (error.name === 'QuotaExceededError') {
                        showToast('營業稅資料儲存空間不足！', 'error');
                    } else {
                        showToast('儲存失敗', 'error');
                    }
                }
            };

            // 載入營業稅資料（增強版）
            const loadVatData = (year, period) => {
                try {
                    const storedData = localStorage.getItem(VAT_STORAGE_KEY);
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        
                        let allVatData;
                        // 檢查資料格式（向後相容）
                        if (parsedData.vatData) {
                            // 新格式
                            allVatData = parsedData.vatData;
                        } else {
                            // 舊格式：直接是營業稅資料物件
                            allVatData = parsedData;
                        }
                        
                        const key = `${year}_${period}`;
                        const vatData = allVatData[key];
                        
                        if (vatData) {
                            // 驗證資料完整性
                            if (vatData.checksum && !verifyVatChecksum(vatData)) {
                                console.warn('營業稅資料校驗失敗，嘗試載入備份...');
                                return loadVatBackupData(year, period);
                            }
                            
                            // 恢復收取方式（如果有的話）
                            if (vatData.collectMethods && Array.isArray(vatData.collectMethods)) {
                                collectMethods = [...vatData.collectMethods];
                            }
                            
                            return vatData;
                        }
                    }
                    
                    // 沒有資料時建立新的
                    return createVatPeriodSheet(year, period);
                } catch (error) {
                    console.error('載入營業稅資料失敗:', error);
                    showToast('載入營業稅資料失敗，嘗試載入備份...', 'warning');
                    return loadVatBackupData(year, period) || createVatPeriodSheet(year, period);
                }
            };

            // 載入營業稅備份資料
            const loadVatBackupData = (year, period) => {
                try {
                    const backupData = localStorage.getItem(VAT_BACKUP_KEY);
                    if (backupData) {
                        const backup = JSON.parse(backupData);
                        const restoredData = JSON.parse(backup.data);
                        
                        let allVatData;
                        if (restoredData.vatData) {
                            allVatData = restoredData.vatData;
                        } else {
                            allVatData = restoredData;
                        }
                        
                        const key = `${year}_${period}`;
                        const vatData = allVatData[key];
                        
                        if (vatData) {
                            // 恢復收取方式（如果有的話）
                            if (vatData.collectMethods && Array.isArray(vatData.collectMethods)) {
                                collectMethods = [...vatData.collectMethods];
                            }
                            
                            showToast(`已從備份載入營業稅資料（${new Date(backup.timestamp).toLocaleString()}）`, 'success');
                            return vatData;
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('載入營業稅備份資料失敗:', error);
                    return null;
                }
            };

            // 生成營業稅資料校驗碼
            const generateVatChecksum = (vatData) => {
                const dataForChecksum = {
                    year: vatData.year,
                    period: vatData.period,
                    rows: vatData.rows,
                    last_collect_deadline: vatData.last_collect_deadline
                };
                const str = JSON.stringify(dataForChecksum);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            };

            // 驗證營業稅資料校驗碼
            const verifyVatChecksum = (vatData) => {
                if (!vatData.checksum) return true; // 舊資料沒有校驗碼，視為有效
                const expectedChecksum = generateVatChecksum(vatData);
                return vatData.checksum === expectedChecksum;
            };

            // 更新營業稅儲存統計
            const updateVatStorageStats = () => {
                try {
                    const storedData = localStorage.getItem(VAT_STORAGE_KEY);
                    if (storedData) {
                        const size = storedData.length;
                        const parsedData = JSON.parse(storedData);
                        
                        let periodCount = 0;
                        if (parsedData.vatData) {
                            periodCount = Object.keys(parsedData.vatData).length;
                        } else {
                            periodCount = Object.keys(parsedData).length;
                        }
                        
                        // 更新 UI 中的統計資訊
                        const statsElement = document.getElementById('vat-storage-stats');
                        if (statsElement) {
                            const sizeKB = Math.round(size / 1024);
                            statsElement.innerHTML = `
                                <span>營業稅資料：${sizeKB}KB</span>
                                <span>期數：${periodCount}期</span>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('更新營業稅儲存統計失敗:', error);
                }
            };

            // 匯出營業稅備份
            const exportVatBackup = () => {
                try {
                    const allVatData = JSON.parse(localStorage.getItem(VAT_STORAGE_KEY) || '{}');
                    const backupData = {
                        vatData: allVatData.vatData || allVatData,
                        exportDate: new Date().toISOString(),
                        version: '2.0',
                        type: 'vat_backup'
                    };
                    
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `營業稅備份_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showToast('營業稅備份已下載', 'success');
                } catch (error) {
                    console.error('匯出營業稅備份失敗:', error);
                    showToast('匯出備份失敗', 'error');
                }
            };

            // 取得台灣時間
            const getTaiwanDate = (offset = 0) => {
                const now = new Date();
                const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000)); // UTC+8
                taiwanTime.setDate(taiwanTime.getDate() + offset);
                return taiwanTime;
            };

            // 格式化日期為民國年
            const formatROCDate = (date, includeWeekday = true) => {
                const year = date.getFullYear() - 1911;
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                const weekday = weekdays[date.getDay()];
                return includeWeekday ? `${year}-${month}-${day}（${weekday}）` : `${year}-${month}-${day}`;
            };

            // 取得當前期數（根據月份）
            const getCurrentPeriod = () => {
                const month = new Date().getMonth() + 1; // 1-12
                return Math.ceil(month / 2);
            };

            // patch: 2025-11-09 儲存期數選擇到本地儲存
            const savePeriodSelection = () => {
                try {
                    const selection = {
                        year: parseInt(doc('vat-year').value),
                        period: parseInt(doc('vat-period').value),
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem(VAT_PERIOD_SELECTION_KEY, JSON.stringify(selection));
                    console.log('期數選擇已儲存:', selection);
                } catch (error) {
                    console.error('儲存期數選擇失敗:', error);
                }
            };

            // patch: 2025-11-09 載入期數選擇
            const loadPeriodSelection = () => {
                try {
                    const stored = localStorage.getItem(VAT_PERIOD_SELECTION_KEY);
                    if (stored) {
                        const selection = JSON.parse(stored);
                        console.log('載入期數選擇:', selection);
                        return selection;
                    }
                } catch (error) {
                    console.error('載入期數選擇失敗:', error);
                }
                return null;
            };

            // 初始化營業稅頁面
            const initVatPage = () => {
                const currentYear = new Date().getFullYear() - 1911; // 民國年
                const currentPeriod = getCurrentPeriod();

                // patch: 2025-11-09 優先載入使用者上次選擇的期數
                const savedSelection = loadPeriodSelection();
                
                // 設定預設值
                if (savedSelection) {
                    doc('vat-year').value = savedSelection.year;
                    doc('vat-period').value = savedSelection.period;
                    console.log('使用上次選擇的期數:', savedSelection);
                } else {
                    doc('vat-year').value = currentYear;
                    doc('vat-period').value = currentPeriod;
                    console.log('使用系統預設期數:', currentYear, currentPeriod);
                }

                // 載入資料
                loadCurrentVatPeriod();

                // 更新日期顯示
                updateDateDisplays();

                // 渲染收取方式選項
                renderCollectMethodCheckboxes();

                // 渲染提醒列表
                renderReminderLists();

                // 渲染本期資料表格
                renderVatDataTable();

                // patch: 2025-11-08 綁定排序事件
                document.querySelectorAll('.vat-data-table th.sortable').forEach(th => {
                    th.addEventListener('click', () => {
                        const sortColumn = th.dataset.sort;
                        if (sortColumn) {
                            sortVatTable(sortColumn);
                        }
                    });
                });

                // patch: 2025-11-08 渲染未收發票提醒（單月才顯示）
                renderUnreceivedReminder();
            };

            // patch: 2025-11-08 渲染尚未收取清單（折疊式）
            const renderUnreceivedReminder = () => {
                if (!currentVatData) return;

                // patch: 2025-11-08 檢查是否有輸入最晚收取發票日
                if (!currentVatData.last_collect_deadline) {
                    // 沒有輸入最晚收取發票日，不顯示
                    const reminderSection = doc('unreceived-reminder-section', true);
                    if (reminderSection) {
                        reminderSection.remove();
                    }
                    return;
                }

                // 找出未收到的客戶
                const unreceivedRows = currentVatData.rows.filter(row => !row.received);

                if (unreceivedRows.length === 0) {
                    const reminderSection = doc('unreceived-reminder-section', true);
                    if (reminderSection) {
                        reminderSection.remove();
                    }
                    return;
                }

                // 顯示尚未收取清單（折疊式）
                const reminderHtml = `
                    <div class="card" id="unreceived-reminder-section" style="background: linear-gradient(135deg, rgba(229, 115, 115, 0.1), rgba(229, 115, 115, 0.05)); border-left: 4px solid #E57373;">
                        <div class="collapsible-header" id="unreceived-header">
                            <h3 style="color: #E57373; margin: 0;">⚠️ 尚未收取清單（${unreceivedRows.length} 家）</h3>
                            <span class="collapse-icon" style="color: #E57373;">▼</span>
                        </div>
                        <div class="collapsible-content" id="unreceived-content" style="margin-top: 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.8rem;">
                                ${unreceivedRows.map(row => {
                                    const customer = customers.find(c => c.id === row.customer_id);
                                    if (!customer) return '';
                                    return `
                                        <div style="background: var(--color-surface); padding: 1rem; border-radius: 4px; border: 1px solid var(--color-border);">
                                            <div style="font-weight: 600; margin-bottom: 0.3rem;">${escapeHTML(customer.companyName || customer.id)}</div>
                                            <div style="font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 0.3rem;">
                                                ${customer.contact || '未設定'} | ${customer.phone || ''}
                                            </div>
                                            <div style="font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 0.5rem;">
                                                收取方式: ${row.collect_method}
                                            </div>
                                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                                <button class="btn btn-small" onclick="setAppointmentDate('${row.row_id}')" style="background: var(--color-accent-gold); color: #000;">+ 約收日期</button>
                                                <button class="btn btn-small" onclick="markAsReceived('${row.row_id}')" style="background: #38A169; color: white;">標記已收到</button>
                                            </div>
                                            ${row.appointment_date ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--color-accent-gold);">約收: ${row.appointment_date}</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;

                // 插入到本期資料區塊之前
                const vatDataSection = document.querySelector('.vat-data-section');
                if (vatDataSection) {
                    const existingReminder = doc('unreceived-reminder-section', true);
                    if (existingReminder) {
                        existingReminder.remove();
                    }
                    vatDataSection.insertAdjacentHTML('beforebegin', reminderHtml);

                    // 綁定折疊事件
                    const header = doc('unreceived-header');
                    const content = doc('unreceived-content');
                    const icon = header?.querySelector('.collapse-icon');
                    
                    if (header && content && icon) {
                        header.addEventListener('click', () => {
                            content.classList.toggle('collapsed');
                            icon.classList.toggle('collapsed');
                        });
                    }
                }
            };

            // patch: 2025-11-08 標記為已收到
            window.markAsReceived = (rowId) => {
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) return;

                row.received = true;
                row.updated_at = new Date().toISOString();

                const customer = customers.find(c => c.id === row.customer_id);
                const customerName = customer ? (customer.companyName || customer.id) : '未知客戶';

                currentVatData.history.push({
                    timestamp: new Date().toISOString(),
                    action: '標記已收到',
                    summary: `${customerName} - 發票已收到`
                });

                saveVatData();
                renderVatDataTable();
                renderUnreceivedReminder();
                showToast('已標記為已收到');
            };





            // 複製提醒話術
            const copyReminderMessage = (rowId) => {
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) return;

                const customer = customers.find(c => c.id === row.customer_id);
                if (!customer) return;

                const plannedDate = new Date(row.planned_collect_date);
                const year = plannedDate.getFullYear() - 1911;
                const month = (plannedDate.getMonth() + 1).toString().padStart(2, '0');
                const day = plannedDate.getDate().toString().padStart(2, '0');
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                const weekday = weekdays[plannedDate.getDay()];
                const dateStr = `${year}-${month}-${day}（週${weekday}）`;

                const message = `提醒您，我們已安排於${dateStr}前往貴公司收取發票資料。

麻煩您協助確認以下資料是否已備妥：
✅ 本期所有進項與銷項發票、憑證
✅ 作廢發票、海關進口報單等其他證明文件

若有任何變動，請盡快回覆告知，謝謝！`;

                navigator.clipboard.writeText(message).then(() => {
                    showToast('提醒話術已複製到剪貼簿');
                }).catch(() => {
                    showToast('複製失敗', 'error');
                });
            };

            // 加入匯出清單
            const addToExportList = (rowId) => {
                // 這裡可以實現加入匯出清單的邏輯
                showToast('已加入匯出清單');
            };

            // 載入當前期數資料
            const loadCurrentVatPeriod = () => {
                const year = parseInt(doc('vat-year').value);
                const period = parseInt(doc('vat-period').value);
                currentVatData = loadVatData(year, period);
                doc('vat-deadline').value = currentVatData.last_collect_deadline;

                // 重新渲染所有相關組件
                renderVatDataTable();
                renderReminderLists();
                renderCollectMethodCheckboxes();
                
                // 更新營業稅儲存統計
                updateVatStorageStats();

                console.log('=== 載入期數資料完成 ===');
                console.log('年度:', year, '期數:', period);
                console.log('本期資料筆數:', currentVatData.rows.length);
            };

            // 更新日期顯示
            const updateDateDisplays = () => {
                const today = getTaiwanDate();
                const tomorrow = getTaiwanDate(1);

                doc('today-date').textContent = `（${formatROCDate(today)}）`;

                // 處理週五的特殊情況
                if (today.getDay() === 5) { // 週五
                    const saturday = getTaiwanDate(1);
                    const sunday = getTaiwanDate(2);
                    const monday = getTaiwanDate(3);
                    doc('tomorrow-date-range').textContent =
                        `（${formatROCDate(saturday, false)}～${formatROCDate(monday)}）`;
                } else {
                    doc('tomorrow-date-range').textContent = `（${formatROCDate(tomorrow)}）`;
                }
            };

            // 渲染收取方式選項
            const renderCollectMethodCheckboxes = () => {
                const container = doc('collect-method-checkboxes');
                container.innerHTML = collectMethods.map(method => `
                    <div class="checkbox-item">
                        <input type="checkbox" id="method-${method}" value="${method}" checked>
                        <label for="method-${method}">${method}</label>
                        <button class="btn-small btn-secondary" onclick="removeCollectMethod('${method}')">×</button>
                    </div>
                `).join('');
            };

            // 新增收取方式
            window.addCollectMethod = () => {
                const method = prompt('請輸入新的收取方式：');
                if (method && method.trim() && !collectMethods.includes(method.trim())) {
                    collectMethods.push(method.trim());
                    saveCollectMethods(); // 儲存收取方式
                    renderCollectMethodCheckboxes();
                    saveVatData(); // 也儲存到營業稅資料中
                    showToast(`已新增收取方式：${method.trim()}`, 'success');
                }
            };

            // 移除收取方式
            window.removeCollectMethod = (method) => {
                if (confirm(`確定要移除「${method}」這個收取方式嗎？`)) {
                    collectMethods = collectMethods.filter(m => m !== method);
                    saveCollectMethods(); // 儲存收取方式
                    renderCollectMethodCheckboxes();
                    saveVatData(); // 也儲存到營業稅資料中
                    showToast(`已移除收取方式：${method}`, 'success');
                }
            };

            // 渲染提醒列表
            const renderReminderLists = () => {
                if (!currentVatData || !currentVatData.rows) {
                    doc('today-reminders').innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: 2rem;">請先載入期數資料</div>';
                    doc('tomorrow-reminders').innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: 2rem;">請先載入期數資料</div>';
                    return;
                }

                const today = new Date();
                const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD格式

                console.log('=== 渲染提醒列表 ===');
                console.log('今日日期:', todayStr);
                console.log('本期資料筆數:', currentVatData.rows.length);
                console.log('本期資料:', currentVatData.rows.map(r => ({ id: r.customer_id, date: r.planned_collect_date })));

                // 今日提醒
                const todayReminders = currentVatData.rows.filter(row => {
                    const match = row.planned_collect_date === todayStr;
                    if (match) console.log('今日提醒匹配:', row.customer_id, row.planned_collect_date);
                    return match;
                });

                console.log('今日提醒筆數:', todayReminders.length);
                renderReminderList('today-reminders', todayReminders);

                // 明日提醒（處理週五特殊情況）
                let tomorrowDates = [];
                if (today.getDay() === 5) { // 週五
                    for (let i = 1; i <= 3; i++) {
                        const date = new Date(today);
                        date.setDate(date.getDate() + i);
                        tomorrowDates.push(date.toISOString().split('T')[0]);
                    }
                } else {
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrowDates.push(tomorrow.toISOString().split('T')[0]);
                }

                console.log('明日提醒日期範圍:', tomorrowDates);

                const tomorrowReminders = currentVatData.rows.filter(row => {
                    const match = tomorrowDates.includes(row.planned_collect_date);
                    if (match) console.log('明日提醒匹配:', row.customer_id, row.planned_collect_date);
                    return match;
                });

                console.log('明日提醒筆數:', tomorrowReminders.length);
                renderReminderList('tomorrow-reminders', tomorrowReminders);
            };

            // 渲染單個提醒列表
            const renderReminderList = (containerId, reminders) => {
                const container = doc(containerId);
                if (reminders.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: 2rem;">本欄位無符合日期的客戶</div>';
                    return;
                }

                container.innerHTML = reminders.map(row => {
                    const customer = customers.find(c => c.id === row.customer_id);
                    if (!customer) return '';

                    return `
                        <div class="reminder-card">
                            <div class="reminder-card-header">
                                <div class="reminder-card-info">
                                    <div class="reminder-card-company">${customer.companyName || customer.id}</div>
                                    <div class="reminder-card-details">
                                        聯絡人：${customer.contact || '未設定'} | 
                                        收取方式：${row.collect_method} | 
                                        預計收取：${row.planned_collect_date}
                                        ${row.note_reminder ? `<br>提醒備註：${row.note_reminder}` : ''}
                                    </div>
                                </div>
                                <div class="reminder-card-actions">
                                    <button class="btn btn-small btn-secondary" onclick="copyReminderMessage('${row.row_id}')">複製提醒</button>
                                    <button class="btn btn-small btn-primary" onclick="addToExportList('${row.row_id}')">加入匯出</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            // 複製提醒話術
            window.copyReminderMessage = (rowId) => {
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) return;

                const message = generateReminderMessage(row);
                navigator.clipboard.writeText(message).then(() => {
                    showToast('提醒話術已複製到剪貼簿');
                }).catch(() => {
                    showToast('複製失敗', 'error');
                });
            };

            // 生成提醒話術
            const generateReminderMessage = (row) => {
                const customer = customers.find(c => c.id === row.customer_id);
                const plannedDate = row.planned_collect_date;

                return `提醒您，我們已安排於【${plannedDate}】前往貴公司收取發票資料。

麻煩您協助確認以下資料是否已備妥：
✅ 本期所有進項與銷項發票、憑證
✅ 作廢發票、海關進口報單等其他證明文件

若有任何變動，請盡快回覆告知，謝謝！`;
            };

            // 渲染本期資料表格
            const renderVatDataTable = () => {
                const tbody = doc('vat-data-tbody');
                if (!currentVatData.rows.length) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">尚未新增任何客戶資料</td></tr>';
                    return;
                }

                tbody.innerHTML = currentVatData.rows.map(row => {
                    const customer = customers.find(c => c.id === row.customer_id);
                    if (!customer) return '';

                    return `
                        <tr data-row-id="${row.row_id}">
                            <td><input type="checkbox" class="row-checkbox" value="${row.row_id}"></td>
                            <td>
                                <div><strong>${customer.companyName || customer.id}</strong></div>
                                <div style="font-size: 0.9rem; color: var(--color-text-secondary);">
                                    ${customer.contact || '未設定'} | ${customer.phone || ''}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--color-text-secondary);">
                                    ${customer.regAddr || ''}
                                </div>
                            </td>
                            <td>${row.collect_method}</td>
                            <td>${row.planned_collect_date || '-'}</td>
                            <td>${row.tax_amount || '-'}</td>
                            <td>${row.note_invoice || '-'}</td>
                            <td>${row.note_reminder || '-'}</td>
                            <td class="vat-row-actions">
                                <button class="btn btn-small btn-secondary" onclick="editVatRow('${row.row_id}')">編輯</button>
                                <button class="btn btn-small btn-secondary" onclick="deleteVatRow('${row.row_id}')">刪除</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            };

            // 產生批次話術
            const generateBatchMessages = (rows, selectedMethods) => {
                const messages = {};

                selectedMethods.forEach(method => {
                    const methodRows = rows.filter(row => row.collect_method === method);
                    messages[method] = methodRows.map(row => {
                        const customer = customers.find(c => c.id === row.customer_id);
                        if (!customer) return '';

                        const contactName = customer.contact || '貴公司';
                        const period = currentVatData.period;
                        const periodText = `第${period}期`;
                        const deadline = currentVatData.last_collect_deadline;
                        const deadlineMinus2 = getDateMinus2(deadline);
                        const noteReminder = row.note_reminder ? `\n${row.note_reminder}` : '';

                        if (method === '自己寄送') {
                            return `${contactName}您好：

提醒您，本期（${periodText}）營業稅即將開始申報囉！

請您務必於${deadlineMinus2}前備妥所有進項、銷項發票及相關憑證（含作廢發票、進口報單等），並準備好交付本所。${noteReminder}

謝謝`;
                        } else {
                            return `${contactName}您好：

提醒您，本期（${periodText}）營業稅即將開始申報囉！

請問${deadlineMinus2}前的哪個時段過去貴公司收取資料比較方便呢？

請提供您方便的確切日期與時間，會盡快為您安排過去收取。`;
                        }
                    });
                });

                return messages;
            };

            // 顯示批次話術
            const displayBatchMessages = (messages) => {
                const previewDiv = doc('batch-message-preview');
                let html = '';

                Object.keys(messages).forEach(method => {
                    html += `<div class="message-group">
                        <h4>${method} (${messages[method].length} 筆)</h4>
                        <div class="message-list">`;

                    messages[method].forEach((message, index) => {
                        if (message.trim()) {
                            html += `<div class="message-item">
                                <div class="message-header">客戶 ${index + 1}</div>
                                <pre class="message-content">${message}</pre>
                                <button class="btn btn-small btn-secondary copy-message-btn" data-message="${encodeURIComponent(message)}">複製</button>
                            </div>`;
                        }
                    });

                    html += `</div></div>`;
                });

                previewDiv.innerHTML = html;
                previewDiv.style.display = 'block';

                // 綁定複製按鈕事件
                previewDiv.querySelectorAll('.copy-message-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const message = decodeURIComponent(e.target.dataset.message);
                        navigator.clipboard.writeText(message).then(() => {
                            showToast('話術已複製到剪貼簿');
                        }).catch(() => {
                            showToast('複製失敗', 'error');
                        });
                    });
                });
            };

            // 匯出營業稅資料到Excel
            const exportVatToExcel = (rows, exportType) => {
                try {
                    const excelData = [];

                    // 標題行
                    excelData.push([
                        'customer_id', 'company_name', 'contact_name', 'registered_address',
                        'collect_method', 'planned_collect_date', 'period', 'year',
                        'last_collect_deadline', 'deadline_minus2', 'note_invoice',
                        'note_reminder', 'message_type', 'message_preview'
                    ]);

                    // 資料行
                    rows.forEach(row => {
                        const customer = customers.find(c => c.id === row.customer_id);
                        if (!customer) return;

                        const deadline = currentVatData.last_collect_deadline;
                        const deadlineMinus2 = getDateMinus2(deadline);
                        const messageType = row.collect_method === '自己寄送' ? 'B-自己寄送' : 'B-到府收取';

                        // 產生完整話術
                        const contactName = customer.contact || '貴公司';
                        const period = currentVatData.period;
                        const periodText = `第${period}期`;
                        const noteReminder = row.note_reminder ? `\n${row.note_reminder}` : '';

                        let messagePreview = '';
                        if (row.collect_method === '自己寄送') {
                            messagePreview = `${contactName}您好：\n\n提醒您，本期（${periodText}）營業稅即將開始申報囉！\n\n請您務必於${deadlineMinus2}前備妥所有進項、銷項發票及相關憑證（含作廢發票、進口報單等），並準備好交付本所。${noteReminder}\n\n謝謝`;
                        } else {
                            messagePreview = `${contactName}您好：\n\n提醒您，本期（${periodText}）營業稅即將開始申報囉！\n\n請問${deadlineMinus2}前的哪個時段過去貴公司收取資料比較方便呢？\n\n請提供您方便的確切日期與時間，會盡快為您安排過去收取。`;
                        }

                        excelData.push([
                            customer.id,
                            customer.companyName || '',
                            customer.contact || '',
                            customer.regAddr || '',
                            row.collect_method,
                            row.planned_collect_date,
                            `第${currentVatData.period}期`,
                            currentVatData.year + 1911, // 轉為西元年
                            deadline,
                            deadlineMinus2,
                            row.note_invoice || '',
                            row.note_reminder || '',
                            messageType,
                            messagePreview
                        ]);
                    });

                    // 創建工作簿
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);

                    // 設定欄位寬度
                    ws['!cols'] = [
                        { width: 12 }, { width: 20 }, { width: 12 }, { width: 30 },
                        { width: 12 }, { width: 15 }, { width: 10 }, { width: 8 },
                        { width: 15 }, { width: 15 }, { width: 20 }, { width: 20 },
                        { width: 15 }, { width: 50 }
                    ];

                    // 凍結標題行
                    ws['!freeze'] = { xSplit: 0, ySplit: 1 };

                    XLSX.utils.book_append_sheet(wb, ws, "Notices");

                    // 匯出檔案
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/[-:]/g, '').slice(0, 13);
                    const fileName = `vat_notice_${timestamp}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                } catch (error) {
                    console.error('Excel匯出失敗:', error);
                    showToast('Excel匯出失敗', 'error');
                }
            };

            // 顯示新增客戶對話框
            const showAddVatRowDialog = () => {
                // patch: 2025-11-08 過濾已存在的客戶
                const existingCustomerIds = currentVatData.rows.map(r => r.customer_id);
                const availableCustomers = customers.filter(c => !existingCustomerIds.includes(c.id));

                if (availableCustomers.length === 0) {
                    showToast('所有客戶都已新增到本期資料中', 'error');
                    return;
                }

                const customerOptions = availableCustomers.map(c =>
                    `<option value="${c.id}">${c.companyName || c.id} (${c.contact || '未設定'})</option>`
                ).join('');

                const methodOptions = collectMethods.map(method =>
                    `<option value="${method}">${method}</option>`
                ).join('');

                const dialogHtml = `
                    <div class="modal-overlay" id="add-vat-row-modal">
                        <div class="modal-content">
                            <h3>新增客戶到本期資料</h3>
                            <div class="form-group">
                                <label>選擇客戶</label>
                                <select id="new-vat-customer">${customerOptions}</select>
                            </div>
                            <div class="form-group">
                                <label>收取發票方式</label>
                                <select id="new-vat-method">${methodOptions}</select>
                            </div>
                            <div class="form-group">
                                <label>預計收取日</label>
                                <input type="date" id="new-vat-date">
                            </div>
                            <div class="form-group">
                                <label>稅金（選填，可後補）</label>
                                <input type="number" id="new-vat-tax-amount" placeholder="選填" min="0">
                            </div>
                            <div class="form-group">
                                <label>備註-發票</label>
                                <input type="text" id="new-vat-note-invoice" placeholder="選填">
                            </div>
                            <div class="form-group">
                                <label>備註-提醒</label>
                                <input type="text" id="new-vat-note-reminder" placeholder="選填">
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-primary" onclick="confirmAddVatRow()">確定新增</button>
                                <button class="btn btn-secondary" onclick="closeAddVatRowDialog()">取消</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', dialogHtml);
            };

            // 關閉新增客戶對話框
            window.closeAddVatRowDialog = () => {
                const modal = doc('add-vat-row-modal');
                if (modal) modal.remove();
            };

            // 確認新增客戶
            window.confirmAddVatRow = () => {
                const customerId = doc('new-vat-customer').value;
                const method = doc('new-vat-method').value;
                const date = doc('new-vat-date').value;
                const taxAmount = doc('new-vat-tax-amount')?.value || ''; // patch: 2025-11-08 稅金可選填
                const noteInvoice = doc('new-vat-note-invoice').value;
                const noteReminder = doc('new-vat-note-reminder').value;

                if (!customerId || !method) {
                    showToast('請選擇客戶和收取方式', 'error');
                    return;
                }

                // 檢查是否已存在（雙重檢查）
                const exists = currentVatData.rows.some(row => row.customer_id === customerId);
                if (exists) {
                    showToast('此客戶已存在於本期資料中', 'error');
                    return;
                }

                const newRow = {
                    row_id: `vat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    customer_id: customerId,
                    collect_method: method,
                    planned_collect_date: date,
                    tax_amount: taxAmount, // patch: 2025-11-08 稅金可後填
                    received: false, // patch: 2025-11-08 已收到狀態
                    appointment_date: '', // patch: 2025-11-08 約收發票日期
                    note_invoice: noteInvoice,
                    note_reminder: noteReminder,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                currentVatData.rows.push(newRow);

                // 記錄歷史
                currentVatData.history.push({
                    timestamp: new Date().toISOString(),
                    action: '新增',
                    summary: `新增客戶 ${customers.find(c => c.id === customerId)?.companyName || customerId}`
                });

                saveVatData();
                renderVatDataTable();
                closeAddVatRowDialog();
                showToast('客戶已新增到本期資料');
            };

            // patch: 2025-11-09 獲取日期減2天（往前推2天）
            const getDateMinus2 = (dateStr) => {
                if (!dateStr) return '';
                
                console.log('getDateMinus2 輸入:', dateStr);
                
                const date = new Date(dateStr);
                console.log('原始日期:', date.toISOString());
                
                // 減2天
                date.setDate(date.getDate() - 2);
                console.log('減2天後:', date.toISOString());
                
                const year = date.getFullYear() - 1911; // 民國年
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                const weekday = weekdays[date.getDay()];
                
                const result = `${year}-${month}-${day}（週${weekday}）`;
                console.log('getDateMinus2 輸出:', result);
                
                return result;
            };

            // 編輯營業稅資料行
            window.editVatRow = (rowId) => {
                console.log('編輯營業稅資料行:', rowId);
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) {
                    showToast('找不到要編輯的資料', 'error');
                    return;
                }

                const customer = customers.find(c => c.id === row.customer_id);
                if (!customer) {
                    showToast('找不到對應的客戶資料', 'error');
                    return;
                }

                showEditVatRowDialog(row, customer);
            };

            // 顯示編輯客戶對話框
            const showEditVatRowDialog = (row, customer) => {
                const methodOptions = collectMethods.map(method =>
                    `<option value="${method}" ${method === row.collect_method ? 'selected' : ''}>${method}</option>`
                ).join('');

                const dialogHtml = `
                    <div class="modal-overlay" id="edit-vat-row-modal">
                        <div class="modal-content">
                            <h3>編輯客戶資料</h3>
                            <div class="form-group">
                                <label>客戶資訊</label>
                                <div style="background: var(--color-surface-light); padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                                    <div><strong>${customer.companyName || customer.id}</strong></div>
                                    <div style="color: var(--color-text-secondary); font-size: 0.9rem;">
                                        ${customer.contact || '未設定'} | ${customer.phone || ''}
                                    </div>
                                    <div style="color: var(--color-text-secondary); font-size: 0.8rem;">
                                        ${customer.regAddr || ''}
                                    </div>
                                    <div style="margin-top: 0.5rem;">
                                        <a href="#" onclick="showPage('page-list'); closeEditVatRowDialog();" style="color: var(--color-accent-gold); font-size: 0.8rem;">
                                            → 到客戶列表編輯基本資料
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>收取發票方式</label>
                                <select id="edit-vat-method">${methodOptions}</select>
                            </div>
                            <div class="form-group">
                                <label>預計收取日</label>
                                <input type="date" id="edit-vat-date" value="${row.planned_collect_date || ''}">
                            </div>
                            <div class="form-group">
                                <label>稅金</label>
                                <input type="number" id="edit-vat-tax-amount" value="${row.tax_amount || ''}" placeholder="選填" min="0">
                            </div>
                            <div class="form-group">
                                <label>備註-發票</label>
                                <input type="text" id="edit-vat-note-invoice" value="${row.note_invoice || ''}" placeholder="選填">
                            </div>
                            <div class="form-group">
                                <label>備註-提醒</label>
                                <input type="text" id="edit-vat-note-reminder" value="${row.note_reminder || ''}" placeholder="選填">
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-primary" onclick="confirmEditVatRow('${row.row_id}')">確定更新</button>
                                <button class="btn btn-secondary" onclick="closeEditVatRowDialog()">取消</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', dialogHtml);
            };

            // 關閉編輯客戶對話框
            window.closeEditVatRowDialog = () => {
                const modal = doc('edit-vat-row-modal');
                if (modal) modal.remove();
            };

            // 確認編輯客戶
            window.confirmEditVatRow = (rowId) => {
                const method = doc('edit-vat-method').value;
                const date = doc('edit-vat-date').value;
                const taxAmount = doc('edit-vat-tax-amount')?.value || ''; // patch: 2025-11-08
                const noteInvoice = doc('edit-vat-note-invoice').value;
                const noteReminder = doc('edit-vat-note-reminder').value;

                if (!method) {
                    showToast('請選擇收取方式', 'error');
                    return;
                }

                const rowIndex = currentVatData.rows.findIndex(r => r.row_id === rowId);
                if (rowIndex === -1) {
                    showToast('找不到要更新的資料', 'error');
                    return;
                }

                // 保存原始資料用於歷史記錄
                const originalRow = { ...currentVatData.rows[rowIndex] };

                // 更新資料
                currentVatData.rows[rowIndex] = {
                    ...currentVatData.rows[rowIndex],
                    collect_method: method,
                    planned_collect_date: date,
                    tax_amount: taxAmount, // patch: 2025-11-08
                    note_invoice: noteInvoice,
                    note_reminder: noteReminder,
                    updated_at: new Date().toISOString()
                };

                // 記錄歷史
                const customer = customers.find(c => c.id === currentVatData.rows[rowIndex].customer_id);
                const changes = [];
                if (originalRow.collect_method !== method) changes.push(`收取方式: ${originalRow.collect_method} → ${method}`);
                if (originalRow.planned_collect_date !== date) changes.push(`預計收取日: ${originalRow.planned_collect_date || '未設定'} → ${date || '未設定'}`);
                if (originalRow.note_invoice !== noteInvoice) changes.push(`備註-發票: ${originalRow.note_invoice || '空'} → ${noteInvoice || '空'}`);
                if (originalRow.note_reminder !== noteReminder) changes.push(`備註-提醒: ${originalRow.note_reminder || '空'} → ${noteReminder || '空'}`);

                currentVatData.history.push({
                    timestamp: new Date().toISOString(),
                    action: '編輯',
                    summary: `編輯客戶 ${customer?.companyName || rowId}${changes.length > 0 ? ': ' + changes.join(', ') : ''}`
                });

                saveVatData();
                renderVatDataTable();
                renderReminderLists(); // 重新渲染提醒列表
                renderUnreceivedReminder(); // patch: 2025-11-08 重新渲染未收提醒
                closeEditVatRowDialog();
                showToast('客戶資料已更新');
            };

            // patch: 2025-11-08 設定約收日期
            window.setAppointmentDate = (rowId) => {
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) return;

                const customer = customers.find(c => c.id === row.customer_id);
                const customerName = customer ? (customer.companyName || customer.id) : '未知客戶';

                const date = prompt(`設定「${customerName}」的約收發票日期：\n\n請輸入日期（格式：YYYY-MM-DD）`, row.appointment_date || '');
                
                if (date === null) return; // 取消
                
                if (date && !/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                    showToast('日期格式錯誤，請使用 YYYY-MM-DD 格式', 'error');
                    return;
                }

                row.appointment_date = date;
                row.updated_at = new Date().toISOString();

                currentVatData.history.push({
                    timestamp: new Date().toISOString(),
                    action: '設定約收日期',
                    summary: `${customerName} - 約收日期: ${date || '清除'}`
                });

                saveVatData();
                renderVatDataTable();
                showToast(date ? '約收日期已設定' : '約收日期已清除');
            };

            // patch: 2025-11-08 表格排序功能
            let currentSort = { column: null, direction: 'asc' };

            const sortVatTable = (column) => {
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }

                const rows = [...currentVatData.rows];

                rows.sort((a, b) => {
                    let aVal, bVal;

                    switch (column) {
                        case 'customer':
                            const aCustomer = customers.find(c => c.id === a.customer_id);
                            const bCustomer = customers.find(c => c.id === b.customer_id);
                            aVal = aCustomer?.companyName || aCustomer?.id || '';
                            bVal = bCustomer?.companyName || bCustomer?.id || '';
                            break;
                        case 'method':
                            aVal = a.collect_method || '';
                            bVal = b.collect_method || '';
                            break;
                        case 'date':
                            aVal = a.planned_collect_date || '';
                            bVal = b.planned_collect_date || '';
                            break;
                        case 'note-invoice':
                            aVal = a.note_invoice || '';
                            bVal = b.note_invoice || '';
                            break;
                        case 'note-reminder':
                            aVal = a.note_reminder || '';
                            bVal = b.note_reminder || '';
                            break;
                        default:
                            return 0;
                    }

                    if (currentSort.direction === 'asc') {
                        return aVal.localeCompare(bVal, 'zh-TW');
                    } else {
                        return bVal.localeCompare(aVal, 'zh-TW');
                    }
                });

                currentVatData.rows = rows;
                renderVatDataTable();

                // 更新排序圖示
                document.querySelectorAll('.vat-data-table th.sortable').forEach(th => {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                });
                const sortedTh = document.querySelector(`.vat-data-table th[data-sort="${column}"]`);
                if (sortedTh) {
                    sortedTh.classList.add(`sorted-${currentSort.direction}`);
                }
            };

            // 刪除營業稅資料行
            window.deleteVatRow = (rowId) => {
                const row = currentVatData.rows.find(r => r.row_id === rowId);
                if (!row) return;

                const customer = customers.find(c => c.id === row.customer_id);
                const customerName = customer?.companyName || row.customer_id;

                if (confirm(`確定要刪除客戶「${customerName}」的資料嗎？\n\n此筆將被移除，可在編輯紀錄回朔復原。`)) {
                    currentVatData.rows = currentVatData.rows.filter(r => r.row_id !== rowId);

                    // 記錄歷史
                    currentVatData.history.push({
                        timestamp: new Date().toISOString(),
                        action: '刪除',
                        summary: `刪除客戶 ${customerName}`
                    });

                    saveVatData();
                    renderVatDataTable();
                    showToast('資料已刪除');
                }
            };

            // --- 營業稅事件處理器 ---
            // patch: 2025-11-09 期數變更時儲存選擇
            doc('vat-year')?.addEventListener('change', () => {
                savePeriodSelection();
                loadCurrentVatPeriod();
            });
            doc('vat-period')?.addEventListener('change', () => {
                savePeriodSelection();
                loadCurrentVatPeriod();
            });
            doc('vat-deadline')?.addEventListener('change', () => {
                if (currentVatData) {
                    currentVatData.last_collect_deadline = doc('vat-deadline').value;
                    saveVatData();
                }
            });

            doc('add-collect-method-btn')?.addEventListener('click', addCollectMethod);

            // patch: 2025-11-08 套用訊息模板到營業稅客戶
            doc('apply-vat-template-btn')?.addEventListener('click', () => {
                console.log('=== 套用訊息模板到營業稅客戶 ===');
                
                if (!currentVatData || currentVatData.rows.length === 0) {
                    showToast('本期沒有客戶資料', 'error');
                    return;
                }
                
                const selectedMethods = Array.from(document.querySelectorAll('#collect-method-checkboxes input:checked'))
                    .map(cb => cb.value);

                if (selectedMethods.length === 0) {
                    showToast('請先選擇收取發票方式', 'error');
                    return;
                }

                const filteredRows = currentVatData.rows.filter(row =>
                    selectedMethods.includes(row.collect_method)
                );

                if (filteredRows.length === 0) {
                    showToast('沒有符合條件的客戶資料', 'error');
                    return;
                }
                
                // 取得對應的客戶資料
                const selectedCustomers = filteredRows.map(row => {
                    return customers.find(c => c.id === row.customer_id);
                }).filter(c => c);
                
                if (selectedCustomers.length === 0) {
                    showToast('找不到對應的客戶資料', 'error');
                    return;
                }
                
                // 顯示模板選擇器（只顯示營業稅模板）
                showVatTemplateSelectorModal((template) => {
                    console.log('========================================');
                    console.log('=== 套用營業稅模板 - 開始 ===');
                    console.log('========================================');
                    console.log('選擇的模板:', template);
                    console.log('模板內容:', template.content);
                    console.log('currentVatData:', currentVatData);
                    console.log('selectedCustomers:', selectedCustomers);
                    console.log('filteredRows:', filteredRows);
                    
                    // patch: 2025-11-09 更新 tagSystem 的營業稅資料
                    console.log('設定前 - tagSystem:', tagSystem);
                    console.log('設定前 - tagSystem.vatData:', tagSystem.vatData);
                    
                    tagSystem.vatData = currentVatData;
                    
                    console.log('設定後 - tagSystem:', tagSystem);
                    console.log('設定後 - tagSystem.vatData:', tagSystem.vatData);
                    console.log('設定後 - tagSystem.vatData.period:', tagSystem.vatData?.period);
                    console.log('設定後 - tagSystem.vatData.year:', tagSystem.vatData?.year);
                    console.log('設定後 - tagSystem.vatData.last_collect_deadline:', tagSystem.vatData?.last_collect_deadline);
                    
                    // 驗證設定是否成功
                    console.log('驗證 - tagSystem.vatData === currentVatData:', tagSystem.vatData === currentVatData);
                    console.log('驗證 - typeof tagSystem.vatData:', typeof tagSystem.vatData);
                    
                    // 產生訊息（傳入營業稅資料）
                    console.log('');
                    console.log('=== 開始產生訊息 ===');
                    console.log('呼叫前 - tagSystem.vatData:', tagSystem.vatData);
                    const messages = tagSystem.generateMessages(template.content, selectedCustomers, filteredRows);
                    console.log('呼叫後 - tagSystem.vatData:', tagSystem.vatData);
                    
                    console.log('');
                    console.log('=== 訊息產生完成 ===');
                    console.log('已產生訊息:', messages.length, '筆');
                    if (messages.length > 0) {
                        console.log('第一筆訊息範例:');
                        console.log('  客戶:', messages[0].customer);
                        console.log('  訊息:', messages[0].message);
                    }
                    console.log('========================================');
                    console.log('');
                    
                    // 增加使用次數
                    templateManager.incrementUsage(template.id);
                    
                    // 顯示訊息預覽
                    showMessagePreviewModal(messages);
                    
                    showToast(`已產生 ${messages.length} 筆訊息`, 'success');
                });
            });

            // 載入他期作為草稿
            doc('load-other-period-btn')?.addEventListener('click', () => {
                console.log('=== 載入他期作為草稿 ===');
                const currentYear = parseInt(doc('vat-year').value);
                const currentPeriod = parseInt(doc('vat-period').value);

                const periodOptions = [
                    { value: 1, text: '第1期 (01-02月)' },
                    { value: 2, text: '第2期 (03-04月)' },
                    { value: 3, text: '第3期 (05-06月)' },
                    { value: 4, text: '第4期 (07-08月)' },
                    { value: 5, text: '第5期 (09-10月)' },
                    { value: 6, text: '第6期 (11-12月)' }
                ];

                const availablePeriods = periodOptions.filter(p => p.value !== currentPeriod);
                const periodList = availablePeriods.map(p => `${p.value}. ${p.text}`).join('\n');

                const selectedPeriod = prompt(`請選擇要載入的期數：\n${periodList}\n\n請輸入期數 (1-6):`);

                if (selectedPeriod && /^[1-6]$/.test(selectedPeriod)) {
                    const sourcePeriod = parseInt(selectedPeriod);
                    const sourceData = loadVatData(currentYear, sourcePeriod);

                    if (sourceData.rows.length === 0) {
                        showToast(`第${sourcePeriod}期沒有資料可載入`, 'error');
                        return;
                    }

                    if (confirm(`確定要載入第${sourcePeriod}期的 ${sourceData.rows.length} 筆資料作為草稿嗎？\n\n注意：這不會覆蓋現有資料，而是作為新增的草稿。`)) {
                        // 複製資料但重新生成ID和時間
                        const draftRows = sourceData.rows.map(row => ({
                            ...row,
                            row_id: `vat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            planned_collect_date: '', // 清空預計收取日，需要重新設定
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }));

                        currentVatData.rows.push(...draftRows);
                        saveVatData();
                        renderVatDataTable();
                        showToast(`已載入 ${draftRows.length} 筆草稿資料`);
                    }
                } else if (selectedPeriod) {
                    showToast('請輸入有效的期數 (1-6)', 'error');
                }
            });

            // 編輯紀錄
            doc('vat-history-btn')?.addEventListener('click', () => {
                console.log('=== 查看編輯紀錄 ===');
                if (!currentVatData || currentVatData.history.length === 0) {
                    showToast('目前沒有編輯紀錄');
                    return;
                }

                const historyList = currentVatData.history
                    .slice(-10) // 只顯示最近10筆
                    .reverse()
                    .map((entry, index) => {
                        const date = new Date(entry.timestamp).toLocaleString('zh-TW');
                        return `${index + 1}. ${date}\n   ${entry.action}: ${entry.summary}`;
                    })
                    .join('\n\n');

                alert(`編輯紀錄 (最近10筆):\n\n${historyList}`);
            });

            // 一鍵產生話術
            doc('generate-batch-message-btn')?.addEventListener('click', () => {
                console.log('=== 一鍵產生話術 ===');
                const selectedMethods = Array.from(document.querySelectorAll('#collect-method-checkboxes input:checked'))
                    .map(cb => cb.value);

                if (selectedMethods.length === 0) {
                    showToast('請先選擇收取發票方式', 'error');
                    return;
                }

                const filteredRows = currentVatData.rows.filter(row =>
                    selectedMethods.includes(row.collect_method)
                );

                if (filteredRows.length === 0) {
                    showToast('沒有符合條件的客戶資料', 'error');
                    return;
                }

                const messages = generateBatchMessages(filteredRows, selectedMethods);
                displayBatchMessages(messages);
                showToast(`已產生 ${filteredRows.length} 筆客戶的話術`);
            });

            // 匯出批次Excel
            doc('export-batch-excel-btn')?.addEventListener('click', () => {
                console.log('=== 匯出批次Excel ===');
                const selectedMethods = Array.from(document.querySelectorAll('#collect-method-checkboxes input:checked'))
                    .map(cb => cb.value);

                if (selectedMethods.length === 0) {
                    showToast('請先選擇收取發票方式', 'error');
                    return;
                }

                const filteredRows = currentVatData.rows.filter(row =>
                    selectedMethods.includes(row.collect_method)
                );

                if (filteredRows.length === 0) {
                    showToast('沒有符合條件的客戶資料可匯出', 'error');
                    return;
                }

                exportVatToExcel(filteredRows, `批次話術_${selectedMethods.join('_')}`);
            });

            // 新增客戶到本期資料
            doc('add-vat-row-btn')?.addEventListener('click', () => {
                console.log('=== 新增客戶到本期資料 ===');
                showAddVatRowDialog();
            });

            // 匯出本期資料
            doc('export-period-data-btn')?.addEventListener('click', () => {
                console.log('=== 匯出本期資料 ===');
                if (currentVatData.rows.length === 0) {
                    showToast('本期沒有資料可匯出', 'error');
                    return;
                }

                const selectedRows = Array.from(document.querySelectorAll('#vat-data-tbody input[type="checkbox"]:checked'))
                    .map(cb => currentVatData.rows.find(row => row.row_id === cb.value))
                    .filter(row => row);

                const exportRows = selectedRows.length > 0 ? selectedRows : currentVatData.rows;
                const exportType = selectedRows.length > 0 ? '選取資料' : '全部資料';

                exportVatToExcel(exportRows, `本期資料_${exportType}`);
                showToast(`已匯出 ${exportRows.length} 筆${exportType}`);
            });

            // JSON 匯出功能
            doc('m2-json-export')?.addEventListener('click', () => {
                try {
                    const storedData = localStorage.getItem(VAT_STORAGE_KEY);
                    let vatData = {};
                    
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        // 檢查新舊格式
                        if (parsedData.vatData) {
                            vatData = parsedData.vatData;
                        } else {
                            vatData = parsedData;
                        }
                    }
                    
                    downloadJSON(`vat_data_${Date.now()}.json`, vatData);
                } catch (error) {
                    console.error('JSON 匯出失敗:', error);
                    showToast('JSON 匯出失敗', 'error');
                }
            });

            // 營業稅備份功能
            doc('vat-backup-btn')?.addEventListener('click', () => {
                exportVatBackup();
            });

            // 營業稅還原備份功能
            doc('vat-restore-btn')?.addEventListener('click', () => {
                if (confirm('確定要還原營業稅備份資料嗎？這將覆蓋目前的資料。')) {
                    const year = parseInt(doc('vat-year').value);
                    const period = parseInt(doc('vat-period').value);
                    const backupData = loadVatBackupData(year, period);
                    
                    if (backupData) {
                        currentVatData = backupData;
                        saveVatData();
                        renderVatDataTable();
                        renderReminderLists();
                        showToast('營業稅備份資料已還原');
                    } else {
                        showToast('沒有找到對應期數的備份資料', 'error');
                    }
                }
            });

            // JSON 匯入按鈕觸發檔案選擇
            doc('m2-json-import-btn')?.addEventListener('click', () => {
                doc('m2-json-in').click();
            });

            // JSON 匯入功能
            doc('m2-json-in')?.addEventListener('change', (e) => {
                const f = e.target.files && e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = async () => {
                    try {
                        const obj = JSON.parse(r.result);
                        if (!obj || typeof obj !== 'object') {
                            throw new Error('格式需為有效的 JSON 物件');
                        }
                        
                        // 檢查是否為新的備份格式
                        let vatDataToImport;
                        if (obj.type === 'vat_backup' && obj.vatData) {
                            vatDataToImport = obj.vatData;
                        } else {
                            vatDataToImport = obj;
                        }
                        
                        // 使用新的儲存格式
                        const dataToSave = {
                            vatData: vatDataToImport,
                            lastModified: new Date().toISOString(),
                            totalPeriods: Object.keys(vatDataToImport).length
                        };
                        
                        localStorage.setItem(VAT_STORAGE_KEY, JSON.stringify(dataToSave));
                        
                        // 重新載入當前期數資料
                        loadCurrentVatPeriod();
                        showToast('營業稅 JSON 匯入完成', 'success');
                    } catch (err) {
                        console.error('JSON 匯入失敗:', err);
                        showToast('JSON 解析失敗：' + err.message, 'error');
                    }
                };
                r.readAsText(f);
            });

            // --- 客戶列表搜尋和匯出功能 ---
            let filteredCustomers = [...customers]; // 搜尋後的結果
            let customerSearchTimeout = null; // patch: 2025-11-09 重新命名避免衝突

            // 關鍵字搜尋功能
            const searchCustomers = (keyword) => {
                if (!keyword.trim()) {
                    filteredCustomers = [...customers];
                    updateExportInfo();
                    enhancedRenderCustomerTable();
                    return;
                }

                const searchTerm = keyword.toLowerCase();
                filteredCustomers = customers.filter(customer => {
                    // 搜尋欄位：公司名稱、聯絡人、地址、Email、電話、標籤
                    const searchFields = [
                        customer.companyName || '',
                        customer.contact || '',
                        customer.regAddr || '',
                        customer.contactAddr || '',
                        customer.email || '',
                        customer.phone || '',
                        customer.taxId || '',
                        customer.taxAddr || '',
                        // 標籤搜尋（如果有備註標籤）
                        ...(customer.notes ? customer.notes.flatMap(note => note.tags || []) : [])
                    ];

                    return searchFields.some(field =>
                        field.toLowerCase().includes(searchTerm)
                    );
                });

                console.log(`搜尋關鍵字: "${keyword}", 找到 ${filteredCustomers.length} 筆結果`);
                updateExportInfo();
                renderFilteredCustomerTable();
            };

            // 渲染篩選後的客戶表格
            const renderFilteredCustomerTable = () => {
                const ui = {
                    customerBody: doc('customer-list-body')
                };

                if (filteredCustomers.length === 0) {
                    ui.customerBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--color-text-secondary);">沒有符合搜尋條件的客戶資料</td></tr>';
                    return;
                }

                ui.customerBody.innerHTML = filteredCustomers.map(c => {
                    const days = getDaysRemaining(c.leaseEnd);
                    const isExpiring = days <= EXPIRE_SOON_DAYS && days > 0;
                    const isExpired = days <= 0;
                    const rowClass = isExpired ? 'expired' : isExpiring ? 'expiring-soon' : '';
                    const leaseEndClass = isExpired ? 'lease-end-cell expired' : isExpiring ? 'lease-end-cell expiring' : 'lease-end-cell';

                    return `<tr data-id="${c.id}" class="${rowClass}">
                        <td>${escapeHTML(c.id)}<br>${escapeHTML(c.companyName)}</td>
                        <td>${escapeHTML(c.contact) || '-'}<br>${escapeHTML(c.phone) || '-'}</td>
                        <td>${escapeHTML(c.taxId) || '-'}<br>${c.taxAddr ? `稅籍:${escapeHTML(c.taxAddr)}` : '-'}</td>
                        <td>${c.regAddr ? `設籍:${escapeHTML(c.regAddr)}` : ''}${c.regAddr && c.contactAddr ? '<br>' : ''}${c.contactAddr ? `聯絡:${escapeHTML(c.contactAddr)}` : ''}</td>
                        <td>${toROCDate(c.leaseStart) || '-'}</td>
                        <td class="${leaseEndClass}">${toROCDate(c.leaseEnd) || '-'}</td>
                        <td class="table-row-actions">
                            <div class="action-buttons-grid">
                                <button type="button" class="btn-action btn-view-notes">查看備註</button>
                                <button type="button" class="btn-action btn-edit">編輯</button>
                                <button type="button" class="btn-action btn-delete">刪除</button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
            };

            // 更新匯出資訊
            const updateExportInfo = () => {
                const exportInfo = document.querySelector('.export-info');
                const exportBtn = doc('export-customers-excel-btn');

                if (filteredCustomers.length === 0) {
                    if (exportInfo) exportInfo.textContent = '目前無可匯出的資料';
                    if (exportBtn) {
                        exportBtn.disabled = true;
                        exportBtn.title = '目前無可匯出的資料';
                    }
                } else {
                    const searchInput = doc('customer-search-input');
                    const hasSearch = searchInput && searchInput.value.trim();
                    const infoText = hasSearch ?
                        `匯出：搜尋結果 (${filteredCustomers.length} 筆)` :
                        `匯出：全部客戶 (${filteredCustomers.length} 筆)`;

                    if (exportInfo) exportInfo.textContent = infoText;
                    if (exportBtn) {
                        exportBtn.disabled = false;
                        exportBtn.title = '';
                    }
                }
            };

            // 匯出客戶Excel
            // patch: 2025-11-08 新增欄寬列高自動調整功能
            const exportCustomersToExcel = () => {
                if (filteredCustomers.length === 0) {
                    showToast('沒有可匯出的資料', 'error');
                    return;
                }

                try {
                    const excelData = [];

                    // 標題行
                    excelData.push([
                        'customer_id', 'company_name', 'contact_name', 'email', 'phone',
                        'registered_address', 'lease_end_date', 'tags'
                    ]);

                    // 資料行
                    filteredCustomers.forEach(customer => {
                        const tags = customer.notes ?
                            [...new Set(customer.notes.flatMap(note => note.tags || []))]
                                .map(tag => tag.toLowerCase())
                                .join('; ') : '';

                        const leaseEndDate = customer.leaseEnd ?
                            new Date(customer.leaseEnd).toISOString().split('T')[0].replace(/-/g, '/') : '';

                        excelData.push([
                            customer.id || '',
                            customer.companyName || '',
                            customer.contact || '',
                            customer.email || '',
                            customer.phone || '',
                            customer.regAddr || '',
                            leaseEndDate,
                            tags
                        ]);
                    });

                    // 創建工作簿
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);

                    // patch: 2025-11-08 自動計算欄寬
                    const colWidths = [];
                    for (let col = 0; col < 8; col++) {
                        let maxWidth = 10;
                        for (let row = 0; row < excelData.length; row++) {
                            const cellValue = excelData[row][col] || '';
                            const cellLength = String(cellValue).length;
                            if (cellLength > maxWidth) {
                                maxWidth = cellLength;
                            }
                        }
                        colWidths.push({ wch: Math.min(maxWidth + 2, 50) });
                    }
                    ws['!cols'] = colWidths;

                    // patch: 2025-11-08 設定列高（標題行較高）
                    ws['!rows'] = [{ hpt: 25 }];
                    for (let i = 1; i < excelData.length; i++) {
                        ws['!rows'].push({ hpt: 18 });
                    }

                    // 凍結標題行
                    ws['!freeze'] = { xSplit: 0, ySplit: 1 };

                    // 設定標題行樣式
                    const headerStyle = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "D4AF37" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };

                    for (let col = 0; col < 8; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }

                    XLSX.utils.book_append_sheet(wb, ws, "Customers");

                    // 匯出檔案
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/[-:]/g, '').slice(0, 13);
                    const fileName = `customers_${timestamp}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    showToast(`✅ 已匯出 ${filteredCustomers.length} 筆客戶資料（已自動調整欄寬列高）`);

                } catch (error) {
                    console.error('Excel匯出失敗:', error);
                    showToast('匯出失敗，請重試', 'error');
                }
            };

            // 搜尋輸入事件
            doc('customer-search-input')?.addEventListener('input', (e) => {
                const keyword = e.target.value;
                const clearBtn = doc('clear-search-btn');

                // 顯示/隱藏清除按鈕
                if (clearBtn) {
                    clearBtn.style.display = keyword ? 'block' : 'none';
                }

                // Debounce搜尋
                if (customerSearchTimeout) clearTimeout(customerSearchTimeout);
                customerSearchTimeout = setTimeout(() => {
                    searchCustomers(keyword);
                }, 300);
            });

            // 清除搜尋
            doc('clear-search-btn')?.addEventListener('click', () => {
                const searchInput = doc('customer-search-input');
                const clearBtn = doc('clear-search-btn');

                if (searchInput) searchInput.value = '';
                if (clearBtn) clearBtn.style.display = 'none';

                filteredCustomers = [...customers];
                updateExportInfo();
                enhancedRenderCustomerTable();
            });

            // 匯出Excel按鈕事件
            doc('export-customers-excel-btn')?.addEventListener('click', exportCustomersToExcel);

            // 建立增強版的客戶表格渲染函數
            const enhancedRenderCustomerTable = () => {
                // 如果沒有搜尋，使用原有邏輯
                const searchInput = doc('customer-search-input');
                if (!searchInput || !searchInput.value.trim()) {
                    filteredCustomers = [...customers];
                    updateExportInfo();
                }
                
                // 使用篩選後的渲染邏輯
                renderFilteredCustomerTable();
            };

            // --- INITIAL RENDER --- 
            console.log('=== 系統初始化 ===');
            console.log('載入的客戶資料筆數:', customers.length);

            // 初始化儲存統計
            updateStorageStats();
            updateVatStorageStats();

            // 顯示載入完成提示
            if (localStorage.getItem(STORAGE_KEY)) {
                showToast(`已載入 ${customers.length} 筆客戶資料`);
            } else {
                showToast('使用預設資料，首次使用請新增客戶資料');
            }

            renderAll();

            // ========================================
            // patch: 2025-11-09 Advanced Features
            // Global Search Initialization
            // ========================================
            
            // 初始化全域搜尋
            globalSearch = new GlobalSearch(customers, templateManager.templates);
            
            // 全域搜尋按鈕事件
            const initColumnResize = () => {
                const table = document.querySelector('.data-table');
                if (!table) return;

                const thead = table.querySelector('thead tr');
                if (!thead) return;

                const ths = thead.querySelectorAll('th');
                let isResizing = false;
                let currentTh = null;
                let startX = 0;
                let startWidth = 0;

                // 為每個 th 新增拖曳手柄
                ths.forEach((th, index) => {
                    // 跳過最後一欄（操作欄）
                    if (index === ths.length - 1) return;

                    th.classList.add('resizable');

                    // 建立拖曳手柄
                    const handle = document.createElement('div');
                    handle.className = 'resize-handle';
                    th.appendChild(handle);

                    // 拖曳開始
                    handle.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        isResizing = true;
                        currentTh = th;
                        startX = e.pageX;
                        startWidth = th.offsetWidth;
                        handle.classList.add('resizing');
                        document.body.style.cursor = 'col-resize';
                        document.body.style.userSelect = 'none';
                    });

                    // 雙擊自動調整
                    handle.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        autoFitColumn(th, index);
                    });
                });

                // 拖曳中
                document.addEventListener('mousemove', (e) => {
                    if (!isResizing || !currentTh) return;
                    
                    const diff = e.pageX - startX;
                    const newWidth = Math.max(50, startWidth + diff);
                    currentTh.style.width = newWidth + 'px';
                });

                // 拖曳結束
                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        
                        const handles = document.querySelectorAll('.resize-handle');
                        handles.forEach(h => h.classList.remove('resizing'));
                        
                        currentTh = null;
                    }
                });

                // 自動調整欄寬到最適大小
                const autoFitColumn = (th, colIndex) => {
                    const table = th.closest('table');
                    if (!table) return;

                    const rows = table.querySelectorAll('tbody tr');
                    let maxWidth = 0;

                    // 計算標題寬度
                    const tempSpan = document.createElement('span');
                    tempSpan.style.visibility = 'hidden';
                    tempSpan.style.position = 'absolute';
                    tempSpan.style.whiteSpace = 'nowrap';
                    tempSpan.style.font = window.getComputedStyle(th).font;
                    tempSpan.textContent = th.textContent;
                    document.body.appendChild(tempSpan);
                    maxWidth = tempSpan.offsetWidth + 40;
                    document.body.removeChild(tempSpan);

                    // 計算每一行的內容寬度
                    rows.forEach(row => {
                        const cell = row.querySelectorAll('td')[colIndex];
                        if (!cell) return;

                        const span = document.createElement('span');
                        span.style.visibility = 'hidden';
                        span.style.position = 'absolute';
                        span.style.whiteSpace = 'nowrap';
                        span.style.font = window.getComputedStyle(cell).font;
                        span.textContent = cell.textContent;
                        document.body.appendChild(span);
                        const width = span.offsetWidth + 40;
                        if (width > maxWidth) maxWidth = width;
                        document.body.removeChild(span);
                    });

                    // 設定最大寬度限制
                    maxWidth = Math.min(maxWidth, 500);
                    th.style.width = maxWidth + 'px';
                    
                    showToast(`已自動調整欄寬至 ${maxWidth}px`);
                };
            };

            // 在表格渲染後初始化欄寬調整
            setTimeout(() => {
                initColumnResize();
            }, 100);

            // patch: 2025-11-08 初始化預設營業稅模板
            initializeDefaultVatTemplates();

            // 初始化收取方式（確保在營業稅頁面正確顯示）
            console.log('載入的收取方式:', collectMethods);

            // ========================================
            // patch: 2025-11-09 Settings Page Functions
            // ========================================

            const APP_SETTINGS_KEY = 'app-settings/v1';

            // 預設設定
            const defaultSettings = {
                expireDays: 30,
                urgentDays: 7,
                timelineDays: 90,
                theme: 'dark',
                fontSize: 'medium',
                autoBackup: true,
                backupFrequency: 7,
                debugMode: false,
                performanceMode: false
            };

            // 載入設定
            let appSettings = { ...defaultSettings };
            try {
                const saved = localStorage.getItem(APP_SETTINGS_KEY);
                if (saved) {
                    appSettings = { ...defaultSettings, ...JSON.parse(saved) };
                }
            } catch (e) {
                console.error('載入設定失敗:', e);
            }

            // 儲存設定
            const saveAppSettings = () => {
                try {
                    localStorage.setItem(APP_SETTINGS_KEY, JSON.stringify(appSettings));
                    return true;
                } catch (e) {
                    console.error('儲存設定失敗:', e);
                    return false;
                }
            };

            // 套用設定
            const applySettings = () => {
                // 套用主題
                document.body.classList.remove('light-theme', 'dark-theme');
                document.body.classList.add(`${appSettings.theme}-theme`);

                // 套用字體大小
                document.body.classList.remove('font-small', 'font-medium', 'font-large');
                document.body.classList.add(`font-${appSettings.fontSize}`);

                // 套用效能模式
                if (appSettings.performanceMode) {
                    document.body.classList.add('performance-mode');
                } else {
                    document.body.classList.remove('performance-mode');
                }

                // 更新全域變數
                if (window.EXPIRE_SOON_DAYS !== undefined) {
                    window.EXPIRE_SOON_DAYS = appSettings.expireDays;
                }
            };

            // 載入設定到表單
            const loadAppSettings = () => {
                const expireDaysEl = doc('setting-expire-days', true);
                const urgentDaysEl = doc('setting-urgent-days', true);
                const timelineDaysEl = doc('setting-timeline-days', true);
                const themeEl = doc('setting-theme', true);
                const fontSizeEl = doc('setting-font-size', true);
                const autoBackupEl = doc('setting-auto-backup', true);
                const backupFrequencyEl = doc('setting-backup-frequency', true);
                const debugModeEl = doc('setting-debug-mode', true);
                const performanceModeEl = doc('setting-performance-mode', true);

                if (expireDaysEl) expireDaysEl.value = appSettings.expireDays;
                if (urgentDaysEl) urgentDaysEl.value = appSettings.urgentDays;
                if (timelineDaysEl) timelineDaysEl.value = appSettings.timelineDays;
                if (themeEl) themeEl.value = appSettings.theme;
                if (fontSizeEl) fontSizeEl.value = appSettings.fontSize;
                if (autoBackupEl) autoBackupEl.checked = appSettings.autoBackup;
                if (backupFrequencyEl) backupFrequencyEl.value = appSettings.backupFrequency;
                if (debugModeEl) debugModeEl.checked = appSettings.debugMode;
                if (performanceModeEl) performanceModeEl.checked = appSettings.performanceMode;

                // 更新儲存空間資訊
                updateStorageUsage();
            };

            // 更新儲存空間使用情況
            const updateStorageUsage = () => {
                const usageEl = doc('storage-usage-info', true);
                if (!usageEl) return;

                try {
                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            totalSize += localStorage[key].length + key.length;
                        }
                    }
                    
                    const sizeInKB = (totalSize / 1024).toFixed(2);
                    const sizeInMB = (totalSize / 1024 / 1024).toFixed(2);
                    
                    if (totalSize < 1024 * 1024) {
                        usageEl.textContent = `${sizeInKB} KB`;
                    } else {
                        usageEl.textContent = `${sizeInMB} MB`;
                    }
                } catch (e) {
                    usageEl.textContent = '無法計算';
                }
            };

            // 儲存設定按鈕
            doc('settings-save-btn')?.addEventListener('click', () => {
                const expireDaysEl = doc('setting-expire-days', true);
                const urgentDaysEl = doc('setting-urgent-days', true);
                const timelineDaysEl = doc('setting-timeline-days', true);
                const themeEl = doc('setting-theme', true);
                const fontSizeEl = doc('setting-font-size', true);
                const autoBackupEl = doc('setting-auto-backup', true);
                const backupFrequencyEl = doc('setting-backup-frequency', true);
                const debugModeEl = doc('setting-debug-mode', true);
                const performanceModeEl = doc('setting-performance-mode', true);

                // 驗證輸入
                const expireDays = parseInt(expireDaysEl?.value || 30);
                const urgentDays = parseInt(urgentDaysEl?.value || 7);

                if (expireDays < 1 || expireDays > 365) {
                    showToast('即將到期天數必須在 1-365 之間', 'error');
                    return;
                }

                if (urgentDays < 1 || urgentDays > 30) {
                    showToast('緊急提醒天數必須在 1-30 之間', 'error');
                    return;
                }

                if (urgentDays > expireDays) {
                    showToast('緊急提醒天數不能大於即將到期天數', 'error');
                    return;
                }

                // 更新設定
                appSettings.expireDays = expireDays;
                appSettings.urgentDays = urgentDays;
                appSettings.timelineDays = parseInt(timelineDaysEl?.value || 90);
                appSettings.theme = themeEl?.value || 'dark';
                appSettings.fontSize = fontSizeEl?.value || 'medium';
                appSettings.autoBackup = autoBackupEl?.checked || false;
                appSettings.backupFrequency = parseInt(backupFrequencyEl?.value || 7);
                appSettings.debugMode = debugModeEl?.checked || false;
                appSettings.performanceMode = performanceModeEl?.checked || false;

                // 儲存並套用
                if (saveAppSettings()) {
                    applySettings();
                    showToast('設定已儲存', 'success');
                    
                    // 如果在儀表板頁面，重新整理
                    if (uiState.activeTab === 'page-dashboard') {
                        refreshDashboard();
                    }
                } else {
                    showToast('設定儲存失敗', 'error');
                }
            });

            // 重設設定按鈕
            doc('settings-reset-btn')?.addEventListener('click', () => {
                if (confirm('確定要重設所有設定為預設值嗎？')) {
                    appSettings = { ...defaultSettings };
                    saveAppSettings();
                    applySettings();
                    loadAppSettings();
                    showToast('設定已重設為預設值', 'success');
                }
            });

            // 匯出完整備份
            doc('settings-export-all-btn')?.addEventListener('click', () => {
                try {
                    const backup = {
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        customers: customers,
                        vatData: vatData,
                        templates: templateManager.templates,
                        settings: appSettings,
                        collectMethods: collectMethods
                    };
                    
                    const dataStr = JSON.stringify(backup, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `complete_backup_${new Date().getTime()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    showToast('完整備份已匯出', 'success');
                } catch (e) {
                    console.error('匯出失敗:', e);
                    showToast('匯出失敗', 'error');
                }
            });

            // 匯入備份
            doc('settings-import-backup-btn')?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            
                            if (!backup.version || !backup.customers) {
                                showToast('備份檔案格式不正確', 'error');
                                return;
                            }
                            
                            if (confirm('確定要匯入備份嗎？這將覆蓋目前的所有資料。')) {
                                // 還原資料
                                if (backup.customers) {
                                    customers = backup.customers;
                                    saveCustomersToStorage();
                                }
                                if (backup.vatData) {
                                    vatData = backup.vatData;
                                    localStorage.setItem('vat-data/v1', JSON.stringify(vatData));
                                }
                                if (backup.templates) {
                                    templateManager.templates = backup.templates;
                                    templateManager.saveTemplates();
                                }
                                if (backup.settings) {
                                    appSettings = { ...defaultSettings, ...backup.settings };
                                    saveAppSettings();
                                    applySettings();
                                }
                                if (backup.collectMethods) {
                                    collectMethods = backup.collectMethods;
                                    localStorage.setItem('collect-methods/v1', JSON.stringify(collectMethods));
                                }
                                
                                showToast('備份已成功匯入', 'success');
                                
                                // 重新載入頁面
                                setTimeout(() => {
                                    location.reload();
                                }, 1000);
                            }
                        } catch (e) {
                            console.error('匯入失敗:', e);
                            showToast('匯入失敗：檔案格式錯誤', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            });

            // 清除所有資料
            doc('settings-clear-all-btn')?.addEventListener('click', () => {
                if (confirm('⚠️ 警告：這將清除所有資料，包括客戶、營業稅、模板和設定。\n\n建議先匯出備份。\n\n確定要繼續嗎？')) {
                    if (confirm('再次確認：真的要清除所有資料嗎？此操作無法復原！')) {
                        try {
                            localStorage.clear();
                            showToast('所有資料已清除', 'success');
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } catch (e) {
                            console.error('清除失敗:', e);
                            showToast('清除失敗', 'error');
                        }
                    }
                }
            });

            // 初始化時套用設定
            applySettings();

            // 初始化搜尋和匯出功能
            filteredCustomers = [...customers];
            updateExportInfo();

            // ========================================
            // patch: 2025-11-09 Dashboard Home Page Functions
            // ========================================

            // 儀表板資料計算
            const calculateDashboardStats = () => {
                const now = new Date();
                const thirtyDaysLater = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                
                let expired = 0;
                let expiring = 0;
                let active = 0;
                
                customers.forEach(customer => {
                    if (!customer.leaseEndDate) {
                        active++;
                        return;
                    }
                    
                    const endDate = new Date(customer.leaseEndDate);
                    if (endDate < now) {
                        expired++;
                    } else if (endDate <= thirtyDaysLater) {
                        expiring++;
                    } else {
                        active++;
                    }
                });
                
                return {
                    total: customers.length,
                    expired,
                    expiring,
                    active
                };
            };

            // 取得即將到期客戶列表
            const getExpiringCustomers = (days = 30) => {
                const now = new Date();
                const targetDate = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
                
                return customers
                    .filter(c => {
                        if (!c.leaseEndDate) return false;
                        const endDate = new Date(c.leaseEndDate);
                        return endDate >= now && endDate <= targetDate;
                    })
                    .map(c => {
                        const endDate = new Date(c.leaseEndDate);
                        const daysUntilExpiry = Math.ceil((endDate - now) / (24 * 60 * 60 * 1000));
                        return {
                            ...c,
                            daysUntilExpiry,
                            urgency: daysUntilExpiry <= 7 ? 'urgent' : 'warning'
                        };
                    })
                    .sort((a, b) => a.daysUntilExpiry - b.daysUntilExpiry);
            };

            // 取得時間軸事件
            const getTimelineEvents = (days = 90) => {
                const now = new Date();
                const endDate = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
                
                const events = [];
                
                // 租約到期事件
                customers.forEach(customer => {
                    if (!customer.leaseEndDate) return;
                    const leaseEnd = new Date(customer.leaseEndDate);
                    if (leaseEnd >= now && leaseEnd <= endDate) {
                        events.push({
                            date: leaseEnd,
                            type: 'lease',
                            icon: '📋',
                            title: customer.companyName,
                            detail: `租約到期 - ${customer.contactPerson || ''}`,
                            customer: customer
                        });
                    }
                });
                
                // 營業稅事件（簡化版）
                const currentYear = new Date().getFullYear() - 1911;
                const vatPeriods = [
                    { month: 1, day: 15, period: `${currentYear-1}年11-12月` },
                    { month: 3, day: 15, period: `${currentYear}年01-02月` },
                    { month: 5, day: 15, period: `${currentYear}年03-04月` },
                    { month: 7, day: 15, period: `${currentYear}年05-06月` },
                    { month: 9, day: 15, period: `${currentYear}年07-08月` },
                    { month: 11, day: 15, period: `${currentYear}年09-10月` }
                ];
                
                vatPeriods.forEach(vat => {
                    const vatDate = new Date(currentYear + 1911, vat.month - 1, vat.day);
                    if (vatDate >= now && vatDate <= endDate) {
                        events.push({
                            date: vatDate,
                            type: 'vat',
                            icon: '💰',
                            title: '營業稅申報',
                            detail: vat.period,
                            vatPeriod: vat.period
                        });
                    }
                });
                
                // 排序事件
                events.sort((a, b) => a.date - b.date);
                
                return events;
            };

            // 渲染儀表板統計卡片
            const renderDashboardStats = () => {
                const stats = calculateDashboardStats();
                
                const totalEl = doc('dashboard-total-customers');
                const expiredEl = doc('dashboard-expired-count');
                const expiringEl = doc('dashboard-expiring-count');
                const activeEl = doc('dashboard-active-count');
                
                if (totalEl) totalEl.textContent = stats.total;
                if (expiredEl) expiredEl.textContent = stats.expired;
                if (expiringEl) expiringEl.textContent = stats.expiring;
                if (activeEl) activeEl.textContent = stats.active;
            };

            // 渲染即將到期客戶列表
            const renderDashboardExpiringList = () => {
                const listEl = doc('dashboard-expiring-list');
                if (!listEl) return;
                
                const expiringCustomers = getExpiringCustomers(30);
                
                if (expiringCustomers.length === 0) {
                    listEl.innerHTML = `
                        <div class="dashboard-empty">
                            <div class="dashboard-empty-icon">✅</div>
                            <div class="dashboard-empty-text">目前沒有即將到期的客戶</div>
                        </div>
                    `;
                    return;
                }
                
                // 只顯示前 10 筆
                const displayCustomers = expiringCustomers.slice(0, 10);
                
                listEl.innerHTML = displayCustomers.map(customer => `
                    <div class="dashboard-list-item ${customer.urgency}" data-customer-id="${customer.id}">
                        <div class="dashboard-list-item-header">
                            <div class="dashboard-list-item-company">${customer.companyName}</div>
                            <div class="dashboard-list-item-days ${customer.urgency}">
                                ${customer.daysUntilExpiry} 天
                            </div>
                        </div>
                        <div class="dashboard-list-item-info">
                            ${customer.contactPerson ? `👤 ${customer.contactPerson}` : ''}
                            ${customer.phone ? ` | 📞 ${customer.phone}` : ''}
                            <br>
                            📅 到期日: ${toROCDate(customer.leaseEndDate)}
                        </div>
                    </div>
                `).join('');
                
                // 綁定點擊事件
                listEl.querySelectorAll('.dashboard-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const customerId = item.dataset.customerId;
                        showPage('page-list');
                        setTimeout(() => {
                            const row = document.querySelector(`tr[data-customer-id="${customerId}"]`);
                            if (row) {
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                row.style.background = 'rgba(212, 175, 55, 0.2)';
                                setTimeout(() => {
                                    row.style.background = '';
                                }, 2000);
                            }
                        }, 100);
                    });
                });
            };

            // 渲染營業稅提醒
            const renderDashboardVatReminders = () => {
                const vatEl = doc('dashboard-vat-reminders');
                if (!vatEl) return;
                
                const now = new Date();
                const currentYear = new Date().getFullYear() - 1911;
                const currentMonth = now.getMonth() + 1;
                
                // 找出當前或下一個申報期
                const vatPeriods = [
                    { deadline: new Date(currentYear + 1911, 0, 15), period: `${currentYear-1}年11-12月`, months: [11, 12] },
                    { deadline: new Date(currentYear + 1911, 2, 15), period: `${currentYear}年01-02月`, months: [1, 2] },
                    { deadline: new Date(currentYear + 1911, 4, 15), period: `${currentYear}年03-04月`, months: [3, 4] },
                    { deadline: new Date(currentYear + 1911, 6, 15), period: `${currentYear}年05-06月`, months: [5, 6] },
                    { deadline: new Date(currentYear + 1911, 8, 15), period: `${currentYear}年07-08月`, months: [7, 8] },
                    { deadline: new Date(currentYear + 1911, 10, 15), period: `${currentYear}年09-10月`, months: [9, 10] }
                ];
                
                const upcomingPeriods = vatPeriods
                    .filter(p => p.deadline >= now)
                    .slice(0, 2);
                
                if (upcomingPeriods.length === 0) {
                    vatEl.innerHTML = `
                        <div class="dashboard-empty">
                            <div class="dashboard-empty-icon">✅</div>
                            <div class="dashboard-empty-text">目前無待處理事項</div>
                        </div>
                    `;
                    return;
                }
                
                vatEl.innerHTML = upcomingPeriods.map(vat => {
                    const daysUntil = Math.ceil((vat.deadline - now) / (24 * 60 * 60 * 1000));
                    const isUrgent = daysUntil <= 7;
                    
                    return `
                        <div class="dashboard-vat-item ${isUrgent ? 'urgent' : ''}" data-vat-period="${vat.period}">
                            <div class="dashboard-vat-item-header">
                                <div class="dashboard-vat-item-period">${vat.period}</div>
                                <div class="dashboard-vat-item-badge ${isUrgent ? 'urgent' : 'normal'}">
                                    ${daysUntil} 天後截止
                                </div>
                            </div>
                            <div class="dashboard-vat-item-info">
                                📅 截止日期: ${vat.deadline.getFullYear() - 1911}/${String(vat.deadline.getMonth() + 1).padStart(2, '0')}/${String(vat.deadline.getDate()).padStart(2, '0')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // 綁定點擊事件
                vatEl.querySelectorAll('.dashboard-vat-item').forEach(item => {
                    item.addEventListener('click', () => {
                        showPage('page-vat');
                        initVatPage();
                    });
                });
            };

            // 渲染時間軸
            const renderDashboardTimeline = (days = 90) => {
                const timelineEl = doc('dashboard-timeline');
                if (!timelineEl) return;
                
                const events = getTimelineEvents(days);
                
                if (events.length === 0) {
                    timelineEl.innerHTML = `
                        <div class="dashboard-empty">
                            <div class="dashboard-empty-icon">📅</div>
                            <div class="dashboard-empty-text">未來 ${days} 天內沒有預定事件</div>
                        </div>
                    `;
                    return;
                }
                
                // 按月份分組
                const eventsByMonth = {};
                events.forEach(event => {
                    const monthKey = `${event.date.getFullYear()}/${String(event.date.getMonth() + 1).padStart(2, '0')}`;
                    if (!eventsByMonth[monthKey]) {
                        eventsByMonth[monthKey] = [];
                    }
                    eventsByMonth[monthKey].push(event);
                });
                
                // 按日期分組
                const groupEventsByDate = (events) => {
                    const grouped = {};
                    events.forEach(event => {
                        // patch: 2025-11-09 使用本地時間避免時區問題
                        const year = event.date.getFullYear();
                        const month = String(event.date.getMonth() + 1).padStart(2, '0');
                        const day = String(event.date.getDate()).padStart(2, '0');
                        const dateKey = `${year}-${month}-${day}`;
                        if (!grouped[dateKey]) {
                            grouped[dateKey] = [];
                        }
                        grouped[dateKey].push(event);
                    });
                    return grouped;
                };
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                
                timelineEl.innerHTML = Object.entries(eventsByMonth).map(([month, monthEvents]) => {
                    const eventsByDate = groupEventsByDate(monthEvents);
                    
                    return `
                        <div class="timeline-month">
                            <div class="timeline-month-header">${month}</div>
                            ${Object.entries(eventsByDate).map(([date, dayEvents]) => {
                                const eventDate = new Date(date);
                                const rocYear = eventDate.getFullYear() - 1911;
                                const monthDay = `${rocYear}/${String(eventDate.getMonth() + 1).padStart(2, '0')}/${String(eventDate.getDate()).padStart(2, '0')}`;
                                const weekday = weekdays[eventDate.getDay()];
                                
                                return `
                                    <div class="timeline-day">
                                        <div class="timeline-day-header">
                                            <span class="timeline-day-date">${monthDay}</span>
                                            <span class="timeline-day-weekday">週${weekday}</span>
                                            ${dayEvents.length > 1 ? `<span class="timeline-day-count">${dayEvents.length} 個事件</span>` : ''}
                                        </div>
                                        <div class="timeline-events">
                                            ${dayEvents.map(event => `
                                                <div class="timeline-event" data-event-type="${event.type}">
                                                    <div class="timeline-event-icon">${event.icon}</div>
                                                    <div class="timeline-event-content">
                                                        <div class="timeline-event-title">${event.title}</div>
                                                        <div class="timeline-event-detail">${event.detail}</div>
                                                    </div>
                                                    <span class="timeline-event-type ${event.type}">
                                                        ${event.type === 'lease' ? '租約' : event.type === 'vat' ? '稅務' : '提醒'}
                                                    </span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }).join('');
            };

            // 重新整理儀表板
            const refreshDashboard = () => {
                renderDashboardStats();
                renderDashboardExpiringList();
                renderDashboardVatReminders();
                renderDashboardTimeline(90);
            };

            // 儀表板事件監聽
            doc('dashboard-refresh-btn')?.addEventListener('click', () => {
                refreshDashboard();
                showToast('儀表板已更新');
            });

            // 統計卡片點擊事件
            document.querySelectorAll('.stat-card.clickable').forEach(card => {
                card.addEventListener('click', () => {
                    const filter = card.dataset.filter;
                    showPage('page-list');
                    
                    // 根據篩選條件設定
                    if (filter === 'expired' || filter === 'expiring' || filter === 'active') {
                        setTimeout(() => {
                            const filterSelect = doc('expiring-filter-select');
                            if (filterSelect) {
                                filterSelect.value = filter;
                                filterSelect.dispatchEvent(new Event('change'));
                            }
                        }, 100);
                    }
                });
            });

            // 查看全部到期客戶
            doc('view-all-expiring-btn')?.addEventListener('click', () => {
                showPage('page-list');
                setTimeout(() => {
                    const expiringSection = doc('expiring-customers-section');
                    if (expiringSection) {
                        expiringSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }, 100);
            });

            // 時間軸範圍選擇
            doc('timeline-range-select')?.addEventListener('change', (e) => {
                const days = parseInt(e.target.value);
                renderDashboardTimeline(days);
            });

            // 快速操作按鈕
            doc('dashboard-add-customer-btn')?.addEventListener('click', () => {
                showPage('page-list');
                setTimeout(() => {
                    doc('add-customer-btn')?.click();
                }, 100);
            });

            doc('dashboard-export-btn')?.addEventListener('click', () => {
                showPage('page-list');
                setTimeout(() => {
                    doc('export-customers-excel-btn')?.click();
                }, 100);
            });

            doc('dashboard-search-btn')?.addEventListener('click', () => {
                doc('global-search-btn')?.click();
            });

            // 初始化儀表板（預設顯示）
            refreshDashboard();
        });
    </script>
</body>

</html>
