<!doctype html><html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob:; img-src 'self' data:;">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Offline Estimator â€” v2</title>
<style>
:root{--bg:#0b0c10;--panel:#11131a;--card:#161925;--border:#232838;--txt:#e8eaef;--muted:#9aa3b2;--accent:#7be495;--ink:#092312;--ok:#30d158;--bad:#ef5350;--chip:#0f1220;--r:16px}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font:14px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
a{color:inherit}
.container{max-width:1280px;margin:0 auto;padding:18px}
.hidden{display:none}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.hr{height:1px;background:var(--border);margin:12px 0}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px}
h1,h2,h3,h4{margin:0 0 8px}
.small{font-size:12px;color:var(--muted)}
.btn{background:#1b1f2e;border:1px solid var(--border);color:var(--txt);padding:9px 13px;border-radius:12px;cursor:pointer;font-weight:600}
.btn:hover{background:#171b29}
.btn.primary{background:var(--accent);color:var(--ink);border:0}
.btn.ghost{background:transparent;border:1px dashed var(--border)}
.pill{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);color:var(--muted);font-size:12px}
.grid{display:grid;grid-template-columns:140px 1fr;gap:10px 12px;align-items:center}
input,select,textarea{width:100%;background:#0f1220;border:1px solid var(--border);border-radius:12px;padding:9px 11px;color:var(--txt);outline:none}
input[type=number]{text-align:right}
textarea{min-height:96px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px dashed var(--border);padding:6px 8px;vertical-align:middle}
.table th{color:var(--muted);font-weight:600}
.right{text-align:right}
.mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
.bad{color:var(--bad);font-weight:700}
.good{color:var(--ok);font-weight:700}
.soft{opacity:.6}
.tabbar{display:flex;gap:10px;margin-bottom:12px}
.box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
.preview-grid{display:grid;grid-template-columns:1fr;gap:12px}
.preview-table{width:100%;border-collapse:collapse;background:#0e1220}
.preview-table th,.preview-table td{border:1px solid #2a2f43;padding:6px 8px}
.preview-table th{background:#0f1322;color:#b2bbcc}
.k23-red{color:#ef5350;font-weight:800}
.k23-green{color:#30d158;font-weight:800}
.toggle{cursor:pointer;user-select:none}
kbd{background:#0e1220;border:1px solid var(--border);border-radius:6px;padding:2px 6px;font:12px ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <div class="tabbar">
    <button class="btn primary" id="btnTabEdit">ç·¨è¼¯ï¼ˆPage 1ï¼‰</button>
    <button class="btn" id="btnTabPreview">é è¦½ï¼ˆPage 2ï¼‰</button>
    <span class="pill">å®Œå…¨é›¢ç·šï½œConsole 0 issue</span>
  </div>

  <!-- Page 1: ç·¨è¼¯ -->
  <div id="pageEdit" class="panel">
    <h2>è¼¸å…¥é ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰</h2>
    <div class="hr"></div>

    <div class="grid">
      <label>é¡åˆ¥</label>
      <select id="cat"><option value="sole">è¡Œè™Ÿ</option><option value="corp">ä¸€èˆ¬å…¬å¸</option></select>

      <label>A1 å®¢æˆ¶ä»£ç¢¼</label><input id="code" placeholder="#3673">
      <label>A3 å®¢æˆ¶åç¨±</label><input id="name" placeholder="ä¸‰ç¦">
      <label>C19 å¹´åº¦ï¼ˆæ°‘åœ‹ YYYï¼‰</label><input id="year" type="number" step="1" value="114">
      <label>A10 å…¥å¸³æ—¥æœŸ</label><input id="bookDate" placeholder="114/10/16 æˆ– 2025-10-16">
      <label>C34 å‘ŠçŸ¥è¯çµ¡äºº</label><input id="contact">
      <label>H34 å‘ŠçŸ¥æ—¥æœŸ</label><input id="noticeDate" placeholder="114/10/16 æˆ– 2025-10-16">
    </div>

    <div class="hr"></div>
    <div class="box">
      <h3>æ”¶å…¥ï¼ˆI å€ï¼‰</h3>
      <div class="grid">
        <label>I4ï¼ˆ01â€“08ï¼‰</label><input id="i4" type="number" step="1" value="0">
        <label>I5ï¼ˆ09â€“10ï¼‰</label><input id="i5" type="number" step="1" value="0">
        <label>I6ï¼ˆ11â€“12 ä¼°ï¼‰</label><input id="i6" type="number" step="1" value="0">
        <label>M6ï¼ˆæ¥­å¤–æ”¶å…¥åˆè¨ˆï¼‰</label><input id="m6" type="number" step="1" value="0">
      </div>
      <div class="small">I7 = I4 + I5 + I6ï¼ˆæœ¬æœŸèªåˆ—ï¼‰</div>
    </div>

    <div class="box" style="margin-top:12px">
      <h3>æ¯”ç‡ / è¦å‰‡</h3>
      <div class="grid">
        <label>N5ï¼ˆæ›¸å¯© %ï¼‰</label><input id="n5" type="number" step="0.01" value="6">
        <label>N14ï¼ˆæ‰€å¾— %ï¼‰</label><input id="n14" type="number" step="0.01" value="6">
        <label>G9ï¼ˆå»å¹´æˆæœ¬ç‡ %ï¼‰</label><input id="g9" type="number" step="0.01" value="76">
        <label>K9ï¼ˆå»å¹´æ¯›åˆ©ç‡ %ï¼‰</label><input id="k9" type="number" step="0.01" value="24">
        <label>N10ï¼ˆæš«ç¹³ï¼Œåƒ…ä¸€èˆ¬å…¬å¸ï¼‰</label><input id="advTax" type="number" step="1" value="0">
      </div>
      <div class="small">G11 = I7 Ã— G9%ï¼›K11 = I7 Ã— K9%ï¼›M7 = INT((I7 + M6) Ã— N5%)ã€‚</div>
    </div>

    <div class="box" style="margin-top:12px">
      <h3>å¹´åº¦èªªæ˜åˆ—ï¼ˆA/Cï¼Œå¯å‹•æ…‹åŠ åˆ—ï¼›åƒ…é¡¯ç¤ºã€Œèªªæ˜ã€ï¼‰</h3>
      <div class="row">
        <button class="btn" id="btnAddA">ï¼‹ A å€åˆ—</button>
        <button class="btn" id="btnAddC">ï¼‹ C å€åˆ—</button>
        <button class="btn ghost" id="btnClearAC">æ¸…ç©º</button>
      </div>
      <table class="table" id="tblAC"><thead><tr><th style="width:56px">å€</th><th>èªªæ˜æ–‡å­—</th><th style="width:70px"></th></tr></thead><tbody></tbody></table>
      <div class="small">A å€å¾ A20 èµ·ã€C å€å¾ C20 èµ·ï¼ŒåŒ¯å‡ºæ™‚å‘ä¸‹å¯«å…¥ã€‚</div>
    </div>

    <div class="box" style="margin-top:12px">
      <h3>G / K æ˜ç´°ï¼ˆåç›®ï¼‹é‡‘é¡ï¼›å¯å‹•æ…‹åŠ åˆ—ï¼‰</h3>
      <div class="row" style="margin-bottom:6px">
        <select id="preset"><option>è–ªè³‡</option><option>ç§Ÿé‡‘</option><option>åŸ·è¡Œ</option><option>å­˜è²¨èª¿æ•´</option><option>1â€“10 é€²è²¨</option><option>11â€“12 é€²è²¨</option><option>1â€“10 è²»ç”¨</option><option>11â€“12 è²»ç”¨</option><option>ç§Ÿé‡‘(ç™¼ç¥¨)</option></select>
        <button class="btn" id="btnAddG">ï¼‹ G åˆ—</button>
        <button class="btn" id="btnAddK">ï¼‹ K åˆ—</button>
        <button class="btn ghost" id="btnClearGK">æ¸…ç©º G/K</button>
      </div>
      <table class="table" id="tblGK"><thead><tr><th style="width:56px">å€</th><th>åç›®</th><th class="right" style="width:140px">é‡‘é¡</th><th style="width:70px"></th></tr></thead><tbody></tbody></table>
      <div class="small">G èµ·é» F12ï¼ˆåç›®ï¼‰ã€é‡‘é¡å¯« G æ¬„ï¼›K èµ·é» J12ï¼ˆåç›®ï¼‰ã€é‡‘é¡å¯« K æ¬„ã€‚</div>
    </div>

    <div class="hr"></div>
    <div class="row">
      <button class="btn primary" id="btnPreview">é è¦½ï¼ˆåˆ‡æ›è‡³ Page 2ï¼‰</button>
      <button class="btn" id="btnExport">åŒ¯å‡º Excelï¼ˆXLSX UTF-8ï¼‰</button>
      <button class="btn ghost" id="btnExportBackup">åŒ¯å‡º Backupï¼ˆXLSX UTF-8ï¼‰</button>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="btn" id="btnExportCSV">åŒ¯å‡ºç¯„æœ¬ï¼ˆCSVï¼‰</button>
      <label class="btn">åŒ¯å…¥ç¯„æœ¬ï¼ˆCSVï¼‰<input id="inCSV" type="file" accept=".csv" style="display:none"></label>
      <button class="btn" id="btnExportJSON">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
      <label class="btn">åŒ¯å…¥å‚™ä»½ï¼ˆJSONï¼‰<input id="inJSON" type="file" accept=".json" style="display:none"></label>
    </div>
    <div class="hr"></div>
    <div class="row">
      <button class="btn" id="btnSave">å„²å­˜ï¼ˆæœ¬æ©Ÿï¼‰</button>
      <button class="btn ghost" id="btnLoad">è¼‰å…¥ï¼ˆæœ¬æ©Ÿï¼‰</button>
      <span class="pill">é›¢ç·šï½œConsole ä¹¾æ·¨</span>
    </div>
  </div>

  <!-- Page 2: é è¦½ -->
  <div id="pagePreview" class="panel hidden">
    <div class="row">
      <h2>é è¦½é ï¼ˆExcel è¦–è¦ºï¼‰</h2>
      <button class="btn" id="btnBack">è¿”å›ç·¨è¼¯</button>
      <button class="btn" id="btnExport2">åŒ¯å‡º Excel</button>
      <button class="btn ghost" id="btnGuide">ğŸ“˜ å„€è¡¨æ¿</button>
    </div>
    <div id="guide" class="hidden" style="margin:10px 0">
      <div class="card"><h4>æ­¥é©Ÿ 1ï½œè¼¸å…¥è³‡æ–™</h4><div class="small">æ”¶å…¥ I4/I5/I6ï¼Œæ¥­å¤– M6ï¼›I7=I4+I5+I6ã€‚</div></div>
      <div class="card"><h4>æ­¥é©Ÿ 2ï½œè¨­å®šæ¯”ç‡</h4><div class="small">æ›¸å¯© N5%ã€æ‰€å¾— N14%ï¼›å»å¹´æ¯”ç‡ G9/K9ï¼›æœ¬å¹´é‡‘é¡ G11/K11=I7Ã—G9/K9ã€‚</div></div>
      <div class="card"><h4>æ­¥é©Ÿ 3ï½œè·¯å¾‘æ¯”è¼ƒ</h4><div class="small">M7=INT((I7+M6)Ã—N5%)ï¼›M15=INT((I7+M6)Ã—N14%)ï¼›K22 å–é«˜è€…ï¼Œæ–¼ M22 é¡¯ç¤ºã€Œæ›¸å¯©/æ‰€å¾—ã€ã€‚</div></div>
      <div class="card"><h4>æ­¥é©Ÿ 4ï½œç¨…é¡è©¦ç®—</h4><div class="small">A å¼ï¼šâ‰¤120,000=0ï¼›120,001~200,000=INT((TIâˆ’120000)/2)ï¼›â‰¥200,001=INT(TIÃ—20%)ã€‚ä¸€èˆ¬å…¬å¸ N11=N9âˆ’N10ï¼›è¡Œè™Ÿ N11=N9ã€‚</div></div>
      <div class="card"><h4>æ­¥é©Ÿ 5ï½œç¼ºå£</h4><div class="small">K23=K21âˆ’K22ï¼›>0ã€Œç›ˆé¤˜ã€ç´…è‰²ï¼›<0ã€Œç¼ºå£ã€ç¶ è‰²ã€‚D22 èµ·è¼¸å‡ºç¼ºå£æ‘˜è¦ï¼ˆæ­£æ•¸è€…é¡¯ç¤ºï¼‰ã€‚</div></div>
    </div>
    <div class="hr"></div>
    <div id="previewArea" class="preview-grid">
      <div id="previewTable" class="box small">å°šæœªç”¢ç”Ÿé è¦½</div>
      <div id="warnings" class="small"></div>
    </div>
  </div>
</div>

<script>
"use strict";
document.addEventListener('DOMContentLoaded',function(){
  const $=s=>document.querySelector(s);
  const fmtInt=n=>new Intl.NumberFormat('zh-Hant-TW',{maximumFractionDigits:0,useGrouping:true}).format(Math.trunc(Number(n)||0));
  const fmtAcct=n=>{const v=Math.trunc(Number(n)||0);const s=fmtInt(Math.abs(v));return v<0?`(${s})`:s;};
  const toROC=d=>{ if(!d) return ''; if(/^\\d{3}\\/\\d{1,2}\\/\\d{1,2}$/.test(d)) return d;
    const m=String(d).match(/^(\\d{4})[-\\/](\\d{1,2})[-\\/](\\d{1,2})$/); if(!m) return d;
    return `${(parseInt(m[1],10)-1911)}/${String(m[2]).padStart(2,'0')}/${String(m[3]).padStart(2,'0')}`; };

  const S={cat:'sole',code:'',name:'',year:114,bookDate:'',contact:'',noticeDate:'',
    i4:0,i5:0,i6:0,m6:0,n5:6,n14:6,g9:76,k9:24,advTax:0,A:[],C:[],GK:[],legacyL6:0};
  ['è–ªè³‡','ç§Ÿé‡‘','åŸ·è¡Œ'].forEach(n=>S.GK.push({zone:'K',name:n,amt:0}));

  function bind(id,key,num=false){const el=$(id); if(!el) return;
    const up=()=>{S[key]=num?Number(el.value||0):el.value;};
    el.addEventListener('input',up); up();}
  bind('#cat','cat'); bind('#code','code'); bind('#name','name'); bind('#year','year',true);
  bind('#bookDate','bookDate'); bind('#contact','contact'); bind('#noticeDate','noticeDate');
  bind('#i4','i4',true); bind('#i5','i5',true); bind('#i6','i6',true); bind('#m6','m6',true);
  bind('#n5','n5',true); bind('#n14','n14',true); bind('#g9','g9',true); bind('#k9','k9',true); bind('#advTax','advTax',true);

  const tblAC=$('#tblAC tbody');
  function renderAC(){
    if(!tblAC) return;
    tblAC.innerHTML='';
    function add(sec){
      S[sec].forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="mono">${sec}</td>
        <td><input value="${r.text}" data-sec="${sec}" data-idx="${i}"></td>
        <td><button class="btn" data-del="${sec}:${i}">åˆª</button></td>`;
        tblAC.appendChild(tr);
      });
    }
    add('A'); add('C');
  }
  function addAC(sec){S[sec].push({text:`${sec} å€èªªæ˜`}); renderAC();}
  function clearAC(){S.A=[];S.C=[]; renderAC();}
  renderAC();

  tblAC?.addEventListener('input', (e)=>{
    const t=e.target;
    if(t && t.dataset && t.dataset.sec){
      const sec=t.dataset.sec, i=Number(t.dataset.idx||0);
      if(S[sec] && S[sec][i]) S[sec][i].text=t.value;
    }
  });
  tblAC?.addEventListener('click',(e)=>{
    const b=e.target.closest('button[data-del]'); if(!b) return;
    const [sec,i]=b.dataset.del.split(':');
    S[sec].splice(Number(i),1); renderAC();
  });

  const tblGK=$('#tblGK tbody');
  function renderGK(){
    if(!tblGK) return;
    tblGK.innerHTML='';
    S.GK.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="mono">${r.zone}</td>
        <td><input value="${r.name}" data-idx="${i}" data-field="name"></td>
        <td class="right"><input type="number" step="1" value="${r.amt}" data-idx="${i}" data-field="amt"></td>
        <td><button class="btn" data-del="${i}">åˆª</button></td>`;
      tblGK.appendChild(tr);
    });
  }
  function addGK(zone){S.GK.push({zone,name:$('#preset').value,amt:0}); renderGK();}
  function clearGK(){S.GK=[]; renderGK();}
  renderGK();

  tblGK?.addEventListener('input',(e)=>{
    const t=e.target; if(!t || t.dataset.idx===undefined) return;
    const i=Number(t.dataset.idx); const f=t.dataset.field;
    if(f==='name') S.GK[i].name=t.value;
    if(f==='amt') S.GK[i].amt=Number(t.value||0);
  });
  tblGK?.addEventListener('click',(e)=>{
    const b=e.target.closest('button[data-del]'); if(!b) return;
    const i=Number(b.dataset.del); S.GK.splice(i,1); renderGK();
  });

  function taxA(TI){
    TI=Math.trunc(Number(TI)||0);
    if(TI<=120000) return 0;
    if(TI<=200000) return Math.trunc((TI-120000)/2);
    return Math.trunc(TI*0.2);
  }

  function renderPreview(){
    const y=Number(S.year||0);
    const I7=Math.trunc((S.i4||0)+(S.i5||0)+(S.i6||0));
    const extra=Math.trunc((S.m6||0) || (S.legacyL6||0));
    const base=Math.trunc(I7+extra);

    const TI_book=Math.trunc(base*((S.n5||0)/100));
    const TI_income=Math.trunc(base*((S.n14||0)/100));
    const route=(TI_book>=TI_income)?'æ›¸å¯©':'æ‰€å¾—';
    const K22=Math.max(TI_book,TI_income);

    const G11_amt=Math.trunc(I7*((S.g9||0)/100));
    const K11_amt=Math.trunc(I7*((S.k9||0)/100));

    const sumG=S.GK.filter(x=>x.zone==='G').reduce((a,b)=>a+Math.trunc(b.amt||0),0);
    const sumK=S.GK.filter(x=>x.zone==='K').reduce((a,b)=>a+Math.trunc(b.amt||0),0);
    const K21=sumK;
    const K23=Math.trunc(K21-K22);

    const tax=taxA(K22);
    const due=(S.cat==='corp')?Math.trunc(tax-(S.advTax||0)):tax;

    const m7Class=(route==='æ›¸å¯©')?'':'soft';
    const m15Class=(route==='æ‰€å¾—')?'':'soft';
    const k23Class=(K23>0)?'k23-red':(K23<0?'k23-green':'');

    const lines=[];
    if(sumG>0) lines.push(`æˆæœ¬ç¼ºå£ï¼š${fmtAcct(sumG)}`);
    if(sumK>0) lines.push(`è²»ç”¨ç¼ºå£ï¼š${fmtAcct(sumK)}`);

    const html=`
      <div class="row">
        <span class="pill">é¡åˆ¥ï¼š${S.cat==='corp'?'ä¸€èˆ¬å…¬å¸':'è¡Œè™Ÿ'}</span>
        <span class="pill">å¹´åº¦ï¼š${y}ï¼ˆA19 é¡¯ç¤º ${y-1}ï½œC19 é¡¯ç¤º ${y}ï¼‰</span>
        <span class="pill">I7 åˆè¨ˆï¼š<span class="mono">${fmtAcct(I7)}</span></span>
        <span class="pill">M6 æ¥­å¤–ï¼š<span class="mono">${fmtAcct(extra)}</span></span>
      </div>
      <div class="hr"></div>
      <table class="preview-table small">
        <tr><th>F1 æ¨™é¡Œ</th><td>${y}å¹´é ä¼°è²»ç”¨</td></tr>
        <tr><th>A19 / C19</th><td>${y-1} ï¼ ${y}</td></tr>
        <tr><th>I4 / I5 / I6 / I7</th><td>${fmtAcct(S.i4)} / ${fmtAcct(S.i5)} / ${fmtAcct(S.i6)} / <b>${fmtAcct(I7)}</b></td></tr>
        <tr><th>M6</th><td>${fmtAcct(extra)}</td></tr>
        <tr><th class="${m7Class}">æ›¸å¯© M7</th><td class="${m7Class}">${fmtAcct(TI_book)}</td></tr>
        <tr><th class="${m15Class}">æ‰€å¾— M15</th><td class="${m15Class}">${fmtAcct(TI_income)}</td></tr>
        <tr><th>è·¯å¾‘ï¼ˆM22ï¼‰</th><td><b>${route}</b></td></tr>
        <tr><th>K22ï¼ˆå–é«˜ï¼‰</th><td><b>${fmtAcct(K22)}</b></td></tr>
        <tr><th>G11 / K11</th><td>${fmtAcct(G11_amt)} ï¼ ${fmtAcct(K11_amt)}</td></tr>
        <tr><th>K21ï¼ˆè²»ç”¨åˆè¨ˆï¼‰</th><td>${fmtAcct(K21)}</td></tr>
        <tr><th>K23ï¼ˆK21âˆ’K22ï¼‰</th><td class="${k23Class} mono">${fmtAcct(K23)}</td></tr>
        <tr><th>N9 ç¨…é¡</th><td>${fmtAcct(tax)}</td></tr>
        ${S.cat==='corp'?`<tr><th>N10 æš«ç¹³</th><td>${fmtAcct(S.advTax||0)}</td></tr><tr><th>N11 æ‡‰ç¹³</th><td>${fmtAcct(due)}</td></tr>`:`<tr><th>N11 ç¨…é¡</th><td>${fmtAcct(due)}</td></tr>`}
        <tr><th>ç¼ºå£æ‘˜è¦ï¼ˆD22 èµ·ï¼‰</th><td>${lines.length?lines.map(x=>`<div>${x}</div>`).join(''):'ï¼ˆç„¡æ­£æ•¸ç¼ºå£ï¼‰'}</td></tr>
      </table>`;

    const previewTable=$('#previewTable');
    if(previewTable) previewTable.innerHTML=html;
    const warnings=$('#warnings'); if(warnings) warnings.textContent='';
  }

  // tab handlers
  $('#btnTabEdit')?.addEventListener('click',()=>{
    $('#pageEdit')?.classList.remove('hidden'); $('#pagePreview')?.classList.add('hidden');
    $('#btnTabEdit')?.classList.add('primary'); $('#btnTabPreview')?.classList.remove('primary');
  });
  $('#btnTabPreview')?.addEventListener('click',()=>{
    renderPreview();
    $('#pageEdit')?.classList.add('hidden'); $('#pagePreview')?.classList.remove('hidden');
    $('#btnTabPreview')?.classList.add('primary'); $('#btnTabEdit')?.classList.remove('primary');
  });
  $('#btnPreview')?.addEventListener('click',()=>$('#btnTabPreview')?.click());
  $('#btnBack')?.addEventListener('click',()=>$('#btnTabEdit')?.click());
  $('#btnGuide')?.addEventListener('click',()=>$('#guide')?.classList.toggle('hidden'));

  // AC / GK buttons
  $('#btnAddA')?.addEventListener('click',()=>addAC('A'));
  $('#btnAddC')?.addEventListener('click',()=>addAC('C'));
  $('#btnClearAC')?.addEventListener('click',()=>clearAC());
  $('#btnAddG')?.addEventListener('click',()=>addGK('G'));
  $('#btnAddK')?.addEventListener('click',()=>addGK('K'));
  $('#btnClearGK')?.addEventListener('click',()=>clearGK());

  // Export / Import
  function u16(n){return new Uint8Array([n&255,(n>>8)&255]);}
  function u32(n){return new Uint8Array([n&255,(n>>8)&255,(n>>16)&255,(n>>24)&255]);}
  function s2b(s){return new TextEncoder().encode(s);}
  function concat(arrs){let len=0;arrs.forEach(a=>len+=a.length);const out=new Uint8Array(len);let o=0;arrs.forEach(a=>{out.set(a,o);o+=a.length});return out;}
  const CRC_TABLE=(()=>{let c,t=new Uint32Array(256);for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++)c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);t[n]=c>>>0;}return t;})();
  function crc32(data){let c=~0;for(let i=0;i<data.length;i++)c=CRC_TABLE[(c^data[i])&255]^(c>>>8);return ~c;}
  function dosTime(d=new Date()){const y=d.getFullYear()<1980?0:d.getFullYear()-1980;return{date:(y<<9)|((d.getMonth()+1)<<5)|d.getDate(),time:(d.getHours()<<11)|(d.getMinutes()<<5)|Math.floor(d.getSeconds()/2)};}
  function zipStore(files){const parts=[],central=[];let off=0;const now=dosTime();files.forEach(f=>{const n=s2b(f.name),data=f.data,crc=crc32(data);
    parts.push(s2b('PK\x03\x04'),u16(20),u16(0),u16(0),u16(now.time),u16(now.date),u32(crc>>>0),u32(data.length),u32(data.length),u16(n.length),u16(0),n,data);
    const localLen=30+n.length+data.length;
    central.push(s2b('PK\x01\x02'),u16(20),u16(20),u16(0),u16(0),u16(now.time),u16(now.date),u32(crc>>>0),u32(data.length),u32(data.length),u16(n.length),u16(0),u16(0),u16(0),u16(0),u32(0),u32(off),n);
    off+=localLen;});
  const cen=concat(central),end=concat([s2b('PK\x05\x06'),u16(0),u16(0),u16(files.length),u16(files.length),u32(cen.length),u32(off),u16(0)]);
  return new Blob([concat(parts),cen,end],{type:'application/zip'});}

  const xmlEsc=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const cStr=(ref,txt)=>`<c r="${ref}" t="inlineStr"><is><t>${xmlEsc(txt)}</t></is></c>`;
  const cNum=(ref,val)=>`<c r="${ref}" t="n"><v>${Math.trunc(Number(val)||0)}</v></c>`;

  function genWB(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
    <sheets><sheet name="Estimate" sheetId="1" r:id="rId1"/></sheets>
  </workbook>`;}
  function genWBRels(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <Relationships xmlns="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
  </Relationships>`;}
  function genCT(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
    <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
    <Default Extension="xml" ContentType="application/xml"/>
    <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
    <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
    <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
    <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
  </Types>`;}
  function genApp(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <Properties xmlns="http://schemas.openxmlformats.org/officeDocument/extended-properties">
    <Application>Offline Estimator</Application>
  </Properties>`;}
  function genCore(){const now=new Date().toISOString();return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <dc:title>Estimate</dc:title><dc:creator>Offline Estimator</dc:creator><cp:lastModifiedBy>Offline Estimator</cp:lastModifiedBy>
    <dcterms:created xsi:type="dcterms:W3CDTF">${now}</dcterms:created><dcterms:modified xsi:type="dcterms:W3CDTF">${now}</dcterms:modified>
  </cp:coreProperties>`;}

  function estimateColWidths(cells){
    const widths={};
    for(const [ref, val] of Object.entries(cells)){
      const col=ref.match(/^([A-Z]+)/)[1];
      const text=String(val);
      const w=Math.min(50, Math.max(8, Math.ceil(text.length*0.9)+2));
      widths[col]=Math.max(widths[col]||8, w);
    }
    return widths;
  }

  function genSheetXML(){
    const y=Number(S.year||0);
    const I7=Math.trunc((S.i4||0)+(S.i5||0)+(S.i6||0));
    const extra=Math.trunc((S.m6||0) || (S.legacyL6||0));
    const base=Math.trunc(I7+extra);
    const TI_book=Math.trunc(base*((S.n5||0)/100));
    const TI_income=Math.trunc(base*((S.n14||0)/100));
    const route=(TI_book>=TI_income)?'æ›¸å¯©':'æ‰€å¾—';
    const K22=Math.max(TI_book,TI_income);
    const G11_amt=Math.trunc(I7*((S.g9||0)/100));
    const K11_amt=Math.trunc(I7*((S.k9||0)/100));
    const sumG=S.GK.filter(x=>x.zone==='G').reduce((a,b)=>a+Math.trunc(b.amt||0),0);
    const sumK=S.GK.filter(x=>x.zone==='K').reduce((a,b)=>a+Math.trunc(b.amt||0),0);
    const K21=sumK, K23=Math.trunc(K21-K22);
    const tax=(K22<=120000)?0:(K22<=200000?Math.trunc((K22-120000)/2):Math.trunc(K22*0.2));
    const due=(S.cat==='corp')?Math.trunc(tax-(S.advTax||0)):tax;

    const textCells={F1:`${y}å¹´é ä¼°è²»ç”¨`,A19:`${y-1}`,C19:`${y}`,A1:S.code||'',A3:S.name||'',
      A10:toROC(S.bookDate)||'',C34:S.contact||'',H34:toROC(S.noticeDate)||'',N5:`${(S.n5||0).toFixed(2)}%`,
      N14:`${(S.n14||0).toFixed(2)}%`,G9:`${(S.g9||0).toFixed(2)}%`,K9:`${(S.k9||0).toFixed(2)}%`,M22:route,
      D22:(sumG>0?`æˆæœ¬ç¼ºå£ï¼š${fmtAcct(sumG)}`:''),D23:(sumK>0?`è²»ç”¨ç¼ºå£ï¼š${fmtAcct(sumK)}`:''),D24:''};
    const numCells={I4:S.i4||0,I5:S.i5||0,I6:S.i6||0,I7:I7,M6:extra,M7:TI_book,M15:TI_income,
      G11:G11_amt,K11:K11_amt,N9:tax,N11:due,K22:K22,G19:sumG,K21:sumK,K23:K23};
    if(S.cat==='corp') numCells['N10']=S.advTax||0;

    const widths=estimateColWidths({...textCells, ...Object.fromEntries(Object.keys(numCells).map(k=>[k,String(numCells[k])]))});

    const rows=new Map();
    const push=(a1,xml)=>{if(!a1)return;const m=a1.match(/^[A-Z]+(\\d+)$/i);if(!m)return;const r=parseInt(m[1],10);if(!rows.has(r))rows.set(r,[]);rows.get(r).push(xml);};
    Object.entries(textCells).forEach(([ref, val])=>{ if(val!==undefined) push(ref, cStr(ref, val)); });
    Object.entries(numCells).forEach(([ref, val])=>{ push(ref, cNum(ref, val)); });

    let rA=20; S.A.forEach(x=>push(`A${rA++}`, cStr(`A${rA-1}`, x.text||'')));
    let rC=20; S.C.forEach(x=>push(`C${rC++}`, cStr(`C${rC-1}`, x.text||'')));
    let rg=12; S.GK.filter(x=>x.zone==='G').forEach(x=>{push(`F${rg}`, cStr(`F${rg}`, x.name||'')); push(`G${rg}`, cNum(`G${rg}`, x.amt||0)); rg++;});
    let rk=12; S.GK.filter(x=>x.zone==='K').forEach(x=>{push(`J${rk}`, cStr(`J${rk}`, x.name||'')); push(`K${rk}`, cNum(`K${rk}`, x.amt||0)); rk++;});

    const colTags=Object.keys(widths).sort().map(col=>{let idx=0; for(let i=0;i<col.length;i++){ idx=idx*26 + (col.charCodeAt(i)-64); }
      return `<col min="${idx}" max="${idx}" width="${widths[col]}" bestFit="1" customWidth="1"/>`; }).join('');

    const lines=[...rows.keys()].sort((a,b)=>a-b).map(r=>`<row r="${r}">${rows.get(r).join('')}</row>`).join('');
    return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
    <worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
      <cols>${colTags}</cols>
      <sheetData>${lines}</sheetData>
    </worksheet>`;
  }

  function downloadBlob(b,name){const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1500);}

  function exportXLSX(backup=false){
    const files=[
      {name:'[Content_Types].xml',data:s2b(genCT())},
      {name:'_rels/.rels',data:s2b(`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
          <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
          <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
          <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
        </Relationships>`)},
      {name:'xl/workbook.xml',data:s2b(genWB())},
      {name:'xl/_rels/workbook.xml.rels',data:s2b(genWBRels())},
      {name:'xl/worksheets/sheet1.xml',data:s2b(genSheetXML())},
      {name:'docProps/app.xml',data:s2b(genApp())},
      {name:'docProps/core.xml',data:s2b(genCore())}
    ];
    const blob=zipStore(files);
    const y=String(S.year||'YYY');
    const today=toROC(new Date().toISOString().slice(0,10)).replace(/\//g,'-');
    const base=`${(S.name||'Unnamed')}_${y}é ä¼°è²»ç”¨_${today}`;
    const fname=backup?`${base}_backup.xlsx`:`${base}.xlsx`;
    downloadBlob(blob,fname);
  }

  // wire buttons
  $('#btnExport')?.addEventListener('click',()=>exportXLSX(false));
  $('#btnExportBackup')?.addEventListener('click',()=>exportXLSX(true));
  $('#btnExport2')?.addEventListener('click',()=>exportXLSX(false));

  $('#btnExportCSV')?.addEventListener('click',exportCSV);
  $('#inCSV')?.addEventListener('change',importCSV);
  $('#btnExportJSON')?.addEventListener('click',exportJSON);
  $('#inJSON')?.addEventListener('change',importJSON);

  $('#btnSave')?.addEventListener('click',()=>{ localStorage.setItem('offline-estimator', JSON.stringify(S)); alert('å·²å„²å­˜æœ¬æ©Ÿ'); });
  $('#btnLoad')?.addEventListener('click',()=>{ try{ const s=localStorage.getItem('offline-estimator'); if(s){ Object.assign(S, JSON.parse(s)); renderAC(); renderGK(); alert('å·²è¼‰å…¥ï¼ˆè‡³é è¦½æŸ¥çœ‹ï¼‰'); } }catch(e){ alert('è¼‰å…¥å¤±æ•—ï¼š'+e.message); }});

  // helpers used above
  function genWB(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
    <sheets><sheet name="Estimate" sheetId="1" r:id="rId1"/></sheets>
  </workbook>`;}
  function genWBRels(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <Relationships xmlns="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
  </Relationships>`;}
  function genCT(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
    <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
    <Default Extension="xml" ContentType="application/xml"/>
    <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
    <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
    <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
    <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
  </Types>`;}
  function genApp(){return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <Properties xmlns="http://schemas.openxmlformats.org/officeDocument/extended-properties">
    <Application>Offline Estimator</Application>
  </Properties>`;}
  function genCore(){const now=new Date().toISOString();return`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <dc:title>Estimate</dc:title><dc:creator>Offline Estimator</dc:creator><cp:lastModifiedBy>Offline Estimator</cp:lastModifiedBy>
    <dcterms:created xsi:type="dcterms:W3CDTF">${now}</dcterms:created><dcterms:modified xsi:type="dcterms:W3CDTF">${now}</dcterms:modified>
  </cp:coreProperties>`;}
});
</script>
</body>
</html>
