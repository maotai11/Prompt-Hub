<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>離線客戶資料庫＆營業稅｜分頁＋列印＋IndexedDB（含備註編輯/單客/全客匯出Excel）</title>
<style>
  :root{
    --bg:#0f1216; --card:#141820; --muted:#8aa0b2; --text:#e8eef4; --acc:#3aa0ff; --warn:#ffb020; --danger:#ff5a6a;
    --ok:#31c48d; --border:#1f2630; --chip:#0d1015;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  h1,h2,h3{margin:0 0 .5rem}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  label{font-size:.9rem;color:var(--muted)}
  input,select,textarea{
    background:#0b0e14;border:1px solid var(--border);color:var(--text);
    padding:8px 10px;border-radius:8px;outline:none;min-height:38px;
  }
  input:focus,select:focus,textarea:focus{border-color:var(--acc)}
  textarea{width:100%;min-height:80px;resize:vertical}
  .btn{border:1px solid var(--border);background:#0d1015;color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn:hover{border-color:var(--acc)}
  .btn-acc{background:var(--acc);color:#001b33;border:none}
  .btn-ok{background:var(--ok);color:#01261c;border:none}
  .btn-warn{background:var(--warn);color:#261a00;border:none}
  .btn-danger{background:var(--danger);color:#2a0004;border:none}
  .muted{color:var(--muted)} .small{font-size:.87rem}
  .pill{display:inline-block;padding:2px 8px;border-radius:99px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-size:.8rem}
  .kbd{font-family:ui-monospace,Menlo,monospace;background:#0b0e12;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  .hr{height:1px;background:var(--border);margin:12px 0}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
  details{border:1px solid var(--border);border-radius:10px;padding:8px;background:#10151c}
  details+details{margin-top:8px}
  summary{cursor:pointer;color:var(--acc)}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){.two-col{grid-template-columns:1fr}}

  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .tab{border:1px solid var(--border);background:#0d1015;color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer}
  .tab.active{background:var(--acc);color:#001b33;border-color:transparent}
  .tab-panels > section{display:none}
  .tab-panels > section.active{display:block}

  .notice{border:1px dashed var(--warn);background:#2a210a;color:#ffd27a;padding:10px;border-radius:10px}

  @media print{
    :root{color-scheme:light}
    body{background:#fff;color:#000}
    .card, .wrap{background:#fff;border:none}
    .tabs, .no-print{display:none !important}
    input,select,textarea,.btn{display:none !important}
    .pill,.kbd,.hint,.muted{color:#000 !important;border:none;background:transparent}
    .table th,.table td{border:1px solid #000 !important}
    details{border:none;background:transparent}
    summary{display:none}
    .small{font-size:0.95rem}
    .print-break{page-break-inside:avoid;page-break-after:auto}
  }

  /* ===== 2025 Neo-Glass Minimal Theme (UI-only override) ===== */
  :root{
    --bg:#0a0e14; --card:#0f141cE6; --border:#1c2735; --text:#eaf2fb; --muted:#90a4b8; --acc:#6fc3ff; --ok:#36d39a; --warn:#ffc561; --danger:#ff6e7b; --chip:#0c1118;
    --ring: 0 0 0 3px rgba(111,195,255,.20); --shadow-sm:0 1px 2px rgba(0,0,0,.3); --shadow-md:0 8px 24px rgba(0,0,0,.35); --shadow-lg:0 18px 40px rgba(0,0,0,.45); --blur:10px; --radius:14px;
  }
  body{
    background:
      radial-gradient(1200px 800px at 20% -10%, rgba(95,169,255,.10), transparent 60%),
      radial-gradient(1000px 700px at 100% 20%, rgba(54,211,154,.10), transparent 60%),
      linear-gradient(180deg, #0a0e14 0%, #0b1118 60%, #0a0e14 100%);
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-1;
    background-image:
      linear-gradient(rgba(255,255,255,.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,.04) 1px, transparent 1px);
    background-size:28px 28px;
    mask-image: radial-gradient(70% 70% at 50% 20%, rgba(0,0,0,.7), transparent 90%);
    pointer-events:none;
  }
  .wrap{ max-width:1280px; padding:20px; }
  .grid{ gap:18px; }
  .card{
    background: linear-gradient(180deg, rgba(20,26,36,.85), rgba(12,18,26,.75));
    border: 1px solid rgba(152,193,255,.12);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    backdrop-filter: blur(var(--blur));
    transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
  }
  .card:hover{ transform: translateY(-1px); box-shadow: var(--shadow-md); border-color: rgba(152,193,255,.22); }
  h1{ letter-spacing:.4px; font-weight:700; font-size:1.6rem; }
  h2{ letter-spacing:.3px; font-weight:650; }
  h3{ letter-spacing:.2px; font-weight:600; }
  .btn{
    border:1px solid rgba(152,193,255,.18);
    background: linear-gradient(180deg, #0f141b, #0c1218);
    color:var(--text);
    padding:10px 14px;
    border-radius:10px;
    backdrop-filter: blur(6px);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    transition: transform .12s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); border-color: rgba(152,193,255,.35); box-shadow: var(--shadow-sm); }
  .btn:active{ transform: translateY(0); }
  .btn-acc{ background: linear-gradient(180deg, #6fc3ff, #51b5ff); color:#062033; border:none; box-shadow: 0 8px 22px rgba(111,195,255,.25); }
  .btn-ok{  background: linear-gradient(180deg, #36d39a, #25c08c); color:#031e16; border:none; box-shadow: 0 8px 22px rgba(54,211,154,.22); }
  .btn-warn{background: linear-gradient(180deg, #ffc561, #ffb83a); color:#2b1b00; border:none; box-shadow: 0 8px 22px rgba(255,197,97,.22); }
  .btn-danger{background: linear-gradient(180deg, #ff7e8a, #ff5564); color:#2a0004; border:none; box-shadow: 0 8px 22px rgba(255,110,123,.25); }
  input,select,textarea{
    background: linear-gradient(180deg, #0b1118, #0a0f15);
    border:1px solid rgba(152,193,255,.18);
    border-radius:10px; min-height:40px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.03), inset 0 -1px 0 rgba(0,0,0,.2);
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  input:focus,select:focus,textarea:focus{ border-color: rgba(111,195,255,.65); box-shadow: var(--ring), inset 0 0 0 1px rgba(255,255,255,.04); }
  label{ font-size:.85rem; color:var(--muted); letter-spacing:.2px; }
  .pill{
    background: linear-gradient(180deg, rgba(15,20,28,.9), rgba(10,15,21,.8));
    border:1px solid rgba(152,193,255,.18); color:#b7c8da; padding:4px 10px;
  }
  .tabs{ gap:10px; }
  .tab{
    background: linear-gradient(180deg, #0f141b, #0c1218);
    border:1px solid rgba(152,193,255,.18);
    border-radius:999px; padding:10px 16px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
  }
  .tab.active{
    background: linear-gradient(180deg, #69bfff, #48b0ff);
    color:#04223a; border-color: transparent;
    box-shadow: 0 6px 16px rgba(111,195,255,.25);
  }
  .notice{ border:1px dashed rgba(255,197,97,.55); background: linear-gradient(180deg, #2b220b, #231c09); color:#ffdca0; }
  .hr{ background: linear-gradient(90deg, rgba(152,193,255,.15), rgba(152,193,255,.04), rgba(152,193,255,.15)); height:1px; }
  .table{ border-collapse: separate; border-spacing:0; overflow:hidden; border-radius:12px; }
  .table thead th{
    position: sticky; top:0; z-index:1; background: linear-gradient(180deg, #101723, #0d141e);
    color:#cfe2f5; border-bottom:1px solid rgba(152,193,255,.20); backdrop-filter: blur(8px);
  }
  .table th, .table td{ border-bottom:1px solid rgba(152,193,255,.10); }
  .table tbody tr:nth-child(even){ background: rgba(255,255,255,.02); }
  .table tbody tr:hover{ background: rgba(111,195,255,.06); }
  details{
    background: linear-gradient(180deg, #0e151f, #0b121a);
    border:1px solid rgba(152,193,255,.16); border-radius:12px;
  }
  summary{ color:#8fd0ff; }
  .kbd{ background: linear-gradient(180deg, #0b1118, #0a0f15); border:1px solid rgba(152,193,255,.18); color:#bcd0e4; }
  @media (prefers-reduced-motion: reduce){ .card, .btn, input, select, textarea { transition: none !important; } }
  @media print{ .table thead th{ background:#fff !important; color:#000 !important; } }

  /* 分頁器 */
  .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pager .btn{padding:6px 10px}
  .pager .num{min-width:28px;text-align:center;border:1px solid var(--border);background:#0d1015;border-radius:8px;padding:6px 8px}
</style>

<!-- 內嵌 seed（初次/無資料時導入） -->
<script type="application/json" id="seed-customers">
{"customers":[{"id":"C0001","companyName":"範例股份有限公司","regAddr":"台北市信義區示例路 100 號","contactAddr":"台北市信義區示例路 200 還","taxId":"12345678","bizRegNo":"A123456789","principal":"王小明","contact":"林小姐","phone":"02-1234-5678","suspendFrom":"","suspendTo":"","notesHistory":[{"id":"Nseeddemo","ts":"2025-09-01T10:00:00","voucherType":"進項","text":"首度建檔，確認統編與收發方式"}]}]}
</script>
</head>
<body>
<div class="wrap grid">

  <header class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <h1>離線客戶資料庫 ＆ 營業稅模組</h1>
        <div class="small muted">單檔・分頁式 UI・友善列印・IndexedDB 優先持久化・JSON/CSV 匯入匯出</div>
      </div>
      <div class="row no-print">
        <button class="btn" type="button" id="btn-print">列印</button>
        <button class="btn" type="button" id="btn-snapshot">下載快照（M1+M2+方式）</button>
      </div>
    </div>
    <div id="env-notice" class="notice no-print" style="display:none"></div>
    <div class="tabs no-print" id="tabs">
      <button class="tab active" type="button" data-tab="module1">客戶資料庫</button>
      <button class="tab" type="button" data-tab="module2">營業稅</button>
    </div>
  </header>

  <div class="tab-panels">
    <!-- 模組1 -->
    <section class="card active" id="module1">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><h2>模組1｜客戶資料庫</h2> <span class="pill">可編輯 / 覆蓋 / 刪除 / JSON / CSV</span></div>
        <div class="row no-print">
          <button class="btn" type="button" id="m1-notes-export-all">匯出全部備註 Excel</button>
          <button class="btn" type="button" id="m1-json-export">JSON 匯出</button>
          <button class="btn" type="button" id="m1-csv-export">CSV 匯出（主檔）</button>
          <div class="small muted">CSV 匯入請用右側區塊</div>
        </div>
      </div>

      <div class="grid">
        <div class="two-col">
          <div class="grid">
            <div class="row">
              <div style="flex:1"><label>用戶代號</label><input id="m1-id" /></div>
              <div style="flex:2"><label>公司名稱</label><input id="m1-company" /></div>
            </div>
            <div class="row">
              <div style="flex:1"><label>設籍地址</label><input id="m1-reg" /></div>
              <div style="flex:1"><label>聯絡地址</label><input id="m1-addr" /></div>
            </div>
            <div class="row">
              <div style="flex:1"><label>聯絡人電話</label><input id="m1-phone" /></div>
              <div style="flex:1"><label>稅籍編號</label><input id="m1-bizno" /></div>
            </div>
            <div class="row">
              <div style="flex:1"><label>統一編號</label><input id="m1-taxid" /></div>
              <div style="flex:1"><label>負責人</label><input id="m1-principal" /></div>
            </div>
            <div class="row">
              <div style="flex:1"><label>聯絡人</label><input id="m1-contact" /></div>
              <div style="flex:1;display:flex;gap:8px">
                <div style="flex:1"><label>停業日期(起)</label><input id="m1-sfrom" type="date" /></div>
                <div style="flex:1"><label>停業日期(迄)</label><input id="m1-sto" type="date" /></div>
              </div>
            </div>
            <div class="row no-print">
              <button class="btn btn-acc" type="button" id="m1-save">新增 / 儲存覆蓋</button>
              <button class="btn btn-warn" type="button" id="m1-clear">清除欄位</button>
              <button class="btn" type="button" id="m1-reseed">載入示範資料</button>
            </div>
          </div>

          <div class="grid no-print">
            <div class="card" style="background:#0d1015">
              <div class="row"><strong>JSON 匯入（模組1）：</strong><input id="m1-json-in" type="file" accept=".json" /></div>
              <div class="hr"></div>
              <div class="row"><strong>CSV 匯入（建立/覆蓋客戶）：</strong><input id="m1-csv-in" type="file" accept=".csv" /></div>
              <div class="small muted" style="margin-top:6px">欄位：id,companyName,regAddr,contactAddr,phone,bizRegNo,taxId,principal,contact,suspendFrom,suspendTo</div>
            </div>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="flex-between row" style="justify-content:space-between;align-items:center">
        <h3>客戶列表</h3>
        <div class="row no-print" style="gap:12px;align-items:center">
          <input id="m1-search" placeholder="關鍵字（代號/公司/統編/人名/電話）" />
          <div id="m1-pager" class="pager"></div>
        </div>
      </div>
      <table class="table" id="m1-table">
        <thead>
          <tr>
            <th>代號</th><th>公司名稱</th><th>統一編號</th><th>聯絡人/電話</th><th>地址</th><th>停業</th><th class="no-print">操作</th>
          </tr>
        </thead>
        <tbody id="m1-tbody"></tbody>
      </table>
      <div class="small muted">展開每筆可寫入「傳票類別 / 常用備註 / 筆記紀錄」，會自動存入「歷史資料庫」。列印時會自動展開。</div>
    </section>

    <!-- 模組2 -->
    <section class="card" id="module2">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><h2>模組2｜營業稅模組</h2> <span class="pill">ROC 年度 / 六期 / 今日與未來三日</span></div>
        <div class="row no-print">
          <button class="btn" type="button" id="m2-json-export">JSON 匯出（模組2）</button>
          <div class="row"><strong>JSON 匯入：</strong><input id="m2-json-in" type="file" accept=".json" /></div>
        </div>
      </div>

      <div class="row">
        <div class="pill">今天：<span id="m2-today"></span></div>
        <div class="pill">民國年度：<span id="m2-roc"></span></div>
        <div class="row">
          <label>期別</label>
          <select id="m2-period" class="no-print">
            <option>01-02</option><option>03-04</option><option>05-06</option>
            <option>07-08</option><option>09-10</option><option>11-12</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <h3>新增預定收發票項目</h3>
        <div class="two-col">
          <div class="grid">
            <div class="row">
              <div style="flex:1">
                <label>選擇客戶（唯讀引用）</label>
                <select id="m2-customer" class="no-print"></select>
              </div>
              <div style="flex:1">
                <label>收發票方式（可新增/編輯/刪除）</label>
                <div class="row no-print">
                  <select id="m2-method"></select>
                  <input id="m2-method-new" placeholder="新增方式名稱" />
                  <button class="btn" type="button" id="m2-method-add">新增方式</button>
                  <button class="btn btn-danger" type="button" id="m2-method-del">刪除所選</button>
                </div>
              </div>
            </div>
            <div class="row">
              <div style="flex:1"><label>預定收發票日</label><input id="m2-date" type="date" class="no-print" /></div>
              <div style="flex:2"><label>提醒（自由文字）</label><input id="m2-remind" placeholder="提醒內容…" class="no-print" /></div>
            </div>
            <div class="row no-print">
              <button class="btn btn-ok" type="button" id="m2-add">加入清單</button>
              <button class="btn" type="button" id="m2-clear">清除欄位</button>
            </div>
            <div class="small muted">今日＝預定日 == 今天；明日清單＝今天 +1/+2/+3，依天數排序（含星期）。</div>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="two-col">
        <div class="grid print-break">
          <h3>今日預定收回客戶</h3>
          <table class="table">
            <thead><tr><th>日期(星期)</th><th>客戶</th><th>方式</th><th>提醒</th><th class="no-print">操作</th></tr></thead>
            <tbody id="m2-today-list"></tbody>
          </table>
        </div>
        <div class="grid print-break">
          <h3>未來三日（+1 / +2 / +3）</h3>
          <table class="table">
            <thead><tr><th>日期(星期)</th><th>客戶</th><th>方式</th><th>提醒</th><th class="no-print">操作</th></tr></thead>
            <tbody id="m2-next-list"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <footer class="card small muted no-print">
    <div class="row">
      <span>事件委派啟用・所有按鈕皆有 <span class="kbd">type="button"</span> ・全域錯誤攔截已啟用。</span>
      <span>若需 Service Worker / fetch / ES Modules，請以本機伺服器啟動（<span class="kbd">python -m http.server</span>）。</span>
    </div>
  </footer>
</div>

<script defer>
/* ========= 全域錯誤攔截 ========= */
window.onerror = function(message, source, lineno, colno, error){
  console.error("[window.onerror]", message, source, lineno, colno, error);
  alert("發生錯誤：" + message + "\\n請按 F12 開啟 console 以查看詳細。");
};
window.addEventListener("unhandledrejection", function(e){
  console.error("[unhandledrejection]", e.reason);
  alert("非同步錯誤：" + (e.reason && e.reason.message ? e.reason.message : e.reason));
});

/*** =========================================================
     STORAGE LAYER (IndexedDB + localStorage fallback)
========================================================= ***/
const DB_KEYS = { M1:"db_customers_v1", M2:"db_tax_v1", METHODS:"db_methods_v1" };

const IDB_NAME = "offline_client_db";
const IDB_VERSION = 1;
let idbAvailable = false;
let idbDb = null;

function idbInit(){
  return new Promise((resolve)=>{
    try{
      const req = indexedDB.open(IDB_NAME, IDB_VERSION);
      req.onerror = ()=> resolve(false);
      req.onsuccess = ()=>{ idbDb = req.result; idbAvailable = true; resolve(true); };
      req.onupgradeneeded = (e)=>{
        const db = e.target.result;
        if(!db.objectStoreNames.contains(DB_KEYS.M1)) db.createObjectStore(DB_KEYS.M1);
        if(!db.objectStoreNames.contains(DB_KEYS.M2)) db.createObjectStore(DB_KEYS.M2);
        if(!db.objectStoreNames.contains(DB_KEYS.METHODS)) db.createObjectStore(DB_KEYS.METHODS);
      };
    }catch(_){ resolve(false); }
  });
}
function idbGet(store, key){
  return new Promise((resolve)=> {
    try{
      const tx = idbDb.transaction(store, "readonly");
      const os = tx.objectStore(store);
      const req = os.get(key);
      req.onsuccess = ()=> resolve(req.result ?? null);
      req.onerror = ()=> resolve(null);
    }catch(_){ resolve(null); }
  });
}
function idbSet(store, key, val){
  return new Promise((resolve)=> {
    try{
      const tx = idbDb.transaction(store, "readwrite");
      const os = tx.objectStore(store);
      const req = os.put(val, key);
      req.onsuccess = ()=> resolve(true);
      req.onerror = ()=> resolve(false);
    }catch(_){ resolve(false); }
  });
}

/* localStorage 備援 */
function lsLoad(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw?JSON.parse(raw):fallback; }
  catch(e){ console.warn("ls parse fail", key, e); return fallback; }
}
function lsSave(key, data){ localStorage.setItem(key, JSON.stringify(data)); }

/* 高階 API：先走 IDB，失敗再走 LS */
async function storeLoad(key, fallback){
  if(idbAvailable){
    const got = await idbGet(key, "value");
    if(got !== null) return got;
    return fallback;
  }else{
    return lsLoad(key, fallback);
  }
}
async function storeSave(key, data){
  if(idbAvailable){
    const ok = await idbSet(key, "value", data);
    if(!ok) lsSave(key, data);
  }else{
    lsSave(key, data);
  }
}

/* ========= 工具 ========= */
function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
function isoPlusDays(iso, days){ const d=new Date(iso); d.setDate(d.getDate()+days); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
function weekdayZH(iso){ return ["日","一","二","三","四","五","六"][new Date(iso).getDay()]; }
function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }
/* 屬性值跳脫：避免 XSS/破版 */
function escapeAttr(s){
  return String(s||"").replace(/&/g,"&amp;")
                      .replace(/"/g,"&quot;")
                      .replace(/</g,"&lt;")
                      .replace(/>/g,"&gt;");
}
function downloadJSON(filename, obj){ const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
function $(sel){ return document.querySelector(sel); }

/* ========= 全域狀態 ========= */
let customers = { customers: [] };
let tax = { items: [] };
let methods = { list: ["親送","郵寄","快遞","EMAIL","LINE"] };

/* 模組1分頁狀態（LS 持久化） */
let m1Pager = (()=>{
  const k="m1_pager_v1";
  const d = lsLoad(k, { page:1, size:20 });
  return {
    get page(){ return d.page; },
    set page(v){ d.page = Math.max(1, v|0); lsSave(k,d); },
    get size(){ return d.size; },
    set size(v){ d.size = Math.min(200, Math.max(5, v|0 || 20)); d.page=1; lsSave(k,d); },
    snapshot(){ return {...d}; }
  };
})();

/* ========= 載入流程 ========= */
async function bootstrap(){
  const ok = await idbInit();
  idbAvailable = ok;

  customers = await storeLoad(DB_KEYS.M1, { customers: [] });
  tax       = await storeLoad(DB_KEYS.M2, { items: [] });
  methods   = await storeLoad(DB_KEYS.METHODS, { list: ["親送","郵寄","快遞","EMAIL","LINE"] });

  if ((!customers.customers || customers.customers.length===0) &&
      (!tax.items || tax.items.length===0)){
    try{
      const seed = $("#seed-customers"); if(seed){
        const data = JSON.parse(seed.textContent);
        customers = { customers: data.customers || [] };
        await storeSave(DB_KEYS.M1, customers);
      }
    }catch(e){ console.warn("seed parse fail", e); }
  }

  initUI();
  renderAll();

  if((tax.items && tax.items.length>0) && (!customers.customers || customers.customers.length===0)){
    const box = $("#env-notice");
    box.style.display = "block";
    box.innerHTML = `
      <strong>偵測到可能的 file:// 儲存分區差異：</strong>
      模組2有資料，但模組1為空。通常代表以不同檔名/路徑或無痕模式開啟。<br>
      建議固定同一檔名與資料夾開啟；或使用本機伺服器（<span class="kbd">python -m http.server</span>）。<br>
      也可立即 <button class="btn btn-warn" type="button" id="btn-load-seed">導入範例</button>
      或 <label class="btn" for="btn-restore-json">匯入快照<input id="btn-restore-json" type="file" accept=".json" style="display:none"></label>。
    `;
    box.addEventListener("click", (e)=>{
      if(e.target.id==="btn-load-seed"){
        try{
          const data = JSON.parse($("#seed-customers").textContent);
          customers = { customers: data.customers || [] };
          storeSave(DB_KEYS.M1, customers).then(()=> renderAll());
          alert("已導入範例客戶。");
        }catch(err){ alert("導入失敗："+err.message); }
      }
    });
    box.querySelector("#btn-restore-json").addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const obj = JSON.parse(r.result);
          if(obj.module1) customers = obj.module1;
          if(obj.module2) tax = obj.module2;
          if(obj.methods) methods = obj.methods;
          Promise.all([
            storeSave(DB_KEYS.M1, customers),
            storeSave(DB_KEYS.M2, tax),
            storeSave(DB_KEYS.METHODS, methods)
          ]).then(()=> renderAll());
          alert("已從快照還原。");
        }catch(err){ alert("快照不合法："+err.message); }
      };
      r.readAsText(f);
    });
  }
}

/* ========= UI 綁定與渲染 ========= */
const tabsEl = $("#tabs"); const panels = document.querySelector(".tab-panels");
if(tabsEl){
  tabsEl.addEventListener("click", (e)=>{
    const btn = e.target.closest(".tab"); if(!btn) return;
    const name = btn.getAttribute("data-tab");
    tabsEl.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t===btn));
    panels.querySelectorAll("section").forEach(sec=>sec.classList.toggle("active", sec.id===name));
  });
}

/* M1 DOM */
const m1 = {
  id: $("#m1-id"), company: $("#m1-company"), reg: $("#m1-reg"), addr: $("#m1-addr"),
  phone: $("#m1-phone"), bizno: $("#m1-bizno"), taxid: $("#m1-taxid"),
  principal: $("#m1-principal"), contact: $("#m1-contact"),
  sfrom: $("#m1-sfrom"), sto: $("#m1-sto"),
  save: $("#m1-save"), clear: $("#m1-clear"),
  jsonIn: $("#m1-json-in"), jsonExport: $("#m1-json-export"),
  csvIn: $("#m1-csv-in"), search: $("#m1-search"),
  reseed: $("#m1-reseed"), tbody: $("#m1-tbody"),
  notesExportAll: $("#m1-notes-export-all")
};
/* M2 DOM */
const m2 = {
  today: $("#m2-today"), roc: $("#m2-roc"), period: $("#m2-period"),
  jsonExport: $("#m2-json-export"), jsonIn: $("#m2-json-in"),
  customerSel: $("#m2-customer"), methodSel: $("#m2-method"),
  methodNew: $("#m2-method-new"), methodAdd: $("#m2-method-add"), methodDel: $("#m2-method-del"),
  date: $("#m2-date"), remind: $("#m2-remind"),
  add: $("#m2-add"), clear: $("#m2-clear"),
  todayList: $("#m2-today-list"), nextList: $("#m2-next-list")
};

function initUI(){
  $("#btn-print").addEventListener("click", ()=> window.print());
  $("#btn-snapshot").addEventListener("click", ()=> downloadJSON(`backup_${Date.now()}.json`, { module1: customers, module2: tax, methods }));

  let detailsState = [];
  window.onbeforeprint = function(){
    detailsState = Array.from(document.querySelectorAll("details")).map(d=>({el:d,open:d.open}));
    document.querySelectorAll("details").forEach(d=> d.open = true);
  };
  window.onafterprint = function(){ detailsState.forEach(s=> s.el.open = s.open); detailsState = []; };

  m1.save.addEventListener("click", upsertCustomer);
  m1.clear.addEventListener("click", clearM1Fields);

  /* 匯出 */
  m1.jsonExport.addEventListener("click", ()=> downloadJSON(`customers_${Date.now()}.json`, customers));
  const csvBtn = $("#m1-csv-export");
  if(csvBtn) csvBtn.addEventListener("click", exportCustomersCSV);

  /* 匯入 */
  m1.jsonIn.addEventListener("change", (e)=> e.target.files[0] && importJSONToM1(e.target.files[0]));
  m1.csvIn.addEventListener("change", (e)=> e.target.files[0] && importCSVToCustomers(e.target.files[0]));

  /* 搜尋 → 重置至第1頁並渲染（避免跳頁找不到） */
  m1.search.addEventListener("input", ()=>{
    m1Pager.page = 1;
    renderM1Table();
  });

  m1.reseed.addEventListener("click", ()=>{
    if(!confirm("將載入示範資料並覆蓋現有客戶。繼續？")) return;
    try{
      const data = JSON.parse($("#seed-customers").textContent);
      customers = { customers: data.customers || [] };
      storeSave(DB_KEYS.M1, customers).then(()=>{ renderM1Table(); populateM2Customers(); });
    }catch(e){ alert("載入失敗："+e.message); }
  });
  // 全客戶備註一次匯出
  m1.notesExportAll.addEventListener("click", exportAllNotesToExcel);

  function refreshDates(){
    const d=new Date(); const y=d.getFullYear(), m=d.getMonth()+1, da=d.getDate();
    m2.today.textContent = `${y}-${String(m).padStart(2,"0")}-${String(da).padStart(2,"0")}（${weekdayZH(todayISO())}）`;
    m2.roc.textContent = `${y-1911}`;
  }
  refreshDates();

  if(m2.methodAdd) m2.methodAdd.addEventListener("click", addMethod);
  if(m2.methodDel) m2.methodDel.addEventListener("click", delMethod);
  if(m2.add) m2.add.addEventListener("click", addTaxItem);
  if(m2.clear) m2.clear.addEventListener("click", ()=>{ m2.customerSel.value=""; m2.methodSel.selectedIndex=0; m2.date.value=""; m2.remind.value=""; });

  /* 委派：M1 表格（含備註編輯/刪除/儲存/匯出Excel） */
  m1.tbody.addEventListener("click",(e)=>{
    const btn = e.target.closest("button"); if(!btn) return;
    const id = btn.getAttribute("data-id");
    const act = btn.getAttribute("data-act");
    const nid = btn.getAttribute("data-nid");

    if(act==="edit") { editFillCustomer(id); return; }
    if(act==="del")  { deleteCustomer(id); return; }

    if(act==="add-note"){
      const wrap = btn.closest("details");
      const typeSel = wrap.querySelector('[data-role="note-type"]');
      const textInp = wrap.querySelector('[data-role="note-text"]');
      const type = typeSel?typeSel.value.trim():"備註";
      const text = textInp?textInp.value.trim():"";
      if(!text){ alert("請輸入備註內容"); return; }
      appendNote(id, type, text).then(()=> renderM1Table());
      return;
    }

    if(act==="export-notes-xls"){ exportNotesToExcel(id); return; }

    if(act==="del-note"){
      if(!confirm("刪除此備註？")) return;
      deleteNote(id, nid).then(()=> renderM1Table());
      return;
    }

    if(act==="edit-note"){
      const row = e.target.closest("[data-note-row]");
      if(!row) return;
      const txtEl = row.querySelector(".note-text");
      const oldText = txtEl ? txtEl.textContent : "";
      const c = customers.customers.find(x=>x.id===id);
      const { note } = c ? findNoteById(c, nid) : {note:null};
      const oldType = note ? note.voucherType : "備註";

      row.innerHTML = `
        <div class="row" style="align-items:center" data-cid="${id}" data-nid="${nid}">
          <select data-role="edit-note-type">
            <option ${oldType==="進項"?"selected":""}>進項</option>
            <option ${oldType==="銷項"?"selected":""}>銷項</option>
            <option ${oldType==="折讓"?"selected":""}>折讓</option>
            <option ${oldType==="常用備註"?"selected":""}>常用備註</option>
            <option ${oldType==="筆記紀錄"?"selected":""}>筆記紀錄</option>
          </select>
          <input data-role="edit-note-text" style="flex:1" value="${escapeAttr(oldText||"")}" />
          <button class="btn btn-ok" type="button" data-act="save-note" data-id="${id}" data-nid="${nid}">儲存覆蓋</button>
          <button class="btn" type="button" data-act="cancel-edit-note" data-id="${id}" data-nid="${nid}">取消</button>
        </div>
      `;
      return;
    }

    if(act==="cancel-edit-note"){ renderM1Table(); return; }

    if(act==="save-note"){
      const row = e.target.closest("[data-cid][data-nid]");
      const typeSel = row.querySelector('[data-role="edit-note-type"]');
      const textInp = row.querySelector('[data-role="edit-note-text"]');
      const type = typeSel ? typeSel.value.trim() : "備註";
      const text = textInp ? textInp.value.trim() : "";
      if(!text){ alert("請輸入備註內容"); return; }
      updateNote(id, nid, { voucherType:type, text }).then(()=> renderM1Table());
      return;
    }
  });

  /* 委派：M2 清單 */
  m2.todayList.addEventListener("click",(e)=>{
    const btn=e.target.closest("button"); if(!btn) return;
    const id=btn.getAttribute("data-id"); const act=btn.getAttribute("data-act");
    if(act==="edit-tax") editTaxItem(id); else if(act==="del-tax") deleteTaxItem(id);
  });
  m2.nextList.addEventListener("click",(e)=>{
    const btn=e.target.closest("button"); if(!btn) return;
    const id=btn.getAttribute("data-id"); const act=btn.getAttribute("data-act");
    if(act==="edit-tax") editTaxItem(id); else if(act==="del-tax") deleteTaxItem(id);
  });
}

function renderAll(){ renderM1Table(); populateM2Customers(); populateMethods(); renderM2Lists(); }

/* ====== 模組1：CRUD／備註功能／匯入匯出 ====== */
function clearM1Fields(){ ["id","company","reg","addr","phone","bizno","taxid","principal","contact","sfrom","sto"].forEach(k=>m1[k].value=""); }
async function upsertCustomer(){
  const id = (m1.id.value||"").trim();
  if(!id){ alert("請輸入用戶代號"); return; }

  const sfrom = m1.sfrom.value || "";
  const sto   = m1.sto.value   || "";
  if(sfrom && sto && new Date(sfrom) > new Date(sto)){
    alert("停業日期範圍錯誤：起日不可大於迄日"); 
    return;
  }

  const obj = {
    id,
    companyName: m1.company.value.trim(),
    regAddr: m1.reg.value.trim(),
    contactAddr: m1.addr.value.trim(),
    phone: m1.phone.value.trim(),
    bizRegNo: m1.bizno.value.trim(),
    taxId: m1.taxid.value.trim(),
    principal: m1.principal.value.trim(),
    contact: m1.contact.value.trim(),
    suspendFrom: sfrom,
    suspendTo: sto,
    notesHistory: []
  };
  const idx = customers.customers.findIndex(c=>c.id===id);
  if(idx>=0){ obj.notesHistory = customers.customers[idx].notesHistory || []; customers.customers[idx]=obj; }
  else customers.customers.push(obj);
  await storeSave(DB_KEYS.M1, customers);
  renderM1Table(); populateM2Customers();
  alert("已儲存。");
}
async function deleteCustomer(id){
  if(!confirm(`確定刪除客戶 ${id}？`)) return;
  const i = customers.customers.findIndex(c=>c.id===id);
  if(i>=0){ customers.customers.splice(i,1); await storeSave(DB_KEYS.M1, customers); renderM1Table(); populateM2Customers(); }
}
function editFillCustomer(id){
  const c = customers.customers.find(x=>x.id===id); if(!c) return;
  m1.id.value=c.id; m1.company.value=c.companyName||""; m1.reg.value=c.regAddr||""; m1.addr.value=c.contactAddr||"";
  m1.phone.value=c.phone||""; m1.bizno.value=c.bizRegNo||""; m1.taxid.value=c.taxId||"";
  m1.principal.value=c.principal||""; m1.contact.value=c.contact||"";
  m1.sfrom.value=c.suspendFrom||""; m1.sto.value=c.suspendTo||"";
  window.scrollTo({top:0,behavior:"smooth"});
}

/* 新版：新增備註（確保每筆有唯一 id） */
async function appendNote(id, voucherType, text){
  const c = customers.customers.find(x=>x.id===id); if(!c) return;
  c.notesHistory = c.notesHistory || [];
  c.notesHistory.push({
    id: "N" + Date.now() + Math.random().toString(16).slice(2),
    ts: new Date().toISOString(),
    voucherType, text
  });
  await storeSave(DB_KEYS.M1, customers);
}

/* 備註工具：查找／更新／刪除 */
function findNoteById(customer, noteId){
  if(!customer || !customer.notesHistory) return { idx:-1, note:null };
  const idx = customer.notesHistory.findIndex(n => n.id === noteId);
  return { idx, note: idx>=0 ? customer.notesHistory[idx] : null };
}
async function updateNote(customerId, noteId, next){
  const c = customers.customers.find(x=>x.id===customerId); if(!c) return false;
  const { idx } = findNoteById(c, noteId);
  if(idx < 0) return false;
  c.notesHistory[idx].voucherType = next.voucherType;
  c.notesHistory[idx].text = next.text;
  c.notesHistory[idx].ts = new Date().toISOString();
  await storeSave(DB_KEYS.M1, customers);
  return true;
}
async function deleteNote(customerId, noteId){
  const c = customers.customers.find(x=>x.id===customerId); if(!c) return false;
  const { idx } = findNoteById(c, noteId);
  if(idx < 0) return false;
  c.notesHistory.splice(idx, 1);
  await storeSave(DB_KEYS.M1, customers);
  return true;
}

/* 單一客戶：備註匯出 Excel（HTML 表格 .xls） */
function exportNotesToExcel(customerId){
  const c = customers.customers.find(x=>x.id===customerId);
  if(!c){ alert("找不到客戶"); return; }
  const rows = (c.notesHistory||[]).slice().sort((a,b)=> (a.ts>b.ts?1:-1));
  const esc = (s)=> String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const html =
`<html><head><meta charset="UTF-8"></head><body>
<table border="1">
  <tr><th>客戶代號</th><td>${esc(c.id)}</td><th>公司名稱</th><td>${esc(c.companyName||"")}</td></tr>
</table>
<br/>
<table border="1">
  <tr><th>#</th><th>時間</th><th>傳票類別</th><th>備註內容</th></tr>
  ${rows.map((n,i)=> `<tr><td>${i+1}</td><td>${esc(n.ts)}</td><td>${esc(n.voucherType||"")}</td><td>${esc(n.text||"")}</td></tr>`).join("")}
</table>
</body></html>`;
  const blob = new Blob([html], {type:"application/vnd.ms-excel"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `notes_${c.id}.xls`; a.click(); URL.revokeObjectURL(url);
}

/* ★ 全客戶：備註一次匯出 Excel（HTML 多表格 .xls） */
function exportAllNotesToExcel(){
  const list = customers.customers.slice().sort((a,b)=> a.id.localeCompare(b.id));
  if(list.length===0){ alert("目前沒有客戶資料"); return; }
  const esc = (s)=> String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const sections = list.map(c=>{
    const rows = (c.notesHistory||[]).slice().sort((a,b)=> (a.ts>b.ts?1:-1));
    const body = rows.length
      ? rows.map((n,i)=> `<tr><td>${i+1}</td><td>${esc(n.ts||"")}</td><td>${esc(n.voucherType||"")}</td><td>${esc(n.text||"")}</td></tr>`).join("")
      : `<tr><td colspan="4">（無備註）</td></tr>`;
    return `
      <table border="1">
        <tr><th colspan="4" style="background:#eee">客戶：${esc(c.id)}｜${esc(c.companyName||"")}</th></tr>
        <tr><th>#</th><th>時間</th><th>傳票類別</th><th>備註內容</th></tr>
        ${body}
      </table>
      <br/>
    `;
  }).join("\n");

  const html = `<html><head><meta charset="UTF-8"></head><body>${sections}</body></html>`;
  const blob = new Blob([html], {type:"application/vnd.ms-excel"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `notes_all_${Date.now()}.xls`;
  a.click();
  URL.revokeObjectURL(url);
}

/* 主檔 CSV 匯出 */
function exportCustomersCSV(){
  const headers = ["id","companyName","regAddr","contactAddr","phone","bizRegNo","taxId","principal","contact","suspendFrom","suspendTo"];
  const escCSV = v=>{
    const s = String(v??"");
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const rows = [headers.join(",")].concat(
    customers.customers.slice().sort((a,b)=>a.id.localeCompare(b.id)).map(c=>
      headers.map(h=>escCSV(c[h]??"")).join(",")
    )
  ).join("\n");

  const blob = new Blob([rows], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `customers_${Date.now()}.csv`; a.click();
  URL.revokeObjectURL(url);
}

/* 渲染客戶列表（含分頁器） */
function renderM1Table(){
  const q = (m1.search.value||"").toLowerCase();
  const all = customers.customers
    .filter(c=>{
      if(!q) return true;
      const hay = [c.id,c.companyName,c.taxId,c.principal,c.contact,c.phone].join("|").toLowerCase();
      return hay.includes(q);
    })
    .sort((a,b)=>a.id.localeCompare(b.id));

  // 補舊資料備註 id
  let touched = false;
  all.forEach(c=>{
    c.notesHistory = c.notesHistory || [];
    c.notesHistory.forEach(n=>{
      if(!n.id){ n.id = "N" + Date.now() + Math.random().toString(16).slice(2); touched = true; }
    });
  });
  if(touched){ storeSave(DB_KEYS.M1, customers); }

  // 分頁
  const total = all.length;
  const { page, size } = m1Pager.snapshot();
  const pages = Math.max(1, Math.ceil(total / size));
  const cur = Math.min(page, pages);
  if(cur !== page){ m1Pager.page = cur; }

  const start = (cur-1)*size;
  const list = all.slice(start, start+size);

  // 渲染 tbody（只渲染當頁，避免大量 innerHTML 卡頓）
  m1.tbody.innerHTML = list.map(c=>{
    const stop = (c.suspendFrom||"") || (c.suspendTo||"") ? `${c.suspendFrom||""}~${c.suspendTo||""}` : "";
    const addr = [c.regAddr,c.contactAddr].filter(Boolean).join("<br>");
    const notesList = (c.notesHistory||[]).slice().reverse();

    const notesHtml = notesList.map(n=>{
      const d=new Date(n.ts); const stamp = isNaN(d)? n.ts : d.toLocaleString();
      return `
        <div class="small" data-note-row data-cid="${c.id}" data-nid="${n.id}">
          <span class="pill">${escapeHTML(n.voucherType||"備註")}</span>
          <span class="note-text">${escapeHTML(n.text||"")}</span>
          <span class="muted">（${escapeHTML(stamp)}）</span>
          <span class="no-print" style="margin-left:8px">
            <button class="btn" type="button" data-act="edit-note" data-id="${c.id}" data-nid="${n.id}">編輯</button>
            <button class="btn btn-danger" type="button" data-act="del-note" data-id="${c.id}" data-nid="${n.id}">刪除</button>
          </span>
        </div>
      `;
    }).join("") || `<div class="small muted">尚無歷史紀錄</div>`;

    return `
      <tr>
        <td><strong>${escapeHTML(c.id)}</strong></td>
        <td>${escapeHTML(c.companyName||"")}</td>
        <td>${escapeHTML(c.taxId||"")}</td>
        <td>${escapeHTML((c.contact||"")+" / "+(c.phone||""))}</td>
        <td>${addr}</td>
        <td>${stop || "-"}</td>
        <td class="small no-print">
          <div class="row">
            <button class="btn" type="button" data-act="edit" data-id="${c.id}">編輯填入</button>
            <button class="btn btn-danger" type="button" data-act="del" data-id="${c.id}">刪除</button>
          </div>
          <details>
            <summary>折疊式備註與歷史</summary>
            <div class="grid" style="margin-top:8px">
              <div class="row">
                <select data-id="${c.id}" data-role="note-type">
                  <option>進項</option><option>銷項</option><option>折讓</option><option>常用備註</option><option>筆記紀錄</option>
                </select>
                <input placeholder="輸入備註內容…" data-id="${c.id}" data-role="note-text" style="flex:1" />
                <button class="btn btn-ok" type="button" data-act="add-note" data-id="${c.id}">新增備註</button>
                <button class="btn" type="button" data-act="export-notes-xls" data-id="${c.id}">匯出 Excel</button>
              </div>
              <div data-role="notes-list">
                ${notesHtml}
              </div>
            </div>
          </details>
        </td>
      </tr>
    `;
  }).join("");

  // 渲染分頁器
  const pager = $("#m1-pager");
  pager.innerHTML = `
    <button class="btn" type="button" data-act="pprev" ${cur<=1?"disabled":""}>«</button>
    <button class="btn" type="button" data-act="prev" ${cur<=1?"disabled":""}>‹</button>
    <span class="num">${cur}</span>/<span class="num">${pages}</span>
    <button class="btn" type="button" data-act="next" ${cur>=pages?"disabled":""}>›</button>
    <button class="btn" type="button" data-act="nnext" ${cur>=pages?"disabled":""}>»</button>
    <label class="small muted">每頁</label>
    <select id="m1-page-size">
      ${[10,20,50,100,200].map(n=>`<option value="${n}" ${n===m1Pager.size?"selected":""}>${n}</option>`).join("")}
    </select>
    <span class="small muted">共 ${total} 筆</span>
  `;

  // 分頁器事件
  pager.onclick = (e)=>{
    const b = e.target.closest("button"); if(!b) return;
    const act = b.getAttribute("data-act");
    if(act==="prev"){ m1Pager.page = Math.max(1, cur-1); renderM1Table(); }
    if(act==="next"){ m1Pager.page = Math.min(pages, cur+1); renderM1Table(); }
    if(act==="pprev"){ m1Pager.page = 1; renderM1Table(); }
    if(act==="nnext"){ m1Pager.page = pages; renderM1Table(); }
  };
  const sizeSel = pager.querySelector("#m1-page-size");
  if(sizeSel){
    sizeSel.onchange = (e)=>{
      m1Pager.size = parseInt(e.target.value,10);
      renderM1Table();
    };
  }
}

/* CSV 解析＆匯入 */
function parseCSV(text){
  const rows=[]; let row=[],val="",inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQ){
      if(ch === '"'){ if(text[i+1] === '"'){ val+='"'; i++; } else inQ=false; }
      else val+=ch;
    }else{
      if(ch === '"') inQ=true;
      else if(ch === ","){ row.push(val); val=""; }
      else if(ch === "\n"){ row.push(val); rows.push(row); row=[]; val=""; }
      else if(ch === "\r"){ /* ignore */ }
      else val+=ch;
    }
  }
  if(val.length || row.length){ row.push(val); rows.push(row); }
  return rows;
}
function importCSVToCustomers(file){
  const reader=new FileReader();
  reader.onload=async ()=>{
    const text=reader.result||""; const rows=parseCSV(text); if(!rows.length){ alert("CSV 空白"); return; }
    const headers=rows[0].map(h=>h.trim()); const idx=(n)=>headers.indexOf(n); const get=(r,n)=> r[idx(n)]||"";
    for(let i=1;i<rows.length;i++){
      const r=rows[i]; if(!r||!r.length) continue;
      const id=(get(r,"id")||"").trim(); if(!id) continue;
      const obj={
        id, companyName:get(r,"companyName"), regAddr:get(r,"regAddr"), contactAddr:get(r,"contactAddr"),
        phone:get(r,"phone"), bizRegNo:get(r,"bizRegNo"), taxId:get(r,"taxId"),
        principal:get(r,"principal"), contact:get(r,"contact"),
        suspendFrom:get(r,"suspendFrom"), suspendTo:get(r,"suspendTo"),
        notesHistory:[]
      };
      const exist = customers.customers.findIndex(c=>c.id===id);
      if(exist>=0){ obj.notesHistory = customers.customers[exist].notesHistory || []; customers.customers[exist]=obj; }
      else customers.customers.push(obj);
    }
    await storeSave(DB_KEYS.M1, customers);
    renderM1Table(); populateM2Customers(); alert("CSV 匯入完成。");
  };
  reader.readAsText(file);
}
function importJSONToM1(file){
  const reader=new FileReader();
  reader.onload=async ()=>{
    try{
      const data=JSON.parse(reader.result);
      if(Array.isArray(data.customers)) customers=data;
      else if(Array.isArray(data)) customers={customers:data};
      else if(data && data.customers) customers=data;
      else throw new Error("格式需為 { customers:[...] } 或純陣列/包裝");
      await storeSave(DB_KEYS.M1, customers);
      renderM1Table(); populateM2Customers(); alert("模組1 JSON 匯入完成。");
    }catch(e){ alert("JSON 解析失敗："+e.message); }
  };
  reader.readAsText(file);
}

/* ====== 模組2：清單 ====== */
function populateM2Customers(){
  if(!m2.customerSel) return;
  m2.customerSel.innerHTML = `<option value="">請選擇客戶</option>` + customers.customers.slice().sort((a,b)=>a.id.localeCompare(b.id))
    .map(c=>`<option value="${c.id}">${c.id}｜${escapeHTML(c.companyName||"")}</option>`).join("");
}
function populateMethods(){ if(m2.methodSel) m2.methodSel.innerHTML = methods.list.map(n=>`<option>${escapeHTML(n)}</option>`).join(""); }
async function addMethod(){
  const name=(m2.methodNew.value||"").trim(); if(!name){ alert("請輸入新方式名稱"); return; }
  if(methods.list.includes(name)){ alert("方式已存在"); return; }
  methods.list.push(name);
  await storeSave(DB_KEYS.METHODS, methods);
  populateMethods(); m2.methodNew.value="";
}
async function delMethod(){
  const cur=m2.methodSel.value; if(!cur) return;
  if(!confirm(`刪除方式「${cur}」？`)) return;
  const i=methods.list.indexOf(cur);
  if(i>=0){ methods.list.splice(i,1); await storeSave(DB_KEYS.METHODS, methods); populateMethods(); }
}
async function addTaxItem(){
  const cid=m2.customerSel.value; if(!cid){ alert("請選擇客戶"); return; }
  const c=customers.customers.find(x=>x.id===cid); if(!c){ alert("客戶不存在"); return; }
  const method=m2.methodSel.value||""; const date=m2.date.value||""; if(!date){ alert("請選擇預定日"); return; }
  const note=m2.remind.value||""; const id="T"+Date.now();
  tax.items.push({ id, customerId: cid, method, date, note });
  await storeSave(DB_KEYS.M2, tax);
  renderM2Lists(); alert("已加入清單。");
}
function formatCustomerReadonly(cid){
  const c=customers.customers.find(x=>x.id===cid);
  if(!c) return "<span class='muted'>[找不到客戶]</span>";
  const addr=[c.regAddr,c.contactAddr].filter(Boolean).join(" / ");
  return `
    <div class="small">
      <div><strong>${escapeHTML(c.id)}</strong>｜${escapeHTML(c.companyName||"")}</div>
      <div class="muted">統編：${escapeHTML(c.taxId||"-")}｜聯絡：${escapeHTML(c.contact||"-")} / ${escapeHTML(c.phone||"-")}</div>
      <div class="muted">地址：${escapeHTML(addr||"-")}</div>
    </div>
  `;
}
function renderM2Lists(){
  const tdy=todayISO();
  const todayItems = tax.items.filter(x=>x.date===tdy);
  const plus=[1,2,3].map(d=>({d,iso:isoPlusDays(tdy,d)}));
  const nextItems = tax.items.filter(x=>plus.some(p=>p.iso===x.date)).sort((a,b)=> new Date(a.date)-new Date(b.date));
  m2.todayList.innerHTML = todayItems.map(x=>{
    const wd=weekdayZH(x.date);
    return `
      <tr data-id="${x.id}">
        <td>${x.date}（${wd}）</td>
        <td>${formatCustomerReadonly(x.customerId)}</td>
        <td>${escapeHTML(x.method||"-")}</td>
        <td>${escapeHTML(x.note||"-")}</td>
        <td class="no-print">
          <div class="row">
            <button class="btn" type="button" data-act="edit-tax" data-id="${x.id}">編輯</button>
            <button class="btn btn-danger" type="button" data-act="del-tax" data-id="${x.id}">刪除</button>
          </div>
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="5" class="muted">今日無預定</td></tr>`;
  m2.nextList.innerHTML = nextItems.map(x=>{
    const wd=weekdayZH(x.date);
    return `
      <tr data-id="${x.id}">
        <td>${x.date}（${wd}）</td>
        <td>${formatCustomerReadonly(x.customerId)}</td>
        <td>${escapeHTML(x.method||"-")}</td>
        <td>${escapeHTML(x.note||"-")}</td>
        <td class="no-print">
          <div class="row">
            <button class="btn" type="button" data-act="edit-tax" data-id="${x.id}">編輯</button>
            <button class="btn btn-danger" type="button" data-act="del-tax" data-id="${x.id}">刪除</button>
          </div>
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="5" class="muted">未來三日無預定</td></tr>`;
}

/* ====== 初始化 ====== */
document.addEventListener("DOMContentLoaded", bootstrap);
</script>
</body>
</html>