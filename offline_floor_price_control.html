<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é›¢ç·šå•†å“é€²éŠ·èˆ‡åƒ¹æ ¼ä¸‹é™ç®¡æ§ï¼ˆå–®æª” HTMLï¼ŒFixedï¼‰</title>
  <style>
    :root {
      /* é–“è·ç³»çµ± */
      --spacing-xs: 8px;
      --spacing-sm: 12px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;

      /* è‰²å½©ç³»çµ± */
      --bg: #F8F9FA;
      /* å¾®å†·èª¿çŸ³ç°è‰² */
      --ink: #1C212E;
      /* æ·±é‚ƒè¿‘å¢¨è—è‰² */
      --muted: #6C757D;
      /* å±¤æ¬¡æš–ç° */
      --ok: #0A7D57;
      /* æ²‰ç©©æˆåŠŸç¶  */
      --warn: #C22B2B;
      /* å…§æ–‚è­¦ç¤ºç´… */
      --info: #215EA6;
      /* é«˜é›…è³‡è¨Šè— */
      --surface: #FFFFFF;
      --cta: #800020;
      /* å‹ƒè‰®ç¬¬ç´… */
      --cta-hover: #600018;
      --cta-disabled: #D1D5DB;
      --border: #E2E8F0;
      /* ç´°è†©æ·ºç° */
      --grid: #D6DBE1;

      /* å­—é«”ç³»çµ± */
      --mono: ui-monospace, "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, "Liberation Mono", monospace;
      --sans: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Helvetica, Arial, sans-serif;
      --font-display-weight: 800;
      --font-display-size: 1.35em;

      /* ä½ˆå±€ç³»çµ± */
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0, 0, 0, .06);
      --card-padding-lg: 20px;
    }

    /* ä¸»é¡Œï¼šå·¥æ¥­ç†æ€§ */
    :root.theme-industrial {
      --bg: #F7F8FA;
      --surface: #FFFFFF;
      --grid: #E6EBF2;
      --ink: #0B0B0C;
    }

    /* ä¸»é¡Œï¼šç¾ä»£æ›¸å ±ï¼ˆé«˜å°æ¯”é»‘ç™½ï¼‰ */
    :root.theme-editorial {
      --bg: #FFFFFF;
      --surface: #FFFFFF;
      --ink: #0B0B0C;
      --muted: #6B7280;
      --grid: #F1F5F9;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--sans);
      line-height: 1.5;
    }

    /* App æ¡†æ¶ */
    .appbar {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .appbar .title {
      font-weight: var(--font-display-weight);
      font-size: var(--font-display-size);
      letter-spacing: .3px
    }

    .appbar .search {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 12px;
    }

    .appbar input[type=search] {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 14px;
    }

    .appbar .actions {
      display: flex;
      gap: 8px
    }

    .btn {
      appearance: none;
      border: 1px solid var(--cta);
      background: var(--cta);
      color: #fff;
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all .15s ease-in-out;
      font-weight: 600;
      font-size: 14px;
    }

    .btn.secondary {
      background: transparent;
      color: var(--cta);
      border-color: var(--cta)
    }

    .btn.ghost {
      background: transparent;
      color: var(--ink);
      border-color: var(--border)
    }

    .btn:disabled {
      background: var(--cta-disabled);
      border-color: var(--cta-disabled);
      cursor: not-allowed
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
      background: var(--cta-hover)
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--border);
      background: var(--surface)
    }

    .badge.ok {
      color: var(--ok);
      border-color: var(--ok)
    }

    .badge.warn {
      color: var(--warn);
      border-color: var(--warn)
    }

    .badge.info {
      color: var(--info);
      border-color: var(--info)
    }

    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 16px;
      padding: 16px;
      align-items: start;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr
      }

      .sidenav {
        position: sticky;
        top: 56px
      }
    }

    .sidenav {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
    }

    .navlink {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600
    }

    .navlink.active,
    .navlink:hover {
      background: var(--bg)
    }

    .main {
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .card .hd {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card .bd {
      padding: 14px
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .grid.cols-2 {
      grid-template-columns: 1fr 1fr
    }

    .grid.cols-3 {
      grid-template-columns: repeat(3, 1fr)
    }

    @media (max-width: 960px) {

      .grid.cols-2,
      .grid.cols-3 {
        grid-template-columns: 1fr
      }
    }

    /* è¡¨å–® */
    .field {
      display: grid;
      gap: 6px
    }

    .label {
      font-size: 12px;
      color: var(--muted)
    }

    .input,
    select,
    textarea {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--ink);
      border-radius: 10px;
      padding: 10px 12px;
      font-family: var(--sans);
      font-size: 14px;
      outline: none;
    }

    .input[aria-invalid="true"] {
      border-color: var(--warn);
      box-shadow: 0 0 0 3px rgba(224, 49, 49, .15)
    }

    .helper {
      font-size: 12px;
      color: var(--muted)
    }

    .helper.warn {
      color: var(--warn)
    }

    .inline {
      display: flex;
      gap: 10px;
      align-items: end
    }

    hr.sep {
      border: none;
      border-top: 1px dashed var(--grid);
      margin: 12px 0
    }

    /* è¡¨æ ¼ */
    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0
    }

    .table th,
    .table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--grid);
      font-size: 14px;
      text-align: left
    }

    .table th {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .5px
    }

    /* æ’åº CSS */
    .table th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 20px;
      /* Space for arrow */
    }

    .table th.sortable::after {
      content: ' ';
      position: absolute;
      right: 8px;
      top: 50%;
      margin-top: -6px;
      /* (4+2) */
      border: 4px solid transparent;
      opacity: 0.3;
    }

    .table th[data-sort-dir="asc"]::after {
      border-bottom-color: var(--ink);
      opacity: 1;
    }

    .table th[data-sort-dir="desc"]::after {
      border-top-color: var(--ink);
      opacity: 1;
    }

    .table tr:nth-child(odd) td {
      background: linear-gradient(to right, rgba(0, 0, 0, 0.02), transparent)
    }

    .num {
      font-family: var(--mono);
      text-align: right
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--border)
    }

    .tag.floor {
      border-color: var(--ink)
    }

    .tag.adjusted {
      border-color: var(--info);
      color: var(--info)
    }

    .tag.blocked {
      border-color: var(--warn);
      color: var(--warn)
    }

    .kbd {
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg)
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast .item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 6px solid var(--ok);
      padding: 10px 12px;
      border-radius: 12px;
      min-width: 280px;
      box-shadow: var(--shadow)
    }

    .toast .item.error {
      border-left-color: var(--warn)
    }

    .toast .item.info {
      border-left-color: var(--info)
    }

    /* Skeleton */
    .skeleton {
      height: 12px;
      background: linear-gradient(90deg, #f0f3f7, #e6eaf0, #f0f3f7);
      background-size: 200% 100%;
      animation: shine 1.2s infinite
    }

    @keyframes shine {
      0% {
        background-position: 200% 0
      }

      100% {
        background-position: -200% 0
      }
    }

    /* Sparklines */
    .sparkline {
      width: 100%;
      height: 36px
    }

    /* ç‹€æ…‹ç‡ˆ */
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      vertical-align: middle;
      margin: 0 2px;
    }

    .status-idb {
      background: #16a34a
    }

    /* ç¶  */
    .status-ls {
      background: #f59e0b
    }

    /* é»ƒ */
    .status-off {
      background: #ef4444
    }

    /* ç´… */

    /* éš±è—é¡ */
    .hidden {
      display: none !important;
    }

    /* é—œéµæ•¸å­—æ¨£å¼ */
    .display-num {
      font-size: 1.5em;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    /* å°å­— */
    .small {
      font-size: 12px;
      color: var(--muted)
    }

    .right {
      text-align: right
    }

    /* å°è©±æ¡† */
    .dialog-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease-out;
      pointer-events: none;
    }

    .dialog-backdrop.show {
      opacity: 1;
      pointer-events: auto;
    }

    .dialog {
      background: #fff;
      border-radius: 16px;
      border: 1px solid var(--border);
      width: min(720px, 96vw);
      box-shadow: var(--shadow);
      transform: scale(0.9);
      transition: transform 0.3s ease-out;
    }

    .dialog-backdrop.show .dialog {
      transform: scale(1);
    }

    .dialog .hd {
      padding: 14px;
      border-bottom: 1px solid var(--border);
      font-weight: 700
    }

    .dialog .bd {
      padding: 14px;
      display: grid;
      gap: 12px
    }

    .dialog .ft {
      padding: 14px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end
    }

    /* å•†å“é¸æ“‡å™¨ */
    .product-selector {
      display: flex;
      gap: var(--spacing-xs);
      align-items: center;
    }

    .product-selector select {
      flex: 1;
    }

    .product-actions {
      display: flex;
      gap: 4px;
    }

    .btn-sm {
      padding: 6px 8px;
      font-size: 12px;
      min-width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-sm:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* å¯èšç„¦å€å¡Š */
    [tabindex="0"] {
      outline: none
    }

    [tabindex="0"]:focus {
      box-shadow: 0 0 0 3px rgba(47, 128, 237, .25);
      border-radius: 8px
    }
  </style>

</head>

<body>
  <div class="toast" id="toast"></div>
  <header class="appbar" role="banner" aria-label="é ‚éƒ¨å·¥å…·åˆ—">
    <div class="title">ğŸ“¦ é›¢ç·šé€²éŠ·èˆ‡åƒ¹æ ¼ä¸‹é™</div>
    <div class="search" role="search">
      <span class="small">å¿«é€Ÿæœå°‹</span>
      <input id="q" type="search" placeholder="è¼¸å…¥å•†å“ä»£ç¢¼æˆ–åç¨±ï¼ˆæŒ‰ / èšç„¦ï¼‰" aria-label="æœå°‹å•†å“" />
    </div>
    <div class="actions">
      <button class="btn secondary" id="btnAddPurchase" title="G æ–°å¢é€²è²¨">æ–°å¢é€²è²¨</button>
      <button class="btn" id="btnAddSale" title="S æ–°å¢éŠ·è²¨">æ–°å¢éŠ·è²¨</button>
      <button class="btn ghost" id="btnExport" title="E åŒ¯å‡º">åŒ¯å‡º</button>
      <button class="btn ghost" id="btnImport" title="I åŒ¯å…¥">åŒ¯å…¥</button>
      <button class="btn ghost" id="btnSettings">è¨­å®š</button>
    </div>
  </header>
  <div class="layout">
    <nav class="sidenav" aria-label="å´é‚Šå°èˆª">
      <div class="navlink active" data-tab="dashboard">Dashboard</div>
      <div class="navlink" data-tab="products">å•†å“</div>
      <div class="navlink" data-tab="purchases">é€²è²¨</div>
      <div class="navlink" data-tab="sales">éŠ·è²¨</div>
      <div class="navlink" data-tab="audits">ç•°å‹•ç´€éŒ„</div>
      <div class="navlink" data-tab="settings">è¨­å®š</div>
      <hr class="sep">
      <div class="small">å„²å­˜ç‹€æ…‹ï¼š
        <span class="status-dot status-idb" id="dotIDB" title="IndexedDB"></span>
        <span class="status-dot status-ls" id="dotLS" title="LocalStorage" style="display:none"></span>
        <span class="status-dot status-off" id="dotOFF" title="ä¸å¯ç”¨" style="display:none"></span>
      </div>
    </nav>
    <main class="main" id="view">
      <section class="card" data-panel="dashboard">
        <div class="hd">
          <div>ä»Šæ—¥æ¦‚è¦½</div>
          <div class="small">å¿«æ·éµï¼š<span class="kbd">/</span> æœå°‹ã€€<span class="kbd">G</span> æ–°å¢é€²è²¨ã€€<span
              class="kbd">S</span> æ–°å¢éŠ·è²¨</div>
        </div>
        <div class="bd">
          <div class="grid cols-3">
            <div class="card">
              <div class="hd">ä»Šæ—¥éŠ·è²¨</div>
              <div class="bd">
                <div>æ•¸é‡ <b><span id="todayQty" class="num">0</span></b></div>
                <div>é‡‘é¡ <b><span id="todayAmt" class="num">0.00</span></b></div>
                <div>æ¨å°å‡åƒ¹ <b>â‰ˆ <span id="todayAvg" class="num">0.00</span></b></div>
              </div>
            </div>
            <div class="card">
              <div class="hd">ç•°å¸¸æ‘˜è¦</div>
              <div class="bd">
                <div>ç„¡ floor å•†å“ï¼š<b><span id="noFloorCount" class="num">0</span></b></div>
                <div>é˜»æ“‹æ¬¡æ•¸ï¼š<b><span id="blockedCount" class="num">0</span></b></div>
                <div>è‡ªå‹•èª¿æ•´æ¬¡æ•¸ï¼š<b><span id="adjustedCount" class="num">0</span></b></div>
              </div>
            </div>
            <div class="card">
              <div class="hd">åº«å­˜å‘Šæ€¥ Top 5</div>
              <div class="bd">
                <table class="table" id="lowStockTable">
                  <thead>
                    <tr>
                      <th>ä»£ç¢¼</th>
                      <th>åç¨±</th>
                      <th class="right">åº«å­˜</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
          <hr class="sep">
          <div class="card">
            <div class="hd">è¿‘30æ—¥å‡åƒ¹è¶¨å‹¢</div>
            <div class="bd">
              <canvas id="spark" class="sparkline" aria-label="è¿‘30æ—¥å‡åƒ¹"></canvas>
            </div>
          </div>
        </div>
      </section>
      
      <section class="card" data-panel="products" hidden>
        <div class="hd">
          <div>å•†å“æ¸…å–®</div>
          <div class="inline">
            <button class="btn ghost" id="btnPasteProducts">æ‰¹æ¬¡è²¼ä¸Š</button>
            <button class="btn secondary" id="btnNewProduct">æ–°å¢å•†å“</button>
          </div>
        </div>
        <div class="bd">
          <table class="table" id="tblProducts" aria-label="å•†å“æ¸…å–®è¡¨">
            <thead>
              <tr>
                <th class="sortable" data-sort="code">ä»£ç¢¼</th>
                <th class="sortable" data-sort="name">åç¨±</th>
                <th class="sortable" data-sort="unit">å–®ä½</th>
                <th class="right sortable" data-sort="stock">åº«å­˜</th>
                <th class="right sortable" data-sort="floor">floor</th>
                <th class="right sortable" data-sort="avg30">è¿‘30æ—¥å‡åƒ¹</th>
                <th>å‹•ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card" data-panel="purchases" hidden>
        <div class="hd">
          <div>é€²è²¨ç´€éŒ„</div>
          <div class="inline">
            <button class="btn secondary" id="btnAddPurchase2">æ–°å¢é€²è²¨</button>
            <button class="btn ghost" id="btnPastePurchase">æ‰¹æ¬¡è²¼ä¸Š</button>
          </div>
        </div>
        <div class="bd">
          <table class="table" id="tblPurchases">
            <thead>
              <tr>
                <th class="sortable" data-sort="date">æ—¥æœŸ</th>
                <th class="sortable" data-sort="productName">å•†å“</th>
                <th class="right sortable" data-sort="qty">æ•¸é‡</th>
                <th class="right sortable" data-sort="unitCost">å–®åƒ¹</th>
                <th>å‹•ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card" data-panel="sales" hidden>
        <div class="hd">
          <div>éŠ·è²¨ç´€éŒ„</div>
          <div class="inline">
            <button class="btn ghost" id="btnPasteSales">æ‰¹æ¬¡è²¼ä¸Š</button>
            <button class="btn" id="btnAddSale2">æ–°å¢éŠ·è²¨</button>
          </div>
        </div>
        <div class="bd">
          <table class="table" id="tblSales">
            <thead>
              <tr>
                <th class="sortable" data-sort="date">æ—¥æœŸ</th>
                <th class="sortable" data-sort="productName">å•†å“</th>
                <th class="right sortable" data-sort="qty">æ•¸é‡</th>
                <th class="right sortable" data-sort="amount">é‡‘é¡</th>
                <th class="right sortable" data-sort="derivedPrice">æ¨å°å–®åƒ¹</th>
                <th class="sortable" data-sort="note">å‚™è¨»</th>
                <th class="sortable" data-sort="adjusted">ç‹€æ…‹</th>
                <th>å‹•ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card" data-panel="audits" hidden>
        <div class="hd">
          <div>ç•°å‹•ç´€éŒ„</div>
        </div>
        <div class="bd">
          <table class="table" id="tblAudits">
            <thead>
              <tr>
                <th class="sortable" data-sort="ts">æ™‚é–“</th>
                <th class="sortable" data-sort="productName">å•†å“</th>
                <th class="right sortable" data-sort="origAmount">åŸé‡‘é¡</th>
                <th class="right sortable" data-sort="newAmount">èª¿æ•´å¾Œ</th>
                <th class="right sortable" data-sort="usedFloor">usedFloor</th>
                <th class="sortable" data-sort="policy">ç­–ç•¥</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card" data-panel="settings" hidden>
        <div class="hd">
          <div>è¨­å®š</div>
        </div>
        <div class="bd">
          <div class="grid cols-2">
            <div class="card">
              <div class="hd">åƒ¹æ ¼èˆ‡åº«å­˜ç­–ç•¥</div>
              <div class="bd grid">
                <div class="field">
                  <label class="label">åƒ¹æ ¼ç­–ç•¥</label>
                  <select id="pricePolicy" aria-label="åƒ¹æ ¼ç­–ç•¥">
                    <option value="autoAdjust">è‡ªå‹•èª¿æ•´</option>
                    <option value="block">é˜»æ“‹</option>
                  </select>
                  <div class="helper">derivedPrice &lt; floor æ™‚ï¼šè‡ªå‹•èª¿æ•´ç‚º floorÃ—æ•¸é‡ï¼›æˆ–é˜»æ“‹</div>
                </div>
                <div class="field">
                  <label class="label">åº«å­˜ç®¡æ§</label>
                  <label><input type="checkbox" id="inventoryControl" checked /> å•Ÿç”¨ï¼ˆè¶…è³£æ™‚é˜»æ“‹ï¼‰</label>
                </div>
                <div class="field">
                  <label class="label">ä¸»é¡Œ</label>
                  <select id="themeSel">
                    <option value="luxe">æ¥µç°¡éœå¥¢ï¼ˆé è¨­ï¼‰</option>
                    <option value="industrial">å·¥æ¥­ç†æ€§</option>
                    <option value="editorial">ç¾ä»£æ›¸å ±</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="hd">è³‡æ–™ç¶­è­·</div>
              <div class="bd grid">
                <button class="btn ghost" id="btnClear">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
                <div class="small">æ­¤å‹•ä½œå°‡åˆªé™¤ IndexedDB / LocalStorage çš„æ‰€æœ‰è³‡æ–™ï¼ˆéœ€äºŒæ¬¡ç¢ºèªï¼‰ã€‚</div>
              </div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>
  
  <div class="dialog-backdrop" id="dlgProduct">
    <div class="dialog" role="dialog" aria-labelledby="dlgProductTitle">
      <div class="hd" id="dlgProductTitle">å•†å“</div>
      <div class="bd grid cols-2">
        <div class="field">
          <label class="label">å•†å“ä»£ç¢¼*</label>
          <input class="input" id="pCode" autocomplete="off" />
        </div>
        <div class="field">
          <label class="label">åç¨±*</label>
          <input class="input" id="pName" autocomplete="off" />
        </div>
        <div class="field">
          <label class="label">å–®ä½</label>
          <input class="input" id="pUnit" autocomplete="off" />
        </div>
      </div>
      <div class="ft">
        <button class="btn ghost" data-close="#dlgProduct">å–æ¶ˆ</button>
        <button class="btn" id="btnSaveProduct">å„²å­˜</button>
      </div>
    </div>
  </div>
  
  <div class="dialog-backdrop" id="dlgPurchase">
    <div class="dialog" role="dialog" aria-labelledby="dlgPurchaseTitle">
      <div class="hd" id="dlgPurchaseTitle">æ–°å¢é€²è²¨</div>
      <div class="bd grid cols-2">
        <div class="field">
          <label class="label">å•†å“*</label>
          <div class="product-selector">
            <select id="purProduct"></select>
            <div class="product-actions">
              <button type="button" class="btn ghost btn-sm" id="btnAddProduct" title="æ–°å¢å•†å“">+</button>
              <button type="button" class="btn ghost btn-sm" id="btnEditProduct" title="ç·¨è¼¯å•†å“" disabled>âœ</button>
              <button type="button" class="btn ghost btn-sm" id="btnDeleteProduct" title="åˆªé™¤å•†å“" disabled>Ã—</button>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label">æ•¸é‡*</label>
          <input class="input" id="purQty" type="number" step="0.001" min="0" />
        </div>
        <div class="field">
          <label class="label">å–®åƒ¹*</label>
          <input class="input" id="purCost" type="number" step="0.0001" min="0" />
        </div>
        <div class="field">
          <label class="label">æ—¥æœŸ</label>
          <input class="input" id="purDate" type="date" />
        </div>
        <div class="field" style="grid-column:1/-1">
          <label class="label">å‚™è¨»</label>
          <input class="input" id="purNote" />
        </div>
      </div>
      <div class="ft">
        <button class="btn ghost" data-close="#dlgPurchase">å–æ¶ˆ</button>
        <button class="btn" id="btnSavePurchase">å»ºç«‹</button>
      </div>
    </div>
  </div>
  
  <div class="dialog-backdrop" id="dlgSale">
    <div class="dialog" role="dialog" aria-labelledby="dlgSaleTitle">
      <div class="hd" id="dlgSaleTitle">æ–°å¢éŠ·è²¨</div>
      <div class="bd grid cols-2">
        <div class="field">
          <label class="label">å•†å“*</label>
          <div class="product-selector">
            <select id="saleProduct"></select>
            <div class="product-actions">
              <button type="button" class="btn ghost btn-sm" id="btnAddProductSale" title="æ–°å¢å•†å“">+</button>
              <button type="button" class="btn ghost btn-sm" id="btnEditProductSale" title="ç·¨è¼¯å•†å“" disabled>âœ</button>
              <button type="button" class="btn ghost btn-sm" id="btnDeleteProductSale" title="åˆªé™¤å•†å“" disabled>Ã—</button>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label">æ•¸é‡*</label>
          <input class="input" id="saleQty" type="number" step="0.001" min="0" inputmode="decimal" />
          <div class="helper">å¯å”®åº«å­˜ï¼š<span id="saleStock" class="num">0.000</span></div>
        </div>
        <div class="field">
          <label class="label">é‡‘é¡*</label>
          <input class="input" id="saleAmt" type="text" inputmode="decimal" />
          <div class="helper">æ¨å°å–®åƒ¹ â‰ˆ <span id="derived" class="num">0.00</span></div>
          <div class="helper warn" id="floorHint" hidden></div>
        </div>
        <div class="field">
          <label class="label">æ—¥æœŸ</label>
          <input class="input" id="saleDate" type="date" />
        </div>
        <div class="field" style="grid-column:1/-1">
          <label class="label">å‚™è¨»</label>
          <input class="input" id="saleNote" />
        </div>
      </div>
      <div class="ft">
        <button class="btn ghost" data-close="#dlgSale">å–æ¶ˆ</button>
        <button class="btn" id="btnSaveSale">å»ºç«‹</button>
      </div>
    </div>
  </div>
  
  <div class="dialog-backdrop" id="dlgPaste">
    <div class="dialog" role="dialog" aria-labelledby="dlgPasteTitle">
      <div class="hd" id="dlgPasteTitle">æ‰¹æ¬¡è²¼ä¸Šé€²è²¨ï¼ˆä»£ç¢¼,æ•¸é‡,å–®åƒ¹,æ—¥æœŸ?ï¼‰</div>
      <div class="bd">
        <textarea id="pasteArea" rows="8" class="input"
          placeholder="ä¾‹å¦‚ï¼š&#10;S-001, 10, 12.5, 2025-10-01&#10;S-002, 3, 99.9"></textarea>
        <div class="small">å°‡é€—è™Ÿåˆ†éš”è³‡æ–™è²¼ä¸Šï¼›æ—¥æœŸå¯çœç•¥ã€‚</div>
      </div>
      <div class="ft">
        <button class="btn ghost" data-close="#dlgPaste">å–æ¶ˆ</button>
        <button class="btn" id="btnDoPaste">å¯«å…¥</button>
      </div>
    </div>
  </div>
  
  <div class="dialog-backdrop" id="dlgPasteProducts">
    <div class="dialog" role="dialog" aria-labelledby="dlgPasteProductsTitle">
      <div class="hd" id="dlgPasteProductsTitle">æ‰¹æ¬¡è²¼ä¸Šå•†å“ï¼ˆä»£ç¢¼,åç¨±,å–®ä½?ï¼‰</div>
      <div class="bd">
        <textarea id="pasteAreaProducts" rows="8" class="input"
          placeholder="ä¾‹å¦‚ï¼š&#10;S-001, ç¯„ä¾‹å•†å“A, ä»¶&#10;S-002, ç¯„ä¾‹å•†å“B, å€‹&#10;S-003, ç¯„ä¾‹å•†å“C"></textarea>
        <div class="small">å°‡é€—è™Ÿåˆ†éš”è³‡æ–™è²¼ä¸Šï¼›å–®ä½å¯çœç•¥ã€‚ä»£ç¢¼è‹¥å·²å­˜åœ¨å‰‡æœƒæ›´æ–°åç¨±èˆ‡å–®ä½ã€‚</div>
      </div>
      <div class="ft">
        <button class="btn ghost" data-close="#dlgPasteProducts">å–æ¶ˆ</button>
        <button class="btn" id="btnDoPasteProducts">å¯«å…¥</button>
      </div>
    </div>
  </div>

  <div class="dialog-backdrop" id="dlgPasteSales">
    <div class="dialog" role="dialog" aria-labelledby="dlgPasteSalesTitle">
      <div class="hd" id="dlgPasteSalesTitle">æ‰¹æ¬¡è²¼ä¸ŠéŠ·è²¨ï¼ˆä»£ç¢¼,æ•¸é‡,é‡‘é¡,æ—¥æœŸ?ï¼‰</div>
      <div class="bd">
        <textarea id="pasteAreaSales" rows="8" class="input"
          placeholder="ä¾‹å¦‚ï¼š&#10;S-001, 2, 500, 2025-10-22&#10;S-002, 1, 199"></textarea>
        <div class="small">å°‡é€—è™Ÿåˆ†éš”è³‡æ–™è²¼ä¸Šï¼›æ—¥æœŸå¯çœç•¥ã€‚ç³»çµ±å°‡è‡ªå‹•æª¢æŸ¥åº«å­˜èˆ‡åƒ¹æ ¼ä¸‹é™ã€‚</div>
      </div>
      <div class="ft">
        <button class="btn ghost" data-close="#dlgPasteSales">å–æ¶ˆ</button>
        <button class="btn" id="btnDoPasteSales">å¯«å…¥</button>
      </div>
    </div>
  </div>
  
  <input type="file" id="fileInput" accept="application/json" hidden />
  <script>
    (function () {
      'use strict';

      /* ========== å¸¸é‡å®šç¾© ========== */
      const TOAST_DURATION = 3800;
      const STORES = {
        PRODUCTS: 'products',
        PURCHASES: 'purchases',
        SALES: 'sales',
        AUDITS: 'audits',
        SETTINGS: 'settings'
      };

      /* ========== æ•¸æ“šå¿«å– ========== */
      let cachedData = {
        products: [],
        purchases: [],
        sales: [],
        audits: [],
        settings: {},
        computed: new Map() // å­˜å„²è¨ˆç®—çµæœ
      };

      /* ========== æ’åºç‹€æ…‹ ========== */
      let sortState = {
        products: { key: 'code', dir: 'asc' },
        purchases: { key: 'date', dir: 'desc' },
        sales: { key: 'date', dir: 'desc' },
        audits: { key: 'ts', dir: 'desc' }
      };

      /* ========== å°å·¥å…· ========== */
      const $ = sel => document.querySelector(sel);
      const $$ = sel => document.querySelector(sel);
      const $$$ = sel => Array.from(document.querySelectorAll(sel));
      const toastBox = $$('#toast');

      // é˜²æŠ–å‡½æ•¸
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      function toast(msg, type = 'success') {
        const div = document.createElement('div');
        div.className = 'item ' + (type === 'error' ? 'error' : type === 'info' ? 'info' : '');
        div.textContent = msg;
        toastBox.appendChild(div);
        setTimeout(() => div.remove(), TOAST_DURATION);
      }
      function fmt2(n) { return Number(n || 0).toFixed(2) }
      function fmt3(n) { return Number(n || 0).toFixed(3) }
      function todayISO() { return new Date().toISOString().slice(0, 10) }
      function inLastDays(iso, days) {
        if (!iso) return false;
        const d = new Date(iso);
        const now = new Date();
        const diff = (now - d) / (1000 * 3600 * 24);
        return diff <= days;
      }
      function parseMoneyExpr(expr) {
        try {
          const safe = String(expr).replace(/[^0-9+*\-./()]/g, '');
          if (!safe) return NaN;
          return Number(new Function('return ' + safe)());
        } catch (e) { return NaN }
      }
      function round(n, d) { const f = Math.pow(10, d); return Math.round(n * f) / f }

      /* é€šç”¨æ’åºæ¯”è¼ƒå™¨ */
      function getSorter(key, dir) {
        const asc = dir === 'asc' ? 1 : -1;
        const numKeys = ['stock', 'floor', 'avg30', 'qty', 'unitCost', 'amount', 'derivedPrice', 'origAmount', 'newAmount', 'usedFloor'];
        const dateKeys = ['date', 'ts'];

        return (a, b) => {
          let valA = a[key];
          let valB = b[key];

          if (numKeys.includes(key)) {
            valA = Number(valA || 0);
            valB = Number(valB || 0);
          } else if (dateKeys.includes(key)) {
            valA = valA || '';
            valB = valB || '';
          } else { // string
            valA = String(valA || '').toLowerCase();
            valB = String(valB || '').toLowerCase();
          }

          if (valA < valB) return -1 * asc;
          if (valA > valB) return 1 * asc;
          return 0;
        };
      }
      
      /* æ›´æ–°æ’åºç®­é ­ UI */
      function updateSortIndicators() {
        for (const tableKey of ['products', 'purchases', 'sales', 'audits']) {
          const state = sortState[tableKey];
          const table = $$(`#tbl${tableKey.charAt(0).toUpperCase() + tableKey.slice(1)}`);
          if (!table) continue;
          
          table.querySelectorAll('thead th').forEach(th => th.removeAttribute('data-sort-dir'));
          const activeTh = table.querySelector(`thead th[data-sort="${state.key}"]`);
          if (activeTh) {
            activeTh.setAttribute('data-sort-dir', state.dir);
          }
        }
      }

      /* ========== å„²å­˜å±¤ï¼šIndexedDB èˆ‡ LocalStorage é™ç´š ========== */
      const DB_NAME = 'offline-floor-pos';
      const DB_VER = 1;
      let useLocal = false;

      function idbOpen() {
        return new Promise((resolve) => {
          if (!('indexedDB' in window)) { useLocal = true; updateDots(); return resolve(null) }
          const req = indexedDB.open(DB_NAME, DB_VER);
          req.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORES.PRODUCTS)) {
              const s = db.createObjectStore(STORES.PRODUCTS, { keyPath: 'id', autoIncrement: true });
              s.createIndex('code', 'code', { unique: true });
            }
            if (!db.objectStoreNames.contains(STORES.PURCHASES)) {
              const s = db.createObjectStore(STORES.PURCHASES, { keyPath: 'id', autoIncrement: true });
              s.createIndex('productId', 'productId');
            }
            if (!db.objectStoreNames.contains(STORES.SALES)) {
              const s = db.createObjectStore(STORES.SALES, { keyPath: 'id', autoIncrement: true });
              s.createIndex('productId', 'productId');
            }
            if (!db.objectStoreNames.contains(STORES.AUDITS)) {
              db.createObjectStore(STORES.AUDITS, { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains(STORES.SETTINGS)) {
              db.createObjectStore(STORES.SETTINGS, { keyPath: 'key' });
            }
          };
          req.onsuccess = e => resolve(e.target.result);
          req.onerror = () => { useLocal = true; updateDots(); resolve(null) };
        });
      }

      function updateDots() {
        $$('#dotIDB').style.display = useLocal ? 'none' : 'inline-block';
        $$('#dotLS').style.display = useLocal ? 'inline-block' : 'none';
        $$('#dotOFF').style.display = 'none';
      }

      let db = null;
      const LS = {
        get: (k) => JSON.parse(localStorage.getItem(k) || 'null'),
        set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
        del: (k) => localStorage.removeItem(k)
      };

      async function getAll(store) {
        if (useLocal) {
          return LS.get(store) || [];
        }
        return new Promise((resolve, reject) => {
          const tx = db.transaction(store, 'readonly');
          const st = tx.objectStore(store);
          const req = st.getAll();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        });
      }
      async function add(store, value) {
        if (useLocal) {
          const arr = LS.get(store) || [];
          value.id = (arr.at(-1)?.id || 0) + 1;
          arr.push(value);
          LS.set(store, arr);
          return value.id;
        }
        return new Promise((resolve, reject) => {
          const tx = db.transaction(store, 'readwrite');
          const st = tx.objectStore(store);
          const req = st.add(value);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }
      async function put(store, value) {
        if (useLocal) {
          const arr = LS.get(store) || [];
          const idx = arr.findIndex(x => x.id === value.id);
          if (idx >= 0) arr[idx] = value; else arr.push(value);
          LS.set(store, arr);
          return value.id;
        }
        return new Promise((resolve, reject) => {
          const tx = db.transaction(store, 'readwrite');
          const st = tx.objectStore(store);
          const req = st.put(value);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }
      
      /* åˆªé™¤å–®ç­†ç´€éŒ„ */
      async function deleteRecord(store, id) {
        if (useLocal) {
          const arr = LS.get(store) || [];
          const filtered = arr.filter(x => x.id !== id);
          LS.set(store, filtered);
          return;
        }
        return new Promise((resolve, reject) => {
          const tx = db.transaction(store, 'readwrite');
          const st = tx.objectStore(store);
          const req = st.delete(id);
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }
      
      async function clearAll() {
        if (useLocal) {
          Object.values(STORES).forEach(k => LS.del(k));
          return;
        }
        await Promise.all(Object.values(STORES).map(store => new Promise((resolve, reject) => {
          const tx = db.transaction(store, 'readwrite');
          const st = tx.objectStore(store);
          const req = st.clear();
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        })));
      }

      /* ========== å•†æ¥­é‚è¼¯ ========== */
      async function listProducts() { return await getAll(STORES.PRODUCTS) }
      async function listPurchases() { return await getAll(STORES.PURCHASES) }
      async function listSales() { return await getAll(STORES.SALES) }
      async function listAudits() { return await getAll(STORES.AUDITS) }
      async function getSettings() {
        if (useLocal) {
          const s = LS.get('settings') || [];
          const map = Object.fromEntries(s.map(x => [x.key, x.value]));
          return { inventoryControl: map.inventoryControl ?? true, priceFloorPolicy: map.priceFloorPolicy ?? 'autoAdjust', theme: map.theme ?? 'luxe' };
        } else {
          return new Promise((resolve, reject) => {
            const tx = db.transaction('settings', 'readonly');
            const st = tx.objectStore('settings');
            const req = st.getAll();
            req.onsuccess = () => {
              const map = Object.fromEntries((req.result || []).map(x => [x.key, x.value]));
              resolve({ inventoryControl: map.inventoryControl ?? true, priceFloorPolicy: map.priceFloorPolicy ?? 'autoAdjust', theme: map.theme ?? 'luxe' });
            };
            req.onerror = () => reject(req.error);
          });
        }
      }
      async function setSetting(key, value) {
        if (useLocal) {
          const arr = LS.get('settings') || [];
          const idx = arr.findIndex(x => x.key === key);
          if (idx >= 0) arr[idx].value = value; else arr.push({ key, value });
          LS.set('settings', arr);
        } else {
          await put('settings', { key, value });
        }
      }

      function calcFloor(purchases, productId) {
        const list = purchases.filter(p => p.productId === productId && Number(p.unitCost) > 0);
        if (list.length === 0) return null;
        return Math.min(...list.map(p => Number(p.unitCost)));
      }
      function calcStock(purchases, sales, productId) {
        const inQty = purchases.filter(p => p.productId === productId).reduce((a, b) => a + Number(b.qty || 0), 0);
        const outQty = sales.filter(s => s.productId === productId).reduce((a, b) => a + Number(b.qty || 0), 0);
        return round(inQty - outQty, 3);
      }
      function avgDerivedLast30(sales, productId) {
        const now30 = sales.filter(s => s.productId === productId && inLastDays(s.date || todayISO(), 30));
        if (now30.length === 0) return 0;
        const sum = now30.reduce((a, b) => a + Number(b.derivedPrice || 0), 0);
        return round(sum / now30.length, 2);
      }

      async function upsertProductByCode(code, name, unit) {
        const products = await listProducts();
        const found = products.find(p => p.code === code);
        if (found) {
          found.name = name || found.name;
          found.unit = unit || found.unit;
          await put(STORES.PRODUCTS, found);
          return found.id;
        } else {
          return await add(STORES.PRODUCTS, { code, name, unit });
        }
      }

      async function deleteProduct(productId) {
        if (useLocal) {
          const products = LS.get(STORES.PRODUCTS) || [];
          const filtered = products.filter(p => p.id !== productId);
          LS.set(STORES.PRODUCTS, filtered);
        } else {
          return new Promise((resolve, reject) => {
            const tx = db.transaction(STORES.PRODUCTS, 'readwrite');
            const store = tx.objectStore(STORES.PRODUCTS);
            const req = store.delete(productId);
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
          });
        }
      }

      /* æ”¹ç‚ºåŒæ­¥ï¼Œä¾è³´å¿«å– */
      function ensureProductOptions() {
        const products = cachedData.products; // Use cache
        const opts = products.map(p => `<option value="${p.id}">${p.code}ï½œ${p.name}</option>`).join('');
        $$('#purProduct').innerHTML = `<option value="">â€” é¸æ“‡å•†å“ â€”</option>${opts}`;
        $$('#saleProduct').innerHTML = `<option value="">â€” é¸æ“‡å•†å“ â€”</option>${opts}`;

        updateProductActions('#purProduct', '#btnEditProduct', '#btnDeleteProduct');
        updateProductActions('#saleProduct', '#btnEditProductSale', '#btnDeleteProductSale');
      }

      function setTheme(theme) {
        document.documentElement.classList.remove('theme-industrial', 'theme-editorial');
        if (theme === 'industrial') document.documentElement.classList.add('theme-industrial');
        if (theme === 'editorial') document.documentElement.classList.add('theme-editorial');
      }

      /* ========== UI ç¶å®š ========== */
      function switchTab(name) {
        $$$('.navlink').forEach(n => n.classList.toggle('active', n.dataset.tab === name));
        $$$('[data-panel]').forEach(p => p.hidden = (p.dataset.panel !== name));
      }
      $$$('.navlink').forEach(n => n.addEventListener('click', () => switchTab(n.dataset.tab)));

      /* å°è©±æ¡†é–‹é—œ */
      function openDlg(sel) {
        const dlg = $$(sel);
        dlg.style.display = 'flex';
        requestAnimationFrame(() => dlg.classList.add('show'));
      }

      function closeDlg(sel) {
        const dlg = $$(sel);
        dlg.classList.remove('show');
        setTimeout(() => {
          if (!dlg.classList.contains('show')) {
            dlg.style.display = 'none';
          }
        }, 300);
      }
      $$$('[data-close]').forEach(b => b.addEventListener('click', () => closeDlg(b.getAttribute('data-close'))));

      /* å¿«æ·éµ */
      document.addEventListener('keydown', (e) => {
        if (e.key === '/') { e.preventDefault(); $$('#q').focus(); }
        if (e.key === 'g' || e.key === 'G') { e.preventDefault(); openPurchase() }
        if (e.key === 's' || e.key === 'S') { e.preventDefault(); openSale() }
        if (e.key === 'e' || e.key === 'E') { e.preventDefault(); doExport() }
        if (e.key === 'i' || e.key === 'I') { e.preventDefault(); $$('#btnImport').click() }
      });

      /* æœå°‹æ¡† */
      $$('#q')?.addEventListener?.('input', renderProducts); 

      /* äº‹ä»¶ç¶å®šï¼šAppBar */
      $$('#btnAddPurchase')?.addEventListener('click', openPurchase);
      $$('#btnAddPurchase2')?.addEventListener('click', openPurchase);
      $$('#btnPastePurchase')?.addEventListener('click', () => openDlg('#dlgPaste'));
      $$('#btnAddSale')?.addEventListener('click', openSale);
      $$('#btnAddSale2')?.addEventListener('click', openSale);
      $$('#btnPasteSales')?.addEventListener('click', () => { $$('#pasteAreaSales').value = ''; openDlg('#dlgPasteSales'); }); // [æ–°å¢]
      $$('#btnExport')?.addEventListener('click', doExport);
      $$('#btnImport')?.addEventListener('click', () => $$('#fileInput').click());
      $$('#btnSettings')?.addEventListener('click', () => switchTab('settings'));

      /* è¨­å®š */
      $$('#pricePolicy')?.addEventListener('change', async (e) => { await setSetting('priceFloorPolicy', e.target.value); cachedData.settings.priceFloorPolicy = e.target.value; toast('å·²åˆ‡æ›åƒ¹æ ¼ç­–ç•¥ç‚ºï¼š' + (e.target.value === 'autoAdjust' ? 'è‡ªå‹•èª¿æ•´' : 'é˜»æ“‹'), 'info') });
      $$('#inventoryControl')?.addEventListener('change', async (e) => { await setSetting('inventoryControl', e.target.checked); cachedData.settings.inventoryControl = e.target.checked; toast('åº«å­˜ç®¡æ§ï¼š' + (e.target.checked ? 'å•Ÿç”¨' : 'åœç”¨'), 'info') });
      $$('#themeSel')?.addEventListener('change', async (e) => { await setSetting('theme', e.target.value); setTheme(e.target.value); });

      $$('#btnClear')?.addEventListener('click', async () => {
        if (confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰æœ¬æ©Ÿè³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
          await clearAll();
          toast('å·²æ¸…é™¤æœ¬æ©Ÿè³‡æ–™');
          await refreshAll();
        }
      });

      /* å•†å“å°è©±æ¡† */
      $$('#btnNewProduct')?.addEventListener('click', () => {
        $$('#pCode').value = ''; $$('#pName').value = ''; $$('#pUnit').value = '';
        $$('#dlgProductTitle').textContent = 'æ–°å¢å•†å“';
        openDlg('#dlgProduct');
      });
      $$('#btnPasteProducts')?.addEventListener('click', () => {
        $$('#pasteAreaProducts').value = '';
        openDlg('#dlgPasteProducts');
      });

      $$('#btnSaveProduct')?.addEventListener('click', async () => {
        const code = $$('#pCode').value.trim();
        const name = $$('#pName').value.trim();
        if (!code || !name) { toast('è«‹å¡«å¯«ä»£ç¢¼èˆ‡åç¨±', 'error'); return }
        await upsertProductByCode(code, name, $$('#pUnit').value.trim());
        await refreshAll();
        closeDlg('#dlgProduct'); toast('å•†å“å·²å„²å­˜');
      });

      /* é€²è²¨ */
      function openPurchase() {
        ensureProductOptions();
        $$('#purQty').value = '';
        $$('#purCost').value = '';
        $$('#purDate').value = todayISO();
        $$('#purNote').value = '';
        
        $$('#dlgPurchaseTitle').textContent = 'æ–°å¢é€²è²¨';
        $$('#btnSavePurchase').textContent = 'å»ºç«‹';
        delete $$('#dlgPurchase').dataset.editingId;
        
        openDlg('#dlgPurchase');
      }

      // å•†å“é¸æ“‡å™¨é‚è¼¯
      function updateProductActions(selectId, editBtnId, deleteBtnId) {
        const select = $$(selectId);
        const editBtn = $$(editBtnId);
        const deleteBtn = $$(deleteBtnId);

        if (select && editBtn && deleteBtn) {
          const hasSelection = select.value && select.value !== '';
          editBtn.disabled = !hasSelection;
          deleteBtn.disabled = !hasSelection;
        }
      }

      // é€²è²¨å•†å“é¸æ“‡å™¨äº‹ä»¶
      $$('#purProduct')?.addEventListener('change', () => {
        updateProductActions('#purProduct', '#btnEditProduct', '#btnDeleteProduct');
      });

      // éŠ·è²¨å•†å“é¸æ“‡å™¨äº‹ä»¶  
      $$('#saleProduct')?.addEventListener('change', () => {
        updateProductActions('#saleProduct', '#btnEditProductSale', '#btnDeleteProductSale');
      });

      // æ–°å¢å•†å“æŒ‰éˆ• (é€²è²¨)
      $$('#btnAddProduct')?.addEventListener('click', () => {
        $$('#pCode').value = '';
        $$('#pName').value = '';
        $$('#pUnit').value = '';
        $$('#dlgProductTitle').textContent = 'æ–°å¢å•†å“';
        openDlg('#dlgProduct');
      });

      // æ–°å¢å•†å“æŒ‰éˆ• (éŠ·è²¨)
      $$('#btnAddProductSale')?.addEventListener('click', () => {
        $$('#pCode').value = '';
        $$('#pName').value = '';
        $$('#pUnit').value = '';
        $$('#dlgProductTitle').textContent = 'æ–°å¢å•†å“';
        openDlg('#dlgProduct');
      });

      // ç·¨è¼¯å•†å“æŒ‰éˆ• (é€²è²¨)
      $$('#btnEditProduct')?.addEventListener('click', async () => {
        const pid = Number($$('#purProduct').value);
        if (!pid) return;
        const product = cachedData.products.find(p => p.id === pid);
        if (!product) return;

        $$('#pCode').value = product.code;
        $$('#pName').value = product.name;
        $$('#pUnit').value = product.unit || '';
        $$('#dlgProductTitle').textContent = 'ç·¨è¼¯å•†å“';
        openDlg('#dlgProduct');
      });

      // ç·¨è¼¯å•†å“æŒ‰éˆ• (éŠ·è²¨)
      $$('#btnEditProductSale')?.addEventListener('click', async () => {
        const pid = Number($$('#saleProduct').value);
        if (!pid) return;
        const product = cachedData.products.find(p => p.id === pid);
        if (!product) return;

        $$('#pCode').value = product.code;
        $$('#pName').value = product.name;
        $$('#pUnit').value = product.unit || '';
        $$('#dlgProductTitle').textContent = 'ç·¨è¼¯å•†å“';
        openDlg('#dlgProduct');
      });

      // åˆªé™¤å•†å“æŒ‰éˆ• (é€²è²¨)
      $$('#btnDeleteProduct')?.addEventListener('click', async () => {
        const pid = Number($$('#purProduct').value);
        if (!pid) return;
        const product = cachedData.products.find(p => p.id === pid);
        if (!product) return;

        if (confirm(`ç¢ºå®šè¦åˆªé™¤å•†å“ã€Œ${product.code} - ${product.name}ã€å—ï¼Ÿ\næ³¨æ„ï¼šç›¸é—œçš„é€²è²¨å’ŒéŠ·è²¨è¨˜éŒ„å°‡ä¿ç•™ï¼Œä½†å•†å“è³‡è¨Šå°‡ç„¡æ³•é¡¯ç¤ºã€‚`)) {
          await deleteProduct(pid);
          await refreshAll();
          toast(`å·²åˆªé™¤å•†å“ï¼š${product.code}`);
        }
      });

      // åˆªé™¤å•†å“æŒ‰éˆ• (éŠ·è²¨)
      $$('#btnDeleteProductSale')?.addEventListener('click', async () => {
        const pid = Number($$('#saleProduct').value);
        if (!pid) return;
        const product = cachedData.products.find(p => p.id === pid);
        if (!product) return;

        if (confirm(`ç¢ºå®šè¦åˆªé™¤å•†å“ã€Œ${product.code} - ${product.name}ã€å—ï¼Ÿ\næ³¨æ„ï¼šç›¸é—œçš„é€²è²¨å’ŒéŠ·è²¨è¨˜éŒ„å°‡ä¿ç•™ï¼Œä½†å•†å“è³‡è¨Šå°‡ç„¡æ³•é¡¯ç¤ºã€‚`)) {
          await deleteProduct(pid);
          await refreshAll();
          toast(`å·²åˆªé™¤å•†å“ï¼š${product.code}`);
        }
      });
      
      $$('#btnSavePurchase')?.addEventListener('click', async () => {
        const editingId = Number($$('#dlgPurchase').dataset.editingId) || null;
        const pid = Number($$('#purProduct').value);
        const qty = Number($$('#purQty').value);
        const cost = Number($$('#purCost').value);
        const date = $$('#purDate').value || todayISO();
        const note = $$('#purNote').value || '';

        if (!pid || qty <= 0 || cost <= 0) { toast('å•†å“ã€æ•¸é‡èˆ‡å–®åƒ¹å¿…å¡«ä¸”éœ€å¤§æ–¼0', 'error'); return }

        const payload = { 
          productId: pid, 
          qty: round(qty, 3), 
          unitCost: round(cost, 4), 
          date, 
          note
        };

        if (editingId) {
          payload.id = editingId;
          await put(STORES.PURCHASES, payload);
          toast('å·²æ›´æ–°é€²è²¨');
        } else {
          await add(STORES.PURCHASES, payload);
          toast('å·²æ–°å¢é€²è²¨');
        }
        
        delete $$('#dlgPurchase').dataset.editingId;
        closeDlg('#dlgPurchase');
        await refreshAll();
      });

      /* æ‰¹æ¬¡è²¼ä¸Š - é€²è²¨ */
      $$('#btnDoPaste')?.addEventListener('click', async () => {
        const t = $$('#pasteArea').value.trim();
        if (!t) { closeDlg('#dlgPaste'); return }
        const lines = t.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        const products = await listProducts(); // ä¿æŒ await
        let ok = 0, fail = 0;
        for (const line of lines) {
          const [code, qtyS, costS, dateS] = line.split(',').map(s => s.trim());
          const p = products.find(x => x.code === code);
          const qty = Number(qtyS);
          const cost = parseMoneyExpr(costS); // [å„ªåŒ–] ä½¿ç”¨ parseMoneyExpr
          
          if (!p || !(qty > 0) || !(cost > 0) || !isFinite(cost)) { 
            fail++; 
            continue;
          }
          
          const date = dateS || todayISO();
          await add('purchases', { productId: p.id, qty: round(qty, 3), unitCost: round(cost, 4), date });
          ok++;
        }
        toast(`æ‰¹æ¬¡å®Œæˆï¼šæˆåŠŸ ${ok} ç­†ï¼Œå¤±æ•— ${fail} ç­†`, fail ? 'info' : 'success');
        $$('#pasteArea').value = '';
        closeDlg('#dlgPaste');
        await refreshAll();
      });

      /* æ‰¹æ¬¡è²¼ä¸Š - å•†å“ */
      $$('#btnDoPasteProducts')?.addEventListener('click', async () => {
        const t = $$('#pasteAreaProducts').value.trim();
        if (!t) { closeDlg('#dlgPasteProducts'); return }
        const lines = t.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        let ok = 0, fail = 0;
        for (const line of lines) {
          const [code, name, unit] = line.split(',').map(s => s.trim());
          if (!code || !name) {
            fail++;
            continue;
          }
          try {
            await upsertProductByCode(code, name, unit || '');
            ok++;
          } catch (e) {
            console.error('Batch product add error:', e);
            fail++;
          }
        }
        toast(`æ‰¹æ¬¡æ–°å¢å•†å“ï¼šæˆåŠŸ ${ok} ç­†ï¼Œå¤±æ•— ${fail} ç­†`, fail ? 'info' : 'success');
        $$('#pasteAreaProducts').value = '';
        closeDlg('#dlgPasteProducts');
        await refreshAll();
      });

      /* [æ–°å¢] æ‰¹æ¬¡è²¼ä¸Š - éŠ·è²¨ */
      $$('#btnDoPasteSales')?.addEventListener('click', async () => {
        const t = $$('#pasteAreaSales').value.trim();
        if (!t) { closeDlg('#dlgPasteSales'); return }

        const lines = t.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        const settings = cachedData.settings;
        
        // å»ºç«‹ä¸€å€‹æš«æ™‚çš„åº«å­˜ mapï¼Œä»¥ä¾¿åœ¨è¿´åœˆä¸­å³æ™‚æ›´æ–°
        const tempStock = new Map();
        for (const p of cachedData.products) {
          tempStock.set(p.id, cachedData.computed.get(p.id)?.stock ?? 0);
        }

        let ok = 0, fail = 0;
        const auditLogs = [];
        const salesToAdd = [];

        for (const line of lines) {
          const [code, qtyS, amtS, dateS] = line.split(',').map(s => s.trim());
          
          const p = cachedData.products.find(x => x.code === code);
          const qty = Number(qtyS);
          let amount = parseMoneyExpr(amtS); // ä½¿ç”¨ parseMoneyExpr

          // --- 1. åŸºæœ¬é©—è­‰ ---
          if (!p || !(qty > 0) || !(amount > 0) || !isFinite(amount)) {
            fail++;
            continue;
          }

          const pid = p.id;
          const floor = cachedData.computed.get(pid)?.floor;

          // --- 2. æª¢æŸ¥ Floor æ˜¯å¦å­˜åœ¨ ---
          if (floor == null) {
            fail++; // å°šç„¡é€²è²¨æˆæœ¬
            continue;
          }

          const currentStock = tempStock.get(pid) ?? 0;
          const date = dateS || todayISO();
          let adjusted = false;
          const origAmount = amount;

          // --- 3. åº«å­˜ç®¡æ§ ---
          if (settings.inventoryControl) {
            if (qty > currentStock) {
              auditLogs.push({
                ts: new Date().toISOString(),
                productId: pid,
                origAmount: round(origAmount, 2),
                newAmount: round(origAmount, 2),
                usedFloor: round(floor, 4),
                policy: 'inventoryBlock'
              });
              fail++;
              continue; // åº«å­˜ä¸è¶³ï¼Œè·³éæ­¤è¡Œ
            }
          }

          // --- 4. åƒ¹æ ¼ä¸‹é™ç®¡æ§ ---
          const derived = round(amount / qty, 4);
          if (derived < floor) {
            if (settings.priceFloorPolicy === 'autoAdjust') {
              const minAmt = round(floor * qty, 2);
              amount = minAmt;
              adjusted = true;
              auditLogs.push({
                ts: new Date().toISOString(),
                productId: pid,
                origAmount: round(origAmount, 2),
                newAmount: round(amount, 2),
                usedFloor: round(floor, 4),
                policy: 'autoAdjust'
              });
            } else { // 'block'
              auditLogs.push({
                ts: new Date().toISOString(),
                productId: pid,
                origAmount: round(origAmount, 2),
                newAmount: round(origAmount, 2),
                usedFloor: round(floor, 4),
                policy: 'block'
              });
              fail++;
              continue; // ä½æ–¼ä¸‹é™ä¸”ç­–ç•¥ç‚ºé˜»æ“‹
            }
          }

          // --- 5. æº–å‚™å¯«å…¥ ---
          const finalDerived = round(amount / qty, 4);
          const sale = { 
            productId: pid, 
            qty: round(qty, 3), 
            amount: round(amount, 2), 
            derivedPrice: finalDerived, 
            usedFloor: round(floor, 4), 
            adjusted, 
            date, 
            note: 'æ‰¹æ¬¡åŒ¯å…¥'
          };
          
          salesToAdd.push(sale);
          tempStock.set(pid, currentStock - qty); // æ‰£é™¤æš«æ™‚åº«å­˜
          ok++;
        } // end for loop

        // --- 6. åŸ·è¡Œè³‡æ–™åº«å¯«å…¥ ---
        for (const log of auditLogs) {
          await add(STORES.AUDITS, log);
        }
        for (const sale of salesToAdd) {
          await add(STORES.SALES, sale);
        }
        
        toast(`æ‰¹æ¬¡éŠ·è²¨å®Œæˆï¼šæˆåŠŸ ${ok} ç­†ï¼Œå¤±æ•— ${fail} ç­†`, fail ? 'info' : 'success');
        $$('#pasteAreaSales').value = ''; // æ¸…ç©º
        closeDlg('#dlgPasteSales');
        await refreshAll(); // é‡æ–°æ•´ç†æ‰€æœ‰è³‡æ–™
      });

      /* éŠ·è²¨ */
      function openSale() {
        ensureProductOptions();
        $$('#saleQty').value = ''; 
        $$('#saleAmt').value = ''; 
        $$('#saleDate').value = todayISO(); 
        $$('#saleNote').value = ''; 
        $$('#derived').textContent = '0.00';
        $$('#floorHint').hidden = true; 
        $$('#saleStock').textContent = '0.000';
        $$('#saleProduct').value = '';

        $$('#dlgSaleTitle').textContent = 'æ–°å¢éŠ·è²¨';
        $$('#btnSaveSale').textContent = 'å»ºç«‹';
        delete $$('#dlgSale').dataset.editingId;

        openDlg('#dlgSale');
      }
      
      $$('#saleProduct')?.addEventListener('change', (e) => { 
        const pid = Number(e.target.value);
        const stock = cachedData.computed.get(pid)?.stock ?? 0;
        $$('#saleStock').textContent = fmt3(stock);
        updateDerivedHelper();
      });
      
      const debouncedUpdateHelper = debounce(updateDerivedHelper, 300);
      $$('#saleQty')?.addEventListener('input', debouncedUpdateHelper);
      $$('#saleAmt')?.addEventListener('input', debouncedUpdateHelper);

      function updateDerivedHelper() {
        const pid = Number($$('#saleProduct').value);
        const qty = Number($$('#saleQty').value);
        const amtExpr = $$('#saleAmt').value;
        const amount = parseMoneyExpr(amtExpr);
        
        const computed = cachedData.computed.get(pid);
        const floor = computed ? computed.floor : null;
        const derived = (qty > 0 && amount > 0) ? round(amount / qty, 4) : 0;
        $$('#derived').textContent = fmt2(derived);
        const policy = cachedData.settings.priceFloorPolicy || 'autoAdjust';
        
        if (pid && floor != null && qty > 0 && derived < floor) {
          const minAmt = round(floor * qty, 2);
          $$('#floorHint').hidden = false;
          $$('#floorHint').textContent = policy === 'autoAdjust'
            ? `ä½æ–¼ä¸‹é™ï¼Œæäº¤æ™‚ç³»çµ±å°‡è‡ªå‹•æ›´æ­£é‡‘é¡ç‚º $${fmt2(minAmt)}ï¼ˆfloorÃ—æ•¸é‡ï¼‰`
            : `ä½æ–¼ä¸‹é™ï¼Œæœ€ä½å¯æ¥å—é‡‘é¡ç‚º $${fmt2(minAmt)}ï¼ˆfloorÃ—æ•¸é‡ï¼‰`;
        } else {
          $$('#floorHint').hidden = true;
        }
      }

      $$('#btnSaveSale')?.addEventListener('click', async () => {
        const editingId = Number($$('#dlgSale').dataset.editingId) || null;
        
        const pid = Number($$('#saleProduct').value);
        const qty = Number($$('#saleQty').value);
        const amtExpr = $$('#saleAmt').value;
        let amount = parseMoneyExpr(amtExpr);
        const date = $$('#saleDate').value || todayISO();
        const note = $$('#saleNote').value || '';
        
        if (!pid) { toast('è«‹é¸æ“‡å•†å“', 'error'); return }
        if (!(qty > 0) || !(amount > 0) || !isFinite(amount)) { toast('æ•¸é‡èˆ‡é‡‘é¡éœ€å¤§æ–¼0', 'error'); return }

        const floor = cachedData.computed.get(pid)?.floor;
        if (floor == null) { toast('å°šç„¡é€²è²¨æˆæœ¬ï¼Œç„¡æ³•éŠ·è²¨', 'error'); closeDlg('#dlgSale'); switchTab('purchases'); return }
        
        const settings = cachedData.settings;
        const derived = round(amount / qty, 4);
        let adjusted = false, origAmount = amount;
        const minAmt = round(floor * qty, 2);

        if (settings.inventoryControl && !editingId) { 
          const stock = cachedData.computed.get(pid)?.stock ?? 0;
          if (qty > stock) {
            await add('audits', {
              ts: new Date().toISOString(),
              productId: pid,
              origAmount: round(origAmount, 2),
              newAmount: round(origAmount, 2),
              usedFloor: round(floor ?? 0, 4),
              policy: 'inventoryBlock'
            });
            toast(`å¯å”®åº«å­˜åƒ…å‰© ${fmt3(stock)}ï¼Œä»å·® ${fmt3(qty - stock)}`, 'error');
            return;
          }
        }

        if (derived < floor) {
          if (settings.priceFloorPolicy === 'autoAdjust') {
            amount = minAmt; adjusted = true;
          } else {
            await add('audits', {
              ts: new Date().toISOString(),
              productId: pid,
              origAmount: round(origAmount, 2),
              newAmount: round(origAmount, 2),
              usedFloor: round(floor, 4),
              policy: 'block'
            });
            toast(`ä½æ–¼æœ€ä½é€²è²¨æˆæœ¬ï¼Œè«‹è‡³å°‘è¼¸å…¥ $${fmt2(minAmt)}`, 'error');
            return;
          }
        }

        const finalDerived = round(amount / qty, 4);
        const sale = { 
          productId: pid, 
          qty: round(qty, 3), 
          amount: round(amount, 2), 
          derivedPrice: finalDerived, 
          usedFloor: round(floor, 4), 
          adjusted, 
          date, 
          note 
        };

        if (editingId) {
          sale.id = editingId;
          await put(STORES.SALES, sale);
          toast(`å·²æ›´æ–°éŠ·è²¨ã€‚`);
        } else {
          await add(STORES.SALES, sale);
          toast(`å·²å»ºç«‹éŠ·è²¨ã€‚`);
        }

        if (adjusted) {
          await add('audits', {
            ts: new Date().toISOString(),
            productId: pid,
            origAmount: round(origAmount, 2),
            newAmount: round(amount, 2),
            usedFloor: round(floor, 4),
            policy: 'autoAdjust'
          });
        }
        
        delete $$('#dlgSale').dataset.editingId;
        closeDlg('#dlgSale');
        await refreshAll();
      });

      /* åŒ¯å‡º / åŒ¯å…¥ */
      async function doExport() {
        const payload = {
          version: 1,
          schema: 'products,purchases,sales,audits,settings',
          exportedAt: new Date().toISOString(),
          data: {
            products: await listProducts(),
            purchases: await listPurchases(),
            sales: await listSales(),
            audits: await listAudits(),
            settings: useLocal ? (LS.get('settings') || []) : await new Promise((resolve) => {
              const tx = db.transaction('settings', 'readonly'); const st = tx.objectStore('settings'); const req = st.getAll(); req.onsuccess = () => resolve(req.result || []); req.onerror = () => resolve([]);
            })
          }
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `floor-pos-export-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
      $$('#fileInput')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const json = JSON.parse(text);
          if (!(json && json.data && json.data.products && json.data.purchases && json.data.sales)) {
            toast('åŒ¯å…¥æ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘å¿…è¦éµå', 'error'); return
          }
          if (useLocal) {
            LS.set('products', json.data.products || []);
            LS.set('purchases', json.data.purchases || []);
            LS.set('sales', json.data.sales || []);
            LS.set('audits', json.data.audits || []);
            LS.set('settings', json.data.settings || []);
          } else {
            const tx1 = db.transaction(['products', 'purchases', 'sales', 'audits', 'settings'], 'readwrite');
            for (const s of ['products', 'purchases', 'sales', 'audits', 'settings']) {
              tx1.objectStore(s).clear();
            }
            await new Promise(res => tx1.oncomplete = res);
            for (const p of (json.data.products || [])) { delete p.id; await add('products', p); }
            for (const p of (json.data.purchases || [])) { delete p.id; await add('purchases', p); }
            for (const p of (json.data.sales || [])) { delete p.id; await add('sales', p); }
            for (const p of (json.data.audits || [])) { delete p.id; await add('audits', p); }
            for (const s of (json.data.settings || [])) { await put('settings', s); }
          }
          toast('åŒ¯å…¥å®Œæˆ');
          await refreshAll();
        } catch (err) {
          console.error(err);
          toast('åŒ¯å…¥å¤±æ•—ï¼šJSON è§£æéŒ¯èª¤', 'error');
        } finally {
          e.target.value = '';
        }
      });

      /* ========== æ¸²æŸ“ ========== */
      
      /* æ”¹ç‚ºåŒæ­¥ï¼Œä¾è³´å¿«å–ï¼ŒåŠ å…¥æ’åº */
      function renderProducts() {
        const products = cachedData.products;
        const q = ($$('#q').value || '').trim().toLowerCase();
        const tbody = $$('#tblProducts tbody');
        
        const mapped = products.map(p => ({
          ...p,
          ...(cachedData.computed.get(p.id) || { stock: 0, floor: null, avg30: 0 })
        }));
        
        const sorter = getSorter(sortState.products.key, sortState.products.dir);
        mapped.sort(sorter);
        
        const rows = mapped
          .filter(p => !q || p.code.toLowerCase().includes(q) || p.name.toLowerCase().includes(q))
          .map(p => {
            return `<tr>
              <td>${p.code}</td>
              <td>${p.name}</td>
              <td>${p.unit || ''}</td>
              <td class="num">${fmt3(p.stock)}</td>
              <td class="num">${p.floor == null ? '<span class="tag floor">æœªå®š</span>' : fmt2(p.floor)}</td>
              <td class="num">${fmt2(p.avg30)}</td>
              <td><button class="btn ghost btn-sm btnEdit" data-id="${p.id}" title="ç·¨è¼¯">âœ</button></td>
            </tr>`;
          });
      
        tbody.innerHTML = rows.join('');
      }

      /* æ”¹ç‚ºåŒæ­¥ï¼Œä¾è³´å¿«å–ï¼ŒåŠ å…¥æ’åºå’Œç·¨è¼¯/åˆªé™¤æŒ‰éˆ• */
      function renderPurchases() {
        const { purchases, products } = cachedData;
        const map = Object.fromEntries(products.map(p => [p.id, `${p.code}ï½œ${p.name}`]));
        const tbody = $$('#tblPurchases tbody');
        
        const mapped = purchases.map(r => ({
          ...r,
          productName: map[r.productId] || r.productId
        }));
        
        const sorter = getSorter(sortState.purchases.key, sortState.purchases.dir);
        mapped.sort(sorter);
        
        tbody.innerHTML = mapped.map(r => `
          <tr>
            <td>${r.date || ''}</td>
            <td>${r.productName}</td>
            <td class="num">${fmt3(r.qty)}</td>
            <td class="num">${fmt2(r.unitCost)}</td>
            <td>
              <button class="btn ghost btn-sm btnEditPur" data-id="${r.id}" title="ç·¨è¼¯">âœ</button>
              <button class="btn ghost btn-sm btnDelPur" data-id="${r.id}" title="åˆªé™¤">Ã—</button>
            </td>
          </tr>
        `).join('');
      }

      /* æ”¹ç‚ºåŒæ­¥ï¼Œä¾è³´å¿«å–ï¼ŒåŠ å…¥æ’åºå’Œç·¨è¼¯/åˆªé™¤æŒ‰éˆ• */
      function renderSales() {
        const { sales, products } = cachedData;
        const map = Object.fromEntries(products.map(p => [p.id, `${p.code}ï½œ${p.name}`]));
        const tbody = $$('#tblSales tbody');
        
        const mapped = sales.map(r => ({
          ...r,
          productName: map[r.productId] || r.productId
        }));

        const sorter = getSorter(sortState.sales.key, sortState.sales.dir);
        mapped.sort(sorter);
        
        tbody.innerHTML = mapped.map(r => `
          <tr>
            <td>${r.date || ''}</td>
            <td>${r.productName}</td>
            <td class="num">${fmt3(r.qty)}</td>
            <td class="num">${fmt2(r.amount)}</td>
            <td class="num">â‰ˆ ${fmt2(r.derivedPrice)}</td>
            <td>${r.note || ''}</td>
            <td>${r.adjusted ? '<span class="tag adjusted">Adjusted</span>' : ''}</td>
            <td>
              <button class="btn ghost btn-sm btnEditSale" data-id="${r.id}" title="ç·¨è¼¯">âœ</button>
              <button class="btn ghost btn-sm btnDelSale" data-id="${r.id}" title="åˆªé™¤">Ã—</button>
            </td>
          </tr>
        `).join('');
      }

      /* æ”¹ç‚ºåŒæ­¥ï¼Œä¾è³´å¿«å–ï¼ŒåŠ å…¥æ’åº */
      function renderAudits() {
        const { audits, products } = cachedData;
        const map = Object.fromEntries(products.map(p => [p.id, `${p.code}ï½œ${p.name}`]));
        const tbody = $$('#tblAudits tbody');
        
        const mapped = audits.map(r => ({
          ...r,
          productName: map[r.productId] || r.productId
        }));

        const sorter = getSorter(sortState.audits.key, sortState.audits.dir);
        mapped.sort(sorter);
        
        tbody.innerHTML = mapped.map(r => `
          <tr>
            <td>${new Date(r.ts).toLocaleString()}</td>
            <td>${r.productName}</td>
            <td class="num">${fmt2(r.origAmount)}</td>
            <td class="num">${fmt2(r.newAmount)}</td>
            <td class="num">${fmt2(r.usedFloor)}</td>
            <td>${r.policy}</td>
          </tr>
        `).join('');
      }

      /* æ”¹ç‚ºåŒæ­¥ï¼Œä¾è³´å¿«å– */
      function renderDashboard() {
        const { sales, products, audits } = cachedData;
        const today = new Date().toISOString().slice(0, 10);

        const sToday = sales.filter(s => (s.date || '').slice(0, 10) === today);
        const qSum = sToday.reduce((a, b) => a + Number(b.qty), 0);
        const aSum = sToday.reduce((a, b) => a + Number(b.amount), 0);
        $$('#todayQty').textContent = fmt3(qSum);
        $$('#todayAmt').textContent = fmt2(aSum);
        $$('#todayAvg').textContent = fmt2(qSum ? (aSum / qSum) : 0);

        const noFloor = products.filter(p => cachedData.computed.get(p.id)?.floor == null).length;
        const blocked = audits.filter(a => a.policy === 'block' || a.policy === 'inventoryBlock').length;
        const adjusted = audits.filter(a => a.policy === 'autoAdjust').length;
        $$('#noFloorCount').textContent = noFloor;
        $$('#blockedCount').textContent = blocked;
        $$('#adjustedCount').textContent = adjusted;

        const list = products.map(p => ({ p, stock: cachedData.computed.get(p.id)?.stock ?? 0 })).sort((a, b) => a.stock - b.stock).slice(0, 5);
        const tbody = $$('#lowStockTable tbody'); tbody.innerHTML = '';
        list.forEach(({ p, stock }) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.code}</td><td>${p.name}</td><td class="num">${fmt3(stock)}</td>`;
          tbody.appendChild(tr);
        });

        // Sparkline
        const ctx = $$('#spark').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        const W = ctx.canvas.width = ctx.canvas.clientWidth;
        const H = ctx.canvas.height = ctx.canvas.clientHeight;
        const days = [...Array(30)].map((_, i) => {
          const d = new Date(); d.setDate(d.getDate() - (29 - i));
          return d.toISOString().slice(0, 10);
        });
        const series = days.map(d => {
          const ss = sales.filter(s => (s.date || '').slice(0, 10) === d);
          const q = ss.reduce((a, b) => a + Number(b.qty), 0);
          const a = ss.reduce((a, b) => a + Number(b.amount), 0);
          return q ? (a / q) : 0;
        });
        const max = Math.max(...series, 1);
        const min = Math.min(...series, 0);
        const xstep = W / (series.length - 1 || 1);
        ctx.beginPath();
        series.forEach((v, i) => {
          const x = i * xstep;
          const t = max === min ? 0.5 : (v - min) / (max - min);
          const y = H - t * H;
          if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.lineWidth = 2;
        (function () {
          const css = (getComputedStyle(document.documentElement).getPropertyValue('--info') || '').toString();
          const c = (css && css.trim()) ? css.trim() : '#2F80ED';
          ctx.strokeStyle = c;
        })();
        ctx.stroke();
      }

      /* ========== æ•¸æ“šé è™•ç†èˆ‡å¿«å– ========== */
      async function loadAndCacheData() {
        // ä¸€æ¬¡æ€§è¼‰å…¥æ‰€æœ‰åŸå§‹æ•¸æ“š
        [
          cachedData.products,
          cachedData.purchases,
          cachedData.sales,
          cachedData.audits,
          cachedData.settings
        ] = await Promise.all([
          listProducts(),
          listPurchases(),
          listSales(),
          listAudits(),
          getSettings()
        ]);

        // é è¨ˆç®—æ‰€æœ‰å•†å“çš„è¡ç”Ÿæ•¸æ“š
        cachedData.computed.clear();
        for (const product of cachedData.products) {
          const stock = calcStock(cachedData.purchases, cachedData.sales, product.id);
          const floor = calcFloor(cachedData.purchases, product.id);
          const avg30 = avgDerivedLast30(cachedData.sales, product.id);

          cachedData.computed.set(product.id, {
            stock,
            floor,
            avg30
          });
        }
      }

      /* æ•´é«”åˆ·æ–° - ç•°æ­¥è¼‰å…¥ -> åŒæ­¥æ¸²æŸ“ */
      async function refreshAll() {
        await loadAndCacheData(); 
        
        ensureProductOptions();
        renderProducts();
        renderPurchases();
        renderSales();
        renderAudits();
        renderDashboard();
        
        updateSortIndicators();
      }

      /* é–‹å§‹ */
      async function init() {
        db = await idbOpen();
        updateDots();
        
        const s = await getSettings();
        cachedData.settings = s;
        setTheme(s.theme);
        $$('#themeSel').value = s.theme;
        $$('#pricePolicy').value = s.priceFloorPolicy;
        $$('#inventoryControl').checked = !!s.inventoryControl;

        setupEventDelegation();

        const products = await listProducts();
        if (products.length === 0) {
          await add(STORES.PRODUCTS, { code: 'S-001', name: 'ç¤ºä¾‹å•†å“', unit: 'ä»¶' });
        }

        await refreshAll();
        toast('å·²è¼‰å…¥ï¼ˆé›¢ç·šå¯ç”¨ï¼‰', 'info');
      }

      /* äº‹ä»¶å§”æ´¾è¨­ç½® - åŠ å…¥æ’åºå’Œç·¨è¼¯/åˆªé™¤ */
      function setupEventDelegation() {
        
        // === æ’åºé»æ“Šè™•ç† ===
        function handleSortClick(e, tableKey, renderFn) {
          const th = e.target.closest('th[data-sort]');
          if (!th) return;
          
          const key = th.dataset.sort;
          const state = sortState[tableKey];
          
          if (state.key === key) {
            state.dir = state.dir === 'asc' ? 'desc' : 'asc';
          } else {
            state.key = key;
            state.dir = (key === 'date' || key === 'ts') ? 'desc' : 'asc';
          }
          
          renderFn();
          updateSortIndicators();
        }

        $$('#tblProducts thead')?.addEventListener('click', (e) => handleSortClick(e, 'products', renderProducts));
        $$('#tblPurchases thead')?.addEventListener('click', (e) => handleSortClick(e, 'purchases', renderPurchases));
        $$('#tblSales thead')?.addEventListener('click', (e) => handleSortClick(e, 'sales', renderSales));
        $$('#tblAudits thead')?.addEventListener('click', (e) => handleSortClick(e, 'audits', renderAudits));

        // === ç·¨è¼¯/åˆªé™¤è™•ç† ===
        
        // å•†å“è¡¨æ ¼
        $$('#tblProducts tbody')?.addEventListener('click', (e) => {
          if (e.target.classList.contains('btnEdit')) {
            const id = Number(e.target.dataset.id);
            const p = cachedData.products.find(x => x.id === id);
            if (!p) return;
            $$('#pCode').value = p.code;
            $$('#pName').value = p.name;
            $$('#pUnit').value = p.unit || '';
            $$('#dlgProductTitle').textContent = 'ç·¨è¼¯å•†å“';
            openDlg('#dlgProduct');
          }
        });
        
        // é€²è²¨è¡¨æ ¼
        $$('#tblPurchases tbody')?.addEventListener('click', async (e) => {
          const target = e.target.closest('button');
          if (!target) return;
          const id = Number(target.dataset.id);
          
          if (target.classList.contains('btnEditPur')) {
            const r = cachedData.purchases.find(x => x.id === id);
            if (!r) return;
            
            $$('#purProduct').value = r.productId;
            $$('#purQty').value = r.qty;
            $$('#purCost').value = r.unitCost;
            $$('#purDate').value = r.date;
            $$('#purNote').value = r.note || '';
            
            $$('#dlgPurchaseTitle').textContent = 'ç·¨è¼¯é€²è²¨';
            $$('#btnSavePurchase').textContent = 'æ›´æ–°';
            $$('#dlgPurchase').dataset.editingId = id;
            
            openDlg('#dlgPurchase');
          }
          
          if (target.classList.contains('btnDelPur')) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é€²è²¨ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œæœƒå½±éŸ¿åº«å­˜ã€‚')) {
              await deleteRecord(STORES.PURCHASES, id);
              toast('å·²åˆªé™¤é€²è²¨ç´€éŒ„');
              await refreshAll();
            }
          }
        });
        
        // éŠ·è²¨è¡¨æ ¼
        $$('#tblSales tbody')?.addEventListener('click', async (e) => {
          const target = e.target.closest('button');
          if (!target) return;
          const id = Number(target.dataset.id);
          
          if (target.classList.contains('btnEditSale')) {
            const r = cachedData.sales.find(x => x.id === id);
            if (!r) return;
            
            $$('#saleProduct').value = r.productId;
            $$('#saleQty').value = r.qty;
            $$('#saleAmt').value = r.amount;
            $$('#saleDate').value = r.date;
            $$('#saleNote').value = r.note || '';
            
            $$('#dlgSaleTitle').textContent = 'ç·¨è¼¯éŠ·è²¨';
            $$('#btnSaveSale').textContent = 'æ›´æ–°';
            $$('#dlgSale').dataset.editingId = id;
            
            $$('#saleProduct').dispatchEvent(new Event('change'));
            openDlg('#dlgSale');
            updateDerivedHelper();
          }
          
          if (target.classList.contains('btnDelSale')) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†éŠ·è²¨ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œæœƒå½±éŸ¿åº«å­˜ã€‚')) {
              await deleteRecord(STORES.SALES, id);
              toast('å·²åˆªé™¤éŠ·è²¨ç´€éŒ„');
              await refreshAll();
            }
          }
        });
      }

      // åˆå§‹åŒ–æ‡‰ç”¨
      window.addEventListener('DOMContentLoaded', init);

    })(); // IIFE çµæŸ
  </script>
</body>

</html>
