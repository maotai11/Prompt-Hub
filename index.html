<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é›¢ç·šè–ªè³‡è¡¨åˆ†æèˆ‡è²¡å‹™å…§æ§ç³»çµ± v1.1</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --primary: #1a56db;
  --primary-light: #e1effe;
  --success: #059669;
  --warning: #d97706;
  --danger: #dc2626;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-600: #4b5563;
  --gray-800: #1f2937;
  --addon-bg: #fffbeb;
  --addon-border: #f59e0b;
  --summary-bg: #ecfdf5;
  --summary-border: #10b981;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--gray-100); color: var(--gray-800); font-size: 14px; }
.container { max-width: 1600px; margin: 0 auto; padding: 16px; }
.header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
.header h1 { font-size: 1.5rem; font-weight: 600; }
.header .badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; }
.card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; overflow: hidden; }
.card-header { padding: 16px 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; background: var(--gray-50); flex-wrap: wrap; gap: 8px; }
.card-header h2 { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.card-body { padding: 20px; }
.btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: #1e429f; }
.btn-success { background: var(--success); color: white; }
.btn-warning { background: var(--warning); color: white; }
.btn-danger { background: var(--danger); color: white; }
.btn-outline { background: white; border: 1px solid var(--gray-300); color: var(--gray-600); }
.btn-outline:hover { background: var(--gray-100); }
.btn-sm { padding: 4px 10px; font-size: 0.8rem; }
.upload-zone { border: 2px dashed var(--gray-300); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--gray-50); }
.upload-zone:hover, .upload-zone.dragover { border-color: var(--primary); background: var(--primary-light); }
.upload-zone input { display: none; }
.upload-icon { font-size: 3rem; margin-bottom: 12px; }
.tabs { display: flex; gap: 4px; padding: 8px; background: var(--gray-100); border-radius: 8px; flex-wrap: wrap; }
.tab { padding: 8px 16px; border-radius: 6px; cursor: pointer; background: transparent; border: none; font-size: 0.9rem; transition: all 0.2s; }
.tab:hover { background: white; }
.tab.active { background: var(--primary); color: white; }
.excel-container { overflow: auto; max-height: 70vh; border: 1px solid var(--gray-200); border-radius: 8px; }
.excel-table { border-collapse: collapse; font-size: 13px; min-width: 100%; }
.excel-table th, .excel-table td { border: 1px solid #c0c0c0; padding: 6px 10px; text-align: left; white-space: nowrap; min-width: 80px; position: relative; }
.excel-table th { background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 600; position: sticky; top: 0; z-index: 10; }
.excel-table .row-header { background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 600; text-align: center; min-width: 50px; position: sticky; left: 0; z-index: 5; }
.excel-table .corner { position: sticky; left: 0; top: 0; z-index: 15; background: #e2e8f0; }
.addon-row { background: var(--addon-bg) !important; }
.addon-row td { border-color: var(--addon-border) !important; }
.addon-badge { display: inline-block; background: var(--addon-border); color: white; font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-right: 4px; vertical-align: middle; }
.summary-row { background: var(--summary-bg) !important; }
.summary-row td { border-color: var(--summary-border) !important; font-weight: 600; }
.summary-badge { display: inline-block; background: var(--summary-border); color: white; font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-right: 4px; vertical-align: middle; }
.highlight-cell { background: #fef3c7 !important; box-shadow: inset 0 0 0 2px var(--warning); }
.error-cell { background: #fee2e2 !important; box-shadow: inset 0 0 0 2px var(--danger); }
.error-list { max-height: 300px; overflow-y: auto; }
.error-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: background 0.2s; }
.error-item:hover { background: var(--gray-50); }
.error-coord { background: var(--danger); color: white; padding: 2px 8px; border-radius: 4px; font-family: monospace; font-weight: 600; white-space: nowrap; }
.error-coord.warning { background: var(--warning); }
.error-desc { flex: 1; }
.copy-btn { padding: 2px 8px; font-size: 11px; }
.settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
.setting-group { background: var(--gray-50); padding: 16px; border-radius: 8px; }
.setting-group h4 { margin-bottom: 12px; color: var(--gray-600); font-size: 0.9rem; }
.form-row { margin-bottom: 12px; }
.form-row label { display: block; margin-bottom: 4px; font-size: 0.85rem; color: var(--gray-600); }
.form-row input, .form-row select { width: 100%; padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.9rem; }
.form-row input:focus, .form-row select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,86,219,0.1); }
.checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; max-height: 200px; overflow-y: auto; padding: 4px; }
.checkbox-item { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: white; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
.checkbox-item:hover { border-color: var(--primary); }
.checkbox-item.checked { background: var(--primary-light); border-color: var(--primary); }
.checkbox-item input { margin: 0; }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-overlay.show { display: flex; }
.modal { background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow: hidden; }
.modal-header { padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
.modal-body { padding: 20px; overflow-y: auto; max-height: 60vh; }
.modal-footer { padding: 16px 20px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 8px; }
.mapping-table { width: 100%; border-collapse: collapse; }
.mapping-table th, .mapping-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--gray-200); }
.mapping-table select { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid var(--gray-300); }
.status-bar { display: flex; gap: 16px; padding: 12px 20px; background: var(--gray-800); color: white; border-radius: 8px; font-size: 0.85rem; flex-wrap: wrap; }
.status-item { display: flex; align-items: center; gap: 6px; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; }
.status-dot.green { background: #10b981; }
.status-dot.yellow { background: #f59e0b; }
.status-dot.red { background: #ef4444; }
.flex { display: flex; }
.flex-wrap { flex-wrap: wrap; }
.gap-2 { gap: 8px; }
.gap-4 { gap: 16px; }
.mt-2 { margin-top: 8px; }
.mt-4 { margin-top: 16px; }
.mb-4 { margin-bottom: 16px; }
.text-sm { font-size: 0.85rem; }
.text-gray { color: var(--gray-600); }
.hidden { display: none !important; }
.year-group { display: inline-block; margin-right: 8px; padding: 2px 6px; background: #dbeafe; border-radius: 4px; font-size: 12px; }
.year-total { font-weight: bold; color: var(--primary); }
@media print {
  body { background: white; font-size: 11px; }
  .no-print { display: none !important; }
  .excel-container { max-height: none !important; overflow: visible !important; border: none !important; }
  /* ç§»é™¤ card çš„ break-inside: avoid ä»¥å…è¨±é•·è¡¨æ ¼è·¨é ï¼Œä¸¦é–‹å•Ÿ overflow */
  .card { box-shadow: none !important; break-inside: auto !important; overflow: visible !important; margin: 0 !important; border: none !important; }
  .container { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
  
  /* å¼·åˆ¶æ¨™é¡Œåˆ—åœ¨æ¯ä¸€é é‡è¤‡å‡ºç¾ */
  .excel-table { width: 100%; }
  .excel-table thead { display: table-header-group; }
  .excel-table tr { break-inside: avoid; page-break-inside: avoid; }
  
  /* ç§»é™¤ sticky å®šä½ï¼Œå¦å‰‡ç€è¦½å™¨ç„¡æ³•åœ¨ç¬¬äºŒé é‡è¤‡æ¨™é¡Œ */
  .excel-table th, .excel-table .row-header, .excel-table .corner { 
    position: static !important; 
    overflow: visible !important;
  }
  
  /* ç¢ºä¿å…§å®¹ä¸è¢«è£åˆ‡ */
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  
  @page { margin: 1cm; size: auto; }
}
@media print and (orientation: landscape) {
  @page { size: landscape; }
}
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header no-print">
    <div>
      <h1>ğŸ“Š é›¢ç·šè–ªè³‡è¡¨åˆ†æèˆ‡è²¡å‹™å…§æ§ç³»çµ±</h1>
      <p class="text-sm" style="opacity:0.8;margin-top:4px;">File:// Offline Payroll Analyzer + Finance Review Team</p>
    </div>
    <div class="flex gap-2">
      <span class="badge">v1.2</span>
      <span class="badge">ğŸ”’ é›¢ç·šæ¨¡å¼</span>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar no-print mb-4">
    <div class="status-item"><span class="status-dot green"></span> é›¢ç·šé‹è¡Œä¸­</div>
    <div class="status-item" id="fileStatus"><span class="status-dot yellow"></span> å¾…ä¸Šå‚³æª”æ¡ˆ</div>
    <div class="status-item" id="sheetStatus"><span class="status-dot yellow"></span> å·¥ä½œè¡¨: --</div>
    <div class="status-item" id="errorStatus"><span class="status-dot green"></span> éŒ¯èª¤: 0</div>
  </div>

  <!-- Upload Section -->
  <div class="card no-print" id="uploadCard">
    <div class="card-body">
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".xlsx,.xls">
        <div class="upload-icon">ğŸ“</div>
        <h3>æ‹–æ”¾ Excel æª”æ¡ˆè‡³æ­¤è™•</h3>
        <p class="text-gray mt-2">æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆï¼ˆæ”¯æ´ .xlsx, .xlsï¼‰</p>
        <p class="text-sm text-gray mt-2">âš ï¸ æ‰€æœ‰è³‡æ–™åƒ…åœ¨æœ¬æ©Ÿè™•ç†ï¼Œçµ•ä¸å¤–å‚³</p>
      </div>
    </div>
  </div>

  <!-- Sheet Tabs -->
  <div class="card hidden" id="sheetTabsCard">
    <div class="card-header no-print">
      <h2>ğŸ“‘ å·¥ä½œè¡¨é¸æ“‡</h2>
      <div class="flex gap-2 flex-wrap">
        <button class="btn btn-outline btn-sm" onclick="openMappingModal()">âš™ï¸ æ¬„ä½æ˜ å°„</button>
        <button class="btn btn-outline btn-sm" onclick="openSettingsModal()">ğŸ”§ å¾Œå°è¨­å®š</button>
        <button class="btn btn-primary btn-sm" onclick="runAnalysis()">â–¶ï¸ åŸ·è¡Œåˆ†æ</button>
      </div>
    </div>
    <div class="card-body">
      <div class="tabs" id="sheetTabs"></div>
    </div>
  </div>

  <!-- Header Row Selection -->
  <div class="card hidden" id="headerRowCard">
    <div class="card-header">
      <h2>ğŸ“ æ¨™é¡Œåˆ—åµæ¸¬</h2>
    </div>
    <div class="card-body">
      <div class="flex gap-4 flex-wrap" style="align-items:center;">
        <label>æ¨™é¡Œåˆ—ä½ç½®ï¼ˆåˆ—è™Ÿï¼‰ï¼š</label>
        <input type="number" id="headerRowInput" value="1" min="1" style="width:80px;">
        <button class="btn btn-primary btn-sm" onclick="confirmHeaderRow()">ç¢ºèªæ¨™é¡Œåˆ—</button>
        <span class="text-sm text-gray" id="headerPreview"></span>
      </div>
    </div>
  </div>

  <!-- Sum Columns Selection -->
  <div class="card hidden" id="sumColumnsCard">
    <div class="card-header">
      <h2>ğŸ“Š åŠ ç¸½èˆ‡æ‘˜è¦è¨­å®š</h2>
    </div>
    <div class="card-body">
      <p class="text-sm text-gray mb-4">ç³»çµ±å·²è‡ªå‹•é é¸é‡‘é¡æ¬„ä½ï¼Œè«‹ç¢ºèªéœ€è¦é¡¯ç¤ºã€Œå“¡å·¥å°è¨ˆã€èˆ‡ã€Œåº•éƒ¨æ‘˜è¦ã€çš„é …ç›®ï¼š</p>
      <div style="max-height: 300px; overflow-y: auto;">
        <table class="mapping-table" style="width:100%;">
          <thead>
            <tr>
              <th style="position:sticky;top:0;background:#f9fafb;">æ¬„ä½åç¨±</th>
              <th style="position:sticky;top:0;background:#f9fafb;text-align:center;">
                <label style="cursor:pointer;"><input type="checkbox" id="chkAllSubtotal" onchange="toggleAllCol(this, 'subtotal')"> å“¡å·¥å°è¨ˆ</label>
              </th>
              <th style="position:sticky;top:0;background:#f9fafb;text-align:center;">
                <label style="cursor:pointer;"><input type="checkbox" id="chkAllSummary" onchange="toggleAllCol(this, 'summary')"> åº•éƒ¨æ‘˜è¦</label>
              </th>
            </tr>
          </thead>
          <tbody id="sumColumnsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Excel Display -->
  <div class="card hidden" id="excelCard">
    <div class="card-header">
      <h2>ğŸ“‹ å·¥ä½œè¡¨å…§å®¹</h2>
      <span class="text-sm text-gray" id="excelInfo"></span>
    </div>
    <div class="excel-container" id="excelContainer"></div>
  </div>

  <!-- Error List -->
  <div class="card hidden" id="errorCard">
    <div class="card-header">
      <h2>âš ï¸ æ ¸å°éŒ¯èª¤æ¸…å–®</h2>
      <div class="flex gap-2">
        <button class="btn btn-outline btn-sm" onclick="copyAllErrors()">ğŸ“‹ è¤‡è£½å…¨éƒ¨</button>
        <button class="btn btn-outline btn-sm" onclick="exportErrors()">ğŸ“¥ åŒ¯å‡º</button>
      </div>
    </div>
    <div class="card-body">
      <div class="error-list" id="errorList"></div>
    </div>
  </div>

  <!-- Print Controls -->
  <div class="card hidden no-print" id="printCard">
    <div class="card-header">
      <h2>ğŸ–¨ï¸ åˆ—å°/è¼¸å‡º</h2>
    </div>
    <div class="card-body">
      <div class="flex gap-4 flex-wrap" style="align-items:center;">
        <div class="setting-group" style="padding:8px; display:flex; gap:12px; align-items:center; background:#f3f4f6;">
          <label>ç´™å¼µæ–¹å‘ï¼š</label>
          <select id="printOrientation" style="padding:4px; border-radius:4px;">
            <option value="portrait">ç›´å¼</option>
            <option value="landscape">æ©«å¼</option>
          </select>
          
          <label style="margin-left:8px; display:flex; align-items:center; gap:4px; cursor:pointer;">
            <input type="checkbox" id="printFitWidth" checked> è‡ªå‹•ç¸®æ”¾è‡³é å¯¬
          </label>

          <label style="margin-left:8px;">ç¸®æ”¾æ¯”ä¾‹:</label>
          <input type="number" id="printScale" value="100" min="50" max="200" step="5" style="width:60px; padding:4px;">%
        </div>

        <button class="btn btn-primary" onclick="printReport()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button>
        <button class="btn btn-success" id="btnExportPdf" onclick="exportToPDF()">ğŸ“¥ åŒ¯å‡º PDF</button>
      </div>
      <p class="text-sm text-gray mt-2">ğŸ’¡ æç¤ºï¼šè‹¥é è¦½æ™‚é‚Šæ¡†è¢«åˆ‡æ‰ï¼Œè«‹å‹¾é¸ã€Œè‡ªå‹•ç¸®æ”¾ã€æˆ–èª¿æ•´ç¸®æ”¾æ¯”ä¾‹ã€‚</p>
    </div>
  </div>
</div>

<!-- Mapping Modal -->
<div class="modal-overlay" id="mappingModal">
  <div class="modal">
    <div class="modal-header">
      <h3>âš™ï¸ æ¬„ä½æ˜ å°„è¨­å®š</h3>
      <button class="btn btn-outline btn-sm" onclick="closeMappingModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <p class="text-sm text-gray mb-4">è«‹é¸æ“‡å°æ‡‰çš„æ¬„ä½ï¼ˆåƒ…å…è¨±ç²¾æº–æ¬„ååŒ¹é…ï¼‰</p>
      <table class="mapping-table">
        <thead>
          <tr><th>ç³»çµ±æ¬„ä½</th><th>Excelæ¬„ä½</th></tr>
        </thead>
        <tbody id="mappingTableBody"></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeMappingModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveMapping()">å„²å­˜æ˜ å°„</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal" style="max-width:800px;">
    <div class="modal-header">
      <h3>ğŸ”§ å¾Œå°è¨­å®š</h3>
      <button class="btn btn-outline btn-sm" onclick="closeSettingsModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="settings-grid">
        <div class="setting-group">
          <h4>ğŸ“‹ æ ¸å°è¦å‰‡</h4>
          <div class="form-row">
            <label>è–ªè³‡ç•°å¸¸é–€æª»ï¼ˆ%ï¼‰</label>
            <input type="number" id="salaryThreshold" value="20">
          </div>
          <div class="form-row">
            <label>è‡ªæèª¤å·®å®¹è¨±</label>
            <input type="number" id="selfContributionTolerance" value="0">
          </div>
          <div class="form-row" style="border-top:1px dashed #ccc; padding-top:12px; margin-top:12px;">
            <label>æ‰€å¾—ç¨…æª¢æŸ¥é–€æª» (è–ªè³‡ > X)</label>
            <input type="number" id="taxCheckThreshold" value="88501">
          </div>
          <div class="form-row">
            <label>æ‰€å¾—ç¨…ç‡ (%)</label>
            <input type="number" id="taxRate" value="5">
          </div>
          <div class="form-row">
            <label>æ ¸å°è¦å‰‡: å§“åèˆ‡IDä¸€è‡´æ€§</label>
            <div class="checkbox-group">
              <label class="checkbox-item"><input type="checkbox" id="checkIdUnique" checked> æª¢æŸ¥ ID å°æ‡‰å¤šå€‹å§“å</label>
              <label class="checkbox-item"><input type="checkbox" id="checkNameUnique" checked> æª¢æŸ¥ å§“å å°æ‡‰å¤šå€‹ ID</label>
            </div>
          </div>
        </div>
        <div class="setting-group">
          <h4>ğŸ‘¤ å“¡å·¥è­˜åˆ¥</h4>
          <div class="form-row">
            <label>ä¸»è¦è­˜åˆ¥æ¬„ä½</label>
            <select id="primaryIdField">
              <option value="idNumber">èº«åˆ†è­‰å­—è™Ÿ</option>
              <option value="employeeId">å“¡å·¥ç·¨è™Ÿ</option>
            </select>
          </div>
          <div class="form-row">
            <label>æ¬¡è¦è­˜åˆ¥æ¬„ä½</label>
            <select id="secondaryIdField">
              <option value="name">å§“å</option>
              <option value="none">ç„¡</option>
            </select>
          </div>
        </div>
        <div class="setting-group">
          <h4>ğŸ“Š åŠ ç¸½èˆ‡å¹´åº¦è¨­å®š</h4>
          <div class="form-row">
            <label>ç›®æ¨™å¹´åº¦ (n, n-1)</label>
            <input type="text" id="targetYears" placeholder="ä¾‹å¦‚: 113,114 (ç•™ç©ºå‰‡è‡ªå‹•æŠ“å–æ‰€æœ‰)">
            <p class="text-sm text-gray" style="margin-top:2px;">* åƒ…ç”¨æ–¼ç¯©é¸ç‰¹å®šå¹´åº¦é¡¯ç¤ºï¼Œç•™ç©ºå‰‡é¡¯ç¤ºå…¨éƒ¨</p>
          </div>
          <div class="form-row">
            <label>åˆ†çµ„æ–¹å¼</label>
            <select id="groupByMethod">
              <option value="year">ä¾å¹´åº¦ï¼ˆæ°‘åœ‹å¹´ï¼‰</option>
              <option value="yearMonth">ä¾å¹´æœˆ</option>
            </select>
          </div>
          <div class="form-row">
            <label>é¡¯ç¤ºå°è¨ˆ</label>
            <select id="showSubtotal">
              <option value="yes">æ˜¯</option>
              <option value="no">å¦</option>
            </select>
          </div>
        </div>
        <div class="setting-group">
          <h4>ğŸ“„ è¦å‰‡ç‰ˆæœ¬</h4>
          <div class="form-row">
            <label>è¦å‰‡ç‰ˆæœ¬è™Ÿ</label>
            <input type="text" id="ruleVersion" value="1.1.0" readonly>
          </div>
          <div class="form-row">
            <label>æœ€å¾Œæ›´æ–°</label>
            <input type="text" id="lastUpdate" readonly>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="resetSettings()">é‡ç½®é è¨­</button>
      <button class="btn btn-outline" onclick="closeSettingsModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
    </div>
  </div>
</div>

<script>
// ========== ç°¡åŒ–ç‰ˆ Excel è§£æå™¨ ==========
class SimpleXLSX {
  constructor() {
    this.sheets = {};
    this.sheetNames = [];
  }

  async read(data) {
    const zip = await this.unzip(data);
    const workbook = { SheetNames: [], Sheets: {} };
    
    const wbXml = await this.getXmlFromZip(zip, 'xl/workbook.xml');
    const sheetNodes = wbXml.querySelectorAll('sheet');
    
    sheetNodes.forEach((node, idx) => {
      const name = node.getAttribute('name');
      workbook.SheetNames.push(name);
    });

    let sharedStrings = [];
    try {
      const ssXml = await this.getXmlFromZip(zip, 'xl/sharedStrings.xml');
      const siNodes = ssXml.querySelectorAll('si');
      siNodes.forEach(si => {
        const tNodes = si.querySelectorAll('t');
        let text = '';
        tNodes.forEach(t => text += t.textContent);
        sharedStrings.push(text);
      });
    } catch (e) {}

    for (let i = 1; i <= workbook.SheetNames.length; i++) {
      try {
        const sheetXml = await this.getXmlFromZip(zip, `xl/worksheets/sheet${i}.xml`);
        const sheetData = this.parseSheet(sheetXml, sharedStrings);
        workbook.Sheets[workbook.SheetNames[i-1]] = sheetData;
      } catch (e) {
        console.warn(`ç„¡æ³•è®€å– sheet${i}:`, e);
      }
    }

    return workbook;
  }

  async unzip(data) {
    const uint8 = new Uint8Array(data);
    const files = {};
    let pos = 0;

    while (pos < uint8.length - 4) {
      const sig = uint8[pos] | (uint8[pos+1]<<8) | (uint8[pos+2]<<16) | (uint8[pos+3]<<24);
      
      if (sig === 0x04034b50) {
        const method = uint8[pos+8] | (uint8[pos+9]<<8);
        const compSize = uint8[pos+18] | (uint8[pos+19]<<8) | (uint8[pos+20]<<16) | (uint8[pos+21]<<24);
        const nameLen = uint8[pos+26] | (uint8[pos+27]<<8);
        const extraLen = uint8[pos+28] | (uint8[pos+29]<<8);
        
        const fileName = new TextDecoder().decode(uint8.slice(pos+30, pos+30+nameLen));
        const dataStart = pos + 30 + nameLen + extraLen;
        const compData = uint8.slice(dataStart, dataStart + compSize);
        
        if (method === 0) {
          files[fileName] = compData;
        } else if (method === 8) {
          try {
            const ds = new DecompressionStream('deflate-raw');
            const writer = ds.writable.getWriter();
            const reader = ds.readable.getReader();
            writer.write(compData);
            writer.close();
            
            const chunks = [];
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              chunks.push(value);
            }
            const totalLen = chunks.reduce((a, c) => a + c.length, 0);
            const result = new Uint8Array(totalLen);
            let offset = 0;
            for (const chunk of chunks) {
              result.set(chunk, offset);
              offset += chunk.length;
            }
            files[fileName] = result;
          } catch (e) {
            files[fileName] = compData;
          }
        }
        
        pos = dataStart + compSize;
      } else if (sig === 0x02014b50) {
        break;
      } else {
        pos++;
      }
    }
    
    return files;
  }

  async getXmlFromZip(zip, path) {
    const data = zip[path];
    if (!data) throw new Error(`File not found: ${path}`);
    const text = new TextDecoder().decode(data);
    const parser = new DOMParser();
    return parser.parseFromString(text, 'application/xml');
  }

  parseSheet(xml, sharedStrings) {
    const sheet = { '!ref': 'A1' };
    const rows = xml.querySelectorAll('row');
    let maxRow = 0, maxCol = 0;

    rows.forEach(row => {
      const cells = row.querySelectorAll('c');
      cells.forEach(cell => {
        const ref = cell.getAttribute('r');
        const type = cell.getAttribute('t');
        const vNode = cell.querySelector('v');
        
        if (ref) {
          const { col, row: rowNum } = this.parseRef(ref);
          maxRow = Math.max(maxRow, rowNum);
          maxCol = Math.max(maxCol, col);
          
          let value = vNode ? vNode.textContent : '';
          
          if (type === 's' && sharedStrings[parseInt(value)]) {
            value = sharedStrings[parseInt(value)];
            sheet[ref] = { t: 's', v: value, w: value };
          } else if (type === 'b') {
            sheet[ref] = { t: 'b', v: value === '1' };
          } else if (value !== '') {
            const num = parseFloat(value);
            if (!isNaN(num)) {
              sheet[ref] = { t: 'n', v: num, w: String(num) };
            } else {
              sheet[ref] = { t: 's', v: value, w: value };
            }
          }
        }
      });
    });

    sheet['!ref'] = `A1:${this.colToLetter(maxCol)}${maxRow}`;
    return sheet;
  }

  parseRef(ref) {
    const match = ref.match(/^([A-Z]+)(\d+)$/);
    if (!match) return { col: 0, row: 0 };
    const colStr = match[1];
    const row = parseInt(match[2]);
    let col = 0;
    for (let i = 0; i < colStr.length; i++) {
      col = col * 26 + (colStr.charCodeAt(i) - 64);
    }
    return { col, row };
  }

  colToLetter(col) {
    let letter = '';
    while (col > 0) {
      const mod = (col - 1) % 26;
      letter = String.fromCharCode(65 + mod) + letter;
      col = Math.floor((col - 1) / 26);
    }
    return letter || 'A';
  }
}

// ========== å…¨åŸŸè®Šæ•¸ ==========
let workbook = null;
let currentSheet = null;
let currentSheetName = '';
let originalData = [];
let headerRow = 1;
let headers = [];
let columnMapping = {};
let settings = {};
let errors = [];
let summaryData = {};
let employeeBlocks = [];
let selectedSumColumns = [];     // ç”¨æ–¼å“¡å·¥å°è¨ˆ
let selectedSummaryColumns = []; // ç”¨æ–¼åº•éƒ¨æ‘˜è¦

// ç³»çµ±æ¬„ä½å®šç¾© - ä¾æ“šä½¿ç”¨è€…éœ€æ±‚æ›´æ–° (v1.2)
const SYSTEM_FIELDS = [
  { key: 'employeeId', label: 'å“¡å·¥ä»£è™Ÿ', required: false },
  { key: 'name', label: 'å“¡å·¥å§“å', required: true },
  { key: 'idNumber', label: 'èº«åˆ†è­‰å­—è™Ÿ', required: true },
  { key: 'address', label: 'åœ°å€', required: false },
  { key: 'category', label: 'é¡åˆ¥', required: false },
  { key: 'year', label: 'å¹´åº¦', required: false },
  { key: 'month', label: 'æœˆä»½', required: false },
  { key: 'salary', label: 'è–ªè³‡', required: false },
  { key: 'netPay', label: 'è–ªè³‡æ·¨é¡', required: false },
  { key: 'selfContribution', label: 'è‡ªæ', required: false },
  { key: 'bonus', label: 'çé‡‘', required: false },
  { key: 'tax', label: 'æ‰€å¾—ç¨…', required: false },
  { key: 'totalPay', label: 'åˆè¨ˆ', required: false },
  { key: 'yearEndBonus', label: 'å¹´çµ‚', required: false }
];

// ========== åˆå§‹åŒ– ==========
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  initUploadZone();
  updateLastUpdate();
});

function loadSettings() {
  const saved = localStorage.getItem('payrollAnalyzerSettings_v1_1');
  if (saved) {
    settings = JSON.parse(saved);
  } else {
    settings = {
      salaryThreshold: 20,
      selfContributionTolerance: 0,
      taxCheckThreshold: 88501,
      taxRate: 5,
      primaryIdField: 'idNumber',
      secondaryIdField: 'name',
      groupByMethod: 'year',
      showSubtotal: 'yes',
      targetYears: '',
      checkIdUnique: true,
      checkNameUnique: true,
      ruleVersion: '1.4.0'
    };
  }
  applySettingsToUI();
}

function applySettingsToUI() {
  document.getElementById('salaryThreshold').value = settings.salaryThreshold || 20;
  document.getElementById('selfContributionTolerance').value = settings.selfContributionTolerance || 0;
  document.getElementById('taxCheckThreshold').value = settings.taxCheckThreshold || 88501;
  document.getElementById('taxRate').value = settings.taxRate || 5;
  document.getElementById('checkIdUnique').checked = settings.checkIdUnique !== false;
  document.getElementById('checkNameUnique').checked = settings.checkNameUnique !== false;

  document.getElementById('primaryIdField').value = settings.primaryIdField || 'idNumber';
  document.getElementById('secondaryIdField').value = settings.secondaryIdField || 'name';
  document.getElementById('groupByMethod').value = settings.groupByMethod || 'year';
  document.getElementById('showSubtotal').value = settings.showSubtotal || 'yes';
  document.getElementById('targetYears').value = settings.targetYears || '';
  document.getElementById('ruleVersion').value = settings.ruleVersion || '1.4.0';
}

function updateLastUpdate() {
  document.getElementById('lastUpdate').value = new Date().toLocaleString('zh-TW');
}

// ========== æª”æ¡ˆä¸Šå‚³ ==========
function initUploadZone() {
  const zone = document.getElementById('uploadZone');
  const input = document.getElementById('fileInput');

  zone.addEventListener('click', () => input.click());
  
  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('dragover');
  });

  zone.addEventListener('dragleave', () => {
    zone.classList.remove('dragover');
  });

  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) handleFile(files[0]);
  });

  input.addEventListener('change', (e) => {
    if (e.target.files.length > 0) handleFile(e.target.files[0]);
  });
}

async function handleFile(file) {
  if (!file.name.match(/\.xlsx?$/i)) {
    alert('è«‹ä¸Šå‚³ Excel æª”æ¡ˆï¼ˆ.xlsx æˆ– .xlsï¼‰');
    return;
  }

  try {
    const data = await file.arrayBuffer();
    const parser = new SimpleXLSX();
    workbook = await parser.read(data);
    
    document.getElementById('fileStatus').innerHTML = '<span class="status-dot green"></span> å·²è¼‰å…¥: ' + file.name;
    
    showSheetTabs();
    
    if (workbook.SheetNames.length > 0) {
      selectSheet(workbook.SheetNames[0]);
    }
  } catch (error) {
    console.error('è§£æéŒ¯èª¤:', error);
    alert('æª”æ¡ˆè§£æå¤±æ•—: ' + error.message);
  }
}

// ========== å·¥ä½œè¡¨æ“ä½œ ==========
function showSheetTabs() {
  const container = document.getElementById('sheetTabs');
  container.innerHTML = '';
  
  workbook.SheetNames.forEach(name => {
    const tab = document.createElement('button');
    tab.className = 'tab';
    tab.textContent = name;
    tab.onclick = () => selectSheet(name);
    container.appendChild(tab);
  });

  document.getElementById('uploadCard').classList.add('hidden');
  document.getElementById('sheetTabsCard').classList.remove('hidden');
}

function selectSheet(name) {
  currentSheetName = name;
  currentSheet = workbook.Sheets[name];
  
  document.querySelectorAll('#sheetTabs .tab').forEach(tab => {
    tab.classList.toggle('active', tab.textContent === name);
  });
  
  document.getElementById('sheetStatus').innerHTML = '<span class="status-dot green"></span> å·¥ä½œè¡¨: ' + name;
  
  parseOriginalData();
  
  document.getElementById('headerRowCard').classList.remove('hidden');
  autoDetectHeaderRow();
  
  renderExcelTable();
}

function parseOriginalData() {
  originalData = [];
  if (!currentSheet || !currentSheet['!ref']) return;
  
  const ref = currentSheet['!ref'];
  const range = parseRange(ref);
  
  for (let r = range.s.r; r <= range.e.r; r++) {
    const row = [];
    for (let c = range.s.c; c <= range.e.c; c++) {
      const addr = colToLetter(c + 1) + (r + 1);
      const cell = currentSheet[addr];
      row.push(cell ? (cell.w !== undefined ? cell.w : cell.v) : '');
    }
    originalData.push(row);
  }
}

function parseRange(ref) {
  const parts = ref.split(':');
  const start = parseCell(parts[0]);
  const end = parts[1] ? parseCell(parts[1]) : start;
  return { s: start, e: end };
}

function parseCell(addr) {
  const match = addr.match(/^([A-Z]+)(\d+)$/);
  if (!match) return { r: 0, c: 0 };
  let c = 0;
  for (let i = 0; i < match[1].length; i++) {
    c = c * 26 + (match[1].charCodeAt(i) - 64);
  }
  return { r: parseInt(match[2]) - 1, c: c - 1 };
}

function colToLetter(col) {
  let letter = '';
  while (col > 0) {
    const mod = (col - 1) % 26;
    letter = String.fromCharCode(65 + mod) + letter;
    col = Math.floor((col - 1) / 26);
  }
  return letter || 'A';
}

// ========== æ¨™é¡Œåˆ—åµæ¸¬ ==========
function autoDetectHeaderRow() {
  for (let i = 0; i < Math.min(10, originalData.length); i++) {
    const row = originalData[i];
    const nonEmptyCount = row.filter(cell => cell !== '').length;
    const hasKeywords = row.some(cell => 
      /å§“å|èº«åˆ†è­‰|è–ªè³‡|å¹´æœˆ|å“¡å·¥|ç·¨è™Ÿ|é‡‘é¡|ç™¼è–ª/.test(String(cell))
    );
    if (nonEmptyCount >= 3 && hasKeywords) {
      headerRow = i + 1;
      document.getElementById('headerRowInput').value = headerRow;
      updateHeaderPreview();
      return;
    }
  }
  updateHeaderPreview();
}

function updateHeaderPreview() {
  const row = originalData[headerRow - 1];
  if (row) {
    const preview = row.slice(0, 5).filter(c => c).join(', ') + (row.length > 5 ? '...' : '');
    document.getElementById('headerPreview').textContent = 'é è¦½: ' + preview;
  }
}

function confirmHeaderRow() {
  headerRow = parseInt(document.getElementById('headerRowInput').value) || 1;
  headers = originalData[headerRow - 1] || [];
  
  updateHeaderPreview();
  showSumColumnsSelection();
  updateMappingTable();
  renderExcelTable();
}

// ========== åŠ ç¸½èˆ‡æ‘˜è¦æ¬„ä½é¸æ“‡ ==========
function showSumColumnsSelection() {
  const tbody = document.getElementById('sumColumnsTableBody');
  tbody.innerHTML = '';
  selectedSumColumns = [];
  selectedSummaryColumns = [];
  
  // é—œéµå­—åˆ¤æ–·æ˜¯å¦ç‚ºé‡‘é¡/æ•¸å€¼æ¬„ä½
  const amountKeywords = ['è–ª', 'é¡', 'é‡‘', 'ç¨…', 'ä¿', 'è²»', 'æ‰£', 'Pay', 'Net', 'Total', 'Bonus', 'Tax', 'åˆè¨ˆ', 'å°è¨ˆ', 'çé‡‘'];
  
  headers.forEach((header, idx) => {
    if (!header || String(header).trim() === '') return;
    
    const hStr = String(header);
    // é è¨­å‹¾é¸é‚è¼¯ï¼šåŒ…å«é—œéµå­—
    const isDefaultChecked = amountKeywords.some(k => hStr.includes(k));
    
    if (isDefaultChecked) {
      selectedSumColumns.push(idx);
      selectedSummaryColumns.push(idx);
    }
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(header)}</td>
      <td style="text-align:center;">
        <input type="checkbox" value="${idx}" class="chk-subtotal" ${isDefaultChecked ? 'checked' : ''} onchange="updateSelectedCols()">
      </td>
      <td style="text-align:center;">
        <input type="checkbox" value="${idx}" class="chk-summary" ${isDefaultChecked ? 'checked' : ''} onchange="updateSelectedCols()">
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // æ›´æ–°å…¨é¸æŒ‰éˆ•ç‹€æ…‹
  document.getElementById('chkAllSubtotal').checked = false;
  document.getElementById('chkAllSummary').checked = false;
  
  document.getElementById('sumColumnsCard').classList.remove('hidden');
}

function toggleAllCol(source, type) {
  const className = type === 'subtotal' ? '.chk-subtotal' : '.chk-summary';
  document.querySelectorAll(className).forEach(chk => {
    chk.checked = source.checked;
  });
  updateSelectedCols();
}

function updateSelectedCols() {
  selectedSumColumns = [];
  selectedSummaryColumns = [];
  
  document.querySelectorAll('.chk-subtotal:checked').forEach(chk => {
    selectedSumColumns.push(parseInt(chk.value));
  });
  
  document.querySelectorAll('.chk-summary:checked').forEach(chk => {
    selectedSummaryColumns.push(parseInt(chk.value));
  });
}

// ========== æ¬„ä½æ˜ å°„ ==========
function openMappingModal() {
  updateMappingTable();
  document.getElementById('mappingModal').classList.add('show');
}

function closeMappingModal() {
  document.getElementById('mappingModal').classList.remove('show');
}

function updateMappingTable() {
  const tbody = document.getElementById('mappingTableBody');
  tbody.innerHTML = '';
  
  SYSTEM_FIELDS.forEach(field => {
    const tr = document.createElement('tr');
    
    let matchedIdx = -1;
    headers.forEach((h, idx) => {
      if (h && h === field.label) {
        matchedIdx = idx;
      }
    });
    
    tr.innerHTML = `
      <td>${field.label}${field.required ? ' <span style="color:red">*</span>' : ''}</td>
      <td>
        <select id="map_${field.key}">
          <option value="">-- æœªæ˜ å°„ --</option>
          ${headers.map((h, idx) => 
            h ? `<option value="${idx}" ${idx === matchedIdx ? 'selected' : ''}>${h}</option>` : ''
          ).join('')}
        </select>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function saveMapping() {
  SYSTEM_FIELDS.forEach(field => {
    const select = document.getElementById(`map_${field.key}`);
    if (select && select.value !== '') {
      columnMapping[field.key] = parseInt(select.value);
    } else {
      delete columnMapping[field.key];
    }
  });
  closeMappingModal();
  alert('æ¬„ä½æ˜ å°„å·²å„²å­˜ï¼');
}

// ========== å¾Œå°è¨­å®š ==========
function openSettingsModal() {
  applySettingsToUI();
  document.getElementById('settingsModal').classList.add('show');
}

function closeSettingsModal() {
  document.getElementById('settingsModal').classList.remove('show');
}

function saveSettings() {
  settings.salaryThreshold = parseInt(document.getElementById('salaryThreshold').value) || 20;
  settings.selfContributionTolerance = parseInt(document.getElementById('selfContributionTolerance').value) || 0;
  settings.taxCheckThreshold = parseInt(document.getElementById('taxCheckThreshold').value) || 88501;
  settings.taxRate = parseFloat(document.getElementById('taxRate').value) || 5;
  settings.checkIdUnique = document.getElementById('checkIdUnique').checked;
  settings.checkNameUnique = document.getElementById('checkNameUnique').checked;

  settings.primaryIdField = document.getElementById('primaryIdField').value;
  settings.secondaryIdField = document.getElementById('secondaryIdField').value;
  settings.groupByMethod = document.getElementById('groupByMethod').value;
  settings.showSubtotal = document.getElementById('showSubtotal').value;
  settings.targetYears = document.getElementById('targetYears').value;
  
  localStorage.setItem('payrollAnalyzerSettings_v1_1', JSON.stringify(settings));
  updateLastUpdate();
  closeSettingsModal();
  alert('è¨­å®šå·²å„²å­˜è‡³æœ¬æ©Ÿï¼');
}

function resetSettings() {
  localStorage.removeItem('payrollAnalyzerSettings_v1_1');
  loadSettings();
  alert('å·²é‡ç½®ç‚ºé è¨­å€¼');
}

// ========== Excel è¡¨æ ¼æ¸²æŸ“ ==========
function renderExcelTable() {
  const container = document.getElementById('excelContainer');
  
  if (originalData.length === 0) {
    container.innerHTML = '<p style="padding:20px;text-align:center;">ç„¡è³‡æ–™</p>';
    return;
  }
  
  let html = '<table class="excel-table"><thead><tr>';
  html += '<th class="corner"></th>';
  
  const colCount = Math.max(...originalData.map(r => r.length));
  for (let c = 0; c < colCount; c++) {
    html += `<th>${colToLetter(c + 1)}</th>`;
  }
  html += '</tr></thead><tbody>';
  
  originalData.forEach((row, rowIdx) => {
    const isHeaderRow = rowIdx === headerRow - 1;
    html += `<tr${isHeaderRow ? ' style="background:#e0f2fe;"' : ''}>`;
    html += `<td class="row-header">${rowIdx + 1}</td>`;
    
    for (let c = 0; c < colCount; c++) {
      const cellAddr = colToLetter(c + 1) + (rowIdx + 1);
      const value = row[c] !== undefined ? row[c] : '';
      html += `<td data-addr="${cellAddr}">${escapeHtml(String(value))}</td>`;
    }
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
  
  document.getElementById('excelCard').classList.remove('hidden');
  document.getElementById('excelInfo').textContent = `${originalData.length} åˆ— Ã— ${colCount} æ¬„`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ========== åŸ·è¡Œåˆ†æ ==========
function runAnalysis() {
  if (originalData.length === 0) {
    alert('è«‹å…ˆä¸Šå‚³ä¸¦é¸æ“‡å·¥ä½œè¡¨');
    return;
  }
  
  errors = [];
  summaryData = {};
  employeeBlocks = [];
  
  if (!headers || headers.length === 0) {
    confirmHeaderRow();
  }
  
  // è‡ªå‹•å˜—è©¦æ˜ å°„æ¬„ä½
  autoMapColumns();
  
  // è­˜åˆ¥å“¡å·¥å€å¡Š
  identifyEmployeeBlocks();
  
  // åŸ·è¡Œæ ¸å°è¦å‰‡
  runValidationRules();
  
  // è¨ˆç®—å¹´åº¦åˆ†çµ„æ•¸æ“š
  calculateYearlyData();
  
  // æ¸²æŸ“å¸¶å¤–æ›å±¤çš„è¡¨æ ¼ï¼ˆå«æ‘˜è¦å€ï¼‰
  renderTableWithAddons();
  
  // é¡¯ç¤ºéŒ¯èª¤æ¸…å–®
  renderErrorList();
  
  // é¡¯ç¤ºåˆ—å°å€
  document.getElementById('printCard').classList.remove('hidden');
  
  // æ›´æ–°ç‹€æ…‹
  document.getElementById('errorStatus').innerHTML = 
    `<span class="status-dot ${errors.length > 0 ? 'red' : 'green'}"></span> éŒ¯èª¤: ${errors.length}`;
}

// ========== è‡ªå‹•æ˜ å°„æ¬„ä½ ==========
function autoMapColumns() {
  if (Object.keys(columnMapping).length > 0) return;
  
  headers.forEach((h, idx) => {
    if (!h) return;
    const hStr = String(h).trim();
    
    // å„ªå…ˆåŒ¹é…å®Œå…¨ç›¸ç¬¦çš„
    if (hStr === 'å“¡å·¥ä»£è™Ÿ') columnMapping.employeeId = idx;
    else if (hStr === 'å“¡å·¥å§“å') columnMapping.name = idx;
    else if (hStr === 'èº«åˆ†è­‰å­—è™Ÿ') columnMapping.idNumber = idx;
    else if (hStr === 'å¹´åº¦') columnMapping.year = idx;
    
    // æ¨¡ç³ŠåŒ¹é…
    if (columnMapping.employeeId === undefined && /ä»£è™Ÿ|ç·¨è™Ÿ|Employee/.test(hStr)) columnMapping.employeeId = idx;
    if (columnMapping.name === undefined && /å§“å|Name/.test(hStr)) columnMapping.name = idx;
    if (columnMapping.idNumber === undefined && /èº«åˆ†è­‰|èº«ä»½è­‰/.test(hStr)) columnMapping.idNumber = idx;
    if (columnMapping.address === undefined && /åœ°å€|Address/.test(hStr)) columnMapping.address = idx;
    if (columnMapping.category === undefined && /é¡åˆ¥|Category/.test(hStr)) columnMapping.category = idx;
    if (columnMapping.year === undefined && (/å¹´åº¦|Year/.test(hStr) && !/å¹´çµ‚/.test(hStr))) columnMapping.year = idx;
    if (columnMapping.month === undefined && /æœˆä»½|Month|ç™¼è–ªæœˆ/.test(hStr)) columnMapping.month = idx;
    
    if (columnMapping.salary === undefined && /è–ªè³‡|æœ¬è–ª|Salary/.test(hStr) && !/æ·¨é¡/.test(hStr)) columnMapping.salary = idx;
    if (columnMapping.netPay === undefined && /æ·¨é¡|Net/.test(hStr)) columnMapping.netPay = idx;
    if (columnMapping.selfContribution === undefined && /è‡ªæ|å‹å¥ä¿/.test(hStr)) columnMapping.selfContribution = idx;
    if (columnMapping.bonus === undefined && /çé‡‘|Bonus/.test(hStr) && !/å¹´çµ‚/.test(hStr)) columnMapping.bonus = idx;
    if (columnMapping.tax === undefined && /æ‰€å¾—ç¨…|Tax/.test(hStr)) columnMapping.tax = idx;
    if (columnMapping.totalPay === undefined && /åˆè¨ˆ|Total/.test(hStr)) columnMapping.totalPay = idx;
    if (columnMapping.yearEndBonus === undefined && /å¹´çµ‚/.test(hStr)) columnMapping.yearEndBonus = idx;
  });
}

// ========== å“¡å·¥å€å¡Šè­˜åˆ¥ ==========
function identifyEmployeeBlocks() {
  const nameIdx = columnMapping.name;
  const idIdx = columnMapping.idNumber;
  
  const employees = new Map();
  
  for (let r = headerRow; r < originalData.length; r++) {
    const row = originalData[r];
    const name = nameIdx !== undefined ? String(row[nameIdx] || '').trim() : '';
    const id = idIdx !== undefined ? String(row[idIdx] || '').trim() : '';
    
    if (!name && !id) continue;
    
    const key = `${id}_${name}`;
    
    if (!employees.has(key)) {
      employees.set(key, {
        name,
        idNumber: id,
        rows: [],
        startRow: r,
        endRow: r
      });
    }
    
    const emp = employees.get(key);
    emp.rows.push(r);
    emp.endRow = r;
  }
  
  employeeBlocks = Array.from(employees.values());
}

// ========== å–å¾—å¹´åº¦ ==========
function getYearFromRow(row) {
  // å„ªå…ˆä½¿ç”¨å–®ç¨çš„å¹´åº¦æ¬„ä½
  if (columnMapping.year !== undefined) {
    const y = String(row[columnMapping.year] || '').trim();
    if (y) {
      let match = y.match(/^(\d{2,4})/);
      if (match) {
        let yr = parseInt(match[1]);
        if (yr > 1900) yr -= 1911; // è¥¿å…ƒè½‰æ°‘åœ‹
        return String(yr);
      }
      return y;
    }
  }

  // å‚™ç”¨ï¼šå¹´æœˆæˆ–ç™¼è–ªæœˆ
  let ymIdx = columnMapping.month; // é€™è£¡å¯¦éš›ä¸Šå¯èƒ½æ˜¯å¹´æœˆæ··åˆ
  if (ymIdx !== undefined) {
    const ym = String(row[ymIdx] || '');
    // æ”¯æ´ 113/01, 113-01, 2024/01, 11301 ç­‰æ ¼å¼
    let match = ym.match(/^(\d{2,4})[\/\-]?\d{1,2}/);
    if (match) {
      let yr = parseInt(match[1]);
      if (yr > 1900) yr -= 1911;
      return String(yr);
    }
  }
  
  return 'æœªåˆ†é¡';
}

// ========== è¨ˆç®—å¹´åº¦åˆ†çµ„æ•¸æ“š ==========
function calculateYearlyData() {
  // å»ºç«‹éœ€è¦è¨ˆç®—çš„æ¬„ä½è¯é›† (å°è¨ˆ + æ‘˜è¦)
  const allCalcCols = new Set([...selectedSumColumns, ...selectedSummaryColumns]);
  
  // ç‚ºæ¯å€‹å“¡å·¥å€å¡Šè¨ˆç®—å¹´åº¦åˆ†çµ„
  employeeBlocks.forEach(block => {
    block.yearlyData = {};
    
    allCalcCols.forEach(colIdx => {
      block.yearlyData[colIdx] = {};
    });
    
    block.rows.forEach(r => {
      const row = originalData[r];
      const year = getYearFromRow(row);
      
      allCalcCols.forEach(colIdx => {
        const valStr = String(row[colIdx] || 0).replace(/,/g, '');
        const val = parseFloat(valStr);
        // æ’é™¤éæ•¸å€¼
        if (!isNaN(val)) {
          if (!block.yearlyData[colIdx][year]) {
            block.yearlyData[colIdx][year] = 0;
          }
          block.yearlyData[colIdx][year] += val;
        }
      });
    });
  });
  
  // è¨ˆç®—å…¨è¡¨æ‘˜è¦ï¼ˆæ‰€æœ‰å“¡å·¥åˆè¨ˆï¼‰
  summaryData = {};
  selectedSummaryColumns.forEach(colIdx => {
    const colName = headers[colIdx];
    summaryData[colIdx] = { name: colName, years: {}, total: 0 };
    
    for (let r = headerRow; r < originalData.length; r++) {
      const row = originalData[r];
      const year = getYearFromRow(row);
      const val = parseFloat(String(row[colIdx] || 0).replace(/,/g, ''));
      
      if (!isNaN(val)) {
        if (!summaryData[colIdx].years[year]) {
          summaryData[colIdx].years[year] = 0;
        }
        summaryData[colIdx].years[year] += val;
        summaryData[colIdx].total += val;
      }
    }
  });
}

// ========== æ ¸å°è¦å‰‡ ==========
function runValidationRules() {
  const nameIdx = columnMapping.name;
  const idIdx = columnMapping.idNumber;
  const salaryIdx = columnMapping.salary;
  const taxIdx = columnMapping.tax;
  
  // æº–å‚™äº¤å‰æª¢æŸ¥çš„ Map
  // çµæ§‹: { 'A123456789': { 'ç‹å°æ˜': ['A2'], 'ç‹å¤§æ˜': ['A5'] } }
  const idToNames = {}; 
  const nameToIds = {};

  // 1. åŸºæœ¬åˆ—è³‡æ–™æª¢æŸ¥
  for (let r = headerRow; r < originalData.length; r++) {
    const row = originalData[r];
    const rowNum = r + 1;
    const name = nameIdx !== undefined ? String(row[nameIdx] || '').trim() : '';
    const idNumber = idIdx !== undefined ? String(row[idIdx] || '').trim() : '';
    
    // æª¢æŸ¥å§“å
    if (nameIdx !== undefined) {
      if (!name) {
        const addr = colToLetter(nameIdx + 1) + rowNum;
        errors.push({
          type: 'warning',
          coord: addr,
          column: headers[nameIdx],
          message: 'å§“åæ¬„ä½ç‚ºç©º',
          expected: 'æ‡‰æœ‰å§“å',
          actual: 'ç©ºç™½'
        });
      }
    }
    
    // æª¢æŸ¥èº«åˆ†è­‰æ ¼å¼ (å¦‚æœæœ‰æ˜ å°„)
    if (idIdx !== undefined && idNumber) {
      if (!/^[A-Z][12]\d{8}$/.test(idNumber)) {
        const addr = colToLetter(idIdx + 1) + rowNum;
        errors.push({
          type: 'error',
          coord: addr,
          column: headers[idIdx],
          message: 'èº«åˆ†è­‰æ ¼å¼ä¸æ­£ç¢º',
          expected: 'æ ¼å¼ï¼šA123456789',
          actual: idNumber
        });
      }
    }

    // äº¤å‰æª¢æŸ¥è³‡æ–™æ”¶é›†: èº«åˆ†è­‰ <-> å§“å (æ’é™¤ç©ºå€¼)
    if (name && idNumber) {
        const addrId = colToLetter(idIdx + 1) + rowNum;
        const addrName = colToLetter(nameIdx + 1) + rowNum;

        // æª¢æŸ¥ ID Number -> Name
        if (!idToNames[idNumber]) idToNames[idNumber] = {};
        if (!idToNames[idNumber][name]) idToNames[idNumber][name] = [];
        idToNames[idNumber][name].push(addrId);

        // æª¢æŸ¥ Name -> ID Number
        if (!nameToIds[name]) nameToIds[name] = {};
        if (!nameToIds[name][idNumber]) nameToIds[name][idNumber] = [];
        nameToIds[name][idNumber].push(addrName);
    }
    
    // è–ªè³‡æ‰€å¾—ç¨…é‚è¼¯æª¢æŸ¥
    if (salaryIdx !== undefined && taxIdx !== undefined) {
      const salaryVal = parseFloat(String(row[salaryIdx] || 0).replace(/,/g, ''));
      const taxVal = parseFloat(String(row[taxIdx] || 0).replace(/,/g, ''));
      const threshold = settings.taxCheckThreshold || 88501;
      const rate = (settings.taxRate || 5) / 100;
      
      if (!isNaN(salaryVal) && !isNaN(taxVal)) {
        if (salaryVal > threshold) {
          // ç°¡å–®è¨ˆç®—ï¼šè–ªè³‡ * ç¨…ç‡ï¼Œå…è¨± +/- 1 çš„èª¤å·® (å››æ¨äº”å…¥æˆ–ç„¡æ¢ä»¶æ¨å»å•é¡Œ)
          const expectedTax = Math.floor(salaryVal * rate);
          const tolerance = 1;
          
          if (Math.abs(taxVal - expectedTax) > tolerance) {
             const addr = colToLetter(taxIdx + 1) + rowNum;
             errors.push({
               type: 'error',
               coord: addr,
               column: headers[taxIdx],
               message: 'æ‰€å¾—ç¨…è¨ˆç®—ç•°å¸¸',
               expected: `ç´„ ${expectedTax} (è–ªè³‡ > ${threshold} ä¸”ç¨…ç‡ ${settings.taxRate}%)`,
               actual: String(taxVal)
             });
          }
        }
      }
    }
    
    // æª¢æŸ¥é¸å®šçš„æ•¸å€¼æ¬„ä½è² æ•¸
    const checkCols = new Set([...selectedSumColumns, ...selectedSummaryColumns]);
    checkCols.forEach(colIdx => {
      const val = row[colIdx];
      if (val !== '' && val !== undefined && val !== null) {
        const numVal = parseFloat(String(val).replace(/,/g, ''));
        if (isNaN(numVal)) {
          // å…è¨±éæ•¸å€¼æ–‡å­—
        } else if (numVal < 0) {
          const addr = colToLetter(colIdx + 1) + rowNum;
          errors.push({
            type: 'warning',
            coord: addr,
            column: headers[colIdx],
            message: 'è² æ•¸å€¼',
            expected: 'æ­£æ•¸æˆ–é›¶',
            actual: String(numVal)
          });
        }
      }
    });
  }

  // åŸ·è¡Œäº¤å‰æª¢æŸ¥åˆ†æ
  // 1. ç”¢å‡ºéŒ¯èª¤ï¼šå–®ä¸€ èº«åˆ†è­‰ å°æ‡‰å¤šå€‹ä¸åŒå§“å (è‹¥è¨­å®šå•Ÿç”¨)
  if (settings.checkIdUnique !== false) {
    Object.keys(idToNames).forEach(id => {
      const names = Object.keys(idToNames[id]);
      if (names.length > 1) {
        const desc = names.map(n => `${n}(${idToNames[id][n].length}ç­†)`).join(', ');
        names.forEach(n => {
          idToNames[id][n].forEach(coord => {
              errors.push({
              type: 'error',
              coord: coord,
              column: headers[idIdx],
              message: 'èº«åˆ†è­‰å°æ‡‰å¤šå€‹ä¸åŒå§“å',
              expected: 'å–®ä¸€èº«åˆ†è­‰æ‡‰å°æ‡‰å”¯ä¸€å§“å',
              actual: `ID ${id} å°æ‡‰: ${desc}`
            });
          });
        });
      }
    });
  }

  // 2. ç”¢å‡ºéŒ¯èª¤ï¼šå–®ä¸€ å§“å å°æ‡‰å¤šå€‹ä¸åŒèº«åˆ†è­‰ (è‹¥è¨­å®šå•Ÿç”¨)
  if (settings.checkNameUnique !== false) {
    Object.keys(nameToIds).forEach(name => {
      const ids = Object.keys(nameToIds[name]);
      if (ids.length > 1) {
        const desc = ids.map(id => `${id}(${nameToIds[name][id].length}ç­†)`).join(', ');
        ids.forEach(id => {
          nameToIds[name][id].forEach(coord => {
              errors.push({
              type: 'error',
              coord: coord,
              column: headers[nameIdx],
              message: 'å§“åå°æ‡‰å¤šå€‹ä¸åŒèº«åˆ†è­‰',
              expected: 'å–®ä¸€å§“åæ‡‰å°æ‡‰å”¯ä¸€èº«åˆ†è­‰',
              actual: `å§“å ${name} å°æ‡‰: ${desc}`
            });
          });
        });
      }
    });
  }
}

// ========== æ ¼å¼åŒ–æ•¸å­— ==========
function formatNumber(num) {
  if (typeof num !== 'number' || isNaN(num)) return '0';
  return num.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

// ========== ç”Ÿæˆå¹´åº¦åˆ†çµ„å­—ä¸² ==========
function generateYearlyString(yearData) {
  let years = Object.keys(yearData).filter(y => y !== 'æœªåˆ†é¡').sort();
  
  // è™•ç†å¾Œå°è¨­å®šçš„ç›®æ¨™å¹´åº¦éæ¿¾
  if (settings.targetYears) {
    const targetSet = new Set(settings.targetYears.split(/[,ï¼Œ]/).map(y => y.trim()));
    if (targetSet.size > 0) {
      years = years.filter(y => targetSet.has(y));
    }
  }

  if (yearData['æœªåˆ†é¡']) years.push('æœªåˆ†é¡');
  
  // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œç›´æ¥è¿”å›
  if (years.length === 0) return '';

  let total = 0;
  const parts = years.map(year => {
    const val = yearData[year] || 0;
    total += val;
    return `${year}(${formatNumber(val)})`;
  });
  
  // è¨ˆç®—ç¸½è¨ˆ (åŒ…å«æœªé¡¯ç¤ºçš„å¹´åº¦å—ï¼Ÿ é€™è£¡å‡è¨­Totalæ‡‰åŒ…å«æ‰€æœ‰æ•¸æ“šï¼Œé‚„æ˜¯åªåŒ…å«é¡¯ç¤ºçš„ï¼Ÿ
  // æ ¹æ“šå…§æ§é‚è¼¯ï¼ŒTotalé€šå¸¸æŒ‡è©²å“¡å·¥è©²æ¬„ä½çš„åŠ ç¸½ã€‚
  // ä½†é¡¯ç¤ºæ ¼å¼ç‚º 113(...), 114(...)=Total(...)ï¼Œéš±å« Total æ˜¯å‰é¢é …ç›®çš„åŠ ç¸½ã€‚
  // å› æ­¤é€™è£¡ Total åªåŠ ç¸½æœ‰é¡¯ç¤ºçš„éƒ¨åˆ†ã€‚
  
  return parts.join(',') + `=Total(${formatNumber(total)})`;
}

// ========== æ¸²æŸ“å¸¶å¤–æ›å±¤çš„è¡¨æ ¼ ==========
function renderTableWithAddons() {
  const container = document.getElementById('excelContainer');
  const colCount = Math.max(...originalData.map(r => r.length));
  
  let html = '<table class="excel-table"><thead><tr>';
  html += '<th class="corner"></th>';
  for (let c = 0; c < colCount; c++) {
    html += `<th>${colToLetter(c + 1)}</th>`;
  }
  html += '</tr></thead><tbody>';
  
  // å»ºç«‹éŒ¯èª¤åº§æ¨™é›†åˆ
  const errorCoords = new Set(errors.map(e => e.coord));
  
  // æ‰¾å‡ºæ¯å€‹å“¡å·¥å€å¡Šçš„çµæŸåˆ—
  const blockEndRows = new Map();
  employeeBlocks.forEach(block => {
    blockEndRows.set(block.endRow, block);
  });
  
  // æ¸²æŸ“åŸå§‹è³‡æ–™
  let addonRowCount = 0;
  originalData.forEach((row, rowIdx) => {
    const isHeaderRow = rowIdx === headerRow - 1;
    html += `<tr${isHeaderRow ? ' style="background:#e0f2fe;"' : ''}>`;
    html += `<td class="row-header">${rowIdx + 1}</td>`;
    
    for (let c = 0; c < colCount; c++) {
      const cellAddr = colToLetter(c + 1) + (rowIdx + 1);
      const value = row[c] !== undefined ? row[c] : '';
      const hasError = errorCoords.has(cellAddr);
      const errorType = hasError ? errors.find(e => e.coord === cellAddr)?.type : '';
      
      html += `<td data-addr="${cellAddr}" class="${hasError ? (errorType === 'error' ? 'error-cell' : 'highlight-cell') : ''}" onclick="highlightCell('${cellAddr}')">${escapeHtml(String(value))}</td>`;
    }
    html += '</tr>';
    
    // æ’å…¥å“¡å·¥å€å¡Šå°è¨ˆå¤–æ›åˆ—ï¼ˆå¹´åº¦åˆ†çµ„ï¼‰
    if (blockEndRows.has(rowIdx)) {
      const block = blockEndRows.get(rowIdx);
      addonRowCount++;
      
      html += `<tr class="addon-row">`;
      html += `<td class="row-header" style="background:var(--addon-bg);font-size:10px;">å¤–æ›</td>`;
      
      for (let c = 0; c < colCount; c++) {
        // å„ªå…ˆé¡¯ç¤ºåŠ ç¸½æ•¸å€¼
        if (selectedSumColumns.includes(c)) {
          if (block.yearlyData && block.yearlyData[c]) {
            const yearData = block.yearlyData[c];
            const yearStr = generateYearlyString(yearData);
            html += `<td style="font-size:11px;font-weight:bold;color:#b45309;">${yearStr}</td>`;
          } else {
            html += `<td></td>`;
          }
        } 
        // éåŠ ç¸½æ¬„ä½çš„ç¬¬ä¸€æ¬„é¡¯ç¤ºæ¨™ç±¤
        else if (c === 0) {
          html += `<td><span class="addon-badge">å¤–æ›</span>åˆ†çµ„å°è¨ˆ</td>`;
        } 
        // å…¶ä»–ç©ºç™½
        else {
          html += `<td></td>`;
        }
      }
      html += '</tr>';
    }
  });
  
  // ========== è¡¨æ ¼æœ€ä¸‹æ–¹æ‘˜è¦å€ï¼ˆå¤–æ›ï¼‰==========
  if (selectedSummaryColumns.length > 0) {
    // ç©ºç™½åˆ†éš”è¡Œ
    html += `<tr class="summary-row"><td class="row-header" style="background:var(--summary-bg);"></td>`;
    html += `<td colspan="${colCount}" style="text-align:center;font-weight:bold;background:var(--summary-bg);border-top:3px solid var(--summary-border);">`;
    html += `<span class="summary-badge">å¤–æ›</span>ğŸ“Š è¡¨æ ¼æ‘˜è¦å€`;
    html += `</td></tr>`;
    
    // æ¯å€‹æ¬„ä½çš„æ‘˜è¦
    selectedSummaryColumns.forEach(colIdx => {
      const data = summaryData[colIdx];
      if (!data) return;
      
      const yearStr = generateYearlyString(data.years);
      
      html += `<tr class="summary-row">`;
      html += `<td class="row-header" style="background:var(--summary-bg);font-size:10px;">æ‘˜è¦</td>`;
      html += `<td colspan="${colCount}" style="font-family:monospace;font-size:12px;">`;
      html += `<strong>${escapeHtml(data.name)}:</strong> ${yearStr}`;
      html += `</td></tr>`;
    });
  }
  
  html += '</tbody></table>';
  container.innerHTML = html;
  
  document.getElementById('excelInfo').textContent = 
    `${originalData.length} åˆ— Ã— ${colCount} æ¬„ | å¤–æ›åˆ—: ${addonRowCount} | é¸å®šæ¬„ä½: ${selectedSumColumns.length}`;
}

function highlightCell(addr) {
  document.querySelectorAll('.excel-table td').forEach(td => {
    if (!td.classList.contains('error-cell')) {
      td.classList.remove('highlight-cell');
    }
  });
  const cell = document.querySelector(`td[data-addr="${addr}"]`);
  if (cell) {
    cell.classList.add('highlight-cell');
    cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// ========== éŒ¯èª¤æ¸…å–® ==========
function renderErrorList() {
  const container = document.getElementById('errorList');
  
  if (errors.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--success);padding:20px;">âœ… ç„¡æ ¸å°éŒ¯èª¤</p>';
    document.getElementById('errorCard').classList.remove('hidden');
    return;
  }
  
  let html = '';
  errors.forEach((err, idx) => {
    html += `
      <div class="error-item" onclick="highlightCell('${err.coord}')">
        <span class="error-coord ${err.type}">${err.coord}</span>
        <div class="error-desc">
          <strong>${err.column}</strong>: ${err.message}
          ${err.expected ? `<br><span class="text-sm text-gray">æœŸæœ›: ${err.expected} | å¯¦éš›: ${err.actual}</span>` : ''}
        </div>
        <button class="btn btn-outline copy-btn" onclick="event.stopPropagation();copyError(${idx})">è¤‡è£½</button>
      </div>
    `;
  });
  
  container.innerHTML = html;
  document.getElementById('errorCard').classList.remove('hidden');
}

function copyError(idx) {
  const err = errors[idx];
  const text = `${err.coord}\t${err.column}\t${err.message}\tæœŸæœ›:${err.expected || '-'}\tå¯¦éš›:${err.actual || '-'}`;
  copyToClipboard(text);
}

function copyAllErrors() {
  const text = errors.map(err => 
    `${err.coord}\t${err.column}\t${err.message}\tæœŸæœ›:${err.expected || '-'}\tå¯¦éš›:${err.actual || '-'}`
  ).join('\n');
  copyToClipboard(text);
}

function exportErrors() {
  const text = 'åº§æ¨™\tæ¬„ä½\tå•é¡Œæè¿°\tæœŸæœ›å€¼\tå¯¦éš›å€¼\n' + errors.map(err => 
    `${err.coord}\t${err.column}\t${err.message}\t${err.expected || '-'}\t${err.actual || '-'}`
  ).join('\n');
  downloadText('errors_' + new Date().toISOString().slice(0,10) + '.txt', text);
}

// ========== åˆ—å° ==========
function printReport() {
  const orientation = document.getElementById('printOrientation').value;
  const fitWidth = document.getElementById('printFitWidth').checked;
  const scalePercent = document.getElementById('printScale').value || 100;
  
  const container = document.getElementById('excelContainer');
  const originalStyle = container.getAttribute('style') || '';
  
  // æš«æ™‚èª¿æ•´å®¹å™¨æ¨£å¼ä»¥é©æ‡‰åˆ—å°
  container.style.maxHeight = 'none';
  container.style.overflow = 'visible';
  container.style.border = 'none'; // é¿å…é‚Šæ¡†é‡ç–Š
  
  // åŠ å…¥åˆ—å°ç”¨ style
  const style = document.createElement('style');
  style.id = 'print-style';
  
  let css = `@page { size: ${orientation}; margin: 10mm; }`;
  css += `@media print { 
    body { -webkit-print-color-adjust: exact; } 
    .no-print { display: none !important; }
    .container { width: 100% !important; max-width: none !important; margin: 0 !important; padding: 0 !important; }
    .card { box-shadow: none !important; border: none !important; margin: 0 !important; }
    .excel-container { overflow: visible !important; max-height: none !important; }
  `;
  
  // è™•ç†ç¸®æ”¾
  if (fitWidth) {
    // è‡ªå‹•è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ (å‡è¨­ A4 å¯¬åº¦ç´„ 210mm/297mm)
    // é€™è£¡ç°¡å–®ä½¿ç”¨ CSS zoom æˆ– transform
    css += `
      .excel-table { width: 100% !important; }
    `;
  } else {
    if (scalePercent != 100) {
      css += `
        .excel-table { zoom: ${scalePercent}%; }
      `;
    }
  }
  
  css += `}`;
  style.textContent = css;
  document.head.appendChild(style);
  
  window.print();
  
  // å¾©åŸ
  setTimeout(() => {
    const s = document.getElementById('print-style');
    if (s) s.remove();
    container.setAttribute('style', originalStyle);
  }, 500);
}

// ========== å·¥å…·å‡½æ•¸ ==========
function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    });
  } else {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
  }
}

function downloadText(filename, text) {
  const blob = new Blob(['\ufeff' + text], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function showToast(message) {
  const existing = document.querySelector('.toast-msg');
  if (existing) existing.remove();
  
  const toast = document.createElement('div');
  toast.className = 'toast-msg';
  toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1f2937;color:white;padding:12px 24px;border-radius:8px;z-index:9999;';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2000);
}

// ========== PDF åŒ¯å‡º ==========
async function exportToPDF() {
  if (!window.jspdf || !window.html2canvas) {
    alert('PDF æ¨¡çµ„å°šæœªè¼‰å…¥ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šï¼ˆæ­¤åŠŸèƒ½éœ€ CDNï¼‰');
    return;
  }
  
  const btn = document.getElementById('btnExportPdf');
  const originalHtml = btn.innerHTML;
  btn.innerHTML = 'â³ è™•ç†ä¸­...';
  btn.disabled = true;

  try {
    const { jsPDF } = window.jspdf;
    const orientation = document.getElementById('printOrientation').value;
    const element = document.getElementById('excelContainer');
    
    // æš«æ™‚ç§»é™¤å®¹å™¨é™åˆ¶ä»¥æˆªå–å®Œæ•´å…§å®¹
    const originalMaxHeight = element.style.maxHeight;
    const originalOverflow = element.style.overflow;
    const originalBorder = element.style.border;
    const originalPadding = element.style.padding;
    
    element.style.maxHeight = 'none';
    element.style.overflow = 'visible';
    element.style.border = 'none';
    element.style.padding = '10px'; // åŠ å…¥å…§è·ç¢ºä¿é‚Šæ¡†è¢«æˆªå–

    // ä½¿ç”¨ html2canvas æˆªåœ–
    // æé«˜ scale ä»¥ç²å¾—æ›´å¥½çš„æ¸…æ™°åº¦
    const canvas = await html2canvas(element, { 
      scale: 2, 
      logging: false,
      useCORS: true,
      backgroundColor: '#ffffff'
    });

    // å¾©åŸæ¨£å¼
    element.style.maxHeight = originalMaxHeight;
    element.style.overflow = originalOverflow;
    element.style.border = originalBorder;
    element.style.padding = originalPadding;

    const imgData = canvas.toDataURL('image/jpeg', 0.85);
    
    const pdf = new jsPDF({
      orientation: orientation,
      unit: 'mm',
      format: 'a4'
    });

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
    
    let heightLeft = imgHeight;
    let position = 0;

    // ç¬¬ä¸€é 
    pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
    heightLeft -= pdfHeight;

    // å¾ŒçºŒé é¢
    while (heightLeft > 0) {
      position = heightLeft - imgHeight; // é€™è£¡çš„é‚è¼¯æ˜¯è² çš„ä½ç§»
      // ä¿®æ­£é‚è¼¯ï¼šæ¯æ¬¡ addPage å¾Œï¼Œåœ–ç‰‡è¦å¾€ä¸Šç§»ä¸€é çš„é«˜åº¦
      // æˆ‘å€‘ä½¿ç”¨ç´¯ç©çš„è² ä½ç§»
      
      pdf.addPage();
      
      // å‡è¨­ç¬¬ä¸€é å°äº† 0 ~ 297mm
      // ç¬¬äºŒé è¦å° 297 ~ 594mm çš„å…§å®¹ï¼ŒæŠŠå®ƒæ”¾åœ¨ PDF çš„ y=0 è™•
      // æ‰€ä»¥ y åº§æ¨™æ‡‰è©²æ˜¯ -297mm
      
      // é‡æ–°è¨ˆç®— position
      // ç¬¬ n é çš„ position æ‡‰è©²æ˜¯ -1 * (n-1) * pdfHeight
      const currentPageIndex = pdf.internal.getNumberOfPages(); // 1-based, now it's 2
      const yOffset = -1 * (currentPageIndex - 1) * pdfHeight;
      
      pdf.addImage(imgData, 'JPEG', 0, yOffset, pdfWidth, imgHeight);
      heightLeft -= pdfHeight;
    }
    
    pdf.save('payroll_analysis_' + new Date().toISOString().slice(0,10) + '.pdf');

  } catch (err) {
    console.error(err);
    alert('PDF åŒ¯å‡ºå¤±æ•—: ' + err.message);
  } finally {
    btn.innerHTML = originalHtml;
    btn.disabled = false;
  }
}
</script>
</body>
</html>
