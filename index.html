<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›¢ç·šå„ªå…ˆå·¥ä½œç´€éŒ„ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Dexie.js - IndexedDB -->
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <!-- Day.js -->
    <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/isoWeek.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/customParseFormat.min.js"></script>
    <!-- RRule -->
    <script src="https://unpkg.com/rrule@2.7.2/dist/es5/rrule.min.js"></script>
    <!-- Fuse.js -->
    <script src="https://unpkg.com/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <!-- SortableJS -->
    <script src="https://unpkg.com/sortablejs@1.15.2/Sortable.min.js"></script>
    <!-- Markdown-it -->
    <script src="https://unpkg.com/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- DOMPurify -->
    <script src="https://unpkg.com/dompurify@3.0.8/dist/purify.min.js"></script>
    <!-- jsPDF -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
        .sortable-chosen { background: #f0f9ff; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .markdown-body h1 { font-size: 1.5em; font-weight: bold; margin: 0.5em 0; }
        .markdown-body h2 { font-size: 1.25em; font-weight: bold; margin: 0.5em 0; }
        .markdown-body ul { list-style: disc; margin-left: 1.5em; }
        .markdown-body ol { list-style: decimal; margin-left: 1.5em; }
        .markdown-body code { background: #f3f4f6; padding: 0.2em 0.4em; border-radius: 3px; }
        .markdown-body pre { background: #1f2937; color: #e5e7eb; padding: 1em; border-radius: 6px; overflow-x: auto; }
        .markdown-body blockquote { border-left: 4px solid #d1d5db; padding-left: 1em; color: #6b7280; }
        .period-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 9999px; }
        .offline-indicator { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator hidden">
        <span class="bg-yellow-500 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m-3.536-3.536a4 4 0 010-5.656m-7.072 7.072a4 4 0 010-5.656m-3.536 3.536a9 9 0 010-12.728"/>
            </svg>
            é›¢ç·šæ¨¡å¼
        </span>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-800">ğŸ“‹ å·¥ä½œç´€éŒ„ç³»çµ±</h1>
                <div class="flex items-center gap-4">
                    <!-- Period Selector -->
                    <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                        <button onclick="navigatePeriod(-1)" class="p-2 hover:bg-white rounded transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <span id="currentPeriodLabel" class="px-3 py-1 font-medium min-w-[180px] text-center"></span>
                        <button onclick="navigatePeriod(1)" class="p-2 hover:bg-white rounded transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                    <!-- Period Type Toggle -->
                    <select id="periodTypeSelect" onchange="changePeriodType(this.value)" class="border rounded-lg px-3 py-2">
                        <option value="week">æ¯é€±</option>
                        <option value="month">æ¯æœˆ</option>
                        <option value="customCutoff">è‡ªè¨‚çµç®—æ—¥</option>
                    </select>
                    <!-- Settings -->
                    <button onclick="openSettings()" class="p-2 hover:bg-gray-100 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex gap-6">
                <button onclick="switchTab('checklist')" data-tab="checklist" class="tab-btn py-3 px-2 font-medium text-gray-600 hover:text-gray-900 tab-active">
                    âœ… æœ¬æœŸæ ¸å°
                </button>
                <button onclick="switchTab('todos')" data-tab="todos" class="tab-btn py-3 px-2 font-medium text-gray-600 hover:text-gray-900">
                    ğŸ“ å¾…è¾¦äº‹é …
                </button>
                <button onclick="switchTab('worklog')" data-tab="worklog" class="tab-btn py-3 px-2 font-medium text-gray-600 hover:text-gray-900">
                    ğŸ““ å·¥ä½œç´€éŒ„
                </button>
                <button onclick="switchTab('recurring')" data-tab="recurring" class="tab-btn py-3 px-2 font-medium text-gray-600 hover:text-gray-900">
                    ğŸ”„ é‡è¤‡äº‹é …
                </button>
                <button onclick="switchTab('search')" data-tab="search" class="tab-btn py-3 px-2 font-medium text-gray-600 hover:text-gray-900">
                    ğŸ” æœå°‹/å»é‡
                </button>
                <button onclick="switchTab('export')" data-tab="export" class="tab-btn py-3 px-2 font-medium text-gray-600 hover:text-gray-900">
                    ğŸ“„ PDF åŒ¯å‡º
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Checklist Tab -->
        <div id="tab-checklist" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">æœ¬æœŸæ ¸å°æ¸…å–®</h2>
                    <div class="flex items-center gap-2">
                        <span id="checklistProgress" class="text-sm text-gray-500"></span>
                        <button onclick="generatePeriodChecklist()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                            ğŸ”„ é‡æ–°ç”Ÿæˆ
                        </button>
                    </div>
                </div>
                <div id="checklistContainer" class="space-y-3">
                    <!-- Checklist items will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Todos Tab -->
        <div id="tab-todos" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">å¾…è¾¦äº‹é …</h2>
                    <button onclick="openTodoModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                        + æ–°å¢å¾…è¾¦
                    </button>
                </div>
                <div id="todosContainer" class="space-y-2">
                    <!-- Todos will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Work Log Tab -->
        <div id="tab-worklog" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">æ–°å¢å·¥ä½œç´€éŒ„</h2>
                    </div>
                    <form id="worklogForm" onsubmit="saveWorklog(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™é¡Œ</label>
                            <input type="text" id="worklogTitle" required class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                            <input type="date" id="worklogDate" required class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                            <input type="text" id="worklogTags" class="w-full border rounded-lg px-3 py-2" placeholder="é–‹ç™¼, æœƒè­°, æ–‡ä»¶">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">å…§å®¹ï¼ˆæ”¯æ´ Markdownï¼‰</label>
                            <textarea id="worklogContent" rows="8" class="w-full border rounded-lg px-3 py-2 font-mono text-sm" placeholder="## ä»Šæ—¥å·¥ä½œ&#10;- å®ŒæˆåŠŸèƒ½A&#10;- ä¿®å¾©Bug B"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">é—œè¯ä»»å‹™ IDï¼ˆå¯é¸ï¼‰</label>
                            <input type="text" id="worklogLinkedTask" class="w-full border rounded-lg px-3 py-2" placeholder="task-xxx">
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">
                            å„²å­˜ç´€éŒ„
                        </button>
                    </form>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-xl font-bold mb-4">æœ¬æœŸå·¥ä½œç´€éŒ„</h2>
                    <div id="worklogList" class="space-y-4 max-h-[600px] overflow-y-auto">
                        <!-- Worklogs will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Recurring Tab -->
        <div id="tab-recurring" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">é‡è¤‡äº‹é …è¦å‰‡</h2>
                    <button onclick="openRecurringModal()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                        + æ–°å¢è¦å‰‡
                    </button>
                </div>
                <div id="recurringContainer" class="space-y-3">
                    <!-- Recurring rules will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Search/Dedupe Tab -->
        <div id="tab-search" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-4">æœå°‹èˆ‡å»é‡</h2>
                    <div class="flex gap-4">
                        <input type="text" id="searchInput" oninput="performSearch(this.value)" class="flex-1 border rounded-lg px-4 py-2" placeholder="æœå°‹æ¨™é¡Œã€æ¨™ç±¤ã€æè¿°...">
                        <button onclick="findDuplicates()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
                            ğŸ” å°‹æ‰¾é‡è¤‡é …ç›®
                        </button>
                    </div>
                </div>
                <div id="searchResults" class="space-y-3">
                    <!-- Search results will be rendered here -->
                </div>
                <div id="duplicatesSection" class="mt-6 hidden">
                    <h3 class="text-lg font-bold mb-4">å¯èƒ½é‡è¤‡çš„é …ç›®</h3>
                    <div id="duplicatesContainer" class="space-y-3">
                        <!-- Duplicates will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="tab-export" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-bold mb-6">PDF åŒ¯å‡º</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-medium mb-4">åŒ¯å‡ºè¨­å®š</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                                <input type="date" id="exportStartDate" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ—¥æœŸ</label>
                                <input type="date" id="exportEndDate" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">åŒ…å«å…§å®¹</label>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="exportChecklist" checked class="rounded">
                                        æ ¸å°æ¸…å–®
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="exportTodos" checked class="rounded">
                                        å¾…è¾¦äº‹é …
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="exportWorklog" checked class="rounded">
                                        å·¥ä½œç´€éŒ„
                                    </label>
                                </div>
                            </div>
                            <button onclick="generatePDF()" class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                ç”¢ç”Ÿ PDF ä¸¦ä¸‹è¼‰
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium mb-4">é è¦½</h3>
                        <div id="pdfPreview" class="border rounded-lg p-4 bg-gray-50 min-h-[400px] text-sm">
                            <p class="text-gray-500">è¨­å®šæ—¥æœŸç¯„åœå¾Œé»æ“Šã€Œç”¢ç”Ÿ PDFã€</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Todo Modal -->
    <div id="todoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">æ–°å¢å¾…è¾¦äº‹é …</h3>
            <form id="todoForm" onsubmit="saveTodo(event)">
                <input type="hidden" id="todoId">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™é¡Œ</label>
                    <input type="text" id="todoTitle" required class="w-full border rounded-lg px-3 py-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æè¿°</label>
                    <textarea id="todoDescription" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                    <input type="text" id="todoTags" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å„ªå…ˆç´š</label>
                    <select id="todoPriority" class="w-full border rounded-lg px-3 py-2">
                        <option value="low">ä½</option>
                        <option value="medium" selected>ä¸­</option>
                        <option value="high">é«˜</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æˆªæ­¢æ—¥æœŸï¼ˆå¯é¸ï¼‰</label>
                    <input type="date" id="todoDueDate" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeTodoModal()" class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                        å„²å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recurring Modal -->
    <div id="recurringModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">æ–°å¢é‡è¤‡äº‹é …è¦å‰‡</h3>
            <form id="recurringForm" onsubmit="saveRecurring(event)">
                <input type="hidden" id="recurringId">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™é¡Œ</label>
                    <input type="text" id="recurringTitle" required class="w-full border rounded-lg px-3 py-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æè¿°</label>
                    <textarea id="recurringDescription" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">é »ç‡</label>
                    <select id="recurringFreq" class="w-full border rounded-lg px-3 py-2" onchange="updateRRulePreview()">
                        <option value="DAILY">æ¯æ—¥</option>
                        <option value="WEEKLY" selected>æ¯é€±</option>
                        <option value="MONTHLY">æ¯æœˆ</option>
                        <option value="YEARLY">æ¯å¹´</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">é–“éš”</label>
                    <input type="number" id="recurringInterval" value="1" min="1" class="w-full border rounded-lg px-3 py-2" onchange="updateRRulePreview()">
                </div>
                <div class="mb-4" id="weekdaySelector">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ˜ŸæœŸå¹¾ï¼ˆé€±é‡è¤‡ç”¨ï¼‰</label>
                    <div class="flex flex-wrap gap-2">
                        <label class="flex items-center gap-1"><input type="checkbox" name="byweekday" value="MO" onchange="updateRRulePreview()"> ä¸€</label>
                        <label class="flex items-center gap-1"><input type="checkbox" name="byweekday" value="TU" onchange="updateRRulePreview()"> äºŒ</label>
                        <label class="flex items-center gap-1"><input type="checkbox" name="byweekday" value="WE" onchange="updateRRulePreview()"> ä¸‰</label>
                        <label class="flex items-center gap-1"><input type="checkbox" name="byweekday" value="TH" onchange="updateRRulePreview()"> å››</label>
                        <label class="flex items-center gap-1"><input type="checkbox" name="byweekday" value="FR" onchange="updateRRulePreview()"> äº”</label>
                        <label class="flex items-center gap-1"><input type="checkbox" name="byweekday" value="SA" onchange="updateRRulePreview()"> å…­</label>
                        <label class="flex items-center gap-1"><input type="checkbox" name="byweekday" value="SU" onchange="updateRRulePreview()"> æ—¥</label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="recurringStart" required class="w-full border rounded-lg px-3 py-2" onchange="updateRRulePreview()">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ—¥æœŸï¼ˆå¯é¸ï¼‰</label>
                    <input type="date" id="recurringEnd" class="w-full border rounded-lg px-3 py-2" onchange="updateRRulePreview()">
                </div>
                <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-1">RRULE é è¦½</label>
                    <code id="rrulePreview" class="text-xs break-all"></code>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeRecurringModal()" class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="flex-1 bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">
                        å„²å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">ç³»çµ±è¨­å®š</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è‡ªè¨‚çµç®—æ—¥ï¼ˆ1-31ï¼‰</label>
                    <input type="number" id="settingsCutoffDay" min="1" max="31" value="25" class="w-full border rounded-lg px-3 py-2">
                    <p class="text-xs text-gray-500 mt-1">è‹¥è©²æœˆç„¡æ­¤æ—¥ï¼Œå°‡æ¡ç”¨è©²æœˆæœ€å¾Œä¸€å¤©</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é€±èµ·å§‹æ—¥</label>
                    <select id="settingsWeekStart" class="w-full border rounded-lg px-3 py-2">
                        <option value="1">æ˜ŸæœŸä¸€</option>
                        <option value="0">æ˜ŸæœŸæ—¥</option>
                    </select>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeSettings()" class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button onclick="saveSettings()" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                        å„²å­˜è¨­å®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Log Modal -->
    <div id="auditModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden flex flex-col">
            <h3 class="text-xl font-bold mb-4">æ“ä½œè¨˜éŒ„ (Audit Log)</h3>
            <div id="auditList" class="flex-1 overflow-y-auto space-y-2">
                <!-- Audit logs will be rendered here -->
            </div>
            <button onclick="closeAuditModal()" class="mt-4 w-full border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                é—œé–‰
            </button>
        </div>
    </div>

<script>
// ============================================
// â‘  æœŸåˆ¥å¼•æ“è¦æ ¼ (Period Engine)
// ============================================
dayjs.extend(dayjs_plugin_isoWeek);
dayjs.extend(dayjs_plugin_customParseFormat);

const PeriodEngine = {
    settings: {
        cutoffDay: 25,  // è‡ªè¨‚çµç®—æ—¥é è¨­å€¼
        weekStart: 1    // 1=é€±ä¸€, 0=é€±æ—¥
    },

    // å–å¾—é€±æœŸåˆ¥è³‡è¨Š
    getPeriod(date, periodType = 'week') {
        const d = dayjs(date);
        switch (periodType) {
            case 'week': return this.getWeekPeriod(d);
            case 'month': return this.getMonthPeriod(d);
            case 'customCutoff': return this.getCustomCutoffPeriod(d);
            default: return this.getWeekPeriod(d);
        }
    },

    // é€±æœŸåˆ¥ï¼šé€±ä¸€åˆ°é€±æ—¥ï¼ˆæˆ–è‡ªè¨‚èµ·å§‹æ—¥ï¼‰
    getWeekPeriod(d) {
        const weekStart = this.settings.weekStart;
        let start, end;
        
        if (weekStart === 1) {
            start = d.isoWeekday(1); // é€±ä¸€
            end = d.isoWeekday(7);   // é€±æ—¥
        } else {
            const dayOfWeek = d.day();
            start = d.subtract(dayOfWeek, 'day');
            end = start.add(6, 'day');
        }
        
        const periodId = `W${start.format('GGGG')}-${start.isoWeek().toString().padStart(2, '0')}`;
        
        return {
            type: 'week',
            periodId,
            start: start.format('YYYY-MM-DD'),
            end: end.format('YYYY-MM-DD'),
            label: `${start.format('MM/DD')} ~ ${end.format('MM/DD')}`,
            prev: () => this.getWeekPeriod(d.subtract(7, 'day')),
            next: () => this.getWeekPeriod(d.add(7, 'day'))
        };
    },

    // æœˆæœŸåˆ¥ï¼š1è™Ÿåˆ°æœˆåº•
    getMonthPeriod(d) {
        const start = d.startOf('month');
        const end = d.endOf('month');
        const periodId = `M${d.format('YYYY-MM')}`;
        
        return {
            type: 'month',
            periodId,
            start: start.format('YYYY-MM-DD'),
            end: end.format('YYYY-MM-DD'),
            label: d.format('YYYYå¹´MMæœˆ'),
            prev: () => this.getMonthPeriod(d.subtract(1, 'month')),
            next: () => this.getMonthPeriod(d.add(1, 'month'))
        };
    },

    // è‡ªè¨‚çµç®—æ—¥æœŸåˆ¥
    // ä¾‹å¦‚ cutoffDay=25ï¼šæœ¬æœŸç‚ºä¸Šæœˆ26æ—¥ï½æœ¬æœˆ25æ—¥
    // é‚Šç•Œè™•ç†ï¼šè‹¥è©²æœˆç„¡æ­¤æ—¥ï¼Œæ¡è©²æœˆæœ€å¾Œä¸€å¤©
    getCustomCutoffPeriod(d) {
        const cutoff = this.settings.cutoffDay;
        const currentDay = d.date();
        
        let periodStart, periodEnd;
        
        if (currentDay <= cutoff) {
            // ç•¶å‰æ—¥æœŸ <= çµç®—æ—¥ï¼Œå±¬æ–¼ä¸Šæœˆçµç®—æ—¥+1 åˆ° æœ¬æœˆçµç®—æ—¥çš„æœŸé–“
            const prevMonth = d.subtract(1, 'month');
            const prevMonthLastDay = prevMonth.endOf('month').date();
            const startDay = Math.min(cutoff + 1, prevMonthLastDay + 1);
            
            if (startDay > prevMonthLastDay) {
                periodStart = d.startOf('month');
            } else {
                periodStart = prevMonth.date(Math.min(cutoff + 1, prevMonthLastDay));
                if (cutoff >= prevMonthLastDay) {
                    periodStart = d.startOf('month');
                }
            }
            
            const thisMonthLastDay = d.endOf('month').date();
            periodEnd = d.date(Math.min(cutoff, thisMonthLastDay));
        } else {
            // ç•¶å‰æ—¥æœŸ > çµç®—æ—¥ï¼Œå±¬æ–¼æœ¬æœˆçµç®—æ—¥+1 åˆ° ä¸‹æœˆçµç®—æ—¥çš„æœŸé–“
            periodStart = d.date(cutoff + 1);
            const nextMonth = d.add(1, 'month');
            const nextMonthLastDay = nextMonth.endOf('month').date();
            periodEnd = nextMonth.date(Math.min(cutoff, nextMonthLastDay));
        }
        
        const periodId = `C${periodEnd.format('YYYY-MM')}-${cutoff.toString().padStart(2, '0')}`;
        
        return {
            type: 'customCutoff',
            periodId,
            start: periodStart.format('YYYY-MM-DD'),
            end: periodEnd.format('YYYY-MM-DD'),
            label: `${periodStart.format('MM/DD')} ~ ${periodEnd.format('MM/DD')} (çµç®—æ—¥${cutoff}è™Ÿ)`,
            prev: () => this.getCustomCutoffPeriod(periodStart.subtract(1, 'day')),
            next: () => this.getCustomCutoffPeriod(periodEnd.add(1, 'day'))
        };
    }
};

// ============================================
// â‘¡ è³‡æ–™åº« Schemaï¼ˆDexieï¼‰
// ============================================
const db = new Dexie('WorkRecordSystem');

db.version(1).stores({
    // å¾…è¾¦äº‹é …
    todos: '++id, title, completed, priority, dueDate, periodId, position, createdAt, updatedAt',
    
    // é‡è¤‡äº‹é …è¦å‰‡
    recurringRules: '++id, title, rruleString, enabled, createdAt',
    
    // æœ¬æœŸæ ¸å°é …å¯¦ä¾‹ï¼ˆLazy ç”Ÿæˆï¼‰
    checklistInstances: '++id, ruleId, periodId, completed, completedAt, [ruleId+periodId], createdAt',
    
    // å·¥ä½œç´€éŒ„
    worklogs: '++id, title, date, periodId, *tags, linkedTaskId, createdAt',
    
    // å¯©è¨ˆè¨˜éŒ„ï¼ˆå»é‡/åˆä½µçš„è¿½è¹¤ï¼‰
    auditLogs: '++id, action, entityType, entityId, data, createdAt',
    
    // ç³»çµ±è¨­å®š
    settings: 'key'
});

// ============================================
// â‘¢ é‡è¤‡è¦å‰‡èˆ‡æœ¬æœŸæ¸…å–®ç”Ÿæˆè¦æ ¼
// ============================================
const RecurrenceManager = {
    // è§£æ RRULE å­—ä¸²
    parseRule(rruleString) {
        return rrule.RRule.fromString(rruleString);
    },

    // æŸ¥è©¢æŒ‡å®šæœŸé–“å…§çš„ occurrence
    getOccurrences(rruleString, startDate, endDate) {
        try {
            const rule = this.parseRule(rruleString);
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            return rule.between(start, end, true);
        } catch (e) {
            console.error('RRULE parse error:', e);
            return [];
        }
    },

    // å»ºç«‹ RRULE å­—ä¸²
    buildRRule(options) {
        const ruleOptions = {
            freq: rrule.RRule[options.freq],
            interval: options.interval || 1,
            dtstart: new Date(options.dtstart)
        };
        
        if (options.until) {
            ruleOptions.until = new Date(options.until);
        }
        
        if (options.byweekday && options.byweekday.length > 0) {
            ruleOptions.byweekday = options.byweekday.map(d => rrule.RRule[d]);
        }
        
        return new rrule.RRule(ruleOptions).toString();
    },

    // Lazy å¯¦ä¾‹åŒ–ï¼šé€²å…¥æŸæœŸæ™‚ç”Ÿæˆæ ¸å°é …
    async generatePeriodChecklist(periodId, startDate, endDate) {
        const rules = await db.recurringRules.where('enabled').equals(1).toArray();
        const instances = [];
        
        for (const rule of rules) {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ­¤æœŸæ­¤è¦å‰‡çš„å¯¦ä¾‹
            const existing = await db.checklistInstances
                .where('[ruleId+periodId]')
                .equals([rule.id, periodId])
                .first();
            
            if (existing) {
                instances.push(existing);
                continue;
            }
            
            // æŸ¥è©¢æ­¤æœŸé–“å…§æœ‰ç„¡ occurrence
            const occurrences = this.getOccurrences(rule.rruleString, startDate, endDate);
            
            if (occurrences.length > 0) {
                // æ¯å€‹è¦å‰‡åœ¨æ¯æœŸåªç”Ÿæˆä¸€å€‹æ ¸å°å¯¦ä¾‹
                const instance = {
                    ruleId: rule.id,
                    ruleTitle: rule.title,
                    ruleDescription: rule.description,
                    periodId,
                    occurrenceDate: occurrences[0].toISOString().split('T')[0],
                    completed: 0,
                    completedAt: null,
                    createdAt: new Date().toISOString()
                };
                
                const id = await db.checklistInstances.add(instance);
                instance.id = id;
                instances.push(instance);
                
                // Audit log
                await addAuditLog('CREATE', 'checklistInstance', id, { periodId, ruleId: rule.id });
            }
        }
        
        return instances;
    }
};

// ============================================
// â‘£ æ ¸å°æµç¨‹èˆ‡å®Œæˆåˆ¤å®š
// ============================================
async function toggleChecklistItem(instanceId) {
    const instance = await db.checklistInstances.get(instanceId);
    if (!instance) return;
    
    const newCompleted = instance.completed ? 0 : 1;
    const completedAt = newCompleted ? new Date().toISOString() : null;
    
    await db.checklistInstances.update(instanceId, {
        completed: newCompleted,
        completedAt
    });
    
    await addAuditLog(
        newCompleted ? 'COMPLETE' : 'UNCOMPLETE',
        'checklistInstance',
        instanceId,
        { periodId: instance.periodId, completedAt }
    );
    
    await renderChecklist();
}

// ============================================
// â‘¤ æœå°‹/å»é‡è¦æ ¼
// ============================================
const SearchManager = {
    fuseOptions: {
        keys: ['title', 'description', 'tags'],
        threshold: 0.4,  // ç›¸ä¼¼åº¦é–¾å€¼
        includeScore: true,
        minMatchCharLength: 2
    },

    async searchAll(query) {
        if (!query || query.length < 2) return [];
        
        const [todos, worklogs, rules] = await Promise.all([
            db.todos.toArray(),
            db.worklogs.toArray(),
            db.recurringRules.toArray()
        ]);
        
        const allItems = [
            ...todos.map(t => ({ ...t, type: 'todo' })),
            ...worklogs.map(w => ({ ...w, type: 'worklog' })),
            ...rules.map(r => ({ ...r, type: 'recurring' }))
        ];
        
        const fuse = new Fuse(allItems, this.fuseOptions);
        return fuse.search(query);
    },

    async findDuplicates() {
        const todos = await db.todos.toArray();
        const duplicates = [];
        
        for (let i = 0; i < todos.length; i++) {
            for (let j = i + 1; j < todos.length; j++) {
                const fuse = new Fuse([todos[j]], { 
                    keys: ['title'], 
                    threshold: 0.3,
                    includeScore: true 
                });
                const result = fuse.search(todos[i].title);
                
                if (result.length > 0 && result[0].score < 0.3) {
                    duplicates.push({
                        item1: todos[i],
                        item2: todos[j],
                        score: result[0].score
                    });
                }
            }
        }
        
        return duplicates;
    },

    async mergeDuplicates(keepId, removeId) {
        const keep = await db.todos.get(keepId);
        const remove = await db.todos.get(removeId);
        
        if (!keep || !remove) return false;
        
        // åˆä½µè³‡æ–™
        const merged = {
            ...keep,
            description: keep.description 
                ? `${keep.description}\n\n[å·²åˆä½µ] ${remove.description || ''}` 
                : remove.description,
            tags: [...new Set([...(keep.tags || []), ...(remove.tags || [])])]
        };
        
        await db.todos.update(keepId, merged);
        await db.todos.delete(removeId);
        
        // å¯©è¨ˆè¨˜éŒ„
        await addAuditLog('MERGE', 'todo', keepId, {
            removedId: removeId,
            removedData: remove,
            mergedInto: keepId
        });
        
        return true;
    },

    async markAsIgnored(id1, id2) {
        await addAuditLog('IGNORE_DUPLICATE', 'todo', id1, {
            ignoredPairWith: id2,
            timestamp: new Date().toISOString()
        });
    },

    // æ’¤éŠ·åˆä½µ
    async undoMerge(auditLogId) {
        const log = await db.auditLogs.get(auditLogId);
        if (!log || log.action !== 'MERGE') return false;
        
        const { removedData, mergedInto } = log.data;
        
        // é‚„åŸè¢«åˆªé™¤çš„é …ç›®
        await db.todos.add(removedData);
        
        await addAuditLog('UNDO_MERGE', 'todo', mergedInto, {
            restoredId: removedData.id,
            originalAuditId: auditLogId
        });
        
        return true;
    }
};

// ============================================
// â‘¥ æ‹–æ‹‰æ’åºè¦æ ¼
// ============================================
let todosSortable = null;

function initSortable() {
    const container = document.getElementById('todosContainer');
    if (!container) return;
    
    if (todosSortable) {
        todosSortable.destroy();
    }
    
    todosSortable = new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        handle: '.drag-handle',
        onEnd: async (evt) => {
            const items = container.querySelectorAll('[data-todo-id]');
            const updates = [];
            
            items.forEach((item, index) => {
                const id = parseInt(item.dataset.todoId);
                updates.push({ id, position: index * 1000 });
            });
            
            // æ‰¹æ¬¡æ›´æ–°ä½ç½®
            await db.transaction('rw', db.todos, async () => {
                for (const u of updates) {
                    await db.todos.update(u.id, { position: u.position });
                }
            });
            
            await addAuditLog('REORDER', 'todo', null, { newOrder: updates });
        }
    });
}

// ============================================
// â‘¦ Markdown å®‰å…¨æ¸²æŸ“
// ============================================
const md = window.markdownit({
    html: false,
    linkify: true,
    typographer: true
});

function renderMarkdown(content) {
    if (!content) return '';
    const rawHtml = md.render(content);
    return DOMPurify.sanitize(rawHtml, {
        ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'code', 'pre', 'ul', 'ol', 'li', 'blockquote', 'a', 'hr'],
        ALLOWED_ATTR: ['href', 'target', 'rel']
    });
}

// ============================================
// â‘§ PDF ç”¢æª”è¦æ ¼ï¼ˆå›ºå®šæ¨¡æ¿ï¼‰
// ============================================
async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });

    const startDate = document.getElementById('exportStartDate').value;
    const endDate = document.getElementById('exportEndDate').value;
    
    if (!startDate || !endDate) {
        alert('è«‹é¸æ“‡æ—¥æœŸç¯„åœ');
        return;
    }

    const includeChecklist = document.getElementById('exportChecklist').checked;
    const includeTodos = document.getElementById('exportTodos').checked;
    const includeWorklog = document.getElementById('exportWorklog').checked;

    // PDF æ¨£å¼è¨­å®š
    const pageWidth = 210;
    const pageHeight = 297;
    const margin = 20;
    const contentWidth = pageWidth - margin * 2;
    let y = margin;

    // é é¦–
    function addHeader() {
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('å·¥ä½œç´€éŒ„å ±è¡¨', pageWidth / 2, y, { align: 'center' });
        y += 8;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`æœŸé–“ï¼š${startDate} ~ ${endDate}`, pageWidth / 2, y, { align: 'center' });
        y += 5;
        doc.text(`ç”¢ç”Ÿæ™‚é–“ï¼š${dayjs().format('YYYY-MM-DD HH:mm:ss')}`, pageWidth / 2, y, { align: 'center' });
        y += 10;
        doc.line(margin, y, pageWidth - margin, y);
        y += 10;
    }

    // é å°¾
    function addFooter(pageNum) {
        doc.setFontSize(8);
        doc.text(`ç¬¬ ${pageNum} é `, pageWidth / 2, pageHeight - 10, { align: 'center' });
    }

    // æª¢æŸ¥åˆ†é 
    function checkPageBreak(neededSpace = 20) {
        if (y + neededSpace > pageHeight - margin - 15) {
            addFooter(doc.internal.getNumberOfPages());
            doc.addPage();
            y = margin;
            return true;
        }
        return false;
    }

    // æ·»åŠ å€æ®µæ¨™é¡Œ
    function addSectionTitle(title) {
        checkPageBreak(15);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text(title, margin, y);
        y += 8;
        doc.setFont(undefined, 'normal');
    }

    addHeader();
    let pageNum = 1;

    // æ ¸å°æ¸…å–®
    if (includeChecklist) {
        const instances = await db.checklistInstances
            .where('periodId')
            .equals(currentPeriod.periodId)
            .toArray();

        if (instances.length > 0) {
            addSectionTitle('âœ… æ ¸å°æ¸…å–®');
            doc.setFontSize(10);

            for (const item of instances) {
                checkPageBreak(8);
                const status = item.completed ? '[âœ“]' : '[ ]';
                const text = `${status} ${item.ruleTitle || 'Untitled'}`;
                doc.text(text, margin + 5, y);
                y += 6;
            }
            y += 5;
        }
    }

    // å¾…è¾¦äº‹é …
    if (includeTodos) {
        const todos = await db.todos
            .where('dueDate')
            .between(startDate, endDate, true, true)
            .toArray();

        if (todos.length > 0) {
            addSectionTitle('ğŸ“ å¾…è¾¦äº‹é …');
            doc.setFontSize(10);

            for (const todo of todos) {
                checkPageBreak(12);
                const status = todo.completed ? '[âœ“]' : '[ ]';
                const priority = { high: 'ğŸ”´', medium: 'ğŸŸ¡', low: 'ğŸŸ¢' }[todo.priority] || '';
                doc.text(`${status} ${priority} ${todo.title}`, margin + 5, y);
                y += 5;
                if (todo.dueDate) {
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(`æˆªæ­¢ï¼š${todo.dueDate}`, margin + 10, y);
                    doc.setTextColor(0);
                    doc.setFontSize(10);
                    y += 5;
                }
            }
            y += 5;
        }
    }

    // å·¥ä½œç´€éŒ„
    if (includeWorklog) {
        const worklogs = await db.worklogs
            .where('date')
            .between(startDate, endDate, true, true)
            .toArray();

        if (worklogs.length > 0) {
            addSectionTitle('ğŸ““ å·¥ä½œç´€éŒ„');
            doc.setFontSize(10);

            for (const log of worklogs) {
                checkPageBreak(20);
                doc.setFont(undefined, 'bold');
                doc.text(`${log.date} - ${log.title}`, margin + 5, y);
                y += 5;
                doc.setFont(undefined, 'normal');
                
                if (log.tags && log.tags.length > 0) {
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(`æ¨™ç±¤ï¼š${log.tags.join(', ')}`, margin + 5, y);
                    doc.setTextColor(0);
                    doc.setFontSize(10);
                    y += 5;
                }
                
                if (log.content) {
                    const lines = doc.splitTextToSize(log.content.replace(/[#*`]/g, ''), contentWidth - 10);
                    for (const line of lines.slice(0, 5)) {
                        checkPageBreak(6);
                        doc.text(line, margin + 5, y);
                        y += 5;
                    }
                    if (lines.length > 5) {
                        doc.text('...', margin + 5, y);
                        y += 5;
                    }
                }
                y += 3;
            }
        }
    }

    addFooter(doc.internal.getNumberOfPages());

    // ç”¢ç”Ÿæª”åä¸¦ä¸‹è¼‰
    const filename = `å·¥ä½œç´€éŒ„_${startDate}_${endDate}.pdf`;
    doc.save(filename);
    
    await addAuditLog('EXPORT_PDF', 'report', null, { startDate, endDate, filename });
}

// ============================================
// Audit Log Helper
// ============================================
async function addAuditLog(action, entityType, entityId, data) {
    await db.auditLogs.add({
        action,
        entityType,
        entityId,
        data,
        createdAt: new Date().toISOString()
    });
}

// ============================================
// UI State & Rendering
// ============================================
let currentPeriod = null;
let currentPeriodType = 'week';

async function init() {
    // è¼‰å…¥è¨­å®š
    const settings = await db.settings.get('app');
    if (settings) {
        PeriodEngine.settings = { ...PeriodEngine.settings, ...settings.value };
        document.getElementById('periodTypeSelect').value = settings.value.periodType || 'week';
        currentPeriodType = settings.value.periodType || 'week';
    }
    
    // åˆå§‹åŒ–ç•¶å‰æœŸåˆ¥
    currentPeriod = PeriodEngine.getPeriod(new Date(), currentPeriodType);
    updatePeriodDisplay();
    
    // è¼‰å…¥è³‡æ–™
    await renderChecklist();
    await renderTodos();
    await renderWorklogs();
    await renderRecurringRules();
    
    // åˆå§‹åŒ–æ‹–æ‹‰
    initSortable();
    
    // è¨­å®šæ—¥æœŸé è¨­å€¼
    document.getElementById('worklogDate').value = dayjs().format('YYYY-MM-DD');
    document.getElementById('recurringStart').value = dayjs().format('YYYY-MM-DD');
    document.getElementById('exportStartDate').value = currentPeriod.start;
    document.getElementById('exportEndDate').value = currentPeriod.end;
    
    // é›¢ç·šç‹€æ…‹åµæ¸¬
    updateOnlineStatus();
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
}

function updateOnlineStatus() {
    const indicator = document.getElementById('offlineIndicator');
    if (navigator.onLine) {
        indicator.classList.add('hidden');
    } else {
        indicator.classList.remove('hidden');
    }
}

function updatePeriodDisplay() {
    document.getElementById('currentPeriodLabel').textContent = currentPeriod.label;
}

function navigatePeriod(direction) {
    currentPeriod = direction > 0 ? currentPeriod.next() : currentPeriod.prev();
    updatePeriodDisplay();
    renderChecklist();
    renderWorklogs();
    
    document.getElementById('exportStartDate').value = currentPeriod.start;
    document.getElementById('exportEndDate').value = currentPeriod.end;
}

function changePeriodType(type) {
    currentPeriodType = type;
    currentPeriod = PeriodEngine.getPeriod(new Date(), type);
    updatePeriodDisplay();
    renderChecklist();
    saveSettings();
}

// Tab Switching
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('tab-active'));
    
    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
    
    if (tabName === 'todos') {
        setTimeout(initSortable, 100);
    }
}

// ============================================
// Checklist Rendering
// ============================================
async function renderChecklist() {
    const container = document.getElementById('checklistContainer');
    
    // Lazy ç”Ÿæˆæœ¬æœŸæ ¸å°é …
    const instances = await RecurrenceManager.generatePeriodChecklist(
        currentPeriod.periodId,
        currentPeriod.start,
        currentPeriod.end
    );
    
    // é¡å¤–æŸ¥è©¢å·²å­˜åœ¨çš„å¯¦ä¾‹
    const existingInstances = await db.checklistInstances
        .where('periodId')
        .equals(currentPeriod.periodId)
        .toArray();
    
    const allInstances = [...new Map([...instances, ...existingInstances].map(i => [i.id, i])).values()];
    
    if (allInstances.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p>æœ¬æœŸç„¡æ ¸å°é …ç›®</p>
                <p class="text-sm mt-2">è«‹å…ˆåœ¨ã€Œé‡è¤‡äº‹é …ã€ä¸­æ–°å¢è¦å‰‡</p>
            </div>
        `;
        document.getElementById('checklistProgress').textContent = '';
        return;
    }
    
    const completed = allInstances.filter(i => i.completed).length;
    document.getElementById('checklistProgress').textContent = `${completed}/${allInstances.length} å·²å®Œæˆ`;
    
    container.innerHTML = allInstances.map(instance => `
        <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition ${instance.completed ? 'opacity-60' : ''}">
            <input type="checkbox" 
                   ${instance.completed ? 'checked' : ''} 
                   onchange="toggleChecklistItem(${instance.id})"
                   class="w-5 h-5 rounded text-blue-500">
            <div class="flex-1">
                <h4 class="font-medium ${instance.completed ? 'line-through text-gray-500' : ''}">${escapeHtml(instance.ruleTitle)}</h4>
                ${instance.ruleDescription ? `<p class="text-sm text-gray-500">${escapeHtml(instance.ruleDescription)}</p>` : ''}
                <span class="text-xs text-gray-400">ç™¼ç”Ÿæ—¥æœŸï¼š${instance.occurrenceDate}</span>
            </div>
            ${instance.completedAt ? `<span class="text-xs text-green-600">å®Œæˆæ–¼ ${dayjs(instance.completedAt).format('MM/DD HH:mm')}</span>` : ''}
        </div>
    `).join('');
}

async function generatePeriodChecklist() {
    // å¼·åˆ¶é‡æ–°ç”Ÿæˆï¼ˆåˆªé™¤èˆŠçš„å†ç”¢ç”Ÿï¼‰
    await db.checklistInstances
        .where('periodId')
        .equals(currentPeriod.periodId)
        .delete();
    
    await renderChecklist();
}

// ============================================
// Todos Rendering
// ============================================
async function renderTodos() {
    const container = document.getElementById('todosContainer');
    const todos = await db.todos.orderBy('position').toArray();
    
    if (todos.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p>å°šç„¡å¾…è¾¦äº‹é …</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = todos.map(todo => {
        const priorityColors = {
            high: 'bg-red-100 text-red-700',
            medium: 'bg-yellow-100 text-yellow-700',
            low: 'bg-green-100 text-green-700'
        };
        
        return `
            <div data-todo-id="${todo.id}" class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition ${todo.completed ? 'opacity-60' : ''}">
                <span class="drag-handle cursor-grab text-gray-400 hover:text-gray-600">â ¿</span>
                <input type="checkbox" 
                       ${todo.completed ? 'checked' : ''} 
                       onchange="toggleTodo(${todo.id})"
                       class="w-5 h-5 rounded">
                <div class="flex-1">
                    <h4 class="font-medium ${todo.completed ? 'line-through text-gray-500' : ''}">${escapeHtml(todo.title)}</h4>
                    ${todo.description ? `<p class="text-sm text-gray-500">${escapeHtml(todo.description)}</p>` : ''}
                    <div class="flex items-center gap-2 mt-1">
                        <span class="period-badge ${priorityColors[todo.priority]}">${todo.priority}</span>
                        ${todo.dueDate ? `<span class="text-xs text-gray-500">æˆªæ­¢ï¼š${todo.dueDate}</span>` : ''}
                        ${todo.tags && todo.tags.length ? `<span class="text-xs text-blue-500">${todo.tags.join(', ')}</span>` : ''}
                    </div>
                </div>
                <button onclick="editTodo(${todo.id})" class="p-1 hover:bg-gray-200 rounded">âœï¸</button>
                <button onclick="deleteTodo(${todo.id})" class="p-1 hover:bg-red-100 rounded text-red-500">ğŸ—‘ï¸</button>
            </div>
        `;
    }).join('');
}

async function toggleTodo(id) {
    const todo = await db.todos.get(id);
    await db.todos.update(id, { 
        completed: todo.completed ? 0 : 1,
        updatedAt: new Date().toISOString()
    });
    await renderTodos();
}

async function deleteTodo(id) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¾…è¾¦äº‹é …ï¼Ÿ')) return;
    await db.todos.delete(id);
    await addAuditLog('DELETE', 'todo', id, {});
    await renderTodos();
}

async function editTodo(id) {
    const todo = await db.todos.get(id);
    if (!todo) return;
    
    document.getElementById('todoId').value = todo.id;
    document.getElementById('todoTitle').value = todo.title;
    document.getElementById('todoDescription').value = todo.description || '';
    document.getElementById('todoTags').value = (todo.tags || []).join(', ');
    document.getElementById('todoPriority').value = todo.priority;
    document.getElementById('todoDueDate').value = todo.dueDate || '';
    
    openTodoModal();
}

function openTodoModal() {
    document.getElementById('todoModal').classList.remove('hidden');
    document.getElementById('todoModal').classList.add('flex');
}

function closeTodoModal() {
    document.getElementById('todoModal').classList.add('hidden');
    document.getElementById('todoModal').classList.remove('flex');
    document.getElementById('todoForm').reset();
    document.getElementById('todoId').value = '';
}

async function saveTodo(e) {
    e.preventDefault();
    
    const id = document.getElementById('todoId').value;
    const data = {
        title: document.getElementById('todoTitle').value,
        description: document.getElementById('todoDescription').value,
        tags: document.getElementById('todoTags').value.split(',').map(t => t.trim()).filter(Boolean),
        priority: document.getElementById('todoPriority').value,
        dueDate: document.getElementById('todoDueDate').value || null,
        periodId: currentPeriod.periodId,
        updatedAt: new Date().toISOString()
    };
    
    if (id) {
        await db.todos.update(parseInt(id), data);
        await addAuditLog('UPDATE', 'todo', parseInt(id), data);
    } else {
        const maxPosition = await db.todos.orderBy('position').last();
        data.position = (maxPosition?.position || 0) + 1000;
        data.completed = 0;
        data.createdAt = new Date().toISOString();
        const newId = await db.todos.add(data);
        await addAuditLog('CREATE', 'todo', newId, data);
    }
    
    closeTodoModal();
    await renderTodos();
    initSortable();
}

// ============================================
// Worklogs Rendering
// ============================================
async function renderWorklogs() {
    const container = document.getElementById('worklogList');
    const worklogs = await db.worklogs
        .where('date')
        .between(currentPeriod.start, currentPeriod.end, true, true)
        .reverse()
        .toArray();
    
    if (worklogs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p>æœ¬æœŸç„¡å·¥ä½œç´€éŒ„</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = worklogs.map(log => `
        <div class="border rounded-lg p-4 hover:shadow-sm transition">
            <div class="flex items-start justify-between mb-2">
                <div>
                    <h4 class="font-medium">${escapeHtml(log.title)}</h4>
                    <span class="text-sm text-gray-500">${log.date}</span>
                </div>
                <button onclick="deleteWorklog(${log.id})" class="text-red-500 hover:bg-red-50 p-1 rounded">ğŸ—‘ï¸</button>
            </div>
            ${log.tags && log.tags.length ? `
                <div class="flex flex-wrap gap-1 mb-2">
                    ${log.tags.map(tag => `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">${escapeHtml(tag)}</span>`).join('')}
                </div>
            ` : ''}
            <div class="markdown-body text-sm">
                ${renderMarkdown(log.content)}
            </div>
            ${log.linkedTaskId ? `<p class="text-xs text-gray-400 mt-2">é—œè¯ä»»å‹™ï¼š${log.linkedTaskId}</p>` : ''}
        </div>
    `).join('');
}

async function saveWorklog(e) {
    e.preventDefault();
    
    const data = {
        title: document.getElementById('worklogTitle').value,
        date: document.getElementById('worklogDate').value,
        tags: document.getElementById('worklogTags').value.split(',').map(t => t.trim()).filter(Boolean),
        content: document.getElementById('worklogContent').value,
        linkedTaskId: document.getElementById('worklogLinkedTask').value || null,
        periodId: currentPeriod.periodId,
        createdAt: new Date().toISOString()
    };
    
    const id = await db.worklogs.add(data);
    await addAuditLog('CREATE', 'worklog', id, data);
    
    document.getElementById('worklogForm').reset();
    document.getElementById('worklogDate').value = dayjs().format('YYYY-MM-DD');
    
    await renderWorklogs();
}

async function deleteWorklog(id) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å·¥ä½œç´€éŒ„ï¼Ÿ')) return;
    await db.worklogs.delete(id);
    await addAuditLog('DELETE', 'worklog', id, {});
    await renderWorklogs();
}

// ============================================
// Recurring Rules Rendering
// ============================================
async function renderRecurringRules() {
    const container = document.getElementById('recurringContainer');
    const rules = await db.recurringRules.toArray();
    
    if (rules.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p>å°šç„¡é‡è¤‡äº‹é …è¦å‰‡</p>
                <p class="text-sm mt-2">æ–°å¢è¦å‰‡å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•åœ¨æ¯æœŸç”Ÿæˆæ ¸å°é …ç›®</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = rules.map(rule => {
        let humanReadable = '';
        try {
            const r = rrule.RRule.fromString(rule.rruleString);
            humanReadable = r.toText();
        } catch (e) {
            humanReadable = rule.rruleString;
        }
        
        return `
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
                <div class="flex-1">
                    <h4 class="font-medium">${escapeHtml(rule.title)}</h4>
                    ${rule.description ? `<p class="text-sm text-gray-500">${escapeHtml(rule.description)}</p>` : ''}
                    <code class="text-xs bg-gray-200 px-2 py-0.5 rounded mt-1 inline-block">${humanReadable}</code>
                </div>
                <label class="flex items-center gap-2">
                    <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleRecurringRule(${rule.id})" class="rounded">
                    <span class="text-sm">å•Ÿç”¨</span>
                </label>
                <button onclick="deleteRecurringRule(${rule.id})" class="p-1 hover:bg-red-100 rounded text-red-500">ğŸ—‘ï¸</button>
            </div>
        `;
    }).join('');
}

async function toggleRecurringRule(id) {
    const rule = await db.recurringRules.get(id);
    await db.recurringRules.update(id, { enabled: rule.enabled ? 0 : 1 });
    await renderRecurringRules();
}

async function deleteRecurringRule(id) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¦å‰‡ï¼Ÿç›¸é—œçš„æ ¸å°é …ç›®ä¸æœƒè¢«åˆªé™¤ã€‚')) return;
    await db.recurringRules.delete(id);
    await addAuditLog('DELETE', 'recurringRule', id, {});
    await renderRecurringRules();
}

function openRecurringModal() {
    document.getElementById('recurringModal').classList.remove('hidden');
    document.getElementById('recurringModal').classList.add('flex');
    updateRRulePreview();
}

function closeRecurringModal() {
    document.getElementById('recurringModal').classList.add('hidden');
    document.getElementById('recurringModal').classList.remove('flex');
    document.getElementById('recurringForm').reset();
    document.getElementById('recurringId').value = '';
    document.querySelectorAll('[name="byweekday"]').forEach(cb => cb.checked = false);
}

function updateRRulePreview() {
    const freq = document.getElementById('recurringFreq').value;
    const interval = parseInt(document.getElementById('recurringInterval').value) || 1;
    const dtstart = document.getElementById('recurringStart').value;
    const until = document.getElementById('recurringEnd').value;
    
    const byweekday = [];
    document.querySelectorAll('[name="byweekday"]:checked').forEach(cb => {
        byweekday.push(cb.value);
    });
    
    if (!dtstart) {
        document.getElementById('rrulePreview').textContent = 'è«‹å…ˆé¸æ“‡é–‹å§‹æ—¥æœŸ';
        return;
    }
    
    try {
        const rruleStr = RecurrenceManager.buildRRule({
            freq,
            interval,
            dtstart,
            until: until || null,
            byweekday: freq === 'WEEKLY' ? byweekday : []
        });
        document.getElementById('rrulePreview').textContent = rruleStr;
    } catch (e) {
        document.getElementById('rrulePreview').textContent = 'è¦å‰‡æ ¼å¼éŒ¯èª¤';
    }
}

async function saveRecurring(e) {
    e.preventDefault();
    
    const freq = document.getElementById('recurringFreq').value;
    const interval = parseInt(document.getElementById('recurringInterval').value) || 1;
    const dtstart = document.getElementById('recurringStart').value;
    const until = document.getElementById('recurringEnd').value;
    
    const byweekday = [];
    document.querySelectorAll('[name="byweekday"]:checked').forEach(cb => {
        byweekday.push(cb.value);
    });
    
    const rruleString = RecurrenceManager.buildRRule({
        freq,
        interval,
        dtstart,
        until: until || null,
        byweekday: freq === 'WEEKLY' ? byweekday : []
    });
    
    const data = {
        title: document.getElementById('recurringTitle').value,
        description: document.getElementById('recurringDescription').value,
        rruleString,
        enabled: 1,
        createdAt: new Date().toISOString()
    };
    
    const id = await db.recurringRules.add(data);
    await addAuditLog('CREATE', 'recurringRule', id, data);
    
    closeRecurringModal();
    await renderRecurringRules();
    await renderChecklist();
}

// ============================================
// Search & Deduplication
// ============================================
async function performSearch(query) {
    const container = document.getElementById('searchResults');
    
    if (!query || query.length < 2) {
        container.innerHTML = '<p class="text-gray-500">è«‹è¼¸å…¥è‡³å°‘ 2 å€‹å­—å…ƒé€²è¡Œæœå°‹</p>';
        return;
    }
    
    const results = await SearchManager.searchAll(query);
    
    if (results.length === 0) {
        container.innerHTML = '<p class="text-gray-500">ç„¡æœå°‹çµæœ</p>';
        return;
    }
    
    container.innerHTML = results.map(r => {
        const item = r.item;
        const typeLabels = { todo: 'å¾…è¾¦', worklog: 'ç´€éŒ„', recurring: 'é‡è¤‡è¦å‰‡' };
        const typeColors = { todo: 'bg-green-100 text-green-700', worklog: 'bg-blue-100 text-blue-700', recurring: 'bg-purple-100 text-purple-700' };
        
        return `
            <div class="p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs px-2 py-0.5 rounded ${typeColors[item.type]}">${typeLabels[item.type]}</span>
                    <span class="text-xs text-gray-400">ç›¸ä¼¼åº¦ï¼š${((1 - r.score) * 100).toFixed(1)}%</span>
                </div>
                <h4 class="font-medium">${escapeHtml(item.title)}</h4>
                ${item.description ? `<p class="text-sm text-gray-500">${escapeHtml(item.description?.substring(0, 100))}...</p>` : ''}
            </div>
        `;
    }).join('');
}

async function findDuplicates() {
    const section = document.getElementById('duplicatesSection');
    const container = document.getElementById('duplicatesContainer');
    
    const duplicates = await SearchManager.findDuplicates();
    
    if (duplicates.length === 0) {
        section.classList.remove('hidden');
        container.innerHTML = '<p class="text-gray-500">æœªç™¼ç¾é‡è¤‡é …ç›® ğŸ‘</p>';
        return;
    }
    
    section.classList.remove('hidden');
    container.innerHTML = duplicates.map(d => `
        <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-orange-700">ç›¸ä¼¼åº¦ï¼š${((1 - d.score) * 100).toFixed(1)}%</span>
                <div class="flex gap-2">
                    <button onclick="mergeDuplicates(${d.item1.id}, ${d.item2.id})" class="text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600">
                        ä¿ç•™ #1 åˆä½µ
                    </button>
                    <button onclick="mergeDuplicates(${d.item2.id}, ${d.item1.id})" class="text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600">
                        ä¿ç•™ #2 åˆä½µ
                    </button>
                    <button onclick="ignoreDuplicate(${d.item1.id}, ${d.item2.id})" class="text-xs border border-gray-300 px-2 py-1 rounded hover:bg-gray-100">
                        å¿½ç•¥
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="p-2 bg-white rounded">
                    <span class="text-xs text-gray-400">#1</span>
                    <h4 class="font-medium">${escapeHtml(d.item1.title)}</h4>
                </div>
                <div class="p-2 bg-white rounded">
                    <span class="text-xs text-gray-400">#2</span>
                    <h4 class="font-medium">${escapeHtml(d.item2.title)}</h4>
                </div>
            </div>
        </div>
    `).join('');
}

async function mergeDuplicates(keepId, removeId) {
    if (!confirm('ç¢ºå®šè¦åˆä½µé€™å…©å€‹é …ç›®ï¼Ÿæ­¤æ“ä½œå¯é€éå¯©è¨ˆè¨˜éŒ„æ’¤éŠ·ã€‚')) return;
    
    await SearchManager.mergeDuplicates(keepId, removeId);
    await renderTodos();
    await findDuplicates();
}

async function ignoreDuplicate(id1, id2) {
    await SearchManager.markAsIgnored(id1, id2);
    await findDuplicates();
}

// ============================================
// Settings
// ============================================
function openSettings() {
    document.getElementById('settingsCutoffDay').value = PeriodEngine.settings.cutoffDay;
    document.getElementById('settingsWeekStart').value = PeriodEngine.settings.weekStart;
    document.getElementById('settingsModal').classList.remove('hidden');
    document.getElementById('settingsModal').classList.add('flex');
}

function closeSettings() {
    document.getElementById('settingsModal').classList.add('hidden');
    document.getElementById('settingsModal').classList.remove('flex');
}

async function saveSettings() {
    PeriodEngine.settings.cutoffDay = parseInt(document.getElementById('settingsCutoffDay').value);
    PeriodEngine.settings.weekStart = parseInt(document.getElementById('settingsWeekStart').value);
    PeriodEngine.settings.periodType = currentPeriodType;
    
    await db.settings.put({
        key: 'app',
        value: PeriodEngine.settings
    });
    
    currentPeriod = PeriodEngine.getPeriod(new Date(), currentPeriodType);
    updatePeriodDisplay();
    
    closeSettings();
}

// ============================================
// Audit Log Modal
// ============================================
async function showAuditLog() {
    const logs = await db.auditLogs.orderBy('createdAt').reverse().limit(50).toArray();
    
    document.getElementById('auditList').innerHTML = logs.map(log => `
        <div class="p-3 bg-gray-50 rounded text-sm">
            <div class="flex items-center justify-between">
                <span class="font-medium">${log.action}</span>
                <span class="text-xs text-gray-400">${dayjs(log.createdAt).format('YYYY-MM-DD HH:mm')}</span>
            </div>
            <div class="text-gray-600">${log.entityType} #${log.entityId || 'N/A'}</div>
            <code class="text-xs block mt-1 overflow-hidden">${JSON.stringify(log.data).substring(0, 100)}...</code>
        </div>
    `).join('');
    
    document.getElementById('auditModal').classList.remove('hidden');
    document.getElementById('auditModal').classList.add('flex');
}

function closeAuditModal() {
    document.getElementById('auditModal').classList.add('hidden');
    document.getElementById('auditModal').classList.remove('flex');
}

// Utility
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
