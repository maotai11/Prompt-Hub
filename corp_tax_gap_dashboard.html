<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Corp Tax Gap Dashboard (Offline)</title>
<style>
  :root{
    --bg:#0b0d10;--card:#111418;--muted:#171a1f;--ink:#e8ecf1;--sub:#9aa6b2;--accent:#78c6ff;
    --ok:#1fc77e;--warn:#ffb020;--err:#ff5c5c;--grid:#222831;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";}
  h1,h2,h3{margin:0 0 .5rem}
  a{color:var(--accent)}
  .wrap{display:grid;grid-template-rows:auto auto 1fr;min-height:100vh}
  header{padding:16px 20px;border-bottom:1px solid var(--grid);display:flex;align-items:center;gap:12px}
  header .title{font-weight:700;font-size:18px;letter-spacing:.3px}
  .tabs{display:flex;gap:8px;padding:10px 20px;border-bottom:1px solid var(--grid);flex-wrap:wrap}
  .tab-btn{padding:10px 14px;border:1px solid var(--grid);background:var(--card);border-radius:12px;cursor:pointer}
  .tab-btn.active{outline:2px solid var(--accent);}
  main{padding:16px;display:grid;grid-template-columns:1fr;gap:16px}
  .panel{display:none}
  .panel.active{display:block}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:var(--card);border:1px solid var(--grid);border-radius:14px;padding:14px}
  label{font-size:12px;color:var(--sub);display:block;margin-bottom:4px}
  input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1116;color:var(--ink);}
  input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{appearance:none;margin:0}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--grid);background:#0f1217;color:var(--ink);cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#009dff,#0076c4);border-color:#005b99}
  .btn.warn{background:#2a1d00;border-color:#5a3b00}
  .btn.ok{background:#062a1c;border-color:#0c4d33}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .grid{border:1px solid var(--grid);border-radius:12px;overflow:auto}
  table{width:100%;border-collapse:collapse;background:#0e1116}
  th,td{border:1px solid #2a2f37;padding:8px;vertical-align:top}
  th{background:#11161c;color:#cbd5e1;text-align:left;font-weight:600}
  .hint{color:var(--sub);font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--grid);background:#0f141a;font-size:12px;color:#cbd5e1}
  .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:8px;margin:4px 0}
  .section-title{font-weight:700;margin:8px 0 6px}
  .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .r{justify-content:flex-end}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .badge{border:1px dashed #334155;border-radius:8px;padding:2px 6px;font-size:12px;color:#93a3af}
  .pair{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .sticky-bottom{position:sticky;bottom:0;background:var(--card);padding:12px;border-top:1px solid var(--grid);border-radius:0 0 14px 14px}
  .small{font-size:12px}
  /* Word-like preview blocks (2 per page) */
  .word-page{width:210mm;min-height:297mm;background:white;color:black;margin:0 auto;padding:20mm 16mm;box-shadow:0 0 0 1px #d0d7de inset}
  .word-grid{display:grid;grid-template-columns:1fr;gap:10mm}
  .word-block{border:1px solid #111;padding:6mm;border-radius:0;color:#000}
  .w-title{font-weight:bold;margin-bottom:3mm;font-size:12pt}
  .w-table{width:100%;border-collapse:collapse;font-size:11pt}
  .w-table td, .w-table th{border:1px solid #000;padding:2mm}
  .print{background:white;color:black}
  @media print{
    body{background:white}
    .no-print{display:none !important}
    .word-page{box-shadow:none}
  }
</style>
</head>
<body>
<div class="wrap">
  <header class="no-print">
    <div class="title">【營所稅預估及缺口分析】 Offline Dashboard</div>
    <span class="pill">Single-file • Offline • LocalStorage</span>
  </header>

  <nav class="tabs no-print">
    <button class="tab-btn active" data-tab="input">Input</button>
    <button class="tab-btn" data-tab="results">Results</button>
    <button class="tab-btn" data-tab="excel">Excel Preview</button>
    <button class="tab-btn" data-tab="word">Word Preview</button>
  </nav>

  <main>
    <!-- INPUT PANEL -->
    <section id="panel-input" class="panel active">
      <div class="row">
        <div class="card" style="grid-column: span 12">
          <div class="toolbar">
            <button class="btn primary" id="btnAddClient">Add Client</button>
            <button class="btn" id="btnSave">Save</button>
            <button class="btn" id="btnLoad">Load</button>
            <input type="file" id="csvIn" accept=".csv" class="no-print">
            <button class="btn" id="btnImportCsv">Import CSV</button>
            <button class="btn" id="btnExportCsv">Export CSV</button>
          </div>
          <div class="hint mt8">Tip: CSV import/export is fully offline. Columns match the form below.</div>
        </div>

        <div id="clients"></div>
      </div>
    </section>

    <!-- RESULTS PANEL -->
    <section id="panel-results" class="panel">
      <div class="card">
        <div class="toolbar no-print">
          <button class="btn" id="btnRecalc">Recalculate</button>
          <button class="btn ok" id="btnToExcel">Export Excel (.xls, per client)</button>
          <button class="btn ok" id="btnToWord">Export Word (.doc, 2 clients per file)</button>
          <button class="btn" id="btnPrint">Print</button>
        </div>
        <div class="grid mt12">
          <table id="resultTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Client Code</th>
                <th>Client Short Name</th>
                <th>Year(n)</th>
                <th>Industry</th>
                <th>Total Revenue</th>
                <th>Cost Base</th>
                <th>Gross Base</th>
                <th>Book Audit Income</th>
                <th>Income Rate Income</th>
                <th>Chosen Income</th>
                <th>Cost Gap</th>
                <th>Expense Gap</th>
                <th>Total Gap</th>
                <th>Final Taxable (A)</th>
                <th>Tax Amount</th>
                <th>Prepay (n)</th>
                <th>Payable</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint mt8">Rules: cost% + gross% = 1; dept cost% + dept gross% = 1. Floors applied where required.</div>
      </div>
    </section>

    <!-- EXCEL PREVIEW -->
    <section id="panel-excel" class="panel">
      <div class="card">
        <div class="toolbar no-print">
          <button class="btn ok" id="btnToExcel2">Export Visible Table to Excel (.xls)</button>
        </div>
        <div class="grid">
          <table id="excelPreview">
            <thead>
              <tr>
                <th colspan="18">【一般公司】n年預估計算（Excel-like Preview）</th>
              </tr>
              <tr>
                <th>Client</th><th>Industry</th><th>Year(n)</th>
                <th>01-08收入</th><th>09-10收入</th><th>(估)11-12收入</th>
                <th>全年收入</th>
                <th>n-1成本率</th><th>n-1毛利率</th>
                <th>成本基準</th><th>毛利基準</th>
                <th>書審率</th><th>所得額率</th>
                <th>書審所得額</th><th>所得額所得額</th><th>擇優</th>
                <th>部頒成本率</th><th>部頒毛利率</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- WORD PREVIEW -->
    <section id="panel-word" class="panel">
      <div class="card no-print">
        <div class="toolbar">
          <button class="btn ok" id="btnToWord2">Export This Page to Word (.doc)</button>
          <span class="hint">Two clients per block/page, modeled after your Word layout.</span>
        </div>
      </div>
      <div id="wordContainer" class="print">
        <!-- pages inserted here -->
      </div>
    </section>
  </main>
</div>

<template id="clientTpl">
  <div class="card" data-client>
    <div class="flex r no-print">
      <button class="btn warn" data-remove>Remove</button>
    </div>
    <div class="row mt8">
      <div class="card" style="grid-column: span 12; background:#0c1117;">
        <div class="section-title">Basic</div>
        <div class="row">
          <div class="kv" style="grid-column: span 4;">
            <label>Client Code</label>
            <input name="code" placeholder="#2767">
          </div>
          <div class="kv" style="grid-column: span 4;">
            <label>Client Short Name</label>
            <input name="short" placeholder="亞伯蘭">
          </div>
          <div class="kv" style="grid-column: span 2;">
            <label>Year n (e.g., 113)</label>
            <input name="yearN" type="number" min="1" step="1" placeholder="113">
          </div>
          <div class="kv" style="grid-column: span 2;">
            <label>Industry</label>
            <select name="industry">
              <option value="一般公司">一般公司</option>
              <option value="行號">行號</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: span 6;">
        <div class="section-title">Rates</div>
        <div class="row">
          <div class="kv" style="grid-column: span 6;">
            <label>n-1 成本率 (e.g., 0.7 or 70%)</label>
            <input name="costRate" placeholder="70%">
          </div>
          <div class="kv" style="grid-column: span 6;">
            <label>n-1 毛利率 (e.g., 0.3 or 30%)</label>
            <input name="grossRate" placeholder="30%">
          </div>
          <div class="kv" style="grid-column: span 6;">
            <label>部頒 成本率</label>
            <input name="deptCostRate" placeholder="70%">
          </div>
          <div class="kv" style="grid-column: span 6;">
            <label>部頒 毛利率</label>
            <input name="deptGrossRate" placeholder="30%">
          </div>
          <div class="kv" style="grid-column: span 6;">
            <label>書審率</label>
            <input name="auditRate" placeholder="6%">
          </div>
          <div class="kv" style="grid-column: span 6;">
            <label>所得額率</label>
            <input name="incomeRate" placeholder="4%">
          </div>
          <div class="kv" style="grid-column: span 6;">
            <label>n-1 年度採 (書審 / 所得額)</label>
            <input name="lastMethod" placeholder="書審">
          </div>
          <div class="kv" style="grid-column: span 6;">
            <label>n-1 年度採率 (紀錄用)</label>
            <input name="lastMethodRate" placeholder="6%">
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: span 6;">
        <div class="section-title">Revenue & Others</div>
        <div class="row">
          <div class="kv" style="grid-column: span 4;">
            <label>01-08 月收入</label>
            <input name="rev1" type="number" min="0" step="1" value="0">
          </div>
          <div class="kv" style="grid-column: span 4;">
            <label>09-10 月收入</label>
            <input name="rev2" type="number" min="0" step="1" value="0">
          </div>
          <div class="kv" style="grid-column: span 4;">
            <label>(估)11-12 月收入</label>
            <input name="rev3" type="number" min="0" step="1" value="0">
          </div>
          <div class="kv" style="grid-column: span 4;">
            <label>n 年 暫繳</label>
            <input name="prepay" type="number" min="0" step="1" value="0">
          </div>
          <div class="kv" style="grid-column: span 4;">
            <label>業外收入 (選填)</label>
            <input name="nonOp" type="number" min="0" step="1" value="0">
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: span 12;">
        <div class="section-title">成本/費用缺口項</div>
        <div class="hint">Add items. Name starting with '+' means add; '-' means subtract. Choose Type: Cost or Expense.</div>
        <div class="toolbar mt8">
          <input class="mono" id="itmName" placeholder="+薪資 or -租金" style="min-width:200px">
          <input class="mono" id="itmAmt" type="number" step="1" placeholder="10000" style="width:160px">
          <select id="itmType">
            <option value="cost">成本</option>
            <option value="expense">費用</option>
          </select>
          <button class="btn" data-addItem>Add Item</button>
        </div>
        <div class="grid mt8">
          <table data-itmTable>
            <thead><tr><th>Name</th><th>Amount</th><th>Type</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="grid-column: span 12;">
        <div class="section-title">Word Mapping (Optional)</div>
        <div class="pair">
          <div>
            <div class="kv"><label>n-1年 薪資</label><input name="w_prev_salary" type="number" value="0"></div>
            <div class="kv"><label>n-1年 租金</label><input name="w_prev_rent" type="number" value="0"></div>
            <div class="kv"><label>n-1年 執行業務</label><input name="w_prev_prof" type="number" value="0"></div>
          </div>
          <div>
            <div class="kv"><label>n年 扣繳 薪資</label><input name="w_curr_salary" type="number" value="0"></div>
            <div class="kv"><label>n年 扣繳 租金</label><input name="w_curr_rent" type="number" value="0"></div>
            <div class="kv"><label>n年 扣繳 執行業務</label><input name="w_curr_prof" type="number" value="0"></div>
            <div class="kv"><label>n年 扣繳 自定義項 (name:amount; one per line)</label><textarea name="w_curr_custom" rows="3" placeholder="+其他:1000&#10;-捐贈:500"></textarea></div>
          </div>
        </div>
      </div>
    </div>
    <div class="sticky-bottom no-print">
      <div class="flex r">
        <button class="btn primary" data-calc>Calculate</button>
      </div>
    </div>
  </div>
</template>

<script>
const $ = (q,el=document)=>el.querySelector(q);
const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));

// state
let clients = [];

// utils
function pctToFloat(v){
  if(v==null||v==='') return 0;
  if(typeof v==='number') return v;
  v = (''+v).trim();
  if(v.endsWith('%')) return parseFloat(v)/100;
  return parseFloat(v);
}
function money(n){ n = Number.isFinite(n)? n : 0; return n.toLocaleString('en-US'); }
function floor0(n){ return Math.floor(Number(n)||0); }
function parseItemsFromDom(card){
  const rows = $$('tbody tr', card);
  const items = [];
  rows.forEach(tr=>{
    items.push({
      name: tr.querySelector('[data-name]').textContent,
      amount: +tr.querySelector('[data-amt]').textContent.replace(/,/g,''),
      type: tr.querySelector('[data-type]').textContent
    });
  });
  return items;
}
function buildClientFromCard(card){
  const g = n=> card.querySelector(`[name="${n}"]`);
  const obj = {
    code: g('code').value.trim(),
    short: g('short').value.trim(),
    yearN: +g('yearN').value||0,
    industry: g('industry').value,
    costRate: pctToFloat(g('costRate').value),
    grossRate: pctToFloat(g('grossRate').value),
    deptCostRate: pctToFloat(g('deptCostRate').value),
    deptGrossRate: pctToFloat(g('deptGrossRate').value),
    auditRate: pctToFloat(g('auditRate').value),
    incomeRate: pctToFloat(g('incomeRate').value),
    lastMethod: g('lastMethod').value.trim(),
    lastMethodRate: pctToFloat(g('lastMethodRate').value),
    rev1:+g('rev1').value||0,
    rev2:+g('rev2').value||0,
    rev3:+g('rev3').value||0,
    prepay:+g('prepay').value||0,
    nonOp:+g('nonOp').value||0,
    items: parseItemsFromDom(card),
    w_prev_salary:+g('w_prev_salary').value||0,
    w_prev_rent:+g('w_prev_rent').value||0,
    w_prev_prof:+g('w_prev_prof').value||0,
    w_curr_salary:+g('w_curr_salary').value||0,
    w_curr_rent:+g('w_curr_rent').value||0,
    w_curr_prof:+g('w_curr_prof').value||0,
    w_curr_custom:g('w_curr_custom').value||''
  };
  return obj;
}
function assertBasic(o){
  const errs = [];
  if(!o.code) errs.push('Client Code is required');
  if(!o.short) errs.push('Client Short Name is required');
  if(!o.yearN) errs.push('Year n is required');
  // rate sums
  if( Math.abs((o.costRate||0)+(o.grossRate||0) - 1) > 1e-6 ) errs.push('n-1 成本率 + 毛利率 must equal 1');
  if( Math.abs((o.deptCostRate||0)+(o.deptGrossRate||0) - 1) > 1e-6 ) errs.push('部頒 成本率 + 毛利率 must equal 1');
  return errs;
}
function calcOne(o){
  const revTotal = o.rev1 + o.rev2 + o.rev3;
  const costBase = revTotal * (o.costRate||0);
  const grossBase = revTotal * (o.grossRate||0);
  const incomeAudit = floor0( (revTotal + (o.nonOp||0)) * (o.auditRate||0) );
  const incomeRate  = floor0( (revTotal + (o.nonOp||0)) * (o.incomeRate||0) );
  const chosenIncome = Math.max(incomeAudit, incomeRate);
  // items
  let costPlus=0,costMinus=0, expPlus=0,expMinus=0;
  for(const it of (o.items||[])){
    const sign = (it.name||'').trim().startsWith('-')? -1 : +1;
    if(it.type==='cost'){
      if(sign>0) costPlus += it.amount||0;
      else costMinus += it.amount||0;
    }else{
      if(sign>0) expPlus += it.amount||0;
      else expMinus += it.amount||0;
    }
  }
  const costGap = (costBase - costMinus + costPlus);
  const tmpProfit = (grossBase - expMinus + expPlus);
  const expGap = (tmpProfit - chosenIncome);
  const totalGap = costGap + expGap;

  // final taxable & tax (一般公司 only)
  let finalA = chosenIncome;
  let taxAmt = 0;
  if(o.industry === '一般公司'){
    if(finalA <= 120000) taxAmt = 0;
    else if(finalA <= 200000) taxAmt = floor0( (finalA - 120000)/2 );
    else taxAmt = floor0( finalA * 0.20 );
  }else{
    // 行號: show only chosen income, zero out taxes
    taxAmt = 0;
  }
  const payable = taxAmt - (o.prepay||0);

  return {
    revTotal, costBase, grossBase,
    incomeAudit, incomeRate, chosenIncome,
    costGap, expGap, totalGap,
    finalA, taxAmt, payable
  };
}

// DOM builders
function addClientCard(prefill){
  const root = document.importNode($('#clientTpl').content, true);
  const card = root.querySelector('[data-client]');
  // controls
  $('[data-remove]', card).addEventListener('click', ()=> card.remove());
  $('[data-addItem]', card).addEventListener('click', ()=>{
    const name = $('#itmName', card).value.trim();
    const amt = +$('#itmAmt', card).value||0;
    const type = $('#itmType', card).value;
    if(!name){ alert('Item name is required'); return; }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td data-name class="mono">${name}</td>
      <td data-amt class="mono" style="text-align:right">${money(amt)}</td>
      <td data-type>${type}</td>
      <td><button class="btn warn" data-del>Del</button></td>`;
    $('[data-itmTable] tbody', card).appendChild(tr);
    $('[data-itmTable] tbody', card).addEventListener('click', e=>{
      if(e.target.matches('[data-del]')) e.target.closest('tr').remove();
    }, {once:true});
    $('#itmName', card).value=''; $('#itmAmt', card).value='';
  });
  if(prefill){
    // attempt to fill
    const g = n=> card.querySelector(`[name="${n}"]`);
    for(const k in prefill){
      if(g(k)){ g(k).value = prefill[k]; }
    }
    if(Array.isArray(prefill.items)){
      for(const it of prefill.items){
        $('#itmName', card).value = it.name; $('#itmAmt', card).value = it.amount; $('#itmType', card).value = it.type;
        $('[data-addItem]', card).click();
      }
    }
  }
  $('#clients')?.appendChild(card);
  return card;
}

// tabs
$$('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.dataset.tab;
    $$('.panel').forEach(p=>p.classList.remove('active'));
    $('#panel-'+id).classList.add('active');
    if(id==='results'){ buildResults(); }
    if(id==='excel'){ buildExcelPreview(); }
    if(id==='word'){ buildWordPreview(); }
  });
});

// actions
$('#btnAddClient')?.addEventListener('click', ()=> addClientCard());

$('[data-calc]')?.addEventListener('click', ()=>{
  buildResults(true);
});

$('#btnRecalc')?.addEventListener('click', ()=> buildResults(true));

$('#btnSave')?.addEventListener('click', ()=>{
  const data = cardsToState();
  localStorage.setItem('corp_tax_gap_v1', JSON.stringify(data));
  alert('Saved locally.');
});

$('#btnLoad')?.addEventListener('click', ()=>{
  const s = localStorage.getItem('corp_tax_gap_v1');
  if(!s){ alert('Nothing saved.'); return; }
  const data = JSON.parse(s);
  $('#clients').innerHTML='';
  for(const c of data){
    addClientCard(c);
  }
  alert('Loaded.');
});

$('#btnImportCsv')?.addEventListener('click', ()=>{
  const f = $('#csvIn').files?.[0];
  if(!f){ alert('Select a CSV file first.'); return; }
  const reader = new FileReader();
  reader.onload = e=>{
    const text = e.target.result;
    importCsv(text);
  };
  reader.readAsText(f, 'utf-8');
});

$('#btnExportCsv')?.addEventListener('click', ()=>{
  const rows = stateToCsvRows(cardsToState());
  const csv = rows.map(r=> r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  downloadBlob(new Blob([csv], {type:'text/csv'}), 'corp_tax_gap_data.csv');
});

$('#btnToExcel')?.addEventListener('click', ()=> exportExcelPerClient());
$('#btnToExcel2')?.addEventListener('click', ()=> exportExcelVisible());
$('#btnToWord')?.addEventListener('click', ()=> exportWordPairs());
$('#btnToWord2')?.addEventListener('click', ()=> exportWordCurrent());

$('#btnPrint')?.addEventListener('click', ()=> window.print());

// helpers
function cardsToState(){
  const list = [];
  $$('#clients [data-client]').forEach(card=> list.push(buildClientFromCard(card)));
  return list;
}
function buildResults(showAlerts=false){
  const tbody = $('#resultTable tbody'); tbody.innerHTML='';
  const cards = $$('#clients [data-client]');
  if(cards.length===0){ if(showAlerts) alert('Please add at least one client.'); return; }
  let idx=1;
  for(const card of cards){
    const o = buildClientFromCard(card);
    const errs = assertBasic(o);
    if(errs.length){ if(showAlerts) alert(errs.join('\n')); }
    const r = calcOne(o);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx++}</td>
      <td class="mono">${o.code}</td>
      <td class="mono">${o.short}</td>
      <td class="mono">${o.yearN}</td>
      <td>${o.industry}</td>
      <td class="mono" style="text-align:right">${money(r.revTotal)}</td>
      <td class="mono" style="text-align:right">${money(r.costBase)}</td>
      <td class="mono" style="text-align:right">${money(r.grossBase)}</td>
      <td class="mono" style="text-align:right">${money(r.incomeAudit)}</td>
      <td class="mono" style="text-align:right">${money(r.incomeRate)}</td>
      <td class="mono" style="text-align:right">${money(r.chosenIncome)}</td>
      <td class="mono" style="text-align:right">${r.costGap>0?'<span class="warn">缺</span> '+money(r.costGap):'<span class="ok">不缺</span>'}</td>
      <td class="mono" style="text-align:right">${r.expGap>0?'<span class="warn">缺</span> '+money(r.expGap):'<span class="ok">不缺</span>'}</td>
      <td class="mono" style="text-align:right">${(r.costGap>0||r.expGap>0)?money(r.totalGap):''}</td>
      <td class="mono" style="text-align:right">${money(r.finalA)}</td>
      <td class="mono" style="text-align:right">${money(r.taxAmt)}</td>
      <td class="mono" style="text-align:right">${money(o.prepay||0)}</td>
      <td class="mono" style="text-align:right">${money(r.payable)}</td>`;
    tbody.appendChild(tr);
  }
}

function buildExcelPreview(){
  const tbody = $('#excelPreview tbody'); tbody.innerHTML='';
  let rows = 0;
  for(const o of cardsToState()){
    const r = calcOne(o);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${o.short}#${o.code}</td>
      <td>${o.industry}</td>
      <td class="mono">${o.yearN}</td>
      <td class="mono" style="text-align:right">${money(o.rev1)}</td>
      <td class="mono" style="text-align:right">${money(o.rev2)}</td>
      <td class="mono" style="text-align:right">${money(o.rev3)}</td>
      <td class="mono" style="text-align:right">${money(r.revTotal)}</td>
      <td class="mono">${(o.costRate||0)}</td>
      <td class="mono">${(o.grossRate||0)}</td>
      <td class="mono" style="text-align:right">${money(r.costBase)}</td>
      <td class="mono" style="text-align:right">${money(r.grossBase)}</td>
      <td class="mono">${(o.auditRate||0)}</td>
      <td class="mono">${(o.incomeRate||0)}</td>
      <td class="mono" style="text-align:right">${money(r.incomeAudit)}</td>
      <td class="mono" style="text-align:right">${money(r.incomeRate)}</td>
      <td class="mono" style="text-align:right">${money(r.chosenIncome)}</td>
      <td class="mono">${(o.deptCostRate||0)}</td>
      <td class="mono">${(o.deptGrossRate||0)}</td>`;
    tbody.appendChild(tr);
    rows++;
  }
  if(rows===0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="18" style="text-align:center;color:#94a3b8">No data</td>`;
    tbody.appendChild(tr);
  }
}

function buildWordPreview(){
  const cont = $('#wordContainer'); cont.innerHTML='';
  const list = cardsToState();
  const groups = [];
  for(let i=0;i<list.length;i+=2){ groups.push(list.slice(i,i+2)); }
  if(groups.length===0){
    const p = document.createElement('div');
    p.className = 'word-page';
    p.innerHTML = `<div style="text-align:center;color:#999">No data</div>`;
    cont.appendChild(p);
    return;
  }
  for(const group of groups){
    const page = document.createElement('div'); page.className='word-page';
    const grid = document.createElement('div'); grid.className='word-grid';
    for(const o of group){
      const r = calcOne(o);
      const block = document.createElement('div'); block.className='word-block';
      const nStr = String(o.yearN||'n');
      block.innerHTML = `
        <div class="w-title">客戶名稱：<span class="mono">${o.short}</span>（代碼：<span class="mono">${o.code}</span>）</div>
        <table class="w-table">
          <tr><th colspan="4">${nStr}年扣繳申報數</th></tr>
          <tr><td>薪資</td><td class="mono" style="text-align:right">${money(o.w_curr_salary)}</td><td>租金</td><td class="mono" style="text-align:right">${money(o.w_curr_rent)}</td></tr>
          <tr><td>執行業務</td><td class="mono" style="text-align:right">${money(o.w_curr_prof)}</td><td>自定義</td><td>${formatCustom(o.w_curr_custom)}</td></tr>
        </table>
        <div style="height:4mm"></div>
        <table class="w-table">
          <tr><th colspan="4">上年度應付（${nStr-1}年）</th></tr>
          <tr><td>薪資</td><td class="mono" style="text-align:right">${money(o.w_prev_salary)}</td><td>租金</td><td class="mono" style="text-align:right">${money(o.w_prev_rent)}</td></tr>
          <tr><td>執行業務</td><td class="mono" style="text-align:right">${money(o.w_prev_prof)}</td><td>應補</td><td>${r.expGap>0?'<b style="color:#b45309">缺</b> '+money(r.expGap):'不缺'}</td></tr>
        </table>
      `;
      grid.appendChild(block);
    }
    page.appendChild(grid);
    cont.appendChild(page);
  }
}
function formatCustom(text){
  const lines = (text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(lines.length===0) return '';
  const tbl = ['<table style="width:100%;border-collapse:collapse">'];
  for(const ln of lines){
    const [name,amt] = ln.split(':').map(s=>s?.trim()||'');
    tbl.push(`<tr><td style="border:0">${name||''}</td><td style="text-align:right;border:0" class="mono">${money(+amt||0)}</td></tr>`);
  }
  tbl.push('</table>');
  return tbl.join('');
}

// CSV
const csvColumns = [
  'code','short','yearN','industry',
  'costRate','grossRate','deptCostRate','deptGrossRate',
  'auditRate','incomeRate','lastMethod','lastMethodRate',
  'rev1','rev2','rev3','prepay','nonOp',
  'w_prev_salary','w_prev_rent','w_prev_prof',
  'w_curr_salary','w_curr_rent','w_curr_prof','w_curr_custom',
  'itemsJSON'
];
function stateToCsvRows(state){
  const rows = [csvColumns];
  for(const c of state){
    const row = [];
    for(const col of csvColumns){
      if(col==='itemsJSON') row.push(JSON.stringify(c.items||[]));
      else row.push(c[col] ?? '');
    }
    rows.push(row);
  }
  return rows;
}
function importCsv(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  if(lines.length<2){ alert('CSV has no data'); return; }
  const header = lines[0].split(',').map(s=> s.replace(/^"|"$/g,'').trim());
  const idx = col => header.indexOf(col);
  $('#clients').innerHTML='';
  for(let i=1;i<lines.length;i++){
    const cols = parseCsvLine(lines[i]);
    const obj = {};
    for(const col of csvColumns){
      const j = idx(col);
      if(j>=0) obj[col] = cols[j];
    }
    // type fixes
    obj.yearN = +obj.yearN||0;
    ['costRate','grossRate','deptCostRate','deptGrossRate','auditRate','incomeRate','lastMethodRate']
      .forEach(k=> obj[k] = pctToFloat(obj[k]));
    ['rev1','rev2','rev3','prepay','nonOp','w_prev_salary','w_prev_rent','w_prev_prof','w_curr_salary','w_curr_rent','w_curr_prof']
      .forEach(k=> obj[k] = +obj[k]||0);
    try{ obj.items = JSON.parse(obj.itemsJSON||'[]') } catch{ obj.items=[] }
    addClientCard(obj);
  }
  alert('Imported.');
}
function parseCsvLine(line){
  const out=[]; let cur=''; let inq=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"' ){
      if(inq && line[i+1]==='"'){ cur+='"'; i++; }
      else inq=!inq;
    }else if(ch===',' && !inq){ out.push(cur); cur=''; }
    else cur+=ch;
  }
  out.push(cur);
  return out.map(s=> s.replace(/\r/g,'').trim());
}

// Export Excel (HTML .xls)
function exportExcelPerClient(){
  const list = cardsToState();
  if(list.length===0){ alert('No data'); return; }
  list.forEach((o,i)=>{
    const r = calcOne(o);
    const sheetHtml = `
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:x="urn:schemas-microsoft-com:office:excel"
      xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8">
<!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>
<x:Name>${o.short||'Sheet'}</x:Name>
<x:WorksheetOptions><x:Print><x:ValidPrinterInfo/></x:Print></x:WorksheetOptions>
</x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
</head>
<body>
<table border="1" style="border-collapse:collapse">
  <tr><th colspan="6">【一般公司】${o.yearN}年預估計算</th></tr>
  <tr><td>Client</td><td class="mono">${o.short}#${o.code}</td><td>Industry</td><td>${o.industry}</td><td>Year</td><td class="mono">${o.yearN}</td></tr>
  <tr><td>01-08收入</td><td class="mono" style="text-align:right">${r.revTotal - o.rev2 - o.rev3}</td><td>09-10收入</td><td class="mono" style="text-align:right">${o.rev2}</td><td>11-12收入</td><td class="mono" style="text-align:right">${o.rev3}</td></tr>
  <tr><td>全年收入</td><td class="mono" style="text-align:right">${r.revTotal}</td><td>n-1成本率</td><td class="mono">${o.costRate}</td><td>n-1毛利率</td><td class="mono">${o.grossRate}</td></tr>
  <tr><td>成本基準</td><td class="mono" style="text-align:right">${r.costBase}</td><td>毛利基準</td><td class="mono" style="text-align:right">${r.grossBase}</td><td>業外收入</td><td class="mono" style="text-align:right">${o.nonOp}</td></tr>
  <tr><td>書審率</td><td class="mono">${o.auditRate}</td><td>所得額率</td><td class="mono">${o.incomeRate}</td><td>擇優所得額</td><td class="mono" style="text-align:right">${r.chosenIncome}</td></tr>
  <tr><td>成本缺口</td><td class="mono" style="text-align:right">${r.costGap>0?r.costGap:0}</td><td>費用缺口</td><td class="mono" style="text-align:right">${r.expGap>0?r.expGap:0}</td><td>總缺口</td><td class="mono" style="text-align:right">${(r.costGap>0||r.expGap>0)?r.totalGap:0}</td></tr>
  <tr><td>Taxable(A)</td><td class="mono" style="text-align:right">${r.finalA}</td><td>營所稅額</td><td class="mono" style="text-align:right">${r.taxAmt}</td><td>應繳(扣暫繳)</td><td class="mono" style="text-align:right">${r.payable}</td></tr>
</table>
</body></html>`;
    const blob = new Blob([sheetHtml], {type:'application/vnd.ms-excel'});
    downloadBlob(blob, `corp_tax_calc_${o.short||'client'}_${i+1}.xls`);
  });
}

function exportExcelVisible(){
  const table = $('#excelPreview').outerHTML;
  const html = `
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:x="urn:schemas-microsoft-com:office:excel"
      xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="utf-8"></head><body>${table}</body></html>`;
  downloadBlob(new Blob([html], {type:'application/vnd.ms-excel'}), 'corp_tax_excel_preview.xls');
}

// Export Word (HTML .doc, 2 clients per file)
function exportWordPairs(){
  const cont = document.createElement('div');
  cont.style.padding='0';
  buildWordPreview(); // ensure built
  // clone content
  const pages = $('#wordContainer').cloneNode(true);
  const blobs = segmentIntoDocs(pages);
  blobs.forEach((blob,i)=> downloadBlob(blob, `corp_tax_word_pair_${i+1}.doc`));
}
function exportWordCurrent(){
  buildWordPreview();
  const html = `<!DOCTYPE html><html><head><meta charset="utf-8">
  <style>
  @page { size: A4; margin: 20mm 16mm; }
  table{border-collapse:collapse} td,th{border:1px solid #000;padding:2mm}
  </style>
  </head><body>${$('#wordContainer').innerHTML}</body></html>`;
  const blob = new Blob([html], {type:'application/msword'});
  downloadBlob(blob, 'corp_tax_word_preview.doc');
}
function segmentIntoDocs(pagesRoot){
  // each .word-page becomes a separate .doc
  const arr=[];
  $$('.word-page', pagesRoot).forEach((pg, idx)=>{
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8">
    <style>@page { size: A4; margin: 20mm 16mm; } table{border-collapse:collapse} td,th{border:1px solid #000;padding:2mm}</style>
    </head><body>${pg.outerHTML}</body></html>`;
    arr.push(new Blob([html], {type:'application/msword'}));
  });
  return arr;
}

function downloadBlob(blob, name){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{
    URL.revokeObjectURL(a.href);
    a.remove();
  }, 1000);
}

// bootstrap: one sample row
addClientCard({
  code:"#2767",
  short:"亞伯蘭",
  yearN:113,
  industry:"一般公司",
  costRate:0.7,grossRate:0.3,deptCostRate:0.7,deptGrossRate:0.3,
  auditRate:0.06,incomeRate:0.04,lastMethod:"書審",lastMethodRate:0.06,
  rev1:1000000,rev2:300000,rev3:300000,prepay:50000,nonOp:0,
  items:[{name:"+薪資",amount:120000,type:"expense"},{name:"-租金",amount:20000,type:"expense"}],
  w_prev_salary:500000,w_prev_rent:120000,w_prev_prof:80000,
  w_curr_salary:550000,w_curr_rent:140000,w_curr_prof:90000,
  w_curr_custom:"+其他:10000\n-捐贈:3000"
});
</script>
</body>
</html>
