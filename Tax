<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£ç¨…å‹™/æµ·é—œ/è–ªè³‡ å–®æª”é›¢ç·šå·¥å…·</title>
    <style>
        /* --- å…¨åŸŸèˆ‡åŸºæœ¬æ¨£å¼ --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --header-bg: #343a40;
            --header-text: #ffffff;
            --tab-active-bg: var(--primary-color);
            --tab-inactive-bg: #e9ecef;
            --tab-inactive-text: #495057;
            --button-bg: var(--primary-color);
            --button-hover-bg: #0056b3;
            --danger-bg: #dc3545;
            --danger-hover-bg: #c82333;
            --success-bg: #28a745;
            --code-bg: #e8eaed;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 0 1rem;
            flex-grow: 1;
        }

        /* --- æ¨™é ­èˆ‡å·¥å…·åˆ— --- */
        .app-header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 0.5rem 1rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }
        .app-header h1 {
            font-size: 1.2rem;
            margin: 0;
            white-space: nowrap;
        }
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .toolbar button, .toolbar .file-input-wrapper {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .toolbar button:hover {
            opacity: 0.85;
        }
        .file-input-wrapper input[type="file"] {
            display: none;
        }

        /* --- åˆ†é å°è¦½ --- */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1rem;
        }
        .tabs button {
            padding: 0.8rem 1rem;
            border: none;
            background-color: var(--tab-inactive-bg);
            color: var(--tab-inactive-text);
            cursor: pointer;
            font-size: 0.9rem;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tabs button.active {
            background-color: var(--card-bg);
            color: var(--primary-color);
            border: 2px solid var(--border-color);
            border-bottom: 2px solid var(--card-bg);
            font-weight: bold;
        }

        /* --- å…§å®¹å€å¡Š --- */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }
        .card h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        /* --- è¡¨å–®å…ƒä»¶ --- */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .form-group small {
            font-weight: normal;
            color: var(--secondary-color);
        }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        .main-action {
            width: 100%;
            padding: 0.8rem;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1rem;
            cursor: pointer;
        }
        .main-action:hover {
            background-color: var(--button-hover-bg);
        }

        /* --- çµæœé¡¯ç¤ºå€ --- */
        #result-display {
            position: sticky;
            top: 1rem;
        }
        #result-display h3 {
            color: var(--primary-color);
        }
        .result-block {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #eef7ff;
            border-left: 5px solid var(--primary-color);
            border-radius: 4px;
        }
        .result-final {
            font-size: 1.5rem;
            font-weight: bold;
            word-wrap: break-word;
        }
        .result-final span {
            font-size: 1rem;
            font-weight: normal;
            color: var(--secondary-color);
        }
        details {
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        summary {
            font-weight: bold;
            padding: 0.5rem;
            cursor: pointer;
            background-color: #f1f1f1;
        }
        .steps, .iteration-table {
            padding: 1rem;
            background-color: var(--card-bg);
            font-family: "Courier New", Courier, monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .iteration-table table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }
        .iteration-table th, .iteration-table td {
            border: 1px solid var(--border-color);
            padding: 0.4rem;
            text-align: right;
        }

        /* --- é å°¾ --- */
        .app-footer {
            text-align: center;
            padding: 1rem;
            background-color: var(--header-bg);
            color: var(--header-text);
            margin-top: 2rem;
        }
        .rounding-control label {
            margin: 0 0.5rem;
        }

        /* --- Toast é€šçŸ¥ --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            background-color: var(--danger-bg);
            color: white;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(-20px);
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* --- åƒæ•¸ç´šè·è¡¨ --- */
        #params-tab .card table {
            width: 100%;
            border-collapse: collapse;
        }
        #params-tab .card th, #params-tab .card td {
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            text-align: left;
        }
        #params-tab .card th {
            background-color: #f1f1f1;
        }
        #params-tab .card td input {
            width: 95%;
            border: none;
            background: transparent;
        }
        #params-tab .card .action-cell { text-align: center; }

        /* --- åˆ—å°æ¨£å¼ --- */
        @media print {
            body {
                font-size: 10pt;
                color: #000;
                background-color: #fff;
            }
            .app-header, .tabs, .app-footer, .no-print {
                display: none !important;
            }
            .container {
                max-width: 100%;
                margin: 0;
                padding: 0;
            }
            .tab-content.active {
                display: block !important;
            }
            .module-grid {
                grid-template-columns: 1fr;
                gap: 0;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                border-radius: 0;
                padding: 1rem;
                page-break-inside: avoid;
            }
            h3 {
                font-size: 1.2rem;
            }
            input, select, textarea {
                border: 1px solid #ccc;
            }
            details {
                page-break-inside: avoid;
            }
            details[open] summary {
                background-color: #eee;
            }
            details[open] {
                border-color: #999;
            }
            .iteration-table td, .iteration-table th {
                padding: 2px 4px;
            }
            /* ç¢ºä¿è¨ˆç®—çµæœå€èˆ‡è¼¸å…¥å€éƒ½åœ¨åŒä¸€é  */
            #calculator-column, #result-column {
                 width: 100% !important;
            }
            .module-grid {
                display: block;
            }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <h1>ğŸ‡¹ğŸ‡¼ ç¨…å‹™é›¢ç·šå·¥å…·</h1>
        <div class="toolbar no-print">
            <button type="button" data-action="createRestorePoint">å»ºç«‹é‚„åŸé»</button>
            <button type="button" data-action="exportBackup">åŒ¯å‡ºå‚™ä»½ (JSON)</button>
            <label class="file-input-wrapper">
                åŒ¯å…¥å‚™ä»½
                <input type="file" id="import-file-input" accept=".json" data-action="importBackup">
            </label>
            <button type="button" data-action="runTests">åŸ·è¡Œå…§å»ºæ¸¬è©¦</button>
            <button type="button" data-action="print">åˆ—å°</button>
            <button type="button" data-action="resetApp" style="background-color: var(--danger-bg);">é‡ç½® App</button>
        </div>
    </header>

    <div class="container">
        <nav class="tabs no-print">
            <button type="button" class="tab-link active" data-tab="vat">VAT/ç™¼ç¥¨ (F1)</button>
            <button type="button" class="tab-link" data-tab="withholding">æ‰£ç¹³/äºŒä»£å¥ä¿ (F2)</button>
            <button type="button" class="tab-link" data-tab="customs">æµ·é—œ/é€²å£ (F3-F6)</button>
            <button type="button" class="tab-link" data-tab="local-tax">åœ°æ–¹/ç‰¹ç¨®ç¨… (F7-F11)</button>
            <button type="button" class="tab-link" data-tab="salary">è–ªè³‡é æ‰£ (F12)</button>
            <button type="button" class="tab-link" data-tab="ifrs16">IFRS 16 (F13-F14)</button>
            <button type="button" class="tab-link" data-tab="splitter">è½‰å¸³åˆ†æ‹† (F15)</button>
            <button type="button" class="tab-link" data-tab="params">âš™ï¸ åƒæ•¸/ç´šè·è¡¨</button>
            <button type="button" class="tab-link" data-tab="history">ğŸ”„ æ­·å²/å›æ»¾</button>
        </nav>

        <main id="main-content">

            <div id="vat-tab" class="tab-content active">
                <div class="module-grid">
                    <div id="calculator-column" class="card">
                        <h3>ç‡Ÿæ¥­ç¨… (VAT) è¨ˆç®—</h3>
                        <div class="form-group">
                            <label for="vat-mode">è¨ˆç®—æ¨¡å¼</label>
                            <select id="vat-mode">
                                <option value="NtoG">æœªç¨… (N) â†’ å«ç¨… (G)</option>
                                <option value="GtoN">å«ç¨… (G) â†’ æœªç¨… (N)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vat-amount">é‡‘é¡</label>
                            <input type="number" id="vat-amount" placeholder="è¼¸å…¥æœªç¨…æˆ–å«ç¨…é‡‘é¡">
                        </div>
                        <div class="form-group">
                            <label for="vat-rate">ç¨…ç‡ <small>(ä¾‹å¦‚: 0.05 æˆ– 5%)</small></label>
                            <input type="text" id="vat-rate" value="5%">
                        </div>
                        <button type="button" class="main-action" data-action="calculateVat">è¨ˆç®—</button>
                        <h3 style="margin-top: 2rem;">æ‰¹é‡ CSV è¨ˆç®—</h3>
                        <div class="form-group">
                            <label for="vat-csv">è²¼ä¸Š CSV è³‡æ–™ <small>(é¦–æ¬„ç‚ºæ¨™é¡Œï¼Œæ¬¡æ¬„ç‚ºé‡‘é¡)</small></label>
                            <textarea id="vat-csv" placeholder="ä¾‹å¦‚ï¼š&#10;ID,Amount&#10;A01,1000&#10;A02,2500"></textarea>
                        </div>
                        <button type="button" class="main-action" data-action="calculateVatCsv">æ‰¹é‡è¨ˆç®—ä¸¦ä¸‹è¼‰</button>
                    </div>
                    <div id="result-column" class="card">
                        <h3>è¨ˆç®—çµæœ</h3>
                        <div id="vat-result" class="result-block-container">è«‹å¡«å¯«å·¦å´æ¬„ä½ä¸¦æŒ‰è¨ˆç®—ã€‚</div>
                    </div>
                </div>
            </div>

            <div id="withholding-tab" class="tab-content">
                 <div class="module-grid">
                    <div class="card">
                        <h3>æ‰£ç¹³åŠäºŒä»£å¥ä¿è£œå……ä¿è²»</h3>
                         <div class="form-group">
                            <label for="wh-mode">è¨ˆç®—æ¨¡å¼</label>
                            <select id="wh-mode">
                                <option value="AtoN">çµ¦ä»˜ç¸½é¡ (A) â†’ å¯¦ä»˜æ·¨é¡ (N)</option>
                                <option value="NtoA">å¯¦ä»˜æ·¨é¡ (N) â†’ çµ¦ä»˜ç¸½é¡ (A) [åæ¨]</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="wh-amount">é‡‘é¡</label>
                            <input type="number" id="wh-amount" placeholder="è¼¸å…¥ç¸½é¡æˆ–æ·¨é¡">
                        </div>
                        <div class="form-group">
                            <label for="wh-tax-rate">æ‰£ç¹³ç‡ (r_w)</label>
                            <input type="text" id="wh-tax-rate" placeholder="ä¾‹å¦‚: 0.1 æˆ– 10%">
                        </div>
                        <div class="form-group">
                            <label for="wh-nhi-rate">äºŒä»£å¥ä¿è£œå……ä¿è²»ç‡ (r_h)</label>
                            <input type="text" id="wh-nhi-rate" placeholder="ä½¿ç”¨åƒæ•¸å€è¨­å®š">
                        </div>
                         <div class="form-group">
                            <label for="wh-nhi-threshold">äºŒä»£å¥ä¿é–€æª» (H)</label>
                            <input type="number" id="wh-nhi-threshold" placeholder="ä½¿ç”¨åƒæ•¸å€è¨­å®š">
                        </div>
                        <button type="button" class="main-action" data-action="calculateWithholding">è¨ˆç®—</button>
                    </div>
                    <div class="card">
                        <h3>è¨ˆç®—çµæœ</h3>
                        <div id="wh-result" class="result-block-container"></div>
                    </div>
                </div>
            </div>

            <div id="customs-tab" class="tab-content">
                <div class="module-grid">
                    <div class="card">
                       <h3>(F3) å®Œç¨…åƒ¹æ ¼ (CIF) è¨ˆç®—</h3>
                        <div class="form-group">
                            <label for="cif-base-price">é›¢å²¸åƒ¹æ ¼ (FOB)</label>
                            <input type="number" id="cif-fob" placeholder="è²¨ç‰©æœ¬èº«åƒ¹æ ¼">
                        </div>
                         <div class="form-group">
                            <label for="cif-freight">é‹è²» (F)</label>
                            <input type="number" id="cif-freight" placeholder="åˆ°é€²å£æ¸¯ä¹‹é‹è²»">
                        </div>
                        <div class="form-group">
                            <label for="cif-insurance">ä¿éšªè²» (I)</label>
                            <input type="number" id="cif-insurance" placeholder="è‹¥ç„¡å‰‡ä¾æç¤ºç‡ä¼°ç®—">
                        </div>
                        <button type="button" class="main-action" data-action="calculateCif">è¨ˆç®— CIF</button>
                        <hr style="margin: 2rem 0;">
                        <h3>(F5) åæ¨ CIF from ç¸½æˆæœ¬</h3>
                        <div class="form-group">
                            <label for="rev-landed-cost">ç›®æ¨™é€²å£ç¸½æˆæœ¬ (Landed Cost)</label>
                            <input type="number" id="rev-landed-cost" placeholder="è¼¸å…¥æœ€çµ‚ç›®æ¨™æˆæœ¬">
                        </div>
                        <p><small>è«‹å…ˆåœ¨å³å´å¡«å¯« F4 çš„å„é …ç¨…ç‡åƒæ•¸ã€‚</small></p>
                        <button type="button" class="main-action" data-action="reverseCalculateLandedCost">åæ¨ CIF</button>
                    </div>
                    <div class="card">
                        <h3>(F4) é€²å£ç¸½æˆæœ¬ (Landed Cost) è¨ˆç®—</h3>
                        <div class="form-group">
                            <label for="lc-cif">å®Œç¨…åƒ¹æ ¼ (CIF)</label>
                            <input type="number" id="lc-cif" placeholder="å¾ F3 è¨ˆç®—æˆ–æ‰‹å‹•è¼¸å…¥">
                        </div>
                        <div class="form-group"><label for="lc-duty-rate">é—œç¨… (d)</label><input type="text" id="lc-duty-rate" value="10%"></div>
                        <div class="form-group"><label for="lc-excise-rate">è²¨ç‰©/é…’ç¨… (c)</label><input type="text" id="lc-excise-rate" value="15%"></div>
                        <div class="form-group"><label for="lc-vat-rate">ç‡Ÿæ¥­ç¨… (t_v)</label><input type="text" id="lc-vat-rate" value="5%"></div>
                        <div class="form-group"><label for="lc-fixed-tax">å›ºå®šç¨… (Ï„)</label><input type="number" id="lc-fixed-tax" value="0"></div>
                        <div class="form-group"><label for="lc-health-surcharge">å¥åº·æ (h)</label><input type="number" id="lc-health-surcharge" value="0"></div>
                        <div class="form-group"><label for="lc-promotion-fee">æ¨å»£è²» (p)</label><input type="text" id="lc-promotion-fee" value="0.04%"></div>
                        <div class="form-group">
                            <input type="checkbox" id="lc-bonded" style="width: auto;">
                            <label for="lc-bonded" style="display: inline;">ä¿ç¨…/FTA (é—œç¨…ç‚º0)</label>
                        </div>
                        <button type="button" class="main-action" data-action="calculateLandedCost">è¨ˆç®—ç¸½æˆæœ¬</button>
                    </div>
                </div>
                 <div class="card" style="margin-top: 1.5rem;">
                    <h3>è¨ˆç®—çµæœ</h3>
                    <div id="customs-result" class="result-block-container"></div>
                </div>
            </div>

            <div id="local-tax-tab" class="tab-content">
                <p>æ­¤åŠŸèƒ½æ­£åœ¨å»ºæ§‹ä¸­...</p>
            </div>
            
            <div id="salary-tab" class="tab-content">
                <div class="module-grid">
                    <div class="card">
                        <h3>è–ªè³‡æ‰€å¾—ç¨…é æ‰£</h3>
                         <div class="form-group">
                            <label for="salary-mode">è¨ˆç®—æ¨¡å¼</label>
                            <select id="salary-mode">
                                <option value="GtoN">æ¯›è–ª (G) â†’ å¯¦é ˜æ·¨è–ª (N)</option>
                                <option value="NtoG">å¯¦é ˜æ·¨è–ª (N) â†’ æ¯›è–ª (G) [åæ¨]</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="salary-amount">è–ªè³‡é‡‘é¡</label>
                            <input type="number" id="salary-amount" placeholder="è¼¸å…¥æ¯›è–ªæˆ–æ·¨è–ª">
                        </div>
                        <p><small>å°‡ä½¿ç”¨ã€Œåƒæ•¸/ç´šè·è¡¨ã€åˆ†é ä¸­è¨­å®šçš„è–ªè³‡ç´šè·è¡¨é€²è¡Œè¨ˆç®—ã€‚</small></p>
                        <button type="button" class="main-action" data-action="calculateSalary">è¨ˆç®—</button>
                        <h3 style="margin-top: 2rem;">æ‰¹é‡ CSV è¨ˆç®—</h3>
                        <div class="form-group">
                            <label for="salary-csv">è²¼ä¸Š CSV è³‡æ–™ <small>(é¦–æ¬„ç‚ºæ¨™é¡Œï¼Œæ¬¡æ¬„ç‚ºæ¯›è–ª)</small></label>
                            <textarea id="salary-csv" placeholder="ä¾‹å¦‚ï¼š&#10;Employee,GrossSalary&#10;E01,50000&#10;E02,85000"></textarea>
                        </div>
                        <button type="button" class="main-action" data-action="calculateSalaryCsv">æ‰¹é‡è¨ˆç®—ä¸¦ä¸‹è¼‰</button>
                    </div>
                    <div class="card">
                        <h3>è¨ˆç®—çµæœ</h3>
                        <div id="salary-result" class="result-block-container"></div>
                    </div>
                </div>
            </div>

            <div id="ifrs16-tab" class="tab-content">
                <div class="module-grid">
                    <div class="card">
                       <h3>(F13) å¹´é‡‘ç¾å€¼ (PV)</h3>
                        <div class="form-group">
                            <label for="pv-payment">æ¯æœŸä»˜æ¬¾ (P)</label>
                            <input type="number" id="pv-payment">
                        </div>
                         <div class="form-group">
                            <label for="pv-periods">æœŸæ•¸ (n)</label>
                            <input type="number" id="pv-periods">
                        </div>
                        <div class="form-group">
                            <label for="pv-rate">æœˆåˆ©ç‡ (r_m) <small>ä¾‹å¦‚: 0.005 (0.5%)</small></label>
                            <input type="number" id="pv-rate" step="0.0001">
                        </div>
                        <button type="button" class="main-action" data-action="calculatePV">è¨ˆç®—ç¾å€¼</button>
                    </div>
                    <div class="card">
                        <h3>(F14) å…§éƒ¨å ±é…¬ç‡ (IRR) åæ¨</h3>
                        <div class="form-group">
                            <label for="irr-pv">ç¾å€¼ (PV)</label>
                            <input type="number" id="irr-pv">
                        </div>
                        <div class="form-group">
                            <label for="irr-payment">æ¯æœŸä»˜æ¬¾ (P)</label>
                            <input type="number" id="irr-payment">
                        </div>
                        <div class="form-group">
                            <label for="irr-periods">æœŸæ•¸ (n)</label>
                            <input type="number" id="irr-periods">
                        </div>
                        <p><small>å°‡ä½¿ç”¨ç‰›é “æ³•/äºŒåˆ†æ³•åæ¨æœˆåˆ©ç‡ã€‚</small></p>
                        <button type="button" class="main-action" data-action="calculateIRR">è¨ˆç®— IRR</button>
                    </div>
                </div>
                 <div class="card" style="margin-top: 1.5rem;">
                    <h3>è¨ˆç®—çµæœ</h3>
                    <div id="ifrs16-result" class="result-block-container"></div>
                </div>
            </div>

            <div id="splitter-tab" class="tab-content">
                 <div class="module-grid">
                    <div class="card">
                        <h3>è½‰å¸³é‡‘é¡åˆ†æ‹†</h3>
                        <div class="form-group">
                            <label for="split-limit">å–®ç­†è½‰å¸³ä¸Šé™</label>
                            <input type="number" id="split-limit" placeholder="ä¾‹å¦‚: 50000">
                        </div>
                        <div class="form-group">
                            <label for="split-amounts">ç•¶æ—¥é‡‘é¡åºåˆ— <small>(ä»¥é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”)</small></label>
                            <textarea id="split-amounts" placeholder="ä¾‹å¦‚:&#10;20000, 35000, 48000, 15000, 51000"></textarea>
                        </div>
                        <button type="button" class="main-action" data-action="calculateSplit">åŸ·è¡Œåˆ†æ‹†</button>
                    </div>
                    <div class="card">
                        <h3>è¨ˆç®—çµæœ</h3>
                        <div id="split-result" class="result-block-container"></div>
                    </div>
                </div>
            </div>

            <div id="params-tab" class="tab-content">
                <div class="module-grid">
                    <div class="card">
                        <h3>ç³»çµ±åƒæ•¸</h3>
                        <div class="form-group">
                            <label for="param-vat-rate">ç‡Ÿæ¥­ç¨…ç‡ (VAT)</label>
                            <input type="text" id="param-vat-rate">
                        </div>
                         <div class="form-group">
                            <label for="param-nhi-rate">äºŒä»£å¥ä¿è£œå……ä¿è²»ç‡</label>
                            <input type="text" id="param-nhi-rate">
                        </div>
                        <div class="form-group">
                            <label for="param-nhi-threshold">äºŒä»£å¥ä¿èµ·æ‰£é–€æª»</label>
                            <input type="number" id="param-nhi-threshold">
                        </div>
                         <button type="button" class="main-action" data-action="saveParams">å„²å­˜åƒæ•¸</button>
                    </div>
                    <div class="card">
                        <h3>è–ªè³‡æ‰€å¾—ç¨…ç´šè·è¡¨</h3>
                        <table id="salary-brackets-table">
                            <thead>
                                <tr><th>ç´šè·ä¸Šé™ (æœˆ)</th><th>ç¨…ç‡ (%)</th><th>é€Ÿç®—æ‰£é™¤æ•¸</th><th>æ“ä½œ</th></tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <button type="button" data-action="addSalaryBracket" style="margin-top: 1rem;">æ–°å¢ä¸€åˆ—</button>
                        <button type="button" data-action="saveSalaryBrackets" class="main-action" style="margin-top: 1rem;">å„²å­˜ç´šè·è¡¨</button>
                    </div>
                </div>
                <div class="card" style="margin-top: 1.5rem;">
                     <h3>CSV å°æ‡‰ç²¾éˆ (åŒ¯å…¥è–ªè³‡ç´šè·)</h3>
                     <div class="form-group">
                         <label for="csv-paste-area">1. è²¼ä¸Šå®˜æ–¹æˆ–è‡ªå‚™çš„ç´šè· CSV</label>
                         <textarea id="csv-paste-area" placeholder="è²¼ä¸Š CSV å…§å®¹ï¼Œé¦–åˆ—æ‡‰ç‚ºæ¨™é¡Œ"></textarea>
                     </div>
                     <div id="csv-mapping-ui" style="display:none;">
                         <p>2. æŒ‡å®šå°æ‡‰æ¬„ä½</p>
                         <div style="display:flex; gap: 1rem;">
                             <div class="form-group"><label for="csv-col-upper">ç´šè·ä¸Šé™ (upper)</label><select id="csv-col-upper"></select></div>
                             <div class="form-group"><label for="csv-col-rate">ç¨…ç‡ (rate)</label><select id="csv-col-rate"></select></div>
                             <div class="form-group"><label for="csv-col-qd">é€Ÿç®—æ‰£é™¤æ•¸ (qd)</label><select id="csv-col-qd"></select></div>
                         </div>
                         <div class="form-group">
                             <input type="checkbox" id="csv-rate-is-percent" checked style="width: auto;">
                             <label for="csv-rate-is-percent" style="display: inline;">ç¨…ç‡æ¬„ä½æ˜¯ç™¾åˆ†æ¯” (ä¾‹å¦‚: 5 ä»£è¡¨ 5%)</label>
                         </div>
                         <button type="button" class="main-action" data-action="previewCsvBrackets">3. è§£æä¸¦é è¦½</button>
                     </div>
                     <div id="csv-preview-area" style="margin-top: 1rem;"></div>
                </div>
            </div>

            <div id="history-tab" class="tab-content">
                <div class="module-grid">
                    <div class="card">
                        <h3>ç‰ˆæœ¬å¿«ç…§ (Versions)</h3>
                        <p>æ‰‹å‹•å„²å­˜çš„åƒæ•¸è¨­å®šé›†ï¼Œå¯ç”¨æ–¼ä¸åŒå¹´åº¦æˆ–æƒ…å¢ƒåˆ‡æ›ã€‚</p>
                        <div id="versions-list"></div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <input type="text" id="new-version-name" placeholder="è¼¸å…¥æ–°ç‰ˆæœ¬åç¨±">
                            <button type="button" class="main-action" data-action="saveVersion" style="margin-top: 0.5rem;">å„²å­˜ç•¶å‰è¨­å®šç‚ºæ–°ç‰ˆæœ¬</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>é‚„åŸé» (Restore Points)</h3>
                        <p>æ“ä½œå‰çš„è‡ªå‹•æˆ–æ‰‹å‹•å¿«ç…§ï¼Œç”¨æ–¼å¿«é€Ÿå¾©åŸéŒ¯èª¤æ“ä½œã€‚</p>
                        <div id="restore-points-list"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <footer class="app-footer no-print">
        <div class="rounding-control">
            <strong>è¨ˆç®—è¦å‰‡ï¼š</strong>
            <label><input type="radio" name="rounding" value="round" checked> å››æ¨äº”å…¥</label>
            <label><input type="radio" name="rounding" value="ceil"> ç„¡æ¢ä»¶é€²ä½</label>
            <label><input type="radio" name="rounding" value="floor"> ç„¡æ¢ä»¶æ¨å»</label>
            <small>(æ‰€æœ‰ç¨…é¡è¨ˆç®—åˆ°æ•´æ•¸ä½)</small>
        </div>
    </footer>

    <div id="toast-container"></div>
    
    <script type="application/json" id="initial-data">
    {
        "params": {
            "vatRate": 0.05,
            "nhiRate": 0.0211,
            "nhiThreshold": 20000,
            "salaryBrackets": [
                {"upper": 45000, "rate": 0.06, "qd": 0},
                {"upper": 50000, "rate": 0.06, "qd": 0},
                {"upper": 60000, "rate": 0.06, "qd": 0},
                {"upper": Infinity, "rate": 0.18, "qd": 8400} 
            ]
        },
        "versions": [],
        "restorePoints": []
    }
    </script>

    <script defer>
    // --- å…¨åŸŸéŒ¯èª¤æ””æˆªï¼Œé¿å…ã€Œçœ‹ä¼¼æ²’åæ‡‰ã€ ---
    // è¨»è§£ï¼šæ­¤è™•æ””æˆªå…¨åŸŸéŒ¯èª¤ï¼Œä¸¦ä»¥ Toast è¨Šæ¯é¡¯ç¤ºï¼Œæ–¹ä¾¿é›¢ç·šåµéŒ¯ã€‚
    window.onerror = function (message, source, lineno, colno, error) {
        TaxApp.ui.showToast(`JavaScript éŒ¯èª¤: ${message} at ${lineno}:${colno}`);
        console.error({ message, source, lineno, colno, error });
        return true;
    };
    window.addEventListener('unhandledrejection', function (event) {
        TaxApp.ui.showToast(`éåŒæ­¥éŒ¯èª¤: ${event.reason}`);
        console.error(event);
    });

    // --- ä¸»æ‡‰ç”¨ç¨‹å¼å‘½åç©ºé–“ ---
    const TaxApp = {
        state: {
            params: {},
            versions: [],
            restorePoints: []
        },

        // --- åˆå§‹åŒ– ---
        init() {
            this.loadState();
            this.events.setup();
            this.ui.renderInitialView();
            console.log("ç¨…å‹™å·¥å…·åˆå§‹åŒ–å®Œæˆã€‚");
        },

        // --- ç‹€æ…‹ç®¡ç† ---
        loadState() {
            try {
                const storedState = localStorage.getItem('taxApp_state');
                if (storedState) {
                    this.state = JSON.parse(storedState);
                } else {
                    const initialState = JSON.parse(document.getElementById('initial-data').textContent);
                    this.state = initialState;
                    this.saveState();
                    this.ui.showToast("åµæ¸¬åˆ°é¦–æ¬¡ä½¿ç”¨ï¼Œå·²è¼‰å…¥é è¨­è³‡æ–™ã€‚");
                }
            } catch (e) {
                console.error("è®€å– localStorage å¤±æ•—:", e);
                this.ui.showToast("è®€å–æœ¬åœ°è³‡æ–™å¤±æ•—ï¼Œå°‡ä½¿ç”¨é è¨­å€¼ã€‚");
                const initialState = JSON.parse(document.getElementById('initial-data').textContent);
                this.state = initialState;
            }
        },

        saveState() {
            try {
                localStorage.setItem('taxApp_state', JSON.stringify(this.state));
            } catch (e) {
                console.error("å„²å­˜ localStorage å¤±æ•—:", e);
                this.ui.showToast("å„²å­˜è¨­å®šåˆ°æœ¬åœ°å¤±æ•—ï¼Œå¯èƒ½å·²æ»¿æˆ–ç€è¦½å™¨ä¸æ”¯æ´ã€‚");
            }
        },
        
        createRestorePoint(name) {
            const point = {
                id: `rp_${new Date().getTime()}`,
                name: name || `é‚„åŸé» @ ${new Date().toLocaleString()}`,
                timestamp: new Date().toISOString(),
                state: JSON.parse(JSON.stringify(this.state)) // Deep copy
            };
            this.state.restorePoints.unshift(point);
            if (this.state.restorePoints.length > 20) { // Keep last 20
                this.state.restorePoints.pop();
            }
            this.saveState();
            this.ui.renderHistory();
            this.ui.showToast(`å·²å»ºç«‹é‚„åŸé»: ${point.name}`, 'success');
        },

        // --- æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---
        calculations: {
            // ... (è¨ˆç®—å‡½å¼å°‡åœ¨æ­¤è™•å®šç¾©)
        },

        // --- UI æ›´æ–°é‚è¼¯ ---
        ui: {
            // ... (UI ç›¸é—œå‡½å¼å°‡åœ¨æ­¤è™•å®šç¾©)
        },

        // --- äº‹ä»¶è™•ç† ---
        events: {
            // ... (äº‹ä»¶ç›£è½å™¨å°‡åœ¨æ­¤è™•å®šç¾©)
        },

        // --- å·¥å…·å‡½å¼ ---
        utils: {
            // ... (å…±ç”¨å‡½å¼å°‡åœ¨æ­¤è™•å®šç¾©)
        }
    };
    
    // --- å¯¦ä½œå„æ¨¡çµ„ ---
    
    // =============================
    //      UTILITIES (TaxApp.utils)
    // =============================
    TaxApp.utils = {
        // è§£æè¼¸å…¥çš„ç™¾åˆ†æ¯”æˆ–å°æ•¸
        parseRate(input) {
            if (typeof input !== 'string') input = String(input);
            input = input.trim();
            if (input.endsWith('%')) {
                return parseFloat(input.slice(0, -1)) / 100;
            }
            return parseFloat(input);
        },

        // æ ¹æ“šä½¿ç”¨è€…é¸æ“‡çš„è¦å‰‡é€²è¡Œå››æ¨äº”å…¥
        round(value) {
            const rule = document.querySelector('input[name="rounding"]:checked').value;
            if (rule === 'ceil') return Math.ceil(value);
            if (rule === 'floor') return Math.floor(value);
            return Math.round(value); // 'round'
        },
        
        // æ ¼å¼åŒ–æ•¸å­—ç‚ºåƒåˆ†ä½
        formatNumber(num) {
            if (num === null || num === undefined) return '';
            return num.toLocaleString('en-US');
        },

        // ç°¡å–®çš„ CSV è§£æå™¨ï¼Œæ”¯æ´å¼•è™Ÿ
        parseCSV(text) {
            // è¨»è§£ï¼šæ­¤è§£æå™¨ç‚ºç°¡åŒ–ç‰ˆï¼Œé©ç”¨æ–¼é›¢ç·šå·¥å…·ã€‚
            // è‹¥è¦è™•ç†è¤‡é›œè½‰ç¾©ï¼Œå»ºè­°ä½¿ç”¨æ›´å¼·å¥çš„å‡½å¼åº«ã€‚
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            
            const header = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const row = {};
                const values = lines[i].split(','); // ç°¡åŒ–ç‰ˆåˆ†å‰²
                header.forEach((key, index) => {
                    row[key] = values[index] ? values[index].trim() : '';
                });
                data.push(row);
            }
            return data;
        },

        // ç”¢ç”Ÿ CSV å…§å®¹ä¸¦è§¸ç™¼ä¸‹è¼‰
        downloadCSV(filename, csvContent) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    // =============================
    //      UI (TaxApp.ui)
    // =============================
    TaxApp.ui = {
        showToast(message, type = 'error') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (type === 'success') {
                toast.style.backgroundColor = 'var(--success-bg)';
            }
            toast.textContent = message;
            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Auto hide
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 500);
            }, 5000);
        },
        
        renderResult(containerId, result) {
            const container = document.getElementById(containerId);
            if (!result) {
                container.innerHTML = '<p>è¨ˆç®—å‡ºéŒ¯æˆ–ç„¡çµæœã€‚</p>';
                return;
            }

            let html = `
                <div class="result-block">
                    <div class="result-final">${result.final.label}: ${TaxApp.utils.formatNumber(result.final.value)}</div>
                    ${result.final.sub ? `<p>${result.final.sub}</p>` : ''}
                </div>
            `;

            if (result.steps) {
                html += `
                    <details open>
                        <summary>å±•é–‹è¨ˆç®—æ­¥é©Ÿ</summary>
                        <div class="steps">${result.steps}</div>
                    </details>
                `;
            }

            if (result.iterationTable) {
                 html += `
                    <details open>
                        <summary>è¿­ä»£æ”¶æ–‚è¡¨</summary>
                        <div class="iteration-table">
                            <table>
                                <thead><tr>${result.iterationTable.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                                <tbody>
                                    ${result.iterationTable.rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </details>
                `;
            }
            container.innerHTML = html;
        },
        
        renderInitialView() {
            // è¼‰å…¥åƒæ•¸åˆ° UI
            document.getElementById('param-vat-rate').value = TaxApp.state.params.vatRate * 100 + '%';
            document.getElementById('param-nhi-rate').value = TaxApp.state.params.nhiRate * 100 + '%';
            document.getElementById('param-nhi-threshold').value = TaxApp.state.params.nhiThreshold;
            
            // é å¡«éƒ¨åˆ†æ¬„ä½
            document.getElementById('wh-nhi-rate').value = TaxApp.state.params.nhiRate * 100 + '%';
            document.getElementById('wh-nhi-threshold').value = TaxApp.state.params.nhiThreshold;

            this.renderSalaryBrackets();
            this.renderHistory();
        },
        
        renderSalaryBrackets() {
            const tbody = document.querySelector('#salary-brackets-table tbody');
            tbody.innerHTML = '';
            TaxApp.state.params.salaryBrackets.forEach((bracket, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="number" value="${isFinite(bracket.upper) ? bracket.upper : ''}" placeholder="Infinity" data-index="${index}" data-field="upper"></td>
                    <td><input type="number" value="${bracket.rate * 100}" data-index="${index}" data-field="rate"></td>
                    <td><input type="number" value="${bracket.qd}" data-index="${index}" data-field="qd"></td>
                    <td class="action-cell"><button type="button" data-action="removeSalaryBracket" data-index="${index}">-</button></td>
                `;
                tbody.appendChild(tr);
            });
        },
        
        renderHistory() {
            const versionsList = document.getElementById('versions-list');
            versionsList.innerHTML = '<h4>å¯ç”¨ç‰ˆæœ¬</h4>';
            if (TaxApp.state.versions.length === 0) {
                versionsList.innerHTML += '<p>å°šç„¡å·²å„²å­˜çš„ç‰ˆæœ¬ã€‚</p>';
            } else {
                TaxApp.state.versions.forEach(v => {
                    versionsList.innerHTML += `
                        <div style="border-bottom: 1px solid #eee; padding: 0.5rem 0;">
                            <strong>${v.name}</strong> <small>(${new Date(v.timestamp).toLocaleString()})</small>
                            <button type="button" data-action="loadVersion" data-id="${v.id}">è¼‰å…¥</button>
                            <button type="button" data-action="deleteVersion" data-id="${v.id}">åˆªé™¤</button>
                        </div>
                    `;
                });
            }

            const rpList = document.getElementById('restore-points-list');
            rpList.innerHTML = '<h4>é‚„åŸé»åˆ—è¡¨ (æœ€æ–° 20 ç­†)</h4>';
             if (TaxApp.state.restorePoints.length === 0) {
                rpList.innerHTML += '<p>å°šç„¡é‚„åŸé»ã€‚</p>';
            } else {
                TaxApp.state.restorePoints.forEach(rp => {
                    rpList.innerHTML += `
                        <div style="border-bottom: 1px solid #eee; padding: 0.5rem 0;">
                            ${rp.name}
                            <button type="button" data-action="rollback" data-id="${rp.id}">å›æ»¾è‡³æ­¤</button>
                        </div>
                    `;
                });
            }
        }
    };
    
    // ==================================
    // CALCULATIONS (TaxApp.calculations)
    // ==================================
    TaxApp.calculations = {
        vat({ mode, amount, rate }) {
            let n, g, t;
            let steps = `ä½¿ç”¨åƒæ•¸:\n  æ¨¡å¼ = ${mode}\n  é‡‘é¡ = ${amount}\n  ç¨…ç‡ = ${rate * 100}%\n`;

            if (mode === 'NtoG') {
                n = amount;
                t = TaxApp.utils.round(n * rate);
                g = n + t;
                steps += `1. è¨ˆç®—ç¨…é¡ (T): ${n} * ${rate} = ${n * rate} â†’ (å–æ•´) â†’ ${t}\n`;
                steps += `2. è¨ˆç®—å«ç¨…é¡ (G): ${n} + ${t} = ${g}`;
                return { final: { label: 'å«ç¨…é¡ (G)', value: g, sub: `æœªç¨…é¡ (N) = ${n}, ç¨…é¡ (T) = ${t}` }, steps };
            } else { // GtoN
                g = amount;
                // G = N + round(N * r)  =>  G approx N * (1+r)  => N approx G / (1+r)
                n = TaxApp.utils.round(g / (1 + rate));
                t = g - n;
                steps += `1. æ¨ç®—æœªç¨…é¡ (N): ${g} / (1 + ${rate}) = ${g / (1 + rate)} â†’ (å–æ•´) â†’ ${n}\n`;
                steps += `2. è¨ˆç®—ç¨…é¡ (T): ${g} - ${n} = ${t}\n`;
                steps += `3. é©—è­‰: ${n} + round(${n}*${rate}) = ${n} + ${TaxApp.utils.round(n*rate)} = ${n + TaxApp.utils.round(n*rate)} (æ‡‰æ¥è¿‘ ${g})`;
                return { final: { label: 'æœªç¨…é¡ (N)', value: n, sub: `å«ç¨…é¡ (G) = ${g}, ç¨…é¡ (T) = ${t}` }, steps };
            }
        },

        withholding({ mode, amount, r_w, r_h, H }) {
            let a, n, t, h;
            let steps = `ä½¿ç”¨åƒæ•¸:\n  æ‰£ç¹³ç‡ r_w = ${r_w*100}%\n  å¥ä¿ç‡ r_h = ${r_h*100}%\n  é–€æª» H = ${H}\n`;
            
            if (mode === 'AtoN') {
                a = amount;
                t = TaxApp.utils.round(a * r_w);
                h = a > H ? TaxApp.utils.round(a * r_h) : 0;
                n = a - t - h;
                steps += `1. è¨ˆç®—æ‰£ç¹³ç¨…é¡ (T): ${a} * ${r_w} = ${a*r_w} â†’ ${t}\n`;
                steps += `2. åˆ¤æ–·å¥ä¿è£œå……ä¿è²»: ${a} ${a > H ? '>' : '<='} ${H}\n`;
                steps += `3. è¨ˆç®—å¥ä¿è£œå……ä¿è²» (H_fee): ${a > H ? `${a} * ${r_h} = ${a*r_h} â†’ ${h}` : '0'}\n`;
                steps += `4. è¨ˆç®—æ·¨é¡ (N): ${a} - ${t} - ${h} = ${n}`;
                return { final: { label: 'å¯¦ä»˜æ·¨é¡ (N)', value: n }, steps };
            } else { // NtoA
                n = amount;
                // N = A - round(A*r_w) - (A > H ? round(A*r_h) : 0)
                // é€™æ˜¯åæ¨ï¼Œéœ€è¦è§£æ–¹ç¨‹ã€‚æˆ‘å€‘å…ˆå‡è¨­ä¸€å€‹è§£
                // Case 1: A <= H (ç„¡å¥ä¿è²»)
                // N approx A * (1 - r_w) => A approx N / (1 - r_w)
                let a_candidate1 = n / (1 - r_w);
                steps += `åæ¨è¨ˆç®— (N â†’ A):\n`;
                steps += `æƒ…æ³ 1: å‡è¨­çµ¦ä»˜ç¸½é¡ A â‰¤ ${H} (ç„¡è£œå……ä¿è²»)\n`;
                steps += `  A â‰ˆ N / (1 - r_w) = ${n} / (1 - ${r_w}) = ${a_candidate1.toFixed(2)}\n`;
                if (a_candidate1 <= H) {
                    a = TaxApp.utils.round(n / (1 - r_w));
                    t = TaxApp.utils.round(a * r_w);
                    h = 0;
                    steps += `  å€™é¸è§£ A = ${a_candidate1.toFixed(2)} â‰¤ ${H}ï¼Œå‡è¨­æˆç«‹ã€‚\n`;
                    steps += `  é‡æ–°è¨ˆç®— A = round(N / (1-r_w)) = ${a}\n`;
                    steps += `  é©—è­‰: A - round(A*r_w) = ${a} - ${t} = ${a-t} (æ‡‰æ¥è¿‘ ${n})`;
                    return { final: { label: 'çµ¦ä»˜ç¸½é¡ (A)', value: a }, steps };
                }
                
                // Case 2: A > H (æœ‰å¥ä¿è²»)
                steps += `  å€™é¸è§£ A = ${a_candidate1.toFixed(2)} > ${H}ï¼Œå‡è¨­ä¸æˆç«‹ã€‚\n`;
                steps += `æƒ…æ³ 2: å‡è¨­çµ¦ä»˜ç¸½é¡ A > ${H} (æœ‰è£œå……ä¿è²»)\n`;
                 // N approx A * (1 - r_w - r_h) => A approx N / (1 - r_w - r_h)
                let a_candidate2 = n / (1 - r_w - r_h);
                steps += `  A â‰ˆ N / (1 - r_w - r_h) = ${n} / (1 - ${r_w} - ${r_h}) = ${a_candidate2.toFixed(2)}\n`;
                 if (a_candidate2 <= H) {
                    steps += `  å€™é¸è§£ A = ${a_candidate2.toFixed(2)} â‰¤ ${H}ï¼Œèˆ‡å‡è¨­çŸ›ç›¾ã€‚å¯èƒ½ç„¡è§£æˆ–åœ¨é‚Šç•Œã€‚\n`;
                    return { final: { label: 'è¨ˆç®—çŸ›ç›¾', value: 'N/A' }, steps };
                 }
                 a = TaxApp.utils.round(n / (1 - r_w - r_h));
                 t = TaxApp.utils.round(a * r_w);
                 h = TaxApp.utils.round(a * r_h);
                 steps += `  é‡æ–°è¨ˆç®— A = round(N / (1-r_w-r_h)) = ${a}\n`;
                 steps += `  é©—è­‰: A - round(A*r_w) - round(A*r_h) = ${a} - ${t} - ${h} = ${a-t-h} (æ‡‰æ¥è¿‘ ${n})`;
                 return { final: { label: 'çµ¦ä»˜ç¸½é¡ (A)', value: a }, steps };
            }
        },
        
        landedCost({ cif, rates, isBonded }) {
            let steps = `å®Œç¨…åƒ¹æ ¼ (CIF) = ${TaxApp.utils.formatNumber(cif)}\n\n`;
            let current_base = cif;
            
            let duty = isBonded ? 0 : TaxApp.utils.round(current_base * rates.duty);
            steps += `1. é—œç¨… (Duty) = ${isBonded ? '0 (ä¿ç¨…/FTA)' : `${cif} * ${rates.duty*100}% = ${TaxApp.utils.formatNumber(duty)}`}\n`;
            current_base += duty;
            
            let excise = TaxApp.utils.round(current_base * rates.excise);
            steps += `2. è²¨ç‰©ç¨… (Excise) = (${cif} + ${duty}) * ${rates.excise*100}% = ${TaxApp.utils.formatNumber(excise)}\n`;
            current_base += excise;
            
            let vat = TaxApp.utils.round(current_base * rates.vat);
            steps += `3. ç‡Ÿæ¥­ç¨… (VAT) = (${cif} + ${duty} + ${excise}) * ${rates.vat*100}% = ${TaxApp.utils.formatNumber(vat)}\n`;
            current_base += vat;
            
            steps += `4. å›ºå®šç¨… (Fixed) = ${TaxApp.utils.formatNumber(rates.fixed)}\n`;
            current_base += rates.fixed;
            
            steps += `5. å¥åº·æ (Health) = ${TaxApp.utils.formatNumber(rates.health)}\n`;
            current_base += rates.health;

            //æ¨å»£è²»ä»¥ CIF ç‚ºåŸºç¤
            let promotion = TaxApp.utils.round(cif * rates.promotion);
            steps += `6. æ¨å»£è²» (Promotion) = ${cif} * ${rates.promotion*100}% = ${TaxApp.utils.formatNumber(promotion)}\n`;
            current_base += promotion;

            const landed = cif + duty + excise + vat + rates.fixed + rates.health + promotion;
            steps += `\nç¸½æˆæœ¬ (Landed Cost) = CIF + å„é …ç¨…è²» = ${TaxApp.utils.formatNumber(landed)}`;

            return {
                final: { label: 'é€²å£ç¸½æˆæœ¬', value: landed },
                steps
            };
        },
        
        reverseLandedCost({ targetLanded, rates, isBonded }) {
            const f = (cif) => this.landedCost({ cif, rates, isBonded }).final.value;
            let low = 0;
            let high = targetLanded; // CIF ä¸æœƒæ¯”ç¸½æˆæœ¬é«˜
            let steps = `ç›®æ¨™ç¸½æˆæœ¬ L = ${TaxApp.utils.formatNumber(targetLanded)}\næ¡ç”¨äºŒåˆ†æ³•æ±‚è§£ CIF...\n`;
            const iterationTable = { headers: ['æ¬¡æ•¸', 'Low CIF', 'High CIF', 'Mid CIF', 'è¨ˆç®—æˆæœ¬', 'å·®ç•°'], rows: [] };
            
            for (let i=0; i < 100; i++) {
                let mid = (low + high) / 2;
                if (mid <= 0) break;
                let calculatedLanded = f(mid);
                let diff = calculatedLanded - targetLanded;
                
                iterationTable.rows.push([
                    i + 1, 
                    mid === 0 ? '0' : TaxApp.utils.formatNumber(low.toFixed(4)),
                    TaxApp.utils.formatNumber(high.toFixed(4)),
                    TaxApp.utils.formatNumber(mid.toFixed(4)),
                    TaxApp.utils.formatNumber(calculatedLanded.toFixed(4)),
                    diff.toFixed(4)
                ]);

                if (Math.abs(diff) < 0.01) {
                    steps += `\næ”¶æ–‚æˆåŠŸï¼`;
                    return {
                        final: { label: 'åæ¨ CIF', value: mid },
                        steps,
                        iterationTable
                    };
                }
                
                if (diff > 0) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            steps += `\nè¨ˆç®—è¶…é 100 æ¬¡è¿­ä»£ä»æœªæ”¶æ–‚ï¼Œå¯èƒ½ç„¡è§£ã€‚`;
            return {
                final: { label: 'ç„¡æ³•æ”¶æ–‚', value: 'N/A' },
                steps,
                iterationTable
            };
        },
        
        salaryTax({ mode, amount, brackets }) {
            const sortedBrackets = [...brackets].sort((a,b) => a.upper - b.upper);
            
            const calculateTax = (gross) => {
                const bracket = sortedBrackets.find(b => gross <= b.upper);
                if (!bracket) return { tax: -1, net: -1 }; // Should not happen with Infinity
                
                const tax = TaxApp.utils.round(gross * bracket.rate) - bracket.qd;
                const net = gross - tax;
                return { gross, tax, net, bracket };
            };
            
            if (mode === 'GtoN') {
                const result = calculateTax(amount);
                let steps = `æ¯›è–ª (G) = ${TaxApp.utils.formatNumber(amount)}\n`;
                steps += `1. æŸ¥æ‰¾é©ç”¨ç´šè·: ${amount} <= ${result.bracket.upper}, é©ç”¨ç¨…ç‡ ${result.bracket.rate*100}%, é€Ÿç®—æ‰£é™¤æ•¸ ${result.bracket.qd}\n`;
                steps += `2. è¨ˆç®—é æ‰£ç¨…é¡ (T): ${amount} * ${result.bracket.rate} - ${result.bracket.qd} = ${amount * result.bracket.rate - result.bracket.qd} â†’ ${result.tax}\n`;
                steps += `3. è¨ˆç®—æ·¨è–ª (N): ${amount} - ${result.tax} = ${result.net}`;
                return { final: { label: 'å¯¦é ˜æ·¨è–ª (N)', value: result.net }, steps };
            } else { // NtoG
                const targetNet = amount;
                // ä½¿ç”¨äºŒåˆ†æ³•åæ¨
                let low = targetNet; // æ¯›è–ªè‡³å°‘æ˜¯æ·¨è–ª
                let high = targetNet * 2; // åˆå§‹çŒœæ¸¬ä¸Šé™
                const iterationTable = { headers: ['æ¬¡æ•¸', 'Low G', 'High G', 'Mid G', 'è¨ˆç®—æ·¨è–ª N', 'å·®ç•°'], rows: [] };
                let finalGross = -1;
                
                for(let i=0; i < 100; i++) {
                    let midGross = (low + high) / 2;
                    let { net: calculatedNet } = calculateTax(midGross);
                    let diff = calculatedNet - targetNet;

                    iterationTable.rows.push([
                        i + 1,
                        TaxApp.utils.formatNumber(low.toFixed(2)),
                        TaxApp.utils.formatNumber(high.toFixed(2)),
                        TaxApp.utils.formatNumber(midGross.toFixed(2)),
                        TaxApp.utils.formatNumber(calculatedNet.toFixed(2)),
                        diff.toFixed(2)
                    ]);
                    
                    if (Math.abs(diff) < 0.5) { // å…è¨± 0.5 å…ƒèª¤å·®
                        finalGross = midGross;
                        break;
                    }
                    
                    if (diff > 0) {
                        high = midGross;
                    } else {
                        low = midGross;
                    }
                     // å¦‚æœ G > N é—œä¿‚ä¸æˆç«‹ï¼Œæ“´å¤§æœç´¢ç¯„åœ
                    if (low >= high) {
                        high *= 2;
                    }
                }
                
                if (finalGross !== -1) {
                    return {
                        final: { label: 'åæ¨æ¯›è–ª (G)', value: finalGross },
                        steps: `å¾ç›®æ¨™æ·¨è–ª ${TaxApp.utils.formatNumber(targetNet)} åæ¨æ¯›è–ªã€‚`,
                        iterationTable
                    };
                } else {
                    return {
                        final: { label: 'ç„¡æ³•æ”¶æ–‚', value: 'N/A' },
                        steps: `ç„¡æ³•å¾ç›®æ¨™æ·¨è–ª ${TaxApp.utils.formatNumber(targetNet)} åæ¨æ¯›è–ªã€‚`,
                        iterationTable
                    }
                }
            }
        },

        presentValue({ payment, periods, rate }) {
            if (rate <= 0) return { final: { label: 'éŒ¯èª¤', value: 'åˆ©ç‡éœ€>0'}, steps: 'æœˆåˆ©ç‡ä¸å¯ç‚º0æˆ–è² æ•¸'};
            const pv = payment * (1 - Math.pow(1 + rate, -periods)) / rate;
            let steps = `å¹´é‡‘ç¾å€¼å…¬å¼: PV = P * [1 - (1 + r)^-n] / r\n`;
            steps += `PV = ${payment} * [1 - (1 + ${rate})^-${periods}] / ${rate}\n`;
            steps += `PV = ${payment} * [1 - ${Math.pow(1 + rate, -periods).toFixed(6)}] / ${rate}\n`;
            steps += `PV = ${pv.toFixed(2)}`;
            return { final: { label: 'å¹´é‡‘ç¾å€¼ (PV)', value: pv }, steps };
        },
        
        irr({ pv, payment, periods }) {
            // IRR: P * [1 - (1 + r)^-n] / r - PV = 0
            const f = (r) => payment * (1 - Math.pow(1 + r, -periods)) / r - pv;
            
            let low = 0.00001;
            let high = 1.0;
            const iterationTable = { headers: ['æ¬¡æ•¸', 'Rate (r)', 'f(r)'], rows: [] };
            
            for (let i=0; i < 100; i++) {
                let mid = (low + high) / 2;
                let f_mid = f(mid);
                
                iterationTable.rows.push([ i+1, mid.toFixed(6), f_mid.toFixed(4) ]);
                
                if (Math.abs(f_mid) < 0.01) {
                    const annualIRR = (Math.pow(1 + mid, 12) - 1) * 100;
                    return {
                        final: { label: 'æœˆåˆ©ç‡ (r_m)', value: mid * 100, sub: `å¹´åŒ– IRR: ${annualIRR.toFixed(4)}%` },
                        steps: 'ä½¿ç”¨äºŒåˆ†æ³•æ±‚è§£å…§éƒ¨å ±é…¬ç‡ (æœˆ)ã€‚',
                        iterationTable
                    };
                }
                
                if (f(low) * f_mid < 0) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            return { final: { label: 'ç„¡æ³•æ”¶æ–‚', value: 'N/A' }, steps: 'IRR è¨ˆç®—æœªèƒ½åœ¨ 100 æ¬¡è¿­ä»£å…§æ”¶æ–‚ã€‚' };
        },

        splitTransactions({ limit, amounts }) {
            let groups = [];
            let currentGroup = { items: [], sum: 0 };
            let steps = `è½‰å¸³ä¸Šé™: ${TaxApp.utils.formatNumber(limit)}\n\n`;

            amounts.forEach((amount, index) => {
                steps += `è™•ç†ç¬¬ ${index + 1} ç­†é‡‘é¡: ${TaxApp.utils.formatNumber(amount)}\n`;
                if (amount > limit) {
                    steps += `  - é‡‘é¡ ${TaxApp.utils.formatNumber(amount)} è¶…éä¸Šé™ï¼Œç¨ç«‹æˆçµ„ (è­¦å‘Š)\n`;
                    if (currentGroup.sum > 0) groups.push(currentGroup);
                    groups.push({ items: [amount], sum: amount });
                    currentGroup = { items: [], sum: 0 };
                } else if (currentGroup.sum + amount > limit) {
                    steps += `  - ç›®å‰çµ„ç¸½å’Œ ${TaxApp.utils.formatNumber(currentGroup.sum)} + ${TaxApp.utils.formatNumber(amount)} > ${TaxApp.utils.formatNumber(limit)}ï¼ŒçµæŸæ­¤çµ„\n`;
                    groups.push(currentGroup);
                    steps += `  - å»ºç«‹æ–°çµ„ï¼Œæ”¾å…¥ ${TaxApp.utils.formatNumber(amount)}\n`;
                    currentGroup = { items: [amount], sum: amount };
                } else {
                    currentGroup.items.push(amount);
                    currentGroup.sum += amount;
                    steps += `  - åŠ å…¥ç›®å‰çµ„ï¼Œæ–°ç¸½å’Œç‚º ${TaxApp.utils.formatNumber(currentGroup.sum)}\n`;
                }
            });
            
            if (currentGroup.sum > 0) {
                groups.push(currentGroup);
            }
            steps += `\nè™•ç†å®Œç•¢ã€‚`;

            let summary = groups.map((g, i) => `ç¬¬ ${i+1} çµ„: [${g.items.map(TaxApp.utils.formatNumber).join(', ')}]ï¼Œç¸½è¨ˆ: ${TaxApp.utils.formatNumber(g.sum)}`).join('\n');
            
            return {
                final: { label: 'åˆ†æ‹†çµæœ', value: `${groups.length} çµ„`, sub: summary },
                steps
            };
        }
    };
    
    // =============================
    //      EVENTS (TaxApp.events)
    // =============================
    TaxApp.events = {
        setup() {
            // è¨»è§£ï¼šä½¿ç”¨äº‹ä»¶å§”æ´¾ï¼Œå°‡ç›£è½å™¨ç¶å®šåœ¨çˆ¶å®¹å™¨ï¼Œè™•ç†å‹•æ…‹æ–°å¢å…ƒç´ çš„äº‹ä»¶ã€‚
            const mainContent = document.getElementById('main-content');
            
            document.querySelector('.tabs').addEventListener('click', this.handleTabClick);
            document.querySelector('.toolbar').addEventListener('click', this.handleToolbarClick);
            document.getElementById('import-file-input').addEventListener('change', this.handleImportFile);
            mainContent.addEventListener('click', this.handleMainContentClick);
            mainContent.addEventListener('change', this.handleMainContentChange);
            document.getElementById('csv-paste-area').addEventListener('paste', this.handleCsvPaste);
        },

        handleTabClick(e) {
            if (!e.target.matches('.tab-link')) return;
            document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            e.target.classList.add('active');
            document.getElementById(e.target.dataset.tab + '-tab').classList.add('active');
        },
        
        handleToolbarClick(e) {
            const action = e.target.dataset.action;
            if (!action) return;

            switch (action) {
                case 'createRestorePoint':
                    TaxApp.createRestorePoint(prompt("è«‹è¼¸å…¥é‚„åŸé»åç¨±ï¼ˆå¯é¸ï¼‰"));
                    break;
                case 'exportBackup':
                    const json = JSON.stringify(TaxApp.state, null, 2);
                    const blob = new Blob([json], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tax-tool-backup-${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    TaxApp.ui.showToast('å‚™ä»½å·²åŒ¯å‡º', 'success');
                    break;
                case 'runTests':
                    alert("å…§å»ºæ¸¬è©¦åŠŸèƒ½å¾…å¯¦ç¾ã€‚");
                    break;
                case 'print':
                    window.print();
                    break;
                case 'resetApp':
                    if (confirm("è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ‰€æœ‰æœ¬åœ°å„²å­˜çš„è³‡æ–™ï¼ŒåŒ…æ‹¬åƒæ•¸ã€ç‰ˆæœ¬å’Œé‚„åŸé»ã€‚ç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) {
                        localStorage.removeItem('taxApp_state');
                        window.location.reload();
                    }
                    break;
            }
        },
        
        handleImportFile(e) {
             const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedState = JSON.parse(event.target.result);
                    // ç°¡å–®åˆä½µé‚è¼¯ï¼šä¸è¦†è“‹ï¼Œåªæ–°å¢
                    // é€™è£¡å¯ä»¥è¨­è¨ˆæ›´è¤‡é›œçš„åˆä½µç­–ç•¥
                    if (importedState.params) TaxApp.state.params = importedState.params;
                    if (importedState.versions) TaxApp.state.versions = [...TaxApp.state.versions, ...importedState.versions];
                    
                    TaxApp.saveState();
                    TaxApp.ui.renderInitialView();
                    TaxApp.ui.showToast("å‚™ä»½åŒ¯å…¥æˆåŠŸï¼", "success");
                } catch (err) {
                    TaxApp.ui.showToast("åŒ¯å…¥å¤±æ•—ï¼šç„¡æ•ˆçš„ JSON æª”æ¡ˆã€‚");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        },

        handleMainContentClick(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const { action, id, index } = target.dataset;
            TaxApp.createRestorePoint(`åŸ·è¡Œæ“ä½œ [${action}] ä¹‹å‰`);

            try {
                switch(action) {
                    case 'calculateVat':
                        {
                            const mode = document.getElementById('vat-mode').value;
                            const amount = parseFloat(document.getElementById('vat-amount').value);
                            const rate = TaxApp.utils.parseRate(document.getElementById('vat-rate').value);
                            if (isNaN(amount) || isNaN(rate)) throw new Error("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡å’Œç¨…ç‡ã€‚");
                            const result = TaxApp.calculations.vat({ mode, amount, rate });
                            TaxApp.ui.renderResult('vat-result', result);
                        }
                        break;
                    case 'calculateVatCsv':
                        {
                            const csvText = document.getElementById('vat-csv').value;
                            const data = TaxApp.utils.parseCSV(csvText);
                            const rate = TaxApp.utils.parseRate(document.getElementById('vat-rate').value);
                            if (data.length === 0) throw new Error("ç„¡æ•ˆçš„ CSV è³‡æ–™ã€‚");
                            
                            const amountKey = Object.keys(data[0])[1]; // Assume second column is amount
                            let resultCsv = "ID,OriginalAmount,Mode,CalculatedAmount,Tax,TotalAmount\n";
                            data.forEach(row => {
                                const amount = parseFloat(row[amountKey]);
                                if(isNaN(amount)) return;
                                const result = TaxApp.calculations.vat({ mode: 'NtoG', amount, rate });
                                resultCsv += `${row[Object.keys(row)[0]]},${amount},NtoG,${result.final.value},${result.final.value - amount},${result.final.value}\n`;
                            });
                            TaxApp.utils.downloadCSV('vat_batch_result.csv', resultCsv);
                        }
                        break;
                    case 'calculateWithholding':
                        {
                            const mode = document.getElementById('wh-mode').value;
                            const amount = parseFloat(document.getElementById('wh-amount').value);
                            const r_w = TaxApp.utils.parseRate(document.getElementById('wh-tax-rate').value);
                            const r_h = TaxApp.utils.parseRate(document.getElementById('wh-nhi-rate').value);
                            const H = parseFloat(document.getElementById('wh-nhi-threshold').value);
                            if (isNaN(amount) || isNaN(r_w)) throw new Error("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡å’Œæ‰£ç¹³ç‡ã€‚");
                            
                            const result = TaxApp.calculations.withholding({ mode, amount, r_w, r_h, H });
                            TaxApp.ui.renderResult('wh-result', result);
                        }
                        break;
                    case 'calculateCif':
                        {
                           const fob = parseFloat(document.getElementById('cif-fob').value) || 0;
                           const freight = parseFloat(document.getElementById('cif-freight').value) || 0;
                           let insurance = parseFloat(document.getElementById('cif-insurance').value);
                           let steps = `FOB = ${fob}, Freight = ${freight}\n`;
                           if (isNaN(insurance)) {
                               // ä¾æç¤ºç‡ä¼°ç®—ä¿è²»ï¼Œæ­¤è™•ç°¡åŒ–
                               insurance = TaxApp.utils.round((fob + freight) * 0.005); // å‡è¨­
                               steps += `ä¿éšªè²» (I) æœªå¡«ï¼Œä¼°ç®—ç‚º (FOB+F)*0.5% = ${insurance}\n`
                           }
                           const cif = fob + freight + insurance;
                           steps += `CIF = FOB + F + I = ${fob} + ${freight} + ${insurance} = ${cif}`;
                           const result = { final: { label: 'å®Œç¨…åƒ¹æ ¼ (CIF)', value: cif}, steps };
                           TaxApp.ui.renderResult('customs-result', result);
                           document.getElementById('lc-cif').value = cif;
                        }
                        break;
                    case 'calculateLandedCost':
                        {
                            const cif = parseFloat(document.getElementById('lc-cif').value);
                             if (isNaN(cif)) throw new Error("è«‹å…ˆè¨ˆç®—æˆ–è¼¸å…¥æœ‰æ•ˆçš„ CIFã€‚");
                            const rates = {
                                duty: TaxApp.utils.parseRate(document.getElementById('lc-duty-rate').value),
                                excise: TaxApp.utils.parseRate(document.getElementById('lc-excise-rate').value),
                                vat: TaxApp.utils.parseRate(document.getElementById('lc-vat-rate').value),
                                fixed: parseFloat(document.getElementById('lc-fixed-tax').value) || 0,
                                health: parseFloat(document.getElementById('lc-health-surcharge').value) || 0,
                                promotion: TaxApp.utils.parseRate(document.getElementById('lc-promotion-fee').value)
                            };
                            const isBonded = document.getElementById('lc-bonded').checked;
                            const result = TaxApp.calculations.landedCost({ cif, rates, isBonded });
                            TaxApp.ui.renderResult('customs-result', result);
                        }
                        break;
                     case 'reverseCalculateLandedCost':
                        {
                            const targetLanded = parseFloat(document.getElementById('rev-landed-cost').value);
                             if (isNaN(targetLanded)) throw new Error("è«‹è¼¸å…¥ç›®æ¨™ç¸½æˆæœ¬ã€‚");
                             const rates = {
                                duty: TaxApp.utils.parseRate(document.getElementById('lc-duty-rate').value),
                                excise: TaxApp.utils.parseRate(document.getElementById('lc-excise-rate').value),
                                vat: TaxApp.utils.parseRate(document.getElementById('lc-vat-rate').value),
                                fixed: parseFloat(document.getElementById('lc-fixed-tax').value) || 0,
                                health: parseFloat(document.getElementById('lc-health-surcharge').value) || 0,
                                promotion: TaxApp.utils.parseRate(document.getElementById('lc-promotion-fee').value)
                            };
                            const isBonded = document.getElementById('lc-bonded').checked;
                            const result = TaxApp.calculations.reverseLandedCost({ targetLanded, rates, isBonded });
                            TaxApp.ui.renderResult('customs-result', result);
                        }
                        break;
                    case 'calculateSalary':
                        {
                            const mode = document.getElementById('salary-mode').value;
                            const amount = parseFloat(document.getElementById('salary-amount').value);
                            if (isNaN(amount)) throw new Error("è«‹è¼¸å…¥æœ‰æ•ˆçš„è–ªè³‡é‡‘é¡ã€‚");
                            const result = TaxApp.calculations.salaryTax({ mode, amount, brackets: TaxApp.state.params.salaryBrackets });
                            TaxApp.ui.renderResult('salary-result', result);
                        }
                        break;
                     case 'calculatePV':
                        {
                            const payment = parseFloat(document.getElementById('pv-payment').value);
                            const periods = parseInt(document.getElementById('pv-periods').value);
                            const rate = parseFloat(document.getElementById('pv-rate').value);
                            if (isNaN(payment) || isNaN(periods) || isNaN(rate)) throw new Error("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼ã€‚");
                            const result = TaxApp.calculations.presentValue({ payment, periods, rate });
                            TaxApp.ui.renderResult('ifrs16-result', result);
                        }
                        break;
                     case 'calculateIRR':
                        {
                            const pv = parseFloat(document.getElementById('irr-pv').value);
                            const payment = parseFloat(document.getElementById('irr-payment').value);
                            const periods = parseInt(document.getElementById('irr-periods').value);
                            if (isNaN(pv) || isNaN(payment) || isNaN(periods)) throw new Error("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼ã€‚");
                            const result = TaxApp.calculations.irr({ pv, payment, periods });
                            TaxApp.ui.renderResult('ifrs16-result', result);
                        }
                        break;
                     case 'calculateSplit':
                        {
                            const limit = parseFloat(document.getElementById('split-limit').value);
                            const amountsStr = document.getElementById('split-amounts').value;
                            if (isNaN(limit)) throw new Error("è«‹è¼¸å…¥æœ‰æ•ˆçš„ä¸Šé™é‡‘é¡ã€‚");
                            const amounts = amountsStr.split(/[\s,]+/).map(s => parseFloat(s)).filter(n => !isNaN(n));
                             if (amounts.length === 0) throw new Error("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡åºåˆ—ã€‚");
                            const result = TaxApp.calculations.splitTransactions({ limit, amounts });
                            TaxApp.ui.renderResult('split-result', result);
                        }
                        break;
                    case 'saveParams':
                        TaxApp.state.params.vatRate = TaxApp.utils.parseRate(document.getElementById('param-vat-rate').value);
                        TaxApp.state.params.nhiRate = TaxApp.utils.parseRate(document.getElementById('param-nhi-rate').value);
                        TaxApp.state.params.nhiThreshold = parseFloat(document.getElementById('param-nhi-threshold').value);
                        TaxApp.saveState();
                        TaxApp.ui.showToast('ç³»çµ±åƒæ•¸å·²å„²å­˜ã€‚', 'success');
                        TaxApp.ui.renderInitialView(); // re-sync other tabs
                        break;
                    case 'addSalaryBracket':
                        TaxApp.state.params.salaryBrackets.push({ upper: '', rate: 0, qd: 0 });
                        TaxApp.ui.renderSalaryBrackets();
                        break;
                    case 'removeSalaryBracket':
                        TaxApp.state.params.salaryBrackets.splice(parseInt(index), 1);
                        TaxApp.ui.renderSalaryBrackets();
                        break;
                    case 'saveSalaryBrackets':
                        const inputs = document.querySelectorAll('#salary-brackets-table tbody input');
                        inputs.forEach(input => {
                            const { index, field } = input.dataset;
                            let value = (field === 'upper' && input.value === '') ? Infinity : parseFloat(input.value);
                            if (field === 'rate') value /= 100;
                            TaxApp.state.params.salaryBrackets[index][field] = value;
                        });
                        TaxApp.saveState();
                        TaxApp.ui.showToast('è–ªè³‡ç´šè·è¡¨å·²å„²å­˜ã€‚', 'success');
                        break;
                    case 'previewCsvBrackets':
                        {
                            const text = document.getElementById('csv-paste-area').value;
                            const data = TaxApp.utils.parseCSV(text);
                            const map = {
                                upper: document.getElementById('csv-col-upper').value,
                                rate: document.getElementById('csv-col-rate').value,
                                qd: document.getElementById('csv-col-qd').value,
                            };
                            const rateIsPercent = document.getElementById('csv-rate-is-percent').checked;

                            const newBrackets = data.map(row => ({
                                upper: parseFloat(row[map.upper]) || Infinity,
                                rate: parseFloat(row[map.rate]) / (rateIsPercent ? 100 : 1),
                                qd: parseFloat(row[map.qd]) || 0
                            }));

                            // Display preview
                            const previewArea = document.getElementById('csv-preview-area');
                            previewArea.innerHTML = `<h4>é è¦½</h4><pre>${JSON.stringify(newBrackets, null, 2)}</pre>
                            <button type="button" class="main-action" data-action="importCsvBrackets">ç¢ºèªåŒ¯å…¥</button>`;
                            // Store in a temp place for import
                            previewArea.dataset.brackets = JSON.stringify(newBrackets);
                        }
                        break;
                    case 'importCsvBrackets':
                        {
                           const bracketsJSON = document.getElementById('csv-preview-area').dataset.brackets;
                           TaxApp.state.params.salaryBrackets = JSON.parse(bracketsJSON);
                           TaxApp.saveState();
                           TaxApp.ui.renderSalaryBrackets();
                           TaxApp.ui.showToast('è–ªè³‡ç´šè·å·²å¾ CSV åŒ¯å…¥ã€‚', 'success');
                           document.getElementById('csv-preview-area').innerHTML = '';
                        }
                        break;
                    case 'saveVersion':
                        {
                            const name = document.getElementById('new-version-name').value.trim();
                            if (!name) throw new Error("è«‹è¼¸å…¥ç‰ˆæœ¬åç¨±ã€‚");
                            const version = {
                                id: `v_${new Date().getTime()}`,
                                name: name,
                                timestamp: new Date().toISOString(),
                                params: JSON.parse(JSON.stringify(TaxApp.state.params))
                            };
                            TaxApp.state.versions.push(version);
                            TaxApp.saveState();
                            TaxApp.ui.renderHistory();
                            document.getElementById('new-version-name').value = '';
                        }
                        break;
                    case 'loadVersion':
                        {
                            const version = TaxApp.state.versions.find(v => v.id === id);
                            if (version && confirm(`ç¢ºå®šè¦è¼‰å…¥ç‰ˆæœ¬ "${version.name}" å—ï¼Ÿç•¶å‰åƒæ•¸å°‡è¢«è¦†è“‹ã€‚`)) {
                                TaxApp.state.params = JSON.parse(JSON.stringify(version.params)); // deep copy
                                TaxApp.saveState();
                                TaxApp.ui.renderInitialView();
                                TaxApp.ui.showToast(`å·²è¼‰å…¥ç‰ˆæœ¬: ${version.name}`, 'success');
                            }
                        }
                        break;
                    case 'deleteVersion':
                        {
                           const version = TaxApp.state.versions.find(v => v.id === id);
                           if (version && confirm(`ç¢ºå®šè¦åˆªé™¤ç‰ˆæœ¬ "${version.name}" å—ï¼Ÿ`)) {
                               TaxApp.state.versions = TaxApp.state.versions.filter(v => v.id !== id);
                               TaxApp.saveState();
                               TaxApp.ui.renderHistory();
                           }
                        }
                        break;
                    case 'rollback':
                        {
                            const rp = TaxApp.state.restorePoints.find(r => r.id === id);
                            if (rp && confirm(`ç¢ºå®šè¦å›æ»¾åˆ° "${rp.name}" å—ï¼Ÿæ‰€æœ‰ä¹‹å¾Œçš„è®Šæ›´å°‡æœƒéºå¤±ã€‚`)) {
                                TaxApp.state = JSON.parse(JSON.stringify(rp.state)); // deep copy
                                TaxApp.saveState();
                                TaxApp.ui.renderInitialView();
                                TaxApp.ui.showToast('å·²æˆåŠŸå›æ»¾ã€‚', 'success');
                            }
                        }
                        break;
                }
            } catch (err) {
                TaxApp.ui.showToast(err.message);
                console.error(err);
            }
        },
        
        handleMainContentChange(e) {
            // Placeholder for potential future use
        },

        handleCsvPaste(e) {
            // Delay to allow textarea to populate
            setTimeout(() => {
                const text = e.target.value;
                const lines = text.trim().split(/\r?\n/);
                if (lines.length < 1) return;
                
                const headers = lines[0].split(',').map(h => h.trim());
                const mappingUI = document.getElementById('csv-mapping-ui');
                const selects = mappingUI.querySelectorAll('select');
                
                selects.forEach(select => {
                    select.innerHTML = headers.map(h => `<option value="${h}">${h}</option>`).join('');
                });
                mappingUI.style.display = 'block';
            }, 10);
        }
    };
    
    // --- ç¨‹å¼é€²å…¥é» ---
    // è¨»è§£ï¼šä½¿ç”¨ DOMContentLoaded ç¢ºä¿ DOM çµæ§‹å®Œå…¨è¼‰å…¥å¾Œå†åŸ·è¡Œè…³æœ¬ã€‚
    document.addEventListener('DOMContentLoaded', () => {
        TaxApp.init();

        // åˆ—å°äº‹ä»¶è™•ç†
        window.onbeforeprint = () => {
            document.querySelectorAll('details').forEach(d => d.open = true);
        };
        // è¨»è§£ï¼šåˆ—å°å¾Œæ¢å¾©æŠ˜ç–Šç‹€æ…‹çš„åŠŸèƒ½åœ¨æ­¤ç‰ˆæœ¬ä¸­çœç•¥ï¼Œ
        // å› ç‚ºç„¡æ³•ç°¡å–®è¿½è¹¤åŸå§‹ç‹€æ…‹ï¼Œä½† onbeforeprint ç¢ºä¿åˆ—å°æ™‚å…§å®¹å®Œæ•´ã€‚
    });

    </script>
</body>
</html>
