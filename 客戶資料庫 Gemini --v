<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›¢ç·šå®¢æˆ¶èˆ‡ç‡Ÿæ¥­ç¨…ç®¡ç†ç³»çµ±</title>
    <style>
        /* --- å…¨åŸŸèˆ‡åŸºæœ¬æ¨£å¼ --- */
        :root {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --border-color: #4a627a;
            --header-bg: #34495e;
            --input-bg: #4a627a;
            --table-row-hover: #4a627a;
            --details-bg: #3a5067;
            --font-family: 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        main {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--header-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* --- UI å…ƒä»¶ --- */
        h1, h2, h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: var(--secondary-color);
        }
        button.danger {
            background-color: var(--accent-color);
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        button.success {
            background-color: var(--success-color);
        }
        button.success:hover {
            background-color: #27ae60;
        }
        input, select, textarea {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        ::placeholder {
            color: #bdc3c7;
            opacity: 0.7;
        }
        fieldset {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        legend {
            color: var(--primary-color);
            padding: 0 10px;
            font-weight: bold;
        }
        small {
            color: #bdc3c7;
            display: block;
            margin-top: -8px;
            margin-bottom: 10px;
        }

        /* --- åˆ†é  UI --- */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
        }
        .tab-link {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--input-bg);
            border: none;
            color: var(--text-color);
            font-size: 1.1em;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            position: relative;
            bottom: -2px;
        }
        .tab-link.active {
            background-color: var(--header-bg);
            border: 2px solid var(--border-color);
            border-bottom: 2px solid var(--header-bg);
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- è¡¨æ ¼æ¨£å¼ --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }
        tbody tr:hover {
            background-color: var(--table-row-hover);
        }
        td .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        td .actions button {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        /* --- å‚™è¨»è©³æƒ… (<details>) --- */
        details {
            background-color: var(--details-bg);
            border-radius: 4px;
            margin-top: 5px;
            padding: 5px 10px;
        }
        summary {
            cursor: pointer;
            font-weight: bold;
            color: var(--text-color);
        }
        .note-history {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .note-history li {
            font-size: 0.9em;
            white-space: pre-wrap;
            word-break: break-word;
            padding: 8px;
            border-top: 1px dashed var(--border-color);
        }
        .note-history li:first-child {
            border-top: none;
        }
        .note-history .timestamp {
            display: block;
            font-size: 0.8em;
            color: #bdc3c7;
        }

        /* --- ç‡Ÿæ¥­ç¨…æ¨¡çµ„ç‰¹æ®Šæ¨£å¼ --- */
        .tax-header, .upcoming-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .upcoming-section {
             display: block;
        }
        .upcoming-section h3 {
            margin-top: 0;
        }
        .upcoming-list {
            list-style-type: none;
            padding-left: 0;
        }
        .upcoming-list li {
            background: var(--details-bg);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .readonly-data {
            color: #bdc3c7;
            font-size: 0.9em;
            pointer-events: none;
            opacity: 0.8;
        }

        /* --- æ§åˆ¶é …èˆ‡åŒ¯å‡ºå…¥ --- */
        .global-controls {
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-color);
            border-radius: 5px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-input-wrapper button {
            width: 100%;
        }

        /* --- è¼”åŠ© class --- */
        .hidden {
            display: none !important;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* --- å‹å–„åˆ—å° --- */
        @media print {
            body {
                background-color: white;
                color: black;
                font-size: 10pt;
            }
            main {
                box-shadow: none;
                padding: 0;
                max-width: 100%;
            }
            .screen-only, .tab-nav, header, fieldset, .global-controls, button, input, select, textarea, .actions {
                display: none !important;
            }
            .tab-content.active {
                display: block !important;
            }
            table, th, td {
                border: 1px solid #ccc;
                color: black;
                background-color: white !important;
            }
            th {
                background-color: #f2f2f2 !important;
            }
            h1, h2, h3 {
                color: black;
                border-bottom: 1px solid #ccc;
            }
            details {
                background-color: transparent;
                padding: 0;
                border: 1px solid #eee;
                margin-bottom: 5px;
            }
            details summary {
                 font-weight: bold;
            }
            /* é è¨­å±•é–‹ details ä»¥ä¾¿åˆ—å° */
            details[open] {
                page-break-inside: avoid;
            }
            /* é‡å°ç‡Ÿæ¥­ç¨…æ¨¡çµ„çš„æ—¥æœŸç¾¤çµ„é€²è¡Œåˆ†é  */
            .tax-date-group {
                page-break-after: auto; /* é è¨­ autoï¼Œå¯æ”¹ç‚º always */
                page-break-inside: avoid;
            }
            .readonly-data {
                color: #555;
            }
            a {
                text-decoration: none;
                color: black;
            }
        }
    </style>
</head>
<body>

<main>
    <header>
        <h1>é›¢ç·šå®¢æˆ¶èˆ‡ç‡Ÿæ¥­ç¨…ç®¡ç†ç³»çµ±</h1>
        <p>æ‰€æœ‰è³‡æ–™çš†å„²å­˜åœ¨æ‚¨çš„æœ¬æ©Ÿç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•ä¼ºæœå™¨ã€‚</p>
    </header>

    <nav class="tab-nav">
        <button type="button" class="tab-link active" data-tab="customers">å®¢æˆ¶è³‡æ–™åº«</button>
        <button type="button" class="tab-link" data-tab="tax">ç‡Ÿæ¥­ç¨…</button>
    </nav>
    
    <div class="global-controls">
        <button type="button" id="printButton" class="screen-only">ğŸ–¨ï¸ åˆ—å°ç›®å‰é é¢</button>
        <button type="button" id="backupAll" class="success screen-only">âš¡ ä¸€éµå‚™ä»½å¿«ç…§</button>
        <div class="file-input-wrapper screen-only">
             <button type="button">ğŸ”„ å¾å¿«ç…§é‚„åŸ</button>
             <input type="file" id="restoreAllInput" accept=".json">
        </div>
        <small class="screen-only">å¿«ç…§åŒ…å«å®¢æˆ¶ã€ç‡Ÿæ¥­ç¨…åŠæ”¶ç™¼ç¥¨è¨­å®šã€‚</small>
    </div>

    <div id="tab-customers" class="tab-content active">
        <h2>å®¢æˆ¶è³‡æ–™åº«</h2>
        <fieldset class="screen-only">
            <legend>æ–°å¢ / ä¿®æ”¹å®¢æˆ¶</legend>
            <form id="customerForm">
                <input type="hidden" id="customerId">
                <div class="grid-4">
                    <div>
                        <label for="customerCode">å®¢æˆ¶ä»£è™Ÿ</label>
                        <input type="text" id="customerCode" required>
                        <small>ç¨ä¸€ç„¡äºŒçš„ä»£è™Ÿï¼Œä¾‹å¦‚ï¼šC001</small>
                    </div>
                    <div>
                        <label for="companyName">å…¬å¸åç¨±</label>
                        <input type="text" id="companyName" required>
                    </div>
                    <div>
                        <label for="taxId">çµ±ä¸€ç·¨è™Ÿ</label>
                        <input type="text" id="taxId" pattern="\d{8}">
                        <small>8 ä½æ•¸å­—</small>
                    </div>
                    <div>
                        <label for="contactPerson">è¯çµ¡äºº</label>
                        <input type="text" id="contactPerson">
                    </div>
                    <div>
                        <label for="phone">è¯çµ¡é›»è©±</label>
                        <input type="tel" id="phone">
                    </div>
                    <div>
                        <label for="address">åœ°å€</label>
                        <input type="text" id="address">
                    </div>
                </div>
                <div>
                    <button type="submit" id="saveCustomerBtn">å„²å­˜å®¢æˆ¶</button>
                    <button type="button" id="clearCustomerFormBtn">æ¸…é™¤è¡¨å–®</button>
                </div>
            </form>
        </fieldset>

        <div class="global-controls screen-only">
            <input type="search" id="customerSearch" placeholder="æœå°‹ä»£è™Ÿ/å…¬å¸/çµ±ç·¨/äººå/é›»è©±...">
            <button type="button" id="exportCustomersJson">åŒ¯å‡º JSON</button>
            <div class="file-input-wrapper">
                 <button type="button">åŒ¯å…¥ JSON</button>
                 <input type="file" id="importCustomersJsonInput" accept=".json">
            </div>
            <div class="file-input-wrapper">
                 <button type="button">åŒ¯å…¥ CSV</button>
                 <input type="file" id="importCustomersCsvInput" accept=".csv">
            </div>
        </div>

        <div style="overflow-x:auto;">
            <table id="customerTable">
                <thead>
                    <tr>
                        <th>ä»£è™Ÿ</th>
                        <th>å…¬å¸åç¨±</th>
                        <th>çµ±ä¸€ç·¨è™Ÿ</th>
                        <th>è¯çµ¡äºº</th>
                        <th>é›»è©±</th>
                        <th>åœ°å€</th>
                        <th>å‚™è¨»</th>
                        <th class="screen-only">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <div id="tab-tax" class="tab-content">
        <h2>ç‡Ÿæ¥­ç¨…æ¨¡çµ„</h2>
        
        <div class="tax-header">
            <div>
                <label for="rocYearSelect">æ°‘åœ‹å¹´åº¦</label>
                <select id="rocYearSelect"></select>
            </div>
            <div>
                <label for="taxPeriodSelect">æœŸåˆ¥</label>
                <select id="taxPeriodSelect">
                    <option value="1">01-02æœˆ</option>
                    <option value="2">03-04æœˆ</option>
                    <option value="3">05-06æœˆ</option>
                    <option value="4">07-08æœˆ</option>
                    <option value="5">09-10æœˆ</option>
                    <option value="6">11-12æœˆ</option>
                </select>
            </div>
            <div id="currentDateDisplay"></div>
        </div>

        <div class="upcoming-section">
            <h3>é å®šæ”¶å›æ¸…å–®</h3>
            <div class="grid-2">
                <div>
                    <h4>ğŸ“… ä»Šæ—¥é å®šæ”¶å›</h4>
                    <ul id="today-collection" class="upcoming-list"><li>ç„¡</li></ul>
                </div>
                <div>
                    <h4>ğŸ”” æœªä¾†ä¸‰æ—¥é å®šæ”¶å›</h4>
                    <ul id="future-collection" class="upcoming-list"><li>ç„¡</li></ul>
                </div>
            </div>
        </div>

        <fieldset class="screen-only">
            <legend>æ–°å¢ / ä¿®æ”¹ç‡Ÿæ¥­ç¨…é …ç›®</legend>
            <form id="taxForm">
                <input type="hidden" id="taxRecordId">
                <div class="grid-4">
                    <div>
                        <label for="taxCustomerSelect">é¸æ“‡å®¢æˆ¶</label>
                        <select id="taxCustomerSelect" required></select>
                        <small>è³‡æ–™ä¾†è‡ªå®¢æˆ¶è³‡æ–™åº«ï¼Œæ­¤è™•å”¯è®€</small>
                    </div>
                    <div>
                        <label for="invoiceType">æ”¶/ç™¼ç¥¨æ–¹å¼</label>
                        <select id="invoiceType">
                            <option value="æ”¶">æˆ‘æ–¹å‘å®¢æˆ¶æ”¶æ¬¾ (éŠ·é …)</option>
                            <option value="ç™¼">æˆ‘æ”¯ä»˜çµ¦å®¢æˆ¶ (é€²é …)</option>
                        </select>
                    </div>
                    <div>
                        <label for="invoiceDate">é å®šæ”¶/ç™¼ç¥¨æ—¥</label>
                        <input type="date" id="invoiceDate" required>
                    </div>
                    <div>
                        <label for="invoiceAmount">é‡‘é¡ (æœªç¨…)</label>
                        <input type="number" id="invoiceAmount" required min="0">
                    </div>
                </div>
                <div>
                     <label for="taxRemark">å‚™è¨»</label>
                     <textarea id="taxRemark" rows="2"></textarea>
                </div>
                <div>
                    <button type="submit" id="saveTaxBtn">å„²å­˜é …ç›®</button>
                    <button type="button" id="clearTaxFormBtn">æ¸…é™¤è¡¨å–®</button>
                </div>
            </form>
        </fieldset>

         <div class="global-controls screen-only">
            <button type="button" id="exportTaxJson">åŒ¯å‡º JSON</button>
            <div class="file-input-wrapper">
                 <button type="button">åŒ¯å…¥ JSON</button>
                 <input type="file" id="importTaxJsonInput" accept=".json">
            </div>
        </div>

        <div style="overflow-x:auto;" id="tax-table-container">
             </div>
    </div>
</main>

<script type="application/json" id="demo-data">
{
  "customers": [
    { "id": "cust-1", "code": "C001", "name": "å‰µæ–°ç§‘æŠ€", "taxId": "12345678", "contact": "é™³ç¶“ç†", "phone": "02-1234-5678", "address": "å°åŒ—å¸‚ä¿¡ç¾©å€å¸‚åºœè·¯1è™Ÿ", "notes": [{ "text": "é•·æœŸåˆä½œå¤¥ä¼´ï¼Œä»˜æ¬¾æº–æ™‚ã€‚", "timestamp": "2025-01-15T10:00:00.000Z" }] },
    { "id": "cust-2", "code": "C002", "name": "ç’°çƒè²¿æ˜“", "taxId": "87654321", "contact": "æ—å°å§", "phone": "03-9876-5432", "address": "æ¡ƒåœ’å¸‚ä¸­å£¢å€ä¸­å¤®è·¯2è™Ÿ", "notes": [] },
    { "id": "cust-3", "code": "C003", "name": "è¨­è¨ˆç¾å­¸æœ‰é™å…¬å¸", "taxId": "11223344", "contact": "ç‹ç¸½ç›£", "phone": "04-1122-3344", "address": "å°ä¸­å¸‚è¥¿å±¯å€æ–‡å¿ƒè·¯3è™Ÿ", "notes": [{ "text": "éœ€è¦å…ˆæ”¶æ¬¾æ‰å‡ºè²¨ã€‚", "timestamp": "2025-03-20T14:30:00.000Z" }, { "text": "2025 Q2 å°ˆæ¡ˆæ´½è«‡ä¸­ã€‚", "timestamp": "2025-04-10T11:00:00.000Z" }] }
  ],
  "taxRecords": [
    { "id": "tax-1", "customerId": "cust-1", "type": "æ”¶", "date": "2025-09-10", "amount": 50000, "remark": "Q3 æœå‹™è²»" },
    { "id": "tax-2", "customerId": "cust-2", "type": "ç™¼", "date": "2025-09-25", "amount": 12000, "remark": "æ¡è³¼è¾¦å…¬ç”¨å“" },
    { "id": "tax-3", "customerId": "cust-1", "type": "æ”¶", "date": "2025-11-15", "amount": 75000, "remark": "Q4 é¡§å•è²»" }
  ]
}
</script>

<script>
// --- å…¨åŸŸéŒ¯èª¤è™•ç† ---
// è¨»è¨˜: è‹¥è¦ä½¿ç”¨ Service Worker / fetch() / ES Modulesï¼Œéœ€ä»¥æœ¬æ©Ÿä¼ºæœå™¨å•Ÿå‹• (e.g., python -m http.server)
window.onerror = function(message, source, lineno, colno, error) {
    const errorMsg = `ç¨‹å¼ç¢¼ç™¼ç”ŸéŒ¯èª¤:\nè¨Šæ¯: ${message}\næª”æ¡ˆ: ${source}\nè¡Œè™Ÿ: ${lineno}:${colno}\néŒ¯èª¤ç‰©ä»¶: ${error}`;
    console.error(errorMsg);
    alert(errorMsg);
    return true; // é˜²æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º
};
window.addEventListener('unhandledrejection', function(event) {
    const errorMsg = `éåŒæ­¥æ“ä½œç™¼ç”ŸéŒ¯èª¤:\nåŸå› : ${event.reason}`;
    console.error(errorMsg);
    alert(errorMsg);
});

// --- ä¸»æ‡‰ç”¨ç¨‹å¼ ---
const App = {
    state: {
        customers: [],
        taxRecords: [],
    },

    // --- åˆå§‹åŒ– ---
    init() {
        this.loadState();
        this.setupEventListeners();
        this.renderAll();
    },

    // --- ç‹€æ…‹ç®¡ç† (localStorage) ---
    loadState() {
        try {
            const savedState = localStorage.getItem('appState');
            if (savedState) {
                this.state = JSON.parse(savedState);
            } else {
                // å¦‚æœ localStorage ç‚ºç©ºï¼Œè¼‰å…¥ç¯„ä¾‹è³‡æ–™
                const demoDataEl = document.getElementById('demo-data');
                if (demoDataEl) {
                    const demoData = JSON.parse(demoDataEl.textContent);
                    this.state.customers = demoData.customers || [];
                    this.state.taxRecords = demoData.taxRecords || [];
                    this.saveState();
                }
            }
        } catch (e) {
            console.error("ç„¡æ³•è¼‰å…¥æˆ–è§£æç‹€æ…‹:", e);
            alert("è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œå°‡ä½¿ç”¨ç©ºè³‡æ–™åº«ã€‚");
            this.state = { customers: [], taxRecords: [] };
        }
    },

    saveState() {
        try {
            localStorage.setItem('appState', JSON.stringify(this.state));
        } catch (e) {
            console.error("ç„¡æ³•å„²å­˜ç‹€æ…‹:", e);
            alert("å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼æ‚¨çš„è³‡æ–™å¯èƒ½ä¸æœƒè¢«ä¿ç•™ã€‚");
        }
    },

    // --- äº‹ä»¶ç›£è½å™¨è¨­å®š ---
    setupEventListeners() {
        // åˆ†é åˆ‡æ›
        document.querySelector('.tab-nav').addEventListener('click', e => {
            if (e.target.classList.contains('tab-link')) {
                const tabId = e.target.dataset.tab;
                this.switchTab(tabId);
            }
        });

        // æ¨¡çµ„1: å®¢æˆ¶è³‡æ–™åº«
        document.getElementById('customerForm').addEventListener('submit', this.handleCustomerFormSubmit.bind(this));
        document.getElementById('clearCustomerFormBtn').addEventListener('click', this.clearCustomerForm.bind(this));
        document.getElementById('customerTable').addEventListener('click', this.handleCustomerTableClick.bind(this));
        document.getElementById('customerSearch').addEventListener('input', e => this.renderCustomerTable(e.target.value));
        document.getElementById('exportCustomersJson').addEventListener('click', () => this.exportJSON('customers', 'customers.json'));
        document.getElementById('importCustomersJsonInput').addEventListener('change', e => this.importJSON(e, 'customers'));
        document.getElementById('importCustomersCsvInput').addEventListener('change', e => this.importCSV(e));

        // æ¨¡çµ„2: ç‡Ÿæ¥­ç¨…
        document.getElementById('taxForm').addEventListener('submit', this.handleTaxFormSubmit.bind(this));
        document.getElementById('clearTaxFormBtn').addEventListener('click', this.clearTaxForm.bind(this));
        document.getElementById('rocYearSelect').addEventListener('change', () => this.renderTaxTable());
        document.getElementById('taxPeriodSelect').addEventListener('change', () => this.renderTaxTable());
        document.getElementById('tax-table-container').addEventListener('click', this.handleTaxTableClick.bind(this));
        document.getElementById('exportTaxJson').addEventListener('click', () => this.exportJSON('taxRecords', 'tax_records.json'));
        document.getElementById('importTaxJsonInput').addEventListener('change', e => this.importJSON(e, 'taxRecords'));

        // å…¨åŸŸæ§åˆ¶
        document.getElementById('printButton').addEventListener('click', () => window.print());
        document.getElementById('backupAll').addEventListener('click', this.backupAll.bind(this));
        document.getElementById('restoreAllInput').addEventListener('change', this.restoreAll.bind(this));
        
        // åˆ—å°äº‹ä»¶é‰¤å­
        window.onbeforeprint = this.handleBeforePrint;
        window.onafterprint = this.handleAfterPrint;
    },

    // --- æ¸²æŸ“å‡½å¼ ---
    renderAll() {
        this.renderCustomerTable();
        this.renderTaxModule();
    },
    
    // --- UI äº’å‹• ---
    switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    },

    // --- è¼”åŠ©å·¥å…· ---
    generateId(prefix = 'id') {
        return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    },
    
    formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
    },
    
    showAlert(message, type = 'info') {
        const color = type === 'error' ? '#e74c3c' : '#3498db';
        alert(message);
        console.log(`[${type.toUpperCase()}] ${message}`);
    },

    // --- æ¨¡çµ„1: å®¢æˆ¶è³‡æ–™åº« ---
    renderCustomerTable(filter = '') {
        const tbody = document.getElementById('customerTable').querySelector('tbody');
        const searchTerm = filter.trim().toLowerCase();
        
        const filteredCustomers = this.state.customers.filter(c => {
            return !searchTerm ||
                   (c.code && c.code.toLowerCase().includes(searchTerm)) ||
                   (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                   (c.taxId && c.taxId.toLowerCase().includes(searchTerm)) ||
                   (c.contact && c.contact.toLowerCase().includes(searchTerm)) ||
                   (c.phone && c.phone.toLowerCase().includes(searchTerm));
        });

        if (filteredCustomers.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å®¢æˆ¶ã€‚</td></tr>`;
            return;
        }

        tbody.innerHTML = filteredCustomers.map(customer => `
            <tr data-id="${customer.id}">
                <td>${customer.code || ''}</td>
                <td>${customer.name || ''}</td>
                <td>${customer.taxId || ''}</td>
                <td>${customer.contact || ''}</td>
                <td>${customer.phone || ''}</td>
                <td>${customer.address || ''}</td>
                <td>
                    <details>
                        <summary>${customer.notes && customer.notes.length > 0 ? `æœ‰ ${customer.notes.length} å‰‡å‚™è¨»` : 'æ–°å¢å‚™è¨»'}</summary>
                        <ul class="note-history">
                            ${customer.notes && customer.notes.map(note => `
                                <li>
                                    <span class="timestamp">${new Date(note.timestamp).toLocaleString()}</span>
                                    ${note.text}
                                </li>
                            `).join('')}
                        </ul>
                        <textarea class="note-input screen-only" placeholder="è¼¸å…¥æ–°å‚™è¨»..."></textarea>
                        <button type="button" class="add-note-btn screen-only" data-id="${customer.id}">æ–°å¢å‚™è¨»</button>
                    </details>
                </td>
                <td class="actions screen-only">
                    <button type="button" class="edit-customer-btn" data-id="${customer.id}">ç·¨è¼¯</button>
                    <button type="button" class="delete-customer-btn danger" data-id="${customer.id}">åˆªé™¤</button>
                </td>
            </tr>
        `).join('');
    },

    handleCustomerFormSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('customerId').value;
        const customerData = {
            id: id || this.generateId('cust'),
            code: document.getElementById('customerCode').value.trim(),
            name: document.getElementById('companyName').value.trim(),
            taxId: document.getElementById('taxId').value.trim(),
            contact: document.getElementById('contactPerson').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            address: document.getElementById('address').value.trim(),
        };

        if (!customerData.code || !customerData.name) {
            this.showAlert('å®¢æˆ¶ä»£è™Ÿèˆ‡å…¬å¸åç¨±ç‚ºå¿…å¡«é …ç›®ï¼', 'error');
            return;
        }

        if (id) { // æ›´æ–°
            const index = this.state.customers.findIndex(c => c.id === id);
            if (index > -1) {
                // ä¿ç•™ç¾æœ‰çš„ notes
                customerData.notes = this.state.customers[index].notes;
                this.state.customers[index] = customerData;
            }
        } else { // æ–°å¢
             // æª¢æŸ¥ä»£è™Ÿæ˜¯å¦é‡è¤‡
            if (this.state.customers.some(c => c.code === customerData.code)) {
                this.showAlert('å®¢æˆ¶ä»£è™Ÿå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„ä»£è™Ÿã€‚', 'error');
                return;
            }
            customerData.notes = [];
            this.state.customers.push(customerData);
        }

        this.saveState();
        this.renderCustomerTable();
        this.renderTaxCustomerOptions();
        this.clearCustomerForm();
    },
    
    handleCustomerTableClick(e) {
        const target = e.target;
        const customerId = target.dataset.id;
        
        if (target.classList.contains('edit-customer-btn')) {
            const customer = this.state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('customerId').value = customer.id;
                document.getElementById('customerCode').value = customer.code;
                document.getElementById('companyName').value = customer.name;
                document.getElementById('taxId').value = customer.taxId;
                document.getElementById('contactPerson').value = customer.contact;
                document.getElementById('phone').value = customer.phone;
                document.getElementById('address').value = customer.address;
                window.scrollTo(0, 0); // æ»¾å‹•åˆ°é é¦–æ–¹ä¾¿ç·¨è¼¯
            }
        } else if (target.classList.contains('delete-customer-btn')) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™ä½å®¢æˆ¶å—ï¼Ÿ\né—œè¯çš„ç‡Ÿæ¥­ç¨…è¨˜éŒ„å°‡æœƒå¤±å»å®¢æˆ¶è³‡è¨Šï¼`)) {
                this.state.customers = this.state.customers.filter(c => c.id !== customerId);
                this.saveState();
                this.renderAll();
            }
        } else if (target.classList.contains('add-note-btn')) {
            const row = target.closest('tr');
            const noteInput = row.querySelector('.note-input');
            const text = noteInput.value.trim();
            if (text) {
                const customer = this.state.customers.find(c => c.id === customerId);
                if (customer) {
                    const newNote = { text, timestamp: new Date().toISOString() };
                    customer.notes.unshift(newNote); // åŠ åˆ°æœ€å‰é¢
                    this.saveState();
                    this.renderCustomerTable();
                    noteInput.value = '';
                }
            }
        }
    },
    
    clearCustomerForm() {
        document.getElementById('customerForm').reset();
        document.getElementById('customerId').value = '';
    },

    // --- æ¨¡çµ„2: ç‡Ÿæ¥­ç¨… ---
    renderTaxModule() {
        this.setupTaxDateSelectors();
        this.renderTaxCustomerOptions();
        this.renderUpcomingCollections();
        this.renderTaxTable();
    },

    setupTaxDateSelectors() {
        const today = new Date();
        const currentYear = today.getFullYear();
        const rocYear = currentYear - 1911;
        
        // è¨­å®šæ°‘åœ‹å¹´åº¦ä¸‹æ‹‰é¸å–®
        const yearSelect = document.getElementById('rocYearSelect');
        if (yearSelect.options.length === 0) { // åªåœ¨é¦–æ¬¡è¼‰å…¥æ™‚å¡«å……
            for (let y = rocYear + 2; y >= rocYear - 5; y--) {
                yearSelect.add(new Option(y, y));
            }
        }
        yearSelect.value = rocYear;

        // è¨­å®šæœŸåˆ¥
        const currentMonth = today.getMonth() + 1;
        const period = Math.ceil(currentMonth / 2);
        document.getElementById('taxPeriodSelect').value = period;

        // é¡¯ç¤ºä»Šå¤©æ—¥æœŸ
        document.getElementById('currentDateDisplay').textContent = `ä»Šå¤©æ—¥æœŸ: ${today.toLocaleDateString('sv-SE')}`;
    },

    renderTaxCustomerOptions() {
        const select = document.getElementById('taxCustomerSelect');
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- é¸æ“‡å®¢æˆ¶ --</option>';
        this.state.customers
            .sort((a, b) => a.code.localeCompare(b.code, 'zh-Hant-TW-u-co-stroke'))
            .forEach(c => {
                const option = new Option(`[${c.code}] ${c.name}`, c.id);
                select.add(option);
            });
        select.value = currentVal; // å˜—è©¦é‚„åŸä¹‹å‰é¸æ“‡çš„å€¼
    },

    renderUpcomingCollections() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toISOString().split('T')[0];

        const todayList = document.getElementById('today-collection');
        const futureList = document.getElementById('future-collection');
        todayList.innerHTML = '';
        futureList.innerHTML = '';
        
        const futureDates = [];
        for (let i = 1; i <= 3; i++) {
            const futureDay = new Date(today);
            futureDay.setDate(today.getDate() + i);
            futureDates.push({
                date: futureDay,
                dateStr: futureDay.toISOString().split('T')[0],
                dayOfWeek: futureDay.toLocaleDateString('zh-TW', { weekday: 'long' })
            });
        }
        
        let todayFound = false;
        
        this.state.taxRecords.forEach(record => {
            const customer = this.state.customers.find(c => c.id === record.customerId);
            const customerName = customer ? `[${customer.code}] ${customer.name}` : '[å®¢æˆ¶è³‡æ–™å·²åˆªé™¤]';
            const recordDate = record.date;

            // ä»Šæ—¥é å®š
            if (recordDate === todayStr) {
                const li = document.createElement('li');
                li.textContent = `${customerName} - ${record.type === 'æ”¶' ? 'æ”¶æ¬¾' : 'ä»˜æ¬¾'} $${Number(record.amount).toLocaleString()}`;
                todayList.appendChild(li);
                todayFound = true;
            }
            
            // æœªä¾†ä¸‰æ—¥
            futureDates.forEach(fd => {
                 if (recordDate === fd.dateStr) {
                    futureList.innerHTML += `<li>${fd.dateStr} (${fd.dayOfWeek}): ${customerName} - ${record.type === 'æ”¶' ? 'æ”¶æ¬¾' : 'ä»˜æ¬¾'} $${Number(record.amount).toLocaleString()}</li>`;
                 }
            });
        });

        if (!todayFound) todayList.innerHTML = '<li>ç„¡</li>';
        if (futureList.innerHTML === '') futureList.innerHTML = '<li>ç„¡</li>';
    },

    renderTaxTable() {
        const container = document.getElementById('tax-table-container');
        const rocYear = parseInt(document.getElementById('rocYearSelect').value, 10);
        const period = parseInt(document.getElementById('taxPeriodSelect').value, 10);
        const year = rocYear + 1911;
        const startMonth = (period - 1) * 2 + 1;
        const endMonth = startMonth + 1;

        const startDate = new Date(year, startMonth - 1, 1);
        const endDate = new Date(year, endMonth, 0); // 0æ—¥æœƒè‡ªå‹•è®Šæˆä¸Šå€‹æœˆçš„æœ€å¾Œä¸€å¤©

        const filteredRecords = this.state.taxRecords.filter(r => {
            const recordDate = new Date(r.date);
            return recordDate >= startDate && recordDate <= endDate;
        }).sort((a,b) => new Date(a.date) - new Date(b.date));

        // æŒ‰æ—¥æœŸåˆ†çµ„
        const groupedByDate = filteredRecords.reduce((acc, record) => {
            (acc[record.date] = acc[record.date] || []).push(record);
            return acc;
        }, {});
        
        const dates = Object.keys(groupedByDate).sort();
        
        if (dates.length === 0) {
            container.innerHTML = `<p style="text-align:center;">æ­¤æœŸé–“ç„¡ç‡Ÿæ¥­ç¨…é …ç›®ã€‚</p>`;
            return;
        }

        let totalIncome = 0;
        let totalExpense = 0;
        
        let html = '';
        dates.forEach(date => {
            const records = groupedByDate[date];
            html += `
            <div class="tax-date-group">
                <h3>${this.formatDate(date)}</h3>
                <table class="tax-table">
                    <thead>
                        <tr>
                            <th>å®¢æˆ¶è³‡æ–™</th>
                            <th>é¡å‹</th>
                            <th>é‡‘é¡ (æœªç¨…)</th>
                            <th>ç¨…é¡ (5%)</th>
                            <th>ç¸½é¡ (å«ç¨…)</th>
                            <th>å‚™è¨»</th>
                            <th class="screen-only">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            records.forEach(record => {
                const customer = this.state.customers.find(c => c.id === record.customerId);
                const tax = Math.round(record.amount * 0.05);
                const total = record.amount + tax;
                if (record.type === 'æ”¶') {
                    totalIncome += record.amount;
                } else {
                    totalExpense += record.amount;
                }
                
                html += `
                    <tr data-id="${record.id}">
                        <td>
                            ${customer ? `<strong>[${customer.code}] ${customer.name}</strong>` : `<strong class="danger">[å®¢æˆ¶è³‡æ–™å·²åˆªé™¤]</strong>`}
                            <div class="readonly-data">${customer ? `çµ±ç·¨: ${customer.taxId || 'N/A'}` : ''}</div>
                        </td>
                        <td>${record.type === 'æ”¶' ? 'éŠ·é …' : 'é€²é …'}</td>
                        <td>$${Number(record.amount).toLocaleString()}</td>
                        <td>$${tax.toLocaleString()}</td>
                        <td>$${total.toLocaleString()}</td>
                        <td>${record.remark || ''}</td>
                        <td class="actions screen-only">
                            <button type="button" class="edit-tax-btn" data-id="${record.id}">ç·¨è¼¯</button>
                            <button type="button" class="delete-tax-btn danger" data-id="${record.id}">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });
            html += `</tbody></table></div>`;
        });
        
        // åŠ ä¸Šç¸½è¨ˆ
        const totalTaxIncome = Math.round(totalIncome * 0.05);
        const totalTaxExpense = Math.round(totalExpense * 0.05);
        const finalTax = totalTaxIncome - totalTaxExpense;

        html += `
            <div class="tax-summary" style="margin-top: 20px; padding: 15px; background: var(--bg-color); border-radius: 5px;">
                <h3>æœ¬æœŸç¸½è¨ˆ</h3>
                <p>éŠ·é …ç¸½é¡ (æœªç¨…): $${totalIncome.toLocaleString()} | ç¨…é¡: $${totalTaxIncome.toLocaleString()}</p>
                <p>é€²é …ç¸½é¡ (æœªç¨…): $${totalExpense.toLocaleString()} | ç¨…é¡: $${totalTaxExpense.toLocaleString()}</p>
                <h4 style="color: ${finalTax >= 0 ? 'var(--success-color)' : 'var(--accent-color)'};">
                    æœ¬æœŸæ‡‰ç´ç¨…é¡: $${finalTax.toLocaleString()}
                </h4>
            </div>
        `;

        container.innerHTML = html;
    },

    handleTaxFormSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('taxRecordId').value;
        const recordData = {
            id: id || this.generateId('tax'),
            customerId: document.getElementById('taxCustomerSelect').value,
            type: document.getElementById('invoiceType').value,
            date: document.getElementById('invoiceDate').value,
            amount: parseFloat(document.getElementById('invoiceAmount').value),
            remark: document.getElementById('taxRemark').value.trim(),
        };

        if (!recordData.customerId || !recordData.date || isNaN(recordData.amount)) {
            this.showAlert('å®¢æˆ¶ã€æ—¥æœŸèˆ‡é‡‘é¡ç‚ºå¿…å¡«é …ç›®ï¼', 'error');
            return;
        }

        if (id) { // æ›´æ–°
            const index = this.state.taxRecords.findIndex(r => r.id === id);
            if (index > -1) this.state.taxRecords[index] = recordData;
        } else { // æ–°å¢
            this.state.taxRecords.push(recordData);
        }

        this.saveState();
        this.renderUpcomingCollections();
        this.renderTaxTable();
        this.clearTaxForm();
    },

    handleTaxTableClick(e) {
        const target = e.target;
        const recordId = target.dataset.id;
        
        if (target.classList.contains('edit-tax-btn')) {
            const record = this.state.taxRecords.find(r => r.id === recordId);
            if (record) {
                document.getElementById('taxRecordId').value = record.id;
                document.getElementById('taxCustomerSelect').value = record.customerId;
                document.getElementById('invoiceType').value = record.type;
                document.getElementById('invoiceDate').value = record.date;
                document.getElementById('invoiceAmount').value = record.amount;
                document.getElementById('taxRemark').value = record.remark;
                window.scrollTo(0, 0);
            }
        } else if (target.classList.contains('delete-tax-btn')) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) {
                this.state.taxRecords = this.state.taxRecords.filter(r => r.id !== recordId);
                this.saveState();
                this.renderUpcomingCollections();
                this.renderTaxTable();
            }
        }
    },
    
    clearTaxForm() {
        document.getElementById('taxForm').reset();
        document.getElementById('taxRecordId').value = '';
    },
    
    // --- åŒ¯å…¥ / åŒ¯å‡º ---
    exportJSON(key, filename) {
        const dataStr = JSON.stringify(this.state[key], null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

    importJSON(event, key) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!Array.isArray(data)) throw new Error('JSON æ ¼å¼ä¸æ­£ç¢ºï¼Œéœ€è¦æ˜¯é™£åˆ—ã€‚');
                
                // ä»¥ ID è¦†è“‹
                data.forEach(newItem => {
                    const index = this.state[key].findIndex(oldItem => oldItem.id === newItem.id);
                    if (index > -1) {
                        this.state[key][index] = newItem;
                    } else {
                        this.state[key].push(newItem);
                    }
                });

                this.saveState();
                this.renderAll();
                this.showAlert('JSON è³‡æ–™åŒ¯å…¥æˆåŠŸï¼', 'success');
            } catch (err) {
                this.showAlert(`åŒ¯å…¥å¤±æ•—: ${err.message}`, 'error');
            } finally {
                event.target.value = ''; // æ¸…ç©º file input
            }
        };
        reader.readAsText(file);
    },

    parseCSV(text) {
        // ç°¡æ˜“ä½†æ”¯æ´å¼•è™Ÿçš„ CSV è§£æå™¨
        const result = [];
        let row = [];
        let current = '';
        let inQuote = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            if (inQuote) {
                if (char === '"' && text[i+1] === '"') { // è™•ç† "" è½‰ç¾©
                    current += '"';
                    i++;
                } else if (char === '"') {
                    inQuote = false;
                } else {
                    current += char;
                }
            } else {
                if (char === '"') {
                    inQuote = true;
                } else if (char === ',') {
                    row.push(current);
                    current = '';
                } else if (char === '\n' || char === '\r') {
                    if (i > 0 && text[i-1] !== '\n' && text[i-1] !== '\r') {
                        row.push(current);
                        result.push(row);
                        row = [];
                        current = '';
                    }
                    if (char === '\r' && text[i+1] === '\n') i++; // è™•ç† CRLF
                } else {
                    current += char;
                }
            }
        }
        if (current || row.length > 0) {
            row.push(current);
            result.push(row);
        }
        return result;
    },

    importCSV(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const parsed = this.parseCSV(text);
                const headers = parsed[0].map(h => h.trim());
                const data = parsed.slice(1);
                
                const requiredHeaders = ['id', 'code', 'name'];
                if (!requiredHeaders.every(h => headers.includes(h))) {
                    throw new Error(`CSV ç¼ºå°‘å¿…è¦æ¬„ä½ï¼Œè‡³å°‘éœ€è¦: ${requiredHeaders.join(', ')}`);
                }
                
                let updatedCount = 0;
                let addedCount = 0;

                data.forEach(row => {
                    if (row.length < headers.length) return; // è·³éç©ºè¡Œæˆ–ä¸å®Œæ•´çš„è¡Œ
                    const newItem = {};
                    headers.forEach((header, index) => {
                        newItem[header] = row[index];
                    });
                    
                    if (!newItem.id) return;

                    // notes æ¬„ä½éœ€è¦ç‰¹æ®Šè™•ç†
                    if (newItem.notes && typeof newItem.notes === 'string') {
                        try {
                            newItem.notes = JSON.parse(newItem.notes);
                        } catch {
                            newItem.notes = [{ text: newItem.notes, timestamp: new Date().toISOString() }];
                        }
                    } else {
                        newItem.notes = [];
                    }

                    const index = this.state.customers.findIndex(c => c.id === newItem.id);
                    if (index > -1) {
                        this.state.customers[index] = { ...this.state.customers[index], ...newItem };
                        updatedCount++;
                    } else {
                        this.state.customers.push(newItem);
                        addedCount++;
                    }
                });

                this.saveState();
                this.renderAll();
                this.showAlert(`CSV åŒ¯å…¥å®Œæˆï¼\næ›´æ–°äº† ${updatedCount} ç­†è³‡æ–™ï¼Œæ–°å¢äº† ${addedCount} ç­†è³‡æ–™ã€‚`, 'success');

            } catch (err) {
                this.showAlert(`åŒ¯å…¥ CSV å¤±æ•—: ${err.message}`, 'error');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    },
    
    // --- å‚™ä»½èˆ‡é‚„åŸ ---
    backupAll() {
        const backupData = JSON.stringify(this.state, null, 2);
        const blob = new Blob([backupData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    },

    restoreAll(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm('é‚„åŸå¿«ç…§å°‡æœƒè¦†è“‹æ‰€æœ‰ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
             event.target.value = '';
             return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const newState = JSON.parse(e.target.result);
                if ('customers' in newState && 'taxRecords' in newState) {
                    this.state = newState;
                    this.saveState();
                    this.renderAll();
                    this.showAlert('å·²æˆåŠŸå¾å¿«ç…§é‚„åŸï¼', 'success');
                } else {
                    throw new Error('å¿«ç…§æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚');
                }
            } catch (err) {
                this.showAlert(`é‚„åŸå¤±æ•—: ${err.message}`, 'error');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    },
    
    // --- åˆ—å°è™•ç† ---
    handleBeforePrint() {
        // å„²å­˜ç›®å‰ details çš„é–‹é—œç‹€æ…‹
        document.querySelectorAll('details').forEach(detail => {
            if (detail.open) {
                detail.dataset.wasOpen = 'true';
            }
            detail.open = true; // åˆ—å°æ™‚å…¨éƒ¨å±•é–‹
        });
    },
    
    handleAfterPrint() {
        // æ¢å¾© details çš„åŸå§‹ç‹€æ…‹
        document.querySelectorAll('details').forEach(detail => {
            if (detail.dataset.wasOpen === 'true') {
                detail.open = true;
                delete detail.dataset.wasOpen;
            } else {
                detail.open = false;
            }
        });
    }
};

// --- DOM è¼‰å…¥å¾Œå•Ÿå‹•æ‡‰ç”¨ ---
document.addEventListener('DOMContentLoaded', () => {
    App.init();
});
</script>

</body>
</html>
