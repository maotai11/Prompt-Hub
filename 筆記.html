<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A R C H I V E</title>
    <!--
      A R C H I V E: é›¢ç·šå„ªå…ˆçš„ç·¨è¼¯æ‡‰ç”¨ç¨‹å¼æ®¼
      ç‰ˆæœ¬: 1.0.0
      è¦ç¯„: Speckit (Vogue Ã— Bazaar Hybrid)
      
      æ­¤ç‚ºä¸€å–®ä¸€ã€ç¨ç«‹çš„ HTML æª”æ¡ˆã€‚ç„¡éœ€ç¶²è·¯é€£ç·šï¼Œ
      æ‰€æœ‰è³‡æ–™ (åŒ…å«é …ç›®ã€ç‰ˆæœ¬ã€é™„ä»¶) å‡å„²å­˜æ–¼æ‚¨æœ¬åœ°çš„ç€è¦½å™¨è³‡æ–™åº« (IndexedDB) ä¸­ã€‚
      
      - ç„¡å¤–éƒ¨ CDN æˆ–å­—å‹æª”æ¡ˆã€‚
      - ç„¡è¿½è¹¤ã€ç„¡ä¼ºæœå™¨å‘¼å«ã€‚
      - 100% ç§æœ‰ä¸¦å¯é›¢ç·šé‹ä½œã€‚
    -->
    <style>
        /* --------------------------------- */
        /* 1. CSS é‡è¨­ (Reset)                */
        /* --------------------------------- */

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--ivory);
            color: var(--soft-gray);
            line-height: 1.6;
            overflow-x: hidden;
            /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
        }

        /* --------------------------------- */
        /* 2. è¨­è¨ˆ Token (Design Tokens)    */
        /* éµå¾ª Speckit è¦ç¯„                 */
        /* --------------------------------- */

        :root {
            /* è‰²å½© (Colors) */
            --ink-black: #000000;
            --ivory: #F8F8F6;
            --rose-gold: #C7A27C;
            --smoke: #1A1A1A;
            --mist-silver: #C0C4C9;
            --cream: #FAF7F2;
            --soft-gray: #6B7280;

            /* å­—é«”å †ç–Š (Fonts) */
            --font-display: "Playfair Display", "Didot", "Bodoni 72", Georgia, "Times New Roman", serif;
            --font-body: Inter, "Helvetica Neue", Arial, system-ui, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;

            /* å­—ç´š (Typography Scale) */
            --fs-display: clamp(2.5rem, 6vw, 4rem);
            --fs-h1: clamp(1.8rem, 4vw, 2.25rem);
            --fs-h2: 1.5rem;
            --fs-h3: 1.25rem;
            --fs-body: 1rem;
            --fs-small: 0.875rem;

            /* ç¶²æ ¼èˆ‡é–“è· (Grid & Spacing) */
            --grid-max-width: 1200px;
            --grid-padding: 24px;
            --baseline: 8px;

            /* åœ“è§’ (Radius) */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;

            /* é™°å½± (Shadows) */
            --shadow-soft: 0 6px 20px rgba(0, 0, 0, .07);
            --shadow-focus: 0 0 0 2px var(--ivory), 0 0 0 4px var(--rose-gold);
            /* éµç›¤ç„¦é» */

            /* å‹•æ•ˆ (Animation) */
            --easing-emphasized: cubic-bezier(0.33, 1, 0.68, 1);
            --dur-stagger: 30ms;
            /* å­—æ¯éšæ¢¯å»¶é² (300ms ç¸½æ™‚é•·) */
            --dur-breathe-min: 600ms;
            --dur-breathe-max: 1000ms;
            --dur-fast: 200ms;
            /* Hover */
            --dur-medium: 300ms;
            /* Header/Modal */
        }

        /* --------------------------------- */
        /* 3. åŸºç¤æ’ç‰ˆ (Base Typography)     */
        /* --------------------------------- */

        h1,
        h2,
        h3,
        h4,
        .font-display {
            font-family: var(--font-display);
            color: var(--ink-black);
            font-weight: 400;
            /* Playfair Display é©åˆè¼ƒç´°çš„å­—é‡ */
            line-height: 1.2;
            margin-bottom: calc(var(--baseline) * 2);
        }

        h1,
        .font-display {
            font-size: var(--fs-display);
        }

        h2 {
            font-size: var(--fs-h1);
        }

        h3 {
            font-size: var(--fs-h2);
        }

        p {
            margin-bottom: calc(var(--baseline) * 2);
            line-height: 1.7;
            /* å¢åŠ é–±è®€èˆ’é©åº¦ */
        }

        a {
            color: var(--rose-gold);
            text-decoration: none;
            transition: color var(--dur-fast) ease;
        }

        a:hover,
        button:hover {
            color: var(--ink-black);
        }

        /* --------------------------------- */
        /* 4. ä½ˆå±€ (Layout & Grid)          */
        /* --------------------------------- */

        .container {
            width: min(var(--grid-max-width), 92vw);
            margin-left: auto;
            margin-right: auto;
        }

        .main-content {
            padding-top: 100px;
            /* é ç•™ Header ç©ºé–“ */
            min-height: 100vh;
        }

        /* --------------------------------- */
        /* 5. çµ„ä»¶ (Components)             */
        /* --------------------------------- */

        /* Header (å›ºå®šå¼/æ¼¸è®Š) */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: calc(var(--baseline) * 3) 0;
            z-index: 100;
            background: transparent;
            transition: background var(--dur-medium) ease, box-shadow var(--dur-medium) ease;
        }

        .app-header.is-scrolled {
            background: linear-gradient(180deg, var(--smoke) 70%, transparent);
            box-shadow: 0 1px 0 rgba(192, 196, 201, 0.3);
            /* --mist-silver with alpha */
        }

        .app-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-logo {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--ink-black);
            font-weight: 400;
            transition: color var(--dur-medium) ease;
            letter-spacing: 1px;
        }

        .app-header.is-scrolled .app-logo {
            color: var(--ivory);
        }

        .nav-buttons {
            display: flex;
            gap: calc(var(--baseline) * 2);
        }

        /* æŒ‰éˆ• (Button) */
        .button {
            font-family: var(--font-body);
            font-size: var(--fs-small);
            font-weight: 500;
            padding: var(--baseline) calc(var(--baseline) * 2);
            border-radius: var(--radius-md);
            border: 1px solid var(--mist-silver);
            background-color: transparent;
            color: var(--ink-black);
            cursor: pointer;
            text-align: center;
            transition: all var(--dur-fast) ease;
            white-space: nowrap;
        }

        .button:hover {
            transform: scale(1.02);
            /* 102% Hover */
            color: var(--ink-black);
            border-color: var(--ink-black);
        }

        /* éœ§ç° â†’ ç´”é»‘ (Speckit) */
        .button.hover-mist {
            color: var(--soft-gray);
            border-color: var(--mist-silver);
        }

        .button.hover-mist:hover {
            color: var(--ink-black);
            border-color: var(--ink-black);
        }

        .app-header.is-scrolled .button {
            color: var(--ivory);
            border-color: var(--ivory);
        }

        .app-header.is-scrolled .button:hover {
            color: var(--smoke);
            background-color: var(--ivory);
            border-color: var(--ivory);
        }

        .button.primary {
            background-color: var(--smoke);
            color: var(--ivory);
            border-color: var(--smoke);
        }

        .button.primary:hover {
            background-color: var(--ink-black);
            border-color: var(--ink-black);
        }

        .button.accent {
            background-color: var(--rose-gold);
            color: var(--ink-black);
            border-color: var(--rose-gold);
        }

        .button.accent:hover {
            filter: brightness(1.1);
            border-color: var(--rose-gold);
        }

        .button.danger {
            background-color: transparent;
            color: #D93025;
            border-color: #D93025;
        }

        .button.danger:hover {
            background-color: #D93025;
            color: var(--ivory);
        }

        /* ç„¦é»å¯è¦‹æ€§ (Accessibility Focus) */
        .button:focus-visible,
        input:focus-visible,
        textarea:focus-visible,
        .item-card:focus-visible,
        .list-tab:focus-visible {
            outline: none;
            box-shadow: var(--shadow-focus);
        }

        /* Hero (éœæ…‹å½±åƒ + è¼•å‹•æ…‹æ–‡å­—) */
        .block-hero {
            min-height: 50vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: calc(var(--baseline) * 10) 0;
            background-color: var(--cream);
            /* èƒŒæ™¯è‰²æ›¿ä»£éœæ…‹å½±åƒ */
            border-bottom: 1px solid var(--mist-silver);
            position: relative;
            overflow: hidden;
        }

        /* æ¼¸å±¤å…‰æƒ (Gradient Sweep) */
        .block-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: -50%;
            width: 200%;
            height: 100%;
            background: conic-gradient(from 90deg at 50% 50%,
                    var(--cream) 0%,
                    var(--ivory) 30%,
                    var(--cream) 60%,
                    var(--cream) 100%);
            opacity: 0.5;
            animation: gradient-sweep 20s linear infinite;
        }

        @keyframes gradient-sweep {
            0% {
                transform: translateX(0) rotate(0deg);
            }

            100% {
                transform: translateX(0) rotate(360deg);
            }
        }

        .hero-title {
            font-size: var(--fs-display);
            line-height: 1.1;
            margin-bottom: calc(var(--baseline) * 3);
            position: relative;
            /* ç¢ºä¿åœ¨å…‰æƒä¹‹ä¸Š */
        }

        /* å­—æ¯éšæ¢¯å»¶é² 0.3s (Speckit) */
        .hero-title .char {
            display: inline-block;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity var(--dur-breathe-min) var(--easing-emphasized),
                transform var(--dur-breathe-min) var(--easing-emphasized);
        }

        .hero-title.is-visible .char {
            opacity: 1;
            transform: translateY(0);
        }

        .hero-subtitle {
            font-size: var(--fs-h3);
            color: var(--soft-gray);
            font-family: var(--font-body);
            max-width: 600px;
            opacity: 0;
            transition: opacity var(--dur-breathe-max) ease calc(var(--dur-stagger) * 10);
            /* 0.6s+ å»¶é² */
            position: relative;
        }

        .hero-subtitle.is-visible {
            opacity: 1;
        }

        /* App Shell (åˆ—è¡¨èˆ‡ç·¨è¼¯å™¨) */
        .app-shell {
            padding: calc(var(--baseline) * 6) 0;
        }

        .list-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--baseline) * 4);
        }

        .search-bar {
            flex-grow: 1;
            max-width: 400px;
        }

        input[type="text"],
        input[type="search"],
        textarea {
            font-family: var(--font-body);
            font-size: var(--fs-body);
            padding: calc(var(--baseline) * 1.5);
            border: 1px solid var(--mist-silver);
            background: var(--cream);
            border-radius: var(--radius-md);
            width: 100%;
            transition: border-color var(--dur-fast) ease, box-shadow var(--dur-fast) ease;
        }

        textarea {
            min-height: 250px;
            line-height: 1.7;
        }

        /* é …ç›®åˆ—è¡¨ (Item List) - é›œèªŒç¶²æ ¼ */
        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: calc(var(--baseline) * 3);
            /* 24px æ¬„è· */
        }

        .item-card {
            background: var(--cream);
            padding: calc(var(--baseline) * 3);
            border-radius: var(--radius-md);
            border: 1px solid var(--mist-silver);
            cursor: pointer;
            transition: all var(--dur-fast) ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Hover 102% (Speckit) */
        .item-card:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-soft);
            border-color: var(--rose-gold);
        }

        .item-card h3 {
            font-size: var(--fs-h3);
            color: var(--ink-black);
            margin-bottom: var(--baseline);
            /* é™åˆ¶æ¨™é¡Œè¡Œæ•¸ */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .item-card-content {
            font-size: var(--fs-body);
            color: var(--soft-gray);
            flex-grow: 1;
            margin-bottom: var(--baseline);
            /* é™åˆ¶å…§å®¹è¡Œæ•¸ */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .item-card-meta {
            font-size: var(--fs-small);
            color: var(--soft-gray);
            opacity: 0.7;
        }

        .item-tags {
            margin-bottom: var(--baseline);
            display: flex;
            flex-wrap: wrap;
            gap: var(--baseline);
        }

        .tag {
            font-size: var(--fs-small);
            background: rgba(199, 162, 124, 0.2);
            /* rose-gold alpha */
            color: var(--rose-gold);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
        }

        .empty-list-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: calc(var(--baseline) * 10) 0;
            color: var(--soft-gray);
            font-family: var(--font-display);
            font-size: var(--fs-h3);
            border: 1px dashed var(--mist-silver);
            border-radius: var(--radius-md);
            background: var(--cream);
        }

        /* ç·¨è¼¯å™¨æŠ½å±œ (Editor Drawer) */
        .editor-drawer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: min(70vw, 800px);
            background: var(--ivory);
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform var(--dur-breathe-min) var(--easing-emphasized);
            z-index: 200;
            display: flex;
            flex-direction: column;
        }

        .editor-drawer.is-open {
            transform: translateX(0);
        }

        .editor-header {
            padding: calc(var(--baseline) * 2) calc(var(--baseline) * 4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--mist-silver);
            background: var(--cream);
            flex-shrink: 0;
        }

        .editor-header h2 {
            margin-bottom: 0;
        }

        .editor-body {
            padding: calc(var(--baseline) * 4);
            overflow-y: auto;
            flex-grow: 1;
        }

        .form-group {
            margin-bottom: calc(var(--baseline) * 3);
        }

        .form-group label {
            display: block;
            font-family: var(--font-display);
            font-size: var(--fs-h3);
            color: var(--ink-black);
            margin-bottom: var(--baseline);
        }

        .editor-footer {
            padding: calc(var(--baseline) * 2) calc(var(--baseline) * 4);
            border-top: 1px solid var(--mist-silver);
            background: var(--cream);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .editor-footer .button-group {
            display: flex;
            gap: var(--baseline);
        }

        /* è©³æƒ…é¢æ¿ (ç‰ˆæœ¬/é™„ä»¶) */
        .details-panel {
            border-top: 1px solid var(--mist-silver);
            margin-top: calc(var(--baseline) * 3);
            padding-top: calc(var(--baseline) * 3);
        }

        .details-tabs {
            display: flex;
            gap: calc(var(--baseline) * 2);
            border-bottom: 1px solid var(--mist-silver);
            margin-bottom: calc(var(--baseline) * 2);
        }

        .list-tab {
            font-family: var(--font-display);
            font-size: var(--fs-h3);
            padding-bottom: var(--baseline);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            color: var(--soft-gray);
        }

        .list-tab.active,
        .list-tab:hover {
            color: var(--ink-black);
            border-bottom-color: var(--rose-gold);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ç‰ˆæœ¬æ­·å² (Versions) */
        .version-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--mist-silver);
            border-radius: var(--radius-md);
        }

        .version-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--baseline) calc(var(--baseline) * 2);
            border-bottom: 1px solid var(--mist-silver);
            background: var(--cream);
        }

        .version-item:last-child {
            border-bottom: none;
        }

        .version-item-info {
            font-size: var(--fs-small);
        }

        .version-item-info .reason {
            color: var(--soft-gray);
            font-style: italic;
        }

        /* é™„ä»¶ (Attachments) - åƒ… IDB */
        .attachments-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--baseline);
        }

        .attachment-item {
            border: 1px solid var(--mist-silver);
            border-radius: var(--radius-md);
            padding: var(--baseline);
            font-size: var(--fs-small);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .drop-zone {
            border: 2px dashed var(--mist-silver);
            border-radius: var(--radius-md);
            padding: calc(var(--baseline) * 4);
            text-align: center;
            color: var(--soft-gray);
            background: var(--cream);
            transition: background-color var(--dur-fast) ease, border-color var(--dur-fast) ease;
        }

        .drop-zone.is-dragging {
            background-color: rgba(199, 162, 124, 0.2);
            /* rose-gold alpha */
            border-color: var(--rose-gold);
        }

        .idb-only {
            display: none;
        }

        /* é è¨­éš±è—é™„ä»¶åŠŸèƒ½ */

        /* --------------------------------- */
        /* 6. å½ˆå‡ºå¼è¦–çª— (Modals)          */
        /* --------------------------------- */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--dur-medium) ease, visibility var(--dur-medium) ease;
        }

        .modal-overlay.is-open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--ivory);
            padding: calc(var(--baseline) * 4);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90vw;
            box-shadow: var(--shadow-soft);
            transform: scale(0.95);
            transition: transform var(--dur-medium) var(--easing-emphasized);
        }

        .modal-overlay.is-open .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--baseline) * 2);
        }

        .modal-header h2 {
            margin-bottom: 0;
        }

        .modal-close-button {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--soft-gray);
            background: none;
            border: none;
            cursor: pointer;
        }

        .modal-close-button:hover {
            color: var(--ink-black);
        }

        .modal-body {
            margin-bottom: calc(var(--baseline) * 3);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--baseline);
        }

        /* å›æ”¶æ¡¶åˆ—è¡¨ */
        .trash-list {
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid var(--mist-silver);
            border-radius: var(--radius-md);
            background: var(--cream);
        }

        .trash-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--baseline) calc(var(--baseline) * 2);
            border-bottom: 1px solid var(--mist-silver);
        }

        .trash-item:last-child {
            border-bottom: none;
        }

        /* åŒ¯å‡º/åŒ¯å…¥ */
        .io-options {
            display: flex;
            flex-direction: column;
            gap: var(--baseline);
        }

        .io-options .button {
            width: 100%;
        }

        /* --------------------------------- */
        /* å…¨æ–‡æª¢ç´¢ & æ™ºæ…§è³‡æ–™å¤¾             */
        /* --------------------------------- */

        /* é€²éšæœå°‹é¢æ¿ */
        .search-panel {
            background: var(--cream);
            border: 1px solid var(--mist-silver);
            border-radius: var(--radius-md);
            padding: calc(var(--baseline) * 2);
            margin-bottom: calc(var(--baseline) * 3);
            display: none;
        }

        .search-panel.is-open {
            display: block;
        }

        .search-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--baseline);
            margin-bottom: calc(var(--baseline) * 2);
        }

        .search-highlight {
            background: rgba(199, 162, 124, 0.3);
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* æ™ºæ…§è³‡æ–™å¤¾å´é‚Šæ¬„ */
        .smart-folders-sidebar {
            position: fixed;
            left: 0;
            top: 100px;
            bottom: 0;
            width: 280px;
            background: var(--cream);
            border-right: 1px solid var(--mist-silver);
            transform: translateX(-100%);
            transition: transform var(--dur-medium) ease;
            z-index: 50;
            overflow-y: auto;
            padding: calc(var(--baseline) * 2);
        }

        .smart-folders-sidebar.is-open {
            transform: translateX(0);
        }

        .smart-folder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--baseline) calc(var(--baseline) * 2);
            margin-bottom: var(--baseline);
            background: var(--ivory);
            border: 1px solid var(--mist-silver);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--dur-fast) ease;
        }

        .smart-folder-item:hover {
            border-color: var(--rose-gold);
            transform: translateX(4px);
        }

        .smart-folder-item.active {
            background: var(--rose-gold);
            color: var(--ink-black);
            border-color: var(--rose-gold);
        }

        .smart-folder-name {
            font-weight: 500;
        }

        .smart-folder-count {
            font-size: var(--fs-small);
            opacity: 0.7;
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
        }

        .smart-folder-actions {
            display: flex;
            gap: 4px;
        }

        .smart-folder-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            opacity: 0.6;
            transition: opacity var(--dur-fast) ease;
        }

        .smart-folder-actions button:hover {
            opacity: 1;
        }

        /* ä¸»å…§å®¹å€åŸŸèª¿æ•´ */
        .main-content.with-sidebar {
            margin-left: 280px;
        }

        /* æœå°‹çµæœçµ±è¨ˆ */
        .search-stats {
            font-size: var(--fs-small);
            color: var(--soft-gray);
            margin-bottom: calc(var(--baseline) * 2);
            padding: var(--baseline) calc(var(--baseline) * 2);
            background: var(--cream);
            border-radius: var(--radius-md);
        }

        /* æ¨™ç±¤é›² */
        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: var(--baseline);
            margin-bottom: calc(var(--baseline) * 2);
        }

        .tag-cloud .tag {
            cursor: pointer;
            transition: all var(--dur-fast) ease;
        }

        .tag-cloud .tag:hover {
            background: var(--rose-gold);
            color: var(--ink-black);
        }

        .tag-cloud .tag.selected {
            background: var(--rose-gold);
            color: var(--ink-black);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .smart-folders-sidebar {
                width: 100vw;
            }

            .main-content.with-sidebar {
                margin-left: 0;
            }

            .search-options {
                grid-template-columns: 1fr;
            }

            .nav-buttons {
                flex-wrap: wrap;
                gap: var(--baseline);
            }

            .nav-buttons .button {
                font-size: var(--fs-small);
                padding: calc(var(--baseline) * 0.75) calc(var(--baseline) * 1.5);
            }
        }

        /* --------------------------------- */
        /* 7. ç‹€æ…‹èˆ‡è¼”åŠ© (States & Helpers) */
        /* --------------------------------- */

        /* å‘¼å¸æ„Ÿæ»¾å‹• (Speckit) */
        .reveal-on-scroll {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity var(--dur-breathe-min) var(--easing-emphasized),
                transform var(--dur-breathe-min) var(--easing-emphasized);
        }

        .reveal-on-scroll.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* æç¤ºè¨Šæ¯ (Toast) */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: var(--baseline) calc(var(--baseline) * 2);
            background: var(--smoke);
            color: var(--ivory);
            border-radius: var(--radius-md);
            z-index: 9999;
            opacity: 0;
            transition: opacity var(--dur-medium) ease, transform var(--dur-medium) ease;
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast-notification.success {
            background-color: #28a745;
        }

        .toast-notification.error {
            background-color: #dc3545;
        }

        .toast-notification.warning {
            background-color: #ffc107;
            color: var(--ink-black);
        }

        .no-print {
            /* åœ¨ JS ä¸­ç”¨æ–¼æ¨™è¨˜ï¼Œä¸»è¦ç”± @media print æ§åˆ¶ */
        }

        /* --------------------------------- */
        /* 8. é å°¾ (Footer)                 */
        /* --------------------------------- */

        .app-footer {
            padding: calc(var(--baseline) * 4) 0;
            margin-top: calc(var(--baseline) * 6);
            border-top: 1px solid var(--mist-silver);
            font-size: var(--fs-small);
            color: var(--soft-gray);
            text-align: center;
        }

        /* --------------------------------- */
        /* 9. åˆ—å°æ¨£å¼ (Print Styles)       */
        /* --------------------------------- */

        @media print {
            body {
                background: #fff;
                color: #000;
                font-family: Georgia, "Times New Roman", serif;
                /* åˆ—å°æ™‚ä½¿ç”¨è¥¯ç·šé«” */
            }

            /* éš±è—æ‰€æœ‰éå…§å®¹å…ƒç´  */
            .app-header,
            .app-footer,
            .list-controls,
            .editor-header,
            .editor-footer,
            .details-panel,
            .modal-overlay,
            .no-print {
                display: none !important;
            }

            .container {
                width: 100%;
                max-width: 100%;
                padding: 0;
                margin: 0;
            }

            /* åˆ—å°æ¨¡å¼åˆ‡æ› */
            body.printing-list .item-list {
                display: block;
                /* ç§»é™¤ç¶²æ ¼ */
            }

            body.printing-list .editor-drawer {
                display: none;
            }

            body.printing-list .item-card {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid;
                transform: none !important;
            }

            body.printing-item .item-list,
            body.printing-item .block-hero {
                display: none;
            }

            body.printing-item .editor-drawer {
                display: block !important;
                position: static;
                width: 100%;
                transform: none;
                box-shadow: none;
                height: auto;
                overflow: visible;
            }

            body.printing-item .editor-body {
                padding: 0;
                overflow: visible;
                height: auto;
            }

            h1,
            h2,
            h3 {
                color: #000;
                page-break-after: avoid;
            }

            a {
                color: #000;
                text-decoration: underline;
            }
        }
    </style>
</head>

<body>

    <!-- 1. æ‡‰ç”¨ç¨‹å¼æ¨™é ­ (Header) -->
    <header class="app-header no-print">
        <div class="container">
            <div class="app-logo" role="banner">A R C H I V E</div>
            <nav class="nav-buttons" role="navigation">
                <button class="button hover-mist" id="btn-smart-folders" aria-label="æ™ºæ…§è³‡æ–™å¤¾">æ™ºæ…§è³‡æ–™å¤¾</button>
                <button class="button hover-mist" id="btn-trash" aria-label="é–‹å•Ÿå›æ”¶æ¡¶">å›æ”¶æ¡¶</button>
                <button class="button hover-mist" id="btn-io" aria-label="åŒ¯å…¥æˆ–åŒ¯å‡ºè³‡æ–™">åŒ¯å…¥/åŒ¯å‡º</button>
                <button class="button primary" id="btn-new-item" aria-label="æ–°å¢é …ç›®">æ–°å¢ç­†è¨˜</button>
            </nav>
        </div>
    </header>

    <!-- æ™ºæ…§è³‡æ–™å¤¾å´é‚Šæ¬„ -->
    <aside class="smart-folders-sidebar no-print" id="smart-folders-sidebar">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--baseline) * 2);">
            <h3 style="margin: 0;">æ™ºæ…§è³‡æ–™å¤¾</h3>
            <button class="button" id="btn-new-smart-folder">æ–°å¢</button>
        </div>

        <div id="smart-folders-list">
            <!-- æ™ºæ…§è³‡æ–™å¤¾é …ç›®å°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
        </div>

        <div
            style="margin-top: calc(var(--baseline) * 3); padding-top: calc(var(--baseline) * 2); border-top: 1px solid var(--mist-silver);">
            <button class="button" id="btn-close-smart-folders" style="width: 100%;">é—œé–‰</button>
        </div>
    </aside>

    <!-- 2. ä¸»å…§å®¹å€åŸŸ (Main Content) -->
    <main class="main-content">

        <!-- 2.1 Hero å€å¡Š -->
        <section class="block-hero no-print">
            <div class="container">
                <h1 class="hero-title" aria-label="ARCHIVE">A R C H I V E</h1>
                <p class="hero-subtitle">ä¸€å€‹ç§å¯†ã€é›¢ç·šã€å±¬æ–¼æ‚¨çš„ç·¨è¼¯ç©ºé–“ã€‚</p>
            </div>
        </section>

        <!-- 2.2 App æ‡‰ç”¨ç¨‹å¼æ®¼ -->
        <section class="app-shell container">

            <!-- æ§åˆ¶é … (æœå°‹/æ–°å¢) -->
            <div class="list-controls no-print">
                <div class="search-bar">
                    <input type="search" id="search-input" placeholder="æœå°‹æ¨™é¡Œã€å…§å®¹æˆ–æ¨™ç±¤...">
                    <button class="button" id="btn-advanced-search" style="margin-left: 8px;">é€²éš</button>
                </div>
            </div>

            <!-- é€²éšæœå°‹é¢æ¿ -->
            <div class="search-panel no-print" id="search-panel">
                <div class="search-options">
                    <div>
                        <label>
                            <input type="checkbox" id="search-title" checked> æœå°‹æ¨™é¡Œ
                        </label>
                    </div>
                    <div>
                        <label>
                            <input type="checkbox" id="search-content" checked> æœå°‹å…§å®¹
                        </label>
                    </div>
                    <div>
                        <label>
                            <input type="checkbox" id="search-tags" checked> æœå°‹æ¨™ç±¤
                        </label>
                    </div>
                    <div>
                        <label>
                            <input type="checkbox" id="search-case-sensitive"> å€åˆ†å¤§å°å¯«
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: var(--baseline);">
                    <input type="text" id="search-tags-filter" placeholder="ç¯©é¸æ¨™ç±¤...">
                    <select id="search-sort">
                        <option value="relevance">ç›¸é—œæ€§</option>
                        <option value="date-desc">æœ€æ–°å„ªå…ˆ</option>
                        <option value="date-asc">æœ€èˆŠå„ªå…ˆ</option>
                        <option value="title">æ¨™é¡Œæ’åº</option>
                    </select>
                </div>

                <div class="tag-cloud" id="tag-cloud">
                    <!-- æ¨™ç±¤é›²å°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>

            <!-- æœå°‹çµæœçµ±è¨ˆ -->
            <div class="search-stats" id="search-stats" style="display: none;">
                <!-- æœå°‹çµ±è¨ˆå°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
            </div>

            <!-- é …ç›®åˆ—è¡¨ (é›œèªŒç¶²æ ¼) -->
            <div class="item-list" id="item-list-container" role="feed">
                <!-- é …ç›®å¡ç‰‡å°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
            </div>

            <div class="empty-list-message" id="empty-list-message" style="display: none;">
                å°šæœªå»ºç«‹ä»»ä½•ç­†è¨˜ã€‚é»æ“Šã€Œæ–°å¢ç­†è¨˜ã€é–‹å§‹ã€‚
            </div>

        </section>

    </main>

    <!-- 3. é å°¾ (Footer) -->
    <footer class="app-footer no-print">
        <p>A R C H I V E é›¢ç·šæ‡‰ç”¨ç¨‹å¼æ®¼ã€‚è³‡æ–™å®Œå…¨å„²å­˜æ–¼æœ¬åœ°ã€‚</p>
        <p id="db-status-message" style="font-size: var(--fs-small); color: var(--rose-gold);"></p>
    </footer>

    <!-- 4. ç·¨è¼¯å™¨æŠ½å±œ (Editor Drawer) -->
    <aside class="editor-drawer" id="editor-drawer" role="form" aria-labelledby="editor-title">

        <header class="editor-header no-print">
            <h2 id="editor-title">ç·¨è¼¯ç­†è¨˜</h2>
            <button class="button" id="btn-editor-close" aria-label="é—œé–‰ç·¨è¼¯å™¨">é—œé–‰</button>
        </header>

        <form id="editor-form" class="editor-body">
            <!-- éš±è—çš„ ID æ¬„ä½ -->
            <input type="hidden" id="editor-item-id">

            <div class="form-group">
                <label for="editor-title-input">æ¨™é¡Œ</label>
                <input type="text" id="editor-title-input" required>
            </div>

            <div class="form-group">
                <label for="editor-content-input">å…§å®¹</label>
                <textarea id="editor-content-input"></textarea>
            </div>

            <div class="form-group">
                <label for="editor-tags-input">æ¨™ç±¤ (ä»¥é€—è™Ÿåˆ†éš”)</label>
                <input type="text" id="editor-tags-input">
            </div>

            <!-- è©³æƒ…é¢æ¿ (ç‰ˆæœ¬/é™„ä»¶) -->
            <div class="details-panel no-print">
                <nav class="details-tabs">
                    <button type="button" class="list-tab active" data-tab="versions" role="tab"
                        aria-controls="tab-versions">ç‰ˆæœ¬æ­·å²</button>
                    <button type="button" class="list-tab idb-only" data-tab="attachments" role="tab"
                        aria-controls="tab-attachments">é™„ä»¶</button>
                </nav>

                <!-- ç‰ˆæœ¬æ­·å² -->
                <div id="tab-versions" class="tab-content active" role="tabpanel">
                    <div class="version-list" id="version-list-container">
                        <!-- ç‰ˆæœ¬é …ç›®å°‡ç”± JS è¼‰å…¥ -->
                    </div>
                    <p id="version-empty-message"
                        style="font-size: var(--fs-small); color: var(--soft-gray); margin-top: 8px;">å°šç„¡æ­·å²ç‰ˆæœ¬ã€‚</p>
                </div>

                <!-- é™„ä»¶ (åƒ… IDB) -->
                <div id="tab-attachments" class="tab-content idb-only" role="tabpanel">
                    <div class="drop-zone" id="attachment-drop-zone">
                        <p>æ‹–æ”¾æª”æ¡ˆè‡³æ­¤ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <input type="file" id="attachment-file-input" multiple style="display: none;">
                    </div>
                    <div class="attachments-list" id="attachment-list-container" style="margin-top: 16px;">
                        <!-- é™„ä»¶é …ç›®å°‡ç”± JS è¼‰å…¥ -->
                    </div>
                </div>

            </div>

        </form>

        <footer class="editor-footer no-print">
            <div class="button-group">
                <button type="button" class="button danger" id="btn-editor-delete" aria-label="åˆªé™¤æ­¤ç­†è¨˜">åˆªé™¤</button>
                <button type="button" class="button" id="btn-editor-print" aria-label="åˆ—å°æ­¤ç­†è¨˜">åˆ—å°</button>
            </div>
            <div class="button-group">
                <button type="submit" class="button primary" form="editor-form" aria-label="å„²å­˜ç­†è¨˜">å„²å­˜</button>
            </div>
        </footer>
    </aside>

    <!-- 5. å½ˆå‡ºå¼è¦–çª— (Modals) -->

    <!-- å›æ”¶æ¡¶ Modal -->
    <div class="modal-overlay" id="trash-modal" role="dialog" aria-modal="true" aria-labelledby="trash-modal-title">
        <div class="modal-content">
            <header class="modal-header">
                <h2 id="trash-modal-title">å›æ”¶æ¡¶</h2>
                <button class="modal-close-button" data-modal-close="trash-modal" aria-label="é—œé–‰">&times;</button>
            </header>
            <div class="modal-body">
                <p>é …ç›®å°‡åœ¨æ­¤è™•ä¿ç•™ 30 å¤©ï¼ˆæˆ–ç›´åˆ°æ‚¨æ°¸ä¹…åˆªé™¤ï¼‰ã€‚</p>
                <div class="trash-list" id="trash-list-container">
                    <!-- å›æ”¶æ¡¶é …ç›®ç”± JS è¼‰å…¥ -->
                </div>
                <p id="trash-empty-message" style="text-align: center; padding: 16px; display: none;">å›æ”¶æ¡¶æ˜¯ç©ºçš„ã€‚</p>
            </div>
            <footer class="modal-footer">
                <button class="button danger" id="btn-empty-trash" aria-label="æ¸…ç©ºå›æ”¶æ¡¶">æ¸…ç©ºå›æ”¶æ¡¶</button>
                <button class="button" data-modal-close="trash-modal">é—œé–‰</button>
            </footer>
        </div>
    </div>

    <!-- åŒ¯å…¥/åŒ¯å‡º Modal -->
    <div class="modal-overlay" id="io-modal" role="dialog" aria-modal="true" aria-labelledby="io-modal-title">
        <div class="modal-content">
            <header class="modal-header">
                <h2 id="io-modal-title">åŒ¯å…¥ / åŒ¯å‡º</h2>
                <button class="modal-close-button" data-modal-close="io-modal" aria-label="é—œé–‰">&times;</button>
            </header>
            <div class="modal-body io-options">
                <p>å°‡æ‰€æœ‰è³‡æ–™ï¼ˆåŒ…å«ç­†è¨˜ã€ç‰ˆæœ¬å’Œæ¨™ç±¤ï¼‰åŒ¯å‡ºç‚º JSON æª”æ¡ˆã€‚é™„ä»¶ï¼ˆè‹¥æ”¯æ´ï¼‰å¯é¸æ“‡æ€§åœ°å…§åµŒç‚º Base64ã€‚</p>

                <label style="font-size: var(--fs-small); display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="export-include-attachments" class="idb-only">
                    <span class="idb-only">å…§åµŒé™„ä»¶ (æª”æ¡ˆå¯èƒ½å¾ˆå¤§)</span>
                </label>

                <button class="button primary" id="btn-export-data">åŒ¯å‡ºè³‡æ–™</button>

                <hr style="border: none; border-top: 1px solid var(--mist-silver; margin: 16px 0;">

                <p>å¾ JSON æª”æ¡ˆåŒ¯å…¥è³‡æ–™ã€‚é€™å¯èƒ½æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ã€‚</p>
                <input type="file" id="import-file-input" accept=".json">
                <button class="button" id="btn-import-data" disabled>åŒ¯å…¥è³‡æ–™ (é¸æ“‡æª”æ¡ˆ)</button>
            </div>
            <footer class="modal-footer">
                <button class="button" data-modal-close="io-modal">é—œé–‰</button>
            </footer>
        </div>
    </div>

    <!-- ç¢ºèªè¦–çª— Modal (é€šç”¨) -->
    <div class="modal-overlay" id="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-modal-title">
        <div class="modal-content">
            <header class="modal-header">
                <h2 id="confirm-modal-title">è«‹ç¢ºèª</h2>
            </header>
            <div class="modal-body">
                <p id="confirm-modal-message">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            </div>
            <footer class="modal-footer">
                <button class="button" id="btn-confirm-cancel">å–æ¶ˆ</button>
                <button class="button danger" id="btn-confirm-action">ç¢ºèª</button>
            </footer>
        </div>
    </div>

    <!-- æç¤ºè¨Šæ¯ (Toast) å®¹å™¨ -->
    <div id="toast-container" class="toast-notification" role="alert" aria-live="assertive"></div>


    <!-- æ™ºæ…§è³‡æ–™å¤¾ç·¨è¼¯ Modal -->
    <div class="modal-overlay" id="smart-folder-modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <header class="modal-header">
                <h2 id="smart-folder-modal-title">ç·¨è¼¯æ™ºæ…§è³‡æ–™å¤¾</h2>
                <button class="modal-close-button" data-modal-close="smart-folder-modal"
                    aria-label="é—œé–‰">&times;</button>
            </header>
            <div class="modal-body">
                <form id="smart-folder-form">
                    <div class="form-group">
                        <label for="smart-folder-name">è³‡æ–™å¤¾åç¨±</label>
                        <input type="text" id="smart-folder-name" required>
                    </div>
                    <div class="form-group">
                        <label for="smart-folder-icon">åœ–ç¤º</label>
                        <input type="text" id="smart-folder-icon" placeholder="ğŸ“">
                    </div>
                    <div class="form-group">
                        <label for="smart-folder-type">æ¢ä»¶é¡å‹</label>
                        <select id="smart-folder-type">
                            <option value="keyword">é—œéµå­—</option>
                            <option value="tag">æ¨™ç±¤</option>
                            <option value="recent">æœ€è¿‘ç·¨è¼¯</option>
                            <option value="untagged">æœªåˆ†é¡</option>
                        </select>
                    </div>
                    <div class="form-group" id="smart-folder-value-group">
                        <label for="smart-folder-value">æ¢ä»¶å€¼</label>
                        <input type="text" id="smart-folder-value" placeholder="è¼¸å…¥é—œéµå­—æˆ–æ¨™ç±¤">
                    </div>
                    <div class="form-group" id="smart-folder-days-group" style="display: none;">
                        <label for="smart-folder-days">å¤©æ•¸</label>
                        <input type="number" id="smart-folder-days" value="7" min="1">
                    </div>
                </form>
            </div>
            <footer class="modal-footer">
                <button class="button" data-modal-close="smart-folder-modal">å–æ¶ˆ</button>
                <button class="button primary" id="btn-save-smart-folder">å„²å­˜</button>
            </footer>
        </div>
    </div>

    <!-- --------------------------------- -->
    <!-- 10. æ‡‰ç”¨ç¨‹å¼è…³æœ¬ (JavaScript)   -->
    <!-- --------------------------------- -->

    <script>
        // ç«‹å³åŸ·è¡Œå‡½å¼ (IIFE) ä»¥é¿å…æ±¡æŸ“å…¨åŸŸç¯„åœ
        (function () {
            "use strict";

            // --- 1. å¸¸æ•¸èˆ‡ç‹€æ…‹ç®¡ç† ---

            const DB_NAME = 'ArchiveAppDB';
            const DB_VERSION = 1;
            const STORES = {
                ITEMS: 'items',
                VERSIONS: 'versions',
                ATTACHMENTS: 'attachments',
                TRASH: 'trash'
            };

            // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
            let state = {
                db: null, // è³‡æ–™åº«å¯¦ä¾‹
                dbMode: 'idb', // 'idb' æˆ– 'ls' (localStorage)
                currentItemId: null, // ç•¶å‰åœ¨ç·¨è¼¯å™¨ä¸­é–‹å•Ÿçš„é …ç›® ID
                currentModal: null, // ç•¶å‰é–‹å•Ÿçš„ modal
                confirmCallback: null // ç¢ºèªè¦–çª—çš„å›å‘¼å‡½å¼
            };

            // --- 2. DOM ç¯€é»å¿«å– ---

            // å¿«å– DOM æŸ¥è©¢çµæœ
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const dom = {
                header: $('.app-header'),
                heroTitle: $('.hero-title'),
                heroSubtitle: $('.hero-subtitle'),
                itemListContainer: $('#item-list-container'),
                emptyListMessage: $('#empty-list-message'),

                // ç·¨è¼¯å™¨
                editorDrawer: $('#editor-drawer'),
                editorForm: $('#editor-form'),
                editorTitle: $('#editor-title'),
                editorItemId: $('#editor-item-id'),
                editorTitleInput: $('#editor-title-input'),
                editorContentInput: $('#editor-content-input'),
                editorTagsInput: $('#editor-tags-input'),

                // è©³æƒ…é¢æ¿
                detailTabs: $$('.list-tab'),
                tabContents: $$('.tab-content'),
                versionListContainer: $('#version-list-container'),
                versionEmptyMessage: $('#version-empty-message'),

                // é™„ä»¶ (IDB)
                idbOnlyElements: $$('.idb-only'),
                attachmentDropZone: $('#attachment-drop-zone'),
                attachmentFileInput: $('#attachment-file-input'),
                attachmentListContainer: $('#attachment-list-container'),

                // æ§åˆ¶é …
                btnNewItem: $('#btn-new-item'),
                btnEditorClose: $('#btn-editor-close'),
                btnEditorDelete: $('#btn-editor-delete'),
                btnEditorPrint: $('#btn-editor-print'),

                // æœå°‹
                searchInput: $('#search-input'),
                btnAdvancedSearch: $('#btn-advanced-search'),
                searchPanel: $('#search-panel'),
                searchTitle: $('#search-title'),
                searchContent: $('#search-content'),
                searchTags: $('#search-tags'),
                searchCaseSensitive: $('#search-case-sensitive'),
                searchTagsFilter: $('#search-tags-filter'),
                searchSort: $('#search-sort'),
                tagCloud: $('#tag-cloud'),
                searchStats: $('#search-stats'),

                // æ™ºæ…§è³‡æ–™å¤¾
                btnSmartFolders: $('#btn-smart-folders'),
                smartFoldersSidebar: $('#smart-folders-sidebar'),
                smartFoldersList: $('#smart-folders-list'),
                btnNewSmartFolder: $('#btn-new-smart-folder'),
                btnCloseSmartFolders: $('#btn-close-smart-folders'),
                mainContent: $('.main-content'),

                // å›æ”¶æ¡¶
                btnTrash: $('#btn-trash'),
                trashModal: $('#trash-modal'),
                trashListContainer: $('#trash-list-container'),
                trashEmptyMessage: $('#trash-empty-message'),
                btnEmptyTrash: $('#btn-empty-trash'),

                // åŒ¯å…¥/åŒ¯å‡º
                btnIO: $('#btn-io'),
                ioModal: $('#io-modal'),
                btnExport: $('#btn-export-data'),
                exportIncludeAttachments: $('#export-include-attachments'),
                btnImport: $('#btn-import-data'),
                importFileInput: $('#import-file-input'),

                // ç¢ºèªè¦–çª—
                confirmModal: $('#confirm-modal'),
                confirmModalTitle: $('#confirm-modal-title'),
                confirmModalMessage: $('#confirm-modal-message'),
                btnConfirmCancel: $('#btn-confirm-cancel'),
                btnConfirmAction: $('#btn-confirm-action'),

                // ç‹€æ…‹
                toastContainer: $('#toast-container'),
                dbStatusMessage: $('#db-status-message'),
            };

            // --- 3. è³‡æ–™åº«å±¤ (Data Layer) ---

            /**
             * è³‡æ–™æœå‹™æŠ½è±¡å±¤
             * ç„¡è«–ä½¿ç”¨ IndexedDB é‚„æ˜¯ localStorageï¼Œéƒ½æä¾›ä¸€è‡´çš„ API
             */
            const dataService = {
                // --- é …ç›® (Items) ---
                getItem: async (id) => {
                    if (state.dbMode === 'idb') {
                        return await idbGet(STORES.ITEMS, id);
                    } else {
                        return lsGet(STORES.ITEMS, id);
                    }
                },
                getAllItems: async () => {
                    if (state.dbMode === 'idb') {
                        return await idbGetAll(STORES.ITEMS);
                    } else {
                        return lsGetAll(STORES.ITEMS);
                    }
                },
                saveItem: async (item) => {
                    if (state.dbMode === 'idb') {
                        return await idbPut(STORES.ITEMS, item);
                    } else {
                        return lsPut(STORES.ITEMS, item);
                    }
                },
                deleteItem: async (id) => {
                    if (state.dbMode === 'idb') {
                        return await idbDelete(STORES.ITEMS, id);
                    } else {
                        return lsDelete(STORES.ITEMS, id);
                    }
                },

                // --- ç‰ˆæœ¬ (Versions) ---
                getVersionsByItemId: async (itemId) => {
                    if (state.dbMode === 'idb') {
                        const allVersions = await idbGetAll(STORES.VERSIONS);
                        // IDB ä¸æ˜“å»ºç«‹ç´¢å¼•ï¼Œåœ¨æ­¤æ‰‹å‹•éæ¿¾ä¸¦æ’åº
                        return allVersions
                            .filter(v => v.itemId === itemId)
                            .sort((a, b) => b.createdAtTS - a.createdAtTS);
                    } else {
                        const allVersions = lsGetAll(STORES.VERSIONS);
                        return allVersions
                            .filter(v => v.itemId === itemId)
                            .sort((a, b) => b.createdAtTS - a.createdAtTS);
                    }
                },
                saveVersion: async (version) => {
                    if (state.dbMode === 'idb') {
                        // IDB ä½¿ç”¨ autoIncrement key
                        delete version.versionId;
                        return await idbAdd(STORES.VERSIONS, version);
                    } else {
                        // LS æ¨¡æ“¬ autoIncrement
                        version.versionId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                        return lsAdd(STORES.VERSIONS, version);
                    }
                },

                // --- å›æ”¶æ¡¶ (Trash) ---
                getTrashItems: async () => {
                    if (state.dbMode === 'idb') {
                        return await idbGetAll(STORES.TRASH);
                    } else {
                        return lsGetAll(STORES.TRASH);
                    }
                },
                trashItem: async (item) => {
                    // è»Ÿåˆªé™¤ï¼š1. å­˜å…¥å›æ”¶æ¡¶ 2. å¾ä¸»åˆ—è¡¨åˆªé™¤
                    const trashEntry = {
                        ...item,
                        deletedAt: Date.now()
                    };

                    if (state.dbMode === 'idb') {
                        await idbPut(STORES.TRASH, trashEntry);
                        await idbDelete(STORES.ITEMS, item.id);
                    } else {
                        lsPut(STORES.TRASH, trashEntry);
                        lsDelete(STORES.ITEMS, item.id);
                    }
                },
                restoreTrashItem: async (id) => {
                    // 1. å¾å›æ”¶æ¡¶å–å¾— 2. å­˜å›ä¸»åˆ—è¡¨ 3. å¾å›æ”¶æ¡¶åˆªé™¤
                    let item;
                    if (state.dbMode === 'idb') {
                        item = await idbGet(STORES.TRASH, id);
                        if (!item) return;
                        delete item.deletedAt;
                        await idbPut(STORES.ITEMS, item);
                        await idbDelete(STORES.TRASH, id);
                    } else {
                        item = lsGet(STORES.TRASH, id);
                        if (!item) return;
                        delete item.deletedAt;
                        lsPut(STORES.ITEMS, item);
                        lsDelete(STORES.TRASH, id);
                    }
                },
                purgeTrashItem: async (id) => {
                    // æ°¸ä¹…åˆªé™¤ (ä¹Ÿæ‡‰åˆªé™¤ç›¸é—œçš„ç‰ˆæœ¬å’Œé™„ä»¶)
                    if (state.dbMode === 'idb') {
                        await idbDelete(STORES.TRASH, id);
                        // TODO: ç´šè¯åˆªé™¤ç‰ˆæœ¬å’Œé™„ä»¶
                    } else {
                        lsDelete(STORES.TRASH, id);
                    }
                },
                emptyTrash: async () => {
                    if (state.dbMode === 'idb') {
                        await idbClear(STORES.TRASH);
                        // TODO: ç´šè¯åˆªé™¤
                    } else {
                        lsClear(STORES.TRASH);
                    }
                },

                // --- é™„ä»¶ (Attachments - IDB Only) ---
                saveAttachment: async (file, itemId) => {
                    if (state.dbMode !== 'idb') return null;
                    const attachment = {
                        id: crypto.randomUUID(),
                        itemId: itemId,
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        blob: file, // å„²å­˜ Blob ç‰©ä»¶
                        createdAt: Date.now()
                    };
                    await idbAdd(STORES.ATTACHMENTS, attachment);
                    return attachment;
                },
                getAttachmentsByItemId: async (itemId) => {
                    if (state.dbMode !== 'idb') return [];
                    const all = await idbGetAll(STORES.ATTACHMENTS);
                    return all.filter(a => a.itemId === itemId);
                },
                deleteAttachment: async (id) => {
                    if (state.dbMode !== 'idb') return;
                    await idbDelete(STORES.ATTACHMENTS, id);
                },
                getAttachmentBlob: async (id) => {
                    if (state.dbMode !== 'idb') return null;
                    const attachment = await idbGet(STORES.ATTACHMENTS, id);
                    return attachment ? attachment.blob : null;
                },

                // --- åŒ¯å‡º/åŒ¯å…¥ ---
                exportData: async (includeAttachments = false) => {
                    const data = {
                        meta: { exportedAt: Date.now(), version: '1.0' },
                        items: await dataService.getAllItems(),
                        versions: (state.dbMode === 'idb' ? await idbGetAll(STORES.VERSIONS) : lsGetAll(STORES.VERSIONS)),
                        trash: await dataService.getTrashItems(),
                        attachments: []
                    };

                    if (state.dbMode === 'idb' && includeAttachments) {
                        const attachments = await idbGetAll(STORES.ATTACHMENTS);
                        for (const att of attachments) {
                            const base64 = await blobToBase64(att.blob);
                            data.attachments.push({ ...att, blob: base64 });
                        }
                    }
                    return data;
                },

                importData: async (data) => {
                    // ç°¡æ˜“åŒ¯å…¥ï¼šæ¸…ç©ºä¸¦å–ä»£
                    if (state.dbMode === 'idb') {
                        await idbClear(STORES.ITEMS);
                        await idbClear(STORES.VERSIONS);
                        await idbClear(STORES.TRASH);
                        await idbClear(STORES.ATTACHMENTS);

                        for (const item of data.items || []) await idbPut(STORES.ITEMS, item);
                        for (const version of data.versions || []) await idbAdd(STORES.VERSIONS, version);
                        for (const item of data.trash || []) await idbPut(STORES.TRASH, item);

                        if (data.attachments) {
                            for (const att of data.attachments) {
                                const blob = base64ToBlob(att.blob, att.type);
                                await idbAdd(STORES.ATTACHMENTS, { ...att, blob });
                            }
                        }
                    } else {
                        // LS æ¨¡å¼
                        lsClear(STORES.ITEMS);
                        lsClear(STORES.VERSIONS);
                        lsClear(STORES.TRASH);

                        (data.items || []).forEach(item => lsPut(STORES.ITEMS, item));
                        (data.versions || []).forEach(ver => lsAdd(STORES.VERSIONS, ver));
                        (data.trash || []).forEach(item => lsPut(STORES.TRASH, item));
                        // LS æ¨¡å¼ä¸åŒ¯å…¥é™„ä»¶
                    }
                }
            };

            // --- 3.1 å…¨æ–‡æª¢ç´¢å¼•æ“ (Full-Text Search Engine) ---

            /**
             * å…¨æ–‡æª¢ç´¢å¼•æ“
             * æ”¯æ´ tokenizeã€å‰ç¶´åŒ¹é…ã€æ¨™ç±¤/å…§å®¹åŠ æ¬Šã€çµæœé«˜äº®
             */
            const searchEngine = {
                // ç´¢å¼•ç·©å­˜
                _index: null,
                _lastIndexTime: 0,

                // åˆ†è©å™¨ - æ”¯æ´ä¸­è‹±æ–‡
                tokenize(text) {
                    if (!text) return [];

                    // è½‰æ›ç‚ºå°å¯«ä¸¦ç§»é™¤æ¨™é»ç¬¦è™Ÿ
                    const cleaned = text.toLowerCase().replace(/[^\w\u4e00-\u9fff\s]/g, ' ');

                    // åˆ†å‰²ä¸­è‹±æ–‡è©å½™
                    const tokens = [];
                    const words = cleaned.split(/\s+/).filter(w => w.length > 0);

                    for (const word of words) {
                        // è‹±æ–‡å–®è©ç›´æ¥åŠ å…¥
                        if (/^[a-z]+$/.test(word)) {
                            tokens.push(word);
                            // æ·»åŠ å‰ç¶´åŒ¹é…æ”¯æ´
                            for (let i = 2; i <= word.length; i++) {
                                tokens.push(word.substring(0, i));
                            }
                        }
                        // ä¸­æ–‡å­—ç¬¦é€å­—åŠ å…¥
                        else if (/[\u4e00-\u9fff]/.test(word)) {
                            for (const char of word) {
                                if (/[\u4e00-\u9fff]/.test(char)) {
                                    tokens.push(char);
                                }
                            }
                            // ä¸­æ–‡è©çµ„ï¼ˆ2-3å­—ï¼‰
                            for (let i = 0; i < word.length - 1; i++) {
                                tokens.push(word.substring(i, i + 2));
                                if (i < word.length - 2) {
                                    tokens.push(word.substring(i, i + 3));
                                }
                            }
                        }
                    }

                    return [...new Set(tokens)]; // å»é‡
                },

                // å»ºç«‹ç´¢å¼•
                async buildIndex() {
                    const items = await dataService.getAllItems();
                    const index = new Map();

                    for (const item of items) {
                        const doc = {
                            id: item.id,
                            title: item.title || '',
                            content: item.content || '',
                            tags: item.tags || [],
                            createdAt: item.createdAt,
                            updatedAt: item.updatedAt
                        };

                        // æ¨™é¡Œæ¬Šé‡ 3
                        const titleTokens = this.tokenize(doc.title);
                        titleTokens.forEach(token => {
                            if (!index.has(token)) index.set(token, []);
                            index.get(token).push({ docId: doc.id, field: 'title', weight: 3, doc });
                        });

                        // å…§å®¹æ¬Šé‡ 1
                        const contentTokens = this.tokenize(doc.content);
                        contentTokens.forEach(token => {
                            if (!index.has(token)) index.set(token, []);
                            index.get(token).push({ docId: doc.id, field: 'content', weight: 1, doc });
                        });

                        // æ¨™ç±¤æ¬Šé‡ 2
                        doc.tags.forEach(tag => {
                            const tagTokens = this.tokenize(tag);
                            tagTokens.forEach(token => {
                                if (!index.has(token)) index.set(token, []);
                                index.get(token).push({ docId: doc.id, field: 'tags', weight: 2, doc });
                            });
                        });
                    }

                    this._index = index;
                    this._lastIndexTime = Date.now();
                    return index;
                },

                // æœå°‹
                async search(query, options = {}) {
                    const {
                        searchTitle = true,
                        searchContent = true,
                        searchTags = true,
                        caseSensitive = false,
                        sortBy = 'relevance',
                        tagFilter = null
                    } = options;

                    // æª¢æŸ¥ç´¢å¼•æ˜¯å¦éœ€è¦é‡å»º
                    if (!this._index || Date.now() - this._lastIndexTime > 60000) {
                        await this.buildIndex();
                    }

                    if (!query.trim()) {
                        const items = await dataService.getAllItems();
                        return this._sortResults(items.map(item => ({ item, score: 0, highlights: {} })), sortBy);
                    }

                    const queryTokens = this.tokenize(caseSensitive ? query : query.toLowerCase());
                    const results = new Map();

                    // æœå°‹æ¯å€‹ token
                    for (const token of queryTokens) {
                        const matches = this._index.get(token) || [];

                        for (const match of matches) {
                            // æª¢æŸ¥æ¬„ä½éæ¿¾
                            if (!searchTitle && match.field === 'title') continue;
                            if (!searchContent && match.field === 'content') continue;
                            if (!searchTags && match.field === 'tags') continue;

                            // æª¢æŸ¥æ¨™ç±¤éæ¿¾
                            if (tagFilter && !match.doc.tags.some(tag =>
                                tag.toLowerCase().includes(tagFilter.toLowerCase()))) continue;

                            if (!results.has(match.docId)) {
                                results.set(match.docId, {
                                    item: match.doc,
                                    score: 0,
                                    highlights: { title: [], content: [], tags: [] }
                                });
                            }

                            const result = results.get(match.docId);
                            result.score += match.weight;

                            // æ·»åŠ é«˜äº®
                            this._addHighlight(result.highlights, match.field, token, match.doc);
                        }
                    }

                    const sortedResults = this._sortResults(Array.from(results.values()), sortBy);
                    return sortedResults;
                },

                // æ·»åŠ é«˜äº®æ¨™è¨˜
                _addHighlight(highlights, field, token, doc) {
                    const text = field === 'tags' ? doc.tags.join(' ') : doc[field];
                    if (!text) return;

                    const regex = new RegExp(`(${this._escapeRegex(token)})`, 'gi');
                    const matches = text.match(regex);
                    if (matches) {
                        highlights[field] = highlights[field].concat(matches);
                    }
                },

                // æ’åºçµæœ
                _sortResults(results, sortBy) {
                    switch (sortBy) {
                        case 'relevance':
                            return results.sort((a, b) => b.score - a.score);
                        case 'date-desc':
                            return results.sort((a, b) => b.item.updatedAt - a.item.updatedAt);
                        case 'date-asc':
                            return results.sort((a, b) => a.item.updatedAt - b.item.updatedAt);
                        case 'title':
                            return results.sort((a, b) => (a.item.title || '').localeCompare(b.item.title || ''));
                        default:
                            return results;
                    }
                },

                // è½‰ç¾©æ­£å‰‡è¡¨é”å¼ç‰¹æ®Šå­—ç¬¦
                _escapeRegex(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                },

                // ç²å–æ‰€æœ‰æ¨™ç±¤
                async getAllTags() {
                    const items = await dataService.getAllItems();
                    const tagCounts = new Map();

                    items.forEach(item => {
                        (item.tags || []).forEach(tag => {
                            tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
                        });
                    });

                    return Array.from(tagCounts.entries())
                        .map(([tag, count]) => ({ tag, count }))
                        .sort((a, b) => b.count - a.count);
                }
            };

            // --- 3.2 æ™ºæ…§è³‡æ–™å¤¾ (Smart Folders) ---

            /**
             * æ™ºæ…§è³‡æ–™å¤¾ç®¡ç†
             * æ”¯æ´æ¢ä»¶éæ¿¾å’Œå‹•æ…‹æ›´æ–°
             */
            const smartFolders = {
                // é è¨­æ™ºæ…§è³‡æ–™å¤¾
                _defaultFolders: [
                    {
                        id: 'recent',
                        name: 'æœ€è¿‘ç·¨è¼¯',
                        icon: 'ğŸ•’',
                        conditions: { type: 'recent', days: 7 },
                        builtin: true
                    },
                    {
                        id: 'untagged',
                        name: 'æœªåˆ†é¡',
                        icon: 'ğŸ“',
                        conditions: { type: 'untagged' },
                        builtin: true
                    },
                    {
                        id: 'favorites',
                        name: 'æˆ‘çš„æœ€æ„›',
                        icon: 'â­',
                        conditions: { type: 'tag', value: 'æœ€æ„›' },
                        builtin: true
                    }
                ],

                // ç²å–æ‰€æœ‰æ™ºæ…§è³‡æ–™å¤¾
                async getAll() {
                    const custom = JSON.parse(localStorage.getItem('smartFolders') || '[]');
                    return [...this._defaultFolders, ...custom];
                },

                // å„²å­˜è‡ªè¨‚æ™ºæ…§è³‡æ–™å¤¾
                async save(folder) {
                    const custom = JSON.parse(localStorage.getItem('smartFolders') || '[]');
                    const existing = custom.findIndex(f => f.id === folder.id);

                    if (existing >= 0) {
                        custom[existing] = folder;
                    } else {
                        folder.id = 'custom_' + Date.now();
                        custom.push(folder);
                    }

                    localStorage.setItem('smartFolders', JSON.stringify(custom));
                    return folder;
                },

                // åˆªé™¤æ™ºæ…§è³‡æ–™å¤¾
                async delete(id) {
                    const custom = JSON.parse(localStorage.getItem('smartFolders') || '[]');
                    const filtered = custom.filter(f => f.id !== id);
                    localStorage.setItem('smartFolders', JSON.stringify(filtered));
                },

                // æ ¹æ“šæ¢ä»¶éæ¿¾é …ç›®
                async filterItems(conditions) {
                    const items = await dataService.getAllItems();

                    switch (conditions.type) {
                        case 'recent':
                            const cutoff = Date.now() - (conditions.days * 24 * 60 * 60 * 1000);
                            return items.filter(item => item.updatedAt > cutoff);

                        case 'untagged':
                            return items.filter(item => !item.tags || item.tags.length === 0);

                        case 'tag':
                            return items.filter(item =>
                                item.tags && item.tags.includes(conditions.value));

                        case 'keyword':
                            const results = await searchEngine.search(conditions.value);
                            return results.map(r => r.item);

                        case 'custom':
                            // æ”¯æ´è¤‡åˆæ¢ä»¶
                            return this._filterByCustomConditions(items, conditions);

                        default:
                            return items;
                    }
                },

                // è‡ªè¨‚æ¢ä»¶éæ¿¾
                _filterByCustomConditions(items, conditions) {
                    return items.filter(item => {
                        // å¯¦ç¾è¤‡åˆæ¢ä»¶é‚è¼¯
                        // é€™è£¡å¯ä»¥æ“´å±•æ”¯æ´æ›´è¤‡é›œçš„æŸ¥è©¢
                        return true;
                    });
                }
            };

            // --- 3.3 IndexedDB (IDB) è¼”åŠ©å‡½å¼ ---

            function initDB() {
                return new Promise((resolve, reject) => {
                    if (!window.indexedDB) {
                        state.dbMode = 'ls';
                        console.warn('IndexedDB not supported. Falling back to localStorage. Attachments will be disabled.');
                        dom.dbStatusMessage.textContent = 'è­¦å‘Šï¼šç€è¦½å™¨ä¸æ”¯æ´ IndexedDBï¼Œé™„ä»¶åŠŸèƒ½å·²åœç”¨ã€‚è³‡æ–™å°‡å„²å­˜æ–¼ localStorageã€‚';
                        dom.idbOnlyElements.forEach(el => el.style.display = 'none');
                        resolve();
                        return;
                    }

                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onupgradeneeded = (event) => {
                        state.db = event.target.result;
                        if (!state.db.objectStoreNames.contains(STORES.ITEMS)) {
                            state.db.createObjectStore(STORES.ITEMS, { keyPath: 'id' });
                        }
                        if (!state.db.objectStoreNames.contains(STORES.VERSIONS)) {
                            // ä½¿ç”¨ autoIncrement ä½œç‚º keyï¼Œä¸¦å»ºç«‹ itemId ç´¢å¼• (é›–ç„¶æˆ‘å€‘ç¨å¾Œæ‰‹å‹•éæ¿¾)
                            const versionStore = state.db.createObjectStore(STORES.VERSIONS, { autoIncrement: true });
                            versionStore.createIndex('itemIdIndex', 'itemId', { unique: false });
                        }
                        if (!state.db.objectStoreNames.contains(STORES.ATTACHMENTS)) {
                            state.db.createObjectStore(STORES.ATTACHMENTS, { keyPath: 'id' });
                        }
                        if (!state.db.objectStoreNames.contains(STORES.TRASH)) {
                            state.db.createObjectStore(STORES.TRASH, { keyPath: 'id' });
                        }
                    };

                    request.onsuccess = (event) => {
                        state.db = event.target.result;
                        state.dbMode = 'idb';
                        console.log('IndexedDB initialized successfully.');
                        dom.dbStatusMessage.textContent = 'è³‡æ–™åº«å·²é€£ç·š (IndexedDB)ã€‚';
                        dom.idbOnlyElements.forEach(el => el.style.display = ''); // é¡¯ç¤ºé™„ä»¶åŠŸèƒ½
                        resolve();
                    };

                    request.onerror = (event) => {
                        state.dbMode = 'ls';
                        console.error('IndexedDB error:', event.target.error);
                        dom.dbStatusMessage.textContent = 'éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥ IndexedDBï¼Œé™ç´šè‡³ localStorageã€‚';
                        dom.idbOnlyElements.forEach(el => el.style.display = 'none');
                        reject(event.target.error);
                    };
                });
            }

            function idbGet(storeName, key) {
                return new Promise((resolve, reject) => {
                    const tx = state.db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            function idbGetAll(storeName) {
                return new Promise((resolve, reject) => {
                    const tx = state.db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            function idbPut(storeName, item) {
                return new Promise((resolve, reject) => {
                    const tx = state.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.put(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                    tx.oncomplete = () => resolve();
                });
            }

            function idbAdd(storeName, item) {
                return new Promise((resolve, reject) => {
                    const tx = state.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.add(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            function idbDelete(storeName, key) {
                return new Promise((resolve, reject) => {
                    const tx = state.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.delete(key);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            function idbClear(storeName) {
                return new Promise((resolve, reject) => {
                    const tx = state.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            // --- 3.2 localStorage (LS) å‚™æ´å‡½å¼ ---

            function lsGetStore(storeName) {
                return JSON.parse(localStorage.getItem(storeName) || '[]');
            }

            function lsSetStore(storeName, data) {
                localStorage.setItem(storeName, JSON.stringify(data));
            }

            function lsGet(storeName, id) {
                const store = lsGetStore(storeName);
                return store.find(item => item.id === id);
            }

            function lsGetAll(storeName) {
                return lsGetStore(storeName);
            }

            function lsPut(storeName, item) {
                let store = lsGetStore(storeName);
                const index = store.findIndex(i => i.id === item.id);
                if (index > -1) {
                    store[index] = item; // æ›´æ–°
                } else {
                    store.push(item); // æ–°å¢
                }
                lsSetStore(storeName, store);
            }

            function lsAdd(storeName, item) {
                let store = lsGetStore(storeName);
                store.push(item);
                lsSetStore(storeName, store);
            }

            function lsDelete(storeName, id) {
                let store = lsGetStore(storeName);
                store = store.filter(item => item.id !== id);
                lsSetStore(storeName, store);
            }

            function lsClear(storeName) {
                lsSetStore(storeName, []);
            }


            // --- 4. UI é‚è¼¯å±¤ (UI Logic) ---

            /**
             * æ¸²æŸ“é …ç›®åˆ—è¡¨
             */
            async function renderItemList() {
                // å¦‚æœé€²éšæœå°‹é¢æ¿é–‹å•Ÿï¼Œä½¿ç”¨é€²éšæœå°‹
                if (dom.searchPanel && dom.searchPanel.classList.contains('is-open')) {
                    await handleAdvancedSearch();
                    return;
                }

                // å¦å‰‡ä½¿ç”¨ç°¡å–®æœå°‹
                const query = dom.searchInput.value.trim();

                if (query) {
                    // ä½¿ç”¨æœå°‹å¼•æ“
                    const results = await searchEngine.search(query, {
                        searchTitle: true,
                        searchContent: true,
                        searchTags: true,
                        sortBy: 'relevance'
                    });
                    await renderSearchResults(results, query);
                    updateSearchStats(results, query);
                } else {
                    // é¡¯ç¤ºæ‰€æœ‰é …ç›®
                    const items = await dataService.getAllItems();
                    items.sort((a, b) => b.updatedAt - a.updatedAt);

                    const results = items.map(item => ({ item, score: 0, highlights: {} }));
                    await renderSearchResults(results, '');
                    if (dom.searchStats) dom.searchStats.style.display = 'none';
                }
            }

            /**
             * å»ºç«‹å–®ä¸€é …ç›®å¡ç‰‡ (Item Card)
             */
            function createItemCard(item) {
                const card = document.createElement('article');
                card.className = 'item-card reveal-on-scroll';
                card.dataset.itemId = item.id;
                card.setAttribute('role', 'listitem');
                card.setAttribute('tabindex', '0'); // å¯ç”¨éµç›¤å°ç„¦

                // æ¨™ç±¤
                const tagsHTML = (item.tags || [])
                    .map(tag => `<span class="tag">${escapeHtml(tag)}</span>`)
                    .join('');

                card.innerHTML = `
                    <div class="item-tags">${tagsHTML}</div>
                    <h3>${escapeHtml(item.title)}</h3>
                    <div class="item-card-content">
                        ${escapeHtml(item.content.substring(0, 100)) + (item.content.length > 100 ? '...' : '')}
                    </div>
                    <div class="item-card-meta">
                        æ›´æ–°æ–¼: ${formatDate(item.updatedAt)}
                    </div>
                `;

                // ç›£è½é»æ“Šå’Œéµç›¤ Enter
                card.addEventListener('click', () => handleOpenItem(item.id));
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        handleOpenItem(item.id);
                    }
                });

                return card;
            }

            /**
             * é–‹å•Ÿç·¨è¼¯å™¨
             */
            async function openEditor(item) {
                if (item) {
                    // ç·¨è¼¯ç¾æœ‰é …ç›®
                    state.currentItemId = item.id;
                    dom.editorTitle.textContent = 'ç·¨è¼¯ç­†è¨˜';
                    dom.editorItemId.value = item.id;
                    dom.editorTitleInput.value = item.title;
                    dom.editorContentInput.value = item.content;
                    dom.editorTagsInput.value = (item.tags || []).join(', ');
                    dom.btnEditorDelete.style.display = 'block';
                    dom.btnEditorPrint.style.display = 'block';

                    // è¼‰å…¥ç‰ˆæœ¬å’Œé™„ä»¶
                    await renderVersions(item.id);
                    if (state.dbMode === 'idb') {
                        await renderAttachments(item.id);
                    }

                } else {
                    // æ–°å¢é …ç›®
                    state.currentItemId = null;
                    dom.editorTitle.textContent = 'æ–°å¢ç­†è¨˜';
                    dom.editorForm.reset(); // æ¸…ç©ºè¡¨å–®
                    dom.editorItemId.value = '';
                    dom.btnEditorDelete.style.display = 'none';
                    dom.btnEditorPrint.style.display = 'none';
                    renderVersions(null); // æ¸…ç©º
                    renderAttachments(null); // æ¸…ç©º
                }

                // é è¨­é¸ä¸­ç¬¬ä¸€å€‹ tab
                switchTab('versions');

                dom.editorDrawer.classList.add('is-open');
                dom.editorTitleInput.focus();
            }

            /**
             * é—œé–‰ç·¨è¼¯å™¨
             */
            function closeEditor() {
                dom.editorDrawer.classList.remove('is-open');
                state.currentItemId = null;
                dom.editorForm.reset();
            }

            /**
             * æ¸²æŸ“ç‰ˆæœ¬æ­·å²
             */
            async function renderVersions(itemId) {
                if (!itemId) {
                    dom.versionListContainer.innerHTML = '';
                    dom.versionEmptyMessage.style.display = 'block';
                    return;
                }

                const versions = await dataService.getVersionsByItemId(itemId);

                if (versions.length === 0) {
                    dom.versionListContainer.innerHTML = '';
                    dom.versionEmptyMessage.style.display = 'block';
                    return;
                }

                dom.versionEmptyMessage.style.display = 'none';
                dom.versionListContainer.innerHTML = versions.map(v => `
                    <div class="version-item">
                        <div class="version-item-info">
                            <strong>${formatDate(v.createdAtTS)}</strong>
                            <span class="reason">${v.reason ? escapeHTML(v.reason) : ''}</span>
                        </div>
                        <div class="button-group">
                            <button class="button" data-version-id="${v.versionId}" data-action="preview">é è¦½</button>
                            <button class="button accent" data-version-id="${v.versionId}" data-action="revert">é‚„åŸ</button>
                        </div>
                    </div>
                `).join('');
            }

            /**
             * æ¸²æŸ“é™„ä»¶åˆ—è¡¨ (IDB only)
             */
            async function renderAttachments(itemId) {
                if (state.dbMode !== 'idb' || !itemId) {
                    dom.attachmentListContainer.innerHTML = '';
                    return;
                }

                const attachments = await dataService.getAttachmentsByItemId(itemId);
                dom.attachmentListContainer.innerHTML = attachments.map(a => `
                    <div class="attachment-item">
                        <span title="${escapeHTML(a.name)}">${escapeHTML(a.name)}</span>
                        <button data-att-id="${a.id}" data-action="download" title="ä¸‹è¼‰">â¬‡ï¸</button>
                        <button data-att-id="${a.id}" data-action="delete" title="åˆªé™¤">âŒ</button>
                    </div>
                `).join('');
            }

            /**
             * æ¸²æŸ“å›æ”¶æ¡¶
             */
            async function renderTrashList() {
                const items = await dataService.getTrashItems();
                items.sort((a, b) => b.deletedAt - a.deletedAt); // æœ€æ–°çš„åœ¨å‰é¢

                if (items.length === 0) {
                    dom.trashListContainer.innerHTML = '';
                    dom.trashEmptyMessage.style.display = 'block';
                    return;
                }

                dom.trashEmptyMessage.style.display = 'none';
                dom.trashListContainer.innerHTML = items.map(item => `
                    <div class="trash-item">
                        <div class="trash-item-info">
                            <strong>${escapeHTML(item.title)}</strong>
                            <br>
                            <small>åˆªé™¤æ–¼: ${formatDate(item.deletedAt)}</small>
                        </div>
                        <div class="button-group">
                            <button class="button" data-trash-id="${item.id}" data-action="restore">é‚„åŸ</button>
                            <button class="button danger" data-trash-id="${item.id}" data-action="purge">æ°¸ä¹…åˆªé™¤</button>
                        </div>
                    </div>
                `).join('');
            }

            /**
             * é¡¯ç¤º Modal
             */
            function showModal(modalElement) {
                if (state.currentModal) {
                    closeModal(state.currentModal);
                }
                modalElement.classList.add('is-open');
                state.currentModal = modalElement;
            }

            /**
             * é—œé–‰ Modal
             */
            function closeModal(modalElement) {
                if (!modalElement) modalElement = state.currentModal;
                if (modalElement) {
                    modalElement.classList.remove('is-open');
                    if (state.currentModal === modalElement) {
                        state.currentModal = null;
                    }
                }
            }

            /**
             * é¡¯ç¤ºç¢ºèªè¦–çª—
             */
            function showConfirm(title, message, onConfirm) {
                dom.confirmModalTitle.textContent = title;
                dom.confirmModalMessage.textContent = message;
                state.confirmCallback = onConfirm;
                showModal(dom.confirmModal);
            }

            /**
             * é¡¯ç¤ºæç¤ºè¨Šæ¯ (Toast)
             */
            function showToast(message, type = 'info', duration = 3000) {
                const toast = dom.toastContainer;
                toast.textContent = message;
                toast.className = `toast-notification ${type}`; // ç§»é™¤èˆŠçš„ show

                // å¼·åˆ¶é‡ç¹ªä»¥è§¸ç™¼ transition
                void toast.offsetWidth;

                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }

            /**
             * åˆ‡æ›ç·¨è¼¯å™¨ä¸­çš„ Tab
             */
            function switchTab(tabName) {
                dom.tabContents.forEach(tab => {
                    tab.classList.toggle('active', tab.id === `tab-${tabName}`);
                });
                dom.detailTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabName);
                });
            }

            // --- 5. äº‹ä»¶è™•ç† (Event Handlers) ---

            /**
             * åˆå§‹åŒ–äº‹ä»¶ç›£è½
             */
            function bindEventListeners() {
                // æ»¾å‹•æ•ˆæœ
                window.addEventListener('scroll', handleScrollEffects);

                // æ§åˆ¶é …
                dom.btnNewItem.addEventListener('click', handleNewItem);
                dom.searchInput.addEventListener('input', debounce(handleAdvancedSearch, 300));
                dom.btnAdvancedSearch.addEventListener('click', toggleAdvancedSearch);

                // é€²éšæœå°‹
                dom.searchTitle.addEventListener('change', handleAdvancedSearch);
                dom.searchContent.addEventListener('change', handleAdvancedSearch);
                dom.searchTags.addEventListener('change', handleAdvancedSearch);
                dom.searchCaseSensitive.addEventListener('change', handleAdvancedSearch);
                dom.searchTagsFilter.addEventListener('input', debounce(handleTagFilter, 200));
                dom.searchSort.addEventListener('change', handleAdvancedSearch);
                dom.tagCloud.addEventListener('click', handleTagCloudClick);

                // æ™ºæ…§è³‡æ–™å¤¾
                dom.btnSmartFolders.addEventListener('click', toggleSmartFolders);
                dom.btnCloseSmartFolders.addEventListener('click', () => toggleSmartFolders(false));
                dom.btnNewSmartFolder.addEventListener('click', handleNewSmartFolder);
                dom.smartFoldersList.addEventListener('click', handleSmartFolderAction);

                // ç·¨è¼¯å™¨
                dom.btnEditorClose.addEventListener('click', closeEditor);
                dom.editorForm.addEventListener('submit', handleSaveItem);
                dom.btnEditorDelete.addEventListener('click', handleDeleteItem);
                dom.btnEditorPrint.addEventListener('click', handlePrintItem);

                // è©³æƒ…é¢æ¿ Tabs
                dom.detailTabs.forEach(tab => {
                    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
                });

                // ç‰ˆæœ¬æ­·å²æŒ‰éˆ• (äº‹ä»¶å§”æ´¾)
                dom.versionListContainer.addEventListener('click', handleVersionAction);

                // é™„ä»¶ (äº‹ä»¶å§”æ´¾)
                dom.attachmentListContainer.addEventListener('click', handleAttachmentAction);
                dom.attachmentDropZone.addEventListener('click', () => dom.attachmentFileInput.click());
                dom.attachmentFileInput.addEventListener('change', handleAttachmentFileSelect);

                // æ‹–æ”¾
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dom.attachmentDropZone.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false); // å…¨å±€é˜²æ­¢æ„å¤–æ‹–æ”¾
                });
                ['dragenter', 'dragover'].forEach(eventName => {
                    dom.attachmentDropZone.addEventListener(eventName, () => dom.attachmentDropZone.classList.add('is-dragging'), false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    dom.attachmentDropZone.addEventListener(eventName, () => dom.attachmentDropZone.classList.remove('is-dragging'), false);
                });
                dom.attachmentDropZone.addEventListener('drop', handleAttachmentDrop, false);

                // Modals (é—œé–‰)
                $$('[data-modal-close]').forEach(btn => {
                    btn.addEventListener('click', () => closeModal($(btn.dataset.modalClose)));
                });

                // å›æ”¶æ¡¶
                dom.btnTrash.addEventListener('click', handleOpenTrash);
                dom.trashListContainer.addEventListener('click', handleTrashAction);
                dom.btnEmptyTrash.addEventListener('click', handleEmptyTrash);

                // åŒ¯å…¥/åŒ¯å‡º
                dom.btnIO.addEventListener('click', () => showModal(dom.ioModal));
                dom.btnExport.addEventListener('click', handleExportData);
                dom.importFileInput.addEventListener('change', () => {
                    dom.btnImport.disabled = !dom.importFileInput.files.length;
                });
                dom.btnImport.addEventListener('click', handleImportData);

                // ç¢ºèªè¦–çª—
                dom.btnConfirmCancel.addEventListener('click', () => {
                    closeModal(dom.confirmModal);
                    state.confirmCallback = null;
                });
                dom.btnConfirmAction.addEventListener('click', () => {
                    if (typeof state.confirmCallback === 'function') {
                        state.confirmCallback();
                    }
                    closeModal(dom.confirmModal);
                    state.confirmCallback = null;
                });
            }

            /**
             * è™•ç†ï¼šé–‹å•Ÿé …ç›®
             */
            async function handleOpenItem(id) {
                const item = await dataService.getItem(id);
                if (item) {
                    openEditor(item);
                }
            }

            /**
             * è™•ç†ï¼šæ–°å¢é …ç›®
             */
            function handleNewItem() {
                openEditor(null);
            }

            /**
             * è™•ç†ï¼šå„²å­˜é …ç›® (æ–°å¢æˆ–æ›´æ–°)
             */
            async function handleSaveItem(event) {
                event.preventDefault();

                const id = dom.editorItemId.value || crypto.randomUUID();
                const now = Date.now();

                const oldItem = state.currentItemId ? await dataService.getItem(state.currentItemId) : null;

                const item = {
                    id: id,
                    title: dom.editorTitleInput.value.trim(),
                    content: dom.editorContentInput.value,
                    tags: dom.editorTagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
                    createdAt: oldItem ? oldItem.createdAt : now,
                    updatedAt: now
                };

                if (!item.title) {
                    showToast('æ¨™é¡Œç‚ºå¿…å¡«é …', 'error');
                    return;
                }

                // å„²å­˜ç‰ˆæœ¬
                if (oldItem) {
                    // åªæœ‰åœ¨å…§å®¹æˆ–æ¨™é¡Œè®Šæ›´æ™‚æ‰å„²å­˜ç‰ˆæœ¬
                    if (oldItem.title !== item.title || oldItem.content !== item.content) {
                        const version = {
                            itemId: oldItem.id,
                            title: oldItem.title,
                            content: oldItem.content,
                            tags: oldItem.tags,
                            createdAtTS: oldItem.updatedAt,
                            reason: 'ç·¨è¼¯å„²å­˜'
                        };
                        await dataService.saveVersion(version);
                    }
                } else {
                    // å»ºç«‹æ–°é …ç›®æ™‚ä¹Ÿå»ºç«‹ä¸€å€‹ "åˆå§‹ç‰ˆæœ¬"
                    const version = {
                        itemId: item.id,
                        title: item.title,
                        content: item.content,
                        tags: item.tags,
                        createdAtTS: item.createdAt,
                        reason: 'å»ºç«‹æ–°é …ç›®'
                    };
                    await dataService.saveVersion(version);
                }

                await dataService.saveItem(item);

                showToast('å„²å­˜æˆåŠŸ', 'success');
                closeEditor();
                await renderItemList();
            }

            /**
             * è™•ç†ï¼šåˆªé™¤é …ç›® (è»Ÿåˆªé™¤)
             */
            function handleDeleteItem() {
                const id = state.currentItemId;
                if (!id) return;

                showConfirm('åˆªé™¤ç­†è¨˜', 'æ‚¨ç¢ºå®šè¦å°‡æ­¤ç­†è¨˜ç§»è‡³å›æ”¶æ¡¶å—ï¼Ÿ', async () => {
                    const item = await dataService.getItem(id);
                    if (item) {
                        await dataService.trashItem(item);
                        showToast('å·²ç§»è‡³å›æ”¶æ¡¶', 'success');
                        closeEditor();
                        await renderItemList();
                    }
                });
            }

            /**
             * è™•ç†ï¼šåˆ—å°é …ç›®
             */
            function handlePrintItem() {
                document.body.classList.add('printing-item');
                document.body.classList.remove('printing-list');
                window.print();
                // åˆ—å°å¾Œæ¸…é™¤ class
                setTimeout(() => {
                    document.body.classList.remove('printing-item');
                }, 1000);
            }

            /**
             * è™•ç†ï¼šæœå°‹
             */
            function handleSearch() {
                // ä½¿ç”¨ debounce é¿å…éåº¦é »ç¹
                debounce(renderItemList, 300)();
            }

            /**
             * è™•ç†ï¼šé€²éšæœå°‹
             */
            async function handleAdvancedSearch() {
                const query = dom.searchInput.value.trim();
                const options = {
                    searchTitle: dom.searchTitle.checked,
                    searchContent: dom.searchContent.checked,
                    searchTags: dom.searchTags.checked,
                    caseSensitive: dom.searchCaseSensitive.checked,
                    sortBy: dom.searchSort.value,
                    tagFilter: dom.searchTagsFilter.value.trim() || null
                };

                try {
                    const results = await searchEngine.search(query, options);
                    await renderSearchResults(results, query);
                    updateSearchStats(results, query);
                } catch (error) {
                    console.error('æœå°‹éŒ¯èª¤:', error);
                    showToast('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            }

            /**
             * åˆ‡æ›é€²éšæœå°‹é¢æ¿
             */
            function toggleAdvancedSearch() {
                const isOpen = dom.searchPanel.classList.contains('is-open');
                dom.searchPanel.classList.toggle('is-open', !isOpen);

                if (!isOpen) {
                    // è¼‰å…¥æ¨™ç±¤é›²
                    loadTagCloud();
                }
            }

            /**
             * è¼‰å…¥æ¨™ç±¤é›²
             */
            async function loadTagCloud() {
                try {
                    const tags = await searchEngine.getAllTags();
                    dom.tagCloud.innerHTML = tags.slice(0, 20).map(({ tag, count }) =>
                        `<span class="tag" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)} (${count})</span>`
                    ).join('');
                } catch (error) {
                    console.error('è¼‰å…¥æ¨™ç±¤é›²éŒ¯èª¤:', error);
                }
            }

            /**
             * è™•ç†æ¨™ç±¤é›²é»æ“Š
             */
            function handleTagCloudClick(event) {
                if (event.target.classList.contains('tag')) {
                    const tag = event.target.dataset.tag;
                    event.target.classList.toggle('selected');

                    // æ›´æ–°æ¨™ç±¤éæ¿¾å™¨
                    const selected = Array.from(dom.tagCloud.querySelectorAll('.tag.selected'))
                        .map(el => el.dataset.tag);
                    dom.searchTagsFilter.value = selected.join(', ');

                    handleAdvancedSearch();
                }
            }

            /**
             * è™•ç†æ¨™ç±¤éæ¿¾
             */
            function handleTagFilter() {
                handleAdvancedSearch();
            }

            /**
             * æ¸²æŸ“æœå°‹çµæœ
             */
            async function renderSearchResults(results, query) {
                if (results.length === 0) {
                    dom.itemListContainer.innerHTML = '';
                    dom.emptyListMessage.style.display = 'block';
                    dom.emptyListMessage.textContent = query ?
                        `æ‰¾ä¸åˆ°ç¬¦åˆã€Œ${query}ã€çš„ç­†è¨˜` : 'å°šæœªå»ºç«‹ä»»ä½•ç­†è¨˜ã€‚é»æ“Šã€Œæ–°å¢ç­†è¨˜ã€é–‹å§‹ã€‚';
                    return;
                }

                dom.emptyListMessage.style.display = 'none';

                const itemsHTML = results.map(({ item, highlights }) => {
                    const title = highlightText(item.title || 'ç„¡æ¨™é¡Œ', highlights.title, query);
                    const content = highlightText(
                        (item.content || '').substring(0, 150) + (item.content?.length > 150 ? '...' : ''),
                        highlights.content,
                        query
                    );
                    const tags = (item.tags || []).map(tag =>
                        `<span class="tag">${highlightText(tag, highlights.tags, query)}</span>`
                    ).join('');

                    return `
                        <article class="item-card reveal-on-scroll" data-item-id="${item.id}" tabindex="0" role="article">
                            <h3>${title}</h3>
                            <div class="item-card-content">${content}</div>
                            ${tags ? `<div class="item-tags">${tags}</div>` : ''}
                            <div class="item-card-meta">
                                å»ºç«‹ï¼š${formatDate(item.createdAt)} | æ›´æ–°ï¼š${formatDate(item.updatedAt)}
                            </div>
                        </article>
                    `;
                }).join('');

                dom.itemListContainer.innerHTML = itemsHTML;

                // é‡æ–°ç¶å®šäº‹ä»¶
                dom.itemListContainer.querySelectorAll('.item-card').forEach(card => {
                    const itemId = card.dataset.itemId;
                    card.addEventListener('click', () => handleOpenItem(itemId));
                    card.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            handleOpenItem(itemId);
                        }
                    });
                });

                // è§¸ç™¼æ»¾å‹•å‹•ç•«
                setTimeout(() => {
                    dom.itemListContainer.querySelectorAll('.reveal-on-scroll').forEach(el => {
                        el.classList.add('is-visible');
                    });
                }, 50);
            }

            /**
             * é«˜äº®æ–‡å­—
             */
            function highlightText(text, highlights = [], query = '') {
                if (!query || !text) return escapeHtml(text);

                let result = escapeHtml(text);
                const tokens = searchEngine.tokenize(query);

                tokens.forEach(token => {
                    const regex = new RegExp(`(${searchEngine._escapeRegex(token)})`, 'gi');
                    result = result.replace(regex, '<span class="search-highlight">$1</span>');
                });

                return result;
            }

            /**
             * æ›´æ–°æœå°‹çµ±è¨ˆ
             */
            function updateSearchStats(results, query) {
                if (!query) {
                    dom.searchStats.style.display = 'none';
                    return;
                }

                const count = results.length;
                const time = performance.now();
                dom.searchStats.innerHTML = `æ‰¾åˆ° ${count} å€‹çµæœ`;
                dom.searchStats.style.display = 'block';
            }

            /**
             * åˆ‡æ›æ™ºæ…§è³‡æ–™å¤¾å´é‚Šæ¬„
             */
            function toggleSmartFolders(show = null) {
                const isOpen = show !== null ? show : !dom.smartFoldersSidebar.classList.contains('is-open');

                dom.smartFoldersSidebar.classList.toggle('is-open', isOpen);
                dom.mainContent.classList.toggle('with-sidebar', isOpen);

                if (isOpen) {
                    renderSmartFolders();
                }
            }

            /**
             * æ¸²æŸ“æ™ºæ…§è³‡æ–™å¤¾
             */
            async function renderSmartFolders() {
                try {
                    const folders = await smartFolders.getAll();
                    const foldersHTML = await Promise.all(folders.map(async folder => {
                        const items = await smartFolders.filterItems(folder.conditions);
                        const count = items.length;

                        return `
                            <div class="smart-folder-item" data-folder-id="${folder.id}">
                                <div>
                                    <div class="smart-folder-name">${folder.icon || 'ğŸ“'} ${escapeHtml(folder.name)}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span class="smart-folder-count">${count}</span>
                                    ${!folder.builtin ? `
                                        <div class="smart-folder-actions">
                                            <button data-action="edit" title="ç·¨è¼¯">âœï¸</button>
                                            <button data-action="delete" title="åˆªé™¤">ğŸ—‘ï¸</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }));

                    dom.smartFoldersList.innerHTML = foldersHTML.join('');
                } catch (error) {
                    console.error('æ¸²æŸ“æ™ºæ…§è³‡æ–™å¤¾éŒ¯èª¤:', error);
                }
            }

            /**
             * è™•ç†æ™ºæ…§è³‡æ–™å¤¾æ“ä½œ
             */
            async function handleSmartFolderAction(event) {
                const folderItem = event.target.closest('.smart-folder-item');
                if (!folderItem) return;

                const folderId = folderItem.dataset.folderId;
                const action = event.target.dataset.action;

                if (action === 'edit') {
                    handleEditSmartFolder(folderId);
                } else if (action === 'delete') {
                    handleDeleteSmartFolder(folderId);
                } else {
                    // é»æ“Šè³‡æ–™å¤¾æœ¬èº« - é¡¯ç¤ºå…§å®¹
                    handleOpenSmartFolder(folderId);
                }
            }

            /**
             * é–‹å•Ÿæ™ºæ…§è³‡æ–™å¤¾
             */
            async function handleOpenSmartFolder(folderId) {
                try {
                    const folders = await smartFolders.getAll();
                    const folder = folders.find(f => f.id === folderId);
                    if (!folder) return;

                    const items = await smartFolders.filterItems(folder.conditions);

                    // æ›´æ–° UI ç‹€æ…‹
                    dom.smartFoldersList.querySelectorAll('.smart-folder-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    dom.smartFoldersList.querySelector(`[data-folder-id="${folderId}"]`).classList.add('active');

                    // æ¸²æŸ“çµæœ
                    const results = items.map(item => ({ item, score: 0, highlights: {} }));
                    await renderSearchResults(results, '');

                    // æ›´æ–°æœå°‹çµ±è¨ˆ
                    dom.searchStats.innerHTML = `${folder.name}ï¼š${items.length} å€‹é …ç›®`;
                    dom.searchStats.style.display = 'block';

                } catch (error) {
                    console.error('é–‹å•Ÿæ™ºæ…§è³‡æ–™å¤¾éŒ¯èª¤:', error);
                    showToast('é–‹å•Ÿè³‡æ–™å¤¾æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            }

            /**
             * æ–°å¢æ™ºæ…§è³‡æ–™å¤¾
             */
            function handleNewSmartFolder() {
                const name = prompt('è«‹è¼¸å…¥è³‡æ–™å¤¾åç¨±ï¼š');
                if (!name) return;

                const keyword = prompt('è«‹è¼¸å…¥é—œéµå­—ï¼ˆå¯é¸ï¼‰ï¼š');

                const folder = {
                    name: name.trim(),
                    icon: 'ğŸ“',
                    conditions: keyword ?
                        { type: 'keyword', value: keyword.trim() } :
                        { type: 'recent', days: 30 },
                    builtin: false
                };

                smartFolders.save(folder).then(() => {
                    renderSmartFolders();
                    showToast('æ™ºæ…§è³‡æ–™å¤¾å·²å»ºç«‹', 'success');
                }).catch(error => {
                    console.error('å»ºç«‹æ™ºæ…§è³‡æ–™å¤¾éŒ¯èª¤:', error);
                    showToast('å»ºç«‹è³‡æ–™å¤¾æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                });
            }

            /**
             * ç·¨è¼¯æ™ºæ…§è³‡æ–™å¤¾
             */
            function handleEditSmartFolder(folderId) {
                // ç°¡åŒ–ç‰ˆç·¨è¼¯ - åƒ…æ”¯æ´é‡å‘½å
                const newName = prompt('è«‹è¼¸å…¥æ–°åç¨±ï¼š');
                if (!newName) return;

                smartFolders.getAll().then(folders => {
                    const folder = folders.find(f => f.id === folderId);
                    if (folder && !folder.builtin) {
                        folder.name = newName.trim();
                        return smartFolders.save(folder);
                    }
                }).then(() => {
                    renderSmartFolders();
                    showToast('è³‡æ–™å¤¾å·²æ›´æ–°', 'success');
                }).catch(error => {
                    console.error('ç·¨è¼¯æ™ºæ…§è³‡æ–™å¤¾éŒ¯èª¤:', error);
                    showToast('ç·¨è¼¯è³‡æ–™å¤¾æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                });
            }

            /**
             * åˆªé™¤æ™ºæ…§è³‡æ–™å¤¾
             */
            function handleDeleteSmartFolder(folderId) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ™ºæ…§è³‡æ–™å¤¾å—ï¼Ÿ')) return;

                smartFolders.delete(folderId).then(() => {
                    renderSmartFolders();
                    showToast('è³‡æ–™å¤¾å·²åˆªé™¤', 'success');
                }).catch(error => {
                    console.error('åˆªé™¤æ™ºæ…§è³‡æ–™å¤¾éŒ¯èª¤:', error);
                    showToast('åˆªé™¤è³‡æ–™å¤¾æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                });
            }

            /**
             * è™•ç†ï¼šæ»¾å‹• (Header æ¼¸è®Š / é …ç›®æ·¡å…¥)
             */
            function handleScrollEffects() {
                // Header
                if (window.scrollY > 48) { // 48px (Speckit)
                    dom.header.classList.add('is-scrolled');
                } else {
                    dom.header.classList.remove('is-scrolled');
                }

                // æ»¾å‹•æ·¡å…¥
                const items = $$('.reveal-on-scroll:not(.is-visible)');
                items.forEach(item => {
                    if (isElementInViewport(item)) {
                        item.classList.add('is-visible');
                    }
                });
            }

            /**
             * è™•ç†ï¼šç‰ˆæœ¬å‹•ä½œ (é‚„åŸ/é è¦½)
             */
            async function handleVersionAction(event) {
                const button = event.target.closest('button');
                if (!button) return;

                const action = button.dataset.action;
                const versionId = button.dataset.versionId;

                // å¾ IDB/LS æ‰¾å‡ºè©²ç‰ˆæœ¬
                const allVersions = await dataService.getVersionsByItemId(state.currentItemId);
                const version = allVersions.find(v => v.versionId.toString() === versionId);

                if (!version) return;

                if (action === 'revert') {
                    showConfirm('é‚„åŸç‰ˆæœ¬', `æ‚¨ç¢ºå®šè¦é‚„åŸåˆ° ${formatDate(version.createdAtTS)} çš„ç‰ˆæœ¬å—ï¼Ÿç›®å‰å…§å®¹å°‡è¢«å­˜ç‚ºä¸€å€‹æ–°ç‰ˆæœ¬ã€‚`, async () => {
                        // 1. å…ˆå°‡ç›®å‰ç·¨è¼¯å™¨ä¸­çš„å…§å®¹å­˜ç‚ºä¸€å€‹æ–°ç‰ˆæœ¬
                        const currentVersion = {
                            itemId: state.currentItemId,
                            title: dom.editorTitleInput.value,
                            content: dom.editorContentInput.value,
                            tags: dom.editorTagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
                            createdAtTS: Date.now(),
                            reason: 'é‚„åŸå‰è‡ªå‹•å„²å­˜'
                        };
                        await dataService.saveVersion(currentVersion);

                        // 2. å°‡ç·¨è¼¯å™¨å…§å®¹æ›¿æ›ç‚ºèˆŠç‰ˆæœ¬
                        dom.editorTitleInput.value = version.title;
                        dom.editorContentInput.value = version.content;
                        dom.editorTagsInput.value = (version.tags || []).join(', ');

                        // 3. é‡æ–°æ¸²æŸ“ç‰ˆæœ¬åˆ—è¡¨ (å› ç‚ºå¤šäº†ä¸€å€‹)
                        await renderVersions(state.currentItemId);
                        showToast('å·²é‚„åŸç‰ˆæœ¬', 'success');
                    });
                }

                if (action === 'preview') {
                    // TODO: å¯¦ä½œä¸€å€‹é è¦½ Modal
                    alert(`é è¦½ç‰ˆæœ¬ ${formatDate(version.createdAtTS)}:\næ¨™é¡Œ: ${version.title}\nå…§å®¹: ${version.content.substring(0, 50)}...`);
                }
            }

            /**
             * è™•ç†ï¼šé™„ä»¶å‹•ä½œ (ä¸‹è¼‰/åˆªé™¤)
             */
            async function handleAttachmentAction(event) {
                if (state.dbMode !== 'idb') return;

                const button = event.target.closest('button');
                if (!button) return;

                const id = button.dataset.attId;
                const action = button.dataset.action;

                if (action === 'download') {
                    const blob = await dataService.getAttachmentBlob(id);
                    if (blob) {
                        const att = await dataService.getAttachmentBlob(id); // æŠ±æ­‰ï¼Œéœ€è¦ att çš„ name
                        const attInfo = await dataService.getItem(id); // é‡æ–°ç²å–è³‡è¨Š

                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = attInfo ? attInfo.name : 'download';
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                }

                if (action === 'delete') {
                    showConfirm('åˆªé™¤é™„ä»¶', 'æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤é™„ä»¶å—ï¼Ÿ', async () => {
                        await dataService.deleteAttachment(id);
                        await renderAttachments(state.currentItemId);
                        showToast('é™„ä»¶å·²åˆªé™¤', 'success');
                    });
                }
            }

            /**
             * è™•ç†ï¼šé™„ä»¶æ‹–æ”¾
             */
            async function handleAttachmentDrop(event) {
                event.preventDefault();
                if (state.dbMode !== 'idb' || !state.currentItemId) return;

                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    for (const file of files) {
                        await dataService.saveAttachment(file, state.currentItemId);
                    }
                    await renderAttachments(state.currentItemId);
                    showToast(`å·²ä¸Šå‚³ ${files.length} å€‹é™„ä»¶`, 'success');
                }
            }

            /**
             * è™•ç†ï¼šé™„ä»¶é¸æ“‡
             */
            async function handleAttachmentFileSelect(event) {
                if (state.dbMode !== 'idb' || !state.currentItemId) return;

                const files = event.target.files;
                if (files.length > 0) {
                    for (const file of files) {
                        await dataService.saveAttachment(file, state.currentItemId);
                    }
                    await renderAttachments(state.currentItemId);
                    showToast(`å·²ä¸Šå‚³ ${files.length} å€‹é™„ä»¶`, 'success');
                }
            }

            /**
             * è™•ç†ï¼šé–‹å•Ÿå›æ”¶æ¡¶
             */
            async function handleOpenTrash() {
                await renderTrashList();
                showModal(dom.trashModal);
            }

            /**
             * è™•ç†ï¼šå›æ”¶æ¡¶å‹•ä½œ (é‚„åŸ/æ°¸ä¹…åˆªé™¤)
             */
            async function handleTrashAction(event) {
                const button = event.target.closest('button');
                if (!button) return;

                const id = button.dataset.trashId;
                const action = button.dataset.action;

                if (action === 'restore') {
                    await dataService.restoreTrashItem(id);
                    showToast('é …ç›®å·²é‚„åŸ', 'success');
                    await renderTrashList();
                    await renderItemList(); // ä¸»åˆ—è¡¨å¯èƒ½å·²è®Šæ›´
                }

                if (action === 'purge') {
                    showConfirm('æ°¸ä¹…åˆªé™¤', 'æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤é …ç›®åŠå…¶æ‰€æœ‰ç›¸é—œè³‡æ–™å—ï¼Ÿ', async () => {
                        await dataService.purgeTrashItem(id);
                        showToast('é …ç›®å·²æ°¸ä¹…åˆªé™¤', 'success');
                        await renderTrashList();
                    });
                }
            }

            /**
             * è™•ç†ï¼šæ¸…ç©ºå›æ”¶æ¡¶
             */
            function handleEmptyTrash() {
                showConfirm('æ¸…ç©ºå›æ”¶æ¡¶', 'æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å›æ”¶æ¡¶ä¸­çš„æ‰€æœ‰é …ç›®å—ï¼Ÿ', async () => {
                    await dataService.emptyTrash();
                    showToast('å›æ”¶æ¡¶å·²æ¸…ç©º', 'success');
                    await renderTrashList();
                });
            }

            /**
             * è™•ç†ï¼šåŒ¯å‡ºè³‡æ–™
             */
            async function handleExportData() {
                const includeAttachments = state.dbMode === 'idb' && dom.exportIncludeAttachments.checked;
                try {
                    const data = await dataService.exportData(includeAttachments);
                    const json = JSON.stringify(data, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `archive_export_${formatDate(Date.now(), true)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);

                    showToast('åŒ¯å‡ºæˆåŠŸ', 'success');
                } catch (err) {
                    console.error('Export failed:', err);
                    showToast('åŒ¯å‡ºå¤±æ•—', 'error');
                }
            }

            /**
             * è™•ç†ï¼šåŒ¯å…¥è³‡æ–™
             */
            function handleImportData() {
                const file = dom.importFileInput.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        showConfirm('åŒ¯å…¥è³‡æ–™', 'é€™å°‡æœƒè¦†è“‹æ‚¨ç›®å‰æ‰€æœ‰çš„æœ¬åœ°è³‡æ–™ã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚æ‚¨ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ', async () => {
                            await dataService.importData(data);
                            await renderItemList(); // é‡æ–°æ•´ç†åˆ—è¡¨
                            closeModal(dom.ioModal);
                            showToast('åŒ¯å…¥æˆåŠŸ', 'success');
                        });

                    } catch (err) {
                        console.error('Import failed:', err);
                        showToast('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error');
                    }
                };
                reader.readAsText(file);
            }

            // --- 6. è¼”åŠ©å·¥å…· (Utilities) ---

            /**
             * Debounce (é˜²æŠ–)
             */
            let debounceTimer;
            function debounce(func, delay) {
                return function () {
                    const context = this;
                    const args = arguments;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(context, args), delay);
                };
            }

            /**
             * æª¢æŸ¥å…ƒç´ æ˜¯å¦åœ¨å¯è¦–ç¯„åœå…§
             */
            function isElementInViewport(el) {
                const rect = el.getBoundingClientRect();
                return (
                    rect.top >= 0 &&
                    rect.left >= 0 &&
                    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
                );
            }

            /**
             * è½‰ç¾© HTML ç‰¹æ®Šå­—ç¬¦
             */
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * æ ¼å¼åŒ–æ—¥æœŸ
             */
            function formatDate(timestamp, fileSafe = false) {
                const date = new Date(timestamp);
                if (fileSafe) {
                    return date.toISOString().replace(/[:.]/g, '-');
                }
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            /**
             * é˜²æ­¢é è¨­è¡Œç‚º (ç”¨æ–¼æ‹–æ”¾)
             */
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            /**
             * HTML è½‰ç¾©
             */
            function escapeHTML(str) {
                return String(str).replace(/[&<>"']/g, function (match) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[match];
                });
            }

            /**
             * Blob è½‰ Base64 (ç”¨æ–¼åŒ¯å‡º)
             */
            function blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]); // åªå– data
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            /**
             * Base64 è½‰ Blob (ç”¨æ–¼åŒ¯å…¥)
             */
            function base64ToBlob(base64, type) {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: type });
            }

            // --- 7. Hero å‹•ç•« (Speckit) ---

            function initHeroAnimation() {
                const text = dom.heroTitle.textContent.trim();
                dom.heroTitle.innerHTML = text.split('').map(char =>
                    `<span class="char" aria-hidden="true">${char === ' ' ? '&nbsp;' : char}</span>`
                ).join('');

                // ä½¿ç”¨ IntersectionObserver ç¢ºä¿å¯è¦‹æ™‚æ‰æ’­æ”¾
                const observer = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting) {
                        setTimeout(() => {
                            dom.heroTitle.classList.add('is-visible');
                            const chars = dom.heroTitle.querySelectorAll('.char');
                            chars.forEach((char, i) => {
                                // ç¸½ 0.3s -> 30ms * 10 
                                char.style.transitionDelay = `${i * (300 / chars.length)}ms`;
                            });

                            dom.heroSubtitle.classList.add('is-visible');

                        }, 300); // å»¶é² 300ms é–‹å§‹
                        observer.disconnect(); // æ’­æ”¾ä¸€æ¬¡å³å¯
                    }
                }, { threshold: 0.1 });

                observer.observe(dom.heroTitle);
            }

            // --- 8. åˆå§‹åŒ– (Initialization) ---

            async function init() {
                try {
                    await initDB();
                    bindEventListeners();
                    initHeroAnimation();
                    await renderItemList();
                    handleScrollEffects(); // ç«‹å³æª¢æŸ¥ä¸€æ¬¡

                    console.log('Archive App Shell initialized.');

                } catch (err) {
                    console.error('Initialization failed:', err);
                    dom.dbStatusMessage.textContent = 'æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ã€‚è«‹å˜—è©¦é‡æ–°æ•´ç†ã€‚';
                }
            }

            // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
            document.addEventListener('DOMContentLoaded', init);

        })();
    </script>

</body>

</html>