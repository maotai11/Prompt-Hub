<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>交寄大宗限時掛號／掛號函件 二聯單（離線HTML）</title>
<style>
  :root{
    --page-w: 210mm; /* A4 寬 */
    --page-h: 297mm; /* A4 高 */
    --margin: 10mm;
    --border-std: 0.6pt;   /* 一般線寬 */
    --border-bold: 1pt;     /* 粗線寬 */
    --font: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
    --fs: 11pt;
    --fs-small: 9pt;
    --cell-h: 10.5mm; /* 每列大約高度，供微調 */
  }
  html,body{height:100%;}
  body{font-family:var(--font); margin:0; color:#111; background:#f7f7f7;}
  .app{max-width:1100px; margin:24px auto; padding:16px; background:white; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.08);} 
  h1{margin:0 0 8px; font-size:20px;}
  nav{display:flex; gap:8px; margin:12px 0 16px; flex-wrap:wrap}
  nav button{padding:8px 12px; border:1px solid #ddd; background:#fafafa; border-radius:8px; cursor:pointer}
  nav button.active{background:#111; color:#fff; border-color:#111}

  /* 表單輸入區 */
  .panel{display:none}
  .panel.active{display:block}
  .input-grid{display:grid; grid-template-columns: 1fr; gap:12px;}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .row > label{display:flex; flex-direction:column; gap:6px; min-width:220px; flex:1}
  input[type="text"], input[type="date"], textarea{
    padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; width:100%; box-sizing:border-box; background:white
  }
  textarea{min-height:72px}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .actions button{padding:10px 14px; border:1px solid #ddd; background:#111; color:#fff; border-radius:8px; cursor:pointer}
  .actions button.secondary{background:#fff; color:#111}
  .hint{font-size:12px; color:#666}
  .table{width:100%; border-collapse:collapse;}
  .table th,.table td{border:1px solid #ddd; padding:8px; font-size:13px}

  /* 預覽／列印頁面容器（A4） */
  .sheet{
    width: var(--page-w);
    height: var(--page-h);
    box-sizing: border-box;
    background:#fff;
    color:#000;
    position: relative;
    margin: 0 auto 16px;
    padding: var(--margin);
    border: 1px solid #e5e5e5;
  }
  .dupe{display:grid; grid-template-rows: 1fr 1fr; gap:12mm; height:100%;}

  /* 標題區（模擬原件） */
  .header{display:grid; grid-template-columns: 1fr auto; align-items:end; margin-bottom:4mm;}
  .h-left{font-weight:700; text-align:center; font-size:14pt;}
  .h-left .title{display:flex; justify-content:center; gap:8px;}
  .h-left .title span{border: var(--border-bold) solid #000; padding:2px 6px;}
  .h-right{font-size: var(--fs-small); white-space:nowrap}
  .meta{display:grid; grid-template-columns: repeat(6, 1fr); gap:2mm; margin-top:2mm; font-size: var(--fs-small)}
  .meta div{border: var(--border-std) solid #000; padding:2mm; height:12mm; display:flex; align-items:center}

  /* 表格（與原件接近的欄位設計）*/
  .grid-table{display:grid; grid-template-rows: auto repeat(20, var(--cell-h)); border-left: var(--border-bold) solid #000; border-top: var(--border-bold) solid #000;}
  /* 欄寬：  序號｜掛號號碼｜收件人姓名｜寄達地名(或地址)｜回執｜印刷物｜重量｜郵資｜備註欄  */
  .grid-row{display:grid; grid-template-columns: 12mm 28mm 34mm 1fr 14mm 16mm 18mm 18mm 36mm;}
  .grid-row > div{border-right: var(--border-std) solid #000; border-bottom: var(--border-std) solid #000; padding:2mm; font-size: var(--fs-small); display:flex; align-items:center}
  .grid-row.header > div{font-weight:700; border-bottom: var(--border-bold) solid #000;}
  .grid-row > div:last-child{border-right: var(--border-bold) solid #000}
  .grid-table .grid-row:last-child > div{border-bottom: var(--border-bold) solid #000}
  .editable{outline: none}
  .editable:focus{box-shadow: inset 0 0 0 1px #0aa; background: #eefafa}

  .footer-note{font-size:9pt; line-height:1.5; margin-top:3mm}
  .print-actions{display:flex; gap:8px; justify-content:flex-end; margin:8px 0 16px}

  /* 歷史紀錄卡片 */
  .history{display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:12px}
  .card{border:1px solid #e5e5e5; border-radius:10px; padding:12px; background:#fafafa}
  .card h3{margin:0 0 8px; font-size:16px}
  .card .meta-line{font-size:12px; color:#666; margin:4px 0}
  .card .btns{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
  .card .btns button{padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer}
  .empty{color:#888; font-size:13px}

  @media print{
    body{background:#fff}
    .app, nav, .print-actions{display:none !important}
    .sheet{border:none; margin:0; page-break-after:always}
  }
</style>
</head>
<body>
  <div class="app">
    <h1>交寄大宗限時掛號／掛號函件 二聯單（離線）</h1>
    <div class="hint">規格：序號連號（21 會顯示 21），每頁 20 列；寄件人資訊為選填；掛號號碼可從「起始號」自動遞增，且在預覽可逐列編輯；日期為民國格式。</div>

    <nav>
      <button id="tab-input" class="active">① 輸入</button>
      <button id="tab-preview">② 預覽/列印</button>
      <button id="tab-history">③ 歷史紀錄</button>
    </nav>

    <!-- ① 輸入頁 -->
    <section id="panel-input" class="panel active">
      <h3>寄件人（選填）</h3>
      <div class="row">
        <label>寄件人名稱<input type="text" id="sender-name" placeholder="不填則列印留白"></label>
        <label>寄件人代表<input type="text" id="sender-rep" placeholder="不填則列印留白"></label>
        <label style="flex:2">詳細地址<input type="text" id="sender-addr" placeholder="不填則列印留白"></label>
        <label>電話<input type="text" id="sender-phone" placeholder="不填則列印留白"></label>
      </div>

      <h3 style="margin-top:12px">寄送與掛號資訊</h3>
      <div class="row">
        <label>寄送日期（自動民國）<input type="text" id="ship-date" readonly></label>
        <label>掛號號碼起始值（選填，如 AA123456789TW）<input type="text" id="reg-start" placeholder="輸入第一筆之後可自動遞增"></label>
        <div class="actions"><button id="btn-apply-reg" class="secondary">套用掛號號碼自動遞增</button></div>
      </div>

      <h3 style="margin-top:12px">收件清單</h3>
      <div class="row">
        <label style="flex:1">
          快速貼上（姓名,地址,備註 每行一筆；建議使用逗號分隔）
          <textarea id="bulk"></textarea>
          <div class="hint">可從 Excel 貼上三欄（姓名,地址,備註）。或用下方逐筆新增。</div>
        </label>
      </div>

      <div class="actions">
        <button id="btn-parse">加入列表</button>
        <button id="btn-add" class="secondary">新增空白一筆</button>
        <button id="btn-clear" class="secondary">清空列表</button>
        <div class="hint" id="counter" style="align-self:center; margin-left:8px"></div>
      </div>

      <table class="table" id="tbl-input">
        <thead>
          <tr>
            <th style="width:72px"># 序號</th>
            <th style="width:18%">掛號號碼</th>
            <th style="width:20%">收件人姓名</th>
            <th>寄達地址</th>
            <th style="width:24%">備註</th>
            <th style="width:100px"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="actions">
        <button id="btn-save">儲存為批次</button>
        <button id="btn-preview">前往預覽/列印</button>
      </div>
    </section>

    <!-- ② 預覽/列印頁 -->
    <section id="panel-preview" class="panel">
      <div class="print-actions">
        <button onclick="window.print()">列印</button>
        <button id="btn-rebuild" class="secondary">重新產生預覽</button>
      </div>
      <div id="preview-container"></div>
    </section>

    <!-- ③ 歷史紀錄頁 -->
    <section id="panel-history" class="panel">
      <div class="actions">
        <button id="btn-export" class="secondary">匯出全部 JSON</button>
        <input type="file" id="file-import" accept="application/json" style="display:none"/>
        <button id="btn-import" class="secondary">從 JSON 匯入</button>
      </div>
      <div id="history" class="history"></div>
    </section>
  </div>

<script>
(function(){
  const LS_KEY_DRAFT = 'massReg_draft_v3';
  const LS_KEY_BATCHES = 'massReg_batches_v3';
  const LS_KEY_SENDER = 'massReg_sender_v1';
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  const tabs = { input: $('#tab-input'), preview: $('#tab-preview'), history: $('#tab-history') };
  const panels = { input: $('#panel-input'), preview: $('#panel-preview'), history: $('#panel-history') };
  Object.keys(tabs).forEach(k=>{
    tabs[k].addEventListener('click', ()=>{
      Object.keys(tabs).forEach(x=>{ tabs[x].classList.remove('active'); panels[x].classList.remove('active'); });
      tabs[k].classList.add('active'); panels[k].classList.add('active');
      if(k==='preview') rebuildPreview();
      if(k==='history') renderHistory();
    });
  });

  function toROC(date){
    const y = date.getFullYear()-1911; const m = date.getMonth()+1; const d = date.getDate();
    const pad = n => String(n).padStart(2,'0');
    return `中華民國 ${y} 年 ${pad(m)} 月 ${pad(d)} 日`;
  }
  const shipDateInput = $('#ship-date');
  shipDateInput.value = toROC(new Date());

  // Sender meta
  const sender = { name: $('#sender-name'), rep: $('#sender-rep'), addr: $('#sender-addr'), phone: $('#sender-phone') };
  function loadSender(){ try{ const s = JSON.parse(localStorage.getItem(LS_KEY_SENDER)||'{}'); sender.name.value=s.name||''; sender.rep.value=s.rep||''; sender.addr.value=s.addr||''; sender.phone.value=s.phone||''; }catch(e){} }
  function saveSender(){ const s={ name: sender.name.value, rep: sender.rep.value, addr: sender.addr.value, phone: sender.phone.value }; localStorage.setItem(LS_KEY_SENDER, JSON.stringify(s)); }
  loadSender(); Object.values(sender).forEach(inp=> inp.addEventListener('input', saveSender));

  function getDraft(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_DRAFT)||'[]'); }catch(e){ return []; } }
  function setDraft(rows){ localStorage.setItem(LS_KEY_DRAFT, JSON.stringify(rows)); updateCounter(); }
  function getBatches(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_BATCHES)||'[]'); }catch(e){ return []; } }
  function setBatches(b){ localStorage.setItem(LS_KEY_BATCHES, JSON.stringify(b)); }

  function updateCounter(){ const n=getDraft().length; const pages=Math.ceil(n/20)||1; $('#counter').textContent = `目前 ${n} 筆 → 將產生 ${pages} 張（每張 20 筆），序號連號不重置`; }

  const tbody = $('#tbl-input tbody');
  function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }

  function renderDraft(){
    tbody.innerHTML='';
    const rows = getDraft();
    rows.forEach((r, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td><input type="text" value="${esc(r.reg||'')}" data-k="reg" placeholder="可留空或自動遞增"></td>
        <td><input type="text" value="${esc(r.name||'')}" data-k="name"></td>
        <td><input type="text" value="${esc(r.addr||'')}" data-k="addr"></td>
        <td><input type="text" value="${esc(r.note||'')}" data-k="note"></td>
        <td><button class="del">刪除</button></td>
      `;
      tbody.appendChild(tr);
    });
    updateCounter();
  }
  if(getDraft().length===0) setDraft([]);
  renderDraft();

  $('#btn-add').addEventListener('click', ()=>{ const rows=getDraft(); rows.push({reg:'',name:'',addr:'',note:''}); setDraft(rows); renderDraft(); });
  $('#btn-clear').addEventListener('click', ()=>{ if(confirm('確定清空目前列表？')){ setDraft([]); renderDraft(); } });

  // 快速貼上（逗號或 tab 分隔）
  $('#btn-parse').addEventListener('click', ()=>{
    const txt = ($('#bulk').value||'').trim(); if(!txt) return; const rows=getDraft();
    txt.split(/\n+/).forEach(line=>{
      const parts = line.split(/[\t,，]/).map(s=>s.trim());
      const name = parts[0]||''; const addr = parts[1]||''; const note = parts[2]||'';
      if(name||addr||note) rows.push({reg:'', name, addr, note});
    });
    setDraft(rows); renderDraft(); $('#bulk').value='';
  });

  tbody.addEventListener('input', e=>{ const tr=e.target.closest('tr'); if(!tr) return; const idx = Array.from(tbody.children).indexOf(tr); const rows=getDraft(); if(rows[idx]){ rows[idx][e.target.dataset.k] = e.target.value; setDraft(rows); } });
  tbody.addEventListener('click', e=>{ if(e.target.classList.contains('del')){ const tr=e.target.closest('tr'); const idx = Array.from(tbody.children).indexOf(tr); const rows=getDraft(); rows.splice(idx,1); setDraft(rows); renderDraft(); } });

  // 起始掛號自動遞增：解析前綴/數字/後綴
  $('#btn-apply-reg').addEventListener('click', ()=>{
    const start = ($('#reg-start').value||'').trim(); if(!start){ alert('請先輸入起始號'); return; }
    const rows = getDraft();
    const m = start.match(/^(\D*)(\d+)(\D*)$/);
    if(!m){
      rows.forEach((r,i)=>{ if(!r.reg){ const n=i+1; r.reg = start + String(n).padStart(2,'0'); } });
    }else{
      const pre=m[1], num=m[2], suf=m[3]; const width=num.length; let base=parseInt(num,10);
      rows.forEach((r,i)=>{ if(!r.reg){ r.reg = pre + String(base+i).padStart(width,'0') + suf; } });
    }
    setDraft(rows); renderDraft();
  });

  // 儲存為批次
  $('#btn-save').addEventListener('click', ()=>{
    const rows=getDraft(); if(!rows.length){ alert('沒有資料可儲存'); return; }
    const batches=getBatches(); const id='B'+Date.now();
    const senderMeta={ name: sender.name.value, rep: sender.rep.value, addr: sender.addr.value, phone: sender.phone.value };
    batches.unshift({ id, createdAt:new Date().toISOString(), rocDate: shipDateInput.value, sender: senderMeta, rows });
    setBatches(batches); alert('已儲存為批次，記錄在歷史中');
  });

  $('#btn-preview').addEventListener('click', ()=>{ tabs.preview.click(); });
  $('#btn-rebuild').addEventListener('click', rebuildPreview);

  function rebuildPreview(){
    const rows=getDraft(); const container=$('#preview-container'); container.innerHTML=''; if(!rows.length){ container.innerHTML='<div class="empty">尚無資料，請先在「輸入」加入收件資料。</div>'; return; }
    const pages=Math.ceil(rows.length/20);
    for(let p=0;p<pages;p++){
      const seg = rows.slice(p*20, p*20+20);
      const sheet = document.createElement('div'); sheet.className='sheet';
      sheet.appendChild(buildDupe(seg, p*20));
      container.appendChild(sheet);
    }
    // 可在預覽直接改掛號號碼，並同步回寫
    container.addEventListener('blur', e=>{
      const el=e.target; if(!el.classList.contains('reg-edit')) return; const idx=parseInt(el.dataset.idx,10); const r=getDraft();
      if(!isNaN(idx)&&r[idx]){ r[idx].reg = el.textContent.trim(); setDraft(r); }
    }, true);
  }

  function buildDupe(seg, offset){
    const wrap=document.createElement('div'); wrap.className='dupe';
    wrap.appendChild(buildOne(seg, offset, true));
    wrap.appendChild(buildOne(seg, offset, false));
    return wrap;
  }

  function buildOne(seg, offset, isReceipt){
    let sMeta={}; try{ sMeta = JSON.parse(localStorage.getItem(LS_KEY_SENDER)||'{}'); }catch(e){}
    const box=document.createElement('div');

    // 標題＋日期區
    const h=document.createElement('div'); h.className='header';
    const hl=document.createElement('div'); hl.className='h-left';
    hl.innerHTML = `
      <div class="title"><span>中 華 民 國 郵 政</span><span>限 時 掛 號</span></div>
      <div style="margin-top:3mm; font-weight:600">交寄大宗掛號函件${isReceipt?'執據':'存根'}／快捷郵件</div>
    `;
    const hr=document.createElement('div'); hr.className='h-right';
    hr.innerHTML = `
      <div>日 期：<strong>${esc(document.getElementById('ship-date').value)}</strong></div>
      <div>寄件人名稱：${esc(sMeta.name||'　　')}　寄件人代表：${esc(sMeta.rep||'　　')}　詳細地址：${esc(sMeta.addr||'　　')}　電話：${esc(sMeta.phone||'　　')}</div>
    `;
    h.appendChild(hl); h.appendChild(hr);

    // 表頭
    const table=document.createElement('div'); table.className='grid-table';
    const head=document.createElement('div'); head.className='grid-row header';
    head.innerHTML = '<div>順序<br>號碼</div><div>掛號號碼</div><div>收件人姓名</div><div>寄達地名(或地址)</div><div>回執</div><div>印刷物</div><div>重量</div><div>郵資</div><div>備註欄</div>';
    table.appendChild(head);

    // 20 行（不足以空白補足），序號連號不重置
    for(let i=0;i<20;i++){
      const row=document.createElement('div'); row.className='grid-row';
      const globalIdx = offset + i; const data = seg[i]||{}; const seq = globalIdx + 1;
      const v_name=data.name||''; const v_addr=data.addr||''; const v_note=data.note||''; const v_reg=data.reg||'';
      row.innerHTML = `
        <div>${seq}</div>
        <div class="editable reg-edit" contenteditable data-idx="${globalIdx}">${esc(v_reg)}</div>
        <div>${esc(v_name)}</div>
        <div>${esc(v_addr)}</div>
        <div></div><div></div><div></div><div></div>
        <div>${esc(v_note)}</div>
      `;
      table.appendChild(row);
    }

    const foot=document.createElement('div'); foot.className='footer-note';
    foot.innerHTML='保存期限2年　|　本單僅作郵資/重量證明；需查詢請於6個月內辦理。';

    box.appendChild(h); box.appendChild(table); box.appendChild(foot); 
    return box;
  }
})();
</script>
</body>
</html>
