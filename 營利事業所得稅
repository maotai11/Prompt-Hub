<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣營利事業所得稅全方位試算</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f4f7f9;
        }
        .form-section {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #f9fafb;
        }
        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
        }
        .input-group-text {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem;
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            border-right: 0;
            border-radius: 0.375rem 0 0 0.375rem;
            color: #4b5563;
        }
        .input-group .form-input {
            border-radius: 0 0.375rem 0.375rem 0;
        }
        .result-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1d4ed8;
        }
        .final-result-display {
            font-size: 2.25rem;
            font-weight: 800;
            color: #166534;
        }
        .comparison-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            height: 100%;
        }
        .comparison-card.highlight {
            border-color: #2563eb;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.2);
            transform: translateY(-5px);
        }
        h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #111827;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .chart-container {
            position: relative;
            width: 100%; 
            max-width: 800px; 
            margin-left: auto; 
            margin-right: auto; 
            height: 350px; 
            max-height: 400px;
        }
        .industry-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.15s;
            border-bottom: 1px solid #f3f4f6;
        }
        .industry-result-item:hover {
            background-color: #eff6ff;
        }
        .industry-result-item:last-child {
            border-bottom: none;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">台灣營利事業所得稅全方位試算</h1>
            <p class="text-gray-600 mt-2">整合四種申報方式、租稅抵減與最低稅負制 (113年度營利事業各業所得額暨同業利潤標準)</p>
        </header>

        <section id="basic-info-section" class="form-section">
            <h2>步驟一：營運與收支細節</h2>
            <p class="text-gray-600 mb-6 -mt-4">請填寫基礎財務數據，這將用於比較三種擴大申報方式下的預估所得額。</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="company-type" class="block text-sm font-medium text-gray-700 mb-1">組織類型</label>
                    <select id="company-type" class="form-input">
                        <option value="corporation">公司 (有限公司、股份有限公司)</option>
                        <option value="partnership">獨資、合夥組織 (行號)</option>
                    </select>
                </div>
                <div>
                    <label for="total-revenue" class="block text-sm font-medium text-gray-700 mb-1">營業收入淨額 (A)</label>
                    <div class="flex items-center input-group">
                        <span class="input-group-text">NT$</span>
                        <input type="number" id="total-revenue" class="form-input" placeholder="例如: 35,000,000" value="0">
                    </div>
                </div>
                <div>
                    <label for="non-operating-income" class="block text-sm font-medium text-gray-700 mb-1">非營業收入 (B)</label>
                    <div class="flex items-center input-group">
                        <span class="input-group-text">NT$</span>
                        <input type="number" id="non-operating-income" class="form-input" placeholder="例如: 50,000" value="0">
                    </div>
                </div>
                <div>
                    <label for="non-operating-expenses" class="block text-sm font-medium text-gray-700 mb-1">非營業費用 (C)</label>
                    <div class="flex items-center input-group">
                        <span class="input-group-text">NT$</span>
                        <input type="number" id="non-operating-expenses" class="form-input" placeholder="例如: 10,000" value="0">
                    </div>
                </div>
                <div class="md:col-span-2 hidden" id="partnership-notice">
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md">
                        <p class="font-bold">提醒您</p>
                        <p>獨資、合夥組織無須繳納營所稅，所得額歸入個人綜所稅計算。後續計算僅供參考法人組織稅負。</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="declaration-method-section" class="form-section">
            <h2>步驟二：申報所得額基礎比較與行業篩選</h2>
            <p class="text-gray-600 mb-6 -mt-4">請透過下方篩選器與關鍵字，找出您的行業別，以套用 **書審率 (R)**、**所得額率 (I)** 及 **同業淨利率 (N)**。</p>
            
            <div class="mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="filter-code" class="block text-xs font-medium text-gray-500 mb-1">標準代號 (開頭)</label>
                        <input type="text" id="filter-code" class="form-input form-input-filter" placeholder="例如: 9511">
                    </div>
                    <div>
                        <label for="filter-rate-R" class="block text-xs font-medium text-gray-500 mb-1">書審率 R (%) $\ge$</label>
                        <input type="number" id="filter-rate-R" class="form-input form-input-filter" placeholder="例如: 6" value="">
                    </div>
                    <div>
                        <label for="filter-rate-I" class="block text-xs font-medium text-gray-500 mb-1">所得額率 I (%) $\le$</label>
                        <input type="number" id="filter-rate-I" class="form-input form-input-filter" placeholder="例如: 12" value="">
                    </div>
                    <div>
                        <label for="filter-rate-N" class="block text-xs font-medium text-gray-500 mb-1">淨利率 N (%) $\le$</label>
                        <input type="number" id="filter-rate-N" class="form-input form-input-filter" placeholder="例如: 18" value="">
                    </div>
                </div>

                <div class="flex items-center justify-between mb-2">
                    <label for="industry-search" class="block text-sm font-medium text-gray-700">行業關鍵字搜尋 (名稱或代號)</label>
                    <div class="flex items-center">
                        <input type="checkbox" id="manual-rate-toggle" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="manual-rate-toggle" class="ml-2 block text-sm text-gray-900">自由輸入稅率</label>
                    </div>
                </div>

                <div id="industry-search-container">
                    <div class="relative">
                        <input type="text" id="industry-search" class="form-input pr-32" placeholder="請輸入關鍵字，例如: KTV, 汽車美容, 軟體設計">
                        <div id="selected-rate-info" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm font-semibold text-blue-600 pointer-events-none bg-blue-50 rounded-r-md px-3 py-1 border border-blue-200">
                            R: 0.0% / I: 0.0% / N: 0.0%
                        </div>
                    </div>
                    <div id="industry-results" class="absolute z-10 w-full md:w-1/2 mt-1 bg-white border border-gray-300 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden">
                        </div>
                </div>

                <div id="manual-rate-container" class="hidden mt-2">
                    <p class="text-xs text-gray-500 mb-2">請直接輸入適用的百分比稅率，例如輸入 6 代表 6%。</p>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="manual-rate-R" class="block text-xs font-medium text-gray-500 mb-1">書審率 R (%)</label>
                            <input type="number" id="manual-rate-R" class="form-input" value="0">
                        </div>
                        <div>
                            <label for="manual-rate-I" class="block text-xs font-medium text-gray-500 mb-1">所得額率 I (%)</label>
                            <input type="number" id="manual-rate-I" class="form-input" value="0">
                        </div>
                        <div>
                            <label for="manual-rate-N" class="block text-xs font-medium text-gray-500 mb-1">同業淨利率 N (%)</label>
                            <input type="number" id="manual-rate-N" class="form-input" value="0">
                        </div>
                    </div>
                </div>
                <input type="hidden" id="selected-industry-rates" value="0,0,0">
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div id="card-paper-review" class="comparison-card flex flex-col">
                    <h3 class="font-bold text-center text-blue-800">1. 擴大書審</h3>
                    <p class="text-xs text-center text-gray-500 mb-4">公式: (A+B) $\times$ 書審率 (R)</p>
                    <div class="flex-grow space-y-3">
                        <p class="text-sm text-gray-700">書審率 (R): <span id="paper-review-rate" class="font-semibold text-lg text-blue-500">0%</span></p>
                        <p class="text-sm">預估所得額：<span id="paper-review-income" class="font-bold text-xl block">0</span></p>
                        <p class="text-sm">預估稅額 (20%)：<span id="paper-review-tax" class="font-bold text-xl block text-red-600">0</span></p>
                    </div>
                    <button data-income-source="paper-review-income" class="use-income-btn mt-4 w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition">以此所得額計算</button>
                </div>
                <div id="card-income-standard" class="comparison-card flex flex-col">
                    <h3 class="font-bold text-center text-green-800">2. 所得額標準</h3>
                    <p class="text-xs text-center text-gray-500 mb-4">公式: A $\times$ 所得額率 (I) + B - C</p>
                     <div class="flex-grow space-y-3">
                        <p class="text-sm text-gray-700">所得額率 (I): <span id="income-standard-rate" class="font-semibold text-lg text-green-500">0%</span></p>
                        <p class="text-sm">預估所得額：<span id="income-standard-income" class="font-bold text-xl block">0</span></p>
                        <p class="text-sm">預估稅額 (20%)：<span id="income-standard-tax" class="font-bold text-xl block text-red-600">0</span></p>
                    </div>
                    <button data-income-source="income-standard-income" class="use-income-btn mt-4 w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition">以此所得額計算</button>
                </div>
                <div id="card-industry-profit" class="comparison-card flex flex-col">
                    <h3 class="font-bold text-center text-purple-800">3. 同業利潤</h3>
                    <p class="text-xs text-center text-gray-500 mb-4">公式: A $\times$ 同業淨利率 (N) + B - C</p>
                     <div class="flex-grow space-y-3">
                        <p class="text-sm text-gray-700">同業淨利率 (N): <span id="industry-profit-rate" class="font-semibold text-lg text-purple-500">0%</span></p>
                        <p class="text-sm">預估所得額：<span id="industry-profit-income" class="font-bold text-xl block">0</span></p>
                        <p class="text-sm">預估稅額 (20%)：<span id="industry-profit-tax" class="font-bold text-xl block text-red-600">0</span></p>
                    </div>
                    <button data-income-source="industry-profit-income" class="use-income-btn mt-4 w-full bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600 transition">以此所得額計算</button>
                </div>
                <div id="card-manual" class="comparison-card flex flex-col">
                    <h3 class="font-bold text-center text-gray-800">4. 查帳/會計師簽證</h3>
                    <p class="text-xs text-center text-gray-500 mb-4">依實際帳簿所得計算 (A+B)-(成本/費用/損失)</p>
                     <div class="flex-grow space-y-3">
                        <label class="text-sm">請自行輸入課稅所得額：</label>
                        <input type="number" id="manual-income" class="form-input text-lg font-bold" placeholder="自行計算所得" value="0">
                        <p class="text-sm mt-3">預估稅額 (20%)：<span id="manual-tax" class="font-bold text-xl block text-red-600">0</span></p>
                     </div>
                    <button data-income-source="manual-income" class="use-income-btn mt-4 w-full bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 transition">以此所得額計算</button>
                </div>
            </div>
            <div class="mt-8 chart-container">
                 <h3 class="text-center mb-4">四種申報方式所得額比較</h3>
                 <canvas id="incomeComparisonChart"></canvas>
            </div>
        </section>

        <section class="form-section">
            <h2>步驟三：營所稅與最低稅負 (AMT) 試算</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1">
                    <label for="taxable-income" class="block text-sm font-medium text-gray-700 mb-1">課稅所得額 (來自步驟二的選擇)</label>
                    <div class="flex items-center input-group">
                        <span class="input-group-text">NT$</span>
                        <input type="number" id="taxable-income" class="form-input bg-yellow-100" placeholder="0" value="0">
                    </div>
                </div>
                <div class="md:col-span-2 bg-blue-50 p-4 rounded-lg flex items-center justify-between">
                    <div>
                         <p class="text-sm text-gray-600">一般營所稅應納稅額 (稅前抵減)</p>
                         <p id="settlement-tax-result" class="result-display">NT$ 0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-600">適用稅率</p>
                        <p class="text-lg font-bold text-blue-700">20%</p>
                    </div>
                </div>
                <div class="md:col-span-3 mt-4">
                    <h3 class="text-lg font-semibold border-b pb-2 mb-4">最低稅負 (AMT) 計算</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="amt-exempt-income" class="block text-sm font-medium text-gray-700 mb-1">特定免稅所得加計項目</label>
                            <div class="flex items-center input-group">
                                <span class="input-group-text">NT$</span>
                                <input type="number" id="amt-exempt-income" class="form-input" placeholder="如舊制證券交易所得" value="0">
                            </div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">基本所得額</p>
                            <p id="amt-base-result" class="result-display text-orange-700">NT$ 0</p>
                        </div>
                         <div class="bg-orange-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">應納基本稅額 (AMT)</p>
                            <p id="amt-tax-result" class="result-display text-orange-700">NT$ 0</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="form-section">
            <h2>步驟四：租稅優惠與抵減計算</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-red-600">A. 投資抵減稅額 (抵減上限 30%)</h3>
                    <p class="text-sm text-gray-600 mb-4">輸入各項可抵減營所稅的金額。總抵減額不得超過步驟三計算之**一般營所稅應納稅額**的 30%。</p>
                    <div class="space-y-3">
                        <label for="rd-credit" class="block text-sm font-medium text-gray-700">研發支出投資抵減 (《產業創新條例》、《中小企業發展條例》等)</label>
                        <div class="flex items-center input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="number" id="rd-credit" class="form-input" placeholder="R&D 抵減金額" value="0">
                        </div>
                        <label for="machine-credit" class="block text-sm font-medium text-gray-700">智慧機械/5G/AI/設備投資抵減</label>
                        <div class="flex items-center input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="number" id="machine-credit" class="form-input" placeholder="設備投資抵減金額" value="0">
                        </div>
                    </div>
                    <div class="mt-4 bg-red-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">最終可抵減稅額</p>
                        <p id="total-credit-used" class="result-display text-red-600">NT$ 0</p>
                        <p class="text-xs text-gray-500">抵減上限: <span id="credit-limit">NT$ 0</span></p>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-3 text-indigo-600">B. 加成減除與未分配盈餘 (UAET)</h3>
                    <p class="text-sm text-gray-600 mb-4">輸入加成減除的費用，此類費用可減少課稅所得額。</p>
                    <div class="space-y-3">
                        <label for="sports-donation" class="block text-sm font-medium text-gray-700">捐贈運動業專戶之加成減除費用 (例: 100% 加成)</label>
                        <div class="flex items-center input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="number" id="sports-donation" class="form-input" placeholder="已報費用外的加成金額" value="0">
                        </div>
                        <label for="military-salary" class="block text-sm font-medium text-gray-700">員工召集請假薪資加成減除費用 (例: 50% 加成)</label>
                        <div class="flex items-center input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="number" id="military-salary" class="form-input" placeholder="加成減除金額" value="0">
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold mt-6 mb-3 border-t pt-4 text-indigo-600">C. 未分配盈餘稅 (UAET, 5%)</h3>
                    <div class="space-y-3">
                        <label for="uaet-net-profit" class="block text-sm font-medium text-gray-700">當年度稅後淨利 (盈餘)</label>
                        <div class="flex items-center input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="number" id="uaet-net-profit" class="form-input" placeholder="稅後淨利" value="0">
                        </div>
                        <label for="uaet-substantial-investment" class="block text-sm font-medium text-gray-700">當年度實質投資金額 (可減除項目)</label>
                        <div class="flex items-center input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="number" id="uaet-substantial-investment" class="form-input" placeholder="未分配盈餘轉投資金額" value="0">
                        </div>
                    </div>
                    <div class="mt-4 bg-indigo-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">應加徵 UAET 之稅基</p>
                        <p id="uaet-base-result" class="result-display text-indigo-700">NT$ 0</p>
                        <p class="text-sm text-gray-600 mt-2">未分配盈餘稅 (5%)</p>
                        <p id="uaet-tax-result" class="result-display text-indigo-700">NT$ 0</p>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="form-section bg-gray-800 text-white">
            <h2 class="text-white border-gray-600">步驟五：年度總應繳稅負</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-center">
                <div>
                    <p class="text-gray-400">一般營所稅 (抵減後)</p>
                    <p class="text-2xl font-bold" id="psit-after-credit">NT$ 0</p>
                </div>
                <div>
                    <p class="text-gray-400">基本稅額 (AMT)</p>
                    <p class="text-2xl font-bold" id="amt-due">NT$ 0</p>
                </div>
                <div>
                    <p class="text-gray-400">最終結算營所稅</p>
                    <p class="text-2xl font-bold" id="final-psit-due">NT$ 0</p>
                    <p class="text-xs text-gray-500">(取兩者較高者)</p>
                </div>
                <div>
                    <p class="text-gray-400">未分配盈餘稅 (UAET)</p>
                    <p class="text-2xl font-bold" id="final-uaet-due">NT$ 0</p>
                </div>
                <div class="md:col-span-4 mt-4 border-t border-gray-600 pt-6">
                    <p class="text-lg text-gray-300">年度總應繳稅負</p>
                    <p id="total-tax-liability" class="final-result-display text-green-400">NT$ 0</p>
                </div>
            </div>
        </section>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>本試算結果僅供參考，實際應納稅額以主管稽徵機關核定為準。請注意公式適用性及各項抵減的法定條件。</p>
        </footer>
    </div>
<script>
let incomeComparisonChart;
let currentRates = { R: 0, I: 0, N: 0 };
// State to hold the selected rates

document.addEventListener('DOMContentLoaded', () => {
    // --- Data (Extracted Sample from 113年度營利事業各業所得額暨同業利潤標準 PDF) ---
    // R: 擴大書審純益率, I: 所得額標準, N: 同業利潤標準 淨利率 (所有費率皆已除以 100 轉換為小數)
    const INDUSTRY_DATA = [
        // A. 農、林、漁、牧業
        { code: '0114-00', name: '農作物栽培業 (蔬菜栽培)', R: 0.04, I: 0.09, N: 0.11 },
        { code: '0115-00', name: '果樹栽培', R: 0.04, I: 0.09, N: 0.11 },
        { code: '0117-11', name: '盆景栽培', R: 0.04, I: 0.09, N: 0.11 },
        { code: '0117-99', name: '其他花卉栽培', R: 0.04, I: 0.08, N: 0.10 },
        { code: '0121-00', name: '牛飼育', R: 0.04, I: 0.07, N: 0.08 },
        { code: '0122-00', name: '豬飼育', R: 0.04, I: 0.07, N: 0.08 },
        // C. 礦業及土石採取業 (範例)
        { code: '0800-00', name: '其他礦業及土石採取業', R: 0.06, I: 0.09, N: 0.12 },
        // D. 製造業 (範例)
        { code: '2641-00', name: '積體電路製造', R: 0.10, I: 0.12, N: 0.25 },
        // E. 電力及燃氣供應業 (範例)
        { code: '3511-00', name: '發電業', R: 0.08, I: 0.10, N: 0.15 },
        // F. 用水供應及污染整治業 (範例)
        { code: '3700-00', name: '汙水處理業', R: 0.07, I: 0.11, N: 0.14 },
        // G. 營建工程業 (範例)
        { code: '4100-00', name: '土木工程業', R: 0.06, I: 0.13, N: 0.16 },
        // H. 批發及零售業
        { code: '4510-00', name: '汽車銷售', R: 0.05, I: 0.07, N: 0.10 },
        { code: '4749-99', name: '其他零售業', R: 0.06, I: 0.08, N: 0.12 }, 
        // I. 運輸及倉儲業 (範例)
        { code: '4910-00', name: '鐵路運輸業', R: 0.08, I: 0.11, N: 0.15 },
        // J. 住宿及餐飲業
        { code: '5611-00', name: '餐館業 (一般餐飲)', R: 0.06, I: 0.08, N: 0.15 },
        // K. 資訊及通訊傳播業
        { code: '7310-00', name: '軟體設計服務業', R: 0.08, I: 0.10, N: 0.20 },
        // L. 金融及保險業 (範例)
        { code: '6411-00', name: '人壽保險業', R: 0.02, I: 0.04, N: 0.05 },
        // M. 不動產業 (範例)
        { code: '6811-00', name: '不動產開發業', R: 0.08, I: 0.14, N: 0.22 },
        // N. 專業、科學及技術服務業 (範例)
        { code: '7410-12', name: '會計服務業', R: 0.08, I: 0.15, N: 0.20 },
        // O. 支援服務業 (範例)
        { code: '8220-00', name: '電話行銷服務業', R: 0.07, I: 0.12, N: 0.18 },
        // R. 藝術、娛樂及休閒服務業
        { code: '9329-11', name: '視唱中心 (KTV)', R: 0.06, I: 0.11, N: 0.14 },
        { code: '9329-12', name: '釣蝦場', R: 0.06, I: 0.11, N: 0.14 },
        { code: '9329-14', name: '海水浴場', R: 0.06, I: 0.13, N: 0.18 },
        { code: '9329-15', name: '上網專門店', R: 0.06, I: 0.11, N: 0.14 },
        // S. 其他服務業
        { code: '9511-11', name: '貨櫃修理', R: 0.06, I: 0.19, N: 0.27 },
        { code: '9511-99', name: '其他汽車維修', R: 0.06, I: 0.13, N: 0.17 },
        { code: '9512-00', name: '汽車美容', R: 0.06, I: 0.12, N: 0.16 },
        { code: '9521-00', name: '電腦及其週邊設備維修', R: 0.06, I: 0.15, N: 0.22 },
        { code: '9499-00', name: '未分類其他組織', R: 0.04, I: 0.05, N: 0.06 },
    ];
    // --- DOM Elements ---
    const allInputs = document.querySelectorAll('input:not(#industry-search), select');
    const formFilterInputs = document.querySelectorAll('.form-input-filter');
    const companyTypeSelect = document.getElementById('company-type');
    const partnershipNotice = document.getElementById('partnership-notice');
    const totalRevenueInput = document.getElementById('total-revenue');
    const nonOperatingIncomeInput = document.getElementById('non-operating-income');
    const nonOperatingExpensesInput = document.getElementById('non-operating-expenses');
    
    // Search/Filter Elements
    const industrySearchInput = document.getElementById('industry-search');
    const industryResultsDiv = document.getElementById('industry-results');
    const selectedRateInfoSpan = document.getElementById('selected-rate-info');
    const taxableIncomeInput = document.getElementById('taxable-income');
    const useIncomeBtns = document.querySelectorAll('.use-income-btn');
    const comparisonCards = document.querySelectorAll('.comparison-card');
    const manualIncomeInput = document.getElementById('manual-income');
    
    // Filter Inputs
    const filterCodeInput = document.getElementById('filter-code');
    const filterRateRInput = document.getElementById('filter-rate-R');
    const filterRateIInput = document.getElementById('filter-rate-I');
    const filterRateNInput = document.getElementById('filter-rate-N');

    // ** NEW **: Manual Rate Input Elements
    const manualRateToggle = document.getElementById('manual-rate-toggle');
    const industrySearchContainer = document.getElementById('industry-search-container');
    const manualRateContainer = document.getElementById('manual-rate-container');
    const manualRateRInput = document.getElementById('manual-rate-R');
    const manualRateIInput = document.getElementById('manual-rate-I');
    const manualRateNInput = document.getElementById('manual-rate-N');

    // Credit/Deduction Inputs
    const rdCreditInput = document.getElementById('rd-credit');
    const machineCreditInput = document.getElementById('machine-credit');
    const uaetNetProfitInput = document.getElementById('uaet-net-profit');
    const uaetSubstantialInvestmentInput = document.getElementById('uaet-substantial-investment');
    const sportsDonationInput = document.getElementById('sports-donation');
    const militarySalaryInput = document.getElementById('military-salary');
    const amtExemptIncomeInput = document.getElementById('amt-exempt-income');
    // --- Data & Constants ---
    const TAX_CONSTANTS = {
        PSIT_RATE: 0.20,
        PSIT_EXEMPT_THRESHOLD: 120000,
        PSIT_PROGRESSIVE_THRESHOLD: 200000,
        UAET_RATE: 0.05,
        AMT_RATE: 0.12, 
        AMT_DEDUCTION: 6700000, 
        TAX_CREDIT_CAP: 0.30, 
    };
    // --- Calculation Helpers ---
    const calculatePSITRate = (income) => {
        if (income <= TAX_CONSTANTS.PSIT_EXEMPT_THRESHOLD) return 0;
        if (income <= TAX_CONSTANTS.PSIT_PROGRESSIVE_THRESHOLD) {
            return (income - TAX_CONSTANTS.PSIT_EXEMPT_THRESHOLD) * 0.5;
        }
        return income * TAX_CONSTANTS.PSIT_RATE;
    };

    const calculateUAET = (base) => {
        if (base <= 0) return 0;
        return Math.round(base * TAX_CONSTANTS.UAET_RATE);
    };

    const formatCurrency = (num) => `NT$ ${Math.round(num).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
    // --- Search & Selection Logic ---

    const filterIndustries = (query) => {
        const lowerCaseQuery = query.toLowerCase().trim();
        const filterCode = filterCodeInput.value.toLowerCase().trim();
        const filterRateR = (parseFloat(filterRateRInput.value) / 100) || 0; 
        const filterRateI = (parseFloat(filterRateIInput.value) / 100) || Infinity;
        const filterRateN = (parseFloat(filterRateNInput.value) / 100) || Infinity;

        const filteredResults = INDUSTRY_DATA.filter(item => {
            const keywordMatch = (lowerCaseQuery.length < 2) || 
                                 item.code.includes(lowerCaseQuery) || 
                                 item.name.toLowerCase().includes(lowerCaseQuery);
            if (!keywordMatch) return false;
            if (filterCode && !item.code.startsWith(filterCode)) return false;
            if (filterRateR && item.R < filterRateR) return false;
            if (filterRateI !== Infinity && item.I > filterRateI) return false;
            if (filterRateN !== Infinity && item.N > filterRateN) return false;
            return true;
        });

        if (lowerCaseQuery.length < 2 && !filterCode && !filterRateRInput.value && !filterRateIInput.value && !filterRateNInput.value) {
            return [];
        }
        return filteredResults.slice(0, 15);
    };

    const renderResults = (results) => {
        industryResultsDiv.innerHTML = '';
        if (results.length === 0) {
            industryResultsDiv.innerHTML = '<div class="p-4 text-center text-gray-500">查無結果或請輸入更多關鍵字/調整篩選條件。</div>';
            industryResultsDiv.classList.remove('hidden');
            return;
        }

        results.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'industry-result-item text-sm';
            itemDiv.innerHTML = `<span class="font-bold text-gray-800">${item.code}</span> - ${item.name} 
                                 <span class="text-xs text-gray-500 ml-2">(R:${(item.R * 100).toFixed(1)}% / I:${(item.I * 100).toFixed(1)}% / N:${(item.N * 100).toFixed(1)}%)</span>`;
            itemDiv.addEventListener('click', () => selectIndustry(item));
            industryResultsDiv.appendChild(itemDiv);
        });
        industryResultsDiv.classList.remove('hidden');
        const inputRect = industrySearchInput.getBoundingClientRect();
        industryResultsDiv.style.width = inputRect.width + 'px';
    };

    const selectIndustry = (item) => {
        currentRates = { R: item.R, I: item.I, N: item.N };
        industrySearchInput.value = `${item.code} - ${item.name}`;
        industryResultsDiv.classList.add('hidden');
        runAllCalculations();
    };
    
    let debounceTimer;
    const debouncedFilter = () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const query = industrySearchInput.value;
            renderResults(filterIndustries(query));
        }, 200);
    };

    industrySearchInput.addEventListener('input', debouncedFilter);
    formFilterInputs.forEach(input => input.addEventListener('input', debouncedFilter));

    industrySearchInput.addEventListener('input', (e) => {
        if (e.target.value.trim() === '') {
            currentRates = { R: 0, I: 0, N: 0 };
            selectedRateInfoSpan.textContent = `R: 0.0% / I: 0.0% / N: 0.0%`;
            runAllCalculations();
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!industryResultsDiv.contains(e.target) && e.target !== industrySearchInput) {
            industryResultsDiv.classList.add('hidden');
        }
    });

    // --- Main Calculation & UI Update Logic ---
    const runAllCalculations = () => {
        // 1. Core Inputs
        const revenue = parseFloat(totalRevenueInput.value) || 0;
        const nonOpIncome = parseFloat(nonOperatingIncomeInput.value) || 0;
        const nonOpExpenses = parseFloat(nonOperatingExpensesInput.value) || 0;
        
        // ** MODIFIED **: Determine which rates to use
        let rates;
        if (manualRateToggle.checked) {
            const r = parseFloat(manualRateRInput.value) / 100 || 0;
            const i = parseFloat(manualRateIInput.value) / 100 || 0;
            const n = parseFloat(manualRateNInput.value) / 100 || 0;
            rates = { R: r, I: i, N: n };
        } else {
            rates = currentRates;
        }

        // Handle partnership case
        if (companyTypeSelect.value === 'partnership') {
            partnershipNotice.classList.remove('hidden');
            document.querySelectorAll('.form-section:not(#basic-info-section)').forEach(s => s.classList.add('opacity-50', 'pointer-events-none'));
            return;
        } else {
            partnershipNotice.classList.add('hidden');
            document.querySelectorAll('.form-section:not(#basic-info-section)').forEach(s => s.classList.remove('opacity-50', 'pointer-events-none'));
        }

        // 2. Declaration Method Comparison (步驟二)
        // Update Rates Display
        selectedRateInfoSpan.textContent = `R: ${(rates.R * 100).toFixed(1)}% / I: ${(rates.I * 100).toFixed(1)}% / N: ${(rates.N * 100).toFixed(1)}%`;
        document.getElementById('paper-review-rate').textContent = `${(rates.R * 100).toFixed(1)}%`;
        document.getElementById('income-standard-rate').textContent = `${(rates.I * 100).toFixed(1)}%`;
        document.getElementById('industry-profit-rate').textContent = `${(rates.N * 100).toFixed(1)}%`;

        const paperReviewIncome = Math.max(0, (revenue + nonOpIncome) * rates.R);
        const paperReviewTax = calculatePSITRate(paperReviewIncome);
        document.getElementById('paper-review-income').textContent = formatCurrency(paperReviewIncome);
        document.getElementById('paper-review-tax').textContent = formatCurrency(paperReviewTax);

        const incomeStandardIncome = Math.max(0, (revenue * rates.I) + nonOpIncome - nonOpExpenses);
        const incomeStandardTax = calculatePSITRate(incomeStandardIncome);
        document.getElementById('income-standard-income').textContent = formatCurrency(incomeStandardIncome);
        document.getElementById('income-standard-tax').textContent = formatCurrency(incomeStandardTax);
        
        const industryProfitIncome = Math.max(0, (revenue * rates.N) + nonOpIncome - nonOpExpenses);
        const industryProfitTax = calculatePSITRate(industryProfitIncome);
        document.getElementById('industry-profit-income').textContent = formatCurrency(industryProfitIncome);
        document.getElementById('industry-profit-tax').textContent = formatCurrency(industryProfitTax);

        const manualIncome = parseFloat(manualIncomeInput.value) || 0;
        const manualTax = calculatePSITRate(manualIncome);
        document.getElementById('manual-tax').textContent = formatCurrency(manualTax);
        updateComparisonChart(paperReviewIncome, incomeStandardIncome, industryProfitIncome, manualIncome);
        
        // 3. PSIT, AMT Calculation (步驟三)
        let taxableIncome = parseFloat(taxableIncomeInput.value) || 0;
        const sportsDonation = parseFloat(sportsDonationInput.value) || 0;
        const militarySalary = parseFloat(militarySalaryInput.value) || 0;
        const totalAddonDeduction = sportsDonation + militarySalary;
        let adjustedTaxableIncome = Math.max(0, taxableIncome - totalAddonDeduction);
        const settlementTaxBeforeCredit = calculatePSITRate(adjustedTaxableIncome);
        document.getElementById('settlement-tax-result').textContent = formatCurrency(settlementTaxBeforeCredit);
        
        const amtExemptIncome = parseFloat(amtExemptIncomeInput.value) || 0;
        const amtBase = adjustedTaxableIncome + amtExemptIncome;
        document.getElementById('amt-base-result').textContent = formatCurrency(amtBase);
        const amtTax = Math.max(0, (amtBase - TAX_CONSTANTS.AMT_DEDUCTION) * TAX_CONSTANTS.AMT_RATE);
        document.getElementById('amt-tax-result').textContent = formatCurrency(amtTax);
        document.getElementById('amt-due').textContent = formatCurrency(amtTax);

        // 4. Tax Credits (步驟四 A)
        const rdCredit = parseFloat(rdCreditInput.value) || 0;
        const machineCredit = parseFloat(machineCreditInput.value) || 0;
        const totalCredit = rdCredit + machineCredit;
        const creditLimit = settlementTaxBeforeCredit * TAX_CONSTANTS.TAX_CREDIT_CAP;
        const creditUsed = Math.min(totalCredit, creditLimit);
        document.getElementById('credit-limit').textContent = formatCurrency(creditLimit);
        document.getElementById('total-credit-used').textContent = formatCurrency(creditUsed);
        const psitAfterCredit = Math.max(0, settlementTaxBeforeCredit - creditUsed);
        document.getElementById('psit-after-credit').textContent = formatCurrency(psitAfterCredit);

        // 4. UAET Calculation (步驟四 C)
        const uaetNetProfit = parseFloat(uaetNetProfitInput.value) || 0;
        const uaetSubstantialInvestment = parseFloat(uaetSubstantialInvestmentInput.value) || 0;
        const uaetBase = Math.max(0, uaetNetProfit - uaetSubstantialInvestment);
        const uaetTax = calculateUAET(uaetBase);
        document.getElementById('uaet-base-result').textContent = formatCurrency(uaetBase);
        document.getElementById('uaet-tax-result').textContent = formatCurrency(uaetTax);
        document.getElementById('final-uaet-due').textContent = formatCurrency(uaetTax);

        // 5. Final Summary (步驟五)
        const finalPSIT = Math.max(psitAfterCredit, amtTax);
        document.getElementById('final-psit-due').textContent = formatCurrency(finalPSIT);
        const totalTaxLiability = finalPSIT + uaetTax;
        document.getElementById('total-tax-liability').textContent = formatCurrency(totalTaxLiability);
    };

    // --- Chart Initialization and Update ---
    const initializeComparisonChart = () => {
        const ctx = document.getElementById('incomeComparisonChart').getContext('2d');
        incomeComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['擴大書審', '所得額標準', '同業利潤標準', '查帳/簽證'],
                datasets: [{
                    label: '預估課稅所得額 (NT$)',
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#3b82f6', '#10b981', '#9333ea', '#6b7280'],
                    borderRadius: 8,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `所得額: NT$ ${context.parsed.y.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: '所得額 (NT$)' },
                        ticks: {
                            callback: function(value) { return value.toLocaleString(); }
                        }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    };

    const updateComparisonChart = (pr, is, ip, ma) => {
        if (!incomeComparisonChart) return;
        incomeComparisonChart.data.datasets[0].data = [pr, is, ip, ma];
        incomeComparisonChart.update();
    };

    // --- Event Listeners ---
    initializeComparisonChart();
    allInputs.forEach(input => {
        input.addEventListener('input', runAllCalculations);
    });
    useIncomeBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const sourceId = e.target.dataset.incomeSource;
            const sourceElement = document.getElementById(sourceId);
            let incomeValue = 0;
            if (sourceElement.tagName === 'INPUT') {
                incomeValue = parseFloat(sourceElement.value) || 0;
            } else { 
                incomeValue = parseFloat(sourceElement.textContent.replace(/[NT$,\s]/g, '')) || 0;
            }
            taxableIncomeInput.value = Math.round(incomeValue);
            taxableIncomeInput.dispatchEvent(new Event('input'));
            comparisonCards.forEach(c => c.classList.remove('highlight'));
            sourceElement.closest('.comparison-card').classList.add('highlight');
            taxableIncomeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    });

    // ** NEW **: Listener for manual rate toggle and inputs
    manualRateToggle.addEventListener('change', () => {
        const isManual = manualRateToggle.checked;
        industrySearchContainer.classList.toggle('hidden', isManual);
        manualRateContainer.classList.toggle('hidden', !isManual);
        
        // When switching to manual, reset search and clear old selection
        if (isManual) {
            industrySearchInput.value = '';
            currentRates = { R: 0, I: 0, N: 0 };
            industryResultsDiv.classList.add('hidden');
        }
        runAllCalculations();
    });

    [manualRateRInput, manualRateIInput, manualRateNInput].forEach(input => {
        input.addEventListener('input', runAllCalculations);
    });

    // --- Initial Run ---
    runAllCalculations();
    debouncedFilter();
});
</script>
</body>
</html>
