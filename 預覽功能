# 專案名稱
單一 HTML 離線多文件預覽與多段文字摘錄工作台  
(Offline Single-HTML Multi-Document Preview & Multi-Clip Extractor)

---

## 一、專案目標（Must-have，不得刪減）

開發一個 **「只有一個 HTML 檔」** 的純前端離線工具。使用者在瀏覽器中開啟此 HTML 後，可以：

1. 一次選擇本機某個「資料夾」或多個檔案，工具要能處理：
   - **Word：`.docx`**
   - **Excel：`.xlsx`**
   - **PDF：`.pdf`**
2. 在同一個網頁介面中，快速切換並預覽這些文件的內容，**不需要反覆打開 / 關閉單一檔案**。
3. 使用者可以在每一個文件預覽畫面中：
   - 正常用滑鼠選取文字。
   - 將選取的文字「加入摘錄」（建立 clip），可多處、多次。
4. 所有檔案中被選取的片段，會被彙整到右側「輸出區」，顯示為 clip 清單：
   - 每一段 clip 必須包含：
     - 文字內容
     - 來源檔名
     - 來源位置：  
       - PDF：頁碼  
       - Word：大致段落序號或結構（如 Heading / Paragraph index）  
       - Excel：工作表名稱 + 儲存格範圍（如 `Sheet1!A2:C5`）
5. 使用者可以在輸出區：
   - 刪除某一則 clip。
   - 最後按下一個「Copy All」按鈕，將所有 clip（含來源標註）一次複製到剪貼簿。
6. 這個工具只作為「閱讀＋摘錄」工作台：
   - **不提供文件內容編輯功能**。
   - 若要修改內容，使用者需回到原始檔案（Word / Excel / PDF）中進行編輯。

> 重點：請完整實作上述功能，不得用假資料、placeholder 或 demo 文字取代實際檔案解析與預覽。

---

## 二、硬限制與邊界條件（不可違反）

### 1. 發佈形式：單一 HTML

- 最終交付成果必須是 **一個單一的 `.html` 檔案**。
- 所有 JS / CSS / library（含 pdf / docx / xlsx 解析程式）都必須：
  - 內嵌在這個 HTML 檔中（使用 `<script>` / `<style>` / data URI 等方式）。
  - 不依賴任何外部 CDN 或額外檔案。
- 使用者只要有這一個 HTML，在支援的瀏覽器（例如 Chrome / Edge）中打開，即可 **完全離線使用**。

### 2. 瀏覽器安全規則

- 必須遵守瀏覽器 File API 與安全沙箱限制：
  - 不得嘗試在未經選取的情況下掃描硬碟或任意路徑。
- 檔案來源限定為：
  - `<input type="file" webkitdirectory>`（讓使用者選資料夾），或
  - `<input type="file" multiple>`（讓使用者一次選多個檔案）。
- 不需要在重新整理頁面後保留先前的檔案狀態（第一版可不做 persistent storage）。

### 3. 完全離線

- 不允許任何網路請求（不論是 API 或載入外部 script）。
- 所有解析 / 渲染 / UI 行為皆在本機瀏覽器內完成。

---

## 三、文件格式支援（一次到位）

請在最終版中 **同時支援** 下列三種格式，並以實際解析檔案內容的方式實作：

1. **PDF（`.pdf`）**
   - 能載入多頁 PDF。
   - 能以文字層方式呈現，使使用者可以正常選取文字。
   - 能取得使用者選取範圍所在的「頁碼」，作為 clip 的 meta。

2. **Word（`.docx`）**
   - 解析 docx 結構（XML）並轉為 HTML 顯示。
   - 不求 100% 排版還原，但需：
     - 文字內容完整呈現。
     - 基本段落階層（標題、段落）可辨識。
   - 在產生 clip 時，盡量提供可辨識的位置資訊，如：
     - 第幾段 / 所屬標題層級（若技術上可行）。

3. **Excel（`.xlsx`）**
   - 解析 xlsx 為結構化資料。
   - 每個工作表可轉成一個或多個 HTML 表格呈現。
   - 使用者可以在表格中選取文字（儲存格內容）。
   - 產出 clip 時，需記錄：
     - 工作表名稱
     - 對應的儲存格範圍（例如：單格 `B3` 或範圍 `A2:C5`）。

> 要求：  
> - 三種類型皆需以實際文件內容做預覽與選取，**不可用假內容**。  
> - 若使用第三方 library（如 pdf.js / SheetJS / docx 解析工具），請確保可以被打包進單一 HTML 中。

---

## 四、介面與使用流程（UI/UX）

整體介面採三欄式布局：

### 1. 左欄：檔案列表（File List）

- 顯示所有成功載入的檔案，包含資訊：
  - 檔名
  - 檔案類型（PDF / Word / Excel）
  - 已摘錄 clip 數量（例如 `3 clips`）
- 互動：
  - 點擊某一筆檔案 → 中央預覽區切換到該檔案內容。
- 錯誤檔案：
  - 若檔案解析失敗，仍顯示在列表中，但標記為「解析失敗」，點擊時在預覽區顯示錯誤訊息。

### 2. 中欄：文件預覽區（Document Viewer）

- 顯示目前選中的檔案內容（PDF / Word / Excel）。
- 要求：
  - 支援捲動，完整瀏覽全部內容。
  - 使用者可以用滑鼠拖拉選取文字。
- 互動：
  - 當有選取文字時，提供「加入摘錄 / Add Clip」的操作方式，例如：
    - 選取後彈出小工具列按鈕，或
    - 預覽區上方固定一個「將目前選取加入 Clip」的按鈕。
  - 按下後：
    - 取得選取文字內容。
    - 根據檔案類型計算並保存來源位置 meta。
    - 在右側新增一個 clip 項目。

### 3. 右欄：摘錄區（Clips / Output Panel）

- 顯示所有已加入的 clips，按照加入順序列出。
- 每一個 clip 項目需顯示：
  - clip 文字內容（可多行文字）
  - 來源說明，例如：  
    - `來源：report.pdf，第 3 頁`  
    - `來源：contract.docx，Heading "條款二" 下第 2 段`（若可做到）  
    - `來源：finance.xlsx，Sheet "2024"，B3:C5`
- 操作：
  - 使用者可以刪除單一 clip。
  - clip 順序若能支援拖曳排序更佳（若實作成本過高，可先維持加入順序）。
- 「Copy All」按鈕：
  - 將所有 clip 整理成一段純文字，格式例如：

    ```
    [1] 檔名：xxx.pdf，第 2 頁
    內容：..........

    [2] 檔名：yyy.xlsx，Sheet1!A2:B5
    內容：..........

    ...
    ```

  - 使用 `navigator.clipboard.writeText()` 送到剪貼簿。

---

## 五、系統架構建議（模組化，便於維護與擴充）

請採用清晰的模組分工（可用原生 JS 或任意前端框架，但最終仍須編譯成單一 HTML）：

1. `FileManager`
   - 取得使用者選擇的檔案（FileList）。
   - 篩選支援的副檔名：`.pdf` / `.docx` / `.xlsx`。
   - 建立內部檔案資料結構（ID、檔名、類型、File 物件、解析狀態）。
   - 提供 API 給 UI 取得檔案列表。

2. `DocumentAdapter` 介面與實作：
   - `PdfAdapter`
   - `DocxAdapter`
   - `XlsxAdapter`
   - 負責：
     - 接收 `File` 或 ArrayBuffer。
     - 解析為可顯示的 HTML / DOM 節點（可放在某個容器中）。
     - 提供計算「位置 meta」的能力（頁碼、段落、儲存格範圍）。

3. `Viewer`（預覽控制）
   - 負責：
     - 根據選中的檔案 ID，調用對應 adapter 渲染內容到中欄容器。
     - 若尚未解析，先執行解析（lazy-load），解析中可顯示 loading 狀態。
     - 處理解析錯誤，顯示錯誤訊息。

4. `SelectionManager`
   - 監聽中欄預覽區的文字選取事件。
   - 確認有有效選取範圍時，允許使用者按下「加入 clip」。
   - 建立 clip：
     - 文字內容
     - 檔案 ID、檔名、類型
     - 位置 meta（請盡量從 adapter 拿到相關資訊）

5. `ClipsStore` / `ClipboardPanel`
   - 維護所有 clip 的列表狀態。
   - 提供：
     - 新增 clip
     - 刪除 clip
     - （選配）調整排序
   - 負責將 clips 渲染到右欄 UI。
   - 實作「Copy All」功能。

---

## 六、效能與錯誤處理（Performance & Error Handling）

1. **Lazy-load 解析**
   - 不要在載入檔案列表時一次解析所有檔案。
   - 使用者點擊某個檔案時才解析該檔案內容。
2. **多檔案情境**
   - 預設使用者一次可能選擇 20～50 個檔案。
   - 確保在這種數量級下仍可順利操作（尤其是 UI 不卡死）。
3. **錯誤處理**
   - 對於不支援或解析失敗的檔案：
     - 在檔案列表中顯示「解析失敗」標記。
     - 中欄顯示簡單錯誤訊息，不讓整個工具崩潰。
4. **記憶體**
   - 解析後的內容可以緩存，但需避免一次把極大量內容常駐記憶體導致瀏覽器崩潰。
   - 可以考慮提供「清除預覽快取」按鈕（選配）。

---

## 七、開發與打包方式（Dev → Single HTML）

你可以在開發階段採用多檔案專案結構與 bundler，但最終須輸出單一 HTML：

1. 開發時可使用：
   - 任意打包工具（例如 esbuild / rollup / webpack 等）。
   - 任意模組系統（ESM / TypeScript 等），最後編譯到原生 JS。
2. Build 階段：
   - 將所有 JS bundle 嵌入一個 HTML 模板中的 `<script>` 標籤。
   - 將 CSS 嵌入 `<style>` 標籤。
   - 若 library 需以 wasm 或其他形式存在，請研究是否能以 data URI 或類似方式內嵌，確保最後仍為單一檔。
3. 最終交付物：
   - 一個 `index.html` 檔案，單獨存在也能完整運作。

---

## 八、最終交付物（Deliverables）

1. **單一檔案：**  
   - `index.html`：打開即用，無須其他檔案，離線可執行。
2. **內嵌說明（建議在工具中內建 Help 區塊）：**
   - 如何選擇資料夾 / 檔案。
   - 如何切換檔案預覽。
   - 如何選取文字與加入 clip。
   - 如何在右欄檢視與複製所有 clip。
3. **（選配）開發原始碼與 build 說明**
   - 若有專案原始碼，可附上簡要說明與 build 指令，方便未來維護。

---

## 九、你的任務（給 AI 工程師）

請你依據以上完整規格：

1. 設計實際可運作的前端架構與檔案結構（開發階段）。
2. 選擇合適的 PDF / DOCX / XLSX 解析方案，並整合進單一 HTML 的輸出流程。
3. 撰寫 HTML + CSS + JS 程式碼，完成上述所有功能：
   - 多檔案選取（含資料夾）
   - 三欄式 UI（檔案列表 / 預覽 / clip 輸出）
   - 真實文件預覽（PDF / DOCX / XLSX）
   - 多處文字選取與 clip 建立
   - clip 彙整與 Copy All
4. 確保最終輸出的 `index.html` 在離線狀態下，能於主流桌面瀏覽器順利開啟並完成上述操作。

請直接產出可實際執行的最終版實作方案與程式碼，不使用假資料、不省略任何核心功能。